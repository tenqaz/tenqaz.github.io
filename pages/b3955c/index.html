<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kubernetes service如何通过iptables转发 | 郑文峰的博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7c28cc47ffa100de44e976f816b0b294";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script>
    <link rel="alternate" type="application/rss+xml" href="https://www.zhengwenfeng.com/rss.xml" title="郑文峰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://www.zhengwenfeng.com/feed.atom" title="郑文峰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://www.zhengwenfeng.com/feed.json" title="郑文峰的博客 JSON Feed">
    <meta name="description" content="本文主要是介绍kubernetes的service是如何利用iptables来进行流量的转发达到流量的负载均衡的，并会通过实践操作来更好的理解与验证其原理。">
    <meta name="image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png">
    <meta name="twitter:title" content="kubernetes service如何通过iptables转发">
    <meta name="twitter:description" content="本文主要是介绍kubernetes的service是如何利用iptables来进行流量的转发达到流量的负载均衡的，并会通过实践操作来更好的理解与验证其原理。">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png">
    <meta name="twitter:url" content="https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/16.kubernetes%20service%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87iptables%E8%BD%AC%E5%8F%91.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="kubernetes service如何通过iptables转发">
    <meta property="og:description" content="本文主要是介绍kubernetes的service是如何利用iptables来进行流量的转发达到流量的负载均衡的，并会通过实践操作来更好的理解与验证其原理。">
    <meta property="og:image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png">
    <meta property="og:url" content="https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/16.kubernetes%20service%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87iptables%E8%BD%AC%E5%8F%91.html">
    <meta property="og:site_name" content="zhengwenfeng">
    <meta property="article:published_time" content="2024-01-18T16:40:30.000Z">
    <meta property="article:tag" content="k8s">
    <meta itemprop="name" content="kubernetes service如何通过iptables转发">
    <meta itemprop="description" content="本文主要是介绍kubernetes的service是如何利用iptables来进行流量的转发达到流量的负载均衡的，并会通过实践操作来更好的理解与验证其原理。">
    <meta itemprop="image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png">
    <meta name="keywords" content="后端博客,个人技术博客,后端,后端开发,后端框架,后端面试题,技术文档,学习,面试,python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.632ebfea.css" as="style"><link rel="preload" href="/assets/js/app.af2152b2.js" as="script"><link rel="preload" href="/assets/js/2.ebc69a32.js" as="script"><link rel="preload" href="/assets/js/25.440f402d.js" as="script"><link rel="prefetch" href="/assets/js/10.6c4c4ab9.js"><link rel="prefetch" href="/assets/js/100.14ecf654.js"><link rel="prefetch" href="/assets/js/101.ef2677ae.js"><link rel="prefetch" href="/assets/js/102.a2e87932.js"><link rel="prefetch" href="/assets/js/103.6b933b04.js"><link rel="prefetch" href="/assets/js/104.a2aaa7ca.js"><link rel="prefetch" href="/assets/js/105.eae2ecc4.js"><link rel="prefetch" href="/assets/js/106.a57cd4d0.js"><link rel="prefetch" href="/assets/js/107.73811f03.js"><link rel="prefetch" href="/assets/js/108.2e5bd9d4.js"><link rel="prefetch" href="/assets/js/109.92b57358.js"><link rel="prefetch" href="/assets/js/11.679678d6.js"><link rel="prefetch" href="/assets/js/110.90f10894.js"><link rel="prefetch" href="/assets/js/111.508768cb.js"><link rel="prefetch" href="/assets/js/112.d14993ff.js"><link rel="prefetch" href="/assets/js/113.0994f3b9.js"><link rel="prefetch" href="/assets/js/114.13df2932.js"><link rel="prefetch" href="/assets/js/115.fcdb35e7.js"><link rel="prefetch" href="/assets/js/116.3b137288.js"><link rel="prefetch" href="/assets/js/12.deaf25f7.js"><link rel="prefetch" href="/assets/js/13.985315df.js"><link rel="prefetch" href="/assets/js/14.7787d897.js"><link rel="prefetch" href="/assets/js/15.635b8f55.js"><link rel="prefetch" href="/assets/js/16.a7f9bb48.js"><link rel="prefetch" href="/assets/js/17.1832ebcb.js"><link rel="prefetch" href="/assets/js/18.ac9e3253.js"><link rel="prefetch" href="/assets/js/19.3e4bc6eb.js"><link rel="prefetch" href="/assets/js/20.984e29ec.js"><link rel="prefetch" href="/assets/js/21.3f37f8b8.js"><link rel="prefetch" href="/assets/js/22.30ee1728.js"><link rel="prefetch" href="/assets/js/23.489c8b6d.js"><link rel="prefetch" href="/assets/js/24.65478516.js"><link rel="prefetch" href="/assets/js/26.1815479a.js"><link rel="prefetch" href="/assets/js/27.f5b8cee5.js"><link rel="prefetch" href="/assets/js/28.9a6cf032.js"><link rel="prefetch" href="/assets/js/29.ce8ffc27.js"><link rel="prefetch" href="/assets/js/3.25c614f0.js"><link rel="prefetch" href="/assets/js/30.f24cccf9.js"><link rel="prefetch" href="/assets/js/31.a6875203.js"><link rel="prefetch" href="/assets/js/32.17e4d471.js"><link rel="prefetch" href="/assets/js/33.fac1c69e.js"><link rel="prefetch" href="/assets/js/34.2b94da57.js"><link rel="prefetch" href="/assets/js/35.6079a664.js"><link rel="prefetch" href="/assets/js/36.1f99cd1d.js"><link rel="prefetch" href="/assets/js/37.c91aaa19.js"><link rel="prefetch" href="/assets/js/38.31561a65.js"><link rel="prefetch" href="/assets/js/39.71c38fd3.js"><link rel="prefetch" href="/assets/js/4.542e9b82.js"><link rel="prefetch" href="/assets/js/40.a76c135b.js"><link rel="prefetch" href="/assets/js/41.e97e6cb7.js"><link rel="prefetch" href="/assets/js/42.b808ef8f.js"><link rel="prefetch" href="/assets/js/43.5b2a9968.js"><link rel="prefetch" href="/assets/js/44.355b1d3b.js"><link rel="prefetch" href="/assets/js/45.9c528887.js"><link rel="prefetch" href="/assets/js/46.8d3eedb6.js"><link rel="prefetch" href="/assets/js/47.8c3bbdb6.js"><link rel="prefetch" href="/assets/js/48.66c350b9.js"><link rel="prefetch" href="/assets/js/49.2fd99115.js"><link rel="prefetch" href="/assets/js/5.4bcce552.js"><link rel="prefetch" href="/assets/js/50.17339639.js"><link rel="prefetch" href="/assets/js/51.5e628842.js"><link rel="prefetch" href="/assets/js/52.d592fe39.js"><link rel="prefetch" href="/assets/js/53.c5dc4be4.js"><link rel="prefetch" href="/assets/js/54.f9ec091c.js"><link rel="prefetch" href="/assets/js/55.abf342d9.js"><link rel="prefetch" href="/assets/js/56.5c78476c.js"><link rel="prefetch" href="/assets/js/57.182af18e.js"><link rel="prefetch" href="/assets/js/58.cc39e610.js"><link rel="prefetch" href="/assets/js/59.6f032d18.js"><link rel="prefetch" href="/assets/js/6.d41e8bf9.js"><link rel="prefetch" href="/assets/js/60.6b5f548a.js"><link rel="prefetch" href="/assets/js/61.02e1a9f1.js"><link rel="prefetch" href="/assets/js/62.50f82996.js"><link rel="prefetch" href="/assets/js/63.71f391ec.js"><link rel="prefetch" href="/assets/js/64.1f0993d0.js"><link rel="prefetch" href="/assets/js/65.7448d827.js"><link rel="prefetch" href="/assets/js/66.468ff5f8.js"><link rel="prefetch" href="/assets/js/67.5c9486d0.js"><link rel="prefetch" href="/assets/js/68.241d98b1.js"><link rel="prefetch" href="/assets/js/69.72d856a7.js"><link rel="prefetch" href="/assets/js/7.e928a25b.js"><link rel="prefetch" href="/assets/js/70.7d934840.js"><link rel="prefetch" href="/assets/js/71.6a0d9ea4.js"><link rel="prefetch" href="/assets/js/72.dc50c87a.js"><link rel="prefetch" href="/assets/js/73.aa1c1691.js"><link rel="prefetch" href="/assets/js/74.c5253135.js"><link rel="prefetch" href="/assets/js/75.6ff54b05.js"><link rel="prefetch" href="/assets/js/76.8bafff13.js"><link rel="prefetch" href="/assets/js/77.40b68e0e.js"><link rel="prefetch" href="/assets/js/78.8c8cb816.js"><link rel="prefetch" href="/assets/js/79.f2b49dc2.js"><link rel="prefetch" href="/assets/js/8.ddf992e7.js"><link rel="prefetch" href="/assets/js/80.84394ab3.js"><link rel="prefetch" href="/assets/js/81.dffe7377.js"><link rel="prefetch" href="/assets/js/82.07a12478.js"><link rel="prefetch" href="/assets/js/83.20894a19.js"><link rel="prefetch" href="/assets/js/84.9536d25d.js"><link rel="prefetch" href="/assets/js/85.79f06ebd.js"><link rel="prefetch" href="/assets/js/86.e50e665c.js"><link rel="prefetch" href="/assets/js/87.95d14ae9.js"><link rel="prefetch" href="/assets/js/88.2cef63e5.js"><link rel="prefetch" href="/assets/js/89.53c53bc6.js"><link rel="prefetch" href="/assets/js/9.faedc087.js"><link rel="prefetch" href="/assets/js/90.32c61d53.js"><link rel="prefetch" href="/assets/js/91.f9b662b0.js"><link rel="prefetch" href="/assets/js/92.410fa25c.js"><link rel="prefetch" href="/assets/js/93.27703c41.js"><link rel="prefetch" href="/assets/js/94.2d354f23.js"><link rel="prefetch" href="/assets/js/95.a70b147a.js"><link rel="prefetch" href="/assets/js/96.adb90937.js"><link rel="prefetch" href="/assets/js/97.7d717f87.js"><link rel="prefetch" href="/assets/js/98.2fb32ed1.js"><link rel="prefetch" href="/assets/js/99.78399d6c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.632ebfea.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/me.jpg" alt="郑文峰的博客" class="logo"> <span class="site-name can-hide">郑文峰的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><!----> <span class="title" style="display:;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/go_performance/" class="nav-link">Go语言高性能编程</a></li><li class="dropdown-item"><!----> <a href="/bug_hunt/" class="nav-link">Bug 通缉令</a></li></ul></div></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的工具" class="dropdown-title"><!----> <span class="title" style="display:;">我的工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://nav.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ref.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  代码片段
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友链</a></li><li class="dropdown-item"><h4>外部页面</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  开往
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/tenqaz/tenqaz.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/me.jpg"> <div class="blogger-info"><h3>zhengwenfeng</h3> <span>穷则变，变则通，通则久</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><!----> <span class="title" style="display:;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/go_performance/" class="nav-link">Go语言高性能编程</a></li><li class="dropdown-item"><!----> <a href="/bug_hunt/" class="nav-link">Bug 通缉令</a></li></ul></div></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的工具" class="dropdown-title"><!----> <span class="title" style="display:;">我的工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://nav.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ref.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  代码片段
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友链</a></li><li class="dropdown-item"><h4>外部页面</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  开往
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/tenqaz/tenqaz.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>k8s</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2b547f/" class="sidebar-link">k8s之Pod</a></li><li><a href="/pages/d73c88/" class="sidebar-link">k8s之Deployment</a></li><li><a href="/pages/1f860b/" class="sidebar-link">k8s之Service</a></li><li><a href="/pages/ff8188/" class="sidebar-link">k8s之ConfigMap和Secret</a></li><li><a href="/pages/c96905/" class="sidebar-link">k8s之Job和CronJob</a></li><li><a href="/pages/92bee4/" class="sidebar-link">k8s之DaemonSet</a></li><li><a href="/pages/095c75/" class="sidebar-link">k8s之PV、PVC和StorageClass</a></li><li><a href="/pages/d178a2/" class="sidebar-link">k8s之StatefulSet</a></li><li><a href="/pages/9e17c8/" class="sidebar-link">使用kubeadm安装k8s</a></li><li><a href="/pages/27987d/" class="sidebar-link">pod中将代码与运行环境分离</a></li><li><a href="/pages/b1b4a3/" class="sidebar-link">django后端服务、logstash和flink接入VictoriaMetrics指标监控</a></li><li><a href="/pages/d9d0ce/" class="sidebar-link">理解flannel的三种容器网络方案原理</a></li><li><a href="/pages/f0f725/" class="sidebar-link">理解calico容器网络通信方案原理</a></li><li><a href="/pages/b3955c/" aria-current="page" class="active sidebar-link">kubernetes service如何通过iptables转发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#环境搭建" class="sidebar-link">环境搭建</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#kube-services" class="sidebar-link">KUBE-SERVICES</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#postrouting" class="sidebar-link">POSTROUTING</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#snat" class="sidebar-link">SNAT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b3955c/#为什么集群外部访问该service需要被snat" class="sidebar-link">为什么集群外部访问该service需要被SNAT？</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3955c/#conntrack" class="sidebar-link">conntrack</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#源和目的ip相同" class="sidebar-link">源和目的IP相同</a></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#nodeport" class="sidebar-link">NodePort</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b3955c/#搭建环境" class="sidebar-link">搭建环境</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3955c/#请求clusterip" class="sidebar-link">请求clusterip</a></li><li class="sidebar-sub-header level3"><a href="/pages/b3955c/#请求节点ip" class="sidebar-link">请求节点IP</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b3955c/#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/pages/6e0045/" class="sidebar-link">kube-proxy源码分析</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E4%BA%91%E5%8E%9F%E7%94%9F" title="分类" data-v-06225672>云原生</a></li><li data-v-06225672><a href="/categories/?category=k8s" title="分类" data-v-06225672>k8s</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tenqaz" target="_blank" title="作者" class="beLink" data-v-06225672>zhengwenfeng</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-01-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">kubernetes service如何通过iptables转发<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="kubernetes-service如何通过iptables转发"><a href="#kubernetes-service如何通过iptables转发" class="header-anchor">#</a> kubernetes service如何通过iptables转发</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>本文主要是介绍kubernetes的service是如何利用iptables来进行流量的转发达到流量的负载均衡的，并会通过实践操作来更好的理解与验证其原理。</p> <h2 id="环境搭建"><a href="#环境搭建" class="header-anchor">#</a> 环境搭建</h2> <p>搭建环境如下图所示：</p> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png" alt=""></p> <ol><li>创建一个deploy，设置其副本数为3</li></ol> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demoapp<span class="token punctuation">-</span>deployment
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demoapp
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> demoapp
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> demoapp
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ubuntu
          <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/demoapp<span class="token punctuation">:</span>v1.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol start="2"><li>创建service，为上面deployment的3个pod进行负载均衡访问</li></ol> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demoapp<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demoapp
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 192.44.140.73
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="3"><li>验证</li></ol> <p>创建完后，环境如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl get pods -n zwf -o wide</span>
NAME                                  READY   STATUS    RESTARTS   AGE     IP
demoapp-deployment-64bdcb8666-4prbk   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7d17h   <span class="token number">192.33</span>.229.12   dmoc-fa163eee1e30
demoapp-deployment-64bdcb8666-cxmmz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7d17h   <span class="token number">192.33</span>.73.139   dmoc-fa163e7188d6
demoapp-deployment-64bdcb8666-kkzsg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7d17h   <span class="token number">192.33</span>.206.93   dmoc-fa163ee6bbe1
demoapp-pod                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h   <span class="token number">192.33</span>.73.172   dmoc-fa163e7188d6

<span class="token comment"># kubectl get svc -n zwf</span>
NAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
demoapp-service            ClusterIP   <span class="token number">192.44</span>.140.73    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP         7s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以直接在环境中请求service的clusterip地址，会随机访问到三个pod，输出的信息包含了请求IP和目的IP。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># curl 192.44.140.73</span>
iKubernetes demoapp v1.0 <span class="token operator">!</span><span class="token operator">!</span> ClientIP: <span class="token number">10.10</span>.10.16, ServerName: demoapp-deployment-64bdcb8666-kkzsg, ServerIP: <span class="token number">192.33</span>.206.93<span class="token operator">!</span>

<span class="token comment"># curl 192.44.140.73</span>
iKubernetes demoapp v1.0 <span class="token operator">!</span><span class="token operator">!</span> ClientIP: <span class="token number">10.65</span>.196.41, ServerName: demoapp-deployment-64bdcb8666-cxmmz, ServerIP: <span class="token number">192.33</span>.73.139<span class="token operator">!</span>

<span class="token comment"># curl 192.44.140.73</span>
iKubernetes demoapp v1.0 <span class="token operator">!</span><span class="token operator">!</span> ClientIP: <span class="token number">10.10</span>.10.16, ServerName: demoapp-deployment-64bdcb8666-4prbk, ServerIP: <span class="token number">192.33</span>.229.12<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="kube-services"><a href="#kube-services" class="header-anchor">#</a> KUBE-SERVICES</h2> <p>在<code>PREROUTING</code>​和<code>OUTPUT</code>​链的nat表中，都包含了<code>KUBE-SERVICES</code>​子链，该子链中就包含了serivce的iptables规则的配置。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L PREROUTING -t nat</span>
Chain PREROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes <span class="token function">service</span> portals */
cali-PREROUTING  all  --  anywhere             anywhere             /* cali:6gwbT8clXdHdC1b1 */

<span class="token comment"># iptables -L OUTPUT -t nat</span>
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes <span class="token function">service</span> portals */
cali-OUTPUT  all  --  anywhere             anywhere             /* cali:tVnHkvAo15HuiPy0 */
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>为什么在PREROUTING和OUTPUT链中添加service规则？</strong></p> <p>service的作用是负载均衡，也就是需要将IP包进行DNAT操作，而这个操作需要在最靠近发送的位置。网卡收到的包进入到网络协议栈时，最先进入的就是PREROUTING链，也就是节点外部的流量进入的入口。OUTPUT是本地进程发出的包最先进入的链。所以需要在这两条链中添加<code>KUBE-SERVICES</code>，详情可参考<a href="https://www.zhengwenfeng.com/pages/72ba9a/" target="_blank" rel="noopener noreferrer">快速了解iptables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>为什么nat表？</strong></p> <p>因为要做DNAT操作，所以在nat表。</p> <p>KUBE-SERVICES下面有许多KUBE-SVC-XXX的子链，每一条子链都是一个集群中一个service的配置，筛选一下</p> <p>通过筛选<code>demoapp-service</code>​得到下面的子链，只有访问目的地址为192.44.140.73才能进入到该子链中。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L KUBE-SERVICES -t nat | grep demoapp-service</span>
KUBE-SVC-FIHIHDNRZEG5VQEQ  tcp  --  anywhere             <span class="token number">192.44</span>.140.73        /* zwf/demoapp-service:http cluster IP */ tcp dpt:http
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看<code>UBE-SVC-FIHIHDNRZEG5VQEQ</code>​链中内容，其中包含了四条子链。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L KUBE-SVC-FIHIHDNRZEG5VQEQ -t nat -n</span>
Chain KUBE-SVC-FIHIHDNRZEG5VQEQ <span class="token punctuation">(</span><span class="token number">1</span> references<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
KUBE-MARK-MASQ  tcp  -- <span class="token operator">!</span><span class="token number">192.33</span>.0.0/16        <span class="token number">192.44</span>.140.73        /* zwf/demoapp-service:http cluster IP */ tcp dpt:80
KUBE-SEP-FO7YK2K5DAKTCVSE  all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability <span class="token number">0.33333333349</span>
KUBE-SEP-IPKL7NSNTVGKI4T5  all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability <span class="token number">0.50000000000</span>
KUBE-SEP-BPER562ISF3UFYOQ  all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            /* zwf/demoapp-service:http */
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>第一条链是，源IP不在192.33.0.0/16段、目的IP为192.44.140.73并且目的端口是80的数据包会匹配到该条子链进行跳转。其中192.33.0.0/16是pod的网段，如果不是集群内的流量，则会匹配上该条子链，会打上0x4000的标记。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L KUBE-MARK-MASQ -t nat -n</span>
Chain KUBE-MARK-MASQ <span class="token punctuation">(</span><span class="token number">548</span> references<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
MARK       all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0            MARK or 0x4000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>后面的三条链是为了将流量随机的分配到任意一个pod中。第二条链代表着有1/3的概率会匹配到该链，而第三条链代表着1/2，最后一条链代表着百分百。</p> <p>看第二条链中的规则，第一条规则是跳转到子链<code>KUBE-MARK-MASQ</code>​，源IP为192.33.206.93的数据包打上了0x4000标记，再将目的IP DNAT成192.33.206.93，说明如果自己访问自己，也会被打上标记。</p> <p>这里的192.33.206.93是本身service所匹配上的pod IP地址，如果调用自己的service则会匹配上该链，打上0x4000标记。</p> <p>而第二条规则是一个DNAT操作，会将目标地址改为192.33.206.93:80，也就是pod的地址。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> <span class="token comment"># iptables -L KUBE-SEP-FO7YK2K5DAKTCVSE -t nat</span>
Chain KUBE-SEP-FO7YK2K5DAKTCVSE <span class="token punctuation">(</span><span class="token number">1</span> references<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination   
KUBE-MARK-MASQ  all  --  <span class="token number">192.33</span>.206.93        anywhere             /* zwf/demoapp-service:http */
DNAT       tcp  --  anywhere             anywhere             /* zwf/demoapp-service:http */ tcp to:192.33.206.93:80
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>剩下的第3、4条规则也是一样的操作，会将流量DNAT到对应的pod中。</p> <h2 id="postrouting"><a href="#postrouting" class="header-anchor">#</a> POSTROUTING</h2> <p>POSTROUTING中包含了一条KUBE-POSTROUTING子链，子链也是由kube-porxy来写入的。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L POSTROUTING -t nat</span>
Chain POSTROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
KUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */
cali-POSTROUTING  all  --  anywhere             anywhere             /* cali:O3lYWMrLQYEMJtB5 */
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>查看子链<code>KUBE-POSTROUTING</code>​内容：</p> <ol><li>第一条规则是没有标记为0x400的数据包会return，不执行下面的子链。还记得在<code>KUBE-PREROUTING</code>​中有两次打上0x4000标记，代表着访问是集群外部访问该service或者是源和目的一样，都会往下走。</li> <li>第二条规则是对数据包的标记值进行异或，而这里是0x4000与0x4000进行异或，也就是0</li> <li>第三条规则时对该数据包进行SNAT，random-fully是对源端口进行随机获取。</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L KUBE-POSTROUTING -t nat</span>
Chain KUBE-POSTROUTING <span class="token punctuation">(</span><span class="token number">1</span> references<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
RETURN     all  --  anywhere             anywhere             mark match <span class="token operator">!</span> 0x4000/0x4000
MARK       all  --  anywhere             anywhere             MARK xor 0x4000
MASQUERADE  all  --  anywhere             anywhere             /* kubernetes <span class="token function">service</span> traffic requiring SNAT */ random-fully
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里有两种情况会被SNAT，说说为什么。</p> <h2 id="snat"><a href="#snat" class="header-anchor">#</a> SNAT</h2> <h3 id="为什么集群外部访问该service需要被snat"><a href="#为什么集群外部访问该service需要被snat" class="header-anchor">#</a> 为什么集群外部访问该service需要被SNAT？</h3> <p>数据包需要回包，如果没有SNAT，那么回包的目的IP是客户端的IP，而源IP是Pod的IP，而客户端并不认该数据包，则会被丢弃。</p> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240108193022-uocio0v.png" alt="">
‍</p> <p>如果有发生SNAT，那么回包的时候可以回到Node1的节点，再回到client。</p> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240108192557-pxds0fc.png" alt="">‍</p> <p>但问题又来了，是怎么从Node1再回包到client的呢？</p> <h3 id="conntrack"><a href="#conntrack" class="header-anchor">#</a> conntrack</h3> <p>conntrack是一个追踪表，在每一个数据包进入到netfilter的时候，都会记录一条记录，当我们进行SNAT和DNAT的时候也都会更新该表中的记录。</p> <p>所以在Node1回包给client时候，可以通过查询这个表中的记录，然后再次SNAT和DNAT恢复回去就可以进行正常的回包了。</p> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20240118185404.png" alt=""></p> <p>可以看下conntrack里面的记录长什么样子。</p> <p>先在某一台节点上curl service的ip，上图的client其实也是在Node1上的，因为Node1上有两张网卡，Node1和Node2的通信使用的网卡eth2 ip为10.10.10.16，因为转发到其他节点，所以会被SNAT。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># curl 192.44.140.73</span>
iKubernetes demoapp v1.0 <span class="token operator">!</span><span class="token operator">!</span> ClientIP: <span class="token number">10.10</span>.10.16, ServerName: demoapp-deployment-64bdcb8666-4prbk, ServerIP: <span class="token number">192.33</span>.229.12<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里主要是看src和dst分别是client请求service的目的IP，然后后面又有一个src和dst它是由Node2回包给Node1的源和目的IP，也就是源是pod的IP，dst是Node1节点IP。</p> <p>前面是发送包的方向，后面是回包的方向。通过查询该表，即可以从Node1回包给client</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># conntrack -L | grep 192.33.229.12</span>
tcp      <span class="token number">6</span> <span class="token number">107</span> TIME_WAIT <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token number">10.65</span>.196.41 <span class="token assign-left variable">dst</span><span class="token operator">=</span><span class="token number">192.44</span>.140.73 <span class="token assign-left variable">sport</span><span class="token operator">=</span><span class="token number">33468</span> <span class="token assign-left variable">dport</span><span class="token operator">=</span><span class="token number">80</span> <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token number">192.33</span>.229.12 <span class="token assign-left variable">dst</span><span class="token operator">=</span><span class="token number">10.10</span>.10.16 <span class="token assign-left variable">sport</span><span class="token operator">=</span><span class="token number">80</span> <span class="token assign-left variable">dport</span><span class="token operator">=</span><span class="token number">18623</span> <span class="token punctuation">[</span>ASSURED<span class="token punctuation">]</span> <span class="token assign-left variable">mark</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">use</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>‍</p> <h2 id="源和目的ip相同"><a href="#源和目的ip相同" class="header-anchor">#</a> 源和目的IP相同</h2> <p>当pod访问service时，正好DNAT成自己的IP，那么就存在源和目的IP一样的情况。</p> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240108194618-1alci1m.png" alt=""></p> <p>这种数据包是很特殊的存在，网络设备可能会将这种数据包视为无效或者异常的包被丢弃，最好不要一样，所以会将源IP SNAT为主机的IP，解决该问题。</p> <p><strong>实验</strong></p> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240108200310-r3nr3es.png" alt=""></p> <p>当前节点的IP为：10.65.196.41，然后进入在当前节点的Pod内，当前pod的ip为：192.33.73.139</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">-n</span> zwf demoapp-deployment-64bdcb8666-cxmmz -- <span class="token function">sh</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>进行多次curl service ip，当某一次请求到本POD的IP时，查看其ClientIP，发现其源IP是：10.65.196.41，这个当前节点的IP</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># curl 192.44.140.73</span>
iKubernetes demoapp v1.0 <span class="token operator">!</span><span class="token operator">!</span> ClientIP: <span class="token number">10.65</span>.196.41, ServerName: demoapp-deployment-64bdcb8666-cxmmz, ServerIP: <span class="token number">192.33</span>.73.139<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="nodeport"><a href="#nodeport" class="header-anchor">#</a> NodePort</h2> <p>上面介绍的是serivi type=ClusterIP方式的，那么NodePort有什么区别呢？</p> <h3 id="搭建环境"><a href="#搭建环境" class="header-anchor">#</a> 搭建环境</h3> <p>先将clusterIP的service删了，防止干扰。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete svc <span class="token parameter variable">-n</span> zwf demoapp-service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建NodePort的service文件<code>demo_service_nodeport.yaml</code>​</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demoapp<span class="token punctuation">-</span>nodeport<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demoapp
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>创建Service</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl apply -n zwf -f demo_service_nodeport.yaml </span>

<span class="token comment"># kubectl get svc -n zwf</span>
NAME                       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
demoapp-nodeport-service   NodePort   <span class="token number">192.44</span>.152.223   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30337/TCP   64s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="请求clusterip"><a href="#请求clusterip" class="header-anchor">#</a> 请求clusterip</h3> <p>通过clusterip+端口的方式请求service，原理和上面将是一样的。</p> <p>在POSTROUTING和OUTPUT中添加了KUBE-SERVICES链，其中包含了新增的service对应的KUBE-SVC-XXX子链，当访问的是其clusterip时，则匹配上该链。在其中包含了从多个pod中随机选择一个进行DNAT操作，打上标记，在POSTROUTING中再SNAT。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L PREROUTING -t nat</span>
Chain PREROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination       
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes <span class="token function">service</span> portals */
cali-PREROUTING  all  --  anywhere             anywhere             /* cali:6gwbT8clXdHdC1b1 */


<span class="token comment"># iptables -L KUBE-SERVICES -t nat | grep zwf</span>
KUBE-SVC-YSWRJGOK5VEB6HOG  tcp  --  anywhere             <span class="token number">192.44</span>.152.223       /* zwf/demoapp-nodeport-service:http cluster IP */ tcp dpt:http

<span class="token comment"># iptables -L KUBE-SVC-YSWRJGOK5VEB6HOG -t nat |grep zwf</span>
KUBE-MARK-MASQ  tcp  -- <span class="token operator">!</span><span class="token number">192.33</span>.0.0/16        <span class="token number">192.44</span>.152.223       /* zwf/demoapp-nodeport-service:http cluster IP */ tcp dpt:http
KUBE-MARK-MASQ  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337
KUBE-SEP-NMMBRSZXI4OIWDPB  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability <span class="token number">0.33333333349</span>
KUBE-SEP-PXDORKZI3GD2RUMC  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability <span class="token number">0.50000000000</span>
KUBE-SEP-YLPOR67MTHPHIZAB  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="请求节点ip"><a href="#请求节点ip" class="header-anchor">#</a> 请求节点IP</h3> <p>但是如果不是通过ClusterIP而是通过节点IP请求service呢，它是怎么做的？</p> <p>因为是节点IP，所以无法匹配上该service的KUBE-SVC-XXX子链，但是有一条<code>KUBE-NODEPORTS</code>​</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># iptables -L KUBE-SERVICES  -t nat | grep KUBE-NODEPORTS</span>
KUBE-NODEPORTS  all  --  anywhere             anywhere             /* kubernetes <span class="token function">service</span> nodeports<span class="token punctuation">;</span> NOTE: this must be the last rule <span class="token keyword">in</span> this chain */ ADDRTYPE match dst-type LOCAL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在其中包含了一条子链<code>KUBE-SVC-YSWRJGOK5VEB6HOG</code>​，只要目的端口为30337就能匹配上，而这个端口正好就是<code>demoapp-nodeport-service</code>​的NodePort端口。</p> <p>这条子链和上面匹配clusterIP时是同一个链，都是进行一个DNAT操作。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># # iptables -L KUBE-NODEPORTS -t nat | grep zwf</span>
KUBE-SVC-YSWRJGOK5VEB6HOG  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>‍</p> <h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <ul><li><a href="https://www.cnblogs.com/liushaodong/archive/2013/02/26/2933593.html" target="_blank" rel="noopener noreferrer">netfilter 链接跟踪机制与NAT原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.jianshu.com/p/33c563045e76" target="_blank" rel="noopener noreferrer">k8s 之 service ip<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.thebyte.com.cn/network/conntrack.html" target="_blank" rel="noopener noreferrer">连接跟踪 conntrack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=k8s" title="标签">#k8s</a><a href="/tags/?tag=%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C" title="标签">#计算机网络</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/02/09, 23:47:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/f0f725/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">理解calico容器网络通信方案原理</div></a> <a href="/pages/6e0045/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">kube-proxy源码分析</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/f0f725/" class="prev">理解calico容器网络通信方案原理</a></span> <span class="next"><a href="/pages/6e0045/">kube-proxy源码分析</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/de98b1/"><div>
            服务启动时出现 OOM
            <!----></div></a> <span class="date">09-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cf65ba/"><div>
            一次服务升级时pg表DDL执行超时失败
            <!----></div></a> <span class="date">09-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/d8ed61/"><div>
            Go语言高效IO缓冲技术详解
            <!----></div></a> <span class="date">06-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:326695231@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tenqaz" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.zhengwenfeng.com/rss.xml" title="RSS订阅" target="_blank" class="iconfont icon-rss"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2025
    <span>zhengwenfeng | <a href="https://github.com/tenqaz/tenqaz.github.io/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.af2152b2.js" defer></script><script src="/assets/js/2.ebc69a32.js" defer></script><script src="/assets/js/25.440f402d.js" defer></script>
  </body>
</html>
