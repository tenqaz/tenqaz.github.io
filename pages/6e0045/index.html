<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kube-proxy源码分析 | 郑文峰的博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7c28cc47ffa100de44e976f816b0b294";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script>
    <link rel="alternate" type="application/rss+xml" href="https://www.zhengwenfeng.com/rss.xml" title="郑文峰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://www.zhengwenfeng.com/feed.atom" title="郑文峰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://www.zhengwenfeng.com/feed.json" title="郑文峰的博客 JSON Feed">
    <meta name="description" content="本文主要是对kube-proxy的源码分析，了解其代码结构和实现原理。这里是根据[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)版本来进行分析的。在下面贴上的代码会一定裁剪，主要用于理解主流程。">
    <meta name="image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png">
    <meta name="twitter:title" content="kube-proxy源码分析">
    <meta name="twitter:description" content="本文主要是对kube-proxy的源码分析，了解其代码结构和实现原理。这里是根据[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)版本来进行分析的。在下面贴上的代码会一定裁剪，主要用于理解主流程。">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png">
    <meta name="twitter:url" content="https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/17.kube-proxy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="kube-proxy源码分析">
    <meta property="og:description" content="本文主要是对kube-proxy的源码分析，了解其代码结构和实现原理。这里是根据[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)版本来进行分析的。在下面贴上的代码会一定裁剪，主要用于理解主流程。">
    <meta property="og:image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png">
    <meta property="og:url" content="https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/17.kube-proxy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">
    <meta property="og:site_name" content="zhengwenfeng">
    <meta property="article:published_time" content="2024-01-18T16:43:23.000Z">
    <meta property="article:tag" content="k8s">
    <meta itemprop="name" content="kube-proxy源码分析">
    <meta itemprop="description" content="本文主要是对kube-proxy的源码分析，了解其代码结构和实现原理。这里是根据[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)版本来进行分析的。在下面贴上的代码会一定裁剪，主要用于理解主流程。">
    <meta itemprop="image" content="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png">
    <meta name="keywords" content="后端博客,个人技术博客,后端,后端开发,后端框架,后端面试题,技术文档,学习,面试,python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.632ebfea.css" as="style"><link rel="preload" href="/assets/js/app.af2152b2.js" as="script"><link rel="preload" href="/assets/js/2.ebc69a32.js" as="script"><link rel="preload" href="/assets/js/26.1815479a.js" as="script"><link rel="prefetch" href="/assets/js/10.6c4c4ab9.js"><link rel="prefetch" href="/assets/js/100.14ecf654.js"><link rel="prefetch" href="/assets/js/101.ef2677ae.js"><link rel="prefetch" href="/assets/js/102.a2e87932.js"><link rel="prefetch" href="/assets/js/103.6b933b04.js"><link rel="prefetch" href="/assets/js/104.a2aaa7ca.js"><link rel="prefetch" href="/assets/js/105.eae2ecc4.js"><link rel="prefetch" href="/assets/js/106.a57cd4d0.js"><link rel="prefetch" href="/assets/js/107.73811f03.js"><link rel="prefetch" href="/assets/js/108.2e5bd9d4.js"><link rel="prefetch" href="/assets/js/109.92b57358.js"><link rel="prefetch" href="/assets/js/11.679678d6.js"><link rel="prefetch" href="/assets/js/110.90f10894.js"><link rel="prefetch" href="/assets/js/111.508768cb.js"><link rel="prefetch" href="/assets/js/112.d14993ff.js"><link rel="prefetch" href="/assets/js/113.0994f3b9.js"><link rel="prefetch" href="/assets/js/114.13df2932.js"><link rel="prefetch" href="/assets/js/115.fcdb35e7.js"><link rel="prefetch" href="/assets/js/116.3b137288.js"><link rel="prefetch" href="/assets/js/12.deaf25f7.js"><link rel="prefetch" href="/assets/js/13.985315df.js"><link rel="prefetch" href="/assets/js/14.7787d897.js"><link rel="prefetch" href="/assets/js/15.635b8f55.js"><link rel="prefetch" href="/assets/js/16.a7f9bb48.js"><link rel="prefetch" href="/assets/js/17.1832ebcb.js"><link rel="prefetch" href="/assets/js/18.ac9e3253.js"><link rel="prefetch" href="/assets/js/19.3e4bc6eb.js"><link rel="prefetch" href="/assets/js/20.984e29ec.js"><link rel="prefetch" href="/assets/js/21.3f37f8b8.js"><link rel="prefetch" href="/assets/js/22.30ee1728.js"><link rel="prefetch" href="/assets/js/23.489c8b6d.js"><link rel="prefetch" href="/assets/js/24.65478516.js"><link rel="prefetch" href="/assets/js/25.440f402d.js"><link rel="prefetch" href="/assets/js/27.f5b8cee5.js"><link rel="prefetch" href="/assets/js/28.9a6cf032.js"><link rel="prefetch" href="/assets/js/29.ce8ffc27.js"><link rel="prefetch" href="/assets/js/3.25c614f0.js"><link rel="prefetch" href="/assets/js/30.f24cccf9.js"><link rel="prefetch" href="/assets/js/31.a6875203.js"><link rel="prefetch" href="/assets/js/32.17e4d471.js"><link rel="prefetch" href="/assets/js/33.fac1c69e.js"><link rel="prefetch" href="/assets/js/34.2b94da57.js"><link rel="prefetch" href="/assets/js/35.6079a664.js"><link rel="prefetch" href="/assets/js/36.1f99cd1d.js"><link rel="prefetch" href="/assets/js/37.c91aaa19.js"><link rel="prefetch" href="/assets/js/38.31561a65.js"><link rel="prefetch" href="/assets/js/39.71c38fd3.js"><link rel="prefetch" href="/assets/js/4.542e9b82.js"><link rel="prefetch" href="/assets/js/40.a76c135b.js"><link rel="prefetch" href="/assets/js/41.e97e6cb7.js"><link rel="prefetch" href="/assets/js/42.b808ef8f.js"><link rel="prefetch" href="/assets/js/43.5b2a9968.js"><link rel="prefetch" href="/assets/js/44.355b1d3b.js"><link rel="prefetch" href="/assets/js/45.9c528887.js"><link rel="prefetch" href="/assets/js/46.8d3eedb6.js"><link rel="prefetch" href="/assets/js/47.8c3bbdb6.js"><link rel="prefetch" href="/assets/js/48.66c350b9.js"><link rel="prefetch" href="/assets/js/49.2fd99115.js"><link rel="prefetch" href="/assets/js/5.4bcce552.js"><link rel="prefetch" href="/assets/js/50.17339639.js"><link rel="prefetch" href="/assets/js/51.5e628842.js"><link rel="prefetch" href="/assets/js/52.d592fe39.js"><link rel="prefetch" href="/assets/js/53.c5dc4be4.js"><link rel="prefetch" href="/assets/js/54.f9ec091c.js"><link rel="prefetch" href="/assets/js/55.abf342d9.js"><link rel="prefetch" href="/assets/js/56.5c78476c.js"><link rel="prefetch" href="/assets/js/57.182af18e.js"><link rel="prefetch" href="/assets/js/58.cc39e610.js"><link rel="prefetch" href="/assets/js/59.6f032d18.js"><link rel="prefetch" href="/assets/js/6.d41e8bf9.js"><link rel="prefetch" href="/assets/js/60.6b5f548a.js"><link rel="prefetch" href="/assets/js/61.02e1a9f1.js"><link rel="prefetch" href="/assets/js/62.50f82996.js"><link rel="prefetch" href="/assets/js/63.71f391ec.js"><link rel="prefetch" href="/assets/js/64.1f0993d0.js"><link rel="prefetch" href="/assets/js/65.7448d827.js"><link rel="prefetch" href="/assets/js/66.468ff5f8.js"><link rel="prefetch" href="/assets/js/67.5c9486d0.js"><link rel="prefetch" href="/assets/js/68.241d98b1.js"><link rel="prefetch" href="/assets/js/69.72d856a7.js"><link rel="prefetch" href="/assets/js/7.e928a25b.js"><link rel="prefetch" href="/assets/js/70.7d934840.js"><link rel="prefetch" href="/assets/js/71.6a0d9ea4.js"><link rel="prefetch" href="/assets/js/72.dc50c87a.js"><link rel="prefetch" href="/assets/js/73.aa1c1691.js"><link rel="prefetch" href="/assets/js/74.c5253135.js"><link rel="prefetch" href="/assets/js/75.6ff54b05.js"><link rel="prefetch" href="/assets/js/76.8bafff13.js"><link rel="prefetch" href="/assets/js/77.40b68e0e.js"><link rel="prefetch" href="/assets/js/78.8c8cb816.js"><link rel="prefetch" href="/assets/js/79.f2b49dc2.js"><link rel="prefetch" href="/assets/js/8.ddf992e7.js"><link rel="prefetch" href="/assets/js/80.84394ab3.js"><link rel="prefetch" href="/assets/js/81.dffe7377.js"><link rel="prefetch" href="/assets/js/82.07a12478.js"><link rel="prefetch" href="/assets/js/83.20894a19.js"><link rel="prefetch" href="/assets/js/84.9536d25d.js"><link rel="prefetch" href="/assets/js/85.79f06ebd.js"><link rel="prefetch" href="/assets/js/86.e50e665c.js"><link rel="prefetch" href="/assets/js/87.95d14ae9.js"><link rel="prefetch" href="/assets/js/88.2cef63e5.js"><link rel="prefetch" href="/assets/js/89.53c53bc6.js"><link rel="prefetch" href="/assets/js/9.faedc087.js"><link rel="prefetch" href="/assets/js/90.32c61d53.js"><link rel="prefetch" href="/assets/js/91.f9b662b0.js"><link rel="prefetch" href="/assets/js/92.410fa25c.js"><link rel="prefetch" href="/assets/js/93.27703c41.js"><link rel="prefetch" href="/assets/js/94.2d354f23.js"><link rel="prefetch" href="/assets/js/95.a70b147a.js"><link rel="prefetch" href="/assets/js/96.adb90937.js"><link rel="prefetch" href="/assets/js/97.7d717f87.js"><link rel="prefetch" href="/assets/js/98.2fb32ed1.js"><link rel="prefetch" href="/assets/js/99.78399d6c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.632ebfea.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/me.jpg" alt="郑文峰的博客" class="logo"> <span class="site-name can-hide">郑文峰的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><!----> <span class="title" style="display:;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/go_performance/" class="nav-link">Go语言高性能编程</a></li><li class="dropdown-item"><!----> <a href="/bug_hunt/" class="nav-link">Bug 通缉令</a></li></ul></div></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的工具" class="dropdown-title"><!----> <span class="title" style="display:;">我的工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://nav.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ref.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  代码片段
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友链</a></li><li class="dropdown-item"><h4>外部页面</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  开往
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/tenqaz/tenqaz.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/me.jpg"> <div class="blogger-info"><h3>zhengwenfeng</h3> <span>穷则变，变则通，通则久</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><!----> <span class="title" style="display:;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/go_performance/" class="nav-link">Go语言高性能编程</a></li><li class="dropdown-item"><!----> <a href="/bug_hunt/" class="nav-link">Bug 通缉令</a></li></ul></div></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="我的工具" class="dropdown-title"><!----> <span class="title" style="display:;">我的工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://nav.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://ref.zhengwenfeng.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  代码片段
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友链</a></li><li class="dropdown-item"><h4>外部页面</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.travellings.cn/go.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  开往
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/tenqaz/tenqaz.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>k8s</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2b547f/" class="sidebar-link">k8s之Pod</a></li><li><a href="/pages/d73c88/" class="sidebar-link">k8s之Deployment</a></li><li><a href="/pages/1f860b/" class="sidebar-link">k8s之Service</a></li><li><a href="/pages/ff8188/" class="sidebar-link">k8s之ConfigMap和Secret</a></li><li><a href="/pages/c96905/" class="sidebar-link">k8s之Job和CronJob</a></li><li><a href="/pages/92bee4/" class="sidebar-link">k8s之DaemonSet</a></li><li><a href="/pages/095c75/" class="sidebar-link">k8s之PV、PVC和StorageClass</a></li><li><a href="/pages/d178a2/" class="sidebar-link">k8s之StatefulSet</a></li><li><a href="/pages/9e17c8/" class="sidebar-link">使用kubeadm安装k8s</a></li><li><a href="/pages/27987d/" class="sidebar-link">pod中将代码与运行环境分离</a></li><li><a href="/pages/b1b4a3/" class="sidebar-link">django后端服务、logstash和flink接入VictoriaMetrics指标监控</a></li><li><a href="/pages/d9d0ce/" class="sidebar-link">理解flannel的三种容器网络方案原理</a></li><li><a href="/pages/f0f725/" class="sidebar-link">理解calico容器网络通信方案原理</a></li><li><a href="/pages/b3955c/" class="sidebar-link">kubernetes service如何通过iptables转发</a></li><li><a href="/pages/6e0045/" aria-current="page" class="active sidebar-link">kube-proxy源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#run" class="sidebar-link">Run</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#service-和-endpointslice-变更事件" class="sidebar-link">service 和 endpointslice 变更事件</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#boundedfrequencyrunner" class="sidebar-link">BoundedFrequencyRunner</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#syncproxyrules" class="sidebar-link">syncProxyRules</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level2"><a href="/pages/6e0045/#相关链接" class="sidebar-link">相关链接</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E4%BA%91%E5%8E%9F%E7%94%9F" title="分类" data-v-06225672>云原生</a></li><li data-v-06225672><a href="/categories/?category=k8s" title="分类" data-v-06225672>k8s</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tenqaz" target="_blank" title="作者" class="beLink" data-v-06225672>zhengwenfeng</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-01-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">kube-proxy源码分析<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="kube-proxy源码分析"><a href="#kube-proxy源码分析" class="header-anchor">#</a> kube-proxy源码分析</h1> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>本文主要是对kube-proxy的源码分析，了解其代码结构和实现原理。这里是根据<a href="https://github.com/kubernetes/kubernetes/tree/v1.23.9" target="_blank" rel="noopener noreferrer">kubernetes1.23.9<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>版本来进行分析的。在下面贴上的代码会一定裁剪，主要用于理解主流程。</p> <h2 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h2> <p>kube-proxy入口文件在<code>cmd/kube-proxy/proxy.go</code>​</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	command <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewProxyCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	code <span class="token operator">:=</span> cli<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>查看<code>app.NewProxyCommand()</code>方法，使用的cobra命令行解析库来作为程序入口</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewProxyCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
	opts <span class="token operator">:=</span> <span class="token function">NewOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
		Use<span class="token punctuation">:</span> <span class="token string">&quot;kube-proxy&quot;</span><span class="token punctuation">,</span>
		Long<span class="token punctuation">:</span> <span class="token string">`The Kubernetes network proxy runs on each node. This
reflects services as defined in the Kubernetes API on each node and can do simple
TCP, UDP, and SCTP stream forwarding or round robin TCP, UDP, and SCTP forwarding across a set of backends.
Service cluster IPs and ports are currently found through Docker-links-compatible
environment variables specifying ports opened by the service proxy. There is an optional
addon that provides cluster DNS for these cluster IPs. The user must create a service
with the apiserver API to configure the proxy.`</span><span class="token punctuation">,</span>
		RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			verflag<span class="token punctuation">.</span><span class="token function">PrintAndExitIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			cliflag<span class="token punctuation">.</span><span class="token function">PrintFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">initForOS</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>WindowsService<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed os init: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 1. 加载配置文件kubeproxyconfig.KubeProxyConfiguration</span>
			<span class="token comment">// 2. 监控文件变化</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> opts<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed complete: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 配置参数的校验</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> opts<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed validate: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 运行服务</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> opts<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error running ProxyServer&quot;</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		Args<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%q does not take any arguments, got %q&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">.</span><span class="token function">CommandPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token comment">// 填充一些默认配置</span>
	opts<span class="token punctuation">.</span>config<span class="token punctuation">,</span> err <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">ApplyDefaults</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Unable to create flag defaults&quot;</span><span class="token punctuation">)</span>
		<span class="token comment">// ACTION REQUIRED: Exit code changed from 255 to 1</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fs <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	opts<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
	<span class="token comment">// 将go的命令行参数也加到命令行参数中</span>
	fs<span class="token punctuation">.</span><span class="token function">AddGoFlagSet</span><span class="token punctuation">(</span>goflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span> <span class="token comment">// for --boot-id-file and --machine-id-file</span>

	<span class="token boolean">_</span> <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">MarkFlagFilename</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yaml&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yml&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><ol><li>读取配置文件KubeProxyConfiguration，并监听变化收到对应的事件</li> <li>对配置KubeProxyConfiguration进行校验</li> <li>启动服务</li></ol> <p>再来看<code>opts.Run()</code>​服务启动的实现</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>errCh<span class="token punctuation">)</span>

    <span class="token comment">// 如果配置了该字段，将配置文件写入指定位置，然后退出</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>WriteConfigTo<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">writeConfigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// 创建代理服务</span>
	proxyServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewProxyServer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// 清除所有的iptables规则</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>CleanupAndExit <span class="token punctuation">{</span>
		<span class="token keyword">return</span> proxyServer<span class="token punctuation">.</span><span class="token function">CleanupAndExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 启动代理服务</span>
	o<span class="token punctuation">.</span>proxyServer <span class="token operator">=</span> proxyServer
	<span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">runLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>再看<code>NewProxyServer()</code>​的实现，主要是用来创建proxyServer对象，并且在其中根据当前的网络模式，通过iptables.NewProxier来创建proxier对象。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewProxyServer</span><span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProxyServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">newProxyServer</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>config<span class="token punctuation">,</span> o<span class="token punctuation">.</span>CleanupAndExit<span class="token punctuation">,</span> o<span class="token punctuation">.</span>master<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newProxyServer</span><span class="token punctuation">(</span>
	config <span class="token operator">*</span>proxyconfigapi<span class="token punctuation">.</span>KubeProxyConfiguration<span class="token punctuation">,</span>
	cleanupAndExit <span class="token builtin">bool</span><span class="token punctuation">,</span>
	master <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProxyServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// 执行本地命令的控制器</span>
	execer <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	kernelHandler <span class="token operator">=</span> ipvs<span class="token punctuation">.</span><span class="token function">NewLinuxKernelHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token comment">// 创建ipset命令的执行器</span>
	ipsetInterface <span class="token operator">=</span> utilipset<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>execer<span class="token punctuation">)</span>
    <span class="token comment">// 判断是否支持ipvs</span>
	canUseIPVS<span class="token punctuation">,</span> err <span class="token operator">:=</span> ipvs<span class="token punctuation">.</span><span class="token function">CanUseIPVSProxier</span><span class="token punctuation">(</span>kernelHandler<span class="token punctuation">,</span> ipsetInterface<span class="token punctuation">,</span> config<span class="token punctuation">.</span>IPVS<span class="token punctuation">.</span>Scheduler<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Mode<span class="token punctuation">)</span> <span class="token operator">==</span> proxyModeIPVS <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Can't use the IPVS proxier&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> canUseIPVS <span class="token punctuation">{</span>
        <span class="token comment">// 如果支持的话，创建ipvs执行器</span>
		ipvsInterface <span class="token operator">=</span> utilipvs<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 创建事件记录器</span>
	eventBroadcaster <span class="token operator">:=</span> events<span class="token punctuation">.</span><span class="token function">NewBroadcaster</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>events<span class="token punctuation">.</span>EventSinkImpl<span class="token punctuation">{</span>Interface<span class="token punctuation">:</span> client<span class="token punctuation">.</span><span class="token function">EventsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	recorder <span class="token operator">:=</span> eventBroadcaster<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> <span class="token string">&quot;kube-proxy&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 创建健康检查服务</span>
	<span class="token keyword">var</span> healthzServer healthcheck<span class="token punctuation">.</span>ProxierHealthUpdater
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>HealthzBindAddress<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		healthzServer <span class="token operator">=</span> healthcheck<span class="token punctuation">.</span><span class="token function">NewProxierHealthServer</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>HealthzBindAddress<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> recorder<span class="token punctuation">,</span> nodeRef<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// 获取当前的代理模式</span>
	proxyMode <span class="token operator">:=</span> <span class="token function">getProxyMode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Mode<span class="token punctuation">)</span><span class="token punctuation">,</span> canUseIPVS<span class="token punctuation">,</span> iptables<span class="token punctuation">.</span>LinuxKernelCompatTester<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	
    <span class="token comment">// 获取当前的主要的IP协议</span>
	primaryProtocol <span class="token operator">:=</span> utiliptables<span class="token punctuation">.</span>ProtocolIPv4
	<span class="token keyword">if</span> netutils<span class="token punctuation">.</span><span class="token function">IsIPv6</span><span class="token punctuation">(</span>nodeIP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		primaryProtocol <span class="token operator">=</span> utiliptables<span class="token punctuation">.</span>ProtocolIPv6
	<span class="token punctuation">}</span>

	<span class="token comment">// 创建iptables执行器</span>
	iptInterface <span class="token operator">=</span> utiliptables<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>execer<span class="token punctuation">,</span> primaryProtocol<span class="token punctuation">)</span>

	<span class="token comment">// 可能支持ipv4和ipv6两种执行器</span>
	<span class="token keyword">var</span> ipt <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Interface
	dualStack <span class="token operator">:=</span> <span class="token boolean">true</span> <span class="token comment">// While we assume that node supports, we do further checks below</span>

	<span class="token comment">// 如果支持的是iptables模式</span>
	<span class="token keyword">if</span> proxyMode <span class="token operator">==</span> proxyModeIPTables <span class="token punctuation">{</span>

		<span class="token comment">// 双端模式，支持IP4和IPV6</span>
		<span class="token keyword">if</span> dualStack <span class="token punctuation">{</span>
			proxier<span class="token punctuation">,</span> err <span class="token operator">=</span> iptables<span class="token punctuation">.</span><span class="token function">NewDualStackProxier</span><span class="token punctuation">(</span>
				ipt<span class="token punctuation">,</span>
				utilsysctl<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				execer<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MinSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeAll<span class="token punctuation">,</span>
				<span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeBit<span class="token punctuation">)</span><span class="token punctuation">,</span>
				localDetectors<span class="token punctuation">,</span>
				hostname<span class="token punctuation">,</span>
				<span class="token function">nodeIPTuple</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BindAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
				recorder<span class="token punctuation">,</span>
				healthzServer<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>NodePortAddresses<span class="token punctuation">,</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			proxier<span class="token punctuation">,</span> err <span class="token operator">=</span> iptables<span class="token punctuation">.</span><span class="token function">NewProxier</span><span class="token punctuation">(</span>
				iptInterface<span class="token punctuation">,</span>
				utilsysctl<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				execer<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MinSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeAll<span class="token punctuation">,</span>
				<span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeBit<span class="token punctuation">)</span><span class="token punctuation">,</span>
				localDetector<span class="token punctuation">,</span>
				hostname<span class="token punctuation">,</span>
				nodeIP<span class="token punctuation">,</span>
				recorder<span class="token punctuation">,</span>
				healthzServer<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>NodePortAddresses<span class="token punctuation">,</span>
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to create proxier: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		proxymetrics<span class="token punctuation">.</span><span class="token function">RegisterMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">else</span> <span class="token keyword">if</span> proxyMode <span class="token operator">==</span> proxyModeIPVS <span class="token punctuation">{</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ProxyServer<span class="token punctuation">{</span>
		Client<span class="token punctuation">:</span>                 client<span class="token punctuation">,</span>
		EventClient<span class="token punctuation">:</span>            eventClient<span class="token punctuation">,</span>
		IptInterface<span class="token punctuation">:</span>           iptInterface<span class="token punctuation">,</span>
		IpvsInterface<span class="token punctuation">:</span>          ipvsInterface<span class="token punctuation">,</span>
		IpsetInterface<span class="token punctuation">:</span>         ipsetInterface<span class="token punctuation">,</span>
		execer<span class="token punctuation">:</span>                 execer<span class="token punctuation">,</span>
		Proxier<span class="token punctuation">:</span>                proxier<span class="token punctuation">,</span>
		Broadcaster<span class="token punctuation">:</span>            eventBroadcaster<span class="token punctuation">,</span>
		Recorder<span class="token punctuation">:</span>               recorder<span class="token punctuation">,</span>
		ConntrackConfiguration<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Conntrack<span class="token punctuation">,</span>
		Conntracker<span class="token punctuation">:</span>            <span class="token operator">&amp;</span>realConntracker<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		ProxyMode<span class="token punctuation">:</span>              proxyMode<span class="token punctuation">,</span>
		NodeRef<span class="token punctuation">:</span>                nodeRef<span class="token punctuation">,</span>
		MetricsBindAddress<span class="token punctuation">:</span>     config<span class="token punctuation">.</span>MetricsBindAddress<span class="token punctuation">,</span>
		BindAddressHardFail<span class="token punctuation">:</span>    config<span class="token punctuation">.</span>BindAddressHardFail<span class="token punctuation">,</span>
		EnableProfiling<span class="token punctuation">:</span>        config<span class="token punctuation">.</span>EnableProfiling<span class="token punctuation">,</span>
		OOMScoreAdj<span class="token punctuation">:</span>            config<span class="token punctuation">.</span>OOMScoreAdj<span class="token punctuation">,</span>
		ConfigSyncPeriod<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
		HealthzServer<span class="token punctuation">:</span>          healthzServer<span class="token punctuation">,</span>
		UseEndpointSlices<span class="token punctuation">:</span>      useEndpointSlices<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br></div></div><p>再来看<code>iptables.NewProxier()</code>​方法</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewProxier</span><span class="token punctuation">(</span>ipt utiliptables<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	sysctl utilsysctl<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	exec utilexec<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	syncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
	minSyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
	masqueradeAll <span class="token builtin">bool</span><span class="token punctuation">,</span>
	masqueradeBit <span class="token builtin">int</span><span class="token punctuation">,</span>
	localDetector proxyutiliptables<span class="token punctuation">.</span>LocalTrafficDetector<span class="token punctuation">,</span>
	hostname <span class="token builtin">string</span><span class="token punctuation">,</span>
	nodeIP net<span class="token punctuation">.</span>IP<span class="token punctuation">,</span>
	recorder events<span class="token punctuation">.</span>EventRecorder<span class="token punctuation">,</span>
	healthzServer healthcheck<span class="token punctuation">.</span>ProxierHealthUpdater<span class="token punctuation">,</span>
	nodePortAddresses <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Proxier<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// 这个就是0x4000，也就是给数据包打上标记，在出主机的时候会进行SNAT</span>
	masqueradeValue <span class="token operator">:=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token function">uint</span><span class="token punctuation">(</span>masqueradeBit<span class="token punctuation">)</span>
	masqueradeMark <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%#08x&quot;</span><span class="token punctuation">,</span> masqueradeValue<span class="token punctuation">)</span>

    <span class="token comment">// 创建健康检查服务</span>
	serviceHealthServer <span class="token operator">:=</span> healthcheck<span class="token punctuation">.</span><span class="token function">NewServiceHealthServer</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> recorder<span class="token punctuation">,</span> nodePortAddresses<span class="token punctuation">)</span>

	proxier <span class="token operator">:=</span> <span class="token operator">&amp;</span>Proxier<span class="token punctuation">{</span>
		serviceMap<span class="token punctuation">:</span>               <span class="token function">make</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>ServiceMap<span class="token punctuation">)</span><span class="token punctuation">,</span>
		serviceChanges<span class="token punctuation">:</span>           proxy<span class="token punctuation">.</span><span class="token function">NewServiceChangeTracker</span><span class="token punctuation">(</span>newServiceInfo<span class="token punctuation">,</span> ipFamily<span class="token punctuation">,</span> recorder<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		endpointsMap<span class="token punctuation">:</span>             <span class="token function">make</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>EndpointsMap<span class="token punctuation">)</span><span class="token punctuation">,</span>
		endpointsChanges<span class="token punctuation">:</span>         proxy<span class="token punctuation">.</span><span class="token function">NewEndpointChangeTracker</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> newEndpointInfo<span class="token punctuation">,</span> ipFamily<span class="token punctuation">,</span> recorder<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		syncPeriod<span class="token punctuation">:</span>               syncPeriod<span class="token punctuation">,</span>
		iptables<span class="token punctuation">:</span>                 ipt<span class="token punctuation">,</span>
		masqueradeAll<span class="token punctuation">:</span>            masqueradeAll<span class="token punctuation">,</span>
		masqueradeMark<span class="token punctuation">:</span>           masqueradeMark<span class="token punctuation">,</span>
		exec<span class="token punctuation">:</span>                     exec<span class="token punctuation">,</span>
		localDetector<span class="token punctuation">:</span>            localDetector<span class="token punctuation">,</span>
		hostname<span class="token punctuation">:</span>                 hostname<span class="token punctuation">,</span>
		nodeIP<span class="token punctuation">:</span>                   nodeIP<span class="token punctuation">,</span>
		recorder<span class="token punctuation">:</span>                 recorder<span class="token punctuation">,</span>
		serviceHealthServer<span class="token punctuation">:</span>      serviceHealthServer<span class="token punctuation">,</span>
		healthzServer<span class="token punctuation">:</span>            healthzServer<span class="token punctuation">,</span>
		precomputedProbabilities<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		iptablesData<span class="token punctuation">:</span>             bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		existingFilterChainsData<span class="token punctuation">:</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		filterChains<span class="token punctuation">:</span>             utilproxy<span class="token punctuation">.</span>LineBuffer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		filterRules<span class="token punctuation">:</span>              utilproxy<span class="token punctuation">.</span>LineBuffer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		natChains<span class="token punctuation">:</span>                utilproxy<span class="token punctuation">.</span>LineBuffer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		natRules<span class="token punctuation">:</span>                 utilproxy<span class="token punctuation">.</span>LineBuffer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		nodePortAddresses<span class="token punctuation">:</span>        nodePortAddresses<span class="token punctuation">,</span>
		networkInterfacer<span class="token punctuation">:</span>        utilproxy<span class="token punctuation">.</span>RealNetwork<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	burstSyncs <span class="token operator">:=</span> <span class="token number">2</span>
    <span class="token comment">// syncRunner是用来控制刷新iptables规则频率的运行器，proxier.syncProxyRules方法就是真正刷新iptables规则的方法</span>
   	proxier<span class="token punctuation">.</span>syncRunner <span class="token operator">=</span> async<span class="token punctuation">.</span><span class="token function">NewBoundedFrequencyRunner</span><span class="token punctuation">(</span><span class="token string">&quot;sync-runner&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>syncProxyRules<span class="token punctuation">,</span> minSyncPeriod<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span> burstSyncs<span class="token punctuation">)</span>

	<span class="token comment">// 这里启用一个goroutine。在三个表中都创建一个KUBE-PROXY-CANARY子链，通过子链是否存在来判断iptables是否被刷掉。</span>
	<span class="token comment">// 如果该链不存在，说明iptables被刷掉了，再次执行syncProxyRules方法刷回来。</span>
	<span class="token keyword">go</span> ipt<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>kubeProxyCanaryChain<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Table<span class="token punctuation">{</span>utiliptables<span class="token punctuation">.</span>TableMangle<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span>TableNAT<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span>TableFilter<span class="token punctuation">}</span><span class="token punctuation">,</span>
		proxier<span class="token punctuation">.</span>syncProxyRules<span class="token punctuation">,</span> syncPeriod<span class="token punctuation">,</span> wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>
	<span class="token keyword">return</span> proxier<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>以上主要的对象已经初始化完成了。</p> <h2 id="run"><a href="#run" class="header-anchor">#</a> Run</h2> <p>回到<code>o.Run()</code>​方法中，先是创建ProxyServer对象，然后在其中又创建proxier对象，做了一系列初始化动作，接下来就是运行代理服务了，现在看向<code>runLoop</code>​方法</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token function">runLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// 开启文件监听</span>
	<span class="token keyword">if</span> o<span class="token punctuation">.</span>watcher <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		o<span class="token punctuation">.</span>watcher<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// run the proxy in goroutine</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		err <span class="token operator">:=</span> o<span class="token punctuation">.</span>proxyServer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		o<span class="token punctuation">.</span>errCh <span class="token operator">&lt;-</span> err
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 如果接受到errCh则停止服务</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>o<span class="token punctuation">.</span>errCh
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>再看向<code>o.proxyServer.Run()</code>​方法，运行代理服务的主流程。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ProxyServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// 设置当前进程的OOM参数，资源紧张时，不优先kill掉kube-proxy</span>
	<span class="token keyword">var</span> oomAdjuster <span class="token operator">*</span>oom<span class="token punctuation">.</span>OOMAdjuster
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>OOMScoreAdj <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		oomAdjuster <span class="token operator">=</span> oom<span class="token punctuation">.</span><span class="token function">NewOOMAdjuster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> oomAdjuster<span class="token punctuation">.</span><span class="token function">ApplyOOMScoreAdj</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">.</span>OOMScoreAdj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InfoS</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to apply OOMScore&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;err&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 开启健康检查服务</span>
	<span class="token function">serveHealthz</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>HealthzServer<span class="token punctuation">,</span> errCh<span class="token punctuation">)</span>

	<span class="token comment">// 开启指标上报服务</span>
	<span class="token function">serveMetrics</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MetricsBindAddress<span class="token punctuation">,</span> s<span class="token punctuation">.</span>ProxyMode<span class="token punctuation">,</span> s<span class="token punctuation">.</span>EnableProfiling<span class="token punctuation">,</span> errCh<span class="token punctuation">)</span>

	<span class="token comment">// 创建informer</span>
	informerFactory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactoryWithOptions</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">,</span>
		informers<span class="token punctuation">.</span><span class="token function">WithTweakListOptions</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>options <span class="token operator">*</span>metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			options<span class="token punctuation">.</span>LabelSelector <span class="token operator">=</span> labelSelector<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 监听service和endpoint并注册事件，当发生变化时，则会进行刷新iptables规则</span>
	serviceConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewServiceConfig</span><span class="token punctuation">(</span>informerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">)</span>
	serviceConfig<span class="token punctuation">.</span><span class="token function">RegisterEventHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Proxier<span class="token punctuation">)</span>
	<span class="token keyword">go</span> serviceConfig<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>

	<span class="token keyword">if</span> endpointsHandler<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>Proxier<span class="token punctuation">.</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>EndpointsHandler<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>UseEndpointSlices <span class="token punctuation">{</span>
		endpointsConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewEndpointsConfig</span><span class="token punctuation">(</span>informerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Endpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">)</span>
		endpointsConfig<span class="token punctuation">.</span><span class="token function">RegisterEventHandler</span><span class="token punctuation">(</span>endpointsHandler<span class="token punctuation">)</span>
		<span class="token keyword">go</span> endpointsConfig<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		endpointSliceConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewEndpointSliceConfig</span><span class="token punctuation">(</span>informerFactory<span class="token punctuation">.</span><span class="token function">Discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EndpointSlices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">)</span>
		endpointSliceConfig<span class="token punctuation">.</span><span class="token function">RegisterEventHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Proxier<span class="token punctuation">)</span>
		<span class="token keyword">go</span> endpointSliceConfig<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	informerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>

	<span class="token comment">// 发送启动事件</span>
	s<span class="token punctuation">.</span><span class="token function">birthCry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> s<span class="token punctuation">.</span>Proxier<span class="token punctuation">.</span><span class="token function">SyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&lt;-</span>errCh
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="service-和-endpointslice-变更事件"><a href="#service-和-endpointslice-变更事件" class="header-anchor">#</a> service 和 endpointslice 变更事件</h2> <p>程序中是通过informer来实现对service和endpoint发生变化的监听，感知变化，并触发事件并进行相应的处理。</p> <p>先看一下<code>NewServiceConfig()</code>​方法，其中注册了当service发生增、删、改事件时，分别执行<code>result.handleAddService</code>​、<code>result.handleUpdateService</code>​、<code>result.handleDeleteService</code>​方法。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewServiceConfig</span><span class="token punctuation">(</span>serviceInformer coreinformers<span class="token punctuation">.</span>ServiceInformer<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token operator">*</span>ServiceConfig <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> <span class="token operator">&amp;</span>ServiceConfig<span class="token punctuation">{</span>
		listerSynced<span class="token punctuation">:</span> serviceInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 注册变更事件</span>
	serviceInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span>
		cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
			AddFunc<span class="token punctuation">:</span>    result<span class="token punctuation">.</span>handleAddService<span class="token punctuation">,</span>
			UpdateFunc<span class="token punctuation">:</span> result<span class="token punctuation">.</span>handleUpdateService<span class="token punctuation">,</span>
			DeleteFunc<span class="token punctuation">:</span> result<span class="token punctuation">.</span>handleDeleteService<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		resyncPeriod<span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>再看看其中的<code>handleAddService()</code>​方法，传入的参数obj就是新增的service对象，然后传入eventHandler.OnServiceAdd()方法进行处理。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ServiceConfig<span class="token punctuation">)</span> <span class="token function">handleAddService</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	service<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected object type: %v&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>eventHandlers <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InfoS</span><span class="token punctuation">(</span><span class="token string">&quot;Calling handler.OnServiceAdd&quot;</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>eventHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">OnServiceAdd</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里c.eventHanlders其实就是proxier对象，在<code>RegisterEventHandler()</code>方法中将其添加进去的。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>serviceConfig<span class="token punctuation">.</span><span class="token function">RegisterEventHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Proxier<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是说，<code>proxier.OnServiceAdd()</code>才是需要触发的处理方法</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceAdd</span><span class="token punctuation">(</span>service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	proxier<span class="token punctuation">.</span><span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第一个参数为旧的service，第二参数为新的参数。该方法给可以<code>OnServiceAdd</code>​复用，传入的第一个参数为nil，第二个参数不为nil，就是新增的操作。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span>oldService<span class="token punctuation">,</span> service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> proxier<span class="token punctuation">.</span>serviceChanges<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>oldService<span class="token punctuation">,</span> service<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> proxier<span class="token punctuation">.</span><span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		proxier<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>还可以看到删除操作也能复用，有旧的service，而新service为nil代表删除。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// OnServiceDelete is called whenever deletion of an existing service</span>
<span class="token comment">// object is observed.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceDelete</span><span class="token punctuation">(</span>service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	proxier<span class="token punctuation">.</span><span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>无论是增、删、改都会执行到<code>proxier.Sync()</code>方法</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> proxier<span class="token punctuation">.</span>healthzServer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		proxier<span class="token punctuation">.</span>healthzServer<span class="token punctuation">.</span><span class="token function">QueuedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	metrics<span class="token punctuation">.</span>SyncProxyRulesLastQueuedTimestamp<span class="token punctuation">.</span><span class="token function">SetToCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	proxier<span class="token punctuation">.</span>syncRunner<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最终到<code>proxier.syncRunner.Run()</code>​方法，可以看出它会发送一个信号到bfr.run管道中。该方法除了是service发生事件执行操作的终点外，endpoint发生事件后最终也会执行到这里。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>bfr <span class="token operator">*</span>BoundedFrequencyRunner<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// If it takes a lot of time to run the underlying function, noone is really</span>
	<span class="token comment">// processing elements from &lt;run&gt; channel. So to avoid blocking here on the</span>
	<span class="token comment">// putting element to it, we simply skip it if there is already an element</span>
	<span class="token comment">// in it.</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> bfr<span class="token punctuation">.</span>run <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="boundedfrequencyrunner"><a href="#boundedfrequencyrunner" class="header-anchor">#</a> BoundedFrequencyRunner</h2> <p>我们再回到代理服务的<code>ProxyServe.Run</code>​方法，最后执行了<code>s.Proxier.SyncLoop()</code>​</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">SyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Update healthz timestamp at beginning in case Sync() never succeeds.</span>
	<span class="token keyword">if</span> proxier<span class="token punctuation">.</span>healthzServer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		proxier<span class="token punctuation">.</span>healthzServer<span class="token punctuation">.</span><span class="token function">Updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// synthesize &quot;last change queued&quot; time as the informers are syncing.</span>
	metrics<span class="token punctuation">.</span>SyncProxyRulesLastQueuedTimestamp<span class="token punctuation">.</span><span class="token function">SetToCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	proxier<span class="token punctuation">.</span>syncRunner<span class="token punctuation">.</span><span class="token function">Loop</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后再执行<code>proxier.syncRunner.Loop()</code>​方法</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>bfr <span class="token operator">*</span>BoundedFrequencyRunner<span class="token punctuation">)</span> <span class="token function">Loop</span><span class="token punctuation">(</span>stop <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s Loop running&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>bfr<span class="token punctuation">.</span>maxInterval<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stop<span class="token punctuation">:</span>
			bfr<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s Loop stopping&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			bfr<span class="token punctuation">.</span><span class="token function">tryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>bfr<span class="token punctuation">.</span>run<span class="token punctuation">:</span>
			bfr<span class="token punctuation">.</span><span class="token function">tryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>bfr<span class="token punctuation">.</span>retry<span class="token punctuation">:</span>
			bfr<span class="token punctuation">.</span><span class="token function">doRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>可以看到如果bfr.run管道接收到了信号，会执行<code>brf.tryRun()</code>​方法，在这个方法中会执行<code>proxier.syncProxyRules()</code>​进行刷新iptables规则。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// assumes the lock is not held</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>bfr <span class="token operator">*</span>BoundedFrequencyRunner<span class="token punctuation">)</span> <span class="token function">tryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	bfr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> bfr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 这里会限制访问速率，看是否可以执行。</span>
	<span class="token keyword">if</span> bfr<span class="token punctuation">.</span>limiter<span class="token punctuation">.</span><span class="token function">TryAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里的fn就是proxier.syncProxyRules方法</span>
		bfr<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		bfr<span class="token punctuation">.</span>lastRun <span class="token operator">=</span> bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>bfr<span class="token punctuation">.</span>maxInterval<span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: ran, next possible in %v, periodic in %v&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>minInterval<span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>maxInterval<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// It can't run right now, figure out when it can run next.</span>
	elapsed <span class="token operator">:=</span> bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>bfr<span class="token punctuation">.</span>lastRun<span class="token punctuation">)</span>   <span class="token comment">// how long since last run</span>
	nextPossible <span class="token operator">:=</span> bfr<span class="token punctuation">.</span>minInterval <span class="token operator">-</span> elapsed <span class="token comment">// time to next possible run</span>
	nextScheduled <span class="token operator">:=</span> bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// time to next scheduled run</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: %v since last run, possible in %v, scheduled in %v&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">,</span> elapsed<span class="token punctuation">,</span> nextPossible<span class="token punctuation">,</span> nextScheduled<span class="token punctuation">)</span>

	<span class="token comment">// It's hard to avoid race conditions in the unit tests unless we always reset</span>
	<span class="token comment">// the timer here, even when it's unchanged</span>
	<span class="token keyword">if</span> nextPossible <span class="token operator">&lt;</span> nextScheduled <span class="token punctuation">{</span>
		nextScheduled <span class="token operator">=</span> nextPossible
	<span class="token punctuation">}</span>
	bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>nextScheduled<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="syncproxyrules"><a href="#syncproxyrules" class="header-anchor">#</a> syncProxyRules</h2> <p>该方法主要是更新节点上的iptables规则。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// 获取service和endpoint发生变化的数据</span>
	serviceUpdateResult <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>serviceMap<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>serviceChanges<span class="token punctuation">)</span>
	endpointUpdateResult <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>endpointsMap<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>endpointsChanges<span class="token punctuation">)</span>


	<span class="token comment">// 创建一些必要的iptables链</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> jump <span class="token operator">:=</span> <span class="token keyword">range</span> iptablesJumpChains <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">EnsureChain</span><span class="token punctuation">(</span>jump<span class="token punctuation">.</span>table<span class="token punctuation">,</span> jump<span class="token punctuation">.</span>dstChain<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Failed to ensure chain exists&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">,</span> jump<span class="token punctuation">.</span>table<span class="token punctuation">,</span> <span class="token string">&quot;chain&quot;</span><span class="token punctuation">,</span> jump<span class="token punctuation">.</span>dstChain<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		args <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>jump<span class="token punctuation">.</span>extraArgs<span class="token punctuation">,</span>
			<span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> jump<span class="token punctuation">.</span>comment<span class="token punctuation">,</span>
			<span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>jump<span class="token punctuation">.</span>dstChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">EnsureRule</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>Prepend<span class="token punctuation">,</span> jump<span class="token punctuation">.</span>table<span class="token punctuation">,</span> jump<span class="token punctuation">.</span>srcChain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Failed to ensure chain jumps&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">,</span> jump<span class="token punctuation">.</span>table<span class="token punctuation">,</span> <span class="token string">&quot;srcChain&quot;</span><span class="token punctuation">,</span> jump<span class="token punctuation">.</span>srcChain<span class="token punctuation">,</span> <span class="token string">&quot;dstChain&quot;</span><span class="token punctuation">,</span> jump<span class="token punctuation">.</span>dstChain<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> iptablesEnsureChains <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">EnsureChain</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>table<span class="token punctuation">,</span> ch<span class="token punctuation">.</span>chain<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Failed to ensure chain exists&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>table<span class="token punctuation">,</span> <span class="token string">&quot;chain&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>chain<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 将当前filter表中所有存在的规则写入existingFilterChainsData中</span>
	proxier<span class="token punctuation">.</span>existingFilterChainsData<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">SaveInto</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>TableFilter<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>existingFilterChainsData<span class="token punctuation">)</span>

	<span class="token comment">// 将nat表中所有存在的规则写入iptablesData中</span>
	proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">SaveInto</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>TableNAT<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">)</span>

	<span class="token comment">// 将filter和nat链中必要添加的子链，通过字符串拼接的方式写入变量filterChains和natChains中</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chainName <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">{</span>kubeServicesChain<span class="token punctuation">,</span> kubeExternalServicesChain<span class="token punctuation">,</span> kubeForwardChain<span class="token punctuation">,</span> kubeNodePortsChain<span class="token punctuation">}</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingFilterChains<span class="token punctuation">[</span>chainName<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">.</span><span class="token function">WriteBytes</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>chainName<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chainName <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">{</span>kubeServicesChain<span class="token punctuation">,</span> kubeNodePortsChain<span class="token punctuation">,</span> kubePostroutingChain<span class="token punctuation">,</span> KubeMarkMasqChain<span class="token punctuation">}</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingNATChains<span class="token punctuation">[</span>chainName<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">.</span><span class="token function">WriteBytes</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>chainName<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 后面就是将各种的iptables规则通过字符串拼接起来</span>
    <span class="token operator">...</span>

	<span class="token comment">// 将所有链和规则的iptables全部集成到一起iptablesData，然后再通过iptables-restore命令刷新到节点中。</span>
	proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">RestoreAll</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span>NoFlushTables<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span>RestoreCounters<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">ErrorS</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Failed to execute iptables-restore&quot;</span><span class="token punctuation">)</span>
		metrics<span class="token punctuation">.</span>IptablesRestoreFailuresTotal<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p><strong>总结</strong></p> <ol><li>获取发生变更的 service 和 endpoint 信息</li> <li>创建一些必要的链</li> <li>使用 iptables-save 命令，将当前环境中 nat 和 filter 表中的 iptables 规则全部加载到程序中。</li> <li>通过拼接字符串，构造出需要创建的 iptables 规则字符串。</li> <li>通过 iptables-restore 命令，将构造的 iptables 规则字符串全部再刷新到节点上</li></ol> <p><strong>思考</strong></p> <p>因为每一次都会将当前所有的iptables规则全部刷新到节点上，如果规则量过大的话，性能会受到影响，所以才有ipvs模式。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>整体代码流程如下：</p> <ol><li>首先是各种对象套娃式的初始化，Options-&gt;ProxyServier-&gt;proxier-&gt;syncRunner</li> <li>然后是向informer中注册service和endpoint事件，当发生改动时，会给bfr.run发送信号</li> <li>syncRunner收到信号会去执行proxier.syncProxyRules()方法，刷新主机的iptables规则</li></ol> <p><img src="https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png" alt=""></p> <h2 id="相关链接"><a href="#相关链接" class="header-anchor">#</a> 相关链接</h2> <p><a href="https://isekiro.com/kubernetes%E6%BA%90%E7%A0%81-kube-proxy-%E5%8E%9F%E7%90%86%E5%92%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80/" target="_blank" rel="noopener noreferrer">kubernetes 源码-kube-proxy 原理和源码分析（一）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.haohtml.com/archives/33728/" target="_blank" rel="noopener noreferrer">kube-proxy 源码解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://youerning.top/post/kubernetes/kube-proxy/" target="_blank" rel="noopener noreferrer">kube-proxy 保姆级别源码阅读<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.thebyte.com.cn/network/conntrack.html" target="_blank" rel="noopener noreferrer">连接跟踪 conntrack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.haohtml.com/archives/32179" target="_blank" rel="noopener noreferrer">kubernetes 之 client-go 之 informer 工作原理源码解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.csdn.net/qq_33745102/article/details/127966484" target="_blank" rel="noopener noreferrer">Kubernetes EndpointSlice 和 Endpoint 对象的区别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>‍</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=k8s" title="标签">#k8s</a><a href="/tags/?tag=%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" title="标签">#源码分析</a><a href="/tags/?tag=go" title="标签">#go</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/02/09, 23:47:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/b3955c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">kubernetes service如何通过iptables转发</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/b3955c/" class="prev">kubernetes service如何通过iptables转发</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/de98b1/"><div>
            服务启动时出现 OOM
            <!----></div></a> <span class="date">09-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cf65ba/"><div>
            一次服务升级时pg表DDL执行超时失败
            <!----></div></a> <span class="date">09-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/d8ed61/"><div>
            Go语言高效IO缓冲技术详解
            <!----></div></a> <span class="date">06-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:326695231@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tenqaz" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.zhengwenfeng.com/rss.xml" title="RSS订阅" target="_blank" class="iconfont icon-rss"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2025
    <span>zhengwenfeng | <a href="https://github.com/tenqaz/tenqaz.github.io/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/assets/js/app.af2152b2.js" defer></script><script src="/assets/js/2.ebc69a32.js" defer></script><script src="/assets/js/26.1815479a.js" defer></script>
  </body>
</html>
