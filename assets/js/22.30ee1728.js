(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{380:function(s,t,a){"use strict";a.r(t);var e=a(5),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_0-简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_0-简介"}},[s._v("#")]),s._v(" 0.简介")]),s._v(" "),t("p",[s._v("通过指标监控可以设置对应的告警，快速发现问题，并通过相应的指标定位问题。")]),s._v(" "),t("p",[s._v("背景：使用的 VictoriaMetrics(简称 VM) 作为监控的解决方案，需要将 django 服务、logstash 和 flink 引擎接入进来，VM 可以实时的获取它们的指标存储并进行监控告警，以上的服务都是部署在 k8s 中的。")]),s._v(" "),t("h2",{attrs:{id:"_1-victoriametrics"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-victoriametrics"}},[s._v("#")]),s._v(" 1.VictoriaMetrics")]),s._v(" "),t("p",[s._v("VictoriaMetrics，是一个快速高效、经济并且可扩展的监控解决方案和时序数据库。比较出名的监控方案有 Promethues，而 VM 是兼容 Promethues 的各种规范、配置等，可以快速的融入 Promethues 生态甚至是取代它。")]),s._v(" "),t("p",[s._v("VM 获取服务指标的方式也是通过主动拉取的方式，每个服务都会暴露一个端口供 VM 来拉取服务的指标信息")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230221110733.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"_2-django-服务接入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-django-服务接入"}},[s._v("#")]),s._v(" 2.django 服务接入")]),s._v(" "),t("p",[s._v("可以通过使用第三方库 "),t("a",{attrs:{href:"https://github.com/prometheus/client_python",target:"_blank",rel:"noopener noreferrer"}},[s._v("prometheus-client"),t("OutboundLink")],1),s._v(" 来收集服务的指标信息，并暴露端口给 VM 拉取。")]),s._v(" "),t("ul",[t("li",[s._v("安装")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("pip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" prometheus-client\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("使用")])]),s._v(" "),t("p",[s._v("因为该服务使用的是 wsgi 协议的，所以在 wsgi.py 文件中添加以下代码，会开启一个新的线程监听 9300 端口，请求该端口可以获取当前服务的参数指标。")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" prometheus_client "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" start_wsgi_server\nstart_wsgi_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("如果想要上报业务指标，可以通过该库在业务中进行埋点和收集。")]),s._v(" "),t("p",[s._v("还需要在 pod 中添加 ports 属性提供给 VM 使用，这个在后面讲解。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" exportport\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"_3-logstash-接入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-logstash-接入"}},[s._v("#")]),s._v(" 3.logstash 接入")]),s._v(" "),t("p",[s._v("logstash 是有自己的指标监控服务，需要在配置文件 logstash.yaml 中将其端口暴露。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http.port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("但是其指标格式和 prometheus 的指标格式是不同的，所以需要通过另一个程序 exporter 来将 logstash 指标转换成 prometheus 指标格式。")]),s._v(" "),t("p",[s._v("该 logstash 是部署在 k8s 中的，使用到容器设计模式 sidecar，就是在 pod 中新增一个容器来辅助主容器 logstash 来做监控指标的转换并提供给 VM 调用。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230221110822.png",alt:""}})]),s._v(" "),t("p",[s._v("logstash 的 exporter 可以使用 "),t("a",{attrs:{href:"https://github.com/alxrem/prometheus-logstash-exporter",target:"_blank",rel:"noopener noreferrer"}},[s._v("prometheus-logstash-exporter"),t("OutboundLink")],1),s._v(" 来完成，可以去 docker hub 中找到对应的镜像，并将其下载下来使用。")]),s._v(" "),t("p",[s._v("在 logstash 的 pod 中添加以下配置来设置 exporter，将暴露 9300 端口作为 logstash 的指标监控端口给 VM 拉取。这里需要配置 ports，在 VM 中需要使用该参数。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" logstash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("exporter\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alxrem/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("logstash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("0.7.0\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("args")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("logstash.host\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" 127.0.0.1\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("logstash.port\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9600")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web.listen"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("address\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" exportport\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h2",{attrs:{id:"_4-flink-接入监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-flink-接入监控"}},[s._v("#")]),s._v(" 4.flink 接入监控")]),s._v(" "),t("p",[s._v("flink 本身是支持 prometheus 的指标监控，只需要通过添加配置 flink 的参数即可开启。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics.reporters")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prom\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics.reporter.prom.class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" org.apache.flink.metrics.prometheus.PrometheusReporter\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics.reporter.prom.port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"9300"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("除了上面的配置外，还需要在 Pod 中设置 ports 来供 VM 使用。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" exportport\n\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"_5-vmpodscrape"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-vmpodscrape"}},[s._v("#")]),s._v(" 5.VMPodScrape")]),s._v(" "),t("p",[s._v("虽然上面的服务都暴露了指标端口，VM 如何找到它们呢？需要通过创建 VMPodScrape 的资源对象来帮助 VM 来找到它们。")]),s._v(" "),t("p",[s._v("配置如下：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" operator.victoriametrics.com/v1beta1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" VMPodScrape\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prometheus")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" demo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("monitor          \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitor\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("any")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("                   \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podMetricsEndpoints")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /metrics            \n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" exportport          \n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" django\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("ul",[t("li",[s._v("spec.podMetricsEndpoints.port，这个就是在每个 pod 中添加的 ports 中对应的 name，VM 会去找到对应 name 的端口获取指标")]),s._v(" "),t("li",[s._v("spec.selector.matchLabels，通过标签过滤找到指定的 pod")])]),s._v(" "),t("p",[s._v("通过 "),t("code",[s._v("kubectl apply -f")]),s._v(" 创建该资源对象，VM 就能找到指标提供的服务。")])])}),[],!1,null,null,null);t.default=n.exports}}]);