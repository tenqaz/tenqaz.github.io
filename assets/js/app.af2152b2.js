(window.webpackJsonp=window.webpackJsonp||[]).push([[0],[]]);!function(n){function e(e){for(var r,s,i=e[0],l=e[1],c=e[2],d=0,u=[];d<i.length;d++)s=i[d],Object.prototype.hasOwnProperty.call(o,s)&&o[s]&&u.push(o[s][0]),o[s]=0;for(r in l)Object.prototype.hasOwnProperty.call(l,r)&&(n[r]=l[r]);for(p&&p(e);u.length;)u.shift()();return a.push.apply(a,c||[]),t()}function t(){for(var n,e=0;e<a.length;e++){for(var t=a[e],r=!0,i=1;i<t.length;i++){var l=t[i];0!==o[l]&&(r=!1)}r&&(a.splice(e--,1),n=s(s.s=t[0]))}return n}var r={},o={1:0},a=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(n){var e=[],t=o[n];if(0!==t)if(t)e.push(t[2]);else{var r=new Promise((function(e,r){t=o[n]=[e,r]}));e.push(t[2]=r);var a,i=document.createElement("script");i.charset="utf-8",i.timeout=120,s.nc&&i.setAttribute("nonce",s.nc),i.src=function(n){return s.p+"assets/js/"+({}[n]||n)+"."+{2:"ebc69a32",3:"25c614f0",4:"542e9b82",5:"4bcce552",6:"d41e8bf9",7:"e928a25b",8:"ddf992e7",9:"faedc087",10:"6c4c4ab9",11:"679678d6",12:"deaf25f7",13:"985315df",14:"7787d897",15:"635b8f55",16:"a7f9bb48",17:"1832ebcb",18:"ac9e3253",19:"3e4bc6eb",20:"984e29ec",21:"3f37f8b8",22:"30ee1728",23:"489c8b6d",24:"65478516",25:"440f402d",26:"1815479a",27:"f5b8cee5",28:"9a6cf032",29:"ce8ffc27",30:"f24cccf9",31:"a6875203",32:"17e4d471",33:"fac1c69e",34:"2b94da57",35:"6079a664",36:"1f99cd1d",37:"c91aaa19",38:"31561a65",39:"71c38fd3",40:"a76c135b",41:"e97e6cb7",42:"b808ef8f",43:"5b2a9968",44:"355b1d3b",45:"9c528887",46:"8d3eedb6",47:"8c3bbdb6",48:"66c350b9",49:"2fd99115",50:"17339639",51:"5e628842",52:"d592fe39",53:"c5dc4be4",54:"f9ec091c",55:"abf342d9",56:"5c78476c",57:"182af18e",58:"cc39e610",59:"6f032d18",60:"6b5f548a",61:"02e1a9f1",62:"50f82996",63:"71f391ec",64:"1f0993d0",65:"7448d827",66:"468ff5f8",67:"5c9486d0",68:"241d98b1",69:"72d856a7",70:"7d934840",71:"6a0d9ea4",72:"dc50c87a",73:"aa1c1691",74:"c5253135",75:"6ff54b05",76:"8bafff13",77:"40b68e0e",78:"8c8cb816",79:"f2b49dc2",80:"84394ab3",81:"dffe7377",82:"07a12478",83:"20894a19",84:"9536d25d",85:"79f06ebd",86:"e50e665c",87:"95d14ae9",88:"2cef63e5",89:"53c53bc6",90:"32c61d53",91:"f9b662b0",92:"410fa25c",93:"27703c41",94:"2d354f23",95:"a70b147a",96:"adb90937",97:"7d717f87",98:"2fb32ed1",99:"78399d6c",100:"14ecf654",101:"ef2677ae",102:"a2e87932",103:"6b933b04",104:"a2aaa7ca",105:"eae2ecc4",106:"a57cd4d0",107:"73811f03",108:"2e5bd9d4",109:"92b57358",110:"90f10894",111:"508768cb",112:"d14993ff",113:"0994f3b9",114:"13df2932",115:"fcdb35e7",116:"3b137288"}[n]+".js"}(n);var l=new Error;a=function(e){i.onerror=i.onload=null,clearTimeout(c);var t=o[n];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),a=e&&e.target&&e.target.src;l.message="Loading chunk "+n+" failed.\n("+r+": "+a+")",l.name="ChunkLoadError",l.type=r,l.request=a,t[1](l)}o[n]=void 0}};var c=setTimeout((function(){a({type:"timeout",target:i})}),12e4);i.onerror=i.onload=a,document.head.appendChild(i)}return Promise.all(e)},s.m=n,s.c=r,s.d=function(n,e,t){s.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:t})},s.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},s.t=function(n,e){if(1&e&&(n=s(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var r in n)s.d(t,r,function(e){return n[e]}.bind(null,r));return t},s.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return s.d(e,"a",e),e},s.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},s.p="/",s.oe=function(n){throw console.error(n),n};var i=window.webpackJsonp=window.webpackJsonp||[],l=i.push.bind(i);i.push=e,i=i.slice();for(var c=0;c<i.length;c++)e(i[c]);var p=l;a.push([129,0]),t()}([function(n,e,t){"use strict";var r=function(n){return n&&n.Math===Math&&n};n.exports=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof global&&global)||r("object"==typeof this&&this)||function(){return this}()||Function("return this")()},function(n,e,t){"use strict";n.exports=function(n){try{return!!n()}catch(n){return!0}}},function(n,e,t){"use strict";var r="object"==typeof document&&document.all;n.exports=void 0===r&&void 0!==r?function(n){return"function"==typeof n||n===r}:function(n){return"function"==typeof n}},function(n,e,t){"use strict";var r=t(13),o=t(0),a=t(144),s=t(4),i=t(2),l=t(87),c=t(146),p=t(147),d=t(1),u=t(11),m=t(18),g=t(88).IteratorPrototype,f=t(6),h=t(24),v=m("toStringTag"),b=TypeError,_=o.Iterator,y=h||!i(_)||_.prototype!==g||!d((function(){_({})})),k=function(){if(a(this,g),l(this)===g)throw new b("Abstract class Iterator not directly constructable")},w=function(n,e){f?c(g,n,{configurable:!0,get:function(){return e},set:function(e){if(s(this),this===g)throw new b("You can't redefine this property");u(this,n)?this[n]=e:p(this,n,e)}}):g[n]=e};u(g,v)||w(v,"Iterator"),!y&&u(g,"constructor")&&g.constructor!==Object||w("constructor",k),k.prototype=g,r({global:!0,constructor:!0,forced:y},{Iterator:k})},function(n,e,t){"use strict";var r=t(9),o=String,a=TypeError;n.exports=function(n){if(r(n))return n;throw new a(o(n)+" is not an object")}},function(n,e,t){"use strict";function r(n,e,t,r,o,a,s,i){var l,c="function"==typeof n?n.options:n;if(e&&(c.render=e,c.staticRenderFns=t,c._compiled=!0),r&&(c.functional=!0),a&&(c._scopeId="data-v-"+a),s?(l=function(n){(n=n||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(n=__VUE_SSR_CONTEXT__),o&&o.call(this,n),n&&n._registeredComponents&&n._registeredComponents.add(s)},c._ssrRegister=l):o&&(l=i?function(){o.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:o),l)if(c.functional){c._injectStyles=l;var p=c.render;c.render=function(n,e){return l.call(e),p(n,e)}}else{var d=c.beforeCreate;c.beforeCreate=d?[].concat(d,l):[l]}return{exports:n,options:c}}t.d(e,"a",(function(){return r}))},function(n,e,t){"use strict";var r=t(1);n.exports=!r((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}))},function(n,e,t){"use strict";var r=t(32),o=Function.prototype,a=o.call,s=r&&o.bind.bind(a,a);n.exports=r?s:function(n){return function(){return a.apply(n,arguments)}}},function(n,e,t){"use strict";var r=t(32),o=Function.prototype.call;n.exports=r?o.bind(o):function(){return o.apply(o,arguments)}},function(n,e,t){"use strict";var r=t(2);n.exports=function(n){return"object"==typeof n?null!==n:r(n)}},function(n,e,t){"use strict";var r=t(2),o=t(49),a=TypeError;n.exports=function(n){if(r(n))return n;throw new a(o(n)+" is not a function")}},function(n,e,t){"use strict";var r=t(7),o=t(38),a=r({}.hasOwnProperty);n.exports=Object.hasOwn||function(n,e){return a(o(n),e)}},function(n,e){var t=Array.isArray;n.exports=t},function(n,e,t){"use strict";var r=t(0),o=t(69).f,a=t(25),s=t(52),i=t(51),l=t(84),c=t(143);n.exports=function(n,e){var t,p,d,u,m,g=n.target,f=n.global,h=n.stat;if(t=f?r:h?r[g]||i(g,{}):r[g]&&r[g].prototype)for(p in e){if(u=e[p],d=n.dontCallGetSet?(m=o(t,p))&&m.value:t[p],!c(f?p:g+(h?".":"#")+p,n.forced)&&void 0!==d){if(typeof u==typeof d)continue;l(u,d)}(n.sham||d&&d.sham)&&a(u,"sham",!0),s(t,p,u,n)}}},function(n,e,t){"use strict";var r=t(8),o=t(4),a=t(37);n.exports=function(n,e,t){var s,i;o(n);try{if(!(s=a(n,"return"))){if("throw"===e)throw t;return t}s=r(s,n)}catch(n){i=!0,s=n}if("throw"===e)throw t;if(i)throw s;return o(s),t}},function(n,e,t){var r=t(99),o="object"==typeof self&&self&&self.Object===Object&&self,a=r||o||Function("return this")();n.exports=a},function(n,e,t){"use strict";var r=t(13),o=t(8),a=t(10),s=t(4),i=t(28),l=t(90),c=t(91),p=t(24),d=t(14),u=t(92),m=t(29),g=!p&&!u("filter",(function(){})),f=!p&&!g&&m("filter",TypeError),h=p||g||f,v=l((function(){for(var n,e,t=this.iterator,r=this.predicate,a=this.next;;){if(n=s(o(a,t)),this.done=!!n.done)return;if(e=n.value,c(t,r,[e,this.counter++],!0))return e}}));r({target:"Iterator",proto:!0,real:!0,forced:h},{filter:function(n){s(this);try{a(n)}catch(n){d(this,"throw",n)}return f?o(f,this,n):new v(i(this),{predicate:n})}})},function(n,e,t){"use strict";var r=t(13),o=t(8),a=t(56),s=t(10),i=t(4),l=t(28),c=t(14),p=t(29)("forEach",TypeError);r({target:"Iterator",proto:!0,real:!0,forced:p},{forEach:function(n){i(this);try{s(n)}catch(n){c(this,"throw",n)}if(p)return o(p,this,n);var e=l(this),t=0;a(e,(function(e){n(e,t++)}),{IS_RECORD:!0})}})},function(n,e,t){"use strict";var r=t(0),o=t(77),a=t(11),s=t(78),i=t(74),l=t(73),c=r.Symbol,p=o("wks"),d=l?c.for||c:c&&c.withoutSetter||s;n.exports=function(n){return a(p,n)||(p[n]=i&&a(c,n)?c[n]:d("Symbol."+n)),p[n]}},function(n,e,t){"use strict";var r=t(6),o=t(79),a=t(81),s=t(4),i=t(71),l=TypeError,c=Object.defineProperty,p=Object.getOwnPropertyDescriptor;e.f=r?a?function(n,e,t){if(s(n),e=i(e),s(t),"function"==typeof n&&"prototype"===e&&"value"in t&&"writable"in t&&!t.writable){var r=p(n,e);r&&r.writable&&(n[e]=t.value,t={configurable:"configurable"in t?t.configurable:r.configurable,enumerable:"enumerable"in t?t.enumerable:r.enumerable,writable:!1})}return c(n,e,t)}:c:function(n,e,t){if(s(n),e=i(e),s(t),o)try{return c(n,e,t)}catch(n){}if("get"in t||"set"in t)throw new l("Accessors not supported");return"value"in t&&(n[e]=t.value),n}},function(n,e,t){var r=t(199),o=t(202);n.exports=function(n,e){var t=o(n,e);return r(t)?t:void 0}},function(n,e,t){"use strict";t.d(e,"e",(function(){return r})),t.d(e,"b",(function(){return a})),t.d(e,"j",(function(){return s})),t.d(e,"g",(function(){return l})),t.d(e,"h",(function(){return c})),t.d(e,"i",(function(){return p})),t.d(e,"c",(function(){return d})),t.d(e,"f",(function(){return u})),t.d(e,"l",(function(){return m})),t.d(e,"m",(function(){return g})),t.d(e,"d",(function(){return h})),t.d(e,"k",(function(){return v})),t.d(e,"n",(function(){return b})),t.d(e,"a",(function(){return y}));t(31),t(3),t(16),t(17),t(22);const r=/#.*$/,o=/\.(md|html)$/,a=/\/$/,s=/^[a-z]+:/i;function i(n){return decodeURI(n).replace(r,"").replace(o,"")}function l(n){return s.test(n)}function c(n){return/^mailto:/.test(n)}function p(n){return/^tel:/.test(n)}function d(n){if(l(n))return n;if(!n)return"404";const e=n.match(r),t=e?e[0]:"",o=i(n);return a.test(o)?n:o+".html"+t}function u(n,e){const t=n.hash,o=function(n){const e=n&&n.match(r);if(e)return e[0]}(e);if(o&&t!==o)return!1;return i(n.path)===i(e)}function m(n,e,t){if(l(e))return{type:"external",path:e};t&&(e=function(n,e,t){const r=n.charAt(0);if("/"===r)return n;if("?"===r||"#"===r)return e+n;const o=e.split("/");t&&o[o.length-1]||o.pop();const a=n.replace(/^\//,"").split("/");for(let n=0;n<a.length;n++){const e=a[n];".."===e?o.pop():"."!==e&&o.push(e)}""!==o[0]&&o.unshift("");return o.join("/")}(e,t));const r=i(e);for(let e=0;e<n.length;e++)if(i(n[e].regularPath)===r)return Object.assign({},n[e],{type:"page",path:d(n[e].path)});return console.error(`[vuepress] No matching page found for sidebar item "${e}"`),{}}function g(n,e,t,r){const{pages:o,themeConfig:a}=t,s=r&&a.locales&&a.locales[r]||a;if("auto"===(n.frontmatter.sidebar||s.sidebar||a.sidebar))return f(n);const i=s.sidebar||a.sidebar;if(i){const{base:t,config:r}=function(n,e){if(Array.isArray(e))return{base:"/",config:e};for(const r in e)if(0===(t=n,/(\.html|\/)$/.test(t)?t:t+"/").indexOf(encodeURI(r)))return{base:r,config:e[r]};var t;return{}}(e,i);return"auto"===r?f(n):r?r.map(n=>function n(e,t,r,o=1){if("string"==typeof e)return m(t,e,r);if(Array.isArray(e))return Object.assign(m(t,e[0],r),{title:e[1]});{o>3&&console.error("[vuepress] detected a too deep nested sidebar group.");const a=e.children||[];return 0===a.length&&e.path?Object.assign(m(t,e.path,r),{title:e.title}):{type:"group",path:e.path,title:e.title,sidebarDepth:e.sidebarDepth,initialOpenGroupIndex:e.initialOpenGroupIndex,children:a.map(e=>n(e,t,r,o+1)),collapsable:!1!==e.collapsable}}}(n,o,t)):[]}return[]}function f(n){const e=h(n.headers||[]);return[{type:"group",collapsable:!1,title:n.title,path:null,children:e.map(e=>({type:"auto",title:e.title,basePath:n.path,path:n.path+"#"+e.slug,children:e.children||[]}))}]}function h(n){let e;return(n=n.map(n=>Object.assign({},n))).forEach(n=>{2===n.level?e=n:e&&(e.children||(e.children=[])).push(n)}),n.filter(n=>2===n.level)}function v(n){return Object.assign(n,{type:n.items&&n.items.length?"links":"link"})}function b(n){return Object.prototype.toString.call(n).match(/\[object (.*?)\]/)[1].toLowerCase()}function _(n){let e=n.frontmatter.date||n.lastUpdated||new Date,t=new Date(e);return"Invalid Date"==t&&e&&(t=new Date(e.replace(/-/g,"/"))),t.getTime()}function y(n,e){return _(e)-_(n)}},function(n,e,t){"use strict";var r=t(13),o=t(8),a=t(10),s=t(4),i=t(28),l=t(90),c=t(91),p=t(14),d=t(92),u=t(29),m=t(24),g=!m&&!d("map",(function(){})),f=!m&&!g&&u("map",TypeError),h=m||g||f,v=l((function(){var n=this.iterator,e=s(o(this.next,n));if(!(this.done=!!e.done))return c(n,this.mapper,[e.value,this.counter++],!0)}));r({target:"Iterator",proto:!0,real:!0,forced:h},{map:function(n){s(this);try{a(n)}catch(n){p(this,"throw",n)}return f?o(f,this,n):new v(i(this),{mapper:n})}})},function(n,e){n.exports=function(n){return null!=n&&"object"==typeof n}},function(n,e,t){"use strict";n.exports=!1},function(n,e,t){"use strict";var r=t(6),o=t(19),a=t(33);n.exports=r?function(n,e,t){return o.f(n,e,a(1,t))}:function(n,e,t){return n[e]=t,n}},function(n,e,t){var r=t(30),o=t(184),a=t(185),s=r?r.toStringTag:void 0;n.exports=function(n){return null==n?void 0===n?"[object Undefined]":"[object Null]":s&&s in Object(n)?o(n):a(n)}},function(n,e,t){"use strict";var r=t(7),o=r({}.toString),a=r("".slice);n.exports=function(n){return a(o(n),8,-1)}},function(n,e,t){"use strict";n.exports=function(n){return{iterator:n,next:n.next,done:!1}}},function(n,e,t){"use strict";var r=t(0);n.exports=function(n,e){var t=r.Iterator,o=t&&t.prototype,a=o&&o[n],s=!1;if(a)try{a.call({next:function(){return{done:!0}},return:function(){s=!0}},-1)}catch(n){n instanceof e||(s=!1)}if(!s)return a}},function(n,e,t){var r=t(15).Symbol;n.exports=r},function(n,e,t){"use strict";var r=t(13),o=t(38),a=t(39),s=t(178),i=t(180);r({target:"Array",proto:!0,arity:1,forced:t(1)((function(){return 4294967297!==[].push.call({length:4294967296},1)}))||!function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(n){return n instanceof TypeError}}()},{push:function(n){var e=o(this),t=a(e),r=arguments.length;i(t+r);for(var l=0;l<r;l++)e[t]=arguments[l],t++;return s(e,t),t}})},function(n,e,t){"use strict";var r=t(1);n.exports=!r((function(){var n=function(){}.bind();return"function"!=typeof n||n.hasOwnProperty("prototype")}))},function(n,e,t){"use strict";n.exports=function(n,e){return{enumerable:!(1&n),configurable:!(2&n),writable:!(4&n),value:e}}},function(n,e,t){"use strict";var r=t(70),o=t(47);n.exports=function(n){return r(o(n))}},function(n,e,t){"use strict";var r=t(0),o=t(2),a=function(n){return o(n)?n:void 0};n.exports=function(n,e){return arguments.length<2?a(r[n]):r[n]&&r[n][e]}},function(n,e,t){"use strict";var r=t(7);n.exports=r({}.isPrototypeOf)},function(n,e,t){"use strict";var r=t(10),o=t(48);n.exports=function(n,e){var t=n[e];return o(t)?void 0:r(t)}},function(n,e,t){"use strict";var r=t(47),o=Object;n.exports=function(n){return o(r(n))}},function(n,e,t){"use strict";var r=t(141);n.exports=function(n){return r(n.length)}},function(n,e,t){var r=t(189),o=t(190),a=t(191),s=t(192),i=t(193);function l(n){var e=-1,t=null==n?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}l.prototype.clear=r,l.prototype.delete=o,l.prototype.get=a,l.prototype.has=s,l.prototype.set=i,n.exports=l},function(n,e,t){var r=t(101);n.exports=function(n,e){for(var t=n.length;t--;)if(r(n[t][0],e))return t;return-1}},function(n,e,t){var r=t(20)(Object,"create");n.exports=r},function(n,e,t){var r=t(211);n.exports=function(n,e){var t=n.__data__;return r(e)?t["string"==typeof e?"string":"hash"]:t.map}},function(n,e,t){var r=t(64);n.exports=function(n){if("string"==typeof n||r(n))return n;var e=n+"";return"0"==e&&1/n==-1/0?"-0":e}},function(n,e,t){var r,o;
/* NProgress, (c) 2013, 2014 Rico Sta. Cruz - http://ricostacruz.com/nprogress
 * @license MIT */void 0===(o="function"==typeof(r=function(){var n,e,t={version:"0.2.0"},r=t.settings={minimum:.08,easing:"ease",positionUsing:"",speed:200,trickle:!0,trickleRate:.02,trickleSpeed:800,showSpinner:!0,barSelector:'[role="bar"]',spinnerSelector:'[role="spinner"]',parent:"body",template:'<div class="bar" role="bar"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div>'};function o(n,e,t){return n<e?e:n>t?t:n}function a(n){return 100*(-1+n)}t.configure=function(n){var e,t;for(e in n)void 0!==(t=n[e])&&n.hasOwnProperty(e)&&(r[e]=t);return this},t.status=null,t.set=function(n){var e=t.isStarted();n=o(n,r.minimum,1),t.status=1===n?null:n;var l=t.render(!e),c=l.querySelector(r.barSelector),p=r.speed,d=r.easing;return l.offsetWidth,s((function(e){""===r.positionUsing&&(r.positionUsing=t.getPositioningCSS()),i(c,function(n,e,t){var o;return(o="translate3d"===r.positionUsing?{transform:"translate3d("+a(n)+"%,0,0)"}:"translate"===r.positionUsing?{transform:"translate("+a(n)+"%,0)"}:{"margin-left":a(n)+"%"}).transition="all "+e+"ms "+t,o}(n,p,d)),1===n?(i(l,{transition:"none",opacity:1}),l.offsetWidth,setTimeout((function(){i(l,{transition:"all "+p+"ms linear",opacity:0}),setTimeout((function(){t.remove(),e()}),p)}),p)):setTimeout(e,p)})),this},t.isStarted=function(){return"number"==typeof t.status},t.start=function(){t.status||t.set(0);var n=function(){setTimeout((function(){t.status&&(t.trickle(),n())}),r.trickleSpeed)};return r.trickle&&n(),this},t.done=function(n){return n||t.status?t.inc(.3+.5*Math.random()).set(1):this},t.inc=function(n){var e=t.status;return e?("number"!=typeof n&&(n=(1-e)*o(Math.random()*e,.1,.95)),e=o(e+n,0,.994),t.set(e)):t.start()},t.trickle=function(){return t.inc(Math.random()*r.trickleRate)},n=0,e=0,t.promise=function(r){return r&&"resolved"!==r.state()?(0===e&&t.start(),n++,e++,r.always((function(){0==--e?(n=0,t.done()):t.set((n-e)/n)})),this):this},t.render=function(n){if(t.isRendered())return document.getElementById("nprogress");c(document.documentElement,"nprogress-busy");var e=document.createElement("div");e.id="nprogress",e.innerHTML=r.template;var o,s=e.querySelector(r.barSelector),l=n?"-100":a(t.status||0),p=document.querySelector(r.parent);return i(s,{transition:"all 0 linear",transform:"translate3d("+l+"%,0,0)"}),r.showSpinner||(o=e.querySelector(r.spinnerSelector))&&u(o),p!=document.body&&c(p,"nprogress-custom-parent"),p.appendChild(e),e},t.remove=function(){p(document.documentElement,"nprogress-busy"),p(document.querySelector(r.parent),"nprogress-custom-parent");var n=document.getElementById("nprogress");n&&u(n)},t.isRendered=function(){return!!document.getElementById("nprogress")},t.getPositioningCSS=function(){var n=document.body.style,e="WebkitTransform"in n?"Webkit":"MozTransform"in n?"Moz":"msTransform"in n?"ms":"OTransform"in n?"O":"";return e+"Perspective"in n?"translate3d":e+"Transform"in n?"translate":"margin"};var s=function(){var n=[];function e(){var t=n.shift();t&&t(e)}return function(t){n.push(t),1==n.length&&e()}}(),i=function(){var n=["Webkit","O","Moz","ms"],e={};function t(t){return t=t.replace(/^-ms-/,"ms-").replace(/-([\da-z])/gi,(function(n,e){return e.toUpperCase()})),e[t]||(e[t]=function(e){var t=document.body.style;if(e in t)return e;for(var r,o=n.length,a=e.charAt(0).toUpperCase()+e.slice(1);o--;)if((r=n[o]+a)in t)return r;return e}(t))}function r(n,e,r){e=t(e),n.style[e]=r}return function(n,e){var t,o,a=arguments;if(2==a.length)for(t in e)void 0!==(o=e[t])&&e.hasOwnProperty(t)&&r(n,t,o);else r(n,a[1],a[2])}}();function l(n,e){return("string"==typeof n?n:d(n)).indexOf(" "+e+" ")>=0}function c(n,e){var t=d(n),r=t+e;l(t,e)||(n.className=r.substring(1))}function p(n,e){var t,r=d(n);l(n,e)&&(t=r.replace(" "+e+" "," "),n.className=t.substring(1,t.length-1))}function d(n){return(" "+(n.className||"")+" ").replace(/\s+/gi," ")}function u(n){n&&n.parentNode&&n.parentNode.removeChild(n)}return t})?r.call(e,t,e,n):r)||(n.exports=o)},function(n){n.exports=JSON.parse('{"_from":"vuepress-plugin-comment-plus@^1.1.0","_id":"vuepress-plugin-comment-plus@1.1.0","_inBundle":false,"_integrity":"sha512-pYlsRuF3PA9KSfUrZ2NukDM2K8y8sNsTozKbOj+xuNKxshKrodo3//LdBhjNyerfJVg5+okq+qoC3/nDH4aHpg==","_location":"/vuepress-plugin-comment-plus","_phantomChildren":{},"_requested":{"type":"range","registry":true,"raw":"vuepress-plugin-comment-plus@^1.1.0","name":"vuepress-plugin-comment-plus","escapedName":"vuepress-plugin-comment-plus","rawSpec":"^1.1.0","saveSpec":null,"fetchSpec":"^1.1.0"},"_requiredBy":["#DEV:/"],"_resolved":"https://registry.npmjs.org/vuepress-plugin-comment-plus/-/vuepress-plugin-comment-plus-1.1.0.tgz","_shasum":"bf44d81db4ffe12c3b72a9d999c2d9b7117c746a","_spec":"vuepress-plugin-comment-plus@^1.1.0","_where":"/home/runner/work/tenqaz.github.io/tenqaz.github.io","author":{"name":"dongyuanxin"},"bugs":{"url":"https://github.com/SivanLaai/vuepress-plugin-comment-plus/issues"},"bundleDependencies":false,"dependencies":{"@waline/client":"^1.3.3","ejs":"^2.6.1","gitalk":"^1.5.0","gitalk-fix":"^1.5.2","i":"^0.3.6","npm":"^6.9.0","valine":"^1.3.9"},"deprecated":false,"description":"Comment plugin in vuepress, such as Gitalk, Valine...","homepage":"https://github.com/SivanLaai/vuepress-plugin-comment-plus#readme","keywords":["vuepress","comment","plugin","vue","gitalk","valine","waline"],"license":"MIT","main":"index.js","name":"vuepress-plugin-comment-plus","repository":{"type":"git","url":"git+ssh://git@github.com/SivanLaai/vuepress-plugin-comment-plus.git"},"scripts":{"test":"echo \\"Error: no test specified\\" && exit 1"},"version":"1.1.0"}')},function(n,e,t){"use strict";var r=t(48),o=TypeError;n.exports=function(n){if(r(n))throw new o("Can't call method on "+n);return n}},function(n,e,t){"use strict";n.exports=function(n){return null==n}},function(n,e,t){"use strict";var r=String;n.exports=function(n){try{return r(n)}catch(n){return"Object"}}},function(n,e,t){"use strict";var r=t(24),o=t(0),a=t(51),s=n.exports=o["__core-js_shared__"]||a("__core-js_shared__",{});(s.versions||(s.versions=[])).push({version:"3.45.1",mode:r?"pure":"global",copyright:"Â© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.45.1/LICENSE",source:"https://github.com/zloirock/core-js"})},function(n,e,t){"use strict";var r=t(0),o=Object.defineProperty;n.exports=function(n,e){try{o(r,n,{value:e,configurable:!0,writable:!0})}catch(t){r[n]=e}return e}},function(n,e,t){"use strict";var r=t(2),o=t(19),a=t(82),s=t(51);n.exports=function(n,e,t,i){i||(i={});var l=i.enumerable,c=void 0!==i.name?i.name:e;if(r(t)&&a(t,c,i),i.global)l?n[e]=t:s(e,t);else{try{i.unsafe?n[e]&&(l=!0):delete n[e]}catch(n){}l?n[e]=t:o.f(n,e,{value:t,enumerable:!1,configurable:!i.nonConfigurable,writable:!i.nonWritable})}return n}},function(n,e,t){"use strict";var r=t(77),o=t(78),a=r("keys");n.exports=function(n){return a[n]||(a[n]=o(n))}},function(n,e,t){"use strict";n.exports={}},function(n,e,t){"use strict";n.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},function(n,e,t){"use strict";var r=t(159),o=t(8),a=t(4),s=t(49),i=t(161),l=t(39),c=t(36),p=t(162),d=t(94),u=t(14),m=TypeError,g=function(n,e){this.stopped=n,this.result=e},f=g.prototype;n.exports=function(n,e,t){var h,v,b,_,y,k,w,E=t&&t.that,x=!(!t||!t.AS_ENTRIES),A=!(!t||!t.IS_RECORD),B=!(!t||!t.IS_ITERATOR),z=!(!t||!t.INTERRUPTED),j=r(e,E),T=function(n){return h&&u(h,"normal"),new g(!0,n)},C=function(n){return x?(a(n),z?j(n[0],n[1],T):j(n[0],n[1])):z?j(n,T):j(n)};if(A)h=n.iterator;else if(B)h=n;else{if(!(v=d(n)))throw new m(s(n)+" is not iterable");if(i(v)){for(b=0,_=l(n);_>b;b++)if((y=C(n[b]))&&c(f,y))return y;return new g(!1)}h=p(n,v)}for(k=A?n.next:h.next;!(w=o(k,h)).done;){try{y=C(w.value)}catch(n){u(h,"throw",n)}if("object"==typeof y&&y&&c(f,y))return y}return new g(!1)}},function(n,e,t){var r=t(183),o=t(23),a=Object.prototype,s=a.hasOwnProperty,i=a.propertyIsEnumerable,l=r(function(){return arguments}())?r:function(n){return o(n)&&s.call(n,"callee")&&!i.call(n,"callee")};n.exports=l},function(n,e,t){var r=t(20)(t(15),"Map");n.exports=r},function(n,e){n.exports=function(n){var e=typeof n;return null!=n&&("object"==e||"function"==e)}},function(n,e,t){var r=t(203),o=t(210),a=t(212),s=t(213),i=t(214);function l(n){var e=-1,t=null==n?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}l.prototype.clear=r,l.prototype.delete=o,l.prototype.get=a,l.prototype.has=s,l.prototype.set=i,n.exports=l},function(n,e){n.exports=function(n){var e=-1,t=Array(n.size);return n.forEach((function(n){t[++e]=n})),t}},function(n,e){n.exports=function(n){return"number"==typeof n&&n>-1&&n%1==0&&n<=9007199254740991}},function(n,e,t){var r=t(12),o=t(64),a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;n.exports=function(n,e){if(r(n))return!1;var t=typeof n;return!("number"!=t&&"symbol"!=t&&"boolean"!=t&&null!=n&&!o(n))||(s.test(n)||!a.test(n)||null!=e&&n in Object(e))}},function(n,e,t){var r=t(26),o=t(23);n.exports=function(n){return"symbol"==typeof n||o(n)&&"[object Symbol]"==r(n)}},function(n,e){n.exports=function(n){return n}},function(n,e,t){"use strict";var r=t(13),o=t(8),a=t(56),s=t(10),i=t(4),l=t(28),c=t(14),p=t(29)("some",TypeError);r({target:"Iterator",proto:!0,real:!0,forced:p},{some:function(n){i(this);try{s(n)}catch(n){c(this,"throw",n)}if(p)return o(p,this,n);var e=l(this),t=0;return a(e,(function(e,r){if(n(e,t++))return r()}),{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})},function(n,e){n.exports=function(n){return n.webpackPolyfill||(n.deprecate=function(){},n.paths=[],n.children||(n.children=[]),Object.defineProperty(n,"loaded",{enumerable:!0,get:function(){return n.l}}),Object.defineProperty(n,"id",{enumerable:!0,get:function(){return n.i}}),n.webpackPolyfill=1),n}},function(n,e){var t=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,o=/^0b[01]+$/i,a=/^0o[0-7]+$/i,s=parseInt,i="object"==typeof global&&global&&global.Object===Object&&global,l="object"==typeof self&&self&&self.Object===Object&&self,c=i||l||Function("return this")(),p=Object.prototype.toString,d=Math.max,u=Math.min,m=function(){return c.Date.now()};function g(n){var e=typeof n;return!!n&&("object"==e||"function"==e)}function f(n){if("number"==typeof n)return n;if(function(n){return"symbol"==typeof n||function(n){return!!n&&"object"==typeof n}(n)&&"[object Symbol]"==p.call(n)}(n))return NaN;if(g(n)){var e="function"==typeof n.valueOf?n.valueOf():n;n=g(e)?e+"":e}if("string"!=typeof n)return 0===n?n:+n;n=n.replace(t,"");var i=o.test(n);return i||a.test(n)?s(n.slice(2),i?2:8):r.test(n)?NaN:+n}n.exports=function(n,e,t){var r,o,a,s,i,l,c=0,p=!1,h=!1,v=!0;if("function"!=typeof n)throw new TypeError("Expected a function");function b(e){var t=r,a=o;return r=o=void 0,c=e,s=n.apply(a,t)}function _(n){return c=n,i=setTimeout(k,e),p?b(n):s}function y(n){var t=n-l;return void 0===l||t>=e||t<0||h&&n-c>=a}function k(){var n=m();if(y(n))return w(n);i=setTimeout(k,function(n){var t=e-(n-l);return h?u(t,a-(n-c)):t}(n))}function w(n){return i=void 0,v&&r?b(n):(r=o=void 0,s)}function E(){var n=m(),t=y(n);if(r=arguments,o=this,l=n,t){if(void 0===i)return _(l);if(h)return i=setTimeout(k,e),b(l)}return void 0===i&&(i=setTimeout(k,e)),s}return e=f(e)||0,g(t)&&(p=!!t.leading,a=(h="maxWait"in t)?d(f(t.maxWait)||0,e):a,v="trailing"in t?!!t.trailing:v),E.cancel=function(){void 0!==i&&clearTimeout(i),c=0,r=l=o=i=void 0},E.flush=function(){return void 0===i?s:w(m())},E}},function(n,e,t){"use strict";var r=t(6),o=t(8),a=t(130),s=t(33),i=t(34),l=t(71),c=t(11),p=t(79),d=Object.getOwnPropertyDescriptor;e.f=r?d:function(n,e){if(n=i(n),e=l(e),p)try{return d(n,e)}catch(n){}if(c(n,e))return s(!o(a.f,n,e),n[e])}},function(n,e,t){"use strict";var r=t(7),o=t(1),a=t(27),s=Object,i=r("".split);n.exports=o((function(){return!s("z").propertyIsEnumerable(0)}))?function(n){return"String"===a(n)?i(n,""):s(n)}:s},function(n,e,t){"use strict";var r=t(131),o=t(72);n.exports=function(n){var e=r(n,"string");return o(e)?e:e+""}},function(n,e,t){"use strict";var r=t(35),o=t(2),a=t(36),s=t(73),i=Object;n.exports=s?function(n){return"symbol"==typeof n}:function(n){var e=r("Symbol");return o(e)&&a(e.prototype,i(n))}},function(n,e,t){"use strict";var r=t(74);n.exports=r&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},function(n,e,t){"use strict";var r=t(75),o=t(1),a=t(0).String;n.exports=!!Object.getOwnPropertySymbols&&!o((function(){var n=Symbol("symbol detection");return!a(n)||!(Object(n)instanceof Symbol)||!Symbol.sham&&r&&r<41}))},function(n,e,t){"use strict";var r,o,a=t(0),s=t(76),i=a.process,l=a.Deno,c=i&&i.versions||l&&l.version,p=c&&c.v8;p&&(o=(r=p.split("."))[0]>0&&r[0]<4?1:+(r[0]+r[1])),!o&&s&&(!(r=s.match(/Edge\/(\d+)/))||r[1]>=74)&&(r=s.match(/Chrome\/(\d+)/))&&(o=+r[1]),n.exports=o},function(n,e,t){"use strict";var r=t(0).navigator,o=r&&r.userAgent;n.exports=o?String(o):""},function(n,e,t){"use strict";var r=t(50);n.exports=function(n,e){return r[n]||(r[n]=e||{})}},function(n,e,t){"use strict";var r=t(7),o=0,a=Math.random(),s=r(1.1.toString);n.exports=function(n){return"Symbol("+(void 0===n?"":n)+")_"+s(++o+a,36)}},function(n,e,t){"use strict";var r=t(6),o=t(1),a=t(80);n.exports=!r&&!o((function(){return 7!==Object.defineProperty(a("div"),"a",{get:function(){return 7}}).a}))},function(n,e,t){"use strict";var r=t(0),o=t(9),a=r.document,s=o(a)&&o(a.createElement);n.exports=function(n){return s?a.createElement(n):{}}},function(n,e,t){"use strict";var r=t(6),o=t(1);n.exports=r&&o((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))},function(n,e,t){"use strict";var r=t(7),o=t(1),a=t(2),s=t(11),i=t(6),l=t(133).CONFIGURABLE,c=t(134),p=t(83),d=p.enforce,u=p.get,m=String,g=Object.defineProperty,f=r("".slice),h=r("".replace),v=r([].join),b=i&&!o((function(){return 8!==g((function(){}),"length",{value:8}).length})),_=String(String).split("String"),y=n.exports=function(n,e,t){"Symbol("===f(m(e),0,7)&&(e="["+h(m(e),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),t&&t.getter&&(e="get "+e),t&&t.setter&&(e="set "+e),(!s(n,"name")||l&&n.name!==e)&&(i?g(n,"name",{value:e,configurable:!0}):n.name=e),b&&t&&s(t,"arity")&&n.length!==t.arity&&g(n,"length",{value:t.arity});try{t&&s(t,"constructor")&&t.constructor?i&&g(n,"prototype",{writable:!1}):n.prototype&&(n.prototype=void 0)}catch(n){}var r=d(n);return s(r,"source")||(r.source=v(_,"string"==typeof e?e:"")),n};Function.prototype.toString=y((function(){return a(this)&&u(this).source||c(this)}),"toString")},function(n,e,t){"use strict";var r,o,a,s=t(135),i=t(0),l=t(9),c=t(25),p=t(11),d=t(50),u=t(53),m=t(54),g=i.TypeError,f=i.WeakMap;if(s||d.state){var h=d.state||(d.state=new f);h.get=h.get,h.has=h.has,h.set=h.set,r=function(n,e){if(h.has(n))throw new g("Object already initialized");return e.facade=n,h.set(n,e),e},o=function(n){return h.get(n)||{}},a=function(n){return h.has(n)}}else{var v=u("state");m[v]=!0,r=function(n,e){if(p(n,v))throw new g("Object already initialized");return e.facade=n,c(n,v,e),e},o=function(n){return p(n,v)?n[v]:{}},a=function(n){return p(n,v)}}n.exports={set:r,get:o,has:a,enforce:function(n){return a(n)?o(n):r(n,{})},getterFor:function(n){return function(e){var t;if(!l(e)||(t=o(e)).type!==n)throw new g("Incompatible receiver, "+n+" required");return t}}}},function(n,e,t){"use strict";var r=t(11),o=t(136),a=t(69),s=t(19);n.exports=function(n,e,t){for(var i=o(e),l=s.f,c=a.f,p=0;p<i.length;p++){var d=i[p];r(n,d)||t&&r(t,d)||l(n,d,c(e,d))}}},function(n,e,t){"use strict";var r=t(7),o=t(11),a=t(34),s=t(138).indexOf,i=t(54),l=r([].push);n.exports=function(n,e){var t,r=a(n),c=0,p=[];for(t in r)!o(i,t)&&o(r,t)&&l(p,t);for(;e.length>c;)o(r,t=e[c++])&&(~s(p,t)||l(p,t));return p}},function(n,e,t){"use strict";var r=t(140);n.exports=function(n){var e=+n;return e!=e||0===e?0:r(e)}},function(n,e,t){"use strict";var r=t(11),o=t(2),a=t(38),s=t(53),i=t(145),l=s("IE_PROTO"),c=Object,p=c.prototype;n.exports=i?c.getPrototypeOf:function(n){var e=a(n);if(r(e,l))return e[l];var t=e.constructor;return o(t)&&e instanceof t?t.prototype:e instanceof c?p:null}},function(n,e,t){"use strict";var r,o,a,s=t(1),i=t(2),l=t(9),c=t(89),p=t(87),d=t(52),u=t(18),m=t(24),g=u("iterator"),f=!1;[].keys&&("next"in(a=[].keys())?(o=p(p(a)))!==Object.prototype&&(r=o):f=!0),!l(r)||s((function(){var n={};return r[g].call(n)!==n}))?r={}:m&&(r=c(r)),i(r[g])||d(r,g,(function(){return this})),n.exports={IteratorPrototype:r,BUGGY_SAFARI_ITERATORS:f}},function(n,e,t){"use strict";var r,o=t(4),a=t(148),s=t(55),i=t(54),l=t(150),c=t(80),p=t(53),d=p("IE_PROTO"),u=function(){},m=function(n){return"<script>"+n+"<\/script>"},g=function(n){n.write(m("")),n.close();var e=n.parentWindow.Object;return n=null,e},f=function(){try{r=new ActiveXObject("htmlfile")}catch(n){}var n,e;f="undefined"!=typeof document?document.domain&&r?g(r):((e=c("iframe")).style.display="none",l.appendChild(e),e.src=String("javascript:"),(n=e.contentWindow.document).open(),n.write(m("document.F=Object")),n.close(),n.F):g(r);for(var t=s.length;t--;)delete f.prototype[s[t]];return f()};i[d]=!0,n.exports=Object.create||function(n,e){var t;return null!==n?(u.prototype=o(n),t=new u,u.prototype=null,t[d]=n):t=f(),void 0===e?t:a.f(t,e)}},function(n,e,t){"use strict";var r=t(8),o=t(89),a=t(25),s=t(151),i=t(18),l=t(83),c=t(37),p=t(88).IteratorPrototype,d=t(152),u=t(14),m=t(153),g=i("toStringTag"),f=l.set,h=function(n){var e=l.getterFor(n?"WrapForValidIterator":"IteratorHelper");return s(o(p),{next:function(){var t=e(this);if(n)return t.nextHandler();if(t.done)return d(void 0,!0);try{var r=t.nextHandler();return t.returnHandlerResult?r:d(r,t.done)}catch(n){throw t.done=!0,n}},return:function(){var t=e(this),o=t.iterator;if(t.done=!0,n){var a=c(o,"return");return a?r(a,o):d(void 0,!0)}if(t.inner)try{u(t.inner.iterator,"normal")}catch(n){return u(o,"throw",n)}if(t.openIters)try{m(t.openIters,"normal")}catch(n){return u(o,"throw",n)}return o&&u(o,"normal"),d(void 0,!0)}})},v=h(!0),b=h(!1);a(b,g,"Iterator Helper"),n.exports=function(n,e,t){var r=function(r,o){o?(o.iterator=r.iterator,o.next=r.next):o=r,o.type=e?"WrapForValidIterator":"IteratorHelper",o.returnHandlerResult=!!t,o.nextHandler=n,o.counter=0,o.done=!1,f(this,o)};return r.prototype=e?v:b,r}},function(n,e,t){"use strict";var r=t(4),o=t(14);n.exports=function(n,e,t,a){try{return a?e(r(t)[0],t[1]):e(t)}catch(e){o(n,"throw",e)}}},function(n,e,t){"use strict";n.exports=function(n,e){var t="function"==typeof Iterator&&Iterator.prototype[n];if(t)try{t.call({next:null},e).next()}catch(n){return!0}}},function(n,e,t){"use strict";n.exports={}},function(n,e,t){"use strict";var r=t(95),o=t(37),a=t(48),s=t(93),i=t(18)("iterator");n.exports=function(n){if(!a(n))return o(n,i)||o(n,"@@iterator")||s[r(n)]}},function(n,e,t){"use strict";var r=t(163),o=t(2),a=t(27),s=t(18)("toStringTag"),i=Object,l="Arguments"===a(function(){return arguments}());n.exports=r?a:function(n){var e,t,r;return void 0===n?"Undefined":null===n?"Null":"string"==typeof(t=function(n,e){try{return n[e]}catch(n){}}(e=i(n),s))?t:l?a(e):"Object"===(r=a(e))&&o(e.callee)?"Arguments":r}},function(n,e,t){"use strict";var r=t(32),o=Function.prototype,a=o.apply,s=o.call;n.exports="object"==typeof Reflect&&Reflect.apply||(r?s.bind(a):function(){return s.apply(a,arguments)})},function(n,e,t){"use strict";var r=t(167),o=t(9),a=t(47),s=t(168);n.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var n,e=!1,t={};try{(n=r(Object.prototype,"__proto__","set"))(t,[]),e=t instanceof Array}catch(n){}return function(t,r){return a(t),s(r),o(t)?(e?n(t,r):t.__proto__=r,t):t}}():void 0)},function(n,e){n.exports=function(n,e){for(var t=-1,r=e.length,o=n.length;++t<r;)n[o+t]=e[t];return n}},function(n,e){var t="object"==typeof global&&global&&global.Object===Object&&global;n.exports=t},function(n,e,t){var r=t(40),o=t(194),a=t(195),s=t(196),i=t(197),l=t(198);function c(n){var e=this.__data__=new r(n);this.size=e.size}c.prototype.clear=o,c.prototype.delete=a,c.prototype.get=s,c.prototype.has=i,c.prototype.set=l,n.exports=c},function(n,e){n.exports=function(n,e){return n===e||n!=n&&e!=e}},function(n,e,t){var r=t(26),o=t(59);n.exports=function(n){if(!o(n))return!1;var e=r(n);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}},function(n,e){var t=Function.prototype.toString;n.exports=function(n){if(null!=n){try{return t.call(n)}catch(n){}try{return n+""}catch(n){}}return""}},function(n,e,t){var r=t(215),o=t(23);n.exports=function n(e,t,a,s,i){return e===t||(null==e||null==t||!o(e)&&!o(t)?e!=e&&t!=t:r(e,t,a,s,n,i))}},function(n,e,t){var r=t(106),o=t(218),a=t(107);n.exports=function(n,e,t,s,i,l){var c=1&t,p=n.length,d=e.length;if(p!=d&&!(c&&d>p))return!1;var u=l.get(n),m=l.get(e);if(u&&m)return u==e&&m==n;var g=-1,f=!0,h=2&t?new r:void 0;for(l.set(n,e),l.set(e,n);++g<p;){var v=n[g],b=e[g];if(s)var _=c?s(b,v,g,e,n,l):s(v,b,g,n,e,l);if(void 0!==_){if(_)continue;f=!1;break}if(h){if(!o(e,(function(n,e){if(!a(h,e)&&(v===n||i(v,n,t,s,l)))return h.push(e)}))){f=!1;break}}else if(v!==b&&!i(v,b,t,s,l)){f=!1;break}}return l.delete(n),l.delete(e),f}},function(n,e,t){var r=t(60),o=t(216),a=t(217);function s(n){var e=-1,t=null==n?0:n.length;for(this.__data__=new r;++e<t;)this.add(n[e])}s.prototype.add=s.prototype.push=o,s.prototype.has=a,n.exports=s},function(n,e){n.exports=function(n,e){return n.has(e)}},function(n,e,t){var r=t(228),o=t(234),a=t(112);n.exports=function(n){return a(n)?r(n):o(n)}},function(n,e,t){(function(n){var r=t(15),o=t(230),a=e&&!e.nodeType&&e,s=a&&"object"==typeof n&&n&&!n.nodeType&&n,i=s&&s.exports===a?r.Buffer:void 0,l=(i?i.isBuffer:void 0)||o;n.exports=l}).call(this,t(67)(n))},function(n,e){var t=/^(?:0|[1-9]\d*)$/;n.exports=function(n,e){var r=typeof n;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&t.test(n))&&n>-1&&n%1==0&&n<e}},function(n,e,t){var r=t(231),o=t(232),a=t(233),s=a&&a.isTypedArray,i=s?o(s):r;n.exports=i},function(n,e,t){var r=t(102),o=t(62);n.exports=function(n){return null!=n&&o(n.length)&&!r(n)}},function(n,e,t){var r=t(20)(t(15),"Set");n.exports=r},function(n,e,t){var r=t(59);n.exports=function(n){return n==n&&!r(n)}},function(n,e){n.exports=function(n,e){return function(t){return null!=t&&(t[n]===e&&(void 0!==e||n in Object(t)))}}},function(n,e,t){var r=t(117),o=t(44);n.exports=function(n,e){for(var t=0,a=(e=r(e,n)).length;null!=n&&t<a;)n=n[o(e[t++])];return t&&t==a?n:void 0}},function(n,e,t){var r=t(12),o=t(63),a=t(245),s=t(248);n.exports=function(n,e){return r(n)?n:o(n,e)?[n]:a(s(n))}},function(n,e,t){},function(n,e,t){},function(n,e,t){},function(n,e,t){},function(n,e,t){},function(n,e,t){var r=t(181),o=t(186),a=t(257),s=t(265),i=t(274),l=t(128),c=a((function(n){var e=l(n);return i(e)&&(e=void 0),s(r(n,1,i,!0),o(e,2))}));n.exports=c},function(n,e,t){"use strict";
/*!
 * escape-html
 * Copyright(c) 2012-2013 TJ Holowaychuk
 * Copyright(c) 2015 Andreas Lubbe
 * Copyright(c) 2015 Tiancheng "Timothy" Gu
 * MIT Licensed
 */var r=/["'&<>]/;n.exports=function(n){var e,t=""+n,o=r.exec(t);if(!o)return t;var a="",s=0,i=0;for(s=o.index;s<t.length;s++){switch(t.charCodeAt(s)){case 34:e="&quot;";break;case 38:e="&amp;";break;case 39:e="&#39;";break;case 60:e="&lt;";break;case 62:e="&gt;";break;default:continue}i!==s&&(a+=t.substring(i,s)),i=s+1,a+=e}return i!==s?a+t.substring(i,s):a}},function(n,e,t){"use strict";
/**
 * @file Embedded JavaScript templating engine. {@link http://ejs.co}
 * @author Matthew Eernisse <mde@fleegix.org>
 * @author Tiancheng "Timothy" Gu <timothygu99@gmail.com>
 * @project EJS
 * @license {@link http://www.apache.org/licenses/LICENSE-2.0 Apache License, Version 2.0}
 */var r=t(281),o=t(282),a=t(283),s=!1,i=t(284).version,l=["delimiter","scope","context","debug","compileDebug","client","_with","rmWhitespace","strict","filename","async"],c=l.concat("cache"),p=/^\uFEFF/,d=/^[a-zA-Z_$][0-9a-zA-Z_$]*$/;function u(n,t){var o;if(t.some((function(t){return o=e.resolveInclude(n,t,!0),r.existsSync(o)})))return o}function m(n,t){var r,o=n.filename,a=arguments.length>1;if(n.cache){if(!o)throw new Error("cache option requires a filename");if(r=e.cache.get(o))return r;a||(t=f(o).toString().replace(p,""))}else if(!a){if(!o)throw new Error("Internal EJS error: no file name or template provided");t=f(o).toString().replace(p,"")}return r=e.compile(t,n),n.cache&&e.cache.set(o,r),r}function g(n,t,r){var o;if(!r){if("function"==typeof e.promiseImpl)return new e.promiseImpl((function(e,r){try{e(o=m(n)(t))}catch(n){r(n)}}));throw new Error("Please provide a callback function")}try{o=m(n)(t)}catch(n){return r(n)}r(null,o)}function f(n){return e.fileLoader(n)}function h(n,t){var o=a.shallowCopy(a.createNullProtoObjWherePossible(),t);if(o.filename=function(n,t){var o,a,s=t.views,i=/^[A-Za-z]+:\\|^\//.exec(n);if(i&&i.length)n=n.replace(/^\/*/,""),o=Array.isArray(t.root)?u(n,t.root):e.resolveInclude(n,t.root||"/",!0);else if(t.filename&&(a=e.resolveInclude(n,t.filename),r.existsSync(a)&&(o=a)),!o&&Array.isArray(s)&&(o=u(n,s)),!o&&"function"!=typeof t.includer)throw new Error('Could not find the include file "'+t.escapeFunction(n)+'"');return o}(n,o),"function"==typeof t.includer){var s=t.includer(n,o.filename);if(s&&(s.filename&&(o.filename=s.filename),s.template))return m(o,s.template)}return m(o)}function v(n,e,t,r,o){var a=e.split("\n"),s=Math.max(r-3,0),i=Math.min(a.length,r+3),l=o(t),c=a.slice(s,i).map((function(n,e){var t=e+s+1;return(t==r?" >> ":"    ")+t+"| "+n})).join("\n");throw n.path=l,n.message=(l||"ejs")+":"+r+"\n"+c+"\n\n"+n.message,n}function b(n){return n.replace(/;(\s*$)/,"$1")}function _(n,t){var r=a.hasOwnOnlyObject(t),o=a.createNullProtoObjWherePossible();this.templateText=n,this.mode=null,this.truncate=!1,this.currentLine=1,this.source="",o.client=r.client||!1,o.escapeFunction=r.escape||r.escapeFunction||a.escapeXML,o.compileDebug=!1!==r.compileDebug,o.debug=!!r.debug,o.filename=r.filename,o.openDelimiter=r.openDelimiter||e.openDelimiter||"<",o.closeDelimiter=r.closeDelimiter||e.closeDelimiter||">",o.delimiter=r.delimiter||e.delimiter||"%",o.strict=r.strict||!1,o.context=r.context,o.cache=r.cache||!1,o.rmWhitespace=r.rmWhitespace,o.root=r.root,o.includer=r.includer,o.outputFunctionName=r.outputFunctionName,o.localsName=r.localsName||e.localsName||"locals",o.views=r.views,o.async=r.async,o.destructuredLocals=r.destructuredLocals,o.legacyInclude=void 0===r.legacyInclude||!!r.legacyInclude,o.strict?o._with=!1:o._with=void 0===r._with||r._with,this.opts=o,this.regex=this.createRegex()}e.cache=a.cache,e.fileLoader=r.readFileSync,e.localsName="locals",e.promiseImpl=new Function("return this;")().Promise,e.resolveInclude=function(n,e,t){var r=o.dirname,a=o.extname,s=(0,o.resolve)(t?e:r(e),n);return a(n)||(s+=".ejs"),s},e.compile=function(n,e){return e&&e.scope&&(s||(console.warn("`scope` option is deprecated and will be removed in EJS 3"),s=!0),e.context||(e.context=e.scope),delete e.scope),new _(n,e).compile()},e.render=function(n,e,t){var r=e||a.createNullProtoObjWherePossible(),o=t||a.createNullProtoObjWherePossible();return 2==arguments.length&&a.shallowCopyFromList(o,r,l),m(o,n)(r)},e.renderFile=function(){var n,e,t,r=Array.prototype.slice.call(arguments),o=r.shift(),s={filename:o};return"function"==typeof arguments[arguments.length-1]&&(n=r.pop()),r.length?(e=r.shift(),r.length?a.shallowCopy(s,r.pop()):(e.settings&&(e.settings.views&&(s.views=e.settings.views),e.settings["view cache"]&&(s.cache=!0),(t=e.settings["view options"])&&a.shallowCopy(s,t)),a.shallowCopyFromList(s,e,c)),s.filename=o):e=a.createNullProtoObjWherePossible(),g(s,e,n)},e.Template=_,e.clearCache=function(){e.cache.reset()},_.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"},_.prototype={createRegex:function(){var n="(<%%|%%>|<%=|<%-|<%_|<%#|<%|%>|-%>|_%>)",e=a.escapeRegExpChars(this.opts.delimiter),t=a.escapeRegExpChars(this.opts.openDelimiter),r=a.escapeRegExpChars(this.opts.closeDelimiter);return n=n.replace(/%/g,e).replace(/</g,t).replace(/>/g,r),new RegExp(n)},compile:function(){var n,e,t,r=this.opts,s="",i="",l=r.escapeFunction,c=r.filename?JSON.stringify(r.filename):"undefined";if(!this.source){if(this.generateSource(),s+='  var __output = "";\n  function __append(s) { if (s !== undefined && s !== null) __output += s }\n',r.outputFunctionName){if(!d.test(r.outputFunctionName))throw new Error("outputFunctionName is not a valid JS identifier.");s+="  var "+r.outputFunctionName+" = __append;\n"}if(r.localsName&&!d.test(r.localsName))throw new Error("localsName is not a valid JS identifier.");if(r.destructuredLocals&&r.destructuredLocals.length){for(var p="  var __locals = ("+r.localsName+" || {}),\n",u=0;u<r.destructuredLocals.length;u++){var m=r.destructuredLocals[u];if(!d.test(m))throw new Error("destructuredLocals["+u+"] is not a valid JS identifier.");u>0&&(p+=",\n  "),p+=m+" = __locals."+m}s+=p+";\n"}!1!==r._with&&(s+="  with ("+r.localsName+" || {}) {\n",i+="  }\n"),i+="  return __output;\n",this.source=s+this.source+i}n=r.compileDebug?"var __line = 1\n  , __lines = "+JSON.stringify(this.templateText)+"\n  , __filename = "+c+";\ntry {\n"+this.source+"} catch (e) {\n  rethrow(e, __lines, __filename, __line, escapeFn);\n}\n":this.source,r.client&&(n="escapeFn = escapeFn || "+l.toString()+";\n"+n,r.compileDebug&&(n="rethrow = rethrow || "+v.toString()+";\n"+n)),r.strict&&(n='"use strict";\n'+n),r.debug&&console.log(n),r.compileDebug&&r.filename&&(n=n+"\n//# sourceURL="+c+"\n");try{if(r.async)try{t=new Function("return (async function(){}).constructor;")()}catch(n){throw n instanceof SyntaxError?new Error("This environment does not support async/await"):n}else t=Function;e=new t(r.localsName+", escapeFn, include, rethrow",n)}catch(n){throw n instanceof SyntaxError&&(r.filename&&(n.message+=" in "+r.filename),n.message+=" while compiling ejs\n\n",n.message+="If the above error is not helpful, you may want to try EJS-Lint:\n",n.message+="https://github.com/RyanZim/EJS-Lint",r.async||(n.message+="\n",n.message+="Or, if you meant to create an async function, pass `async: true` as an option.")),n}var g=r.client?e:function(n){return e.apply(r.context,[n||a.createNullProtoObjWherePossible(),l,function(e,t){var o=a.shallowCopy(a.createNullProtoObjWherePossible(),n);return t&&(o=a.shallowCopy(o,t)),h(e,r)(o)},v])};if(r.filename&&"function"==typeof Object.defineProperty){var f=r.filename,b=o.basename(f,o.extname(f));try{Object.defineProperty(g,"name",{value:b,writable:!1,enumerable:!1,configurable:!0})}catch(n){}}return g},generateSource:function(){this.opts.rmWhitespace&&(this.templateText=this.templateText.replace(/[\r\n]+/g,"\n").replace(/^\s+|\s+$/gm,"")),this.templateText=this.templateText.replace(/[ \t]*<%_/gm,"<%_").replace(/_%>[ \t]*/gm,"_%>");var n=this,e=this.parseTemplateText(),t=this.opts.delimiter,r=this.opts.openDelimiter,o=this.opts.closeDelimiter;e&&e.length&&e.forEach((function(a,s){var i;if(0===a.indexOf(r+t)&&0!==a.indexOf(r+t+t)&&(i=e[s+2])!=t+o&&i!="-"+t+o&&i!="_"+t+o)throw new Error('Could not find matching close tag for "'+a+'".');n.scanLine(a)}))},parseTemplateText:function(){for(var n,e=this.templateText,t=this.regex,r=t.exec(e),o=[];r;)0!==(n=r.index)&&(o.push(e.substring(0,n)),e=e.slice(n)),o.push(r[0]),e=e.slice(r[0].length),r=t.exec(e);return e&&o.push(e),o},_addOutput:function(n){if(this.truncate&&(n=n.replace(/^(?:\r\n|\r|\n)/,""),this.truncate=!1),!n)return n;n=(n=(n=(n=n.replace(/\\/g,"\\\\")).replace(/\n/g,"\\n")).replace(/\r/g,"\\r")).replace(/"/g,'\\"'),this.source+='    ; __append("'+n+'")\n'},scanLine:function(n){var e,t=this.opts.delimiter,r=this.opts.openDelimiter,o=this.opts.closeDelimiter;switch(e=n.split("\n").length-1,n){case r+t:case r+t+"_":this.mode=_.modes.EVAL;break;case r+t+"=":this.mode=_.modes.ESCAPED;break;case r+t+"-":this.mode=_.modes.RAW;break;case r+t+"#":this.mode=_.modes.COMMENT;break;case r+t+t:this.mode=_.modes.LITERAL,this.source+='    ; __append("'+n.replace(r+t+t,r+t)+'")\n';break;case t+t+o:this.mode=_.modes.LITERAL,this.source+='    ; __append("'+n.replace(t+t+o,t+o)+'")\n';break;case t+o:case"-"+t+o:case"_"+t+o:this.mode==_.modes.LITERAL&&this._addOutput(n),this.mode=null,this.truncate=0===n.indexOf("-")||0===n.indexOf("_");break;default:if(this.mode){switch(this.mode){case _.modes.EVAL:case _.modes.ESCAPED:case _.modes.RAW:n.lastIndexOf("//")>n.lastIndexOf("\n")&&(n+="\n")}switch(this.mode){case _.modes.EVAL:this.source+="    ; "+n+"\n";break;case _.modes.ESCAPED:this.source+="    ; __append(escapeFn("+b(n)+"))\n";break;case _.modes.RAW:this.source+="    ; __append("+b(n)+")\n";break;case _.modes.COMMENT:break;case _.modes.LITERAL:this._addOutput(n)}}else this._addOutput(n)}this.opts.compileDebug&&e&&(this.currentLine+=e,this.source+="    ; __line = "+this.currentLine+"\n")}},e.escapeXML=a.escapeXML,e.__express=e.renderFile,e.VERSION=i,e.name="ejs","undefined"!=typeof window&&(window.ejs=e)},function(n,e,t){"use strict";t.r(e);var r={name:"CodeBlock",props:{title:{type:String,required:!0},active:{type:Boolean,default:!1}}},o=(t(277),t(5)),a=Object(o.a)(r,(function(){return(0,this._self._c)("div",{staticClass:"theme-code-block",class:{"theme-code-block__active":this.active}},[this._t("default")],2)}),[],!1,null,"4f1e9d0c",null);e.default=a.exports},function(n,e,t){"use strict";t.r(e);t(3),t(16),t(17),t(22);var r={name:"CodeGroup",data:()=>({codeTabs:[],activeCodeTabIndex:-1}),watch:{activeCodeTabIndex(n){this.codeTabs.forEach(n=>{n.elm.classList.remove("theme-code-block__active")}),this.codeTabs[n].elm.classList.add("theme-code-block__active")}},mounted(){this.codeTabs=(this.$slots.default||[]).filter(n=>Boolean(n.componentOptions)).map((n,e)=>(""===n.componentOptions.propsData.active&&(this.activeCodeTabIndex=e),{title:n.componentOptions.propsData.title,elm:n.elm})),-1===this.activeCodeTabIndex&&this.codeTabs.length>0&&(this.activeCodeTabIndex=0)},methods:{changeCodeTab(n){this.activeCodeTabIndex=n}}},o=(t(278),t(5)),a=Object(o.a)(r,(function(){var n=this,e=n._self._c;return e("div",{staticClass:"theme-code-group"},[e("div",{staticClass:"theme-code-group__nav"},[e("ul",{staticClass:"theme-code-group__ul"},n._l(n.codeTabs,(function(t,r){return e("li",{key:t.title,staticClass:"theme-code-group__li"},[e("button",{staticClass:"theme-code-group__nav-tab",class:{"theme-code-group__nav-tab-active":r===n.activeCodeTabIndex},on:{click:function(e){return n.changeCodeTab(r)}}},[n._v("\n            "+n._s(t.title)+"\n          ")])])})),0)]),n._v(" "),n._t("default"),n._v(" "),n.codeTabs.length<1?e("pre",{staticClass:"pre-blank"},[n._v("// Make sure to add code blocks to your code group")]):n._e()],2)}),[],!1,null,"2f5f1757",null);e.default=a.exports},function(n,e){n.exports=function(n){var e=null==n?0:n.length;return e?n[e-1]:void 0}},function(n,e,t){n.exports=t(288)},function(n,e,t){"use strict";var r={}.propertyIsEnumerable,o=Object.getOwnPropertyDescriptor,a=o&&!r.call({1:2},1);e.f=a?function(n){var e=o(this,n);return!!e&&e.enumerable}:r},function(n,e,t){"use strict";var r=t(8),o=t(9),a=t(72),s=t(37),i=t(132),l=t(18),c=TypeError,p=l("toPrimitive");n.exports=function(n,e){if(!o(n)||a(n))return n;var t,l=s(n,p);if(l){if(void 0===e&&(e="default"),t=r(l,n,e),!o(t)||a(t))return t;throw new c("Can't convert object to primitive value")}return void 0===e&&(e="number"),i(n,e)}},function(n,e,t){"use strict";var r=t(8),o=t(2),a=t(9),s=TypeError;n.exports=function(n,e){var t,i;if("string"===e&&o(t=n.toString)&&!a(i=r(t,n)))return i;if(o(t=n.valueOf)&&!a(i=r(t,n)))return i;if("string"!==e&&o(t=n.toString)&&!a(i=r(t,n)))return i;throw new s("Can't convert object to primitive value")}},function(n,e,t){"use strict";var r=t(6),o=t(11),a=Function.prototype,s=r&&Object.getOwnPropertyDescriptor,i=o(a,"name"),l=i&&"something"===function(){}.name,c=i&&(!r||r&&s(a,"name").configurable);n.exports={EXISTS:i,PROPER:l,CONFIGURABLE:c}},function(n,e,t){"use strict";var r=t(7),o=t(2),a=t(50),s=r(Function.toString);o(a.inspectSource)||(a.inspectSource=function(n){return s(n)}),n.exports=a.inspectSource},function(n,e,t){"use strict";var r=t(0),o=t(2),a=r.WeakMap;n.exports=o(a)&&/native code/.test(String(a))},function(n,e,t){"use strict";var r=t(35),o=t(7),a=t(137),s=t(142),i=t(4),l=o([].concat);n.exports=r("Reflect","ownKeys")||function(n){var e=a.f(i(n)),t=s.f;return t?l(e,t(n)):e}},function(n,e,t){"use strict";var r=t(85),o=t(55).concat("length","prototype");e.f=Object.getOwnPropertyNames||function(n){return r(n,o)}},function(n,e,t){"use strict";var r=t(34),o=t(139),a=t(39),s=function(n){return function(e,t,s){var i=r(e),l=a(i);if(0===l)return!n&&-1;var c,p=o(s,l);if(n&&t!=t){for(;l>p;)if((c=i[p++])!=c)return!0}else for(;l>p;p++)if((n||p in i)&&i[p]===t)return n||p||0;return!n&&-1}};n.exports={includes:s(!0),indexOf:s(!1)}},function(n,e,t){"use strict";var r=t(86),o=Math.max,a=Math.min;n.exports=function(n,e){var t=r(n);return t<0?o(t+e,0):a(t,e)}},function(n,e,t){"use strict";var r=Math.ceil,o=Math.floor;n.exports=Math.trunc||function(n){var e=+n;return(e>0?o:r)(e)}},function(n,e,t){"use strict";var r=t(86),o=Math.min;n.exports=function(n){var e=r(n);return e>0?o(e,9007199254740991):0}},function(n,e,t){"use strict";e.f=Object.getOwnPropertySymbols},function(n,e,t){"use strict";var r=t(1),o=t(2),a=/#|\.prototype\./,s=function(n,e){var t=l[i(n)];return t===p||t!==c&&(o(e)?r(e):!!e)},i=s.normalize=function(n){return String(n).replace(a,".").toLowerCase()},l=s.data={},c=s.NATIVE="N",p=s.POLYFILL="P";n.exports=s},function(n,e,t){"use strict";var r=t(36),o=TypeError;n.exports=function(n,e){if(r(e,n))return n;throw new o("Incorrect invocation")}},function(n,e,t){"use strict";var r=t(1);n.exports=!r((function(){function n(){}return n.prototype.constructor=null,Object.getPrototypeOf(new n)!==n.prototype}))},function(n,e,t){"use strict";var r=t(82),o=t(19);n.exports=function(n,e,t){return t.get&&r(t.get,e,{getter:!0}),t.set&&r(t.set,e,{setter:!0}),o.f(n,e,t)}},function(n,e,t){"use strict";var r=t(6),o=t(19),a=t(33);n.exports=function(n,e,t){r?o.f(n,e,a(0,t)):n[e]=t}},function(n,e,t){"use strict";var r=t(6),o=t(81),a=t(19),s=t(4),i=t(34),l=t(149);e.f=r&&!o?Object.defineProperties:function(n,e){s(n);for(var t,r=i(e),o=l(e),c=o.length,p=0;c>p;)a.f(n,t=o[p++],r[t]);return n}},function(n,e,t){"use strict";var r=t(85),o=t(55);n.exports=Object.keys||function(n){return r(n,o)}},function(n,e,t){"use strict";var r=t(35);n.exports=r("document","documentElement")},function(n,e,t){"use strict";var r=t(52);n.exports=function(n,e,t){for(var o in e)r(n,o,e[o],t);return n}},function(n,e,t){"use strict";n.exports=function(n,e){return{value:n,done:e}}},function(n,e,t){"use strict";var r=t(14);n.exports=function(n,e,t){for(var o=n.length-1;o>=0;o--)if(void 0!==n[o])try{t=r(n[o].iterator,e,t)}catch(n){e="throw",t=n}if("throw"===e)throw t;return t}},function(n,e,t){"use strict";var r=t(13),o=t(155).left,a=t(156),s=t(75);r({target:"Array",proto:!0,forced:!t(157)&&s>79&&s<83||!a("reduce")},{reduce:function(n){var e=arguments.length;return o(this,n,e,e>1?arguments[1]:void 0)}})},function(n,e,t){"use strict";var r=t(10),o=t(38),a=t(70),s=t(39),i=TypeError,l="Reduce of empty array with no initial value",c=function(n){return function(e,t,c,p){var d=o(e),u=a(d),m=s(d);if(r(t),0===m&&c<2)throw new i(l);var g=n?m-1:0,f=n?-1:1;if(c<2)for(;;){if(g in u){p=u[g],g+=f;break}if(g+=f,n?g<0:m<=g)throw new i(l)}for(;n?g>=0:m>g;g+=f)g in u&&(p=t(p,u[g],g,d));return p}};n.exports={left:c(!1),right:c(!0)}},function(n,e,t){"use strict";var r=t(1);n.exports=function(n,e){var t=[][n];return!!t&&r((function(){t.call(null,e||function(){return 1},1)}))}},function(n,e,t){"use strict";var r=t(158);n.exports="NODE"===r},function(n,e,t){"use strict";var r=t(0),o=t(76),a=t(27),s=function(n){return o.slice(0,n.length)===n};n.exports=s("Bun/")?"BUN":s("Cloudflare-Workers")?"CLOUDFLARE":s("Deno/")?"DENO":s("Node.js/")?"NODE":r.Bun&&"string"==typeof Bun.version?"BUN":r.Deno&&"object"==typeof Deno.version?"DENO":"process"===a(r.process)?"NODE":r.window&&r.document?"BROWSER":"REST"},function(n,e,t){"use strict";var r=t(160),o=t(10),a=t(32),s=r(r.bind);n.exports=function(n,e){return o(n),void 0===e?n:a?s(n,e):function(){return n.apply(e,arguments)}}},function(n,e,t){"use strict";var r=t(27),o=t(7);n.exports=function(n){if("Function"===r(n))return o(n)}},function(n,e,t){"use strict";var r=t(18),o=t(93),a=r("iterator"),s=Array.prototype;n.exports=function(n){return void 0!==n&&(o.Array===n||s[a]===n)}},function(n,e,t){"use strict";var r=t(8),o=t(10),a=t(4),s=t(49),i=t(94),l=TypeError;n.exports=function(n,e){var t=arguments.length<2?i(n):e;if(o(t))return a(r(t,n));throw new l(s(n)+" is not iterable")}},function(n,e,t){"use strict";var r={};r[t(18)("toStringTag")]="z",n.exports="[object z]"===String(r)},function(n,e,t){"use strict";var r=t(13),o=t(56),a=t(10),s=t(4),i=t(28),l=t(14),c=t(29),p=t(96),d=t(1),u=TypeError,m=d((function(){[].keys().reduce((function(){}),void 0)})),g=!m&&c("reduce",u);r({target:"Iterator",proto:!0,real:!0,forced:m||g},{reduce:function(n){s(this);try{a(n)}catch(n){l(this,"throw",n)}var e=arguments.length<2,t=e?void 0:arguments[1];if(g)return p(g,this,e?[n]:[n,t]);var r=i(this),c=0;if(o(r,(function(r){e?(e=!1,t=r):t=n(t,r,c),c++}),{IS_RECORD:!0}),e)throw new u("Reduce of empty iterator with no initial value");return t}})},function(n,e,t){"use strict";var r=t(13),o=t(0),a=t(96),s=t(166),i=o.WebAssembly,l=7!==new Error("e",{cause:7}).cause,c=function(n,e){var t={};t[n]=s(n,e,l),r({global:!0,constructor:!0,arity:1,forced:l},t)},p=function(n,e){if(i&&i[n]){var t={};t[n]=s("WebAssembly."+n,e,l),r({target:"WebAssembly",stat:!0,constructor:!0,arity:1,forced:l},t)}};c("Error",(function(n){return function(e){return a(n,this,arguments)}})),c("EvalError",(function(n){return function(e){return a(n,this,arguments)}})),c("RangeError",(function(n){return function(e){return a(n,this,arguments)}})),c("ReferenceError",(function(n){return function(e){return a(n,this,arguments)}})),c("SyntaxError",(function(n){return function(e){return a(n,this,arguments)}})),c("TypeError",(function(n){return function(e){return a(n,this,arguments)}})),c("URIError",(function(n){return function(e){return a(n,this,arguments)}})),p("CompileError",(function(n){return function(e){return a(n,this,arguments)}})),p("LinkError",(function(n){return function(e){return a(n,this,arguments)}})),p("RuntimeError",(function(n){return function(e){return a(n,this,arguments)}}))},function(n,e,t){"use strict";var r=t(35),o=t(11),a=t(25),s=t(36),i=t(97),l=t(84),c=t(170),p=t(171),d=t(172),u=t(174),m=t(175),g=t(6),f=t(24);n.exports=function(n,e,t,h){var v=h?2:1,b=n.split("."),_=b[b.length-1],y=r.apply(null,b);if(y){var k=y.prototype;if(!f&&o(k,"cause")&&delete k.cause,!t)return y;var w=r("Error"),E=e((function(n,e){var t=d(h?e:n,void 0),r=h?new y(n):new y;return void 0!==t&&a(r,"message",t),m(r,E,r.stack,2),this&&s(k,this)&&p(r,this,E),arguments.length>v&&u(r,arguments[v]),r}));if(E.prototype=k,"Error"!==_?i?i(E,w):l(E,w,{name:!0}):g&&"stackTraceLimit"in y&&(c(E,y,"stackTraceLimit"),c(E,y,"prepareStackTrace")),l(E,y),!f)try{k.name!==_&&a(k,"name",_),k.constructor=E}catch(n){}return E}}},function(n,e,t){"use strict";var r=t(7),o=t(10);n.exports=function(n,e,t){try{return r(o(Object.getOwnPropertyDescriptor(n,e)[t]))}catch(n){}}},function(n,e,t){"use strict";var r=t(169),o=String,a=TypeError;n.exports=function(n){if(r(n))return n;throw new a("Can't set "+o(n)+" as a prototype")}},function(n,e,t){"use strict";var r=t(9);n.exports=function(n){return r(n)||null===n}},function(n,e,t){"use strict";var r=t(19).f;n.exports=function(n,e,t){t in n||r(n,t,{configurable:!0,get:function(){return e[t]},set:function(n){e[t]=n}})}},function(n,e,t){"use strict";var r=t(2),o=t(9),a=t(97);n.exports=function(n,e,t){var s,i;return a&&r(s=e.constructor)&&s!==t&&o(i=s.prototype)&&i!==t.prototype&&a(n,i),n}},function(n,e,t){"use strict";var r=t(173);n.exports=function(n,e){return void 0===n?arguments.length<2?"":e:r(n)}},function(n,e,t){"use strict";var r=t(95),o=String;n.exports=function(n){if("Symbol"===r(n))throw new TypeError("Cannot convert a Symbol value to a string");return o(n)}},function(n,e,t){"use strict";var r=t(9),o=t(25);n.exports=function(n,e){r(e)&&"cause"in e&&o(n,"cause",e.cause)}},function(n,e,t){"use strict";var r=t(25),o=t(176),a=t(177),s=Error.captureStackTrace;n.exports=function(n,e,t,i){a&&(s?s(n,e):r(n,"stack",o(t,i)))}},function(n,e,t){"use strict";var r=t(7),o=Error,a=r("".replace),s=String(new o("zxcasd").stack),i=/\n\s*at [^:]*:[^\n]*/,l=i.test(s);n.exports=function(n,e){if(l&&"string"==typeof n&&!o.prepareStackTrace)for(;e--;)n=a(n,i,"");return n}},function(n,e,t){"use strict";var r=t(1),o=t(33);n.exports=!r((function(){var n=new Error("a");return!("stack"in n)||(Object.defineProperty(n,"stack",o(1,7)),7!==n.stack)}))},function(n,e,t){"use strict";var r=t(6),o=t(179),a=TypeError,s=Object.getOwnPropertyDescriptor,i=r&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(n){return n instanceof TypeError}}();n.exports=i?function(n,e){if(o(n)&&!s(n,"length").writable)throw new a("Cannot set read only .length");return n.length=e}:function(n,e){return n.length=e}},function(n,e,t){"use strict";var r=t(27);n.exports=Array.isArray||function(n){return"Array"===r(n)}},function(n,e,t){"use strict";var r=TypeError;n.exports=function(n){if(n>9007199254740991)throw r("Maximum allowed index exceeded");return n}},function(n,e,t){var r=t(98),o=t(182);n.exports=function n(e,t,a,s,i){var l=-1,c=e.length;for(a||(a=o),i||(i=[]);++l<c;){var p=e[l];t>0&&a(p)?t>1?n(p,t-1,a,s,i):r(i,p):s||(i[i.length]=p)}return i}},function(n,e,t){var r=t(30),o=t(57),a=t(12),s=r?r.isConcatSpreadable:void 0;n.exports=function(n){return a(n)||o(n)||!!(s&&n&&n[s])}},function(n,e,t){var r=t(26),o=t(23);n.exports=function(n){return o(n)&&"[object Arguments]"==r(n)}},function(n,e,t){var r=t(30),o=Object.prototype,a=o.hasOwnProperty,s=o.toString,i=r?r.toStringTag:void 0;n.exports=function(n){var e=a.call(n,i),t=n[i];try{n[i]=void 0;var r=!0}catch(n){}var o=s.call(n);return r&&(e?n[i]=t:delete n[i]),o}},function(n,e){var t=Object.prototype.toString;n.exports=function(n){return t.call(n)}},function(n,e,t){var r=t(187),o=t(243),a=t(65),s=t(12),i=t(254);n.exports=function(n){return"function"==typeof n?n:null==n?a:"object"==typeof n?s(n)?o(n[0],n[1]):r(n):i(n)}},function(n,e,t){var r=t(188),o=t(242),a=t(115);n.exports=function(n){var e=o(n);return 1==e.length&&e[0][2]?a(e[0][0],e[0][1]):function(t){return t===n||r(t,n,e)}}},function(n,e,t){var r=t(100),o=t(104);n.exports=function(n,e,t,a){var s=t.length,i=s,l=!a;if(null==n)return!i;for(n=Object(n);s--;){var c=t[s];if(l&&c[2]?c[1]!==n[c[0]]:!(c[0]in n))return!1}for(;++s<i;){var p=(c=t[s])[0],d=n[p],u=c[1];if(l&&c[2]){if(void 0===d&&!(p in n))return!1}else{var m=new r;if(a)var g=a(d,u,p,n,e,m);if(!(void 0===g?o(u,d,3,a,m):g))return!1}}return!0}},function(n,e){n.exports=function(){this.__data__=[],this.size=0}},function(n,e,t){var r=t(41),o=Array.prototype.splice;n.exports=function(n){var e=this.__data__,t=r(e,n);return!(t<0)&&(t==e.length-1?e.pop():o.call(e,t,1),--this.size,!0)}},function(n,e,t){var r=t(41);n.exports=function(n){var e=this.__data__,t=r(e,n);return t<0?void 0:e[t][1]}},function(n,e,t){var r=t(41);n.exports=function(n){return r(this.__data__,n)>-1}},function(n,e,t){var r=t(41);n.exports=function(n,e){var t=this.__data__,o=r(t,n);return o<0?(++this.size,t.push([n,e])):t[o][1]=e,this}},function(n,e,t){var r=t(40);n.exports=function(){this.__data__=new r,this.size=0}},function(n,e){n.exports=function(n){var e=this.__data__,t=e.delete(n);return this.size=e.size,t}},function(n,e){n.exports=function(n){return this.__data__.get(n)}},function(n,e){n.exports=function(n){return this.__data__.has(n)}},function(n,e,t){var r=t(40),o=t(58),a=t(60);n.exports=function(n,e){var t=this.__data__;if(t instanceof r){var s=t.__data__;if(!o||s.length<199)return s.push([n,e]),this.size=++t.size,this;t=this.__data__=new a(s)}return t.set(n,e),this.size=t.size,this}},function(n,e,t){var r=t(102),o=t(200),a=t(59),s=t(103),i=/^\[object .+?Constructor\]$/,l=Function.prototype,c=Object.prototype,p=l.toString,d=c.hasOwnProperty,u=RegExp("^"+p.call(d).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");n.exports=function(n){return!(!a(n)||o(n))&&(r(n)?u:i).test(s(n))}},function(n,e,t){var r,o=t(201),a=(r=/[^.]+$/.exec(o&&o.keys&&o.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";n.exports=function(n){return!!a&&a in n}},function(n,e,t){var r=t(15)["__core-js_shared__"];n.exports=r},function(n,e){n.exports=function(n,e){return null==n?void 0:n[e]}},function(n,e,t){var r=t(204),o=t(40),a=t(58);n.exports=function(){this.size=0,this.__data__={hash:new r,map:new(a||o),string:new r}}},function(n,e,t){var r=t(205),o=t(206),a=t(207),s=t(208),i=t(209);function l(n){var e=-1,t=null==n?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}l.prototype.clear=r,l.prototype.delete=o,l.prototype.get=a,l.prototype.has=s,l.prototype.set=i,n.exports=l},function(n,e,t){var r=t(42);n.exports=function(){this.__data__=r?r(null):{},this.size=0}},function(n,e){n.exports=function(n){var e=this.has(n)&&delete this.__data__[n];return this.size-=e?1:0,e}},function(n,e,t){var r=t(42),o=Object.prototype.hasOwnProperty;n.exports=function(n){var e=this.__data__;if(r){var t=e[n];return"__lodash_hash_undefined__"===t?void 0:t}return o.call(e,n)?e[n]:void 0}},function(n,e,t){var r=t(42),o=Object.prototype.hasOwnProperty;n.exports=function(n){var e=this.__data__;return r?void 0!==e[n]:o.call(e,n)}},function(n,e,t){var r=t(42);n.exports=function(n,e){var t=this.__data__;return this.size+=this.has(n)?0:1,t[n]=r&&void 0===e?"__lodash_hash_undefined__":e,this}},function(n,e,t){var r=t(43);n.exports=function(n){var e=r(this,n).delete(n);return this.size-=e?1:0,e}},function(n,e){n.exports=function(n){var e=typeof n;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==n:null===n}},function(n,e,t){var r=t(43);n.exports=function(n){return r(this,n).get(n)}},function(n,e,t){var r=t(43);n.exports=function(n){return r(this,n).has(n)}},function(n,e,t){var r=t(43);n.exports=function(n,e){var t=r(this,n),o=t.size;return t.set(n,e),this.size+=t.size==o?0:1,this}},function(n,e,t){var r=t(100),o=t(105),a=t(219),s=t(222),i=t(238),l=t(12),c=t(109),p=t(111),d="[object Object]",u=Object.prototype.hasOwnProperty;n.exports=function(n,e,t,m,g,f){var h=l(n),v=l(e),b=h?"[object Array]":i(n),_=v?"[object Array]":i(e),y=(b="[object Arguments]"==b?d:b)==d,k=(_="[object Arguments]"==_?d:_)==d,w=b==_;if(w&&c(n)){if(!c(e))return!1;h=!0,y=!1}if(w&&!y)return f||(f=new r),h||p(n)?o(n,e,t,m,g,f):a(n,e,b,t,m,g,f);if(!(1&t)){var E=y&&u.call(n,"__wrapped__"),x=k&&u.call(e,"__wrapped__");if(E||x){var A=E?n.value():n,B=x?e.value():e;return f||(f=new r),g(A,B,t,m,f)}}return!!w&&(f||(f=new r),s(n,e,t,m,g,f))}},function(n,e){n.exports=function(n){return this.__data__.set(n,"__lodash_hash_undefined__"),this}},function(n,e){n.exports=function(n){return this.__data__.has(n)}},function(n,e){n.exports=function(n,e){for(var t=-1,r=null==n?0:n.length;++t<r;)if(e(n[t],t,n))return!0;return!1}},function(n,e,t){var r=t(30),o=t(220),a=t(101),s=t(105),i=t(221),l=t(61),c=r?r.prototype:void 0,p=c?c.valueOf:void 0;n.exports=function(n,e,t,r,c,d,u){switch(t){case"[object DataView]":if(n.byteLength!=e.byteLength||n.byteOffset!=e.byteOffset)return!1;n=n.buffer,e=e.buffer;case"[object ArrayBuffer]":return!(n.byteLength!=e.byteLength||!d(new o(n),new o(e)));case"[object Boolean]":case"[object Date]":case"[object Number]":return a(+n,+e);case"[object Error]":return n.name==e.name&&n.message==e.message;case"[object RegExp]":case"[object String]":return n==e+"";case"[object Map]":var m=i;case"[object Set]":var g=1&r;if(m||(m=l),n.size!=e.size&&!g)return!1;var f=u.get(n);if(f)return f==e;r|=2,u.set(n,e);var h=s(m(n),m(e),r,c,d,u);return u.delete(n),h;case"[object Symbol]":if(p)return p.call(n)==p.call(e)}return!1}},function(n,e,t){var r=t(15).Uint8Array;n.exports=r},function(n,e){n.exports=function(n){var e=-1,t=Array(n.size);return n.forEach((function(n,r){t[++e]=[r,n]})),t}},function(n,e,t){var r=t(223),o=Object.prototype.hasOwnProperty;n.exports=function(n,e,t,a,s,i){var l=1&t,c=r(n),p=c.length;if(p!=r(e).length&&!l)return!1;for(var d=p;d--;){var u=c[d];if(!(l?u in e:o.call(e,u)))return!1}var m=i.get(n),g=i.get(e);if(m&&g)return m==e&&g==n;var f=!0;i.set(n,e),i.set(e,n);for(var h=l;++d<p;){var v=n[u=c[d]],b=e[u];if(a)var _=l?a(b,v,u,e,n,i):a(v,b,u,n,e,i);if(!(void 0===_?v===b||s(v,b,t,a,i):_)){f=!1;break}h||(h="constructor"==u)}if(f&&!h){var y=n.constructor,k=e.constructor;y==k||!("constructor"in n)||!("constructor"in e)||"function"==typeof y&&y instanceof y&&"function"==typeof k&&k instanceof k||(f=!1)}return i.delete(n),i.delete(e),f}},function(n,e,t){var r=t(224),o=t(225),a=t(108);n.exports=function(n){return r(n,a,o)}},function(n,e,t){var r=t(98),o=t(12);n.exports=function(n,e,t){var a=e(n);return o(n)?a:r(a,t(n))}},function(n,e,t){var r=t(226),o=t(227),a=Object.prototype.propertyIsEnumerable,s=Object.getOwnPropertySymbols,i=s?function(n){return null==n?[]:(n=Object(n),r(s(n),(function(e){return a.call(n,e)})))}:o;n.exports=i},function(n,e){n.exports=function(n,e){for(var t=-1,r=null==n?0:n.length,o=0,a=[];++t<r;){var s=n[t];e(s,t,n)&&(a[o++]=s)}return a}},function(n,e){n.exports=function(){return[]}},function(n,e,t){var r=t(229),o=t(57),a=t(12),s=t(109),i=t(110),l=t(111),c=Object.prototype.hasOwnProperty;n.exports=function(n,e){var t=a(n),p=!t&&o(n),d=!t&&!p&&s(n),u=!t&&!p&&!d&&l(n),m=t||p||d||u,g=m?r(n.length,String):[],f=g.length;for(var h in n)!e&&!c.call(n,h)||m&&("length"==h||d&&("offset"==h||"parent"==h)||u&&("buffer"==h||"byteLength"==h||"byteOffset"==h)||i(h,f))||g.push(h);return g}},function(n,e){n.exports=function(n,e){for(var t=-1,r=Array(n);++t<n;)r[t]=e(t);return r}},function(n,e){n.exports=function(){return!1}},function(n,e,t){var r=t(26),o=t(62),a=t(23),s={};s["[object Float32Array]"]=s["[object Float64Array]"]=s["[object Int8Array]"]=s["[object Int16Array]"]=s["[object Int32Array]"]=s["[object Uint8Array]"]=s["[object Uint8ClampedArray]"]=s["[object Uint16Array]"]=s["[object Uint32Array]"]=!0,s["[object Arguments]"]=s["[object Array]"]=s["[object ArrayBuffer]"]=s["[object Boolean]"]=s["[object DataView]"]=s["[object Date]"]=s["[object Error]"]=s["[object Function]"]=s["[object Map]"]=s["[object Number]"]=s["[object Object]"]=s["[object RegExp]"]=s["[object Set]"]=s["[object String]"]=s["[object WeakMap]"]=!1,n.exports=function(n){return a(n)&&o(n.length)&&!!s[r(n)]}},function(n,e){n.exports=function(n){return function(e){return n(e)}}},function(n,e,t){(function(n){var r=t(99),o=e&&!e.nodeType&&e,a=o&&"object"==typeof n&&n&&!n.nodeType&&n,s=a&&a.exports===o&&r.process,i=function(){try{var n=a&&a.require&&a.require("util").types;return n||s&&s.binding&&s.binding("util")}catch(n){}}();n.exports=i}).call(this,t(67)(n))},function(n,e,t){var r=t(235),o=t(236),a=Object.prototype.hasOwnProperty;n.exports=function(n){if(!r(n))return o(n);var e=[];for(var t in Object(n))a.call(n,t)&&"constructor"!=t&&e.push(t);return e}},function(n,e){var t=Object.prototype;n.exports=function(n){var e=n&&n.constructor;return n===("function"==typeof e&&e.prototype||t)}},function(n,e,t){var r=t(237)(Object.keys,Object);n.exports=r},function(n,e){n.exports=function(n,e){return function(t){return n(e(t))}}},function(n,e,t){var r=t(239),o=t(58),a=t(240),s=t(113),i=t(241),l=t(26),c=t(103),p=c(r),d=c(o),u=c(a),m=c(s),g=c(i),f=l;(r&&"[object DataView]"!=f(new r(new ArrayBuffer(1)))||o&&"[object Map]"!=f(new o)||a&&"[object Promise]"!=f(a.resolve())||s&&"[object Set]"!=f(new s)||i&&"[object WeakMap]"!=f(new i))&&(f=function(n){var e=l(n),t="[object Object]"==e?n.constructor:void 0,r=t?c(t):"";if(r)switch(r){case p:return"[object DataView]";case d:return"[object Map]";case u:return"[object Promise]";case m:return"[object Set]";case g:return"[object WeakMap]"}return e}),n.exports=f},function(n,e,t){var r=t(20)(t(15),"DataView");n.exports=r},function(n,e,t){var r=t(20)(t(15),"Promise");n.exports=r},function(n,e,t){var r=t(20)(t(15),"WeakMap");n.exports=r},function(n,e,t){var r=t(114),o=t(108);n.exports=function(n){for(var e=o(n),t=e.length;t--;){var a=e[t],s=n[a];e[t]=[a,s,r(s)]}return e}},function(n,e,t){var r=t(104),o=t(244),a=t(251),s=t(63),i=t(114),l=t(115),c=t(44);n.exports=function(n,e){return s(n)&&i(e)?l(c(n),e):function(t){var s=o(t,n);return void 0===s&&s===e?a(t,n):r(e,s,3)}}},function(n,e,t){var r=t(116);n.exports=function(n,e,t){var o=null==n?void 0:r(n,e);return void 0===o?t:o}},function(n,e,t){var r=t(246),o=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,a=/\\(\\)?/g,s=r((function(n){var e=[];return 46===n.charCodeAt(0)&&e.push(""),n.replace(o,(function(n,t,r,o){e.push(r?o.replace(a,"$1"):t||n)})),e}));n.exports=s},function(n,e,t){var r=t(247);n.exports=function(n){var e=r(n,(function(n){return 500===t.size&&t.clear(),n})),t=e.cache;return e}},function(n,e,t){var r=t(60);function o(n,e){if("function"!=typeof n||null!=e&&"function"!=typeof e)throw new TypeError("Expected a function");var t=function(){var r=arguments,o=e?e.apply(this,r):r[0],a=t.cache;if(a.has(o))return a.get(o);var s=n.apply(this,r);return t.cache=a.set(o,s)||a,s};return t.cache=new(o.Cache||r),t}o.Cache=r,n.exports=o},function(n,e,t){var r=t(249);n.exports=function(n){return null==n?"":r(n)}},function(n,e,t){var r=t(30),o=t(250),a=t(12),s=t(64),i=r?r.prototype:void 0,l=i?i.toString:void 0;n.exports=function n(e){if("string"==typeof e)return e;if(a(e))return o(e,n)+"";if(s(e))return l?l.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(n,e){n.exports=function(n,e){for(var t=-1,r=null==n?0:n.length,o=Array(r);++t<r;)o[t]=e(n[t],t,n);return o}},function(n,e,t){var r=t(252),o=t(253);n.exports=function(n,e){return null!=n&&o(n,e,r)}},function(n,e){n.exports=function(n,e){return null!=n&&e in Object(n)}},function(n,e,t){var r=t(117),o=t(57),a=t(12),s=t(110),i=t(62),l=t(44);n.exports=function(n,e,t){for(var c=-1,p=(e=r(e,n)).length,d=!1;++c<p;){var u=l(e[c]);if(!(d=null!=n&&t(n,u)))break;n=n[u]}return d||++c!=p?d:!!(p=null==n?0:n.length)&&i(p)&&s(u,p)&&(a(n)||o(n))}},function(n,e,t){var r=t(255),o=t(256),a=t(63),s=t(44);n.exports=function(n){return a(n)?r(s(n)):o(n)}},function(n,e){n.exports=function(n){return function(e){return null==e?void 0:e[n]}}},function(n,e,t){var r=t(116);n.exports=function(n){return function(e){return r(e,n)}}},function(n,e,t){var r=t(65),o=t(258),a=t(260);n.exports=function(n,e){return a(o(n,e,r),n+"")}},function(n,e,t){var r=t(259),o=Math.max;n.exports=function(n,e,t){return e=o(void 0===e?n.length-1:e,0),function(){for(var a=arguments,s=-1,i=o(a.length-e,0),l=Array(i);++s<i;)l[s]=a[e+s];s=-1;for(var c=Array(e+1);++s<e;)c[s]=a[s];return c[e]=t(l),r(n,this,c)}}},function(n,e){n.exports=function(n,e,t){switch(t.length){case 0:return n.call(e);case 1:return n.call(e,t[0]);case 2:return n.call(e,t[0],t[1]);case 3:return n.call(e,t[0],t[1],t[2])}return n.apply(e,t)}},function(n,e,t){var r=t(261),o=t(264)(r);n.exports=o},function(n,e,t){var r=t(262),o=t(263),a=t(65),s=o?function(n,e){return o(n,"toString",{configurable:!0,enumerable:!1,value:r(e),writable:!0})}:a;n.exports=s},function(n,e){n.exports=function(n){return function(){return n}}},function(n,e,t){var r=t(20),o=function(){try{var n=r(Object,"defineProperty");return n({},"",{}),n}catch(n){}}();n.exports=o},function(n,e){var t=Date.now;n.exports=function(n){var e=0,r=0;return function(){var o=t(),a=16-(o-r);if(r=o,a>0){if(++e>=800)return arguments[0]}else e=0;return n.apply(void 0,arguments)}}},function(n,e,t){var r=t(106),o=t(266),a=t(271),s=t(107),i=t(272),l=t(61);n.exports=function(n,e,t){var c=-1,p=o,d=n.length,u=!0,m=[],g=m;if(t)u=!1,p=a;else if(d>=200){var f=e?null:i(n);if(f)return l(f);u=!1,p=s,g=new r}else g=e?[]:m;n:for(;++c<d;){var h=n[c],v=e?e(h):h;if(h=t||0!==h?h:0,u&&v==v){for(var b=g.length;b--;)if(g[b]===v)continue n;e&&g.push(v),m.push(h)}else p(g,v,t)||(g!==m&&g.push(v),m.push(h))}return m}},function(n,e,t){var r=t(267);n.exports=function(n,e){return!!(null==n?0:n.length)&&r(n,e,0)>-1}},function(n,e,t){var r=t(268),o=t(269),a=t(270);n.exports=function(n,e,t){return e==e?a(n,e,t):r(n,o,t)}},function(n,e){n.exports=function(n,e,t,r){for(var o=n.length,a=t+(r?1:-1);r?a--:++a<o;)if(e(n[a],a,n))return a;return-1}},function(n,e){n.exports=function(n){return n!=n}},function(n,e){n.exports=function(n,e,t){for(var r=t-1,o=n.length;++r<o;)if(n[r]===e)return r;return-1}},function(n,e){n.exports=function(n,e,t){for(var r=-1,o=null==n?0:n.length;++r<o;)if(t(e,n[r]))return!0;return!1}},function(n,e,t){var r=t(113),o=t(273),a=t(61),s=r&&1/a(new r([,-0]))[1]==1/0?function(n){return new r(n)}:o;n.exports=s},function(n,e){n.exports=function(){}},function(n,e,t){var r=t(112),o=t(23);n.exports=function(n){return o(n)&&r(n)}},function(n,e,t){},function(n,e,t){},function(n,e,t){"use strict";t(118)},function(n,e,t){"use strict";t(119)},function(n,e,t){},function(n,e,t){},function(n,e){},function(n,e){function t(n,e){for(var t=0,r=n.length-1;r>=0;r--){var o=n[r];"."===o?n.splice(r,1):".."===o?(n.splice(r,1),t++):t&&(n.splice(r,1),t--)}if(e)for(;t--;t)n.unshift("..");return n}function r(n,e){if(n.filter)return n.filter(e);for(var t=[],r=0;r<n.length;r++)e(n[r],r,n)&&t.push(n[r]);return t}e.resolve=function(){for(var n="",e=!1,o=arguments.length-1;o>=-1&&!e;o--){var a=o>=0?arguments[o]:process.cwd();if("string"!=typeof a)throw new TypeError("Arguments to path.resolve must be strings");a&&(n=a+"/"+n,e="/"===a.charAt(0))}return(e?"/":"")+(n=t(r(n.split("/"),(function(n){return!!n})),!e).join("/"))||"."},e.normalize=function(n){var a=e.isAbsolute(n),s="/"===o(n,-1);return(n=t(r(n.split("/"),(function(n){return!!n})),!a).join("/"))||a||(n="."),n&&s&&(n+="/"),(a?"/":"")+n},e.isAbsolute=function(n){return"/"===n.charAt(0)},e.join=function(){var n=Array.prototype.slice.call(arguments,0);return e.normalize(r(n,(function(n,e){if("string"!=typeof n)throw new TypeError("Arguments to path.join must be strings");return n})).join("/"))},e.relative=function(n,t){function r(n){for(var e=0;e<n.length&&""===n[e];e++);for(var t=n.length-1;t>=0&&""===n[t];t--);return e>t?[]:n.slice(e,t-e+1)}n=e.resolve(n).substr(1),t=e.resolve(t).substr(1);for(var o=r(n.split("/")),a=r(t.split("/")),s=Math.min(o.length,a.length),i=s,l=0;l<s;l++)if(o[l]!==a[l]){i=l;break}var c=[];for(l=i;l<o.length;l++)c.push("..");return(c=c.concat(a.slice(i))).join("/")},e.sep="/",e.delimiter=":",e.dirname=function(n){if("string"!=typeof n&&(n+=""),0===n.length)return".";for(var e=n.charCodeAt(0),t=47===e,r=-1,o=!0,a=n.length-1;a>=1;--a)if(47===(e=n.charCodeAt(a))){if(!o){r=a;break}}else o=!1;return-1===r?t?"/":".":t&&1===r?"/":n.slice(0,r)},e.basename=function(n,e){var t=function(n){"string"!=typeof n&&(n+="");var e,t=0,r=-1,o=!0;for(e=n.length-1;e>=0;--e)if(47===n.charCodeAt(e)){if(!o){t=e+1;break}}else-1===r&&(o=!1,r=e+1);return-1===r?"":n.slice(t,r)}(n);return e&&t.substr(-1*e.length)===e&&(t=t.substr(0,t.length-e.length)),t},e.extname=function(n){"string"!=typeof n&&(n+="");for(var e=-1,t=0,r=-1,o=!0,a=0,s=n.length-1;s>=0;--s){var i=n.charCodeAt(s);if(47!==i)-1===r&&(o=!1,r=s+1),46===i?-1===e?e=s:1!==a&&(a=1):-1!==e&&(a=-1);else if(!o){t=s+1;break}}return-1===e||-1===r||0===a||1===a&&e===r-1&&e===t+1?"":n.slice(e,r)};var o="b"==="ab".substr(-1)?function(n,e,t){return n.substr(e,t)}:function(n,e,t){return e<0&&(e=n.length+e),n.substr(e,t)}},function(n,e,t){"use strict";var r=/[|\\{}()[\]^$+*?.]/g,o=Object.prototype.hasOwnProperty,a=function(n,e){return o.apply(n,[e])};e.escapeRegExpChars=function(n){return n?String(n).replace(r,"\\$&"):""};var s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},i=/[&<>'"]/g;function l(n){return s[n]||n}function c(){return Function.prototype.toString.call(this)+';\nvar _ENCODE_HTML_RULES = {\n      "&": "&amp;"\n    , "<": "&lt;"\n    , ">": "&gt;"\n    , \'"\': "&#34;"\n    , "\'": "&#39;"\n    }\n  , _MATCH_HTML = /[&<>\'"]/g;\nfunction encode_char(c) {\n  return _ENCODE_HTML_RULES[c] || c;\n};\n'}e.escapeXML=function(n){return null==n?"":String(n).replace(i,l)};try{"function"==typeof Object.defineProperty?Object.defineProperty(e.escapeXML,"toString",{value:c}):e.escapeXML.toString=c}catch(n){console.warn("Unable to set escapeXML.toString (is the Function prototype frozen?)")}e.shallowCopy=function(n,e){if(e=e||{},null!=n)for(var t in e)a(e,t)&&"__proto__"!==t&&"constructor"!==t&&(n[t]=e[t]);return n},e.shallowCopyFromList=function(n,e,t){if(t=t||[],e=e||{},null!=n)for(var r=0;r<t.length;r++){var o=t[r];if(void 0!==e[o]){if(!a(e,o))continue;if("__proto__"===o||"constructor"===o)continue;n[o]=e[o]}}return n},e.cache={_data:{},set:function(n,e){this._data[n]=e},get:function(n){return this._data[n]},remove:function(n){delete this._data[n]},reset:function(){this._data={}}},e.hyphenToCamel=function(n){return n.replace(/-[a-z]/g,(function(n){return n[1].toUpperCase()}))},e.createNullProtoObjWherePossible="function"==typeof Object.create?function(){return Object.create(null)}:{__proto__:null}instanceof Object?function(){return{}}:function(){return{__proto__:null}},e.hasOwnOnlyObject=function(n){var t=e.createNullProtoObjWherePossible();for(var r in n)a(n,r)&&(t[r]=n[r]);return t}},function(n){n.exports=JSON.parse('{"_from":"ejs@^3.1.8","_id":"ejs@3.1.10","_inBundle":false,"_integrity":"sha512-UeJmFfOrAQS8OJWPZ4qtgHyWExa088/MtK5UEyoJGFH67cDEXkZSviOiKRCZ4Xij0zxI3JECgYs3oKx+AizQBA==","_location":"/ejs","_phantomChildren":{},"_requested":{"type":"range","registry":true,"raw":"ejs@^3.1.8","name":"ejs","escapedName":"ejs","rawSpec":"^3.1.8","saveSpec":null,"fetchSpec":"^3.1.8"},"_requiredBy":["/vuepress-plugin-vssue-global"],"_resolved":"https://registry.npmjs.org/ejs/-/ejs-3.1.10.tgz","_shasum":"69ab8358b14e896f80cc39e62087b88500c3ac3b","_spec":"ejs@^3.1.8","_where":"/home/runner/work/tenqaz.github.io/tenqaz.github.io/node_modules/vuepress-plugin-vssue-global","author":{"name":"Matthew Eernisse","email":"mde@fleegix.org","url":"http://fleegix.org"},"bin":{"ejs":"bin/cli.js"},"bugs":{"url":"https://github.com/mde/ejs/issues"},"bundleDependencies":false,"dependencies":{"jake":"^10.8.5"},"deprecated":false,"description":"Embedded JavaScript templates","devDependencies":{"browserify":"^16.5.1","eslint":"^6.8.0","git-directory-deploy":"^1.5.1","jsdoc":"^4.0.2","lru-cache":"^4.0.1","mocha":"^10.2.0","uglify-js":"^3.3.16"},"engines":{"node":">=0.10.0"},"homepage":"https://github.com/mde/ejs","jsdelivr":"ejs.min.js","keywords":["template","engine","ejs"],"license":"Apache-2.0","main":"./lib/ejs.js","name":"ejs","repository":{"type":"git","url":"git://github.com/mde/ejs.git"},"scripts":{"test":"npx jake test"},"unpkg":"ejs.min.js","version":"3.1.10"}')},function(n,e,t){"use strict";t(120)},function(n,e,t){"use strict";t(121)},function(n,e,t){"use strict";t(122)},function(n,e,t){"use strict";t.r(e);t(3),t(16),t(22);var r=Object.freeze({}),o=Array.isArray;function a(n){return null==n}function s(n){return null!=n}function i(n){return!0===n}function l(n){return"string"==typeof n||"number"==typeof n||"symbol"==typeof n||"boolean"==typeof n}function c(n){return"function"==typeof n}function p(n){return null!==n&&"object"==typeof n}var d=Object.prototype.toString;function u(n){return"[object Object]"===d.call(n)}function m(n){return"[object RegExp]"===d.call(n)}function g(n){var e=parseFloat(String(n));return e>=0&&Math.floor(e)===e&&isFinite(n)}function f(n){return s(n)&&"function"==typeof n.then&&"function"==typeof n.catch}function h(n){return null==n?"":Array.isArray(n)||u(n)&&n.toString===d?JSON.stringify(n,v,2):String(n)}function v(n,e){return e&&e.__v_isRef?e.value:e}function b(n){var e=parseFloat(n);return isNaN(e)?n:e}function _(n,e){for(var t=Object.create(null),r=n.split(","),o=0;o<r.length;o++)t[r[o]]=!0;return e?function(n){return t[n.toLowerCase()]}:function(n){return t[n]}}_("slot,component",!0);var y=_("key,ref,slot,slot-scope,is");function k(n,e){var t=n.length;if(t){if(e===n[t-1])return void(n.length=t-1);var r=n.indexOf(e);if(r>-1)return n.splice(r,1)}}var w=Object.prototype.hasOwnProperty;function E(n,e){return w.call(n,e)}function x(n){var e=Object.create(null);return function(t){return e[t]||(e[t]=n(t))}}var A=/-(\w)/g,B=x((function(n){return n.replace(A,(function(n,e){return e?e.toUpperCase():""}))})),z=x((function(n){return n.charAt(0).toUpperCase()+n.slice(1)})),j=/\B([A-Z])/g,T=x((function(n){return n.replace(j,"-$1").toLowerCase()}));var C=Function.prototype.bind?function(n,e){return n.bind(e)}:function(n,e){function t(t){var r=arguments.length;return r?r>1?n.apply(e,arguments):n.call(e,t):n.call(e)}return t._length=n.length,t};function S(n,e){e=e||0;for(var t=n.length-e,r=new Array(t);t--;)r[t]=n[t+e];return r}function P(n,e){for(var t in e)n[t]=e[t];return n}function I(n){for(var e={},t=0;t<n.length;t++)n[t]&&P(e,n[t]);return e}function q(n,e,t){}var D=function(n,e,t){return!1},N=function(n){return n};function O(n,e){if(n===e)return!0;var t=p(n),r=p(e);if(!t||!r)return!t&&!r&&String(n)===String(e);try{var o=Array.isArray(n),a=Array.isArray(e);if(o&&a)return n.length===e.length&&n.every((function(n,t){return O(n,e[t])}));if(n instanceof Date&&e instanceof Date)return n.getTime()===e.getTime();if(o||a)return!1;var s=Object.keys(n),i=Object.keys(e);return s.length===i.length&&s.every((function(t){return O(n[t],e[t])}))}catch(n){return!1}}function R(n,e){for(var t=0;t<n.length;t++)if(O(n[t],e))return t;return-1}function F(n){var e=!1;return function(){e||(e=!0,n.apply(this,arguments))}}function L(n,e){return n===e?0===n&&1/n!=1/e:n==n||e==e}var U=["component","directive","filter"],M=["beforeCreate","created","beforeMount","mounted","beforeUpdate","updated","beforeDestroy","destroyed","activated","deactivated","errorCaptured","serverPrefetch","renderTracked","renderTriggered"],G={optionMergeStrategies:Object.create(null),silent:!1,productionTip:!1,devtools:!1,performance:!1,errorHandler:null,warnHandler:null,ignoredElements:[],keyCodes:Object.create(null),isReservedTag:D,isReservedAttr:D,isUnknownElement:D,getTagNamespace:q,parsePlatformTagName:N,mustUseProp:D,async:!0,_lifecycleHooks:M},V=/a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD/;function $(n){var e=(n+"").charCodeAt(0);return 36===e||95===e}function W(n,e,t,r){Object.defineProperty(n,e,{value:t,enumerable:!!r,writable:!0,configurable:!0})}var H=new RegExp("[^".concat(V.source,".$_\\d]"));var Z="__proto__"in{},K="undefined"!=typeof window,X=K&&window.navigator.userAgent.toLowerCase(),J=X&&/msie|trident/.test(X),Y=X&&X.indexOf("msie 9.0")>0,Q=X&&X.indexOf("edge/")>0;X&&X.indexOf("android");var nn=X&&/iphone|ipad|ipod|ios/.test(X);X&&/chrome\/\d+/.test(X),X&&/phantomjs/.test(X);var en,tn=X&&X.match(/firefox\/(\d+)/),rn={}.watch,on=!1;if(K)try{var an={};Object.defineProperty(an,"passive",{get:function(){on=!0}}),window.addEventListener("test-passive",null,an)}catch(n){}var sn=function(){return void 0===en&&(en=!K&&"undefined"!=typeof global&&(global.process&&"server"===global.process.env.VUE_ENV)),en},ln=K&&window.__VUE_DEVTOOLS_GLOBAL_HOOK__;function cn(n){return"function"==typeof n&&/native code/.test(n.toString())}var pn,dn="undefined"!=typeof Symbol&&cn(Symbol)&&"undefined"!=typeof Reflect&&cn(Reflect.ownKeys);pn="undefined"!=typeof Set&&cn(Set)?Set:function(){function n(){this.set=Object.create(null)}return n.prototype.has=function(n){return!0===this.set[n]},n.prototype.add=function(n){this.set[n]=!0},n.prototype.clear=function(){this.set=Object.create(null)},n}();var un=null;function mn(n){void 0===n&&(n=null),n||un&&un._scope.off(),un=n,n&&n._scope.on()}var gn=function(){function n(n,e,t,r,o,a,s,i){this.tag=n,this.data=e,this.children=t,this.text=r,this.elm=o,this.ns=void 0,this.context=a,this.fnContext=void 0,this.fnOptions=void 0,this.fnScopeId=void 0,this.key=e&&e.key,this.componentOptions=s,this.componentInstance=void 0,this.parent=void 0,this.raw=!1,this.isStatic=!1,this.isRootInsert=!0,this.isComment=!1,this.isCloned=!1,this.isOnce=!1,this.asyncFactory=i,this.asyncMeta=void 0,this.isAsyncPlaceholder=!1}return Object.defineProperty(n.prototype,"child",{get:function(){return this.componentInstance},enumerable:!1,configurable:!0}),n}(),fn=function(n){void 0===n&&(n="");var e=new gn;return e.text=n,e.isComment=!0,e};function hn(n){return new gn(void 0,void 0,void 0,String(n))}function vn(n){var e=new gn(n.tag,n.data,n.children&&n.children.slice(),n.text,n.elm,n.context,n.componentOptions,n.asyncFactory);return e.ns=n.ns,e.isStatic=n.isStatic,e.key=n.key,e.isComment=n.isComment,e.fnContext=n.fnContext,e.fnOptions=n.fnOptions,e.fnScopeId=n.fnScopeId,e.asyncMeta=n.asyncMeta,e.isCloned=!0,e}"function"==typeof SuppressedError&&SuppressedError;var bn=0,_n=[],yn=function(){function n(){this._pending=!1,this.id=bn++,this.subs=[]}return n.prototype.addSub=function(n){this.subs.push(n)},n.prototype.removeSub=function(n){this.subs[this.subs.indexOf(n)]=null,this._pending||(this._pending=!0,_n.push(this))},n.prototype.depend=function(e){n.target&&n.target.addDep(this)},n.prototype.notify=function(n){var e=this.subs.filter((function(n){return n}));for(var t=0,r=e.length;t<r;t++){0,e[t].update()}},n}();yn.target=null;var kn=[];function wn(n){kn.push(n),yn.target=n}function En(){kn.pop(),yn.target=kn[kn.length-1]}var xn=Array.prototype,An=Object.create(xn);["push","pop","shift","unshift","splice","sort","reverse"].forEach((function(n){var e=xn[n];W(An,n,(function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o,a=e.apply(this,t),s=this.__ob__;switch(n){case"push":case"unshift":o=t;break;case"splice":o=t.slice(2)}return o&&s.observeArray(o),s.dep.notify(),a}))}));var Bn=Object.getOwnPropertyNames(An),zn={},jn=!0;function Tn(n){jn=n}var Cn={notify:q,depend:q,addSub:q,removeSub:q},Sn=function(){function n(n,e,t){if(void 0===e&&(e=!1),void 0===t&&(t=!1),this.value=n,this.shallow=e,this.mock=t,this.dep=t?Cn:new yn,this.vmCount=0,W(n,"__ob__",this),o(n)){if(!t)if(Z)n.__proto__=An;else for(var r=0,a=Bn.length;r<a;r++){W(n,i=Bn[r],An[i])}e||this.observeArray(n)}else{var s=Object.keys(n);for(r=0;r<s.length;r++){var i;In(n,i=s[r],zn,void 0,e,t)}}}return n.prototype.observeArray=function(n){for(var e=0,t=n.length;e<t;e++)Pn(n[e],!1,this.mock)},n}();function Pn(n,e,t){return n&&E(n,"__ob__")&&n.__ob__ instanceof Sn?n.__ob__:!jn||!t&&sn()||!o(n)&&!u(n)||!Object.isExtensible(n)||n.__v_skip||Ln(n)||n instanceof gn?void 0:new Sn(n,e,t)}function In(n,e,t,r,a,s,i){void 0===i&&(i=!1);var l=new yn,c=Object.getOwnPropertyDescriptor(n,e);if(!c||!1!==c.configurable){var p=c&&c.get,d=c&&c.set;p&&!d||t!==zn&&2!==arguments.length||(t=n[e]);var u=a?t&&t.__ob__:Pn(t,!1,s);return Object.defineProperty(n,e,{enumerable:!0,configurable:!0,get:function(){var e=p?p.call(n):t;return yn.target&&(l.depend(),u&&(u.dep.depend(),o(e)&&Nn(e))),Ln(e)&&!a?e.value:e},set:function(e){var r=p?p.call(n):t;if(L(r,e)){if(d)d.call(n,e);else{if(p)return;if(!a&&Ln(r)&&!Ln(e))return void(r.value=e);t=e}u=a?e&&e.__ob__:Pn(e,!1,s),l.notify()}}}),l}}function qn(n,e,t){if(!Fn(n)){var r=n.__ob__;return o(n)&&g(e)?(n.length=Math.max(n.length,e),n.splice(e,1,t),r&&!r.shallow&&r.mock&&Pn(t,!1,!0),t):e in n&&!(e in Object.prototype)?(n[e]=t,t):n._isVue||r&&r.vmCount?t:r?(In(r.value,e,t,void 0,r.shallow,r.mock),r.dep.notify(),t):(n[e]=t,t)}}function Dn(n,e){if(o(n)&&g(e))n.splice(e,1);else{var t=n.__ob__;n._isVue||t&&t.vmCount||Fn(n)||E(n,e)&&(delete n[e],t&&t.dep.notify())}}function Nn(n){for(var e=void 0,t=0,r=n.length;t<r;t++)(e=n[t])&&e.__ob__&&e.__ob__.dep.depend(),o(e)&&Nn(e)}function On(n){return Rn(n,!0),W(n,"__v_isShallow",!0),n}function Rn(n,e){if(!Fn(n)){Pn(n,e,sn());0}}function Fn(n){return!(!n||!n.__v_isReadonly)}function Ln(n){return!(!n||!0!==n.__v_isRef)}function Un(n,e,t){Object.defineProperty(n,t,{enumerable:!0,configurable:!0,get:function(){var n=e[t];if(Ln(n))return n.value;var r=n&&n.__ob__;return r&&r.dep.depend(),n},set:function(n){var r=e[t];Ln(r)&&!Ln(n)?r.value=n:e[t]=n}})}"".concat("watcher"," callback"),"".concat("watcher"," getter"),"".concat("watcher"," cleanup");var Mn;var Gn=function(){function n(n){void 0===n&&(n=!1),this.detached=n,this.active=!0,this.effects=[],this.cleanups=[],this.parent=Mn,!n&&Mn&&(this.index=(Mn.scopes||(Mn.scopes=[])).push(this)-1)}return n.prototype.run=function(n){if(this.active){var e=Mn;try{return Mn=this,n()}finally{Mn=e}}else 0},n.prototype.on=function(){Mn=this},n.prototype.off=function(){Mn=this.parent},n.prototype.stop=function(n){if(this.active){var e=void 0,t=void 0;for(e=0,t=this.effects.length;e<t;e++)this.effects[e].teardown();for(e=0,t=this.cleanups.length;e<t;e++)this.cleanups[e]();if(this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].stop(!0);if(!this.detached&&this.parent&&!n){var r=this.parent.scopes.pop();r&&r!==this&&(this.parent.scopes[this.index]=r,r.index=this.index)}this.parent=void 0,this.active=!1}},n}();function Vn(n){var e=n._provided,t=n.$parent&&n.$parent._provided;return t===e?n._provided=Object.create(t):e}var $n=x((function(n){var e="&"===n.charAt(0),t="~"===(n=e?n.slice(1):n).charAt(0),r="!"===(n=t?n.slice(1):n).charAt(0);return{name:n=r?n.slice(1):n,once:t,capture:r,passive:e}}));function Wn(n,e){function t(){var n=t.fns;if(!o(n))return je(n,null,arguments,e,"v-on handler");for(var r=n.slice(),a=0;a<r.length;a++)je(r[a],null,arguments,e,"v-on handler")}return t.fns=n,t}function Hn(n,e,t,r,o,s){var l,c,p,d;for(l in n)c=n[l],p=e[l],d=$n(l),a(c)||(a(p)?(a(c.fns)&&(c=n[l]=Wn(c,s)),i(d.once)&&(c=n[l]=o(d.name,c,d.capture)),t(d.name,c,d.capture,d.passive,d.params)):c!==p&&(p.fns=c,n[l]=p));for(l in e)a(n[l])&&r((d=$n(l)).name,e[l],d.capture)}function Zn(n,e,t){var r;n instanceof gn&&(n=n.data.hook||(n.data.hook={}));var o=n[e];function l(){t.apply(this,arguments),k(r.fns,l)}a(o)?r=Wn([l]):s(o.fns)&&i(o.merged)?(r=o).fns.push(l):r=Wn([o,l]),r.merged=!0,n[e]=r}function Kn(n,e,t,r,o){if(s(e)){if(E(e,t))return n[t]=e[t],o||delete e[t],!0;if(E(e,r))return n[t]=e[r],o||delete e[r],!0}return!1}function Xn(n){return l(n)?[hn(n)]:o(n)?function n(e,t){var r,c,p,d,u=[];for(r=0;r<e.length;r++)a(c=e[r])||"boolean"==typeof c||(p=u.length-1,d=u[p],o(c)?c.length>0&&(Jn((c=n(c,"".concat(t||"","_").concat(r)))[0])&&Jn(d)&&(u[p]=hn(d.text+c[0].text),c.shift()),u.push.apply(u,c)):l(c)?Jn(d)?u[p]=hn(d.text+c):""!==c&&u.push(hn(c)):Jn(c)&&Jn(d)?u[p]=hn(d.text+c.text):(i(e._isVList)&&s(c.tag)&&a(c.key)&&s(t)&&(c.key="__vlist".concat(t,"_").concat(r,"__")),u.push(c)));return u}(n):void 0}function Jn(n){return s(n)&&s(n.text)&&!1===n.isComment}function Yn(n,e){var t,r,a,i,l=null;if(o(n)||"string"==typeof n)for(l=new Array(n.length),t=0,r=n.length;t<r;t++)l[t]=e(n[t],t);else if("number"==typeof n)for(l=new Array(n),t=0;t<n;t++)l[t]=e(t+1,t);else if(p(n))if(dn&&n[Symbol.iterator]){l=[];for(var c=n[Symbol.iterator](),d=c.next();!d.done;)l.push(e(d.value,l.length)),d=c.next()}else for(a=Object.keys(n),l=new Array(a.length),t=0,r=a.length;t<r;t++)i=a[t],l[t]=e(n[i],i,t);return s(l)||(l=[]),l._isVList=!0,l}function Qn(n,e,t,r){var o,a=this.$scopedSlots[n];a?(t=t||{},r&&(t=P(P({},r),t)),o=a(t)||(c(e)?e():e)):o=this.$slots[n]||(c(e)?e():e);var s=t&&t.slot;return s?this.$createElement("template",{slot:s},o):o}function ne(n){return St(this.$options,"filters",n,!0)||N}function ee(n,e){return o(n)?-1===n.indexOf(e):n!==e}function te(n,e,t,r,o){var a=G.keyCodes[e]||t;return o&&r&&!G.keyCodes[e]?ee(o,r):a?ee(a,n):r?T(r)!==e:void 0===n}function re(n,e,t,r,a){if(t)if(p(t)){o(t)&&(t=I(t));var s=void 0,i=function(o){if("class"===o||"style"===o||y(o))s=n;else{var i=n.attrs&&n.attrs.type;s=r||G.mustUseProp(e,i,o)?n.domProps||(n.domProps={}):n.attrs||(n.attrs={})}var l=B(o),c=T(o);l in s||c in s||(s[o]=t[o],a&&((n.on||(n.on={}))["update:".concat(o)]=function(n){t[o]=n}))};for(var l in t)i(l)}else;return n}function oe(n,e){var t=this._staticTrees||(this._staticTrees=[]),r=t[n];return r&&!e||se(r=t[n]=this.$options.staticRenderFns[n].call(this._renderProxy,this._c,this),"__static__".concat(n),!1),r}function ae(n,e,t){return se(n,"__once__".concat(e).concat(t?"_".concat(t):""),!0),n}function se(n,e,t){if(o(n))for(var r=0;r<n.length;r++)n[r]&&"string"!=typeof n[r]&&ie(n[r],"".concat(e,"_").concat(r),t);else ie(n,e,t)}function ie(n,e,t){n.isStatic=!0,n.key=e,n.isOnce=t}function le(n,e){if(e)if(u(e)){var t=n.on=n.on?P({},n.on):{};for(var r in e){var o=t[r],a=e[r];t[r]=o?[].concat(o,a):a}}else;return n}function ce(n,e,t,r){e=e||{$stable:!t};for(var a=0;a<n.length;a++){var s=n[a];o(s)?ce(s,e,t):s&&(s.proxy&&(s.fn.proxy=!0),e[s.key]=s.fn)}return r&&(e.$key=r),e}function pe(n,e){for(var t=0;t<e.length;t+=2){var r=e[t];"string"==typeof r&&r&&(n[e[t]]=e[t+1])}return n}function de(n,e){return"string"==typeof n?e+n:n}function ue(n){n._o=ae,n._n=b,n._s=h,n._l=Yn,n._t=Qn,n._q=O,n._i=R,n._m=oe,n._f=ne,n._k=te,n._b=re,n._v=hn,n._e=fn,n._u=ce,n._g=le,n._d=pe,n._p=de}function me(n,e){if(!n||!n.length)return{};for(var t={},r=0,o=n.length;r<o;r++){var a=n[r],s=a.data;if(s&&s.attrs&&s.attrs.slot&&delete s.attrs.slot,a.context!==e&&a.fnContext!==e||!s||null==s.slot)(t.default||(t.default=[])).push(a);else{var i=s.slot,l=t[i]||(t[i]=[]);"template"===a.tag?l.push.apply(l,a.children||[]):l.push(a)}}for(var c in t)t[c].every(ge)&&delete t[c];return t}function ge(n){return n.isComment&&!n.asyncFactory||" "===n.text}function fe(n){return n.isComment&&n.asyncFactory}function he(n,e,t,o){var a,s=Object.keys(t).length>0,i=e?!!e.$stable:!s,l=e&&e.$key;if(e){if(e._normalized)return e._normalized;if(i&&o&&o!==r&&l===o.$key&&!s&&!o.$hasNormal)return o;for(var c in a={},e)e[c]&&"$"!==c[0]&&(a[c]=ve(n,t,c,e[c]))}else a={};for(var p in t)p in a||(a[p]=be(t,p));return e&&Object.isExtensible(e)&&(e._normalized=a),W(a,"$stable",i),W(a,"$key",l),W(a,"$hasNormal",s),a}function ve(n,e,t,r){var a=function(){var e=un;mn(n);var t=arguments.length?r.apply(null,arguments):r({}),a=(t=t&&"object"==typeof t&&!o(t)?[t]:Xn(t))&&t[0];return mn(e),t&&(!a||1===t.length&&a.isComment&&!fe(a))?void 0:t};return r.proxy&&Object.defineProperty(e,t,{get:a,enumerable:!0,configurable:!0}),a}function be(n,e){return function(){return n[e]}}function _e(n){return{get attrs(){if(!n._attrsProxy){var e=n._attrsProxy={};W(e,"_v_attr_proxy",!0),ye(e,n.$attrs,r,n,"$attrs")}return n._attrsProxy},get listeners(){n._listenersProxy||ye(n._listenersProxy={},n.$listeners,r,n,"$listeners");return n._listenersProxy},get slots(){return function(n){n._slotsProxy||we(n._slotsProxy={},n.$scopedSlots);return n._slotsProxy}(n)},emit:C(n.$emit,n),expose:function(e){e&&Object.keys(e).forEach((function(t){return Un(n,e,t)}))}}}function ye(n,e,t,r,o){var a=!1;for(var s in e)s in n?e[s]!==t[s]&&(a=!0):(a=!0,ke(n,s,r,o));for(var s in n)s in e||(a=!0,delete n[s]);return a}function ke(n,e,t,r){Object.defineProperty(n,e,{enumerable:!0,configurable:!0,get:function(){return t[r][e]}})}function we(n,e){for(var t in e)n[t]=e[t];for(var t in n)t in e||delete n[t]}var Ee=null;function xe(n,e){return(n.__esModule||dn&&"Module"===n[Symbol.toStringTag])&&(n=n.default),p(n)?e.extend(n):n}function Ae(n){if(o(n))for(var e=0;e<n.length;e++){var t=n[e];if(s(t)&&(s(t.componentOptions)||fe(t)))return t}}function Be(n,e,t,r,d,u){return(o(t)||l(t))&&(d=r,r=t,t=void 0),i(u)&&(d=2),function(n,e,t,r,l){if(s(t)&&s(t.__ob__))return fn();s(t)&&s(t.is)&&(e=t.is);if(!e)return fn();0;o(r)&&c(r[0])&&((t=t||{}).scopedSlots={default:r[0]},r.length=0);2===l?r=Xn(r):1===l&&(r=function(n){for(var e=0;e<n.length;e++)if(o(n[e]))return Array.prototype.concat.apply([],n);return n}(r));var d,u;if("string"==typeof e){var m=void 0;u=n.$vnode&&n.$vnode.ns||G.getTagNamespace(e),d=G.isReservedTag(e)?new gn(G.parsePlatformTagName(e),t,r,void 0,void 0,n):t&&t.pre||!s(m=St(n.$options,"components",e))?new gn(e,t,r,void 0,void 0,n):kt(m,t,n,r,e)}else d=kt(e,t,n,r);return o(d)?d:s(d)?(s(u)&&function n(e,t,r){e.ns=t,"foreignObject"===e.tag&&(t=void 0,r=!0);if(s(e.children))for(var o=0,l=e.children.length;o<l;o++){var c=e.children[o];s(c.tag)&&(a(c.ns)||i(r)&&"svg"!==c.tag)&&n(c,t,r)}}(d,u),s(t)&&function(n){p(n.style)&&Ge(n.style);p(n.class)&&Ge(n.class)}(t),d):fn()}(n,e,t,r,d)}function ze(n,e,t){wn();try{if(e)for(var r=e;r=r.$parent;){var o=r.$options.errorCaptured;if(o)for(var a=0;a<o.length;a++)try{if(!1===o[a].call(r,n,e,t))return}catch(n){Te(n,r,"errorCaptured hook")}}Te(n,e,t)}finally{En()}}function je(n,e,t,r,o){var a;try{(a=t?n.apply(e,t):n.call(e))&&!a._isVue&&f(a)&&!a._handled&&(a.catch((function(n){return ze(n,r,o+" (Promise/async)")})),a._handled=!0)}catch(n){ze(n,r,o)}return a}function Te(n,e,t){if(G.errorHandler)try{return G.errorHandler.call(null,n,e,t)}catch(e){e!==n&&Ce(e,null,"config.errorHandler")}Ce(n,e,t)}function Ce(n,e,t){if(!K||"undefined"==typeof console)throw n;console.error(n)}var Se,Pe=!1,Ie=[],qe=!1;function De(){qe=!1;var n=Ie.slice(0);Ie.length=0;for(var e=0;e<n.length;e++)n[e]()}if("undefined"!=typeof Promise&&cn(Promise)){var Ne=Promise.resolve();Se=function(){Ne.then(De),nn&&setTimeout(q)},Pe=!0}else if(J||"undefined"==typeof MutationObserver||!cn(MutationObserver)&&"[object MutationObserverConstructor]"!==MutationObserver.toString())Se="undefined"!=typeof setImmediate&&cn(setImmediate)?function(){setImmediate(De)}:function(){setTimeout(De,0)};else{var Oe=1,Re=new MutationObserver(De),Fe=document.createTextNode(String(Oe));Re.observe(Fe,{characterData:!0}),Se=function(){Oe=(Oe+1)%2,Fe.data=String(Oe)},Pe=!0}function Le(n,e){var t;if(Ie.push((function(){if(n)try{n.call(e)}catch(n){ze(n,e,"nextTick")}else t&&t(e)})),qe||(qe=!0,Se()),!n&&"undefined"!=typeof Promise)return new Promise((function(n){t=n}))}function Ue(n){return function(e,t){if(void 0===t&&(t=un),t)return function(n,e,t){var r=n.$options;r[e]=zt(r[e],t)}(t,n,e)}}Ue("beforeMount"),Ue("mounted"),Ue("beforeUpdate"),Ue("updated"),Ue("beforeDestroy"),Ue("destroyed"),Ue("activated"),Ue("deactivated"),Ue("serverPrefetch"),Ue("renderTracked"),Ue("renderTriggered"),Ue("errorCaptured");var Me=new pn;function Ge(n){return function n(e,t){var r,a,s=o(e);if(!s&&!p(e)||e.__v_skip||Object.isFrozen(e)||e instanceof gn)return;if(e.__ob__){var i=e.__ob__.dep.id;if(t.has(i))return;t.add(i)}if(s)for(r=e.length;r--;)n(e[r],t);else if(Ln(e))n(e.value,t);else for(a=Object.keys(e),r=a.length;r--;)n(e[a[r]],t)}(n,Me),Me.clear(),n}var Ve,$e=0,We=function(){function n(n,e,t,r,o){var a,s;a=this,void 0===(s=Mn&&!Mn._vm?Mn:n?n._scope:void 0)&&(s=Mn),s&&s.active&&s.effects.push(a),(this.vm=n)&&o&&(n._watcher=this),r?(this.deep=!!r.deep,this.user=!!r.user,this.lazy=!!r.lazy,this.sync=!!r.sync,this.before=r.before):this.deep=this.user=this.lazy=this.sync=!1,this.cb=t,this.id=++$e,this.active=!0,this.post=!1,this.dirty=this.lazy,this.deps=[],this.newDeps=[],this.depIds=new pn,this.newDepIds=new pn,this.expression="",c(e)?this.getter=e:(this.getter=function(n){if(!H.test(n)){var e=n.split(".");return function(n){for(var t=0;t<e.length;t++){if(!n)return;n=n[e[t]]}return n}}}(e),this.getter||(this.getter=q)),this.value=this.lazy?void 0:this.get()}return n.prototype.get=function(){var n;wn(this);var e=this.vm;try{n=this.getter.call(e,e)}catch(n){if(!this.user)throw n;ze(n,e,'getter for watcher "'.concat(this.expression,'"'))}finally{this.deep&&Ge(n),En(),this.cleanupDeps()}return n},n.prototype.addDep=function(n){var e=n.id;this.newDepIds.has(e)||(this.newDepIds.add(e),this.newDeps.push(n),this.depIds.has(e)||n.addSub(this))},n.prototype.cleanupDeps=function(){for(var n=this.deps.length;n--;){var e=this.deps[n];this.newDepIds.has(e.id)||e.removeSub(this)}var t=this.depIds;this.depIds=this.newDepIds,this.newDepIds=t,this.newDepIds.clear(),t=this.deps,this.deps=this.newDeps,this.newDeps=t,this.newDeps.length=0},n.prototype.update=function(){this.lazy?this.dirty=!0:this.sync?this.run():mt(this)},n.prototype.run=function(){if(this.active){var n=this.get();if(n!==this.value||p(n)||this.deep){var e=this.value;if(this.value=n,this.user){var t='callback for watcher "'.concat(this.expression,'"');je(this.cb,this.vm,[n,e],this.vm,t)}else this.cb.call(this.vm,n,e)}}},n.prototype.evaluate=function(){this.value=this.get(),this.dirty=!1},n.prototype.depend=function(){for(var n=this.deps.length;n--;)this.deps[n].depend()},n.prototype.teardown=function(){if(this.vm&&!this.vm._isBeingDestroyed&&k(this.vm._scope.effects,this),this.active){for(var n=this.deps.length;n--;)this.deps[n].removeSub(this);this.active=!1,this.onStop&&this.onStop()}},n}();function He(n,e){Ve.$on(n,e)}function Ze(n,e){Ve.$off(n,e)}function Ke(n,e){var t=Ve;return function r(){var o=e.apply(null,arguments);null!==o&&t.$off(n,r)}}function Xe(n,e,t){Ve=n,Hn(e,t||{},He,Ze,Ke,n),Ve=void 0}var Je=null;function Ye(n){var e=Je;return Je=n,function(){Je=e}}function Qe(n){for(;n&&(n=n.$parent);)if(n._inactive)return!0;return!1}function nt(n,e){if(e){if(n._directInactive=!1,Qe(n))return}else if(n._directInactive)return;if(n._inactive||null===n._inactive){n._inactive=!1;for(var t=0;t<n.$children.length;t++)nt(n.$children[t]);et(n,"activated")}}function et(n,e,t,r){void 0===r&&(r=!0),wn();var o=un,a=Mn;r&&mn(n);var s=n.$options[e],i="".concat(e," hook");if(s)for(var l=0,c=s.length;l<c;l++)je(s[l],n,t||null,n,i);n._hasHookEvent&&n.$emit("hook:"+e),r&&(mn(o),a&&a.on()),En()}var tt=[],rt=[],ot={},at=!1,st=!1,it=0;var lt=0,ct=Date.now;if(K&&!J){var pt=window.performance;pt&&"function"==typeof pt.now&&ct()>document.createEvent("Event").timeStamp&&(ct=function(){return pt.now()})}var dt=function(n,e){if(n.post){if(!e.post)return 1}else if(e.post)return-1;return n.id-e.id};function ut(){var n,e;for(lt=ct(),st=!0,tt.sort(dt),it=0;it<tt.length;it++)(n=tt[it]).before&&n.before(),e=n.id,ot[e]=null,n.run();var t=rt.slice(),r=tt.slice();it=tt.length=rt.length=0,ot={},at=st=!1,function(n){for(var e=0;e<n.length;e++)n[e]._inactive=!0,nt(n[e],!0)}(t),function(n){var e=n.length;for(;e--;){var t=n[e],r=t.vm;r&&r._watcher===t&&r._isMounted&&!r._isDestroyed&&et(r,"updated")}}(r),function(){for(var n=0;n<_n.length;n++){var e=_n[n];e.subs=e.subs.filter((function(n){return n})),e._pending=!1}_n.length=0}(),ln&&G.devtools&&ln.emit("flush")}function mt(n){var e=n.id;if(null==ot[e]&&(n!==yn.target||!n.noRecurse)){if(ot[e]=!0,st){for(var t=tt.length-1;t>it&&tt[t].id>n.id;)t--;tt.splice(t+1,0,n)}else tt.push(n);at||(at=!0,Le(ut))}}function gt(n,e){if(n){for(var t=Object.create(null),r=dn?Reflect.ownKeys(n):Object.keys(n),o=0;o<r.length;o++){var a=r[o];if("__ob__"!==a){var s=n[a].from;if(s in e._provided)t[a]=e._provided[s];else if("default"in n[a]){var i=n[a].default;t[a]=c(i)?i.call(e):i}else 0}}return t}}function ft(n,e,t,a,s){var l,c=this,p=s.options;E(a,"_uid")?(l=Object.create(a))._original=a:(l=a,a=a._original);var d=i(p._compiled),u=!d;this.data=n,this.props=e,this.children=t,this.parent=a,this.listeners=n.on||r,this.injections=gt(p.inject,a),this.slots=function(){return c.$slots||he(a,n.scopedSlots,c.$slots=me(t,a)),c.$slots},Object.defineProperty(this,"scopedSlots",{enumerable:!0,get:function(){return he(a,n.scopedSlots,this.slots())}}),d&&(this.$options=p,this.$slots=this.slots(),this.$scopedSlots=he(a,n.scopedSlots,this.$slots)),p._scopeId?this._c=function(n,e,t,r){var s=Be(l,n,e,t,r,u);return s&&!o(s)&&(s.fnScopeId=p._scopeId,s.fnContext=a),s}:this._c=function(n,e,t,r){return Be(l,n,e,t,r,u)}}function ht(n,e,t,r,o){var a=vn(n);return a.fnContext=t,a.fnOptions=r,e.slot&&((a.data||(a.data={})).slot=e.slot),a}function vt(n,e){for(var t in e)n[B(t)]=e[t]}function bt(n){return n.name||n.__name||n._componentTag}ue(ft.prototype);var _t={init:function(n,e){if(n.componentInstance&&!n.componentInstance._isDestroyed&&n.data.keepAlive){var t=n;_t.prepatch(t,t)}else{(n.componentInstance=function(n,e){var t={_isComponent:!0,_parentVnode:n,parent:e},r=n.data.inlineTemplate;s(r)&&(t.render=r.render,t.staticRenderFns=r.staticRenderFns);return new n.componentOptions.Ctor(t)}(n,Je)).$mount(e?n.elm:void 0,e)}},prepatch:function(n,e){var t=e.componentOptions;!function(n,e,t,o,a){var s=o.data.scopedSlots,i=n.$scopedSlots,l=!!(s&&!s.$stable||i!==r&&!i.$stable||s&&n.$scopedSlots.$key!==s.$key||!s&&n.$scopedSlots.$key),c=!!(a||n.$options._renderChildren||l),p=n.$vnode;n.$options._parentVnode=o,n.$vnode=o,n._vnode&&(n._vnode.parent=o),n.$options._renderChildren=a;var d=o.data.attrs||r;n._attrsProxy&&ye(n._attrsProxy,d,p.data&&p.data.attrs||r,n,"$attrs")&&(c=!0),n.$attrs=d,t=t||r;var u=n.$options._parentListeners;if(n._listenersProxy&&ye(n._listenersProxy,t,u||r,n,"$listeners"),n.$listeners=n.$options._parentListeners=t,Xe(n,t,u),e&&n.$options.props){Tn(!1);for(var m=n._props,g=n.$options._propKeys||[],f=0;f<g.length;f++){var h=g[f],v=n.$options.props;m[h]=Pt(h,v,e,n)}Tn(!0),n.$options.propsData=e}c&&(n.$slots=me(a,o.context),n.$forceUpdate())}(e.componentInstance=n.componentInstance,t.propsData,t.listeners,e,t.children)},insert:function(n){var e,t=n.context,r=n.componentInstance;r._isMounted||(r._isMounted=!0,et(r,"mounted")),n.data.keepAlive&&(t._isMounted?((e=r)._inactive=!1,rt.push(e)):nt(r,!0))},destroy:function(n){var e=n.componentInstance;e._isDestroyed||(n.data.keepAlive?function n(e,t){if(!(t&&(e._directInactive=!0,Qe(e))||e._inactive)){e._inactive=!0;for(var r=0;r<e.$children.length;r++)n(e.$children[r]);et(e,"deactivated")}}(e,!0):e.$destroy())}},yt=Object.keys(_t);function kt(n,e,t,l,c){if(!a(n)){var d=t.$options._base;if(p(n)&&(n=d.extend(n)),"function"==typeof n){var u;if(a(n.cid)&&void 0===(n=function(n,e){if(i(n.error)&&s(n.errorComp))return n.errorComp;if(s(n.resolved))return n.resolved;var t=Ee;if(t&&s(n.owners)&&-1===n.owners.indexOf(t)&&n.owners.push(t),i(n.loading)&&s(n.loadingComp))return n.loadingComp;if(t&&!s(n.owners)){var r=n.owners=[t],o=!0,l=null,c=null;t.$on("hook:destroyed",(function(){return k(r,t)}));var d=function(n){for(var e=0,t=r.length;e<t;e++)r[e].$forceUpdate();n&&(r.length=0,null!==l&&(clearTimeout(l),l=null),null!==c&&(clearTimeout(c),c=null))},u=F((function(t){n.resolved=xe(t,e),o?r.length=0:d(!0)})),m=F((function(e){s(n.errorComp)&&(n.error=!0,d(!0))})),g=n(u,m);return p(g)&&(f(g)?a(n.resolved)&&g.then(u,m):f(g.component)&&(g.component.then(u,m),s(g.error)&&(n.errorComp=xe(g.error,e)),s(g.loading)&&(n.loadingComp=xe(g.loading,e),0===g.delay?n.loading=!0:l=setTimeout((function(){l=null,a(n.resolved)&&a(n.error)&&(n.loading=!0,d(!1))}),g.delay||200)),s(g.timeout)&&(c=setTimeout((function(){c=null,a(n.resolved)&&m(null)}),g.timeout)))),o=!1,n.loading?n.loadingComp:n.resolved}}(u=n,d)))return function(n,e,t,r,o){var a=fn();return a.asyncFactory=n,a.asyncMeta={data:e,context:t,children:r,tag:o},a}(u,e,t,l,c);e=e||{},Wt(n),s(e.model)&&function(n,e){var t=n.model&&n.model.prop||"value",r=n.model&&n.model.event||"input";(e.attrs||(e.attrs={}))[t]=e.model.value;var a=e.on||(e.on={}),i=a[r],l=e.model.callback;s(i)?(o(i)?-1===i.indexOf(l):i!==l)&&(a[r]=[l].concat(i)):a[r]=l}(n.options,e);var m=function(n,e,t){var r=e.options.props;if(!a(r)){var o={},i=n.attrs,l=n.props;if(s(i)||s(l))for(var c in r){var p=T(c);Kn(o,l,c,p,!0)||Kn(o,i,c,p,!1)}return o}}(e,n);if(i(n.options.functional))return function(n,e,t,a,i){var l=n.options,c={},p=l.props;if(s(p))for(var d in p)c[d]=Pt(d,p,e||r);else s(t.attrs)&&vt(c,t.attrs),s(t.props)&&vt(c,t.props);var u=new ft(t,c,i,a,n),m=l.render.call(null,u._c,u);if(m instanceof gn)return ht(m,t,u.parent,l,u);if(o(m)){for(var g=Xn(m)||[],f=new Array(g.length),h=0;h<g.length;h++)f[h]=ht(g[h],t,u.parent,l,u);return f}}(n,m,e,t,l);var g=e.on;if(e.on=e.nativeOn,i(n.options.abstract)){var h=e.slot;e={},h&&(e.slot=h)}!function(n){for(var e=n.hook||(n.hook={}),t=0;t<yt.length;t++){var r=yt[t],o=e[r],a=_t[r];o===a||o&&o._merged||(e[r]=o?wt(a,o):a)}}(e);var v=bt(n.options)||c;return new gn("vue-component-".concat(n.cid).concat(v?"-".concat(v):""),e,void 0,void 0,void 0,t,{Ctor:n,propsData:m,listeners:g,tag:c,children:l},u)}}}function wt(n,e){var t=function(t,r){n(t,r),e(t,r)};return t._merged=!0,t}var Et=q,xt=G.optionMergeStrategies;function At(n,e,t){if(void 0===t&&(t=!0),!e)return n;for(var r,o,a,s=dn?Reflect.ownKeys(e):Object.keys(e),i=0;i<s.length;i++)"__ob__"!==(r=s[i])&&(o=n[r],a=e[r],t&&E(n,r)?o!==a&&u(o)&&u(a)&&At(o,a):qn(n,r,a));return n}function Bt(n,e,t){return t?function(){var r=c(e)?e.call(t,t):e,o=c(n)?n.call(t,t):n;return r?At(r,o):o}:e?n?function(){return At(c(e)?e.call(this,this):e,c(n)?n.call(this,this):n)}:e:n}function zt(n,e){var t=e?n?n.concat(e):o(e)?e:[e]:n;return t?function(n){for(var e=[],t=0;t<n.length;t++)-1===e.indexOf(n[t])&&e.push(n[t]);return e}(t):t}function jt(n,e,t,r){var o=Object.create(n||null);return e?P(o,e):o}xt.data=function(n,e,t){return t?Bt(n,e,t):e&&"function"!=typeof e?n:Bt(n,e)},M.forEach((function(n){xt[n]=zt})),U.forEach((function(n){xt[n+"s"]=jt})),xt.watch=function(n,e,t,r){if(n===rn&&(n=void 0),e===rn&&(e=void 0),!e)return Object.create(n||null);if(!n)return e;var a={};for(var s in P(a,n),e){var i=a[s],l=e[s];i&&!o(i)&&(i=[i]),a[s]=i?i.concat(l):o(l)?l:[l]}return a},xt.props=xt.methods=xt.inject=xt.computed=function(n,e,t,r){if(!n)return e;var o=Object.create(null);return P(o,n),e&&P(o,e),o},xt.provide=function(n,e){return n?function(){var t=Object.create(null);return At(t,c(n)?n.call(this):n),e&&At(t,c(e)?e.call(this):e,!1),t}:e};var Tt=function(n,e){return void 0===e?n:e};function Ct(n,e,t){if(c(e)&&(e=e.options),function(n,e){var t=n.props;if(t){var r,a,s={};if(o(t))for(r=t.length;r--;)"string"==typeof(a=t[r])&&(s[B(a)]={type:null});else if(u(t))for(var i in t)a=t[i],s[B(i)]=u(a)?a:{type:a};else 0;n.props=s}}(e),function(n,e){var t=n.inject;if(t){var r=n.inject={};if(o(t))for(var a=0;a<t.length;a++)r[t[a]]={from:t[a]};else if(u(t))for(var s in t){var i=t[s];r[s]=u(i)?P({from:s},i):{from:i}}else 0}}(e),function(n){var e=n.directives;if(e)for(var t in e){var r=e[t];c(r)&&(e[t]={bind:r,update:r})}}(e),!e._base&&(e.extends&&(n=Ct(n,e.extends,t)),e.mixins))for(var r=0,a=e.mixins.length;r<a;r++)n=Ct(n,e.mixins[r],t);var s,i={};for(s in n)l(s);for(s in e)E(n,s)||l(s);function l(r){var o=xt[r]||Tt;i[r]=o(n[r],e[r],t,r)}return i}function St(n,e,t,r){if("string"==typeof t){var o=n[e];if(E(o,t))return o[t];var a=B(t);if(E(o,a))return o[a];var s=z(a);return E(o,s)?o[s]:o[t]||o[a]||o[s]}}function Pt(n,e,t,r){var o=e[n],a=!E(t,n),s=t[n],i=Nt(Boolean,o.type);if(i>-1)if(a&&!E(o,"default"))s=!1;else if(""===s||s===T(n)){var l=Nt(String,o.type);(l<0||i<l)&&(s=!0)}if(void 0===s){s=function(n,e,t){if(!E(e,"default"))return;var r=e.default;0;if(n&&n.$options.propsData&&void 0===n.$options.propsData[t]&&void 0!==n._props[t])return n._props[t];return c(r)&&"Function"!==qt(e.type)?r.call(n):r}(r,o,n);var p=jn;Tn(!0),Pn(s),Tn(p)}return s}var It=/^\s*function (\w+)/;function qt(n){var e=n&&n.toString().match(It);return e?e[1]:""}function Dt(n,e){return qt(n)===qt(e)}function Nt(n,e){if(!o(e))return Dt(e,n)?0:-1;for(var t=0,r=e.length;t<r;t++)if(Dt(e[t],n))return t;return-1}var Ot={enumerable:!0,configurable:!0,get:q,set:q};function Rt(n,e,t){Ot.get=function(){return this[e][t]},Ot.set=function(n){this[e][t]=n},Object.defineProperty(n,t,Ot)}function Ft(n){var e=n.$options;if(e.props&&function(n,e){var t=n.$options.propsData||{},r=n._props=On({}),o=n.$options._propKeys=[];n.$parent&&Tn(!1);var a=function(a){o.push(a);var s=Pt(a,e,t,n);In(r,a,s,void 0,!0),a in n||Rt(n,"_props",a)};for(var s in e)a(s);Tn(!0)}(n,e.props),function(n){var e=n.$options,t=e.setup;if(t){var r=n._setupContext=_e(n);mn(n),wn();var o=je(t,null,[n._props||On({}),r],n,"setup");if(En(),mn(),c(o))e.render=o;else if(p(o))if(n._setupState=o,o.__sfc){var a=n._setupProxy={};for(var s in o)"__sfc"!==s&&Un(a,o,s)}else for(var s in o)$(s)||Un(n,o,s);else 0}}(n),e.methods&&function(n,e){n.$options.props;for(var t in e)n[t]="function"!=typeof e[t]?q:C(e[t],n)}(n,e.methods),e.data)!function(n){var e=n.$options.data;u(e=n._data=c(e)?function(n,e){wn();try{return n.call(e,e)}catch(n){return ze(n,e,"data()"),{}}finally{En()}}(e,n):e||{})||(e={});var t=Object.keys(e),r=n.$options.props,o=(n.$options.methods,t.length);for(;o--;){var a=t[o];0,r&&E(r,a)||$(a)||Rt(n,"_data",a)}var s=Pn(e);s&&s.vmCount++}(n);else{var t=Pn(n._data={});t&&t.vmCount++}e.computed&&function(n,e){var t=n._computedWatchers=Object.create(null),r=sn();for(var o in e){var a=e[o],s=c(a)?a:a.get;0,r||(t[o]=new We(n,s||q,q,Lt)),o in n||Ut(n,o,a)}}(n,e.computed),e.watch&&e.watch!==rn&&function(n,e){for(var t in e){var r=e[t];if(o(r))for(var a=0;a<r.length;a++)Vt(n,t,r[a]);else Vt(n,t,r)}}(n,e.watch)}var Lt={lazy:!0};function Ut(n,e,t){var r=!sn();c(t)?(Ot.get=r?Mt(e):Gt(t),Ot.set=q):(Ot.get=t.get?r&&!1!==t.cache?Mt(e):Gt(t.get):q,Ot.set=t.set||q),Object.defineProperty(n,e,Ot)}function Mt(n){return function(){var e=this._computedWatchers&&this._computedWatchers[n];if(e)return e.dirty&&e.evaluate(),yn.target&&e.depend(),e.value}}function Gt(n){return function(){return n.call(this,this)}}function Vt(n,e,t,r){return u(t)&&(r=t,t=t.handler),"string"==typeof t&&(t=n[t]),n.$watch(e,t,r)}var $t=0;function Wt(n){var e=n.options;if(n.super){var t=Wt(n.super);if(t!==n.superOptions){n.superOptions=t;var r=function(n){var e,t=n.options,r=n.sealedOptions;for(var o in t)t[o]!==r[o]&&(e||(e={}),e[o]=t[o]);return e}(n);r&&P(n.extendOptions,r),(e=n.options=Ct(t,n.extendOptions)).name&&(e.components[e.name]=n)}}return e}function Ht(n){this._init(n)}function Zt(n){n.cid=0;var e=1;n.extend=function(n){n=n||{};var t=this,r=t.cid,o=n._Ctor||(n._Ctor={});if(o[r])return o[r];var a=bt(n)||bt(t.options);var s=function(n){this._init(n)};return(s.prototype=Object.create(t.prototype)).constructor=s,s.cid=e++,s.options=Ct(t.options,n),s.super=t,s.options.props&&function(n){var e=n.options.props;for(var t in e)Rt(n.prototype,"_props",t)}(s),s.options.computed&&function(n){var e=n.options.computed;for(var t in e)Ut(n.prototype,t,e[t])}(s),s.extend=t.extend,s.mixin=t.mixin,s.use=t.use,U.forEach((function(n){s[n]=t[n]})),a&&(s.options.components[a]=s),s.superOptions=t.options,s.extendOptions=n,s.sealedOptions=P({},s.options),o[r]=s,s}}function Kt(n){return n&&(bt(n.Ctor.options)||n.tag)}function Xt(n,e){return o(n)?n.indexOf(e)>-1:"string"==typeof n?n.split(",").indexOf(e)>-1:!!m(n)&&n.test(e)}function Jt(n,e){var t=n.cache,r=n.keys,o=n._vnode,a=n.$vnode;for(var s in t){var i=t[s];if(i){var l=i.name;l&&!e(l)&&Yt(t,s,r,o)}}a.componentOptions.children=void 0}function Yt(n,e,t,r){var o=n[e];!o||r&&o.tag===r.tag||o.componentInstance.$destroy(),n[e]=null,k(t,e)}!function(n){n.prototype._init=function(n){var e=this;e._uid=$t++,e._isVue=!0,e.__v_skip=!0,e._scope=new Gn(!0),e._scope.parent=void 0,e._scope._vm=!0,n&&n._isComponent?function(n,e){var t=n.$options=Object.create(n.constructor.options),r=e._parentVnode;t.parent=e.parent,t._parentVnode=r;var o=r.componentOptions;t.propsData=o.propsData,t._parentListeners=o.listeners,t._renderChildren=o.children,t._componentTag=o.tag,e.render&&(t.render=e.render,t.staticRenderFns=e.staticRenderFns)}(e,n):e.$options=Ct(Wt(e.constructor),n||{},e),e._renderProxy=e,e._self=e,function(n){var e=n.$options,t=e.parent;if(t&&!e.abstract){for(;t.$options.abstract&&t.$parent;)t=t.$parent;t.$children.push(n)}n.$parent=t,n.$root=t?t.$root:n,n.$children=[],n.$refs={},n._provided=t?t._provided:Object.create(null),n._watcher=null,n._inactive=null,n._directInactive=!1,n._isMounted=!1,n._isDestroyed=!1,n._isBeingDestroyed=!1}(e),function(n){n._events=Object.create(null),n._hasHookEvent=!1;var e=n.$options._parentListeners;e&&Xe(n,e)}(e),function(n){n._vnode=null,n._staticTrees=null;var e=n.$options,t=n.$vnode=e._parentVnode,o=t&&t.context;n.$slots=me(e._renderChildren,o),n.$scopedSlots=t?he(n.$parent,t.data.scopedSlots,n.$slots):r,n._c=function(e,t,r,o){return Be(n,e,t,r,o,!1)},n.$createElement=function(e,t,r,o){return Be(n,e,t,r,o,!0)};var a=t&&t.data;In(n,"$attrs",a&&a.attrs||r,null,!0),In(n,"$listeners",e._parentListeners||r,null,!0)}(e),et(e,"beforeCreate",void 0,!1),function(n){var e=gt(n.$options.inject,n);e&&(Tn(!1),Object.keys(e).forEach((function(t){In(n,t,e[t])})),Tn(!0))}(e),Ft(e),function(n){var e=n.$options.provide;if(e){var t=c(e)?e.call(n):e;if(!p(t))return;for(var r=Vn(n),o=dn?Reflect.ownKeys(t):Object.keys(t),a=0;a<o.length;a++){var s=o[a];Object.defineProperty(r,s,Object.getOwnPropertyDescriptor(t,s))}}}(e),et(e,"created"),e.$options.el&&e.$mount(e.$options.el)}}(Ht),function(n){var e={get:function(){return this._data}},t={get:function(){return this._props}};Object.defineProperty(n.prototype,"$data",e),Object.defineProperty(n.prototype,"$props",t),n.prototype.$set=qn,n.prototype.$delete=Dn,n.prototype.$watch=function(n,e,t){if(u(e))return Vt(this,n,e,t);(t=t||{}).user=!0;var r=new We(this,n,e,t);if(t.immediate){var o='callback for immediate watcher "'.concat(r.expression,'"');wn(),je(e,this,[r.value],this,o),En()}return function(){r.teardown()}}}(Ht),function(n){var e=/^hook:/;n.prototype.$on=function(n,t){var r=this;if(o(n))for(var a=0,s=n.length;a<s;a++)r.$on(n[a],t);else(r._events[n]||(r._events[n]=[])).push(t),e.test(n)&&(r._hasHookEvent=!0);return r},n.prototype.$once=function(n,e){var t=this;function r(){t.$off(n,r),e.apply(t,arguments)}return r.fn=e,t.$on(n,r),t},n.prototype.$off=function(n,e){var t=this;if(!arguments.length)return t._events=Object.create(null),t;if(o(n)){for(var r=0,a=n.length;r<a;r++)t.$off(n[r],e);return t}var s,i=t._events[n];if(!i)return t;if(!e)return t._events[n]=null,t;for(var l=i.length;l--;)if((s=i[l])===e||s.fn===e){i.splice(l,1);break}return t},n.prototype.$emit=function(n){var e=this,t=e._events[n];if(t){t=t.length>1?S(t):t;for(var r=S(arguments,1),o='event handler for "'.concat(n,'"'),a=0,s=t.length;a<s;a++)je(t[a],e,r,e,o)}return e}}(Ht),function(n){n.prototype._update=function(n,e){var t=this,r=t.$el,o=t._vnode,a=Ye(t);t._vnode=n,t.$el=o?t.__patch__(o,n):t.__patch__(t.$el,n,e,!1),a(),r&&(r.__vue__=null),t.$el&&(t.$el.__vue__=t);for(var s=t;s&&s.$vnode&&s.$parent&&s.$vnode===s.$parent._vnode;)s.$parent.$el=s.$el,s=s.$parent},n.prototype.$forceUpdate=function(){this._watcher&&this._watcher.update()},n.prototype.$destroy=function(){var n=this;if(!n._isBeingDestroyed){et(n,"beforeDestroy"),n._isBeingDestroyed=!0;var e=n.$parent;!e||e._isBeingDestroyed||n.$options.abstract||k(e.$children,n),n._scope.stop(),n._data.__ob__&&n._data.__ob__.vmCount--,n._isDestroyed=!0,n.__patch__(n._vnode,null),et(n,"destroyed"),n.$off(),n.$el&&(n.$el.__vue__=null),n.$vnode&&(n.$vnode.parent=null)}}}(Ht),function(n){ue(n.prototype),n.prototype.$nextTick=function(n){return Le(n,this)},n.prototype._render=function(){var n=this,e=n.$options,t=e.render,r=e._parentVnode;r&&n._isMounted&&(n.$scopedSlots=he(n.$parent,r.data.scopedSlots,n.$slots,n.$scopedSlots),n._slotsProxy&&we(n._slotsProxy,n.$scopedSlots)),n.$vnode=r;var a,s=un,i=Ee;try{mn(n),Ee=n,a=t.call(n._renderProxy,n.$createElement)}catch(e){ze(e,n,"render"),a=n._vnode}finally{Ee=i,mn(s)}return o(a)&&1===a.length&&(a=a[0]),a instanceof gn||(a=fn()),a.parent=r,a}}(Ht);var Qt=[String,RegExp,Array],nr={KeepAlive:{name:"keep-alive",abstract:!0,props:{include:Qt,exclude:Qt,max:[String,Number]},methods:{cacheVNode:function(){var n=this.cache,e=this.keys,t=this.vnodeToCache,r=this.keyToCache;if(t){var o=t.tag,a=t.componentInstance,s=t.componentOptions;n[r]={name:Kt(s),tag:o,componentInstance:a},e.push(r),this.max&&e.length>parseInt(this.max)&&Yt(n,e[0],e,this._vnode),this.vnodeToCache=null}}},created:function(){this.cache=Object.create(null),this.keys=[]},destroyed:function(){for(var n in this.cache)Yt(this.cache,n,this.keys)},mounted:function(){var n=this;this.cacheVNode(),this.$watch("include",(function(e){Jt(n,(function(n){return Xt(e,n)}))})),this.$watch("exclude",(function(e){Jt(n,(function(n){return!Xt(e,n)}))}))},updated:function(){this.cacheVNode()},render:function(){var n=this.$slots.default,e=Ae(n),t=e&&e.componentOptions;if(t){var r=Kt(t),o=this.include,a=this.exclude;if(o&&(!r||!Xt(o,r))||a&&r&&Xt(a,r))return e;var s=this.cache,i=this.keys,l=null==e.key?t.Ctor.cid+(t.tag?"::".concat(t.tag):""):e.key;s[l]?(e.componentInstance=s[l].componentInstance,k(i,l),i.push(l)):(this.vnodeToCache=e,this.keyToCache=l),e.data.keepAlive=!0}return e||n&&n[0]}}};!function(n){var e={get:function(){return G}};Object.defineProperty(n,"config",e),n.util={warn:Et,extend:P,mergeOptions:Ct,defineReactive:In},n.set=qn,n.delete=Dn,n.nextTick=Le,n.observable=function(n){return Pn(n),n},n.options=Object.create(null),U.forEach((function(e){n.options[e+"s"]=Object.create(null)})),n.options._base=n,P(n.options.components,nr),function(n){n.use=function(n){var e=this._installedPlugins||(this._installedPlugins=[]);if(e.indexOf(n)>-1)return this;var t=S(arguments,1);return t.unshift(this),c(n.install)?n.install.apply(n,t):c(n)&&n.apply(null,t),e.push(n),this}}(n),function(n){n.mixin=function(n){return this.options=Ct(this.options,n),this}}(n),Zt(n),function(n){U.forEach((function(e){n[e]=function(n,t){return t?("component"===e&&u(t)&&(t.name=t.name||n,t=this.options._base.extend(t)),"directive"===e&&c(t)&&(t={bind:t,update:t}),this.options[e+"s"][n]=t,t):this.options[e+"s"][n]}}))}(n)}(Ht),Object.defineProperty(Ht.prototype,"$isServer",{get:sn}),Object.defineProperty(Ht.prototype,"$ssrContext",{get:function(){return this.$vnode&&this.$vnode.ssrContext}}),Object.defineProperty(Ht,"FunctionalRenderContext",{value:ft}),Ht.version="2.7.16";var er=_("style,class"),tr=_("input,textarea,option,select,progress"),rr=_("contenteditable,draggable,spellcheck"),or=_("events,caret,typing,plaintext-only"),ar=_("allowfullscreen,async,autofocus,autoplay,checked,compact,controls,declare,default,defaultchecked,defaultmuted,defaultselected,defer,disabled,enabled,formnovalidate,hidden,indeterminate,inert,ismap,itemscope,loop,multiple,muted,nohref,noresize,noshade,novalidate,nowrap,open,pauseonexit,readonly,required,reversed,scoped,seamless,selected,sortable,truespeed,typemustmatch,visible"),sr="http://www.w3.org/1999/xlink",ir=function(n){return":"===n.charAt(5)&&"xlink"===n.slice(0,5)},lr=function(n){return ir(n)?n.slice(6,n.length):""},cr=function(n){return null==n||!1===n};function pr(n){for(var e=n.data,t=n,r=n;s(r.componentInstance);)(r=r.componentInstance._vnode)&&r.data&&(e=dr(r.data,e));for(;s(t=t.parent);)t&&t.data&&(e=dr(e,t.data));return function(n,e){if(s(n)||s(e))return ur(n,mr(e));return""}(e.staticClass,e.class)}function dr(n,e){return{staticClass:ur(n.staticClass,e.staticClass),class:s(n.class)?[n.class,e.class]:e.class}}function ur(n,e){return n?e?n+" "+e:n:e||""}function mr(n){return Array.isArray(n)?function(n){for(var e,t="",r=0,o=n.length;r<o;r++)s(e=mr(n[r]))&&""!==e&&(t&&(t+=" "),t+=e);return t}(n):p(n)?function(n){var e="";for(var t in n)n[t]&&(e&&(e+=" "),e+=t);return e}(n):"string"==typeof n?n:""}var gr={svg:"http://www.w3.org/2000/svg",math:"http://www.w3.org/1998/Math/MathML"},fr=_("html,body,base,head,link,meta,style,title,address,article,aside,footer,header,h1,h2,h3,h4,h5,h6,hgroup,nav,section,div,dd,dl,dt,figcaption,figure,picture,hr,img,li,main,ol,p,pre,ul,a,b,abbr,bdi,bdo,br,cite,code,data,dfn,em,i,kbd,mark,q,rp,rt,rtc,ruby,s,samp,small,span,strong,sub,sup,time,u,var,wbr,area,audio,map,track,video,embed,object,param,source,canvas,script,noscript,del,ins,caption,col,colgroup,table,thead,tbody,td,th,tr,button,datalist,fieldset,form,input,label,legend,meter,optgroup,option,output,progress,select,textarea,details,dialog,menu,menuitem,summary,content,element,shadow,template,blockquote,iframe,tfoot"),hr=_("svg,animate,circle,clippath,cursor,defs,desc,ellipse,filter,font-face,foreignobject,g,glyph,image,line,marker,mask,missing-glyph,path,pattern,polygon,polyline,rect,switch,symbol,text,textpath,tspan,use,view",!0),vr=function(n){return fr(n)||hr(n)};var br=Object.create(null);var _r=_("text,number,password,search,email,tel,url");var yr=Object.freeze({__proto__:null,createElement:function(n,e){var t=document.createElement(n);return"select"!==n||e.data&&e.data.attrs&&void 0!==e.data.attrs.multiple&&t.setAttribute("multiple","multiple"),t},createElementNS:function(n,e){return document.createElementNS(gr[n],e)},createTextNode:function(n){return document.createTextNode(n)},createComment:function(n){return document.createComment(n)},insertBefore:function(n,e,t){n.insertBefore(e,t)},removeChild:function(n,e){n.removeChild(e)},appendChild:function(n,e){n.appendChild(e)},parentNode:function(n){return n.parentNode},nextSibling:function(n){return n.nextSibling},tagName:function(n){return n.tagName},setTextContent:function(n,e){n.textContent=e},setStyleScope:function(n,e){n.setAttribute(e,"")}}),kr={create:function(n,e){wr(e)},update:function(n,e){n.data.ref!==e.data.ref&&(wr(n,!0),wr(e))},destroy:function(n){wr(n,!0)}};function wr(n,e){var t=n.data.ref;if(s(t)){var r=n.context,a=n.componentInstance||n.elm,i=e?null:a,l=e?void 0:a;if(c(t))je(t,r,[i],r,"template ref function");else{var p=n.data.refInFor,d="string"==typeof t||"number"==typeof t,u=Ln(t),m=r.$refs;if(d||u)if(p){var g=d?m[t]:t.value;e?o(g)&&k(g,a):o(g)?g.includes(a)||g.push(a):d?(m[t]=[a],Er(r,t,m[t])):t.value=[a]}else if(d){if(e&&m[t]!==a)return;m[t]=l,Er(r,t,i)}else if(u){if(e&&t.value!==a)return;t.value=i}else 0}}}function Er(n,e,t){var r=n._setupState;r&&E(r,e)&&(Ln(r[e])?r[e].value=t:r[e]=t)}var xr=new gn("",{},[]),Ar=["create","activate","update","remove","destroy"];function Br(n,e){return n.key===e.key&&n.asyncFactory===e.asyncFactory&&(n.tag===e.tag&&n.isComment===e.isComment&&s(n.data)===s(e.data)&&function(n,e){if("input"!==n.tag)return!0;var t,r=s(t=n.data)&&s(t=t.attrs)&&t.type,o=s(t=e.data)&&s(t=t.attrs)&&t.type;return r===o||_r(r)&&_r(o)}(n,e)||i(n.isAsyncPlaceholder)&&a(e.asyncFactory.error))}function zr(n,e,t){var r,o,a={};for(r=e;r<=t;++r)s(o=n[r].key)&&(a[o]=r);return a}var jr={create:Tr,update:Tr,destroy:function(n){Tr(n,xr)}};function Tr(n,e){(n.data.directives||e.data.directives)&&function(n,e){var t,r,o,a=n===xr,s=e===xr,i=Sr(n.data.directives,n.context),l=Sr(e.data.directives,e.context),c=[],p=[];for(t in l)r=i[t],o=l[t],r?(o.oldValue=r.value,o.oldArg=r.arg,Ir(o,"update",e,n),o.def&&o.def.componentUpdated&&p.push(o)):(Ir(o,"bind",e,n),o.def&&o.def.inserted&&c.push(o));if(c.length){var d=function(){for(var t=0;t<c.length;t++)Ir(c[t],"inserted",e,n)};a?Zn(e,"insert",d):d()}p.length&&Zn(e,"postpatch",(function(){for(var t=0;t<p.length;t++)Ir(p[t],"componentUpdated",e,n)}));if(!a)for(t in i)l[t]||Ir(i[t],"unbind",n,n,s)}(n,e)}var Cr=Object.create(null);function Sr(n,e){var t,r,o=Object.create(null);if(!n)return o;for(t=0;t<n.length;t++){if((r=n[t]).modifiers||(r.modifiers=Cr),o[Pr(r)]=r,e._setupState&&e._setupState.__sfc){var a=r.def||St(e,"_setupState","v-"+r.name);r.def="function"==typeof a?{bind:a,update:a}:a}r.def=r.def||St(e.$options,"directives",r.name)}return o}function Pr(n){return n.rawName||"".concat(n.name,".").concat(Object.keys(n.modifiers||{}).join("."))}function Ir(n,e,t,r,o){var a=n.def&&n.def[e];if(a)try{a(t.elm,n,t,r,o)}catch(r){ze(r,t.context,"directive ".concat(n.name," ").concat(e," hook"))}}var qr=[kr,jr];function Dr(n,e){var t=e.componentOptions;if(!(s(t)&&!1===t.Ctor.options.inheritAttrs||a(n.data.attrs)&&a(e.data.attrs))){var r,o,l=e.elm,c=n.data.attrs||{},p=e.data.attrs||{};for(r in(s(p.__ob__)||i(p._v_attr_proxy))&&(p=e.data.attrs=P({},p)),p)o=p[r],c[r]!==o&&Nr(l,r,o,e.data.pre);for(r in(J||Q)&&p.value!==c.value&&Nr(l,"value",p.value),c)a(p[r])&&(ir(r)?l.removeAttributeNS(sr,lr(r)):rr(r)||l.removeAttribute(r))}}function Nr(n,e,t,r){r||n.tagName.indexOf("-")>-1?Or(n,e,t):ar(e)?cr(t)?n.removeAttribute(e):(t="allowfullscreen"===e&&"EMBED"===n.tagName?"true":e,n.setAttribute(e,t)):rr(e)?n.setAttribute(e,function(n,e){return cr(e)||"false"===e?"false":"contenteditable"===n&&or(e)?e:"true"}(e,t)):ir(e)?cr(t)?n.removeAttributeNS(sr,lr(e)):n.setAttributeNS(sr,e,t):Or(n,e,t)}function Or(n,e,t){if(cr(t))n.removeAttribute(e);else{if(J&&!Y&&"TEXTAREA"===n.tagName&&"placeholder"===e&&""!==t&&!n.__ieph){var r=function(e){e.stopImmediatePropagation(),n.removeEventListener("input",r)};n.addEventListener("input",r),n.__ieph=!0}n.setAttribute(e,t)}}var Rr={create:Dr,update:Dr};function Fr(n,e){var t=e.elm,r=e.data,o=n.data;if(!(a(r.staticClass)&&a(r.class)&&(a(o)||a(o.staticClass)&&a(o.class)))){var i=pr(e),l=t._transitionClasses;s(l)&&(i=ur(i,mr(l))),i!==t._prevClass&&(t.setAttribute("class",i),t._prevClass=i)}}var Lr,Ur={create:Fr,update:Fr};function Mr(n,e,t){var r=Lr;return function o(){var a=e.apply(null,arguments);null!==a&&$r(n,o,t,r)}}var Gr=Pe&&!(tn&&Number(tn[1])<=53);function Vr(n,e,t,r){if(Gr){var o=lt,a=e;e=a._wrapper=function(n){if(n.target===n.currentTarget||n.timeStamp>=o||n.timeStamp<=0||n.target.ownerDocument!==document)return a.apply(this,arguments)}}Lr.addEventListener(n,e,on?{capture:t,passive:r}:t)}function $r(n,e,t,r){(r||Lr).removeEventListener(n,e._wrapper||e,t)}function Wr(n,e){if(!a(n.data.on)||!a(e.data.on)){var t=e.data.on||{},r=n.data.on||{};Lr=e.elm||n.elm,function(n){if(s(n.__r)){var e=J?"change":"input";n[e]=[].concat(n.__r,n[e]||[]),delete n.__r}s(n.__c)&&(n.change=[].concat(n.__c,n.change||[]),delete n.__c)}(t),Hn(t,r,Vr,$r,Mr,e.context),Lr=void 0}}var Hr,Zr={create:Wr,update:Wr,destroy:function(n){return Wr(n,xr)}};function Kr(n,e){if(!a(n.data.domProps)||!a(e.data.domProps)){var t,r,o=e.elm,l=n.data.domProps||{},c=e.data.domProps||{};for(t in(s(c.__ob__)||i(c._v_attr_proxy))&&(c=e.data.domProps=P({},c)),l)t in c||(o[t]="");for(t in c){if(r=c[t],"textContent"===t||"innerHTML"===t){if(e.children&&(e.children.length=0),r===l[t])continue;1===o.childNodes.length&&o.removeChild(o.childNodes[0])}if("value"===t&&"PROGRESS"!==o.tagName){o._value=r;var p=a(r)?"":String(r);Xr(o,p)&&(o.value=p)}else if("innerHTML"===t&&hr(o.tagName)&&a(o.innerHTML)){(Hr=Hr||document.createElement("div")).innerHTML="<svg>".concat(r,"</svg>");for(var d=Hr.firstChild;o.firstChild;)o.removeChild(o.firstChild);for(;d.firstChild;)o.appendChild(d.firstChild)}else if(r!==l[t])try{o[t]=r}catch(n){}}}}function Xr(n,e){return!n.composing&&("OPTION"===n.tagName||function(n,e){var t=!0;try{t=document.activeElement!==n}catch(n){}return t&&n.value!==e}(n,e)||function(n,e){var t=n.value,r=n._vModifiers;if(s(r)){if(r.number)return b(t)!==b(e);if(r.trim)return t.trim()!==e.trim()}return t!==e}(n,e))}var Jr={create:Kr,update:Kr},Yr=x((function(n){var e={},t=/:(.+)/;return n.split(/;(?![^(]*\))/g).forEach((function(n){if(n){var r=n.split(t);r.length>1&&(e[r[0].trim()]=r[1].trim())}})),e}));function Qr(n){var e=no(n.style);return n.staticStyle?P(n.staticStyle,e):e}function no(n){return Array.isArray(n)?I(n):"string"==typeof n?Yr(n):n}var eo,to=/^--/,ro=/\s*!important$/,oo=function(n,e,t){if(to.test(e))n.style.setProperty(e,t);else if(ro.test(t))n.style.setProperty(T(e),t.replace(ro,""),"important");else{var r=so(e);if(Array.isArray(t))for(var o=0,a=t.length;o<a;o++)n.style[r]=t[o];else n.style[r]=t}},ao=["Webkit","Moz","ms"],so=x((function(n){if(eo=eo||document.createElement("div").style,"filter"!==(n=B(n))&&n in eo)return n;for(var e=n.charAt(0).toUpperCase()+n.slice(1),t=0;t<ao.length;t++){var r=ao[t]+e;if(r in eo)return r}}));function io(n,e){var t=e.data,r=n.data;if(!(a(t.staticStyle)&&a(t.style)&&a(r.staticStyle)&&a(r.style))){var o,i,l=e.elm,c=r.staticStyle,p=r.normalizedStyle||r.style||{},d=c||p,u=no(e.data.style)||{};e.data.normalizedStyle=s(u.__ob__)?P({},u):u;var m=function(n,e){var t,r={};if(e)for(var o=n;o.componentInstance;)(o=o.componentInstance._vnode)&&o.data&&(t=Qr(o.data))&&P(r,t);(t=Qr(n.data))&&P(r,t);for(var a=n;a=a.parent;)a.data&&(t=Qr(a.data))&&P(r,t);return r}(e,!0);for(i in d)a(m[i])&&oo(l,i,"");for(i in m)o=m[i],oo(l,i,null==o?"":o)}}var lo={create:io,update:io},co=/\s+/;function po(n,e){if(e&&(e=e.trim()))if(n.classList)e.indexOf(" ")>-1?e.split(co).forEach((function(e){return n.classList.add(e)})):n.classList.add(e);else{var t=" ".concat(n.getAttribute("class")||""," ");t.indexOf(" "+e+" ")<0&&n.setAttribute("class",(t+e).trim())}}function uo(n,e){if(e&&(e=e.trim()))if(n.classList)e.indexOf(" ")>-1?e.split(co).forEach((function(e){return n.classList.remove(e)})):n.classList.remove(e),n.classList.length||n.removeAttribute("class");else{for(var t=" ".concat(n.getAttribute("class")||""," "),r=" "+e+" ";t.indexOf(r)>=0;)t=t.replace(r," ");(t=t.trim())?n.setAttribute("class",t):n.removeAttribute("class")}}function mo(n){if(n){if("object"==typeof n){var e={};return!1!==n.css&&P(e,go(n.name||"v")),P(e,n),e}return"string"==typeof n?go(n):void 0}}var go=x((function(n){return{enterClass:"".concat(n,"-enter"),enterToClass:"".concat(n,"-enter-to"),enterActiveClass:"".concat(n,"-enter-active"),leaveClass:"".concat(n,"-leave"),leaveToClass:"".concat(n,"-leave-to"),leaveActiveClass:"".concat(n,"-leave-active")}})),fo=K&&!Y,ho="transition",vo="transitionend",bo="animation",_o="animationend";fo&&(void 0===window.ontransitionend&&void 0!==window.onwebkittransitionend&&(ho="WebkitTransition",vo="webkitTransitionEnd"),void 0===window.onanimationend&&void 0!==window.onwebkitanimationend&&(bo="WebkitAnimation",_o="webkitAnimationEnd"));var yo=K?window.requestAnimationFrame?window.requestAnimationFrame.bind(window):setTimeout:function(n){return n()};function ko(n){yo((function(){yo(n)}))}function wo(n,e){var t=n._transitionClasses||(n._transitionClasses=[]);t.indexOf(e)<0&&(t.push(e),po(n,e))}function Eo(n,e){n._transitionClasses&&k(n._transitionClasses,e),uo(n,e)}function xo(n,e,t){var r=Bo(n,e),o=r.type,a=r.timeout,s=r.propCount;if(!o)return t();var i="transition"===o?vo:_o,l=0,c=function(){n.removeEventListener(i,p),t()},p=function(e){e.target===n&&++l>=s&&c()};setTimeout((function(){l<s&&c()}),a+1),n.addEventListener(i,p)}var Ao=/\b(transform|all)(,|$)/;function Bo(n,e){var t,r=window.getComputedStyle(n),o=(r[ho+"Delay"]||"").split(", "),a=(r[ho+"Duration"]||"").split(", "),s=zo(o,a),i=(r[bo+"Delay"]||"").split(", "),l=(r[bo+"Duration"]||"").split(", "),c=zo(i,l),p=0,d=0;return"transition"===e?s>0&&(t="transition",p=s,d=a.length):"animation"===e?c>0&&(t="animation",p=c,d=l.length):d=(t=(p=Math.max(s,c))>0?s>c?"transition":"animation":null)?"transition"===t?a.length:l.length:0,{type:t,timeout:p,propCount:d,hasTransform:"transition"===t&&Ao.test(r[ho+"Property"])}}function zo(n,e){for(;n.length<e.length;)n=n.concat(n);return Math.max.apply(null,e.map((function(e,t){return jo(e)+jo(n[t])})))}function jo(n){return 1e3*Number(n.slice(0,-1).replace(",","."))}function To(n,e){var t=n.elm;s(t._leaveCb)&&(t._leaveCb.cancelled=!0,t._leaveCb());var r=mo(n.data.transition);if(!a(r)&&!s(t._enterCb)&&1===t.nodeType){for(var o=r.css,i=r.type,l=r.enterClass,d=r.enterToClass,u=r.enterActiveClass,m=r.appearClass,g=r.appearToClass,f=r.appearActiveClass,h=r.beforeEnter,v=r.enter,_=r.afterEnter,y=r.enterCancelled,k=r.beforeAppear,w=r.appear,E=r.afterAppear,x=r.appearCancelled,A=r.duration,B=Je,z=Je.$vnode;z&&z.parent;)B=z.context,z=z.parent;var j=!B._isMounted||!n.isRootInsert;if(!j||w||""===w){var T=j&&m?m:l,C=j&&f?f:u,S=j&&g?g:d,P=j&&k||h,I=j&&c(w)?w:v,q=j&&E||_,D=j&&x||y,N=b(p(A)?A.enter:A);0;var O=!1!==o&&!Y,R=Po(I),L=t._enterCb=F((function(){O&&(Eo(t,S),Eo(t,C)),L.cancelled?(O&&Eo(t,T),D&&D(t)):q&&q(t),t._enterCb=null}));n.data.show||Zn(n,"insert",(function(){var e=t.parentNode,r=e&&e._pending&&e._pending[n.key];r&&r.tag===n.tag&&r.elm._leaveCb&&r.elm._leaveCb(),I&&I(t,L)})),P&&P(t),O&&(wo(t,T),wo(t,C),ko((function(){Eo(t,T),L.cancelled||(wo(t,S),R||(So(N)?setTimeout(L,N):xo(t,i,L)))}))),n.data.show&&(e&&e(),I&&I(t,L)),O||R||L()}}}function Co(n,e){var t=n.elm;s(t._enterCb)&&(t._enterCb.cancelled=!0,t._enterCb());var r=mo(n.data.transition);if(a(r)||1!==t.nodeType)return e();if(!s(t._leaveCb)){var o=r.css,i=r.type,l=r.leaveClass,c=r.leaveToClass,d=r.leaveActiveClass,u=r.beforeLeave,m=r.leave,g=r.afterLeave,f=r.leaveCancelled,h=r.delayLeave,v=r.duration,_=!1!==o&&!Y,y=Po(m),k=b(p(v)?v.leave:v);0;var w=t._leaveCb=F((function(){t.parentNode&&t.parentNode._pending&&(t.parentNode._pending[n.key]=null),_&&(Eo(t,c),Eo(t,d)),w.cancelled?(_&&Eo(t,l),f&&f(t)):(e(),g&&g(t)),t._leaveCb=null}));h?h(E):E()}function E(){w.cancelled||(!n.data.show&&t.parentNode&&((t.parentNode._pending||(t.parentNode._pending={}))[n.key]=n),u&&u(t),_&&(wo(t,l),wo(t,d),ko((function(){Eo(t,l),w.cancelled||(wo(t,c),y||(So(k)?setTimeout(w,k):xo(t,i,w)))}))),m&&m(t,w),_||y||w())}}function So(n){return"number"==typeof n&&!isNaN(n)}function Po(n){if(a(n))return!1;var e=n.fns;return s(e)?Po(Array.isArray(e)?e[0]:e):(n._length||n.length)>1}function Io(n,e){!0!==e.data.show&&To(e)}var qo=function(n){var e,t,r={},c=n.modules,p=n.nodeOps;for(e=0;e<Ar.length;++e)for(r[Ar[e]]=[],t=0;t<c.length;++t)s(c[t][Ar[e]])&&r[Ar[e]].push(c[t][Ar[e]]);function d(n){var e=p.parentNode(n);s(e)&&p.removeChild(e,n)}function u(n,e,t,o,a,l,c){if(s(n.elm)&&s(l)&&(n=l[c]=vn(n)),n.isRootInsert=!a,!function(n,e,t,o){var a=n.data;if(s(a)){var l=s(n.componentInstance)&&a.keepAlive;if(s(a=a.hook)&&s(a=a.init)&&a(n,!1),s(n.componentInstance))return m(n,e),g(t,n.elm,o),i(l)&&function(n,e,t,o){var a,i=n;for(;i.componentInstance;)if(i=i.componentInstance._vnode,s(a=i.data)&&s(a=a.transition)){for(a=0;a<r.activate.length;++a)r.activate[a](xr,i);e.push(i);break}g(t,n.elm,o)}(n,e,t,o),!0}}(n,e,t,o)){var d=n.data,u=n.children,h=n.tag;s(h)?(n.elm=n.ns?p.createElementNS(n.ns,h):p.createElement(h,n),b(n),f(n,u,e),s(d)&&v(n,e),g(t,n.elm,o)):i(n.isComment)?(n.elm=p.createComment(n.text),g(t,n.elm,o)):(n.elm=p.createTextNode(n.text),g(t,n.elm,o))}}function m(n,e){s(n.data.pendingInsert)&&(e.push.apply(e,n.data.pendingInsert),n.data.pendingInsert=null),n.elm=n.componentInstance.$el,h(n)?(v(n,e),b(n)):(wr(n),e.push(n))}function g(n,e,t){s(n)&&(s(t)?p.parentNode(t)===n&&p.insertBefore(n,e,t):p.appendChild(n,e))}function f(n,e,t){if(o(e)){0;for(var r=0;r<e.length;++r)u(e[r],t,n.elm,null,!0,e,r)}else l(n.text)&&p.appendChild(n.elm,p.createTextNode(String(n.text)))}function h(n){for(;n.componentInstance;)n=n.componentInstance._vnode;return s(n.tag)}function v(n,t){for(var o=0;o<r.create.length;++o)r.create[o](xr,n);s(e=n.data.hook)&&(s(e.create)&&e.create(xr,n),s(e.insert)&&t.push(n))}function b(n){var e;if(s(e=n.fnScopeId))p.setStyleScope(n.elm,e);else for(var t=n;t;)s(e=t.context)&&s(e=e.$options._scopeId)&&p.setStyleScope(n.elm,e),t=t.parent;s(e=Je)&&e!==n.context&&e!==n.fnContext&&s(e=e.$options._scopeId)&&p.setStyleScope(n.elm,e)}function y(n,e,t,r,o,a){for(;r<=o;++r)u(t[r],a,n,e,!1,t,r)}function k(n){var e,t,o=n.data;if(s(o))for(s(e=o.hook)&&s(e=e.destroy)&&e(n),e=0;e<r.destroy.length;++e)r.destroy[e](n);if(s(e=n.children))for(t=0;t<n.children.length;++t)k(n.children[t])}function w(n,e,t){for(;e<=t;++e){var r=n[e];s(r)&&(s(r.tag)?(E(r),k(r)):d(r.elm))}}function E(n,e){if(s(e)||s(n.data)){var t,o=r.remove.length+1;for(s(e)?e.listeners+=o:e=function(n,e){function t(){0==--t.listeners&&d(n)}return t.listeners=e,t}(n.elm,o),s(t=n.componentInstance)&&s(t=t._vnode)&&s(t.data)&&E(t,e),t=0;t<r.remove.length;++t)r.remove[t](n,e);s(t=n.data.hook)&&s(t=t.remove)?t(n,e):e()}else d(n.elm)}function x(n,e,t,r){for(var o=t;o<r;o++){var a=e[o];if(s(a)&&Br(n,a))return o}}function A(n,e,t,o,l,c){if(n!==e){s(e.elm)&&s(o)&&(e=o[l]=vn(e));var d=e.elm=n.elm;if(i(n.isAsyncPlaceholder))s(e.asyncFactory.resolved)?j(n.elm,e,t):e.isAsyncPlaceholder=!0;else if(i(e.isStatic)&&i(n.isStatic)&&e.key===n.key&&(i(e.isCloned)||i(e.isOnce)))e.componentInstance=n.componentInstance;else{var m,g=e.data;s(g)&&s(m=g.hook)&&s(m=m.prepatch)&&m(n,e);var f=n.children,v=e.children;if(s(g)&&h(e)){for(m=0;m<r.update.length;++m)r.update[m](n,e);s(m=g.hook)&&s(m=m.update)&&m(n,e)}a(e.text)?s(f)&&s(v)?f!==v&&function(n,e,t,r,o){var i,l,c,d=0,m=0,g=e.length-1,f=e[0],h=e[g],v=t.length-1,b=t[0],_=t[v],k=!o;for(0;d<=g&&m<=v;)a(f)?f=e[++d]:a(h)?h=e[--g]:Br(f,b)?(A(f,b,r,t,m),f=e[++d],b=t[++m]):Br(h,_)?(A(h,_,r,t,v),h=e[--g],_=t[--v]):Br(f,_)?(A(f,_,r,t,v),k&&p.insertBefore(n,f.elm,p.nextSibling(h.elm)),f=e[++d],_=t[--v]):Br(h,b)?(A(h,b,r,t,m),k&&p.insertBefore(n,h.elm,f.elm),h=e[--g],b=t[++m]):(a(i)&&(i=zr(e,d,g)),a(l=s(b.key)?i[b.key]:x(b,e,d,g))?u(b,r,n,f.elm,!1,t,m):Br(c=e[l],b)?(A(c,b,r,t,m),e[l]=void 0,k&&p.insertBefore(n,c.elm,f.elm)):u(b,r,n,f.elm,!1,t,m),b=t[++m]);d>g?y(n,a(t[v+1])?null:t[v+1].elm,t,m,v,r):m>v&&w(e,d,g)}(d,f,v,t,c):s(v)?(s(n.text)&&p.setTextContent(d,""),y(d,null,v,0,v.length-1,t)):s(f)?w(f,0,f.length-1):s(n.text)&&p.setTextContent(d,""):n.text!==e.text&&p.setTextContent(d,e.text),s(g)&&s(m=g.hook)&&s(m=m.postpatch)&&m(n,e)}}}function B(n,e,t){if(i(t)&&s(n.parent))n.parent.data.pendingInsert=e;else for(var r=0;r<e.length;++r)e[r].data.hook.insert(e[r])}var z=_("attrs,class,staticClass,staticStyle,key");function j(n,e,t,r){var o,a=e.tag,l=e.data,c=e.children;if(r=r||l&&l.pre,e.elm=n,i(e.isComment)&&s(e.asyncFactory))return e.isAsyncPlaceholder=!0,!0;if(s(l)&&(s(o=l.hook)&&s(o=o.init)&&o(e,!0),s(o=e.componentInstance)))return m(e,t),!0;if(s(a)){if(s(c))if(n.hasChildNodes())if(s(o=l)&&s(o=o.domProps)&&s(o=o.innerHTML)){if(o!==n.innerHTML)return!1}else{for(var p=!0,d=n.firstChild,u=0;u<c.length;u++){if(!d||!j(d,c[u],t,r)){p=!1;break}d=d.nextSibling}if(!p||d)return!1}else f(e,c,t);if(s(l)){var g=!1;for(var h in l)if(!z(h)){g=!0,v(e,t);break}!g&&l.class&&Ge(l.class)}}else n.data!==e.text&&(n.data=e.text);return!0}return function(n,e,t,o){if(!a(e)){var l,c=!1,d=[];if(a(n))c=!0,u(e,d);else{var m=s(n.nodeType);if(!m&&Br(n,e))A(n,e,d,null,null,o);else{if(m){if(1===n.nodeType&&n.hasAttribute("data-server-rendered")&&(n.removeAttribute("data-server-rendered"),t=!0),i(t)&&j(n,e,d))return B(e,d,!0),n;l=n,n=new gn(p.tagName(l).toLowerCase(),{},[],void 0,l)}var g=n.elm,f=p.parentNode(g);if(u(e,d,g._leaveCb?null:f,p.nextSibling(g)),s(e.parent))for(var v=e.parent,b=h(e);v;){for(var _=0;_<r.destroy.length;++_)r.destroy[_](v);if(v.elm=e.elm,b){for(var y=0;y<r.create.length;++y)r.create[y](xr,v);var E=v.data.hook.insert;if(E.merged)for(var x=E.fns.slice(1),z=0;z<x.length;z++)x[z]()}else wr(v);v=v.parent}s(f)?w([n],0,0):s(n.tag)&&k(n)}}return B(e,d,c),e.elm}s(n)&&k(n)}}({nodeOps:yr,modules:[Rr,Ur,Zr,Jr,lo,K?{create:Io,activate:Io,remove:function(n,e){!0!==n.data.show?Co(n,e):e()}}:{}].concat(qr)});Y&&document.addEventListener("selectionchange",(function(){var n=document.activeElement;n&&n.vmodel&&Mo(n,"input")}));var Do={inserted:function(n,e,t,r){"select"===t.tag?(r.elm&&!r.elm._vOptions?Zn(t,"postpatch",(function(){Do.componentUpdated(n,e,t)})):No(n,e,t.context),n._vOptions=[].map.call(n.options,Fo)):("textarea"===t.tag||_r(n.type))&&(n._vModifiers=e.modifiers,e.modifiers.lazy||(n.addEventListener("compositionstart",Lo),n.addEventListener("compositionend",Uo),n.addEventListener("change",Uo),Y&&(n.vmodel=!0)))},componentUpdated:function(n,e,t){if("select"===t.tag){No(n,e,t.context);var r=n._vOptions,o=n._vOptions=[].map.call(n.options,Fo);if(o.some((function(n,e){return!O(n,r[e])})))(n.multiple?e.value.some((function(n){return Ro(n,o)})):e.value!==e.oldValue&&Ro(e.value,o))&&Mo(n,"change")}}};function No(n,e,t){Oo(n,e,t),(J||Q)&&setTimeout((function(){Oo(n,e,t)}),0)}function Oo(n,e,t){var r=e.value,o=n.multiple;if(!o||Array.isArray(r)){for(var a,s,i=0,l=n.options.length;i<l;i++)if(s=n.options[i],o)a=R(r,Fo(s))>-1,s.selected!==a&&(s.selected=a);else if(O(Fo(s),r))return void(n.selectedIndex!==i&&(n.selectedIndex=i));o||(n.selectedIndex=-1)}}function Ro(n,e){return e.every((function(e){return!O(e,n)}))}function Fo(n){return"_value"in n?n._value:n.value}function Lo(n){n.target.composing=!0}function Uo(n){n.target.composing&&(n.target.composing=!1,Mo(n.target,"input"))}function Mo(n,e){var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!0),n.dispatchEvent(t)}function Go(n){return!n.componentInstance||n.data&&n.data.transition?n:Go(n.componentInstance._vnode)}var Vo={model:Do,show:{bind:function(n,e,t){var r=e.value,o=(t=Go(t)).data&&t.data.transition,a=n.__vOriginalDisplay="none"===n.style.display?"":n.style.display;r&&o?(t.data.show=!0,To(t,(function(){n.style.display=a}))):n.style.display=r?a:"none"},update:function(n,e,t){var r=e.value;!r!=!e.oldValue&&((t=Go(t)).data&&t.data.transition?(t.data.show=!0,r?To(t,(function(){n.style.display=n.__vOriginalDisplay})):Co(t,(function(){n.style.display="none"}))):n.style.display=r?n.__vOriginalDisplay:"none")},unbind:function(n,e,t,r,o){o||(n.style.display=n.__vOriginalDisplay)}}},$o={name:String,appear:Boolean,css:Boolean,mode:String,type:String,enterClass:String,leaveClass:String,enterToClass:String,leaveToClass:String,enterActiveClass:String,leaveActiveClass:String,appearClass:String,appearActiveClass:String,appearToClass:String,duration:[Number,String,Object]};function Wo(n){var e=n&&n.componentOptions;return e&&e.Ctor.options.abstract?Wo(Ae(e.children)):n}function Ho(n){var e={},t=n.$options;for(var r in t.propsData)e[r]=n[r];var o=t._parentListeners;for(var r in o)e[B(r)]=o[r];return e}function Zo(n,e){if(/\d-keep-alive$/.test(e.tag))return n("keep-alive",{props:e.componentOptions.propsData})}var Ko=function(n){return n.tag||fe(n)},Xo=function(n){return"show"===n.name},Jo={name:"transition",props:$o,abstract:!0,render:function(n){var e=this,t=this.$slots.default;if(t&&(t=t.filter(Ko)).length){0;var r=this.mode;0;var o=t[0];if(function(n){for(;n=n.parent;)if(n.data.transition)return!0}(this.$vnode))return o;var a=Wo(o);if(!a)return o;if(this._leaving)return Zo(n,o);var s="__transition-".concat(this._uid,"-");a.key=null==a.key?a.isComment?s+"comment":s+a.tag:l(a.key)?0===String(a.key).indexOf(s)?a.key:s+a.key:a.key;var i=(a.data||(a.data={})).transition=Ho(this),c=this._vnode,p=Wo(c);if(a.data.directives&&a.data.directives.some(Xo)&&(a.data.show=!0),p&&p.data&&!function(n,e){return e.key===n.key&&e.tag===n.tag}(a,p)&&!fe(p)&&(!p.componentInstance||!p.componentInstance._vnode.isComment)){var d=p.data.transition=P({},i);if("out-in"===r)return this._leaving=!0,Zn(d,"afterLeave",(function(){e._leaving=!1,e.$forceUpdate()})),Zo(n,o);if("in-out"===r){if(fe(a))return c;var u,m=function(){u()};Zn(i,"afterEnter",m),Zn(i,"enterCancelled",m),Zn(d,"delayLeave",(function(n){u=n}))}}return o}}},Yo=P({tag:String,moveClass:String},$o);function Qo(n){n.elm._moveCb&&n.elm._moveCb(),n.elm._enterCb&&n.elm._enterCb()}function na(n){n.data.newPos=n.elm.getBoundingClientRect()}function ea(n){var e=n.data.pos,t=n.data.newPos,r=e.left-t.left,o=e.top-t.top;if(r||o){n.data.moved=!0;var a=n.elm.style;a.transform=a.WebkitTransform="translate(".concat(r,"px,").concat(o,"px)"),a.transitionDuration="0s"}}delete Yo.mode;var ta={Transition:Jo,TransitionGroup:{props:Yo,beforeMount:function(){var n=this,e=this._update;this._update=function(t,r){var o=Ye(n);n.__patch__(n._vnode,n.kept,!1,!0),n._vnode=n.kept,o(),e.call(n,t,r)}},render:function(n){for(var e=this.tag||this.$vnode.data.tag||"span",t=Object.create(null),r=this.prevChildren=this.children,o=this.$slots.default||[],a=this.children=[],s=Ho(this),i=0;i<o.length;i++){if((p=o[i]).tag)if(null!=p.key&&0!==String(p.key).indexOf("__vlist"))a.push(p),t[p.key]=p,(p.data||(p.data={})).transition=s;else;}if(r){var l=[],c=[];for(i=0;i<r.length;i++){var p;(p=r[i]).data.transition=s,p.data.pos=p.elm.getBoundingClientRect(),t[p.key]?l.push(p):c.push(p)}this.kept=n(e,null,l),this.removed=c}return n(e,null,a)},updated:function(){var n=this.prevChildren,e=this.moveClass||(this.name||"v")+"-move";n.length&&this.hasMove(n[0].elm,e)&&(n.forEach(Qo),n.forEach(na),n.forEach(ea),this._reflow=document.body.offsetHeight,n.forEach((function(n){if(n.data.moved){var t=n.elm,r=t.style;wo(t,e),r.transform=r.WebkitTransform=r.transitionDuration="",t.addEventListener(vo,t._moveCb=function n(r){r&&r.target!==t||r&&!/transform$/.test(r.propertyName)||(t.removeEventListener(vo,n),t._moveCb=null,Eo(t,e))})}})))},methods:{hasMove:function(n,e){if(!fo)return!1;if(this._hasMove)return this._hasMove;var t=n.cloneNode();n._transitionClasses&&n._transitionClasses.forEach((function(n){uo(t,n)})),po(t,e),t.style.display="none",this.$el.appendChild(t);var r=Bo(t);return this.$el.removeChild(t),this._hasMove=r.hasTransform}}}};function ra(n,e){for(var t in e)n[t]=e[t];return n}Ht.config.mustUseProp=function(n,e,t){return"value"===t&&tr(n)&&"button"!==e||"selected"===t&&"option"===n||"checked"===t&&"input"===n||"muted"===t&&"video"===n},Ht.config.isReservedTag=vr,Ht.config.isReservedAttr=er,Ht.config.getTagNamespace=function(n){return hr(n)?"svg":"math"===n?"math":void 0},Ht.config.isUnknownElement=function(n){if(!K)return!0;if(vr(n))return!1;if(n=n.toLowerCase(),null!=br[n])return br[n];var e=document.createElement(n);return n.indexOf("-")>-1?br[n]=e.constructor===window.HTMLUnknownElement||e.constructor===window.HTMLElement:br[n]=/HTMLUnknownElement/.test(e.toString())},P(Ht.options.directives,Vo),P(Ht.options.components,ta),Ht.prototype.__patch__=K?qo:q,Ht.prototype.$mount=function(n,e){return function(n,e,t){var r;n.$el=e,n.$options.render||(n.$options.render=fn),et(n,"beforeMount"),r=function(){n._update(n._render(),t)},new We(n,r,q,{before:function(){n._isMounted&&!n._isDestroyed&&et(n,"beforeUpdate")}},!0),t=!1;var o=n._preWatchers;if(o)for(var a=0;a<o.length;a++)o[a].run();return null==n.$vnode&&(n._isMounted=!0,et(n,"mounted")),n}(this,n=n&&K?function(n){if("string"==typeof n){var e=document.querySelector(n);return e||document.createElement("div")}return n}(n):void 0,e)},K&&setTimeout((function(){G.devtools&&ln&&ln.emit("init",Ht)}),0);var oa=/[!'()*]/g,aa=function(n){return"%"+n.charCodeAt(0).toString(16)},sa=/%2C/g,ia=function(n){return encodeURIComponent(n).replace(oa,aa).replace(sa,",")};function la(n){try{return decodeURIComponent(n)}catch(n){0}return n}var ca=function(n){return null==n||"object"==typeof n?n:String(n)};function pa(n){var e={};return(n=n.trim().replace(/^(\?|#|&)/,""))?(n.split("&").forEach((function(n){var t=n.replace(/\+/g," ").split("="),r=la(t.shift()),o=t.length>0?la(t.join("=")):null;void 0===e[r]?e[r]=o:Array.isArray(e[r])?e[r].push(o):e[r]=[e[r],o]})),e):e}function da(n){var e=n?Object.keys(n).map((function(e){var t=n[e];if(void 0===t)return"";if(null===t)return ia(e);if(Array.isArray(t)){var r=[];return t.forEach((function(n){void 0!==n&&(null===n?r.push(ia(e)):r.push(ia(e)+"="+ia(n)))})),r.join("&")}return ia(e)+"="+ia(t)})).filter((function(n){return n.length>0})).join("&"):null;return e?"?"+e:""}var ua=/\/?$/;function ma(n,e,t,r){var o=r&&r.options.stringifyQuery,a=e.query||{};try{a=ga(a)}catch(n){}var s={name:e.name||n&&n.name,meta:n&&n.meta||{},path:e.path||"/",hash:e.hash||"",query:a,params:e.params||{},fullPath:va(e,o),matched:n?ha(n):[]};return t&&(s.redirectedFrom=va(t,o)),Object.freeze(s)}function ga(n){if(Array.isArray(n))return n.map(ga);if(n&&"object"==typeof n){var e={};for(var t in n)e[t]=ga(n[t]);return e}return n}var fa=ma(null,{path:"/"});function ha(n){for(var e=[];n;)e.unshift(n),n=n.parent;return e}function va(n,e){var t=n.path,r=n.query;void 0===r&&(r={});var o=n.hash;return void 0===o&&(o=""),(t||"/")+(e||da)(r)+o}function ba(n,e,t){return e===fa?n===e:!!e&&(n.path&&e.path?n.path.replace(ua,"")===e.path.replace(ua,"")&&(t||n.hash===e.hash&&_a(n.query,e.query)):!(!n.name||!e.name)&&(n.name===e.name&&(t||n.hash===e.hash&&_a(n.query,e.query)&&_a(n.params,e.params))))}function _a(n,e){if(void 0===n&&(n={}),void 0===e&&(e={}),!n||!e)return n===e;var t=Object.keys(n).sort(),r=Object.keys(e).sort();return t.length===r.length&&t.every((function(t,o){var a=n[t];if(r[o]!==t)return!1;var s=e[t];return null==a||null==s?a===s:"object"==typeof a&&"object"==typeof s?_a(a,s):String(a)===String(s)}))}function ya(n){for(var e=0;e<n.matched.length;e++){var t=n.matched[e];for(var r in t.instances){var o=t.instances[r],a=t.enteredCbs[r];if(o&&a){delete t.enteredCbs[r];for(var s=0;s<a.length;s++)o._isBeingDestroyed||a[s](o)}}}}var ka={name:"RouterView",functional:!0,props:{name:{type:String,default:"default"}},render:function(n,e){var t=e.props,r=e.children,o=e.parent,a=e.data;a.routerView=!0;for(var s=o.$createElement,i=t.name,l=o.$route,c=o._routerViewCache||(o._routerViewCache={}),p=0,d=!1;o&&o._routerRoot!==o;){var u=o.$vnode?o.$vnode.data:{};u.routerView&&p++,u.keepAlive&&o._directInactive&&o._inactive&&(d=!0),o=o.$parent}if(a.routerViewDepth=p,d){var m=c[i],g=m&&m.component;return g?(m.configProps&&wa(g,a,m.route,m.configProps),s(g,a,r)):s()}var f=l.matched[p],h=f&&f.components[i];if(!f||!h)return c[i]=null,s();c[i]={component:h},a.registerRouteInstance=function(n,e){var t=f.instances[i];(e&&t!==n||!e&&t===n)&&(f.instances[i]=e)},(a.hook||(a.hook={})).prepatch=function(n,e){f.instances[i]=e.componentInstance},a.hook.init=function(n){n.data.keepAlive&&n.componentInstance&&n.componentInstance!==f.instances[i]&&(f.instances[i]=n.componentInstance),ya(l)};var v=f.props&&f.props[i];return v&&(ra(c[i],{route:l,configProps:v}),wa(h,a,l,v)),s(h,a,r)}};function wa(n,e,t,r){var o=e.props=function(n,e){switch(typeof e){case"undefined":return;case"object":return e;case"function":return e(n);case"boolean":return e?n.params:void 0;default:0}}(t,r);if(o){o=e.props=ra({},o);var a=e.attrs=e.attrs||{};for(var s in o)n.props&&s in n.props||(a[s]=o[s],delete o[s])}}function Ea(n,e,t){var r=n.charAt(0);if("/"===r)return n;if("?"===r||"#"===r)return e+n;var o=e.split("/");t&&o[o.length-1]||o.pop();for(var a=n.replace(/^\//,"").split("/"),s=0;s<a.length;s++){var i=a[s];".."===i?o.pop():"."!==i&&o.push(i)}return""!==o[0]&&o.unshift(""),o.join("/")}function xa(n){return n.replace(/\/(?:\s*\/)+/g,"/")}var Aa=Array.isArray||function(n){return"[object Array]"==Object.prototype.toString.call(n)},Ba=La,za=Pa,ja=function(n,e){return qa(Pa(n,e),e)},Ta=qa,Ca=Fa,Sa=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))"].join("|"),"g");function Pa(n,e){for(var t,r=[],o=0,a=0,s="",i=e&&e.delimiter||"/";null!=(t=Sa.exec(n));){var l=t[0],c=t[1],p=t.index;if(s+=n.slice(a,p),a=p+l.length,c)s+=c[1];else{var d=n[a],u=t[2],m=t[3],g=t[4],f=t[5],h=t[6],v=t[7];s&&(r.push(s),s="");var b=null!=u&&null!=d&&d!==u,_="+"===h||"*"===h,y="?"===h||"*"===h,k=t[2]||i,w=g||f;r.push({name:m||o++,prefix:u||"",delimiter:k,optional:y,repeat:_,partial:b,asterisk:!!v,pattern:w?Na(w):v?".*":"[^"+Da(k)+"]+?"})}}return a<n.length&&(s+=n.substr(a)),s&&r.push(s),r}function Ia(n){return encodeURI(n).replace(/[\/?#]/g,(function(n){return"%"+n.charCodeAt(0).toString(16).toUpperCase()}))}function qa(n,e){for(var t=new Array(n.length),r=0;r<n.length;r++)"object"==typeof n[r]&&(t[r]=new RegExp("^(?:"+n[r].pattern+")$",Ra(e)));return function(e,r){for(var o="",a=e||{},s=(r||{}).pretty?Ia:encodeURIComponent,i=0;i<n.length;i++){var l=n[i];if("string"!=typeof l){var c,p=a[l.name];if(null==p){if(l.optional){l.partial&&(o+=l.prefix);continue}throw new TypeError('Expected "'+l.name+'" to be defined')}if(Aa(p)){if(!l.repeat)throw new TypeError('Expected "'+l.name+'" to not repeat, but received `'+JSON.stringify(p)+"`");if(0===p.length){if(l.optional)continue;throw new TypeError('Expected "'+l.name+'" to not be empty')}for(var d=0;d<p.length;d++){if(c=s(p[d]),!t[i].test(c))throw new TypeError('Expected all "'+l.name+'" to match "'+l.pattern+'", but received `'+JSON.stringify(c)+"`");o+=(0===d?l.prefix:l.delimiter)+c}}else{if(c=l.asterisk?encodeURI(p).replace(/[?#]/g,(function(n){return"%"+n.charCodeAt(0).toString(16).toUpperCase()})):s(p),!t[i].test(c))throw new TypeError('Expected "'+l.name+'" to match "'+l.pattern+'", but received "'+c+'"');o+=l.prefix+c}}else o+=l}return o}}function Da(n){return n.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function Na(n){return n.replace(/([=!:$\/()])/g,"\\$1")}function Oa(n,e){return n.keys=e,n}function Ra(n){return n&&n.sensitive?"":"i"}function Fa(n,e,t){Aa(e)||(t=e||t,e=[]);for(var r=(t=t||{}).strict,o=!1!==t.end,a="",s=0;s<n.length;s++){var i=n[s];if("string"==typeof i)a+=Da(i);else{var l=Da(i.prefix),c="(?:"+i.pattern+")";e.push(i),i.repeat&&(c+="(?:"+l+c+")*"),a+=c=i.optional?i.partial?l+"("+c+")?":"(?:"+l+"("+c+"))?":l+"("+c+")"}}var p=Da(t.delimiter||"/"),d=a.slice(-p.length)===p;return r||(a=(d?a.slice(0,-p.length):a)+"(?:"+p+"(?=$))?"),a+=o?"$":r&&d?"":"(?="+p+"|$)",Oa(new RegExp("^"+a,Ra(t)),e)}function La(n,e,t){return Aa(e)||(t=e||t,e=[]),t=t||{},n instanceof RegExp?function(n,e){var t=n.source.match(/\((?!\?)/g);if(t)for(var r=0;r<t.length;r++)e.push({name:r,prefix:null,delimiter:null,optional:!1,repeat:!1,partial:!1,asterisk:!1,pattern:null});return Oa(n,e)}(n,e):Aa(n)?function(n,e,t){for(var r=[],o=0;o<n.length;o++)r.push(La(n[o],e,t).source);return Oa(new RegExp("(?:"+r.join("|")+")",Ra(t)),e)}(n,e,t):function(n,e,t){return Fa(Pa(n,t),e,t)}(n,e,t)}Ba.parse=za,Ba.compile=ja,Ba.tokensToFunction=Ta,Ba.tokensToRegExp=Ca;var Ua=Object.create(null);function Ma(n,e,t){e=e||{};try{var r=Ua[n]||(Ua[n]=Ba.compile(n));return"string"==typeof e.pathMatch&&(e[0]=e.pathMatch),r(e,{pretty:!0})}catch(n){return""}finally{delete e[0]}}function Ga(n,e,t,r){var o="string"==typeof n?{path:n}:n;if(o._normalized)return o;if(o.name){var a=(o=ra({},n)).params;return a&&"object"==typeof a&&(o.params=ra({},a)),o}if(!o.path&&o.params&&e){(o=ra({},o))._normalized=!0;var s=ra(ra({},e.params),o.params);if(e.name)o.name=e.name,o.params=s;else if(e.matched.length){var i=e.matched[e.matched.length-1].path;o.path=Ma(i,s,e.path)}else 0;return o}var l=function(n){var e="",t="",r=n.indexOf("#");r>=0&&(e=n.slice(r),n=n.slice(0,r));var o=n.indexOf("?");return o>=0&&(t=n.slice(o+1),n=n.slice(0,o)),{path:n,query:t,hash:e}}(o.path||""),c=e&&e.path||"/",p=l.path?Ea(l.path,c,t||o.append):c,d=function(n,e,t){void 0===e&&(e={});var r,o=t||pa;try{r=o(n||"")}catch(n){r={}}for(var a in e){var s=e[a];r[a]=Array.isArray(s)?s.map(ca):ca(s)}return r}(l.query,o.query,r&&r.options.parseQuery),u=o.hash||l.hash;return u&&"#"!==u.charAt(0)&&(u="#"+u),{_normalized:!0,path:p,query:d,hash:u}}var Va,$a=function(){},Wa={name:"RouterLink",props:{to:{type:[String,Object],required:!0},tag:{type:String,default:"a"},custom:Boolean,exact:Boolean,exactPath:Boolean,append:Boolean,replace:Boolean,activeClass:String,exactActiveClass:String,ariaCurrentValue:{type:String,default:"page"},event:{type:[String,Array],default:"click"}},render:function(n){var e=this,t=this.$router,r=this.$route,o=t.resolve(this.to,r,this.append),a=o.location,s=o.route,i=o.href,l={},c=t.options.linkActiveClass,p=t.options.linkExactActiveClass,d=null==c?"router-link-active":c,u=null==p?"router-link-exact-active":p,m=null==this.activeClass?d:this.activeClass,g=null==this.exactActiveClass?u:this.exactActiveClass,f=s.redirectedFrom?ma(null,Ga(s.redirectedFrom),null,t):s;l[g]=ba(r,f,this.exactPath),l[m]=this.exact||this.exactPath?l[g]:function(n,e){return 0===n.path.replace(ua,"/").indexOf(e.path.replace(ua,"/"))&&(!e.hash||n.hash===e.hash)&&function(n,e){for(var t in e)if(!(t in n))return!1;return!0}(n.query,e.query)}(r,f);var h=l[g]?this.ariaCurrentValue:null,v=function(n){Ha(n)&&(e.replace?t.replace(a,$a):t.push(a,$a))},b={click:Ha};Array.isArray(this.event)?this.event.forEach((function(n){b[n]=v})):b[this.event]=v;var _={class:l},y=!this.$scopedSlots.$hasNormal&&this.$scopedSlots.default&&this.$scopedSlots.default({href:i,route:s,navigate:v,isActive:l[m],isExactActive:l[g]});if(y){if(1===y.length)return y[0];if(y.length>1||!y.length)return 0===y.length?n():n("span",{},y)}if("a"===this.tag)_.on=b,_.attrs={href:i,"aria-current":h};else{var k=function n(e){var t;if(e)for(var r=0;r<e.length;r++){if("a"===(t=e[r]).tag)return t;if(t.children&&(t=n(t.children)))return t}}(this.$slots.default);if(k){k.isStatic=!1;var w=k.data=ra({},k.data);for(var E in w.on=w.on||{},w.on){var x=w.on[E];E in b&&(w.on[E]=Array.isArray(x)?x:[x])}for(var A in b)A in w.on?w.on[A].push(b[A]):w.on[A]=v;var B=k.data.attrs=ra({},k.data.attrs);B.href=i,B["aria-current"]=h}else _.on=b}return n(this.tag,_,this.$slots.default)}};function Ha(n){if(!(n.metaKey||n.altKey||n.ctrlKey||n.shiftKey||n.defaultPrevented||void 0!==n.button&&0!==n.button)){if(n.currentTarget&&n.currentTarget.getAttribute){var e=n.currentTarget.getAttribute("target");if(/\b_blank\b/i.test(e))return}return n.preventDefault&&n.preventDefault(),!0}}var Za="undefined"!=typeof window;function Ka(n,e,t,r,o){var a=e||[],s=t||Object.create(null),i=r||Object.create(null);n.forEach((function(n){!function n(e,t,r,o,a,s){var i=o.path,l=o.name;0;var c=o.pathToRegexpOptions||{},p=function(n,e,t){t||(n=n.replace(/\/$/,""));if("/"===n[0])return n;if(null==e)return n;return xa(e.path+"/"+n)}(i,a,c.strict);"boolean"==typeof o.caseSensitive&&(c.sensitive=o.caseSensitive);var d={path:p,regex:Xa(p,c),components:o.components||{default:o.component},alias:o.alias?"string"==typeof o.alias?[o.alias]:o.alias:[],instances:{},enteredCbs:{},name:l,parent:a,matchAs:s,redirect:o.redirect,beforeEnter:o.beforeEnter,meta:o.meta||{},props:null==o.props?{}:o.components?o.props:{default:o.props}};o.children&&o.children.forEach((function(o){var a=s?xa(s+"/"+o.path):void 0;n(e,t,r,o,d,a)}));t[d.path]||(e.push(d.path),t[d.path]=d);if(void 0!==o.alias)for(var u=Array.isArray(o.alias)?o.alias:[o.alias],m=0;m<u.length;++m){0;var g={path:u[m],children:o.children};n(e,t,r,g,a,d.path||"/")}l&&(r[l]||(r[l]=d))}(a,s,i,n,o)}));for(var l=0,c=a.length;l<c;l++)"*"===a[l]&&(a.push(a.splice(l,1)[0]),c--,l--);return{pathList:a,pathMap:s,nameMap:i}}function Xa(n,e){return Ba(n,[],e)}function Ja(n,e){var t=Ka(n),r=t.pathList,o=t.pathMap,a=t.nameMap;function s(n,t,s){var i=Ga(n,t,!1,e),c=i.name;if(c){var p=a[c];if(!p)return l(null,i);var d=p.regex.keys.filter((function(n){return!n.optional})).map((function(n){return n.name}));if("object"!=typeof i.params&&(i.params={}),t&&"object"==typeof t.params)for(var u in t.params)!(u in i.params)&&d.indexOf(u)>-1&&(i.params[u]=t.params[u]);return i.path=Ma(p.path,i.params),l(p,i,s)}if(i.path){i.params={};for(var m=0;m<r.length;m++){var g=r[m],f=o[g];if(Ya(f.regex,i.path,i.params))return l(f,i,s)}}return l(null,i)}function i(n,t){var r=n.redirect,o="function"==typeof r?r(ma(n,t,null,e)):r;if("string"==typeof o&&(o={path:o}),!o||"object"!=typeof o)return l(null,t);var i=o,c=i.name,p=i.path,d=t.query,u=t.hash,m=t.params;if(d=i.hasOwnProperty("query")?i.query:d,u=i.hasOwnProperty("hash")?i.hash:u,m=i.hasOwnProperty("params")?i.params:m,c){a[c];return s({_normalized:!0,name:c,query:d,hash:u,params:m},void 0,t)}if(p){var g=function(n,e){return Ea(n,e.parent?e.parent.path:"/",!0)}(p,n);return s({_normalized:!0,path:Ma(g,m),query:d,hash:u},void 0,t)}return l(null,t)}function l(n,t,r){return n&&n.redirect?i(n,r||t):n&&n.matchAs?function(n,e,t){var r=s({_normalized:!0,path:Ma(t,e.params)});if(r){var o=r.matched,a=o[o.length-1];return e.params=r.params,l(a,e)}return l(null,e)}(0,t,n.matchAs):ma(n,t,r,e)}return{match:s,addRoute:function(n,e){var t="object"!=typeof n?a[n]:void 0;Ka([e||n],r,o,a,t),t&&t.alias.length&&Ka(t.alias.map((function(n){return{path:n,children:[e]}})),r,o,a,t)},getRoutes:function(){return r.map((function(n){return o[n]}))},addRoutes:function(n){Ka(n,r,o,a)}}}function Ya(n,e,t){var r=e.match(n);if(!r)return!1;if(!t)return!0;for(var o=1,a=r.length;o<a;++o){var s=n.keys[o-1];s&&(t[s.name||"pathMatch"]="string"==typeof r[o]?la(r[o]):r[o])}return!0}var Qa=Za&&window.performance&&window.performance.now?window.performance:Date;function ns(){return Qa.now().toFixed(3)}var es=ns();function ts(){return es}function rs(n){return es=n}var os=Object.create(null);function as(){"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var n=window.location.protocol+"//"+window.location.host,e=window.location.href.replace(n,""),t=ra({},window.history.state);return t.key=ts(),window.history.replaceState(t,"",e),window.addEventListener("popstate",ls),function(){window.removeEventListener("popstate",ls)}}function ss(n,e,t,r){if(n.app){var o=n.options.scrollBehavior;o&&n.app.$nextTick((function(){var a=function(){var n=ts();if(n)return os[n]}(),s=o.call(n,e,t,r?a:null);s&&("function"==typeof s.then?s.then((function(n){ms(n,a)})).catch((function(n){0})):ms(s,a))}))}}function is(){var n=ts();n&&(os[n]={x:window.pageXOffset,y:window.pageYOffset})}function ls(n){is(),n.state&&n.state.key&&rs(n.state.key)}function cs(n){return ds(n.x)||ds(n.y)}function ps(n){return{x:ds(n.x)?n.x:window.pageXOffset,y:ds(n.y)?n.y:window.pageYOffset}}function ds(n){return"number"==typeof n}var us=/^#\d/;function ms(n,e){var t,r="object"==typeof n;if(r&&"string"==typeof n.selector){var o=us.test(n.selector)?document.getElementById(n.selector.slice(1)):document.querySelector(n.selector);if(o){var a=n.offset&&"object"==typeof n.offset?n.offset:{};e=function(n,e){var t=document.documentElement.getBoundingClientRect(),r=n.getBoundingClientRect();return{x:r.left-t.left-e.x,y:r.top-t.top-e.y}}(o,a={x:ds((t=a).x)?t.x:0,y:ds(t.y)?t.y:0})}else cs(n)&&(e=ps(n))}else r&&cs(n)&&(e=ps(n));e&&("scrollBehavior"in document.documentElement.style?window.scrollTo({left:e.x,top:e.y,behavior:n.behavior}):window.scrollTo(e.x,e.y))}var gs,fs=Za&&((-1===(gs=window.navigator.userAgent).indexOf("Android 2.")&&-1===gs.indexOf("Android 4.0")||-1===gs.indexOf("Mobile Safari")||-1!==gs.indexOf("Chrome")||-1!==gs.indexOf("Windows Phone"))&&window.history&&"function"==typeof window.history.pushState);function hs(n,e){is();var t=window.history;try{if(e){var r=ra({},t.state);r.key=ts(),t.replaceState(r,"",n)}else t.pushState({key:rs(ns())},"",n)}catch(t){window.location[e?"replace":"assign"](n)}}function vs(n){hs(n,!0)}var bs={redirected:2,aborted:4,cancelled:8,duplicated:16};function _s(n,e){return ks(n,e,bs.redirected,'Redirected when going from "'+n.fullPath+'" to "'+function(n){if("string"==typeof n)return n;if("path"in n)return n.path;var e={};return ws.forEach((function(t){t in n&&(e[t]=n[t])})),JSON.stringify(e,null,2)}(e)+'" via a navigation guard.')}function ys(n,e){return ks(n,e,bs.cancelled,'Navigation cancelled from "'+n.fullPath+'" to "'+e.fullPath+'" with a new navigation.')}function ks(n,e,t,r){var o=new Error(r);return o._isRouter=!0,o.from=n,o.to=e,o.type=t,o}var ws=["params","query","hash"];function Es(n){return Object.prototype.toString.call(n).indexOf("Error")>-1}function xs(n,e){return Es(n)&&n._isRouter&&(null==e||n.type===e)}function As(n,e,t){var r=function(o){o>=n.length?t():n[o]?e(n[o],(function(){r(o+1)})):r(o+1)};r(0)}function Bs(n){return function(e,t,r){var o=!1,a=0,s=null;zs(n,(function(n,e,t,i){if("function"==typeof n&&void 0===n.cid){o=!0,a++;var l,c=Cs((function(e){var o;((o=e).__esModule||Ts&&"Module"===o[Symbol.toStringTag])&&(e=e.default),n.resolved="function"==typeof e?e:Va.extend(e),t.components[i]=e,--a<=0&&r()})),p=Cs((function(n){var e="Failed to resolve async component "+i+": "+n;s||(s=Es(n)?n:new Error(e),r(s))}));try{l=n(c,p)}catch(n){p(n)}if(l)if("function"==typeof l.then)l.then(c,p);else{var d=l.component;d&&"function"==typeof d.then&&d.then(c,p)}}})),o||r()}}function zs(n,e){return js(n.map((function(n){return Object.keys(n.components).map((function(t){return e(n.components[t],n.instances[t],n,t)}))})))}function js(n){return Array.prototype.concat.apply([],n)}var Ts="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag;function Cs(n){var e=!1;return function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];if(!e)return e=!0,n.apply(this,t)}}var Ss=function(n,e){this.router=n,this.base=function(n){if(!n)if(Za){var e=document.querySelector("base");n=(n=e&&e.getAttribute("href")||"/").replace(/^https?:\/\/[^\/]+/,"")}else n="/";"/"!==n.charAt(0)&&(n="/"+n);return n.replace(/\/$/,"")}(e),this.current=fa,this.pending=null,this.ready=!1,this.readyCbs=[],this.readyErrorCbs=[],this.errorCbs=[],this.listeners=[]};function Ps(n,e,t,r){var o=zs(n,(function(n,r,o,a){var s=function(n,e){"function"!=typeof n&&(n=Va.extend(n));return n.options[e]}(n,e);if(s)return Array.isArray(s)?s.map((function(n){return t(n,r,o,a)})):t(s,r,o,a)}));return js(r?o.reverse():o)}function Is(n,e){if(e)return function(){return n.apply(e,arguments)}}Ss.prototype.listen=function(n){this.cb=n},Ss.prototype.onReady=function(n,e){this.ready?n():(this.readyCbs.push(n),e&&this.readyErrorCbs.push(e))},Ss.prototype.onError=function(n){this.errorCbs.push(n)},Ss.prototype.transitionTo=function(n,e,t){var r,o=this;try{r=this.router.match(n,this.current)}catch(n){throw this.errorCbs.forEach((function(e){e(n)})),n}var a=this.current;this.confirmTransition(r,(function(){o.updateRoute(r),e&&e(r),o.ensureURL(),o.router.afterHooks.forEach((function(n){n&&n(r,a)})),o.ready||(o.ready=!0,o.readyCbs.forEach((function(n){n(r)})))}),(function(n){t&&t(n),n&&!o.ready&&(xs(n,bs.redirected)&&a===fa||(o.ready=!0,o.readyErrorCbs.forEach((function(e){e(n)}))))}))},Ss.prototype.confirmTransition=function(n,e,t){var r=this,o=this.current;this.pending=n;var a,s,i=function(n){!xs(n)&&Es(n)&&(r.errorCbs.length?r.errorCbs.forEach((function(e){e(n)})):console.error(n)),t&&t(n)},l=n.matched.length-1,c=o.matched.length-1;if(ba(n,o)&&l===c&&n.matched[l]===o.matched[c])return this.ensureURL(),n.hash&&ss(this.router,o,n,!1),i(((s=ks(a=o,n,bs.duplicated,'Avoided redundant navigation to current location: "'+a.fullPath+'".')).name="NavigationDuplicated",s));var p=function(n,e){var t,r=Math.max(n.length,e.length);for(t=0;t<r&&n[t]===e[t];t++);return{updated:e.slice(0,t),activated:e.slice(t),deactivated:n.slice(t)}}(this.current.matched,n.matched),d=p.updated,u=p.deactivated,m=p.activated,g=[].concat(function(n){return Ps(n,"beforeRouteLeave",Is,!0)}(u),this.router.beforeHooks,function(n){return Ps(n,"beforeRouteUpdate",Is)}(d),m.map((function(n){return n.beforeEnter})),Bs(m)),f=function(e,t){if(r.pending!==n)return i(ys(o,n));try{e(n,o,(function(e){!1===e?(r.ensureURL(!0),i(function(n,e){return ks(n,e,bs.aborted,'Navigation aborted from "'+n.fullPath+'" to "'+e.fullPath+'" via a navigation guard.')}(o,n))):Es(e)?(r.ensureURL(!0),i(e)):"string"==typeof e||"object"==typeof e&&("string"==typeof e.path||"string"==typeof e.name)?(i(_s(o,n)),"object"==typeof e&&e.replace?r.replace(e):r.push(e)):t(e)}))}catch(n){i(n)}};As(g,f,(function(){As(function(n){return Ps(n,"beforeRouteEnter",(function(n,e,t,r){return function(n,e,t){return function(r,o,a){return n(r,o,(function(n){"function"==typeof n&&(e.enteredCbs[t]||(e.enteredCbs[t]=[]),e.enteredCbs[t].push(n)),a(n)}))}}(n,t,r)}))}(m).concat(r.router.resolveHooks),f,(function(){if(r.pending!==n)return i(ys(o,n));r.pending=null,e(n),r.router.app&&r.router.app.$nextTick((function(){ya(n)}))}))}))},Ss.prototype.updateRoute=function(n){this.current=n,this.cb&&this.cb(n)},Ss.prototype.setupListeners=function(){},Ss.prototype.teardown=function(){this.listeners.forEach((function(n){n()})),this.listeners=[],this.current=fa,this.pending=null};var qs=function(n){function e(e,t){n.call(this,e,t),this._startLocation=Ds(this.base)}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.setupListeners=function(){var n=this;if(!(this.listeners.length>0)){var e=this.router,t=e.options.scrollBehavior,r=fs&&t;r&&this.listeners.push(as());var o=function(){var t=n.current,o=Ds(n.base);n.current===fa&&o===n._startLocation||n.transitionTo(o,(function(n){r&&ss(e,n,t,!0)}))};window.addEventListener("popstate",o),this.listeners.push((function(){window.removeEventListener("popstate",o)}))}},e.prototype.go=function(n){window.history.go(n)},e.prototype.push=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){hs(xa(r.base+n.fullPath)),ss(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.replace=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){vs(xa(r.base+n.fullPath)),ss(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.ensureURL=function(n){if(Ds(this.base)!==this.current.fullPath){var e=xa(this.base+this.current.fullPath);n?hs(e):vs(e)}},e.prototype.getCurrentLocation=function(){return Ds(this.base)},e}(Ss);function Ds(n){var e=window.location.pathname,t=e.toLowerCase(),r=n.toLowerCase();return!n||t!==r&&0!==t.indexOf(xa(r+"/"))||(e=e.slice(n.length)),(e||"/")+window.location.search+window.location.hash}var Ns=function(n){function e(e,t,r){n.call(this,e,t),r&&function(n){var e=Ds(n);if(!/^\/#/.test(e))return window.location.replace(xa(n+"/#"+e)),!0}(this.base)||Os()}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.setupListeners=function(){var n=this;if(!(this.listeners.length>0)){var e=this.router.options.scrollBehavior,t=fs&&e;t&&this.listeners.push(as());var r=function(){var e=n.current;Os()&&n.transitionTo(Rs(),(function(r){t&&ss(n.router,r,e,!0),fs||Us(r.fullPath)}))},o=fs?"popstate":"hashchange";window.addEventListener(o,r),this.listeners.push((function(){window.removeEventListener(o,r)}))}},e.prototype.push=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){Ls(n.fullPath),ss(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.replace=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){Us(n.fullPath),ss(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.go=function(n){window.history.go(n)},e.prototype.ensureURL=function(n){var e=this.current.fullPath;Rs()!==e&&(n?Ls(e):Us(e))},e.prototype.getCurrentLocation=function(){return Rs()},e}(Ss);function Os(){var n=Rs();return"/"===n.charAt(0)||(Us("/"+n),!1)}function Rs(){var n=window.location.href,e=n.indexOf("#");return e<0?"":n=n.slice(e+1)}function Fs(n){var e=window.location.href,t=e.indexOf("#");return(t>=0?e.slice(0,t):e)+"#"+n}function Ls(n){fs?hs(Fs(n)):window.location.hash=n}function Us(n){fs?vs(Fs(n)):window.location.replace(Fs(n))}var Ms=function(n){function e(e,t){n.call(this,e,t),this.stack=[],this.index=-1}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.push=function(n,e,t){var r=this;this.transitionTo(n,(function(n){r.stack=r.stack.slice(0,r.index+1).concat(n),r.index++,e&&e(n)}),t)},e.prototype.replace=function(n,e,t){var r=this;this.transitionTo(n,(function(n){r.stack=r.stack.slice(0,r.index).concat(n),e&&e(n)}),t)},e.prototype.go=function(n){var e=this,t=this.index+n;if(!(t<0||t>=this.stack.length)){var r=this.stack[t];this.confirmTransition(r,(function(){var n=e.current;e.index=t,e.updateRoute(r),e.router.afterHooks.forEach((function(e){e&&e(r,n)}))}),(function(n){xs(n,bs.duplicated)&&(e.index=t)}))}},e.prototype.getCurrentLocation=function(){var n=this.stack[this.stack.length-1];return n?n.fullPath:"/"},e.prototype.ensureURL=function(){},e}(Ss),Gs=function(n){void 0===n&&(n={}),this.app=null,this.apps=[],this.options=n,this.beforeHooks=[],this.resolveHooks=[],this.afterHooks=[],this.matcher=Ja(n.routes||[],this);var e=n.mode||"hash";switch(this.fallback="history"===e&&!fs&&!1!==n.fallback,this.fallback&&(e="hash"),Za||(e="abstract"),this.mode=e,e){case"history":this.history=new qs(this,n.base);break;case"hash":this.history=new Ns(this,n.base,this.fallback);break;case"abstract":this.history=new Ms(this,n.base);break;default:0}},Vs={currentRoute:{configurable:!0}};Gs.prototype.match=function(n,e,t){return this.matcher.match(n,e,t)},Vs.currentRoute.get=function(){return this.history&&this.history.current},Gs.prototype.init=function(n){var e=this;if(this.apps.push(n),n.$once("hook:destroyed",(function(){var t=e.apps.indexOf(n);t>-1&&e.apps.splice(t,1),e.app===n&&(e.app=e.apps[0]||null),e.app||e.history.teardown()})),!this.app){this.app=n;var t=this.history;if(t instanceof qs||t instanceof Ns){var r=function(n){t.setupListeners(),function(n){var r=t.current,o=e.options.scrollBehavior;fs&&o&&"fullPath"in n&&ss(e,n,r,!1)}(n)};t.transitionTo(t.getCurrentLocation(),r,r)}t.listen((function(n){e.apps.forEach((function(e){e._route=n}))}))}},Gs.prototype.beforeEach=function(n){return Ws(this.beforeHooks,n)},Gs.prototype.beforeResolve=function(n){return Ws(this.resolveHooks,n)},Gs.prototype.afterEach=function(n){return Ws(this.afterHooks,n)},Gs.prototype.onReady=function(n,e){this.history.onReady(n,e)},Gs.prototype.onError=function(n){this.history.onError(n)},Gs.prototype.push=function(n,e,t){var r=this;if(!e&&!t&&"undefined"!=typeof Promise)return new Promise((function(e,t){r.history.push(n,e,t)}));this.history.push(n,e,t)},Gs.prototype.replace=function(n,e,t){var r=this;if(!e&&!t&&"undefined"!=typeof Promise)return new Promise((function(e,t){r.history.replace(n,e,t)}));this.history.replace(n,e,t)},Gs.prototype.go=function(n){this.history.go(n)},Gs.prototype.back=function(){this.go(-1)},Gs.prototype.forward=function(){this.go(1)},Gs.prototype.getMatchedComponents=function(n){var e=n?n.matched?n:this.resolve(n).route:this.currentRoute;return e?[].concat.apply([],e.matched.map((function(n){return Object.keys(n.components).map((function(e){return n.components[e]}))}))):[]},Gs.prototype.resolve=function(n,e,t){var r=Ga(n,e=e||this.history.current,t,this),o=this.match(r,e),a=o.redirectedFrom||o.fullPath;return{location:r,route:o,href:function(n,e,t){var r="hash"===t?"#"+e:e;return n?xa(n+"/"+r):r}(this.history.base,a,this.mode),normalizedTo:r,resolved:o}},Gs.prototype.getRoutes=function(){return this.matcher.getRoutes()},Gs.prototype.addRoute=function(n,e){this.matcher.addRoute(n,e),this.history.current!==fa&&this.history.transitionTo(this.history.getCurrentLocation())},Gs.prototype.addRoutes=function(n){this.matcher.addRoutes(n),this.history.current!==fa&&this.history.transitionTo(this.history.getCurrentLocation())},Object.defineProperties(Gs.prototype,Vs);var $s=Gs;function Ws(n,e){return n.push(e),function(){var t=n.indexOf(e);t>-1&&n.splice(t,1)}}Gs.install=function n(e){if(!n.installed||Va!==e){n.installed=!0,Va=e;var t=function(n){return void 0!==n},r=function(n,e){var r=n.$options._parentVnode;t(r)&&t(r=r.data)&&t(r=r.registerRouteInstance)&&r(n,e)};e.mixin({beforeCreate:function(){t(this.$options.router)?(this._routerRoot=this,this._router=this.$options.router,this._router.init(this),e.util.defineReactive(this,"_route",this._router.history.current)):this._routerRoot=this.$parent&&this.$parent._routerRoot||this,r(this,this)},destroyed:function(){r(this)}}),Object.defineProperty(e.prototype,"$router",{get:function(){return this._routerRoot._router}}),Object.defineProperty(e.prototype,"$route",{get:function(){return this._routerRoot._route}}),e.component("RouterView",ka),e.component("RouterLink",Wa);var o=e.config.optionMergeStrategies;o.beforeRouteEnter=o.beforeRouteLeave=o.beforeRouteUpdate=o.created}},Gs.version="3.6.5",Gs.isNavigationFailure=xs,Gs.NavigationFailureType=bs,Gs.START_LOCATION=fa,Za&&window.Vue&&window.Vue.use(Gs);t(154),t(17),t(164);t(165),t(31);var Hs={NotFound:()=>Promise.all([t.e(0),t.e(4)]).then(t.bind(null,363)),Layout:()=>Promise.all([t.e(0),t.e(2)]).then(t.bind(null,362))},Zs={"v-f7879d60":()=>t.e(8).then(t.bind(null,365)),"v-6f7bb862":()=>t.e(10).then(t.bind(null,366)),"v-08a8939a":()=>t.e(9).then(t.bind(null,367)),"v-29274a29":()=>t.e(12).then(t.bind(null,368)),"v-44df3b79":()=>t.e(13).then(t.bind(null,369)),"v-6430d054":()=>t.e(11).then(t.bind(null,370)),"v-341f9276":()=>t.e(14).then(t.bind(null,371)),"v-ba5a65c4":()=>t.e(15).then(t.bind(null,372)),"v-64f910e0":()=>t.e(6).then(t.bind(null,373)),"v-3ff5ce46":()=>t.e(16).then(t.bind(null,374)),"v-470b5455":()=>t.e(7).then(t.bind(null,375)),"v-411a2b26":()=>t.e(17).then(t.bind(null,376)),"v-14bd5c2a":()=>t.e(18).then(t.bind(null,377)),"v-0ee080d4":()=>t.e(20).then(t.bind(null,378)),"v-9fc226e2":()=>t.e(19).then(t.bind(null,379)),"v-c31c1604":()=>t.e(22).then(t.bind(null,380)),"v-476540fe":()=>t.e(21).then(t.bind(null,381)),"v-38f161f6":()=>t.e(24).then(t.bind(null,382)),"v-44e743b8":()=>t.e(23).then(t.bind(null,383)),"v-2f20c458":()=>t.e(25).then(t.bind(null,384)),"v-e543b750":()=>t.e(27).then(t.bind(null,385)),"v-3c54c66f":()=>t.e(26).then(t.bind(null,386)),"v-7c3ad306":()=>t.e(28).then(t.bind(null,387)),"v-5793b4fb":()=>t.e(29).then(t.bind(null,388)),"v-967c62b6":()=>t.e(30).then(t.bind(null,389)),"v-097050d4":()=>t.e(31).then(t.bind(null,390)),"v-2ecc148c":()=>t.e(32).then(t.bind(null,391)),"v-278df89e":()=>t.e(33).then(t.bind(null,392)),"v-61296d7f":()=>t.e(34).then(t.bind(null,393)),"v-be37f416":()=>t.e(35).then(t.bind(null,394)),"v-ae93950e":()=>t.e(36).then(t.bind(null,395)),"v-834e066a":()=>t.e(37).then(t.bind(null,396)),"v-b9336fc4":()=>t.e(39).then(t.bind(null,397)),"v-300c8022":()=>t.e(40).then(t.bind(null,398)),"v-450eddde":()=>t.e(38).then(t.bind(null,399)),"v-ed00c198":()=>t.e(42).then(t.bind(null,400)),"v-06e111a1":()=>t.e(41).then(t.bind(null,401)),"v-e35e3500":()=>t.e(44).then(t.bind(null,402)),"v-a7079bc2":()=>t.e(45).then(t.bind(null,403)),"v-da2a3b40":()=>t.e(43).then(t.bind(null,404)),"v-3644af7a":()=>t.e(46).then(t.bind(null,405)),"v-6fc4dda8":()=>t.e(48).then(t.bind(null,406)),"v-dea92c98":()=>t.e(47).then(t.bind(null,407)),"v-a6f8fe8c":()=>t.e(50).then(t.bind(null,408)),"v-cf78fd3a":()=>t.e(51).then(t.bind(null,409)),"v-3599af91":()=>t.e(52).then(t.bind(null,410)),"v-3e233877":()=>t.e(49).then(t.bind(null,411)),"v-628321a6":()=>t.e(54).then(t.bind(null,412)),"v-77d8c9f4":()=>t.e(55).then(t.bind(null,413)),"v-226be104":()=>t.e(53).then(t.bind(null,414)),"v-22b0df18":()=>t.e(56).then(t.bind(null,415)),"v-fab79492":()=>t.e(57).then(t.bind(null,416)),"v-fab7554a":()=>t.e(58).then(t.bind(null,417)),"v-15cbdfc3":()=>t.e(59).then(t.bind(null,418)),"v-74cd7d9e":()=>t.e(60).then(t.bind(null,419)),"v-37cf929d":()=>t.e(61).then(t.bind(null,420)),"v-40dce165":()=>t.e(62).then(t.bind(null,421)),"v-722217eb":()=>t.e(63).then(t.bind(null,422)),"v-224b6ec4":()=>t.e(64).then(t.bind(null,423)),"v-73bfa208":()=>t.e(67).then(t.bind(null,424)),"v-9c48962a":()=>t.e(66).then(t.bind(null,425)),"v-ff2c286e":()=>t.e(65).then(t.bind(null,426)),"v-364f49b5":()=>t.e(68).then(t.bind(null,427)),"v-2f2878f8":()=>t.e(69).then(t.bind(null,428)),"v-33efde74":()=>t.e(70).then(t.bind(null,429)),"v-5000cd97":()=>t.e(71).then(t.bind(null,430)),"v-fad5dda8":()=>t.e(72).then(t.bind(null,431)),"v-7f082a66":()=>t.e(73).then(t.bind(null,432)),"v-4371bf05":()=>t.e(75).then(t.bind(null,433)),"v-13f4cf5a":()=>t.e(74).then(t.bind(null,434)),"v-ba59602c":()=>t.e(76).then(t.bind(null,435)),"v-4edff9fd":()=>t.e(77).then(t.bind(null,436)),"v-69c6394c":()=>t.e(79).then(t.bind(null,437)),"v-3d85724c":()=>t.e(78).then(t.bind(null,438)),"v-465edabc":()=>t.e(80).then(t.bind(null,439)),"v-2afdd346":()=>t.e(81).then(t.bind(null,440)),"v-2f3e170c":()=>t.e(82).then(t.bind(null,441)),"v-66d9b7c0":()=>t.e(84).then(t.bind(null,442)),"v-569242f6":()=>t.e(83).then(t.bind(null,443)),"v-deed5aca":()=>t.e(86).then(t.bind(null,444)),"v-2835a650":()=>t.e(85).then(t.bind(null,445)),"v-1c8f04f0":()=>t.e(87).then(t.bind(null,446)),"v-e7a69188":()=>t.e(88).then(t.bind(null,447)),"v-2bccd8fe":()=>t.e(89).then(t.bind(null,448)),"v-6dda71f1":()=>t.e(90).then(t.bind(null,449)),"v-ccb4316a":()=>t.e(91).then(t.bind(null,450)),"v-3b2ad750":()=>t.e(92).then(t.bind(null,451)),"v-d6123402":()=>t.e(94).then(t.bind(null,452)),"v-1ba8c576":()=>t.e(95).then(t.bind(null,453)),"v-3ff27440":()=>t.e(93).then(t.bind(null,454)),"v-99455fdc":()=>t.e(96).then(t.bind(null,455)),"v-7f2a6202":()=>t.e(97).then(t.bind(null,456)),"v-26efa3da":()=>t.e(98).then(t.bind(null,457)),"v-32e66a02":()=>t.e(100).then(t.bind(null,458)),"v-5973e693":()=>t.e(99).then(t.bind(null,459)),"v-7e9794a8":()=>t.e(102).then(t.bind(null,460)),"v-7accfee0":()=>t.e(103).then(t.bind(null,461)),"v-23857ed1":()=>t.e(101).then(t.bind(null,462)),"v-48a6492a":()=>t.e(104).then(t.bind(null,463)),"v-38488cef":()=>t.e(105).then(t.bind(null,464)),"v-602416af":()=>t.e(106).then(t.bind(null,465)),"v-c5fbc8ae":()=>t.e(107).then(t.bind(null,364)),"v-fe55c380":()=>t.e(108).then(t.bind(null,466)),"v-67feae3c":()=>t.e(109).then(t.bind(null,467)),"v-31af7045":()=>t.e(110).then(t.bind(null,468)),"v-36a595c5":()=>t.e(112).then(t.bind(null,469)),"v-1e8d1344":()=>t.e(113).then(t.bind(null,470)),"v-5cc30ba5":()=>t.e(111).then(t.bind(null,471))};function Ks(n){const e=Object.create(null);return function(t){return e[t]||(e[t]=n(t))}}const Xs=/-(\w)/g,Js=Ks(n=>n.replace(Xs,(n,e)=>e?e.toUpperCase():"")),Ys=/\B([A-Z])/g,Qs=Ks(n=>n.replace(Ys,"-$1").toLowerCase()),ni=Ks(n=>n.charAt(0).toUpperCase()+n.slice(1));function ei(n,e){if(!e)return;if(n(e))return n(e);return e.includes("-")?n(ni(Js(e))):n(ni(e))||n(Qs(e))}const ti=Object.assign({},Hs,Zs),ri=n=>ti[n],oi=n=>Zs[n],ai=n=>Hs[n],si=n=>Ht.component(n);function ii(n){return ei(oi,n)}function li(n){return ei(ai,n)}function ci(n){return ei(ri,n)}function pi(n){return ei(si,n)}function di(...n){return Promise.all(n.filter(n=>n).map(async n=>{if(!pi(n)&&ci(n)){const e=await ci(n)();Ht.component(n,e.default)}}))}function ui(n,e){"undefined"!=typeof window&&window.__VUEPRESS__&&(window.__VUEPRESS__[n]=e)}var mi=t(123),gi=t.n(mi),fi=t(124),hi=t.n(fi),vi={created(){if(this.siteMeta=this.$site.headTags.filter(([n])=>"meta"===n).map(([n,e])=>e),this.$ssrContext){const e=this.getMergedMetaTags();this.$ssrContext.title=this.$title,this.$ssrContext.lang=this.$lang,this.$ssrContext.pageMeta=(n=e)?n.map(n=>{let e="<meta";return Object.keys(n).forEach(t=>{e+=` ${t}="${hi()(n[t])}"`}),e+">"}).join("\n    "):"",this.$ssrContext.canonicalLink=_i(this.$canonicalUrl)}var n},mounted(){this.currentMetaTags=[...document.querySelectorAll("meta")],this.updateMeta(),this.updateCanonicalLink()},methods:{updateMeta(){document.title=this.$title,document.documentElement.lang=this.$lang;const n=this.getMergedMetaTags();this.currentMetaTags=yi(n,this.currentMetaTags)},getMergedMetaTags(){const n=this.$page.frontmatter.meta||[];return gi()([{name:"description",content:this.$description}],n,this.siteMeta,ki)},updateCanonicalLink(){bi(),this.$canonicalUrl&&document.head.insertAdjacentHTML("beforeend",_i(this.$canonicalUrl))}},watch:{$page(){this.updateMeta(),this.updateCanonicalLink()}},beforeDestroy(){yi(null,this.currentMetaTags),bi()}};function bi(){const n=document.querySelector("link[rel='canonical']");n&&n.remove()}function _i(n=""){return n?`<link href="${n}" rel="canonical" />`:""}function yi(n,e){if(e&&[...e].filter(n=>n.parentNode===document.head).forEach(n=>document.head.removeChild(n)),n)return n.map(n=>{const e=document.createElement("meta");return Object.keys(n).forEach(t=>{e.setAttribute(t,n[t])}),document.head.appendChild(e),e})}function ki(n){for(const e of["name","property","itemprop"])if(n.hasOwnProperty(e))return n[e]+e;return JSON.stringify(n)}t(66);var wi=t(68),Ei={mounted(){window.addEventListener("scroll",this.onScroll)},methods:{onScroll:t.n(wi)()((function(){this.setActiveHash()}),300),setActiveHash(){const n=[].slice.call(document.querySelectorAll(".sidebar-link")),e=[].slice.call(document.querySelectorAll(".header-anchor")).filter(e=>n.some(n=>n.hash===e.hash)),t=Math.max(window.pageYOffset,document.documentElement.scrollTop,document.body.scrollTop),r=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight),o=window.innerHeight+t;for(let n=0;n<e.length;n++){const a=e[n],s=e[n+1],i=0===n&&0===t||t>=a.parentElement.offsetTop+10&&(!s||t<s.parentElement.offsetTop-10),l=decodeURIComponent(this.$route.hash);if(i&&l!==decodeURIComponent(a.hash)){const t=a;if(o===r)for(let t=n+1;t<e.length;t++)if(l===decodeURIComponent(e[t].hash))return;return this.$vuepress.$set("disableScrollBehavior",!0),void this.$router.replace(decodeURIComponent(t.hash),()=>{this.$nextTick(()=>{this.$vuepress.$set("disableScrollBehavior",!1)})})}}}},beforeDestroy(){window.removeEventListener("scroll",this.onScroll)}},xi=t(45),Ai=t.n(xi),Bi={mounted(){Ai.a.configure({showSpinner:!1}),this.$router.beforeEach((n,e,t)=>{n.path===e.path||Ht.component(n.name)||Ai.a.start(),t()}),this.$router.afterEach(()=>{Ai.a.done(),this.isSidebarOpen=!1})}};t(275),t(276);class zi{constructor(){this.containerEl=document.getElementById("message-container"),this.containerEl||(this.containerEl=document.createElement("div"),this.containerEl.id="message-container",document.body.appendChild(this.containerEl))}show({text:n="",duration:e=3e3}){let t=document.createElement("div");t.className="message move-in",t.innerHTML=`\n      <i style="fill: #06a35a;font-size: 14px;display:inline-flex;align-items: center;">\n        <svg style="fill: #06a35a;font-size: 14px;" t="1572421810237" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2323" width="16" height="16"><path d="M822.811993 824.617989c-83.075838 81.99224-188.546032 124.613757-316.049383 127.86455-122.085362-3.250794-223.943563-45.87231-305.935802-127.86455s-124.613757-184.21164-127.86455-305.935802c3.250794-127.503351 45.87231-232.973545 127.86455-316.049383 81.99224-83.075838 184.21164-126.058554 305.935802-129.309347 127.503351 3.250794 232.973545 46.23351 316.049383 129.309347 83.075838 83.075838 126.058554 188.546032 129.309347 316.049383C949.231746 640.406349 905.887831 742.62575 822.811993 824.617989zM432.716755 684.111464c3.973192 3.973192 8.307584 5.779189 13.364374 6.140388 5.05679 0.361199 9.752381-1.444797 13.364374-5.417989l292.571429-287.514638c3.973192-3.973192 5.779189-8.307584 5.779189-13.364374 0-5.05679-1.805996-9.752381-5.779189-13.364374l1.805996 1.805996c-3.973192-3.973192-8.668783-5.779189-14.086772-6.140388-5.417989-0.361199-10.47478 1.444797-14.809171 5.417989l-264.397884 220.33157c-3.973192 3.250794-8.668783 4.695591-14.447972 4.695591-5.779189 0-10.835979-1.444797-15.53157-3.973192l-94.273016-72.962257c-4.334392-3.250794-9.391182-4.334392-14.447972-3.973192s-9.391182 3.250794-12.641975 7.585185l-2.889594 3.973192c-3.250794 4.334392-4.334392 9.391182-3.973192 14.809171 0.722399 5.417989 2.528395 10.11358 5.779189 14.086772L432.716755 684.111464z" p-id="2324"></path></svg>\n      </i>\n      <div class="text">${n}</div>\n    `,this.containerEl.appendChild(t),e>0&&setTimeout(()=>{this.close(t)},e)}close(n){n.className=n.className.replace("move-in",""),n.className+="move-out",n.addEventListener("animationend",()=>{n.remove()})}}var ji={mounted(){!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||this.updateCopy()},updated(){!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||this.updateCopy()},methods:{updateCopy(){setTimeout(()=>{(['div[class*="language-"] pre','div[class*="aside-code"] aside']instanceof Array||Array.isArray(['div[class*="language-"] pre','div[class*="aside-code"] aside']))&&['div[class*="language-"] pre','div[class*="aside-code"] aside'].forEach(n=>{document.querySelectorAll(n).forEach(this.generateCopyButton)})},1e3)},generateCopyButton(n){if(n.classList.contains("codecopy-enabled"))return;const e=document.createElement("i");e.className="code-copy",e.innerHTML='<svg  style="color:#aaa;font-size:14px" t="1572422231464" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3201" width="14" height="14"><path d="M866.461538 39.384615H354.461538c-43.323077 0-78.769231 35.446154-78.76923 78.769231v39.384616h472.615384c43.323077 0 78.769231 35.446154 78.769231 78.76923v551.384616h39.384615c43.323077 0 78.769231-35.446154 78.769231-78.769231V118.153846c0-43.323077-35.446154-78.769231-78.769231-78.769231z m-118.153846 275.692308c0-43.323077-35.446154-78.769231-78.76923-78.769231H157.538462c-43.323077 0-78.769231 35.446154-78.769231 78.769231v590.769231c0 43.323077 35.446154 78.769231 78.769231 78.769231h512c43.323077 0 78.769231-35.446154 78.76923-78.769231V315.076923z m-354.461538 137.846154c0 11.815385-7.876923 19.692308-19.692308 19.692308h-157.538461c-11.815385 0-19.692308-7.876923-19.692308-19.692308v-39.384615c0-11.815385 7.876923-19.692308 19.692308-19.692308h157.538461c11.815385 0 19.692308 7.876923 19.692308 19.692308v39.384615z m157.538461 315.076923c0 11.815385-7.876923 19.692308-19.692307 19.692308H216.615385c-11.815385 0-19.692308-7.876923-19.692308-19.692308v-39.384615c0-11.815385 7.876923-19.692308 19.692308-19.692308h315.076923c11.815385 0 19.692308 7.876923 19.692307 19.692308v39.384615z m78.769231-157.538462c0 11.815385-7.876923 19.692308-19.692308 19.692308H216.615385c-11.815385 0-19.692308-7.876923-19.692308-19.692308v-39.384615c0-11.815385 7.876923-19.692308 19.692308-19.692308h393.846153c11.815385 0 19.692308 7.876923 19.692308 19.692308v39.384615z" p-id="3202"></path></svg>',e.title="Copy to clipboard",e.addEventListener("click",()=>{this.copyToClipboard(n.innerText)}),n.appendChild(e),n.classList.add("codecopy-enabled")},copyToClipboard(n){const e=document.createElement("textarea");e.value=n,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e);const t=document.getSelection().rangeCount>0&&document.getSelection().getRangeAt(0);e.select(),document.execCommand("copy");(new zi).show({text:"å¤å¶æå",duration:1e3}),document.body.removeChild(e),t&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(t))}}};!function(n,e){void 0===e&&(e={});var t=e.insertAt;if(n&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===t&&r.firstChild?r.insertBefore(o,r.firstChild):r.appendChild(o),o.styleSheet?o.styleSheet.cssText=n:o.appendChild(document.createTextNode(n))}}("@media (max-width: 1000px) {\n  .vuepress-plugin-demo-block__h_code {\n    display: none;\n  }\n  .vuepress-plugin-demo-block__app {\n    margin-left: auto !important;\n    margin-right: auto !important;\n  }\n}\n.vuepress-plugin-demo-block__wrapper {\n  margin-top: 10px;\n  border: 1px solid #ebebeb;\n  border-radius: 4px;\n  transition: all 0.2s;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display {\n  height: 400px;\n  display: flex;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display .vuepress-plugin-demo-block__app {\n  width: 300px;\n  border: 1px solid #ebebeb;\n  box-shadow: 1px 1px 3px #ebebeb;\n  margin-right: 5px;\n  overflow: auto;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display .vuepress-plugin-demo-block__h_code {\n  flex: 1;\n  overflow: auto;\n  height: 100%;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display .vuepress-plugin-demo-block__h_code > pre {\n  overflow: visible;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__display {\n  max-height: 400px;\n  overflow: auto;\n}\n.vuepress-plugin-demo-block__wrapper div {\n  box-sizing: border-box;\n}\n.vuepress-plugin-demo-block__wrapper:hover {\n  box-shadow: 0 0 11px rgba(33, 33, 33, 0.2);\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__code {\n  overflow: hidden;\n  height: 0;\n  padding: 0 !important;\n  background-color: #282c34;\n  border-radius: 0 !important;\n  transition: height 0.5s;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__code pre {\n  margin: 0 !important;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__display {\n  padding: 20px;\n  border-bottom: 1px solid #ebebeb;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer {\n  position: relative;\n  text-align: center;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer.vuepress-plugin-demo-block__show-link .vuepress-plugin-demo-block__jsfiddle,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer.vuepress-plugin-demo-block__show-link .vuepress-plugin-demo-block__codepen {\n  opacity: 1;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer.vuepress-plugin-demo-block__show-link .vuepress-plugin-demo-block__expand::before {\n  border-top: none;\n  border-right: 6px solid transparent;\n  border-bottom: 6px solid #ccc;\n  border-left: 6px solid transparent;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__jsfiddle,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__codepen,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__expand span,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__expand {\n  opacity: 1;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__expand::before {\n  border-top-color: #3eaf7c !important;\n  border-bottom-color: #3eaf7c !important;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover svg {\n  fill: #3eaf7c !important;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__expand-text {\n  transition: all 0.5s;\n  opacity: 0;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer form:nth-last-child(2) {\n  right: 50px;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer form:last-child {\n  right: 10px;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button {\n  border-color: transparent;\n  background-color: transparent;\n  font-size: 14px;\n  color: #3eaf7c;\n  cursor: pointer;\n  outline: none;\n  margin: 0;\n  width: 46px;\n  position: relative;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button:hover::before {\n  content: attr(data-tip);\n  white-space: nowrap;\n  position: absolute;\n  top: -30px;\n  left: 50%;\n  color: #eee;\n  line-height: 1;\n  z-index: 1000;\n  border-radius: 4px;\n  padding: 6px;\n  -webkit-transform: translateX(-50%);\n          transform: translateX(-50%);\n  background-color: rgba(0, 0, 0, 0.8);\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button:hover::after {\n  content: '' !important;\n  display: block;\n  position: absolute;\n  left: 50%;\n  top: -5px;\n  -webkit-transform: translateX(-50%);\n          transform: translateX(-50%);\n  border: 5px solid transparent;\n  border-top-color: rgba(0, 0, 0, 0.8);\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button svg {\n  width: 34px;\n  height: 20px;\n  fill: #ccc;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__jsfiddle,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__codepen {\n  position: absolute;\n  top: 10px;\n  transition: all 0.5s;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__expand {\n  position: relative;\n  width: 100px;\n  height: 40px;\n  margin: 0;\n  color: #3eaf7c;\n  font-size: 14px;\n  background-color: transparent;\n  border-color: transparent;\n  outline: none;\n  transition: all 0.5s;\n  cursor: pointer;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__expand::before {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 0;\n  height: 0;\n  border-top: 6px solid #ccc;\n  border-right: 6px solid transparent;\n  border-left: 6px solid transparent;\n  -webkit-transform: translate(-50%, -50%);\n          transform: translate(-50%, -50%);\n}\n");var Ti={jsLib:[],cssLib:[],jsfiddle:!0,codepen:!0,codepenLayout:"left",codepenJsProcessor:"babel",codepenEditors:"101",horizontal:!1,vue:"https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js",react:"https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js",reactDOM:"https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"},Ci={},Si=function(n){return'<div id="app">\n'.concat(n,"\n</div>")},Pi=function(n){return window.$VUEPRESS_DEMO_BLOCK&&void 0!==window.$VUEPRESS_DEMO_BLOCK[n]?window.$VUEPRESS_DEMO_BLOCK[n]:Ti[n]},Ii=function n(e,t,r){var o=document.createElement(e);return t&&Object.keys(t).forEach((function(n){if(n.indexOf("data"))o[n]=t[n];else{var e=n.replace("data","");o.dataset[e]=t[n]}})),r&&r.forEach((function(e){var t=e.tag,r=e.attrs,a=e.children;o.appendChild(n(t,r,a))})),o},qi=function(n,e,t){var r,o=(r=n.querySelectorAll(".".concat(e)),Array.prototype.slice.call(r));return 1!==o.length||t?o:o[0]},Di=function(n,e){var t,r,o=n.match(/<style>([\s\S]+)<\/style>/),a=n.match(/<template>([\s\S]+)<\/template>/),s=n.match(/<script>([\s\S]+)<\/script>/),i={css:o&&o[1].replace(/^\n|\n$/g,""),html:a&&a[1].replace(/^\n|\n$/g,""),js:s&&s[1].replace(/^\n|\n$/g,""),jsLib:e.jsLib||[],cssLib:e.cssLib||[]};i.htmlTpl=Si(i.html),i.jsTpl=(t=i.js,r=t.replace(/export\s+default\s*?\{\n*/,"").replace(/\n*\}\s*$/,"").trim(),"new Vue({\n  el: '#app',\n  ".concat(r,"\n})")),i.script=function(n,e){var t=n.split(/export\s+default/),r="(function() {".concat(t[0]," ; return ").concat(t[1],"})()"),o=window.Babel?window.Babel.transform(r,{presets:["es2015"]}).code:r,a=[eval][0](o);return a.template=e,a}(i.js,i.html);var l=Pi("vue");return i.jsLib.unshift(l),i},Ni=function(n,e){var t,r=n.match(/<style>([\s\S]+)<\/style>/),o=n.match(/<html>([\s\S]+)<\/html>/),a=n.match(/<script>([\s\S]+)<\/script>/),s={css:r&&r[1].replace(/^\n|\n$/g,""),html:o&&o[1].replace(/^\n|\n$/g,""),js:a&&a[1].replace(/^\n|\n$/g,""),jsLib:e.jsLib||[],cssLib:e.cssLib||[]};return s.htmlTpl=s.html,s.jsTpl=s.js,s.script=(t=s.js,window.Babel?window.Babel.transform(t,{presets:["es2015"]}).code:t),s},Oi=function(n){return n=n.replace("export default ","").replace(/App\.__style__(\s*)=(\s*)`([\s\S]*)?`/,""),n+='ReactDOM.render(React.createElement(App), document.getElementById("app"))'};function Ri(){var n=qi(document,"vuepress-plugin-demo-block__wrapper",!0);n.length?n.forEach((function(n){if("true"!==n.dataset.created){n.style.display="block";var e=qi(n,"vuepress-plugin-demo-block__code"),t=qi(n,"vuepress-plugin-demo-block__display"),r=qi(n,"vuepress-plugin-demo-block__footer"),o=qi(t,"vuepress-plugin-demo-block__app"),a=decodeURIComponent(n.dataset.code),s=decodeURIComponent(n.dataset.config),i=decodeURIComponent(n.dataset.type);s=s?JSON.parse(s):{};var l=e.querySelector("div").clientHeight,c="react"===i?function(n,e){var t=(0,window.Babel.transform)(n,{presets:["es2015","react"]}).code,r="(function(exports){var module={};module.exports=exports;".concat(t,";return module.exports.__esModule?module.exports.default:module.exports;})({})"),o=new Function("return ".concat(r))(),a={js:o,css:o.__style__||"",jsLib:e.jsLib||[],cssLib:e.cssLib||[],jsTpl:Oi(n),htmlTpl:Si("")},s=Pi("react"),i=Pi("reactDOM");return a.jsLib.unshift(s,i),a}(a,s):"vanilla"===i?Ni(a,s):Di(a,s),p=Ii("button",{className:"".concat("vuepress-plugin-demo-block__expand")});if(r.appendChild(p),p.addEventListener("click",Fi.bind(null,p,l,e,r)),Pi("jsfiddle")&&r.appendChild(function(n){var e=n.css,t=n.htmlTpl,r=n.jsTpl,o=n.jsLib,a=n.cssLib,s=o.concat(a).concat(Pi("cssLib")).concat(Pi("jsLib")).join(",");return Ii("form",{className:"vuepress-plugin-demo-block__jsfiddle",target:"_blank",action:"https://jsfiddle.net/api/post/library/pure/",method:"post"},[{tag:"input",attrs:{type:"hidden",name:"css",value:e}},{tag:"input",attrs:{type:"hidden",name:"html",value:t}},{tag:"input",attrs:{type:"hidden",name:"js",value:r}},{tag:"input",attrs:{type:"hidden",name:"panel_js",value:3}},{tag:"input",attrs:{type:"hidden",name:"wrap",value:1}},{tag:"input",attrs:{type:"hidden",name:"resources",value:s}},{tag:"button",attrs:{type:"submit",className:"vuepress-plugin-demo-block__button",innerHTML:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1547088289967" class="icon" style="" viewBox="0 0 1170 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1952" xmlns:xlink="http://www.w3.org/1999/xlink" width="228.515625" height="200"><defs><style type="text/css"></style></defs><path d="M1028.571429 441.142857q63.428571 26.285714 102.571428 83.142857T1170.285714 650.857143q0 93.714286-67.428571 160.285714T940 877.714286q-2.285714 0-6.571429-0.285715t-6-0.285714H232q-97.142857-5.714286-164.571429-71.714286T0 645.142857q0-62.857143 31.428571-116t84-84q-6.857143-22.285714-6.857142-46.857143 0-65.714286 46.857142-112t113.714286-46.285714q54.285714 0 98.285714 33.142857 42.857143-88 127.142858-141.714286t186.571428-53.714285q94.857143 0 174.857143 46T982.571429 248.571429t46.571428 172q0 3.428571-0.285714 10.285714t-0.285714 10.285714zM267.428571 593.142857q0 69.714286 48 110.285714t118.857143 40.571429q78.285714 0 137.142857-56.571429-9.142857-11.428571-27.142857-32.285714T519.428571 626.285714q-38.285714 37.142857-82.285714 37.142857-31.428571 0-53.428571-19.142857T361.714286 594.285714q0-30.285714 22-49.714285t52.285714-19.428572q25.142857 0 48.285714 12t41.714286 31.428572 37.142857 42.857142 39.428572 46.857143 44 42.857143 55.428571 31.428572 69.428571 12q69.142857 0 116.857143-40.857143T936 594.857143q0-69.142857-48-109.714286t-118.285714-40.571428q-81.714286 0-137.714286 55.428571l53.142857 61.714286q37.714286-36.571429 81.142857-36.571429 29.714286 0 52.571429 18.857143t22.857143 48q0 32.571429-21.142857 52.285714t-53.714286 19.714286q-24.571429 0-47.142857-12t-41.142857-31.428571-37.428572-42.857143-39.714286-46.857143-44.285714-42.857143-55.142857-31.428571T434.285714 444.571429q-69.714286 0-118.285714 40.285714T267.428571 593.142857z" p-id="1953"></path></svg>',datatip:"JSFiddle"}}])}(c)),Pi("codepen")&&r.appendChild(function(n){var e=n.css,t=n.htmlTpl,r=n.jsTpl,o=n.jsLib,a=n.cssLib,s=JSON.stringify({css:e,html:t,js:r,js_external:o.concat(Pi("jsLib")).join(";"),css_external:a.concat(Pi("cssLib")).join(";"),layout:Pi("codepenLayout"),js_pre_processor:Pi("codepenJsProcessor"),editors:Pi("codepenEditors")});return Ii("form",{className:"vuepress-plugin-demo-block__codepen",target:"_blank",action:"https://codepen.io/pen/define",method:"post"},[{tag:"input",attrs:{type:"hidden",name:"data",value:s}},{tag:"button",attrs:{type:"submit",innerHTML:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1547088271207" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1737" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M123.428571 668l344.571429 229.714286v-205.142857L277.142857 565.142857z m-35.428571-82.285714l110.285714-73.714286-110.285714-73.714286v147.428572z m468 312l344.571429-229.714286-153.714286-102.857143-190.857143 127.428572v205.142857z m-44-281.714286l155.428571-104-155.428571-104-155.428571 104zM277.142857 458.857143l190.857143-127.428572V126.285714L123.428571 356z m548.571429 53.142857l110.285714 73.714286V438.285714z m-78.857143-53.142857l153.714286-102.857143-344.571429-229.714286v205.142857z m277.142857-102.857143v312q0 23.428571-19.428571 36.571429l-468 312q-12 7.428571-24.571429 7.428571t-24.571429-7.428571L19.428571 704.571429q-19.428571-13.142857-19.428571-36.571429V356q0-23.428571 19.428571-36.571429L487.428571 7.428571q12-7.428571 24.571429-7.428571t24.571429 7.428571l468 312q19.428571 13.142857 19.428571 36.571429z" p-id="1738"></path></svg>',className:"vuepress-plugin-demo-block__button",datatip:"Codepen"}}])}(c)),void 0!==s.horizontal?s.horizontal:Pi("horizontal")){n.classList.add("vuepress-plugin-demo-block__horizontal");var d=e.firstChild.cloneNode(!0);d.classList.add("vuepress-plugin-demo-block__h_code"),t.appendChild(d)}if(c.css&&function(n){if(!Ci[n]){var e=Ii("style",{innerHTML:n});document.body.appendChild(e),Ci[n]=!0}}(c.css),"react"===i)ReactDOM.render(React.createElement(c.js),o);else if("vue"===i){var u=(new(Vue.extend(c.script))).$mount();o.appendChild(u.$el)}else"vanilla"===i&&(o.innerHTML=c.html,new Function("return (function(){".concat(c.script,"})()"))());n.dataset.created="true"}})):setTimeout((function(n){Ri()}),300)}function Fi(n,e,t,r){var o="1"!==n.dataset.isExpand;t.style.height=o?"".concat(e,"px"):0,o?r.classList.add("vuepress-plugin-demo-block__show-link"):r.classList.remove("vuepress-plugin-demo-block__show-link"),n.dataset.isExpand=o?"1":"0"}var Li={mounted:function(){window.$VUEPRESS_DEMO_BLOCK={jsfiddle:!1,codepen:!0,horizontal:!1},Ri()},updated:function(){Ri()}},Ui="auto",Mi="zoom-in",Gi="zoom-out",Vi="grab",$i="move";function Wi(n,e,t){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o={passive:!1};r?n.addEventListener(e,t,o):n.removeEventListener(e,t,o)}function Hi(n,e){if(n){var t=new Image;t.onload=function(){e&&e(t)},t.src=n}}function Zi(n){return n.dataset.original?n.dataset.original:"A"===n.parentNode.tagName?n.parentNode.getAttribute("href"):null}function Ki(n,e,t){!function(n){var e=Xi,t=Ji;if(n.transition){var r=n.transition;delete n.transition,n[e]=r}if(n.transform){var o=n.transform;delete n.transform,n[t]=o}}(e);var r=n.style,o={};for(var a in e)t&&(o[a]=r[a]||""),r[a]=e[a];return o}var Xi="transition",Ji="transform",Yi="transform",Qi="transitionend";var nl=function(){},el={enableGrab:!0,preloadImage:!1,closeOnWindowResize:!0,transitionDuration:.4,transitionTimingFunction:"cubic-bezier(0.4, 0, 0, 1)",bgColor:"rgb(255, 255, 255)",bgOpacity:1,scaleBase:1,scaleExtra:.5,scrollThreshold:40,zIndex:998,customSize:null,onOpen:nl,onClose:nl,onGrab:nl,onMove:nl,onRelease:nl,onBeforeOpen:nl,onBeforeClose:nl,onBeforeGrab:nl,onBeforeRelease:nl,onImageLoading:nl,onImageLoaded:nl},tl={init:function(n){var e,t;e=this,t=n,Object.getOwnPropertyNames(Object.getPrototypeOf(e)).forEach((function(n){e[n]=e[n].bind(t)}))},click:function(n){if(n.preventDefault(),ol(n))return window.open(this.target.srcOriginal||n.currentTarget.src,"_blank");this.shown?this.released?this.close():this.release():this.open(n.currentTarget)},scroll:function(){var n=document.documentElement||document.body.parentNode||document.body,e=window.pageXOffset||n.scrollLeft,t=window.pageYOffset||n.scrollTop;null===this.lastScrollPosition&&(this.lastScrollPosition={x:e,y:t});var r=this.lastScrollPosition.x-e,o=this.lastScrollPosition.y-t,a=this.options.scrollThreshold;(Math.abs(o)>=a||Math.abs(r)>=a)&&(this.lastScrollPosition=null,this.close())},keydown:function(n){(function(n){return"Escape"===(n.key||n.code)||27===n.keyCode})(n)&&(this.released?this.close():this.release(this.close))},mousedown:function(n){if(rl(n)&&!ol(n)){n.preventDefault();var e=n.clientX,t=n.clientY;this.pressTimer=setTimeout(function(){this.grab(e,t)}.bind(this),200)}},mousemove:function(n){this.released||this.move(n.clientX,n.clientY)},mouseup:function(n){rl(n)&&!ol(n)&&(clearTimeout(this.pressTimer),this.released?this.close():this.release())},touchstart:function(n){n.preventDefault();var e=n.touches[0],t=e.clientX,r=e.clientY;this.pressTimer=setTimeout(function(){this.grab(t,r)}.bind(this),200)},touchmove:function(n){if(!this.released){var e=n.touches[0],t=e.clientX,r=e.clientY;this.move(t,r)}},touchend:function(n){(function(n){n.targetTouches.length})(n)||(clearTimeout(this.pressTimer),this.released?this.close():this.release())},clickOverlay:function(){this.close()},resizeWindow:function(){this.close()}};function rl(n){return 0===n.button}function ol(n){return n.metaKey||n.ctrlKey}var al={init:function(n){this.el=document.createElement("div"),this.instance=n,this.parent=document.body,Ki(this.el,{position:"fixed",top:0,left:0,right:0,bottom:0,opacity:0}),this.updateStyle(n.options),Wi(this.el,"click",n.handler.clickOverlay.bind(n))},updateStyle:function(n){Ki(this.el,{zIndex:n.zIndex,backgroundColor:n.bgColor,transition:"opacity\n        "+n.transitionDuration+"s\n        "+n.transitionTimingFunction})},insert:function(){this.parent.appendChild(this.el)},remove:function(){this.parent.removeChild(this.el)},fadeIn:function(){this.el.offsetWidth,this.el.style.opacity=this.instance.options.bgOpacity},fadeOut:function(){this.el.style.opacity=0}},sl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},il=function(){function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),ll=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},cl={init:function(n,e){this.el=n,this.instance=e,this.srcThumbnail=this.el.getAttribute("src"),this.srcset=this.el.getAttribute("srcset"),this.srcOriginal=Zi(this.el),this.rect=this.el.getBoundingClientRect(),this.translate=null,this.scale=null,this.styleOpen=null,this.styleClose=null},zoomIn:function(){var n=this.instance.options,e=n.zIndex,t=n.enableGrab,r=n.transitionDuration,o=n.transitionTimingFunction;this.translate=this.calculateTranslate(),this.scale=this.calculateScale(),this.styleOpen={position:"relative",zIndex:e+1,cursor:t?Vi:Gi,transition:Yi+"\n        "+r+"s\n        "+o,transform:"translate3d("+this.translate.x+"px, "+this.translate.y+"px, 0px)\n        scale("+this.scale.x+","+this.scale.y+")",height:this.rect.height+"px",width:this.rect.width+"px"},this.el.offsetWidth,this.styleClose=Ki(this.el,this.styleOpen,!0)},zoomOut:function(){this.el.offsetWidth,Ki(this.el,{transform:"none"})},grab:function(n,e,t){var r=pl(),o=r.x-n,a=r.y-e;Ki(this.el,{cursor:$i,transform:"translate3d(\n        "+(this.translate.x+o)+"px, "+(this.translate.y+a)+"px, 0px)\n        scale("+(this.scale.x+t)+","+(this.scale.y+t)+")"})},move:function(n,e,t){var r=pl(),o=r.x-n,a=r.y-e;Ki(this.el,{transition:Yi,transform:"translate3d(\n        "+(this.translate.x+o)+"px, "+(this.translate.y+a)+"px, 0px)\n        scale("+(this.scale.x+t)+","+(this.scale.y+t)+")"})},restoreCloseStyle:function(){Ki(this.el,this.styleClose)},restoreOpenStyle:function(){Ki(this.el,this.styleOpen)},upgradeSource:function(){if(this.srcOriginal){var n=this.el.parentNode;this.srcset&&this.el.removeAttribute("srcset");var e=this.el.cloneNode(!1);e.setAttribute("src",this.srcOriginal),e.style.position="fixed",e.style.visibility="hidden",n.appendChild(e),setTimeout(function(){this.el.setAttribute("src",this.srcOriginal),n.removeChild(e)}.bind(this),50)}},downgradeSource:function(){this.srcOriginal&&(this.srcset&&this.el.setAttribute("srcset",this.srcset),this.el.setAttribute("src",this.srcThumbnail))},calculateTranslate:function(){var n=pl(),e=this.rect.left+this.rect.width/2,t=this.rect.top+this.rect.height/2;return{x:n.x-e,y:n.y-t}},calculateScale:function(){var n=this.el.dataset,e=n.zoomingHeight,t=n.zoomingWidth,r=this.instance.options,o=r.customSize,a=r.scaleBase;if(!o&&e&&t)return{x:t/this.rect.width,y:e/this.rect.height};if(o&&"object"===(void 0===o?"undefined":sl(o)))return{x:o.width/this.rect.width,y:o.height/this.rect.height};var s=this.rect.width/2,i=this.rect.height/2,l=pl(),c={x:l.x-s,y:l.y-i},p=c.x/s,d=c.y/i,u=a+Math.min(p,d);if(o&&"string"==typeof o){var m=t||this.el.naturalWidth,g=e||this.el.naturalHeight,f=parseFloat(o)*m/(100*this.rect.width),h=parseFloat(o)*g/(100*this.rect.height);if(u>f||u>h)return{x:f,y:h}}return{x:u,y:u}}};function pl(){var n=document.documentElement;return{x:Math.min(n.clientWidth,window.innerWidth)/2,y:Math.min(n.clientHeight,window.innerHeight)/2}}function dl(n,e,t){["mousedown","mousemove","mouseup","touchstart","touchmove","touchend"].forEach((function(r){Wi(n,r,e[r],t)}))}var ul=function(){function n(e){!function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.target=Object.create(cl),this.overlay=Object.create(al),this.handler=Object.create(tl),this.body=document.body,this.shown=!1,this.lock=!1,this.released=!0,this.lastScrollPosition=null,this.pressTimer=null,this.options=ll({},el,e),this.overlay.init(this),this.handler.init(this)}return il(n,[{key:"listen",value:function(n){if("string"==typeof n)for(var e=document.querySelectorAll(n),t=e.length;t--;)this.listen(e[t]);else"IMG"===n.tagName&&(n.style.cursor=Mi,Wi(n,"click",this.handler.click),this.options.preloadImage&&Hi(Zi(n)));return this}},{key:"config",value:function(n){return n?(ll(this.options,n),this.overlay.updateStyle(this.options),this):this.options}},{key:"open",value:function(n){var e=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.onOpen;if(!this.shown&&!this.lock){var r="string"==typeof n?document.querySelector(n):n;if("IMG"===r.tagName){if(this.options.onBeforeOpen(r),this.target.init(r,this),!this.options.preloadImage){var o=this.target.srcOriginal;null!=o&&(this.options.onImageLoading(r),Hi(o,this.options.onImageLoaded))}this.shown=!0,this.lock=!0,this.target.zoomIn(),this.overlay.insert(),this.overlay.fadeIn(),Wi(document,"scroll",this.handler.scroll),Wi(document,"keydown",this.handler.keydown),this.options.closeOnWindowResize&&Wi(window,"resize",this.handler.resizeWindow);var a=function n(){Wi(r,Qi,n,!1),e.lock=!1,e.target.upgradeSource(),e.options.enableGrab&&dl(document,e.handler,!0),t(r)};return Wi(r,Qi,a),this}}}},{key:"close",value:function(){var n=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.options.onClose;if(this.shown&&!this.lock){var t=this.target.el;this.options.onBeforeClose(t),this.lock=!0,this.body.style.cursor=Ui,this.overlay.fadeOut(),this.target.zoomOut(),Wi(document,"scroll",this.handler.scroll,!1),Wi(document,"keydown",this.handler.keydown,!1),this.options.closeOnWindowResize&&Wi(window,"resize",this.handler.resizeWindow,!1);var r=function r(){Wi(t,Qi,r,!1),n.shown=!1,n.lock=!1,n.target.downgradeSource(),n.options.enableGrab&&dl(document,n.handler,!1),n.target.restoreCloseStyle(),n.overlay.remove(),e(t)};return Wi(t,Qi,r),this}}},{key:"grab",value:function(n,e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.scaleExtra,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.options.onGrab;if(this.shown&&!this.lock){var o=this.target.el;this.options.onBeforeGrab(o),this.released=!1,this.target.grab(n,e,t);var a=function n(){Wi(o,Qi,n,!1),r(o)};return Wi(o,Qi,a),this}}},{key:"move",value:function(n,e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.scaleExtra,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.options.onMove;if(this.shown&&!this.lock){this.released=!1,this.body.style.cursor=$i,this.target.move(n,e,t);var o=this.target.el,a=function n(){Wi(o,Qi,n,!1),r(o)};return Wi(o,Qi,a),this}}},{key:"release",value:function(){var n=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.options.onRelease;if(this.shown&&!this.lock){var t=this.target.el;this.options.onBeforeRelease(t),this.lock=!0,this.body.style.cursor=Ui,this.target.restoreOpenStyle();var r=function r(){Wi(t,Qi,r,!1),n.lock=!1,n.released=!0,e(t)};return Wi(t,Qi,r),this}}}]),n}();const ml=JSON.parse('{"bgColor":"rgba(0,0,0,0.6)"}'),gl=Number("500");class fl{constructor(){this.instance=new ul(ml)}update(n=".theme-vdoing-content img:not(.no-zoom)"){"undefined"!=typeof window&&this.instance.listen(n)}updateDelay(n=".theme-vdoing-content img:not(.no-zoom)",e=gl){setTimeout(()=>this.update(n),e)}}var hl=[vi,Ei,Bi,ji,Li,{watch:{"$page.path"(){void 0!==this.$vuepress.zooming&&this.$vuepress.zooming.updateDelay()}},mounted(){this.$vuepress.zooming=new fl,this.$vuepress.zooming.updateDelay()}}],vl={name:"GlobalLayout",computed:{layout(){const n=this.getLayout();return ui("layout",n),Ht.component(n)}},methods:{getLayout(){if(this.$page.path){const n=this.$page.frontmatter.layout;return n&&(this.$vuepress.getLayoutAsyncComponent(n)||this.$vuepress.getVueComponent(n))?n:"Layout"}return"NotFound"}}},bl=t(5),_l=Object(bl.a)(vl,(function(){return(0,this._self._c)(this.layout,{tag:"component"})}),[],!1,null,null,null).exports;!function(n,e,t){switch(e){case"components":n[e]||(n[e]={}),Object.assign(n[e],t);break;case"mixins":n[e]||(n[e]=[]),n[e].push(...t);break;default:throw new Error("Unknown option name.")}}(_l,"mixins",hl);const yl=[{name:"v-f7879d60",path:"/pages/f3cf17/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-f7879d60").then(t)}},{path:"/pages/f3cf17/index.html",redirect:"/pages/f3cf17/"},{path:"/01.äºåç/06.docker/01.å®¹å¨çæ¬è´¨.html",redirect:"/pages/f3cf17/"},{name:"v-6f7bb862",path:"/pages/d3768c/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-6f7bb862").then(t)}},{path:"/pages/d3768c/index.html",redirect:"/pages/d3768c/"},{path:"/01.äºåç/06.docker/03.æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å.html",redirect:"/pages/d3768c/"},{name:"v-08a8939a",path:"/pages/39f36e/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-08a8939a").then(t)}},{path:"/pages/39f36e/index.html",redirect:"/pages/39f36e/"},{path:"/01.äºåç/06.docker/02.dockerå®¹å¨.html",redirect:"/pages/39f36e/"},{name:"v-29274a29",path:"/pages/2b547f/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-29274a29").then(t)}},{path:"/pages/2b547f/index.html",redirect:"/pages/2b547f/"},{path:"/01.äºåç/07.k8s/03.k8sä¹pod.html",redirect:"/pages/2b547f/"},{name:"v-44df3b79",path:"/pages/d73c88/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-44df3b79").then(t)}},{path:"/pages/d73c88/index.html",redirect:"/pages/d73c88/"},{path:"/01.äºåç/07.k8s/04.k8sä¹deployment.html",redirect:"/pages/d73c88/"},{name:"v-6430d054",path:"/pages/0ddeb7/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-6430d054").then(t)}},{path:"/pages/0ddeb7/index.html",redirect:"/pages/0ddeb7/"},{path:"/01.äºåç/06.docker/04.dockerå®¹å¨åæºç½ç».html",redirect:"/pages/0ddeb7/"},{name:"v-341f9276",path:"/pages/1f860b/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-341f9276").then(t)}},{path:"/pages/1f860b/index.html",redirect:"/pages/1f860b/"},{path:"/01.äºåç/07.k8s/05.k8sä¹service.html",redirect:"/pages/1f860b/"},{name:"v-ba5a65c4",path:"/pages/ff8188/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-ba5a65c4").then(t)}},{path:"/pages/ff8188/index.html",redirect:"/pages/ff8188/"},{path:"/01.äºåç/07.k8s/06.k8sä¹ConfigMapåSecret.html",redirect:"/pages/ff8188/"},{name:"v-64f910e0",path:"/go_performance/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-64f910e0").then(t)}},{path:"/go_performance/index.html",redirect:"/go_performance/"},{path:"/00.ç®å½é¡µ/01.Goè¯­è¨é«æ§è½ç¼ç¨.html",redirect:"/go_performance/"},{name:"v-3ff5ce46",path:"/pages/c96905/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3ff5ce46").then(t)}},{path:"/pages/c96905/index.html",redirect:"/pages/c96905/"},{path:"/01.äºåç/07.k8s/07.k8sä¹JobåCronJob.html",redirect:"/pages/c96905/"},{name:"v-470b5455",path:"/bug_hunt/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-470b5455").then(t)}},{path:"/bug_hunt/index.html",redirect:"/bug_hunt/"},{path:"/00.ç®å½é¡µ/02.Bug éç¼ä»¤.html",redirect:"/bug_hunt/"},{name:"v-411a2b26",path:"/pages/92bee4/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-411a2b26").then(t)}},{path:"/pages/92bee4/index.html",redirect:"/pages/92bee4/"},{path:"/01.äºåç/07.k8s/08.k8sä¹DaemonSet.html",redirect:"/pages/92bee4/"},{name:"v-14bd5c2a",path:"/pages/095c75/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-14bd5c2a").then(t)}},{path:"/pages/095c75/index.html",redirect:"/pages/095c75/"},{path:"/01.äºåç/07.k8s/09.k8sä¹PVãPVCåStorageClass.html",redirect:"/pages/095c75/"},{name:"v-0ee080d4",path:"/pages/9e17c8/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-0ee080d4").then(t)}},{path:"/pages/9e17c8/index.html",redirect:"/pages/9e17c8/"},{path:"/01.äºåç/07.k8s/11.ä½¿ç¨kubeadmå®è£k8s.html",redirect:"/pages/9e17c8/"},{name:"v-9fc226e2",path:"/pages/d178a2/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-9fc226e2").then(t)}},{path:"/pages/d178a2/index.html",redirect:"/pages/d178a2/"},{path:"/01.äºåç/07.k8s/10.k8sä¹StatefulSet.html",redirect:"/pages/d178a2/"},{name:"v-c31c1604",path:"/pages/b1b4a3/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-c31c1604").then(t)}},{path:"/pages/b1b4a3/index.html",redirect:"/pages/b1b4a3/"},{path:"/01.äºåç/07.k8s/13.djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§.html",redirect:"/pages/b1b4a3/"},{name:"v-476540fe",path:"/pages/27987d/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-476540fe").then(t)}},{path:"/pages/27987d/index.html",redirect:"/pages/27987d/"},{path:"/01.äºåç/07.k8s/12.podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦».html",redirect:"/pages/27987d/"},{name:"v-38f161f6",path:"/pages/f0f725/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-38f161f6").then(t)}},{path:"/pages/f0f725/index.html",redirect:"/pages/f0f725/"},{path:"/01.äºåç/07.k8s/15.çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç.html",redirect:"/pages/f0f725/"},{name:"v-44e743b8",path:"/pages/d9d0ce/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-44e743b8").then(t)}},{path:"/pages/d9d0ce/index.html",redirect:"/pages/d9d0ce/"},{path:"/01.äºåç/07.k8s/14.çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç.html",redirect:"/pages/d9d0ce/"},{name:"v-2f20c458",path:"/pages/b3955c/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2f20c458").then(t)}},{path:"/pages/b3955c/index.html",redirect:"/pages/b3955c/"},{path:"/01.äºåç/07.k8s/16.kubernetes serviceå¦ä½éè¿iptablesè½¬å.html",redirect:"/pages/b3955c/"},{name:"v-e543b750",path:"/pages/cf65ba/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-e543b750").then(t)}},{path:"/pages/cf65ba/index.html",redirect:"/pages/cf65ba/"},{path:"/02.Bug éç¼ä»¤/01.ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥.html",redirect:"/pages/cf65ba/"},{name:"v-3c54c66f",path:"/pages/6e0045/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3c54c66f").then(t)}},{path:"/pages/6e0045/index.html",redirect:"/pages/6e0045/"},{path:"/01.äºåç/07.k8s/17.kube-proxyæºç åæ.html",redirect:"/pages/6e0045/"},{name:"v-7c3ad306",path:"/pages/de98b1/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-7c3ad306").then(t)}},{path:"/pages/de98b1/index.html",redirect:"/pages/de98b1/"},{path:"/02.Bug éç¼ä»¤/02.æå¡å¯å¨æ¶åºç° OOM.html",redirect:"/pages/de98b1/"},{name:"v-5793b4fb",path:"/pages/fa114f/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-5793b4fb").then(t)}},{path:"/pages/fa114f/index.html",redirect:"/pages/fa114f/"},{path:"/03.ä¸­é´ä»¶/01.kafka/01.listeneråadvertised.listenersçä½ç¨.html",redirect:"/pages/fa114f/"},{name:"v-967c62b6",path:"/pages/2d69c7/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-967c62b6").then(t)}},{path:"/pages/2d69c7/index.html",redirect:"/pages/2d69c7/"},{path:"/03.ä¸­é´ä»¶/03.mysql/01.mysqlä¹æ¥å¿.html",redirect:"/pages/2d69c7/"},{name:"v-097050d4",path:"/pages/0d8f4a/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-097050d4").then(t)}},{path:"/pages/0d8f4a/index.html",redirect:"/pages/0d8f4a/"},{path:"/03.ä¸­é´ä»¶/03.mysql/02.mysqlä¹MVCCåç.html",redirect:"/pages/0d8f4a/"},{name:"v-2ecc148c",path:"/pages/2bbeb3/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2ecc148c").then(t)}},{path:"/pages/2bbeb3/index.html",redirect:"/pages/2bbeb3/"},{path:"/03.ä¸­é´ä»¶/05.redis/01.redisä¹äºç§åºæ¬æ°æ®ç±»å.html",redirect:"/pages/2bbeb3/"},{name:"v-278df89e",path:"/pages/4c6b13/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-278df89e").then(t)}},{path:"/pages/4c6b13/index.html",redirect:"/pages/4c6b13/"},{path:"/03.ä¸­é´ä»¶/05.redis/02.redisä¹æä¹å.html",redirect:"/pages/4c6b13/"},{name:"v-61296d7f",path:"/pages/8072eb/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-61296d7f").then(t)}},{path:"/pages/8072eb/index.html",redirect:"/pages/8072eb/"},{path:"/03.ä¸­é´ä»¶/05.redis/03. redisä¹ä¸»ä»åºåæ­¥.html",redirect:"/pages/8072eb/"},{name:"v-be37f416",path:"/pages/ffee9e/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-be37f416").then(t)}},{path:"/pages/ffee9e/index.html",redirect:"/pages/ffee9e/"},{path:"/03.ä¸­é´ä»¶/05.redis/04. redisä¹å¨åµæºå¶.html",redirect:"/pages/ffee9e/"},{name:"v-ae93950e",path:"/pages/1c2914/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-ae93950e").then(t)}},{path:"/pages/1c2914/index.html",redirect:"/pages/1c2914/"},{path:"/03.ä¸­é´ä»¶/05.redis/05. redisä¹åçéç¾¤.html",redirect:"/pages/1c2914/"},{name:"v-834e066a",path:"/pages/0d7b25/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-834e066a").then(t)}},{path:"/pages/0d7b25/index.html",redirect:"/pages/0d7b25/"},{path:"/03.ä¸­é´ä»¶/05.redis/06. redisä¹ç¼å­.html",redirect:"/pages/0d7b25/"},{name:"v-b9336fc4",path:"/pages/e31b06/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-b9336fc4").then(t)}},{path:"/pages/e31b06/index.html",redirect:"/pages/e31b06/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/01.pythonè¿­ä»£å¨ä¸çæå¨.html",redirect:"/pages/e31b06/"},{name:"v-300c8022",path:"/pages/5fa368/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-300c8022").then(t)}},{path:"/pages/5fa368/index.html",redirect:"/pages/5fa368/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/02.pythonåç¼ç¨.html",redirect:"/pages/5fa368/"},{name:"v-450eddde",path:"/pages/adedbd/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-450eddde").then(t)}},{path:"/pages/adedbd/index.html",redirect:"/pages/adedbd/"},{path:"/03.ä¸­é´ä»¶/06.logstash/01.pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿.html",redirect:"/pages/adedbd/"},{name:"v-ed00c198",path:"/pages/a6b804/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-ed00c198").then(t)}},{path:"/pages/a6b804/index.html",redirect:"/pages/a6b804/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/04.pythonä¸ä¸æç®¡çå¨.html",redirect:"/pages/a6b804/"},{name:"v-06e111a1",path:"/pages/78c648/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-06e111a1").then(t)}},{path:"/pages/78c648/index.html",redirect:"/pages/78c648/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/03.pythonåå¾åæ¶æºå¶.html",redirect:"/pages/78c648/"},{name:"v-e35e3500",path:"/pages/33b8d0/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-e35e3500").then(t)}},{path:"/pages/33b8d0/index.html",redirect:"/pages/33b8d0/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/06.ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼.html",redirect:"/pages/33b8d0/"},{name:"v-a7079bc2",path:"/pages/d8fd49/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-a7079bc2").then(t)}},{path:"/pages/d8fd49/index.html",redirect:"/pages/d8fd49/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/07.pythonä¸­importåç.html",redirect:"/pages/d8fd49/"},{name:"v-da2a3b40",path:"/pages/7434f1/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-da2a3b40").then(t)}},{path:"/pages/7434f1/index.html",redirect:"/pages/7434f1/"},{path:"/04.ç¼ç¨/01.python/01.åºç¡/05.pythonè£é¥°å¨çä½¿ç¨æ¹æ³.html",redirect:"/pages/7434f1/"},{name:"v-3644af7a",path:"/pages/8d9ab9/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3644af7a").then(t)}},{path:"/pages/8d9ab9/index.html",redirect:"/pages/8d9ab9/"},{path:"/04.ç¼ç¨/01.python/02.ç¬¬ä¸æ¹åº/01.ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯.html",redirect:"/pages/8d9ab9/"},{name:"v-6fc4dda8",path:"/pages/ec5110/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-6fc4dda8").then(t)}},{path:"/pages/ec5110/index.html",redirect:"/pages/ec5110/"},{path:"/04.ç¼ç¨/01.python/02.ç¬¬ä¸æ¹åº/03.django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢.html",redirect:"/pages/ec5110/"},{name:"v-dea92c98",path:"/pages/069c65/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-dea92c98").then(t)}},{path:"/pages/069c65/index.html",redirect:"/pages/069c65/"},{path:"/04.ç¼ç¨/01.python/02.ç¬¬ä¸æ¹åº/02.ddtæºç åæ.html",redirect:"/pages/069c65/"},{name:"v-a6f8fe8c",path:"/pages/25eafd/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-a6f8fe8c").then(t)}},{path:"/pages/25eafd/index.html",redirect:"/pages/25eafd/"},{path:"/04.ç¼ç¨/01.python/06.django/02.django rest_frameworkä½¿ç¨jwt.html",redirect:"/pages/25eafd/"},{name:"v-cf78fd3a",path:"/pages/626675/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-cf78fd3a").then(t)}},{path:"/pages/626675/index.html",redirect:"/pages/626675/"},{path:"/04.ç¼ç¨/01.python/06.django/03.django rest_framework Authentication.html",redirect:"/pages/626675/"},{name:"v-3599af91",path:"/pages/070fec/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3599af91").then(t)}},{path:"/pages/070fec/index.html",redirect:"/pages/070fec/"},{path:"/04.ç¼ç¨/01.python/06.django/04.django rest_frameworkå¼å¸¸å¤ç.html",redirect:"/pages/070fec/"},{name:"v-3e233877",path:"/pages/853501/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3e233877").then(t)}},{path:"/pages/853501/index.html",redirect:"/pages/853501/"},{path:"/04.ç¼ç¨/01.python/06.django/01.django celery ç»åä½¿ç¨.html",redirect:"/pages/853501/"},{name:"v-628321a6",path:"/pages/f2738b/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-628321a6").then(t)}},{path:"/pages/f2738b/index.html",redirect:"/pages/f2738b/"},{path:"/04.ç¼ç¨/01.python/06.django/06.djangoåç¼©æä»¶ä¸è½½.html",redirect:"/pages/f2738b/"},{name:"v-77d8c9f4",path:"/pages/c28126/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-77d8c9f4").then(t)}},{path:"/pages/c28126/index.html",redirect:"/pages/c28126/"},{path:"/04.ç¼ç¨/01.python/06.django/07.django rest_frameworkä½¿ç¨pytestååæµè¯.html",redirect:"/pages/c28126/"},{name:"v-226be104",path:"/pages/c3af6a/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-226be104").then(t)}},{path:"/pages/c3af6a/index.html",redirect:"/pages/c3af6a/"},{path:"/04.ç¼ç¨/01.python/06.django/05.django rest_framework èªå®ä¹ææ¡£.html",redirect:"/pages/c3af6a/"},{name:"v-22b0df18",path:"/pages/b90015/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-22b0df18").then(t)}},{path:"/pages/b90015/index.html",redirect:"/pages/b90015/"},{path:"/04.ç¼ç¨/01.python/06.django/08.django restframework choice èªå®ä¹è¾åºæ°æ®.html",redirect:"/pages/b90015/"},{name:"v-fab79492",path:"/pages/cfdb5f/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-fab79492").then(t)}},{path:"/pages/cfdb5f/index.html",redirect:"/pages/cfdb5f/"},{path:"/04.ç¼ç¨/01.python/06.django/09.django Filtering ä½¿ç¨.html",redirect:"/pages/cfdb5f/"},{name:"v-fab7554a",path:"/pages/e75ceb/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-fab7554a").then(t)}},{path:"/pages/e75ceb/index.html",redirect:"/pages/e75ceb/"},{path:"/04.ç¼ç¨/01.python/06.django/10.django viewset å Router éåä½¿ç¨æ¶æ¥çé.html",redirect:"/pages/e75ceb/"},{name:"v-15cbdfc3",path:"/pages/acdd50/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-15cbdfc3").then(t)}},{path:"/pages/acdd50/index.html",redirect:"/pages/acdd50/"},{path:"/04.ç¼ç¨/01.python/06.django/11.django modelçåºåå.html",redirect:"/pages/acdd50/"},{name:"v-74cd7d9e",path:"/pages/382755/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-74cd7d9e").then(t)}},{path:"/pages/382755/index.html",redirect:"/pages/382755/"},{path:"/04.ç¼ç¨/01.python/06.django/12.djangoä¸­ä½¿ç¨AbStractUser.html",redirect:"/pages/382755/"},{name:"v-37cf929d",path:"/pages/060c51/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-37cf929d").then(t)}},{path:"/pages/060c51/index.html",redirect:"/pages/060c51/"},{path:"/04.ç¼ç¨/01.python/06.django/13.django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users.html",redirect:"/pages/060c51/"},{name:"v-40dce165",path:"/pages/de01e2/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-40dce165").then(t)}},{path:"/pages/de01e2/index.html",redirect:"/pages/de01e2/"},{path:"/04.ç¼ç¨/01.python/06.django/14.django ä¸­ mediaéç½®.html",redirect:"/pages/de01e2/"},{name:"v-722217eb",path:"/pages/b422bd/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-722217eb").then(t)}},{path:"/pages/b422bd/index.html",redirect:"/pages/b422bd/"},{path:"/04.ç¼ç¨/01.python/06.django/15.django å¤é®å¼ç¨èªèº«åon_deleteåæ°.html",redirect:"/pages/b422bd/"},{name:"v-224b6ec4",path:"/pages/f0d816/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-224b6ec4").then(t)}},{path:"/pages/f0d816/index.html",redirect:"/pages/f0d816/"},{path:"/04.ç¼ç¨/01.python/06.django/16.django è­¦å while time zone support is active.html",redirect:"/pages/f0d816/"},{name:"v-73bfa208",path:"/pages/b71dc2/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-73bfa208").then(t)}},{path:"/pages/b71dc2/index.html",redirect:"/pages/b71dc2/"},{path:"/04.ç¼ç¨/01.python/07.flask/01.Flaskä½¿ç¨flask_socketioå®ç°websocket.html",redirect:"/pages/b71dc2/"},{name:"v-9c48962a",path:"/pages/4b0adb/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-9c48962a").then(t)}},{path:"/pages/4b0adb/index.html",redirect:"/pages/4b0adb/"},{path:"/04.ç¼ç¨/01.python/06.django/18.django-prometheusä½¿ç¨åæºç åæ.html",redirect:"/pages/4b0adb/"},{name:"v-ff2c286e",path:"/pages/cb262f/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-ff2c286e").then(t)}},{path:"/pages/cb262f/index.html",redirect:"/pages/cb262f/"},{path:"/04.ç¼ç¨/01.python/06.django/17.django rest_framework åé¡µ.html",redirect:"/pages/cb262f/"},{name:"v-364f49b5",path:"/pages/c59edf/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-364f49b5").then(t)}},{path:"/pages/c59edf/index.html",redirect:"/pages/c59edf/"},{path:"/04.ç¼ç¨/01.python/07.flask/02.flaskç»åmongo.html",redirect:"/pages/c59edf/"},{name:"v-2f2878f8",path:"/pages/4c38f5/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2f2878f8").then(t)}},{path:"/pages/4c38f5/index.html",redirect:"/pages/4c38f5/"},{path:"/04.ç¼ç¨/01.python/08.tornado/01.tornado æä»¶ä¸ä¼ .html",redirect:"/pages/4c38f5/"},{name:"v-33efde74",path:"/pages/c24905/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-33efde74").then(t)}},{path:"/pages/c24905/index.html",redirect:"/pages/c24905/"},{path:"/04.ç¼ç¨/01.python/08.tornado/02.tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯.html",redirect:"/pages/c24905/"},{name:"v-5000cd97",path:"/pages/22f35b/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-5000cd97").then(t)}},{path:"/pages/22f35b/index.html",redirect:"/pages/22f35b/"},{path:"/04.ç¼ç¨/01.python/08.tornado/03.tornado ç¨æ·å¯ç  bcryptå å¯.html",redirect:"/pages/22f35b/"},{name:"v-fad5dda8",path:"/pages/7ac01f/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-fad5dda8").then(t)}},{path:"/pages/7ac01f/index.html",redirect:"/pages/7ac01f/"},{path:"/04.ç¼ç¨/01.python/08.tornado/04.tornado ç»åwtformsä½¿ç¨è¡¨åæä½.html",redirect:"/pages/7ac01f/"},{name:"v-7f082a66",path:"/pages/d18657/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-7f082a66").then(t)}},{path:"/pages/d18657/index.html",redirect:"/pages/d18657/"},{path:"/04.ç¼ç¨/01.python/08.tornado/05.tornado finishåwriteåºå«.html",redirect:"/pages/d18657/"},{name:"v-4371bf05",path:"/pages/f9d78c/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-4371bf05").then(t)}},{path:"/pages/f9d78c/index.html",redirect:"/pages/f9d78c/"},{path:"/04.ç¼ç¨/01.python/09.å¶ä»/01.pythonç®åä½¿ç¨grpc.html",redirect:"/pages/f9d78c/"},{name:"v-13f4cf5a",path:"/pages/113ab1/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-13f4cf5a").then(t)}},{path:"/pages/113ab1/index.html",redirect:"/pages/113ab1/"},{path:"/04.ç¼ç¨/01.python/08.tornado/06.tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½.html",redirect:"/pages/113ab1/"},{name:"v-ba59602c",path:"/pages/72664a/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-ba59602c").then(t)}},{path:"/pages/72664a/index.html",redirect:"/pages/72664a/"},{path:"/04.ç¼ç¨/01.python/09.å¶ä»/02.pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾.html",redirect:"/pages/72664a/"},{name:"v-4edff9fd",path:"/pages/7f6078/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-4edff9fd").then(t)}},{path:"/pages/7f6078/index.html",redirect:"/pages/7f6078/"},{path:"/04.ç¼ç¨/01.python/09.å¶ä»/03.åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ.html",redirect:"/pages/7f6078/"},{name:"v-69c6394c",path:"/pages/c41003/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-69c6394c").then(t)}},{path:"/pages/c41003/index.html",redirect:"/pages/c41003/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/02. ginä¸­validatoræ¨¡åçæºç åæ.html",redirect:"/pages/c41003/"},{name:"v-3d85724c",path:"/pages/87014e/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3d85724c").then(t)}},{path:"/pages/87014e/index.html",redirect:"/pages/87014e/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/01.goç®åä½¿ç¨grpc.html",redirect:"/pages/87014e/"},{name:"v-465edabc",path:"/pages/cf9a4d/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-465edabc").then(t)}},{path:"/pages/cf9a4d/index.html",redirect:"/pages/cf9a4d/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/03.ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯.html",redirect:"/pages/cf9a4d/"},{name:"v-2afdd346",path:"/pages/d93df5/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2afdd346").then(t)}},{path:"/pages/d93df5/index.html",redirect:"/pages/d93df5/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/04.goä¸­å¦ä½å¤çerror.html",redirect:"/pages/d93df5/"},{name:"v-2f3e170c",path:"/pages/36b0b2/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2f3e170c").then(t)}},{path:"/pages/36b0b2/index.html",redirect:"/pages/36b0b2/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/05.tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±.html",redirect:"/pages/36b0b2/"},{name:"v-66d9b7c0",path:"/pages/d2c214/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-66d9b7c0").then(t)}},{path:"/pages/d2c214/index.html",redirect:"/pages/d2c214/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/01.Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ.html",redirect:"/pages/d2c214/"},{name:"v-569242f6",path:"/pages/91d2d9/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-569242f6").then(t)}},{path:"/pages/91d2d9/index.html",redirect:"/pages/91d2d9/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/06.ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢.html",redirect:"/pages/91d2d9/"},{name:"v-deed5aca",path:"/pages/88360d/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-deed5aca").then(t)}},{path:"/pages/88360d/index.html",redirect:"/pages/88360d/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/03.Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ.html",redirect:"/pages/88360d/"},{name:"v-2835a650",path:"/pages/49057b/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2835a650").then(t)}},{path:"/pages/49057b/index.html",redirect:"/pages/49057b/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/02.Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå.html",redirect:"/pages/49057b/"},{name:"v-1c8f04f0",path:"/pages/4f7497/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-1c8f04f0").then(t)}},{path:"/pages/4f7497/index.html",redirect:"/pages/4f7497/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/04.Goè¯­è¨é¶æ·è´ææ¯å®å¨æå.html",redirect:"/pages/4f7497/"},{name:"v-e7a69188",path:"/pages/b03207/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-e7a69188").then(t)}},{path:"/pages/b03207/index.html",redirect:"/pages/b03207/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/05.Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ.html",redirect:"/pages/b03207/"},{name:"v-2bccd8fe",path:"/pages/d7dbc7/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-2bccd8fe").then(t)}},{path:"/pages/d7dbc7/index.html",redirect:"/pages/d7dbc7/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/06.Goè¯­è¨åå­é¢åéå®å¨æå.html",redirect:"/pages/d7dbc7/"},{name:"v-6dda71f1",path:"/pages/821b25/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-6dda71f1").then(t)}},{path:"/pages/821b25/index.html",redirect:"/pages/821b25/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/07.Goè¯­è¨åå­æä½å®å¨æå.html",redirect:"/pages/821b25/"},{name:"v-ccb4316a",path:"/pages/c19d45/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-ccb4316a").then(t)}},{path:"/pages/c19d45/index.html",redirect:"/pages/c19d45/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/08.Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ.html",redirect:"/pages/c19d45/"},{name:"v-3b2ad750",path:"/pages/df4833/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3b2ad750").then(t)}},{path:"/pages/df4833/index.html",redirect:"/pages/df4833/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/09.Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨.html",redirect:"/pages/df4833/"},{name:"v-d6123402",path:"/pages/d4c8eb/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-d6123402").then(t)}},{path:"/pages/d4c8eb/index.html",redirect:"/pages/d4c8eb/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/11.Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå.html",redirect:"/pages/d4c8eb/"},{name:"v-1ba8c576",path:"/pages/f9a2a3/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-1ba8c576").then(t)}},{path:"/pages/f9a2a3/index.html",redirect:"/pages/f9a2a3/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/12.Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ.html",redirect:"/pages/f9a2a3/"},{name:"v-3ff27440",path:"/pages/13969e/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-3ff27440").then(t)}},{path:"/pages/13969e/index.html",redirect:"/pages/13969e/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/10.Goè¯­è¨é«æ§è½ç¼ç¨ä¹ç»æä½åå­å¯¹é½.html",redirect:"/pages/13969e/"},{name:"v-99455fdc",path:"/pages/d8ed61/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-99455fdc").then(t)}},{path:"/pages/d8ed61/index.html",redirect:"/pages/d8ed61/"},{path:"/04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/13.Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£.html",redirect:"/pages/d8ed61/"},{name:"v-7f2a6202",path:"/pages/72ba9a/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-7f2a6202").then(t)}},{path:"/pages/72ba9a/index.html",redirect:"/pages/72ba9a/"},{path:"/04.ç¼ç¨/03.linux/01.å¿«éäºè§£iptables.html",redirect:"/pages/72ba9a/"},{name:"v-26efa3da",path:"/pages/143447/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-26efa3da").then(t)}},{path:"/pages/143447/index.html",redirect:"/pages/143447/"},{path:"/04.ç¼ç¨/03.linux/02.çè§£Linux TunTapè®¾å¤.html",redirect:"/pages/143447/"},{name:"v-32e66a02",path:"/pages/c128e7/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-32e66a02").then(t)}},{path:"/pages/c128e7/index.html",redirect:"/pages/c128e7/"},{path:"/04.ç¼ç¨/03.linux/04.çè§£Linux IPIPé§é.html",redirect:"/pages/c128e7/"},{name:"v-5973e693",path:"/pages/8a4b28/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-5973e693").then(t)}},{path:"/pages/8a4b28/index.html",redirect:"/pages/8a4b28/"},{path:"/04.ç¼ç¨/03.linux/03.çè§£VXLANç½ç».html",redirect:"/pages/8a4b28/"},{name:"v-7e9794a8",path:"/pages/aba491/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-7e9794a8").then(t)}},{path:"/pages/aba491/index.html",redirect:"/pages/aba491/"},{path:"/04.ç¼ç¨/09.å¶ä»/02.ä½¿ç¨hueåå»ºozzieçpyspark action workflow.html",redirect:"/pages/aba491/"},{name:"v-7accfee0",path:"/pages/7f16f6/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-7accfee0").then(t)}},{path:"/pages/7f16f6/index.html",redirect:"/pages/7f16f6/"},{path:"/04.ç¼ç¨/09.å¶ä»/03.ä½¿ç¨javaå¼ålogstashçfilteræä»¶.html",redirect:"/pages/7f16f6/"},{name:"v-23857ed1",path:"/pages/d91dfb/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-23857ed1").then(t)}},{path:"/pages/d91dfb/index.html",redirect:"/pages/d91dfb/"},{path:"/04.ç¼ç¨/09.å¶ä»/01.åå¸å¼é.html",redirect:"/pages/d91dfb/"},{name:"v-48a6492a",path:"/pages/19cfb6/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-48a6492a").then(t)}},{path:"/pages/19cfb6/index.html",redirect:"/pages/19cfb6/"},{path:"/04.ç¼ç¨/09.å¶ä»/20.countçæ§è½ä¼å.html",redirect:"/pages/19cfb6/"},{name:"v-38488cef",path:"/pages/8bdb8d/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-38488cef").then(t)}},{path:"/pages/8bdb8d/index.html",redirect:"/pages/8bdb8d/"},{path:"/05.è¯»ä¹¦ç ´ä¸å·/01.å¦ä½éè¯»ä¸æ¬ä¹¦.html",redirect:"/pages/8bdb8d/"},{name:"v-602416af",path:"/pages/92e280/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-602416af").then(t)}},{path:"/pages/92e280/index.html",redirect:"/pages/92e280/"},{path:"/06.AI/01.åè¯ MCP Server.html",redirect:"/pages/92e280/"},{name:"v-c5fbc8ae",path:"/about/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-c5fbc8ae").then(t)}},{path:"/about/index.html",redirect:"/about/"},{path:"/08.å³äº/01.å³äº.html",redirect:"/about/"},{name:"v-fe55c380",path:"/pages/beb6c0bd8a66cea6/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-fe55c380").then(t)}},{path:"/pages/beb6c0bd8a66cea6/index.html",redirect:"/pages/beb6c0bd8a66cea6/"},{path:"/09.æ´å¤/01.æ¶è.html",redirect:"/pages/beb6c0bd8a66cea6/"},{name:"v-67feae3c",path:"/friends/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-67feae3c").then(t)}},{path:"/friends/index.html",redirect:"/friends/"},{path:"/09.æ´å¤/02.åé¾.html",redirect:"/friends/"},{name:"v-31af7045",path:"/archives/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-31af7045").then(t)}},{path:"/archives/index.html",redirect:"/archives/"},{path:"/@pages/archivesPage.html",redirect:"/archives/"},{name:"v-36a595c5",path:"/tags/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-36a595c5").then(t)}},{path:"/tags/index.html",redirect:"/tags/"},{path:"/@pages/tagsPage.html",redirect:"/tags/"},{name:"v-1e8d1344",path:"/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-1e8d1344").then(t)}},{path:"/index.html",redirect:"/"},{name:"v-5cc30ba5",path:"/categories/",component:_l,beforeEnter:(n,e,t)=>{di("Layout","v-5cc30ba5").then(t)}},{path:"/categories/index.html",redirect:"/categories/"},{path:"/@pages/categoriesPage.html",redirect:"/categories/"},{path:"*",component:_l}],kl={title:"éæå³°çåå®¢",description:"ææ¯åå®¢ï¼ä¸æ³¨äºåç«¯å­¦ä¹ ä¸æ»ç»ï¼python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdownç­ææ¯ç±»æç« ",base:"/",headTags:[["link",{rel:"icon",href:"/img/favicon.ico"}],["meta",{name:"keywords",content:"åç«¯åå®¢,ä¸ªäººææ¯åå®¢,åç«¯,åç«¯å¼å,åç«¯æ¡æ¶,åç«¯é¢è¯é¢,ææ¯ææ¡£,å­¦ä¹ ,é¢è¯,python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdown"}],["meta",{name:"baidu-site-verification",content:"7F55weZDDc"}],["meta",{name:"theme-color",content:"#11a8cd"}],["meta",{name:"viewport",content:"width=device-width, initial-scale=1"}],["script",{},'var _hmt = _hmt || [];\n      (function() {\n        var hm = document.createElement("script");\n        hm.src = "https://hm.baidu.com/hm.js?7c28cc47ffa100de44e976f816b0b294";\n        var s = document.getElementsByTagName("script")[0]; \n        s.parentNode.insertBefore(hm, s);\n      })();'],["link",{rel:"alternate",type:"application/rss+xml",href:"https://www.zhengwenfeng.com/rss.xml",title:"éæå³°çåå®¢ RSS Feed"}],["link",{rel:"alternate",type:"application/atom+xml",href:"https://www.zhengwenfeng.com/feed.atom",title:"éæå³°çåå®¢ Atom Feed"}],["link",{rel:"alternate",type:"application/json",href:"https://www.zhengwenfeng.com/feed.json",title:"éæå³°çåå®¢ JSON Feed"}]],pages:[{title:"å®¹å¨çæ¬è´¨",frontmatter:{title:"å®¹å¨çæ¬è´¨",date:"2022-08-10T00:11:48.000Z",permalink:"/pages/f3cf17/",tags:["docker","äºåç"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å®¹å¨å®ç°çä¸»è¦ææ¯ï¼namespaceãcgroupãchroot, éè¿ä»£ç å®ç°ä¸ä¸ªå®¹å¨æ¥æ·±å¥çè§£å¶æ¬è´¨ã",feed:{enable:!0},categories:["äºåç","docker"],comment:!0,meta:[{name:"twitter:title",content:"å®¹å¨çæ¬è´¨"},{name:"twitter:description",content:"å®¹å¨å®ç°çä¸»è¦ææ¯ï¼namespaceãcgroupãchroot, éè¿ä»£ç å®ç°ä¸ä¸ªå®¹å¨æ¥æ·±å¥çè§£å¶æ¬è´¨ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/01.%E5%AE%B9%E5%99%A8%E7%9A%84%E6%9C%AC%E8%B4%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"å®¹å¨çæ¬è´¨"},{property:"og:description",content:"å®¹å¨å®ç°çä¸»è¦ææ¯ï¼namespaceãcgroupãchroot, éè¿ä»£ç å®ç°ä¸ä¸ªå®¹å¨æ¥æ·±å¥çè§£å¶æ¬è´¨ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/01.%E5%AE%B9%E5%99%A8%E7%9A%84%E6%9C%AC%E8%B4%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:11:48.000Z"},{property:"article:tag",content:"docker"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"å®¹å¨çæ¬è´¨"},{itemprop:"description",content:"å®¹å¨å®ç°çä¸»è¦ææ¯ï¼namespaceãcgroupãchroot, éè¿ä»£ç å®ç°ä¸ä¸ªå®¹å¨æ¥æ·±å¥çè§£å¶æ¬è´¨ã"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/01.%E5%AE%B9%E5%99%A8%E7%9A%84%E6%9C%AC%E8%B4%A8.html",relativePath:"01.äºåç/06.docker/01.å®¹å¨çæ¬è´¨.md",key:"v-f7879d60",path:"/pages/f3cf17/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"NameSpace",slug:"namespace",normalizedTitle:"namespace",charIndex:8},{level:2,title:"chroot",slug:"chroot",normalizedTitle:"chroot",charIndex:95},{level:2,title:"æå¨æé ä¸ä¸ªå®¹å¨",slug:"æå¨æé ä¸ä¸ªå®¹å¨",normalizedTitle:"æå¨æé ä¸ä¸ªå®¹å¨",charIndex:819},{level:2,title:"cgroup",slug:"cgroup",normalizedTitle:"cgroup",charIndex:3796}],headersStr:"åè¨ NameSpace chroot æå¨æé ä¸ä¸ªå®¹å¨ cgroup",content:'# åè¨\n\nä½¿ç¨NameSpaceææ¯æ¥ä¿®æ¹è¿ç¨è§å¾ï¼åå»ºåºç¬ç«çæä»¶ç³»ç»ãä¸»æºåãè¿ç¨å·ãç½ç»ç­èµæºç©ºé´ï¼åä½¿ç¨Cgroupsæ¥å®ç°å¯¹è¿ç¨ç CPUãåå­ç­èµæºçä¼åçº§åéé¢éå¶ï¼æåä½¿ç¨chrootæ´æ¹è¿ç¨çæ ¹ç®å½ï¼ä¹å°±æ¯éå¶è®¿é®æä»¶ç³»ç»\n\n\n# NameSpace\n\nå¯ä»¥åå»ºåºç¬ç«çæä»¶ç³»ç»ãä¸»æºåãè¿ç¨å·ãç½ç»ç­èµæºç©ºé´ï¼å®ç°ç³»ç»å¨å±èµæºåè¿ç¨å±é¨èµæºçéç¦»ã\n\nNameSpaceæå¤ç§éç¦»ç±»åï¼åå¸¸è§çæPID NameSpaceå¯ä»¥éç¦»è¿ç¨IDãNET Namespaceéç¦»ç½ç»è®¾å¤ç«¯å£å·ç­ã\n\nä¸¾ä¸ªä¾å­\n\nNameSpaceå¯ä»¥è®©å½åè¿ç¨åªè½çå°å½åNamespaceéçè¿ç¨ï¼çä¸å°å®¿ä¸»æºåå»ºçè¿ç¨ãå¹¶ä¸è¿è¡å®¹å¨çå½ä»¤ä¸º1å·è¿ç¨ã\n\n# docker run -it busybox /bin/sh\n\n/ # ps aux\nPID   USER     COMMAND\n    1 root     /bin/sh\n    8 root     ps aux\n\n/ # echo $$\n1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨å®¿ä¸»æºä¸­å¯ä»¥çå°è¯¥å®¹å¨è¿ç¨IDå¹¶ä¸ä¸º1ãåæ¬¡è¯æå®¹å¨ä¹åªæ¯å®¿ä¸»æºä¸­çä¸ä¸ªè¿ç¨èå·²ã\n\n[root@k8s-master ~]# ps aux | grep /bin/sh | grep -v grep\nroot     1398061  0.1  0.3 1368728 54104 pts/1   Sl+  10:36   0:00 docker run -it mirrors.sangfor.com/busybox /bin/sh\nroot     1398102  0.8  0.0   3176   188 pts/0    Ss+  10:36   0:00 /bin/sh\n\n\n1\n2\n3\n\n\n\n# chroot\n\nå¯ä»¥æ´æ¹è¿ç¨çæ ¹ç®å½ï¼éå¶è®¿é®æä»¶ç³»ç»ã\n\n\n# æå¨æé ä¸ä¸ªå®¹å¨\n\næä»¬ä½¿ç¨cloneåå»ºä¸ä¸ªå­è¿ç¨ï¼ä¼ å¥çåæ°æ¯CLONE_NEWPIDä»£è¡¨çå¯ç¨äºPID NameSpaceï¼å½åè¿ç¨çå°çæ¯ä¸ä¸ªå¨æ°çè¿ç¨ç©ºé´ï¼å¨è¯¥å½åç©ºé´ä¸­ï¼èªå·±æ¯1å·è¿ç¨ã\n\n#define _GNU_SOURCE\n#include <sys/mount.h> \n#include <sys/types.h>\n#include <sys/wait.h>\n#include <stdio.h>\n#include <sched.h>\n#include <signal.h>\n#include <unistd.h>\n#define STACK_SIZE (1024 * 1024)\nstatic char container_stack[STACK_SIZE];\nchar* const container_args[] = {\n  "/bin/bash",\n  NULL\n};\n\nint container_main(void* arg)\n{  \n  printf("Container - inside the container!\\n");\n  execv(container_args[0], container_args);\n  printf("Something\'s wrong!\\n");\n  return 1;\n}\n\nint main()\n{\n  printf("Parent - start a container!\\n");\n  int container_pid = clone(container_main, container_stack+STACK_SIZE, CLONE_NEWPID | SIGCHLD , NULL);\n  waitpid(container_pid, NULL, 0);\n  printf("Parent - container stopped!\\n");\n  return 0;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n\n\n[root@k8s-master k8s]# gcc a.c -o a\n\n[root@k8s-master k8s]# ./a \nParent - start a container!\nContainer - inside the container!\n\n[root@k8s-master k8s]# echo $$\n1\n\n[root@k8s-master k8s]# exit\nParent - container stopped!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä½æ¯æä»¬å¨ä½¿ç¨ps auxæ¶ï¼è¿æ¯çå°æ´ä¸ªå®¿ä¸»æºçè¿ç¨ï¼å¹¶ä¸è¿ç¨IDä¸º1çè¿æ¯Systemdï¼ä¸ºä»ä¹å¢ï¼\n\nè¿æ¯å ä¸ºpså½ä»¤æ¯è¯»/procæä»¶ç³»ç»çï¼æä»¥æä»¬è¿éè¦è¿è¡æä»¶ç³»ç»çéç¦»ã\n\næä»¬åä½¿ç¨Mount NameSpaceè¿è¡æä»¶ç³»ç»çéç¦»ï¼å¨cloneä¸­ä½¿ç¨CLONE_NEWNSåæ°ã\n\nint main()\n{\n  printf("Parent - start a container!\\n");\n  int container_pid = clone(container_main, container_stack+STACK_SIZE, CLONE_NEWPID | CLONE_NEWNS  | SIGCHLD , NULL);\n  waitpid(container_pid, NULL, 0);\n  printf("Parent - container stopped!\\n");\n  return 0;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nç¼è¯è¿è¡åï¼åç°å½åæä»¶ç³»ç»å¹¶æªåçååï¼è¿ä¸ªæ¯å ä¸ºï¼åå»ºå­è¿ç¨æ¶ï¼ä¼ç»§æ¿ç¶è¿ç¨çæè½½ç¹ã\n\næä»¥æä»¬éè¦å¨å­è¿ç¨ä¸­ä¿®æ¹å½åçæè½½ç¹ï¼å¹¶ä¸å­è¿ç¨å¨æ°çnamespaceçæè½½å¨ä½åªå½±åèªèº«çæè½½æä»¶ç³»ç»ã\n\nåæ·è´ä¸ä¸ªæä»¶ç³»ç»åºæ¥ä½ä¸ºæä»¬å®¹å¨çæ ¹æä»¶ç³»ç»\n\ndocker export 48ab2ddd04dc | tar -C ./testfs -xvf -\n\n\n1\n\n\nåæè½½procï¼å¹¶ä¸å°testfsä½ä¸ºè¯¥è¿ç¨çæ ¹ç®å½\n\nint container_main(void* arg)\n{  \n  printf("Container - inside the container!\\n");\n\n  if (mount("proc", "testfs/proc", "proc", 0, NULL)) {\n     perror("proc");\n  }\n\n  if ( chdir("./testfs")!=0 ||  chroot("./") != 0) {\n     perror("chroot");\n  }\n\n  execv(container_args[0], container_args);\n  printf("Something\'s wrong!\\n");\n  return 1;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nåæ¬¡è¿è¡è¿å¥å®¹å¨ä¸­ï¼å½åçæ ¹ç®å½æ¯ä¸é¢æä»¬æé çtestfsï¼å¹¶ä¸ps auxå½ä»¤åªè½çå°å½ånamespaceçè¿ç¨ï¼èçä¸å°å®¿ä¸»æºnamespaceçè¿ç¨äºã\n\n[root@k8s-worker1 k8s]# ./a\nParent - start a container!\nContainer - inside the container!\nroot@k8s-worker1:/# ls\nbin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var\nroot@k8s-worker1:/# ps aux\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0  26680  5452 ?        S    07:42   0:00 /bin/bash\nroot          94  0.0  0.0   5352   692 ?        S    07:49   0:00 ./a\nroot          95  0.0  0.0   4620  3872 ?        S    07:49   0:00 /bin/bash\nroot          99  0.0  0.0   7056  1556 ?        R+   07:49   0:00 ps aux\nroot@k8s-worker1:/# echo $$\n1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# cgroup\n\nå¯ä»¥å®ç°å¯¹è¿ç¨çCPUãåå­ç­èµæºçéé¢éå¶\n\ncgroupå¨æä½ç³»ç»ä¸­æ´é²åºæ¥çæ¥å£æ¯æä»¶ç³»ç»ï¼ä¼ä»¥æä»¶åç®å½å¨/sys/fs/cgroup/ç®å½ä¸­å±ç¤ºï¼ä¸é¢çç®å½é½æ¯å­ç³»ç»ï¼å¯ä»¥éå¶åç§èµæºï¼\n\n[root@iZwz93q4afq8ck02cesqh4Z ~]# ls /sys/fs/cgroup/\nblkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  systemd\ncpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids\n\n\n1\n2\n3\n\n\nå¦ä½éå¶è¿ç¨CPU\n\næ§è¡ä»¥ä¸å½ä»¤å°CPUåå°100%\n\n$ while : ; do : ; done &\n\n\n1\n\n\nä½¿ç¨topå½ä»¤æ¥çæ¯å¦cpuæ¯å¦æ»¡è´è½½\n\n# top\n\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                              \n2503037 root      20   0   26672   5412   3520 R  99.0   0.0   0:46.09 -bash                                                                                  99.49%\n\n\n1\n2\n3\n4\n\n\nå¨ç®å½/sys/fs/cgroup/cpu,cpuacct/ä¸åå»ºç®å½containerï¼æä½ç³»ç»ä¼èªå¨åå»ºèµæºéå¶æä»¶\n\n[root@k8s-worker1 container]# mkdir container\n[root@k8s-worker1 container]# ls\ncgroup.clone_children  cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.rt_period_us   cpu.stat\ncgroup.procs           cpuacct.usage_all     cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.rt_runtime_us  notify_on_release\ncpuacct.stat           cpuacct.usage_percpu  cpuacct.usage_sys          cpu.cfs_quota_us    cpu.shares         tasks\n\n\n1\n2\n3\n4\n5\n\n\nå¨æä»¶å¤¹ä¸é¢å¯ä»¥æ¥çå°cpu.cfs_quota_usçé»è®¤å¼æ¯-1ï¼ä»£è¡¨æ²¡æéå¶ï¼cpu.cfs_period_usé»è®¤å¼ä¸º100ms(100000us)\n\n# cat /sys/fs/cgroup/cpu/container/cpu.cfs_period_us\n100000\n# cat /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us\n-1\n\n\n1\n2\n3\n4\n\n\n\nåcpu.cfs_quota_usåå¥20ms(20000us)ï¼ä¹å°±æ¯æ¯100msæ¶é´éï¼éå¶çè¿ç¨åªè½éç¨20msï¼ä¹å°±æ¯è¿ä¸ªè¿ç¨åªè½ä½¿ç¨å°20%çCPUå¸¦å®½\n\necho 20000 > /sys/fs/cgroup/cpu//cpu.cfs_quota_us\n\n\n1\n\n\nåå°éå¶çè¿ç¨IDåå¥å°tasksæä»¶ä¸­ï¼å¯ä»¥çå°è¯¥æä»¶ä¸­å·²ç»åå«äºè¯¥å®¹å¨è¿ç¨ID\n\n# echo 2503037 > tasks\n# cat tasks\n2503037\n\n\n1\n2\n3\n\n\nåä½¿ç¨topå¯ä»¥åç°è¯¥è¿ç¨çcpuè¢«éå¶å¨20%\n\n# top\n\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                              \n2503037 root      20   0   26672   5412   3520 R  20.4   0.0   6:43.71 -bash\n\n\n1\n2\n3\n4\n\n\nå®¹å¨è¢«cgroupçæåµ\n\nå½ç¶dockerå·²ç»å°è£å¥½äºï¼ç´æ¥è°ç¨ä»¥ä¸å½ä»¤å³å¯å®ç°ä¸é¢CPUçéå¶\n\ndocker run -it --cpu-period=100000 --cpu-quota=20000 ubuntu /bin/bash\n\n\n1\n\n\nå¯ä»¥çå°å¨/sys/fs/cgroup/cpu,cpuacct/dockerç®å½ä¸åå»ºäºè¯¥å®¹å¨çç®å½ï¼ç®å½ä¸é¢åå«äºèµæºéå¶æä»¶\n\n[root@k8s-worker1 docker]# pwd\n/sys/fs/cgroup/cpu,cpuacct/docker\n[root@k8s-worker1 docker]# ls\n87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c  cpuacct.usage             cpuacct.usage_percpu_user  cpu.cfs_quota_us   cpu.stat\ncgroup.clone_children                                             cpuacct.usage_all         cpuacct.usage_sys          cpu.rt_period_us   notify_on_release\ncgroup.procs                                                      cpuacct.usage_percpu      cpuacct.usage_user         cpu.rt_runtime_us  tasks\ncpuacct.stat\n[root@k8s-worker1 docker]# cd 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c/\n[root@k8s-worker1 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c]# ls\ncgroup.clone_children  cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.rt_period_us   cpu.stat\ncgroup.procs           cpuacct.usage_all     cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.rt_runtime_us  notify_on_release\ncpuacct.stat           cpuacct.usage_percpu  cpuacct.usage_sys          cpu.cfs_quota_us    cpu.shares         tasks\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nå¨è¯¥ç®å½ä¸å¯ä»¥çå°cpu.cfs_quota_usè®¾ç½®æäº20000ï¼å¹¶ä¸tasksä¸­åå«äºè¯¥å®¹å¨è¿ç¨çID\n\n[root@k8s-worker1 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c]# cat cpu.cfs_quota_us \n20000\n[root@k8s-worker1 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c]# cat tasks\n2560954\n\n\n1\n2\n3\n4\n',normalizedContent:'# åè¨\n\nä½¿ç¨namespaceææ¯æ¥ä¿®æ¹è¿ç¨è§å¾ï¼åå»ºåºç¬ç«çæä»¶ç³»ç»ãä¸»æºåãè¿ç¨å·ãç½ç»ç­èµæºç©ºé´ï¼åä½¿ç¨cgroupsæ¥å®ç°å¯¹è¿ç¨ç cpuãåå­ç­èµæºçä¼åçº§åéé¢éå¶ï¼æåä½¿ç¨chrootæ´æ¹è¿ç¨çæ ¹ç®å½ï¼ä¹å°±æ¯éå¶è®¿é®æä»¶ç³»ç»\n\n\n# namespace\n\nå¯ä»¥åå»ºåºç¬ç«çæä»¶ç³»ç»ãä¸»æºåãè¿ç¨å·ãç½ç»ç­èµæºç©ºé´ï¼å®ç°ç³»ç»å¨å±èµæºåè¿ç¨å±é¨èµæºçéç¦»ã\n\nnamespaceæå¤ç§éç¦»ç±»åï¼åå¸¸è§çæpid namespaceå¯ä»¥éç¦»è¿ç¨idãnet namespaceéç¦»ç½ç»è®¾å¤ç«¯å£å·ç­ã\n\nä¸¾ä¸ªä¾å­\n\nnamespaceå¯ä»¥è®©å½åè¿ç¨åªè½çå°å½ånamespaceéçè¿ç¨ï¼çä¸å°å®¿ä¸»æºåå»ºçè¿ç¨ãå¹¶ä¸è¿è¡å®¹å¨çå½ä»¤ä¸º1å·è¿ç¨ã\n\n# docker run -it busybox /bin/sh\n\n/ # ps aux\npid   user     command\n    1 root     /bin/sh\n    8 root     ps aux\n\n/ # echo $$\n1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨å®¿ä¸»æºä¸­å¯ä»¥çå°è¯¥å®¹å¨è¿ç¨idå¹¶ä¸ä¸º1ãåæ¬¡è¯æå®¹å¨ä¹åªæ¯å®¿ä¸»æºä¸­çä¸ä¸ªè¿ç¨èå·²ã\n\n[root@k8s-master ~]# ps aux | grep /bin/sh | grep -v grep\nroot     1398061  0.1  0.3 1368728 54104 pts/1   sl+  10:36   0:00 docker run -it mirrors.sangfor.com/busybox /bin/sh\nroot     1398102  0.8  0.0   3176   188 pts/0    ss+  10:36   0:00 /bin/sh\n\n\n1\n2\n3\n\n\n\n# chroot\n\nå¯ä»¥æ´æ¹è¿ç¨çæ ¹ç®å½ï¼éå¶è®¿é®æä»¶ç³»ç»ã\n\n\n# æå¨æé ä¸ä¸ªå®¹å¨\n\næä»¬ä½¿ç¨cloneåå»ºä¸ä¸ªå­è¿ç¨ï¼ä¼ å¥çåæ°æ¯clone_newpidä»£è¡¨çå¯ç¨äºpid namespaceï¼å½åè¿ç¨çå°çæ¯ä¸ä¸ªå¨æ°çè¿ç¨ç©ºé´ï¼å¨è¯¥å½åç©ºé´ä¸­ï¼èªå·±æ¯1å·è¿ç¨ã\n\n#define _gnu_source\n#include <sys/mount.h> \n#include <sys/types.h>\n#include <sys/wait.h>\n#include <stdio.h>\n#include <sched.h>\n#include <signal.h>\n#include <unistd.h>\n#define stack_size (1024 * 1024)\nstatic char container_stack[stack_size];\nchar* const container_args[] = {\n  "/bin/bash",\n  null\n};\n\nint container_main(void* arg)\n{  \n  printf("container - inside the container!\\n");\n  execv(container_args[0], container_args);\n  printf("something\'s wrong!\\n");\n  return 1;\n}\n\nint main()\n{\n  printf("parent - start a container!\\n");\n  int container_pid = clone(container_main, container_stack+stack_size, clone_newpid | sigchld , null);\n  waitpid(container_pid, null, 0);\n  printf("parent - container stopped!\\n");\n  return 0;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n\n\n[root@k8s-master k8s]# gcc a.c -o a\n\n[root@k8s-master k8s]# ./a \nparent - start a container!\ncontainer - inside the container!\n\n[root@k8s-master k8s]# echo $$\n1\n\n[root@k8s-master k8s]# exit\nparent - container stopped!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä½æ¯æä»¬å¨ä½¿ç¨ps auxæ¶ï¼è¿æ¯çå°æ´ä¸ªå®¿ä¸»æºçè¿ç¨ï¼å¹¶ä¸è¿ç¨idä¸º1çè¿æ¯systemdï¼ä¸ºä»ä¹å¢ï¼\n\nè¿æ¯å ä¸ºpså½ä»¤æ¯è¯»/procæä»¶ç³»ç»çï¼æä»¥æä»¬è¿éè¦è¿è¡æä»¶ç³»ç»çéç¦»ã\n\næä»¬åä½¿ç¨mount namespaceè¿è¡æä»¶ç³»ç»çéç¦»ï¼å¨cloneä¸­ä½¿ç¨clone_newnsåæ°ã\n\nint main()\n{\n  printf("parent - start a container!\\n");\n  int container_pid = clone(container_main, container_stack+stack_size, clone_newpid | clone_newns  | sigchld , null);\n  waitpid(container_pid, null, 0);\n  printf("parent - container stopped!\\n");\n  return 0;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nç¼è¯è¿è¡åï¼åç°å½åæä»¶ç³»ç»å¹¶æªåçååï¼è¿ä¸ªæ¯å ä¸ºï¼åå»ºå­è¿ç¨æ¶ï¼ä¼ç»§æ¿ç¶è¿ç¨çæè½½ç¹ã\n\næä»¥æä»¬éè¦å¨å­è¿ç¨ä¸­ä¿®æ¹å½åçæè½½ç¹ï¼å¹¶ä¸å­è¿ç¨å¨æ°çnamespaceçæè½½å¨ä½åªå½±åèªèº«çæè½½æä»¶ç³»ç»ã\n\nåæ·è´ä¸ä¸ªæä»¶ç³»ç»åºæ¥ä½ä¸ºæä»¬å®¹å¨çæ ¹æä»¶ç³»ç»\n\ndocker export 48ab2ddd04dc | tar -c ./testfs -xvf -\n\n\n1\n\n\nåæè½½procï¼å¹¶ä¸å°testfsä½ä¸ºè¯¥è¿ç¨çæ ¹ç®å½\n\nint container_main(void* arg)\n{  \n  printf("container - inside the container!\\n");\n\n  if (mount("proc", "testfs/proc", "proc", 0, null)) {\n     perror("proc");\n  }\n\n  if ( chdir("./testfs")!=0 ||  chroot("./") != 0) {\n     perror("chroot");\n  }\n\n  execv(container_args[0], container_args);\n  printf("something\'s wrong!\\n");\n  return 1;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nåæ¬¡è¿è¡è¿å¥å®¹å¨ä¸­ï¼å½åçæ ¹ç®å½æ¯ä¸é¢æä»¬æé çtestfsï¼å¹¶ä¸ps auxå½ä»¤åªè½çå°å½ånamespaceçè¿ç¨ï¼èçä¸å°å®¿ä¸»æºnamespaceçè¿ç¨äºã\n\n[root@k8s-worker1 k8s]# ./a\nparent - start a container!\ncontainer - inside the container!\nroot@k8s-worker1:/# ls\nbin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var\nroot@k8s-worker1:/# ps aux\nuser         pid %cpu %mem    vsz   rss tty      stat start   time command\nroot           1  0.0  0.0  26680  5452 ?        s    07:42   0:00 /bin/bash\nroot          94  0.0  0.0   5352   692 ?        s    07:49   0:00 ./a\nroot          95  0.0  0.0   4620  3872 ?        s    07:49   0:00 /bin/bash\nroot          99  0.0  0.0   7056  1556 ?        r+   07:49   0:00 ps aux\nroot@k8s-worker1:/# echo $$\n1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# cgroup\n\nå¯ä»¥å®ç°å¯¹è¿ç¨çcpuãåå­ç­èµæºçéé¢éå¶\n\ncgroupå¨æä½ç³»ç»ä¸­æ´é²åºæ¥çæ¥å£æ¯æä»¶ç³»ç»ï¼ä¼ä»¥æä»¶åç®å½å¨/sys/fs/cgroup/ç®å½ä¸­å±ç¤ºï¼ä¸é¢çç®å½é½æ¯å­ç³»ç»ï¼å¯ä»¥éå¶åç§èµæºï¼\n\n[root@izwz93q4afq8ck02cesqh4z ~]# ls /sys/fs/cgroup/\nblkio  cpuacct      cpuset   freezer  memory   net_cls,net_prio  perf_event  systemd\ncpu    cpu,cpuacct  devices  hugetlb  net_cls  net_prio          pids\n\n\n1\n2\n3\n\n\nå¦ä½éå¶è¿ç¨cpu\n\næ§è¡ä»¥ä¸å½ä»¤å°cpuåå°100%\n\n$ while : ; do : ; done &\n\n\n1\n\n\nä½¿ç¨topå½ä»¤æ¥çæ¯å¦cpuæ¯å¦æ»¡è´è½½\n\n# top\n\npid user      pr  ni    virt    res    shr s  %cpu  %mem     time+ command                                                                              \n2503037 root      20   0   26672   5412   3520 r  99.0   0.0   0:46.09 -bash                                                                                  99.49%\n\n\n1\n2\n3\n4\n\n\nå¨ç®å½/sys/fs/cgroup/cpu,cpuacct/ä¸åå»ºç®å½containerï¼æä½ç³»ç»ä¼èªå¨åå»ºèµæºéå¶æä»¶\n\n[root@k8s-worker1 container]# mkdir container\n[root@k8s-worker1 container]# ls\ncgroup.clone_children  cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.rt_period_us   cpu.stat\ncgroup.procs           cpuacct.usage_all     cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.rt_runtime_us  notify_on_release\ncpuacct.stat           cpuacct.usage_percpu  cpuacct.usage_sys          cpu.cfs_quota_us    cpu.shares         tasks\n\n\n1\n2\n3\n4\n5\n\n\nå¨æä»¶å¤¹ä¸é¢å¯ä»¥æ¥çå°cpu.cfs_quota_usçé»è®¤å¼æ¯-1ï¼ä»£è¡¨æ²¡æéå¶ï¼cpu.cfs_period_usé»è®¤å¼ä¸º100ms(100000us)\n\n# cat /sys/fs/cgroup/cpu/container/cpu.cfs_period_us\n100000\n# cat /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us\n-1\n\n\n1\n2\n3\n4\n\n\n\nåcpu.cfs_quota_usåå¥20ms(20000us)ï¼ä¹å°±æ¯æ¯100msæ¶é´éï¼éå¶çè¿ç¨åªè½éç¨20msï¼ä¹å°±æ¯è¿ä¸ªè¿ç¨åªè½ä½¿ç¨å°20%çcpuå¸¦å®½\n\necho 20000 > /sys/fs/cgroup/cpu//cpu.cfs_quota_us\n\n\n1\n\n\nåå°éå¶çè¿ç¨idåå¥å°tasksæä»¶ä¸­ï¼å¯ä»¥çå°è¯¥æä»¶ä¸­å·²ç»åå«äºè¯¥å®¹å¨è¿ç¨id\n\n# echo 2503037 > tasks\n# cat tasks\n2503037\n\n\n1\n2\n3\n\n\nåä½¿ç¨topå¯ä»¥åç°è¯¥è¿ç¨çcpuè¢«éå¶å¨20%\n\n# top\n\npid user      pr  ni    virt    res    shr s  %cpu  %mem     time+ command                                                                              \n2503037 root      20   0   26672   5412   3520 r  20.4   0.0   6:43.71 -bash\n\n\n1\n2\n3\n4\n\n\nå®¹å¨è¢«cgroupçæåµ\n\nå½ç¶dockerå·²ç»å°è£å¥½äºï¼ç´æ¥è°ç¨ä»¥ä¸å½ä»¤å³å¯å®ç°ä¸é¢cpuçéå¶\n\ndocker run -it --cpu-period=100000 --cpu-quota=20000 ubuntu /bin/bash\n\n\n1\n\n\nå¯ä»¥çå°å¨/sys/fs/cgroup/cpu,cpuacct/dockerç®å½ä¸åå»ºäºè¯¥å®¹å¨çç®å½ï¼ç®å½ä¸é¢åå«äºèµæºéå¶æä»¶\n\n[root@k8s-worker1 docker]# pwd\n/sys/fs/cgroup/cpu,cpuacct/docker\n[root@k8s-worker1 docker]# ls\n87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c  cpuacct.usage             cpuacct.usage_percpu_user  cpu.cfs_quota_us   cpu.stat\ncgroup.clone_children                                             cpuacct.usage_all         cpuacct.usage_sys          cpu.rt_period_us   notify_on_release\ncgroup.procs                                                      cpuacct.usage_percpu      cpuacct.usage_user         cpu.rt_runtime_us  tasks\ncpuacct.stat\n[root@k8s-worker1 docker]# cd 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c/\n[root@k8s-worker1 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c]# ls\ncgroup.clone_children  cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.rt_period_us   cpu.stat\ncgroup.procs           cpuacct.usage_all     cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.rt_runtime_us  notify_on_release\ncpuacct.stat           cpuacct.usage_percpu  cpuacct.usage_sys          cpu.cfs_quota_us    cpu.shares         tasks\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nå¨è¯¥ç®å½ä¸å¯ä»¥çå°cpu.cfs_quota_usè®¾ç½®æäº20000ï¼å¹¶ä¸tasksä¸­åå«äºè¯¥å®¹å¨è¿ç¨çid\n\n[root@k8s-worker1 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c]# cat cpu.cfs_quota_us \n20000\n[root@k8s-worker1 87ee72386a6079ba6411ac8f3030c12407558652d28a1cd16c03f4434581500c]# cat tasks\n2560954\n\n\n1\n2\n3\n4\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å",frontmatter:{title:"æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å",date:"2023-01-08T10:52:18.000Z",permalink:"/pages/d3768c/",tags:["docker","äºåç","å®¹å¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦æ¯éè¿ä½¿ç¨Network Namespaceæ¥æ¨¡å¼dockerçbridgeæ¨¡å¼æ¥æ·±å¥ççè§£å¶åçã",feed:{enable:!0},categories:["äºåç","docker"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731830378711673183036984.png"},{name:"twitter:title",content:"æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å"},{name:"twitter:description",content:"æ¬æä¸»è¦æ¯éè¿ä½¿ç¨Network Namespaceæ¥æ¨¡å¼dockerçbridgeæ¨¡å¼æ¥æ·±å¥ççè§£å¶åçã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731830378711673183036984.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/03.%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0docker%E5%AE%B9%E5%99%A8bridge%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.html"},{property:"og:type",content:"article"},{property:"og:title",content:"æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å"},{property:"og:description",content:"æ¬æä¸»è¦æ¯éè¿ä½¿ç¨Network Namespaceæ¥æ¨¡å¼dockerçbridgeæ¨¡å¼æ¥æ·±å¥ççè§£å¶åçã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731830378711673183036984.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/03.%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0docker%E5%AE%B9%E5%99%A8bridge%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-01-08T10:52:18.000Z"},{property:"article:tag",content:"docker"},{property:"article:tag",content:"äºåç"},{property:"article:tag",content:"å®¹å¨"},{itemprop:"name",content:"æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å"},{itemprop:"description",content:"æ¬æä¸»è¦æ¯éè¿ä½¿ç¨Network Namespaceæ¥æ¨¡å¼dockerçbridgeæ¨¡å¼æ¥æ·±å¥ççè§£å¶åçã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731830378711673183036984.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/03.%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0docker%E5%AE%B9%E5%99%A8bridge%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.html",relativePath:"01.äºåç/06.docker/03.æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å.md",key:"v-6f7bb862",path:"/pages/d3768c/",headers:[{level:2,title:"Network Namespace",slug:"network-namespace",normalizedTitle:"network namespace",charIndex:2},{level:2,title:"å®¹å¨é´ç½ç»äºé",slug:"å®¹å¨é´ç½ç»äºé",normalizedTitle:"å®¹å¨é´ç½ç»äºé",charIndex:202},{level:3,title:"veth pair",slug:"veth-pair",normalizedTitle:"veth pair",charIndex:491},{level:3,title:"å®è·µ",slug:"å®è·µ",normalizedTitle:"å®è·µ",charIndex:635},{level:3,title:"æµè¯",slug:"æµè¯",normalizedTitle:"æµè¯",charIndex:3971},{level:2,title:"å®¿ä¸»æºè®¿é®å®¹å¨",slug:"å®¿ä¸»æºè®¿é®å®¹å¨",normalizedTitle:"å®¿ä¸»æºè®¿é®å®¹å¨",charIndex:6151},{level:2,title:"å®¹å¨åè®¿é®å¤é¨",slug:"å®¹å¨åè®¿é®å¤é¨",normalizedTitle:"å®¹å¨åè®¿é®å¤é¨",charIndex:7551},{level:2,title:"å¤é¨è®¿é®å®¹å¨æ´é²çæå¡",slug:"å¤é¨è®¿é®å®¹å¨æ´é²çæå¡",normalizedTitle:"å¤é¨è®¿é®å®¹å¨æ´é²çæå¡",charIndex:10201}],headersStr:"Network Namespace å®¹å¨é´ç½ç»äºé veth pair å®è·µ æµè¯ å®¿ä¸»æºè®¿é®å®¹å¨ å®¹å¨åè®¿é®å¤é¨ å¤é¨è®¿é®å®¹å¨æ´é²çæå¡",content:"# Network Namespace\n\nNamespace ææ¯æ¯å®¹å¨èæåçéè¦ææ¯ï¼å¯ä»¥å°è¿ç¨éç¦»å¨èªå·±ç Namespace ä¸­ãè Network Namespace ææ¯æ¯å°è¿ç¨éç¦»å¨èªå·±çç½ç»ç©ºé´ä¸­ï¼æ¥æç¬ç«çç½ç»æ ï¼ä»¿ä½èªå·±å¤äºç¬ç«çç½ç»ä¸­ã\n\n> ç½ç»æ æ¯æç½å¡ãåç¯è®¾å¤ãè·¯ç±è¡¨å iptables è§åç­ç­ãç½ç»æ æ¯æç½å¡ãåç¯è®¾å¤ãè·¯ç±è¡¨å iptables è§åç­ç­ã\n\n\n# å®¹å¨é´ç½ç»äºé\n\nå®¹å¨ç bridge ç½ç»æ¨¡å¼ä¼åå»ºå±äºèªå·±ç Network Namespace æ¥éç¦»èªå·±ä¸å®¿ä¸»æºï¼æ¥æå±äºèªå·±çç½ç»æ ãå¯ä»¥çè§£ä¸ºä¸åç Network Namespace æ¯ä¸åçä¸»æºï¼é£ä¹å®ä»¬æ³è¦ç½ç»éä¿¡ï¼è¯¥å¦ä½å®ç°ï¼\n\né¦åæ³å°çå½ç¶æ¯äº¤æ¢æºåè·¯ç±å¨äºï¼å ä¸ºå®ä»¬æ¯å¤äºåä¸ä¸ªç½ç»ä¸­ï¼æä»¥ä½¿ç¨äº¤æ¢æºå³å¯ï¼è Linux æä¾äº bridge æ¥åå½èæäº¤æ¢æºçè§è²ï¼å°å¤ä¸ª Network Namespace æ¥å¥å° bridge ä¸­ï¼å®ä»¬å°±è½ç½ç»äºéäºã\n\né£ä¹å¦ä½å°å®¹å¨ç Network Namespace æ¥å¥å° bridge å¢ï¼\n\n\n# veth pair\n\nveth pair æ¯æå¯¹åºç°çèæç½å¡ï¼å¯ä»¥æå®çåæä¸ä¸ªç®¡éï¼æèä¸æ ¹ç½çº¿ï¼ä»ä¸æ®µè¾å¥çæ°æ®åä¼ä»å¦ä¸ç«¯è¾åºï¼å¯ä»¥éè¿å®æ¥è¿æ¥å®¹å¨ç Network Namespace å bridgeã\n\nä½¿ç¨ veth pair + bridge çç½ç»æ¨¡åå¦ä¸ï¼\n\n\n# å®è·µ\n\næä»¬ä¸ç¨å®è£ dockerï¼ç´æ¥ç¨ Network Namespace æ¥æ¨¡æå®¹å¨çç½ç»ç¯å¢ã\n\n 1. åå»º bridge è®¾å¤\n\nè¿éä½¿ç¨ ip å½ä»¤æ¥å¯¹ bridge è¿è¡æä½ï¼ä¹å¯ä»¥ä½¿ç¨ brctl å½ä»¤ï¼è¯¥å½ä»¤æ¯å¨ bridge-utils åä¸­ã\n\n[root@localhost ~]# ip link add br0 type bridge\n[root@localhost ~]# ip link set dev br0 up\n[root@localhost ~]# ip addr add 10.0.0.3/24 dev br0\n\n[root@localhost ~]# ip link\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: ens18: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000\n    link/ether fe:fc:fe:af:4b:ea brd ff:ff:ff:ff:ff:ff\n60: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000\n    link/ether 7e:b5:12:2d:fd:d4 brd ff:ff:ff:ff:ff:ff\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n 2. åå»º 3 ä¸ª Network Namespace\n\nä½¿ç¨ ip netns å½ä»¤å¯ä»¥å¯¹ Network Namesapce è¿è¡æä½ï¼æä»¥ä½¿ç¨è¯¥å½ä»¤åå»º net0ãnet1 ä¸¤ä¸ª Network Namespace\n\n[root@localhost ~]# ip netns add net0\n[root@localhost ~]# ip netns add net1\n\n\n1\n2\n\n 3. åå»ºä¸¤å¯¹ veth pair\n\né¦ååå»ºä¸¤å¯¹ veth pair èæç½å¡ï¼å®ä»¬æ¯ä¸ä¸å¯¹åºçï¼veth0 å veth1ï¼veth2 å veth3\n\n[root@localhost ~]# ip link add veth0 type veth peer name veth1\n[root@localhost ~]# ip link add veth2 type veth peer name veth3\n\n\n1\n2\n\n\næ¥çåå»ºåºæ¥ç 4 ä¸ªèæç½å¡ï¼@åé¢çæ¯è¯¥ç½å¡çåç§°ï¼åé¢çæ¯è¯¥ç½å¡çå¦ä¸ç«¯ã\n\n[root@localhost ~]# ip a\n...\n67: veth1@veth0: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN group default qlen 1000\n    link/ether 7e:b5:12:2d:fd:d4 brd ff:ff:ff:ff:ff:ff\n68: veth0@veth1: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN group default qlen 1000\n    link/ether 26:22:ef:1a:b3:33 brd ff:ff:ff:ff:ff:ff\n69: veth3@veth2: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN group default qlen 1000\n    link/ether c6:f2:d1:2d:c7:95 brd ff:ff:ff:ff:ff:ff\n70: veth2@veth3: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN group default qlen 1000\n    link/ether ee:4b:0d:17:60:b1 brd ff:ff:ff:ff:ff:ff\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n 4. å° veth pair çä¸ç«¯æ¥å¥å° Network Namespace ä¸­ï¼å¹¶è®¾ç½®å¥½å¶ IP å°å\n\n[root@localhost ~]# ip link set dev veth0 netns net0\n[root@localhost ~]# ip netns exec net0 ip addr add 10.0.0.1/24 dev veth0\n[root@localhost ~]# ip netns exec net0 ip link set dev veth0 up\n\n\n[root@localhost ~]# ip link set dev veth2 netns net1\n[root@localhost ~]# ip netns exec net1 ip addr add 10.0.0.2/24 dev veth2\n[root@localhost ~]# ip netns exec net1 ip link set dev veth2 up\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n> ip netns exec å½ä»¤å¯ä»¥è¿å¥å°æå®ç Network Namespace ä¸­æ§è¡å½ä»¤\n\n 5. å° veth pair çå¦ä¸ç«¯è®¾ç½®å° bridge ä¸­\n\n[root@localhost ~]# ip link set dev veth1 master br0\n[root@localhost ~]# ip link set dev veth3 master br0\n\n[root@localhost ~]# ip link set dev veth1 up\n[root@localhost ~]# ip link set dev veth3 up\n\n\n1\n2\n3\n4\n5\n\n\nå¯ä»¥éè¿å½ä»¤ bridge link æ¥çå° veth1ãveth3é½æå¥å° br0 ä¸­äºã\n\n[root@localhost ~]# bridge link\n67: veth1 state UP @(null): <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master br0 state forwarding priority 32 cost 2 \n69: veth3 state UP @(null): <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master br0 state forwarding priority 32 cost 2\n\n\n1\n2\n3\n\n\nä¹å¯ä»¥éè¿ brctl å½ä»¤æ¥ç\n\n[root@localhost ~]# brctl show\n[root@localhost ~]# brctl show\nbridge name     bridge id               STP enabled     interfaces\nbr0             8000.7eb5122dfdd4       no              veth1\n                                                        veth3\n\n\n1\n2\n3\n4\n5\n\n\n\n# æµè¯\n\n 1. é¦åçå¬ br0 ç½å¡\n\n[root@localhost ~]# tcpdump -i br0\n\n\n1\n\n 2. å¨ net0 ä¸­ ping net1 ç ip\n\nip netns exec net0 ping -c 3 10.0.0.2\n\n\n1\n\n 3. ä¼åç°çå¬ br0 ç½å¡æ¯ææµéçï¼\n\n[root@localhost ~]# tcpdump -i br0\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes\n02:39:41.251428 ARP, Request who-has 10.0.0.2 tell 10.0.0.1, length 28\n02:39:41.251495 ARP, Reply 10.0.0.2 is-at ee:4b:0d:17:60:b1 (oui Unknown), length 28\n02:39:41.251502 IP 10.0.0.1 > 10.0.0.2: ICMP echo request, id 15665, seq 1, length 64\n02:39:41.251702 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply, id 15665, seq 1, length 64\n02:39:42.251435 IP 10.0.0.1 > 10.0.0.2: ICMP echo request, id 15665, seq 2, length 64\n02:39:42.251554 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply, id 15665, seq 2, length 64\n02:39:43.251414 IP 10.0.0.1 > 10.0.0.2: ICMP echo request, id 15665, seq 3, length 64\n02:39:43.251512 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply, id 15665, seq 3, length 64\n02:39:46.261377 ARP, Request who-has 10.0.0.1 tell 10.0.0.2, length 28\n02:39:46.261400 ARP, Reply 10.0.0.1 is-at 26:22:ef:1a:b3:33 (oui Unknown), length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¯ä»¥çå°åæ¯ 10.0.0.1 åéç ARP è·å 10.0.0.2 ç MAC å°åï¼ç¶åååé ICMP çè¯·æ±åååºï¼æå 10.0.0.2 ä¹åé ARP è·å 10.0.0.1 ç MAC å°åã\n\nå ä¸º bridge æ¯äºå±ç½ç»è®¾å¤ï¼æä»¥å®æ¯éè¦éè¿è¯å« MAC å°åæ¥è¿è¡éä¿¡çå±åç½ã\n\nåé¢æåéè¿ net0 ping net1 ç ipï¼åç°å®æ²¡æåé ARP äºï¼è¿ä¸ªæ¯å ä¸ºç¬¬ä¸æ¬¡ bridge å·²ç»å° MAC å°ååç«¯å£çæ å°å³ç³»å·²ç»è®°å½äºä¸æ¥ï¼åé¢å¯ä»¥ç´æ¥éè¿æ¥è¡¨ï¼èä¸ç¨ååé ARP äºã\n\n[root@localhost ~]# tcpdump -i br0 -n \ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes\n02:40:01.267689 IP 10.0.0.1 > 10.0.0.2: ICMP echo request, id 15991, seq 1, length 64\n02:40:01.267948 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply, id 15991, seq 1, length 64\n02:40:02.267509 IP 10.0.0.1 > 10.0.0.2: ICMP echo request, id 15991, seq 2, length 64\n02:40:02.267641 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply, id 15991, seq 2, length 64\n02:40:03.267458 IP 10.0.0.1 > 10.0.0.2: ICMP echo request, id 15991, seq 3, length 64\n02:40:03.267582 IP 10.0.0.2 > 10.0.0.1: ICMP echo reply, id 15991, seq 3, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å®¿ä¸»æºè®¿é®å®¹å¨\n\n 1. åæ¬¡çå¬ br0 ç½å¡\n\ntcpdump -i br0\n\n\n1\n\n 2. å¨å®¿ä¸»æºä¸ ping å®¹å¨åé¨ ipï¼æ¯å¯ä»¥ ping éç\n\nping 10.0.0.1 -n 3\n\n\n1\n\n 3. æ¥ççå¬ç br0 ç½å¡æµéï¼\n\n[root@localhost ~]# tcpdump -i br0 -n \ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes\n02:56:03.232293 ARP, Request who-has 10.0.0.1 tell 10.0.0.3, length 28\n02:56:03.232342 ARP, Reply 10.0.0.1 is-at 26:22:ef:1a:b3:33, length 28\n02:56:03.232379 IP 10.0.0.3 > 10.0.0.1: ICMP echo request, id 3964, seq 1, length 64\n02:56:03.232402 IP 10.0.0.1 > 10.0.0.3: ICMP echo reply, id 3964, seq 1, length 64\n02:56:04.232494 IP 10.0.0.3 > 10.0.0.1: ICMP echo request, id 3964, seq 2, length 64\n02:56:04.232554 IP 10.0.0.1 > 10.0.0.3: ICMP echo reply, id 3964, seq 2, length 64\n02:56:05.232517 IP 10.0.0.3 > 10.0.0.1: ICMP echo request, id 3964, seq 3, length 64\n02:56:05.232607 IP 10.0.0.1 > 10.0.0.3: ICMP echo reply, id 3964, seq 3, length 64\n02:56:08.245354 ARP, Request who-has 10.0.0.3 tell 10.0.0.1, length 28\n02:56:08.245412 ARP, Reply 10.0.0.3 is-at 7e:b5:12:2d:fd:d4, length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¯ä»¥çå°æ¯ 10.0.0.3 è®¿é®éäº 10.0.0.1 ï¼æä»¬æ¯éè¿å®¿ä¸»æºè®¿é®çå®¹å¨åé¨ï¼ä¸ºä»ä¹æº ip åæ 10.0.0.3ï¼\n\n 4. éè¿æ¥çå®¿ä¸»æºçè·¯ç±è¡¨ï¼å¯ä»¥çå°å½æä»¬ ping 10.0.0.1 æ¶ï¼æ¯å¹éä¸äºè¯¥æ¡è·¯ç±ï¼ç¶åèµ° br0 ç½å¡ï¼ä½¿ç¨çæº ip æ¯ br0 ç ip 10.0.0.3\n\n[root@localhost ~]# ip r\n...\n10.0.0.0/24 dev br0 proto kernel scope link src 10.0.0.3 \n...\n\n\n1\n2\n3\n4\n\n\n\n# å®¹å¨åè®¿é®å¤é¨\n\n 1. éç½® Network Namespace ä¸­å° bridge ä½ä¸ºé»è®¤ç½å³\n\nå½æä»¬å¨ net0 åé¨è®¿é®å¤é¨ ip æ¶ï¼ä¼åç°ç½ç»ä¸å¯è¾¾ã\n\n[root@localhost ~]# ip netns exec net0 ping 10.65.132.187\nconnect: Network is unreachable\n\n\n1\n2\n\n\nè¿ä¸ªæ¯å ä¸ºæ²¡æå¹éä¸è·¯ç±è¡¨ä¸çåå \n\n[root@localhost ~]# ip netns exec net0 ip r\n10.0.0.0/24 dev veth0 proto kernel scope link src 10.0.0.1\n\n\n1\n2\n\n\næä»¬å ä¸é»è®¤ç½å³ï¼ä¹å°±æ¯å¨æ²¡æå¹éä¸å¶ä»è·¯ç±æ¶ï¼èµ°è¯¥ç½å³\n\n[root@localhost ~]# ip netns exec net0 ip r add default via 10.0.0.3 dev veth0\n\n[root@localhost ~]# ip netns exec net0 ip r \ndefault via 10.0.0.3 dev veth0 \n10.0.0.0/24 dev veth0 proto kernel scope link src 10.0.0.1 \n\n\n1\n2\n3\n4\n5\n\n 2. éç½®å®¿ä¸»æº iptables ç SNAT è§å\n\næä»¬åæ¬¡å¨å®¹å¨ä¸­è®¿é®å¤é¨ ip æ¶ï¼åç°ç½ç»è¿ä¸å¯è¾¾ï¼ä½æ¯æä»¬çå¬ br0 ç½å¡åç°æ¯ææ°æ®åçï¼ä¹å°±æ¯è·¯ç±éçæ²¡é®é¢\n\n[root@localhost ~]# tcpdump -i br0\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes\n03:23:23.738010 IP 10.0.0.1 > 10.65.132.187: ICMP echo request, id 11228, seq 1, length 64\n03:23:24.737415 IP 10.0.0.1 > 10.65.132.187: ICMP echo request, id 11228, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n\n\næä»¬åçå®¿ä¸»æºä¸çè·¯ç±ï¼æ¯æéç½®é»è®¤è·¯ç±çã\n\n[root@localhost ~]# ip r\ndefault via 10.61.74.1 dev ens18 proto static metric 100\n\n\n1\n2\n\n\næä»¥æåçå¬ä¸ä¸å®¿ä¸»æºçç½å¡ ens18 ççï¼\n\n[root@localhost ~]# tcpdump -i ens18 dst host 10.65.132.187\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type EN10MB (Ethernet), capture size 262144 bytes\n03:24:47.162152 IP 10.0.0.1 > 10.65.132.187: ICMP echo request, id 13281, seq 1, length 64\n03:24:48.161585 IP 10.0.0.1 > 10.65.132.187: ICMP echo request, id 13281, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n\n\nåç°ä¹æ¯ææ°æ®åçï¼ä½æ¯åå°åæ¯ net0 ç ip å°å 10.0.0.1ï¼å¤é¨æ¯ä¸è®¤è¯çï¼æä»¥éè¦éç½® iptablesï¼å°æº IP æ¹ä¸ºå®¿ä¸»æºç IPã\n\n# åå»ºè§å\n[root@localhost ~]# iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -o br0 -j MASQUERADE\n\n# æ¥çè§å\n[root@localhost ~]# iptables -L POSTROUTING -t nat\n...\nMASQUERADE  all  --  10.0.0.0/24          anywhere\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nä¸é¢è®¾ç½® ipatbels çå½ä»¤çå«ä¹æ¯ï¼å¨ POSTROUTING é¾ç nat è¡¨ä¸­æ·»å ä¸æ¡è§åï¼å½æ°æ®åçæº IP ç½æ®µä¸º 10.0.0.0/24 æ¶ï¼å¹¶ä¸ä¸æ¯ç½å¡ br0 åéçï¼å°±æ§è¡ MASQUERADE å¨ä½ï¼è¯¥å¨ä½å°±æ¯æºå°åæ¹ä¸ºå®¿ä¸»æºå°åçè½¬æ¢å¨ä½ã\n\nç°å¨å°±å¯ä»¥ ping éå¤é¨ IP äºï¼æ¥ç ens18 ç½å¡çæ°æ®åï¼æºå°åå·²ç»ä¿®æ¹æå®¿ä¸»æºç½å¡ ens18 çå°åäºã\n\n[root@localhost ~]# tcpdump -i ens18 dst host 10.65.132.187 -n \ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type EN10MB (Ethernet), capture size 262144 bytes\n03:41:51.157483 IP 10.61.74.37 > 10.65.132.187: ICMP echo request, id 3972, seq 1, length 64\n03:41:52.158483 IP 10.61.74.37 > 10.65.132.187: ICMP echo request, id 3972, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n\n\né£å¤é¨ IP ååæ¶ï¼åªæå®¿ä¸»æºç IPï¼å¹¶æ²¡æå®¹å¨ç IPï¼é£å®¿ä¸»æºæä¹ç¥éåéå®¹å¨ä¸­å¢ï¼\n\nè¿ä¸ªæ¯å ä¸ºåæ ¸ netfilter ä¼è¿½è¸ªè®°å½è¿æ¥ï¼æä»¬å¨å¢å äº SNAT è§åæ¶ï¼ç³»ç»ä¼èªå¨å¢å ä¸ä¸ªéå¼çååè§åï¼è¿æ ·è¿åçåä¼èªå¨å°å®¿ä¸»æºç IP æ¿æ¢ä¸ºå®¹å¨ IPã\n\n\n# å¤é¨è®¿é®å®¹å¨æ´é²çæå¡\n\ndocker å®¹å¨å¯ä»¥éè¿-p çæ¹å¼å°å®¹å¨åé¨çç«¯å£æ´é²å°å®¿ä¸»æºä¸­ï¼ç»å¤é¨è®¿é®ï¼è¿ä¸ªæ¯æä¹å®ç°çå¢ï¼\n\n 1. è¿ä¸ªæ¯éè¿ iptables ç DNAT è§åå®ç°ç\n\n# åå»ºè§å\n[root@localhost ~]# iptables -t nat -A PREROUTING  ! -i br0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.0.0.1:80\n\n# æ¥çè§å\n[root@localhost ~]# iptables -L PREROUTING -t nat\nDNAT       tcp  --  anywhere             anywhere             tcp dpt:http to:10.0.0.1:80\n\n\n1\n2\n3\n4\n5\n6\n\n\nåå»ºè§åçå½ä»¤çæææ¯ï¼å¨ PREROUTING é¾ç nat è¡¨ä¸­æ·»å ä¸æ¡è§åï¼æ°æ®åçæ¥æºç½å¡ä¸æ¯ br0ï¼æ°æ®ååè®®æ¯ tcpï¼ç®çç«¯å£æ¯ 80ï¼åè¿è¡ DNATï¼å°ç®ç IP ä»å®¿ä¸»æº IP æ¹ä¸ºå®¹å¨ IPã\n\n 2. å¨ net0 ä¸­å¼å¯ 80 ç«¯å£\n\n[root@localhost ~]# nc -lp 80\n\n\n1\n\n 3. å¨å¤é¨ä¸»æºä¸è®¿é®å®¿ä¸»æºç 80 ç«¯å£ï¼æ¯å¯ä»¥è®¿é®æåç\n\n[root@k8s-master-07rf9 ~]# telnet 10.61.74.37 80\n\n\n1\n",normalizedContent:"# network namespace\n\nnamespace ææ¯æ¯å®¹å¨èæåçéè¦ææ¯ï¼å¯ä»¥å°è¿ç¨éç¦»å¨èªå·±ç namespace ä¸­ãè network namespace ææ¯æ¯å°è¿ç¨éç¦»å¨èªå·±çç½ç»ç©ºé´ä¸­ï¼æ¥æç¬ç«çç½ç»æ ï¼ä»¿ä½èªå·±å¤äºç¬ç«çç½ç»ä¸­ã\n\n> ç½ç»æ æ¯æç½å¡ãåç¯è®¾å¤ãè·¯ç±è¡¨å iptables è§åç­ç­ãç½ç»æ æ¯æç½å¡ãåç¯è®¾å¤ãè·¯ç±è¡¨å iptables è§åç­ç­ã\n\n\n# å®¹å¨é´ç½ç»äºé\n\nå®¹å¨ç bridge ç½ç»æ¨¡å¼ä¼åå»ºå±äºèªå·±ç network namespace æ¥éç¦»èªå·±ä¸å®¿ä¸»æºï¼æ¥æå±äºèªå·±çç½ç»æ ãå¯ä»¥çè§£ä¸ºä¸åç network namespace æ¯ä¸åçä¸»æºï¼é£ä¹å®ä»¬æ³è¦ç½ç»éä¿¡ï¼è¯¥å¦ä½å®ç°ï¼\n\né¦åæ³å°çå½ç¶æ¯äº¤æ¢æºåè·¯ç±å¨äºï¼å ä¸ºå®ä»¬æ¯å¤äºåä¸ä¸ªç½ç»ä¸­ï¼æä»¥ä½¿ç¨äº¤æ¢æºå³å¯ï¼è linux æä¾äº bridge æ¥åå½èæäº¤æ¢æºçè§è²ï¼å°å¤ä¸ª network namespace æ¥å¥å° bridge ä¸­ï¼å®ä»¬å°±è½ç½ç»äºéäºã\n\né£ä¹å¦ä½å°å®¹å¨ç network namespace æ¥å¥å° bridge å¢ï¼\n\n\n# veth pair\n\nveth pair æ¯æå¯¹åºç°çèæç½å¡ï¼å¯ä»¥æå®çåæä¸ä¸ªç®¡éï¼æèä¸æ ¹ç½çº¿ï¼ä»ä¸æ®µè¾å¥çæ°æ®åä¼ä»å¦ä¸ç«¯è¾åºï¼å¯ä»¥éè¿å®æ¥è¿æ¥å®¹å¨ç network namespace å bridgeã\n\nä½¿ç¨ veth pair + bridge çç½ç»æ¨¡åå¦ä¸ï¼\n\n\n# å®è·µ\n\næä»¬ä¸ç¨å®è£ dockerï¼ç´æ¥ç¨ network namespace æ¥æ¨¡æå®¹å¨çç½ç»ç¯å¢ã\n\n 1. åå»º bridge è®¾å¤\n\nè¿éä½¿ç¨ ip å½ä»¤æ¥å¯¹ bridge è¿è¡æä½ï¼ä¹å¯ä»¥ä½¿ç¨ brctl å½ä»¤ï¼è¯¥å½ä»¤æ¯å¨ bridge-utils åä¸­ã\n\n[root@localhost ~]# ip link add br0 type bridge\n[root@localhost ~]# ip link set dev br0 up\n[root@localhost ~]# ip addr add 10.0.0.3/24 dev br0\n\n[root@localhost ~]# ip link\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown mode default group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: ens18: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state up mode default group default qlen 1000\n    link/ether fe:fc:fe:af:4b:ea brd ff:ff:ff:ff:ff:ff\n60: br0: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up mode default group default qlen 1000\n    link/ether 7e:b5:12:2d:fd:d4 brd ff:ff:ff:ff:ff:ff\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n 2. åå»º 3 ä¸ª network namespace\n\nä½¿ç¨ ip netns å½ä»¤å¯ä»¥å¯¹ network namesapce è¿è¡æä½ï¼æä»¥ä½¿ç¨è¯¥å½ä»¤åå»º net0ãnet1 ä¸¤ä¸ª network namespace\n\n[root@localhost ~]# ip netns add net0\n[root@localhost ~]# ip netns add net1\n\n\n1\n2\n\n 3. åå»ºä¸¤å¯¹ veth pair\n\né¦ååå»ºä¸¤å¯¹ veth pair èæç½å¡ï¼å®ä»¬æ¯ä¸ä¸å¯¹åºçï¼veth0 å veth1ï¼veth2 å veth3\n\n[root@localhost ~]# ip link add veth0 type veth peer name veth1\n[root@localhost ~]# ip link add veth2 type veth peer name veth3\n\n\n1\n2\n\n\næ¥çåå»ºåºæ¥ç 4 ä¸ªèæç½å¡ï¼@åé¢çæ¯è¯¥ç½å¡çåç§°ï¼åé¢çæ¯è¯¥ç½å¡çå¦ä¸ç«¯ã\n\n[root@localhost ~]# ip a\n...\n67: veth1@veth0: <broadcast,multicast,m-down> mtu 1500 qdisc noop state down group default qlen 1000\n    link/ether 7e:b5:12:2d:fd:d4 brd ff:ff:ff:ff:ff:ff\n68: veth0@veth1: <broadcast,multicast,m-down> mtu 1500 qdisc noop state down group default qlen 1000\n    link/ether 26:22:ef:1a:b3:33 brd ff:ff:ff:ff:ff:ff\n69: veth3@veth2: <broadcast,multicast,m-down> mtu 1500 qdisc noop state down group default qlen 1000\n    link/ether c6:f2:d1:2d:c7:95 brd ff:ff:ff:ff:ff:ff\n70: veth2@veth3: <broadcast,multicast,m-down> mtu 1500 qdisc noop state down group default qlen 1000\n    link/ether ee:4b:0d:17:60:b1 brd ff:ff:ff:ff:ff:ff\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n 4. å° veth pair çä¸ç«¯æ¥å¥å° network namespace ä¸­ï¼å¹¶è®¾ç½®å¥½å¶ ip å°å\n\n[root@localhost ~]# ip link set dev veth0 netns net0\n[root@localhost ~]# ip netns exec net0 ip addr add 10.0.0.1/24 dev veth0\n[root@localhost ~]# ip netns exec net0 ip link set dev veth0 up\n\n\n[root@localhost ~]# ip link set dev veth2 netns net1\n[root@localhost ~]# ip netns exec net1 ip addr add 10.0.0.2/24 dev veth2\n[root@localhost ~]# ip netns exec net1 ip link set dev veth2 up\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n> ip netns exec å½ä»¤å¯ä»¥è¿å¥å°æå®ç network namespace ä¸­æ§è¡å½ä»¤\n\n 5. å° veth pair çå¦ä¸ç«¯è®¾ç½®å° bridge ä¸­\n\n[root@localhost ~]# ip link set dev veth1 master br0\n[root@localhost ~]# ip link set dev veth3 master br0\n\n[root@localhost ~]# ip link set dev veth1 up\n[root@localhost ~]# ip link set dev veth3 up\n\n\n1\n2\n3\n4\n5\n\n\nå¯ä»¥éè¿å½ä»¤ bridge link æ¥çå° veth1ãveth3é½æå¥å° br0 ä¸­äºã\n\n[root@localhost ~]# bridge link\n67: veth1 state up @(null): <broadcast,multicast,up,lower_up> mtu 1500 master br0 state forwarding priority 32 cost 2 \n69: veth3 state up @(null): <broadcast,multicast,up,lower_up> mtu 1500 master br0 state forwarding priority 32 cost 2\n\n\n1\n2\n3\n\n\nä¹å¯ä»¥éè¿ brctl å½ä»¤æ¥ç\n\n[root@localhost ~]# brctl show\n[root@localhost ~]# brctl show\nbridge name     bridge id               stp enabled     interfaces\nbr0             8000.7eb5122dfdd4       no              veth1\n                                                        veth3\n\n\n1\n2\n3\n4\n5\n\n\n\n# æµè¯\n\n 1. é¦åçå¬ br0 ç½å¡\n\n[root@localhost ~]# tcpdump -i br0\n\n\n1\n\n 2. å¨ net0 ä¸­ ping net1 ç ip\n\nip netns exec net0 ping -c 3 10.0.0.2\n\n\n1\n\n 3. ä¼åç°çå¬ br0 ç½å¡æ¯ææµéçï¼\n\n[root@localhost ~]# tcpdump -i br0\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type en10mb (ethernet), capture size 262144 bytes\n02:39:41.251428 arp, request who-has 10.0.0.2 tell 10.0.0.1, length 28\n02:39:41.251495 arp, reply 10.0.0.2 is-at ee:4b:0d:17:60:b1 (oui unknown), length 28\n02:39:41.251502 ip 10.0.0.1 > 10.0.0.2: icmp echo request, id 15665, seq 1, length 64\n02:39:41.251702 ip 10.0.0.2 > 10.0.0.1: icmp echo reply, id 15665, seq 1, length 64\n02:39:42.251435 ip 10.0.0.1 > 10.0.0.2: icmp echo request, id 15665, seq 2, length 64\n02:39:42.251554 ip 10.0.0.2 > 10.0.0.1: icmp echo reply, id 15665, seq 2, length 64\n02:39:43.251414 ip 10.0.0.1 > 10.0.0.2: icmp echo request, id 15665, seq 3, length 64\n02:39:43.251512 ip 10.0.0.2 > 10.0.0.1: icmp echo reply, id 15665, seq 3, length 64\n02:39:46.261377 arp, request who-has 10.0.0.1 tell 10.0.0.2, length 28\n02:39:46.261400 arp, reply 10.0.0.1 is-at 26:22:ef:1a:b3:33 (oui unknown), length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¯ä»¥çå°åæ¯ 10.0.0.1 åéç arp è·å 10.0.0.2 ç mac å°åï¼ç¶åååé icmp çè¯·æ±åååºï¼æå 10.0.0.2 ä¹åé arp è·å 10.0.0.1 ç mac å°åã\n\nå ä¸º bridge æ¯äºå±ç½ç»è®¾å¤ï¼æä»¥å®æ¯éè¦éè¿è¯å« mac å°åæ¥è¿è¡éä¿¡çå±åç½ã\n\nåé¢æåéè¿ net0 ping net1 ç ipï¼åç°å®æ²¡æåé arp äºï¼è¿ä¸ªæ¯å ä¸ºç¬¬ä¸æ¬¡ bridge å·²ç»å° mac å°ååç«¯å£çæ å°å³ç³»å·²ç»è®°å½äºä¸æ¥ï¼åé¢å¯ä»¥ç´æ¥éè¿æ¥è¡¨ï¼èä¸ç¨ååé arp äºã\n\n[root@localhost ~]# tcpdump -i br0 -n \ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type en10mb (ethernet), capture size 262144 bytes\n02:40:01.267689 ip 10.0.0.1 > 10.0.0.2: icmp echo request, id 15991, seq 1, length 64\n02:40:01.267948 ip 10.0.0.2 > 10.0.0.1: icmp echo reply, id 15991, seq 1, length 64\n02:40:02.267509 ip 10.0.0.1 > 10.0.0.2: icmp echo request, id 15991, seq 2, length 64\n02:40:02.267641 ip 10.0.0.2 > 10.0.0.1: icmp echo reply, id 15991, seq 2, length 64\n02:40:03.267458 ip 10.0.0.1 > 10.0.0.2: icmp echo request, id 15991, seq 3, length 64\n02:40:03.267582 ip 10.0.0.2 > 10.0.0.1: icmp echo reply, id 15991, seq 3, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å®¿ä¸»æºè®¿é®å®¹å¨\n\n 1. åæ¬¡çå¬ br0 ç½å¡\n\ntcpdump -i br0\n\n\n1\n\n 2. å¨å®¿ä¸»æºä¸ ping å®¹å¨åé¨ ipï¼æ¯å¯ä»¥ ping éç\n\nping 10.0.0.1 -n 3\n\n\n1\n\n 3. æ¥ççå¬ç br0 ç½å¡æµéï¼\n\n[root@localhost ~]# tcpdump -i br0 -n \ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type en10mb (ethernet), capture size 262144 bytes\n02:56:03.232293 arp, request who-has 10.0.0.1 tell 10.0.0.3, length 28\n02:56:03.232342 arp, reply 10.0.0.1 is-at 26:22:ef:1a:b3:33, length 28\n02:56:03.232379 ip 10.0.0.3 > 10.0.0.1: icmp echo request, id 3964, seq 1, length 64\n02:56:03.232402 ip 10.0.0.1 > 10.0.0.3: icmp echo reply, id 3964, seq 1, length 64\n02:56:04.232494 ip 10.0.0.3 > 10.0.0.1: icmp echo request, id 3964, seq 2, length 64\n02:56:04.232554 ip 10.0.0.1 > 10.0.0.3: icmp echo reply, id 3964, seq 2, length 64\n02:56:05.232517 ip 10.0.0.3 > 10.0.0.1: icmp echo request, id 3964, seq 3, length 64\n02:56:05.232607 ip 10.0.0.1 > 10.0.0.3: icmp echo reply, id 3964, seq 3, length 64\n02:56:08.245354 arp, request who-has 10.0.0.3 tell 10.0.0.1, length 28\n02:56:08.245412 arp, reply 10.0.0.3 is-at 7e:b5:12:2d:fd:d4, length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¯ä»¥çå°æ¯ 10.0.0.3 è®¿é®éäº 10.0.0.1 ï¼æä»¬æ¯éè¿å®¿ä¸»æºè®¿é®çå®¹å¨åé¨ï¼ä¸ºä»ä¹æº ip åæ 10.0.0.3ï¼\n\n 4. éè¿æ¥çå®¿ä¸»æºçè·¯ç±è¡¨ï¼å¯ä»¥çå°å½æä»¬ ping 10.0.0.1 æ¶ï¼æ¯å¹éä¸äºè¯¥æ¡è·¯ç±ï¼ç¶åèµ° br0 ç½å¡ï¼ä½¿ç¨çæº ip æ¯ br0 ç ip 10.0.0.3\n\n[root@localhost ~]# ip r\n...\n10.0.0.0/24 dev br0 proto kernel scope link src 10.0.0.3 \n...\n\n\n1\n2\n3\n4\n\n\n\n# å®¹å¨åè®¿é®å¤é¨\n\n 1. éç½® network namespace ä¸­å° bridge ä½ä¸ºé»è®¤ç½å³\n\nå½æä»¬å¨ net0 åé¨è®¿é®å¤é¨ ip æ¶ï¼ä¼åç°ç½ç»ä¸å¯è¾¾ã\n\n[root@localhost ~]# ip netns exec net0 ping 10.65.132.187\nconnect: network is unreachable\n\n\n1\n2\n\n\nè¿ä¸ªæ¯å ä¸ºæ²¡æå¹éä¸è·¯ç±è¡¨ä¸çåå \n\n[root@localhost ~]# ip netns exec net0 ip r\n10.0.0.0/24 dev veth0 proto kernel scope link src 10.0.0.1\n\n\n1\n2\n\n\næä»¬å ä¸é»è®¤ç½å³ï¼ä¹å°±æ¯å¨æ²¡æå¹éä¸å¶ä»è·¯ç±æ¶ï¼èµ°è¯¥ç½å³\n\n[root@localhost ~]# ip netns exec net0 ip r add default via 10.0.0.3 dev veth0\n\n[root@localhost ~]# ip netns exec net0 ip r \ndefault via 10.0.0.3 dev veth0 \n10.0.0.0/24 dev veth0 proto kernel scope link src 10.0.0.1 \n\n\n1\n2\n3\n4\n5\n\n 2. éç½®å®¿ä¸»æº iptables ç snat è§å\n\næä»¬åæ¬¡å¨å®¹å¨ä¸­è®¿é®å¤é¨ ip æ¶ï¼åç°ç½ç»è¿ä¸å¯è¾¾ï¼ä½æ¯æä»¬çå¬ br0 ç½å¡åç°æ¯ææ°æ®åçï¼ä¹å°±æ¯è·¯ç±éçæ²¡é®é¢\n\n[root@localhost ~]# tcpdump -i br0\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on br0, link-type en10mb (ethernet), capture size 262144 bytes\n03:23:23.738010 ip 10.0.0.1 > 10.65.132.187: icmp echo request, id 11228, seq 1, length 64\n03:23:24.737415 ip 10.0.0.1 > 10.65.132.187: icmp echo request, id 11228, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n\n\næä»¬åçå®¿ä¸»æºä¸çè·¯ç±ï¼æ¯æéç½®é»è®¤è·¯ç±çã\n\n[root@localhost ~]# ip r\ndefault via 10.61.74.1 dev ens18 proto static metric 100\n\n\n1\n2\n\n\næä»¥æåçå¬ä¸ä¸å®¿ä¸»æºçç½å¡ ens18 ççï¼\n\n[root@localhost ~]# tcpdump -i ens18 dst host 10.65.132.187\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type en10mb (ethernet), capture size 262144 bytes\n03:24:47.162152 ip 10.0.0.1 > 10.65.132.187: icmp echo request, id 13281, seq 1, length 64\n03:24:48.161585 ip 10.0.0.1 > 10.65.132.187: icmp echo request, id 13281, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n\n\nåç°ä¹æ¯ææ°æ®åçï¼ä½æ¯åå°åæ¯ net0 ç ip å°å 10.0.0.1ï¼å¤é¨æ¯ä¸è®¤è¯çï¼æä»¥éè¦éç½® iptablesï¼å°æº ip æ¹ä¸ºå®¿ä¸»æºç ipã\n\n# åå»ºè§å\n[root@localhost ~]# iptables -t nat -a postrouting -s 10.0.0.0/24 ! -o br0 -j masquerade\n\n# æ¥çè§å\n[root@localhost ~]# iptables -l postrouting -t nat\n...\nmasquerade  all  --  10.0.0.0/24          anywhere\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nä¸é¢è®¾ç½® ipatbels çå½ä»¤çå«ä¹æ¯ï¼å¨ postrouting é¾ç nat è¡¨ä¸­æ·»å ä¸æ¡è§åï¼å½æ°æ®åçæº ip ç½æ®µä¸º 10.0.0.0/24 æ¶ï¼å¹¶ä¸ä¸æ¯ç½å¡ br0 åéçï¼å°±æ§è¡ masquerade å¨ä½ï¼è¯¥å¨ä½å°±æ¯æºå°åæ¹ä¸ºå®¿ä¸»æºå°åçè½¬æ¢å¨ä½ã\n\nç°å¨å°±å¯ä»¥ ping éå¤é¨ ip äºï¼æ¥ç ens18 ç½å¡çæ°æ®åï¼æºå°åå·²ç»ä¿®æ¹æå®¿ä¸»æºç½å¡ ens18 çå°åäºã\n\n[root@localhost ~]# tcpdump -i ens18 dst host 10.65.132.187 -n \ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type en10mb (ethernet), capture size 262144 bytes\n03:41:51.157483 ip 10.61.74.37 > 10.65.132.187: icmp echo request, id 3972, seq 1, length 64\n03:41:52.158483 ip 10.61.74.37 > 10.65.132.187: icmp echo request, id 3972, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n\n\né£å¤é¨ ip ååæ¶ï¼åªæå®¿ä¸»æºç ipï¼å¹¶æ²¡æå®¹å¨ç ipï¼é£å®¿ä¸»æºæä¹ç¥éåéå®¹å¨ä¸­å¢ï¼\n\nè¿ä¸ªæ¯å ä¸ºåæ ¸ netfilter ä¼è¿½è¸ªè®°å½è¿æ¥ï¼æä»¬å¨å¢å äº snat è§åæ¶ï¼ç³»ç»ä¼èªå¨å¢å ä¸ä¸ªéå¼çååè§åï¼è¿æ ·è¿åçåä¼èªå¨å°å®¿ä¸»æºç ip æ¿æ¢ä¸ºå®¹å¨ ipã\n\n\n# å¤é¨è®¿é®å®¹å¨æ´é²çæå¡\n\ndocker å®¹å¨å¯ä»¥éè¿-p çæ¹å¼å°å®¹å¨åé¨çç«¯å£æ´é²å°å®¿ä¸»æºä¸­ï¼ç»å¤é¨è®¿é®ï¼è¿ä¸ªæ¯æä¹å®ç°çå¢ï¼\n\n 1. è¿ä¸ªæ¯éè¿ iptables ç dnat è§åå®ç°ç\n\n# åå»ºè§å\n[root@localhost ~]# iptables -t nat -a prerouting  ! -i br0 -p tcp -m tcp --dport 80 -j dnat --to-destination 10.0.0.1:80\n\n# æ¥çè§å\n[root@localhost ~]# iptables -l prerouting -t nat\ndnat       tcp  --  anywhere             anywhere             tcp dpt:http to:10.0.0.1:80\n\n\n1\n2\n3\n4\n5\n6\n\n\nåå»ºè§åçå½ä»¤çæææ¯ï¼å¨ prerouting é¾ç nat è¡¨ä¸­æ·»å ä¸æ¡è§åï¼æ°æ®åçæ¥æºç½å¡ä¸æ¯ br0ï¼æ°æ®ååè®®æ¯ tcpï¼ç®çç«¯å£æ¯ 80ï¼åè¿è¡ dnatï¼å°ç®ç ip ä»å®¿ä¸»æº ip æ¹ä¸ºå®¹å¨ ipã\n\n 2. å¨ net0 ä¸­å¼å¯ 80 ç«¯å£\n\n[root@localhost ~]# nc -lp 80\n\n\n1\n\n 3. å¨å¤é¨ä¸»æºä¸è®¿é®å®¿ä¸»æºç 80 ç«¯å£ï¼æ¯å¯ä»¥è®¿é®æåç\n\n[root@k8s-master-07rf9 ~]# telnet 10.61.74.37 80\n\n\n1\n",charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"dockerå®¹å¨",frontmatter:{title:"dockerå®¹å¨",date:"2022-08-10T00:11:29.000Z",permalink:"/pages/39f36e/",tags:["docker","äºåç","å®¹å¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ç®ä»dockeråå¶ä½¿ç¨æ¹æ³",feed:{enable:!0},categories:["äºåç","docker"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220705193057.png"},{name:"twitter:title",content:"dockerå®¹å¨"},{name:"twitter:description",content:"ç®ä»dockeråå¶ä½¿ç¨æ¹æ³"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220705193057.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/02.docker%E5%AE%B9%E5%99%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"dockerå®¹å¨"},{property:"og:description",content:"ç®ä»dockeråå¶ä½¿ç¨æ¹æ³"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220705193057.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/02.docker%E5%AE%B9%E5%99%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:11:29.000Z"},{property:"article:tag",content:"docker"},{property:"article:tag",content:"äºåç"},{property:"article:tag",content:"å®¹å¨"},{itemprop:"name",content:"dockerå®¹å¨"},{itemprop:"description",content:"ç®ä»dockeråå¶ä½¿ç¨æ¹æ³"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220705193057.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/02.docker%E5%AE%B9%E5%99%A8.html",relativePath:"01.äºåç/06.docker/02.dockerå®¹å¨.md",key:"v-08a8939a",path:"/pages/39f36e/",headers:[{level:2,title:"å®¹å¨æ¯ä»ä¹ï¼",slug:"å®¹å¨æ¯ä»ä¹",normalizedTitle:"å®¹å¨æ¯ä»ä¹ï¼",charIndex:15},{level:2,title:"ä¸ºä»ä¹è¦éç¦»?",slug:"ä¸ºä»ä¹è¦éç¦»",normalizedTitle:"ä¸ºä»ä¹è¦éç¦»?",charIndex:42},{level:2,title:"åèææºçåºå«æ¯ä»ä¹?",slug:"åèææºçåºå«æ¯ä»ä¹",normalizedTitle:"åèææºçåºå«æ¯ä»ä¹?",charIndex:100},{level:2,title:"ä»ä¹æ¯å®¹å¨ååºç¨ï¼",slug:"ä»ä¹æ¯å®¹å¨ååºç¨",normalizedTitle:"ä»ä¹æ¯å®¹å¨ååºç¨ï¼",charIndex:606},{level:2,title:"dockeræ¶æ",slug:"dockeræ¶æ",normalizedTitle:"dockeræ¶æ",charIndex:840},{level:2,title:"å¸¸ç¨éåæä½",slug:"å¸¸ç¨éåæä½",normalizedTitle:"å¸¸ç¨éåæä½",charIndex:1054},{level:2,title:"å¸¸ç¨å®¹å¨æä½",slug:"å¸¸ç¨å®¹å¨æä½",normalizedTitle:"å¸¸ç¨å®¹å¨æä½",charIndex:1164},{level:2,title:"å®¹å¨éå",slug:"å®¹å¨éå",normalizedTitle:"å®¹å¨éå",charIndex:2093},{level:3,title:"éååé¨æºå¶",slug:"éååé¨æºå¶",normalizedTitle:"éååé¨æºå¶",charIndex:2102},{level:2,title:"Dockerfile",slug:"dockerfile",normalizedTitle:"dockerfile",charIndex:5229},{level:2,title:"å®¹å¨ä¸å¤é¨çäº¤äº",slug:"å®¹å¨ä¸å¤é¨çäº¤äº",normalizedTitle:"å®¹å¨ä¸å¤é¨çäº¤äº",charIndex:5781},{level:2,title:"å³äºk8sä¸dockerçå³ç³»",slug:"å³äºk8sä¸dockerçå³ç³»",normalizedTitle:"å³äºk8sä¸dockerçå³ç³»",charIndex:6584}],headersStr:"å®¹å¨æ¯ä»ä¹ï¼ ä¸ºä»ä¹è¦éç¦»? åèææºçåºå«æ¯ä»ä¹? ä»ä¹æ¯å®¹å¨ååºç¨ï¼ dockeræ¶æ å¸¸ç¨éåæä½ å¸¸ç¨å®¹å¨æä½ å®¹å¨éå éååé¨æºå¶ Dockerfile å®¹å¨ä¸å¤é¨çäº¤äº å³äºk8sä¸dockerçå³ç³»",content:'# dockerå®¹å¨\n\n\n# å®¹å¨æ¯ä»ä¹ï¼\n\nå®¹å¨ï¼å°±æ¯ä¸ä¸ªè¢«éç¦»çè¿ç¨ã\n\n\n# ä¸ºä»ä¹è¦éç¦»?\n\n 1. å°åºç¨ç¨åºä¸å¤çç³»ç»éç¦»ï¼ä¿è¯å®¹å¨å¤ç³»ç»å®å¨\n 2. èµæºéç¦»ï¼åªè½ä½¿ç¨æå®éé¢\n\n\n# åèææºçåºå«æ¯ä»ä¹?\n\nèææºï¼èæçæ¯ç¡¬ä»¶ï¼éè¦å¨ä¸é¢å®è£æä½ç³»ç»æè½è¿è¡åºç¨ç¨åºã\n\nå®¹å¨ï¼å±äº«ä¸å±çç¡¬ä»¶åæä½ç³»ç»ã\n\nä¸å¾æ¯å®æ¹çå¾\n\n\n\nå¶å®ä¸å¾å³äºå®¹å¨çé¨åå¹¶ä¸åç¡®ï¼APPä¹å°±æ¯å®¹å¨å¹¶ä¸æ¯è¿è¡å¨Dockerä¸çï¼Dockeråªæ¯å¨å¸®å©ç¨æ·åå»ºè¿ç¨æ¶æ·»å äºåç§Namespaceåæ°ï¼å®¹å¨æ¯ç¹æ®çè¿ç¨ï¼è¿æ¯è¿è¡å¨æä½ç³»ç»ä¸çã\n\n      å®ç°æ¹å¼             ä¼å¿             å£å¿\nèææº   èæåç¡¬ä»¶            éç¦»ç¨åº¦éå¸¸é«        èµæºæ¶èå¤§ï¼å¯å¨æ¢\nå®¹å¨    ç´æ¥å©ç¨ä¸å±çç¡¬ä»¶åæä½ç³»ç»   èµæºå©ç¨çé«ï¼è¿è¡éåº¦å¿«   éç¦»ç¨åº¦ä½, å®å¨æ§ä½\n\n 1. èææºæ¯ç¡¬ä»¶çº§å«çéç¦»ï¼èå®¹å¨åæ¯è¿ç¨é´çéç¦»ã\n\n 2. èæåéè¦æ¨¡æç¡¬ä»¶å ç¨é¨ååå­ï¼å¹¶ä¸å¯¹å®¿ä¸»æºæä½çç³»ç»è°ç¨éè¦ç»è¿èæåè½¯ä»¶çæ¦æªä¸è½¬æ¢ï¼é æèµæºçå¼éãèå®¹å¨å°±æ¯ä¸ä¸ªæ®éçè¿ç¨ï¼åºæ¬æ é¢å¤çè®¡ç®èµæºçå¼éã\n\n 3. å¨Linuxåæ ¸ä¸­æé¨åçèµæºåå¯¹è±¡æ æ³namespaceåï¼å¦æ¶é´ã\n\n 4. å ä¸ºå®¹å¨æ¯å±äº«å®¿ä¸»æºåæ ¸ï¼æä»¥å¯¹å¤æ´é²çä¾ç»é¢éå¸¸çå¤§ã\n\n\n# ä»ä¹æ¯å®¹å¨ååºç¨ï¼\n\néåï¼å°±æ¯å°å®¹å¨çåå§åç¯å¢åºåä¸æ¥ï¼å°è¿è¡è¿ç¨æéè¦çæä»¶ç³»ç»ãä¾èµåºãç¯å¢åéãå¯å¨åæ°ç­æåæ´åå°ä¸èµ·ï¼ä¿å­æä¸ä¸ªéæçæä»¶ã\n\nå®¹å¨åç¯å¢å¯ä»¥éè¿éåå¿«ééå»ºå®¹å¨ï¼åºç¨ç¨åºçå°çå°±æ¯ä¸è´çè¿è¡ç¯å¢ã\n\nå®¹å¨ååºç¨ï¼ä¹å°±æ¯åºç¨ç¨åºä¸ç´æ¥ä¸æä½ç³»ç»å»æäº¤éï¼èæ¯å°åºç¨ç¨åºæåæéåï¼åäº¤ç»å®¹å¨ç¯å¢å»è¿è¡\n\néåä¸å®¹å¨çå³ç³»è¿å¯ä»¥ç¨"åºåå"å"ååºåå"æ¥çè§£ï¼éåå°±æ¯åºååå°ç£ççæ°æ®ï¼èå®¹å¨æ¯ååºååååå­ä¸­çå¯¹è±¡ã\n\n\n\n\n\n\n# dockeræ¶æ\n\nåå»ºå®¹å¨æ¶ï¼æä»¬éè¿dockerå½ä»¤è¯·æ±Docker Daemonæå¡ï¼ç¶åè¯¥æå¡åéè¿RPCè¯·æ±Containerdè¿ç¨ï¼è¯¥è¿ç¨ä¼åå»ºContainerd-shimè¿ç¨ï¼è¯¥è¿ç¨ä¼ååå»ºRunCè¿ç¨ï¼è¯¥è¿ç¨æ¯çæ­£åå»ºå®¹å¨çæ¯è¿ç¨ï¼ç­å®¹å¨åå»ºå¥½åï¼RunCä¼éåºï¼å®¹å¨çç¶è¿ç¨ä¼åæContainerd-shimï¼å½å®¹å¨ç»ææ¶ï¼Conatinerd-shimä¼åæ¶å®¹å¨è¿ç¨çèµæºï¼ä»¥é²æ­¢åµå°¸è¿ç¨ã\n\n\n\n\n# å¸¸ç¨éåæä½\n\nå½ä»¤              ä½ç¨\ndocker pull     ä»è¿ç«¯ä»åºæåéå\ndocker images   ååºå½åæ¬å°å·²æéå\ndocker rmi      å é¤ä¸åä½¿ç¨çéå\n\n\n# å¸¸ç¨å®¹å¨æä½\n\nå½ä»¤              ä½ç¨            ä¾å­\ndocker run      ä½¿ç¨éåå¯å¨å®¹å¨      \ndocker ps       ååºæ­£å¨è¿è¡çå®¹å¨     \ndocker exec     å¨å®¹å¨åæ§è¡å¦ä¸ä¸ªç¨åº   \ndocker stop     åæ­¢å®¹å¨          \ndocker start    å°åæ­¢çå®¹å¨åæ¬¡å¯å¨    \ndocker rm       å é¤å®¹å¨          \ndocker export   å°å®¹å¨åçæä»¶ç³»ç»å¯¼åº   docker export -o rootfs.tar å®¹å¨ID\n\nå®¹å¨è¢«åæ­¢åï¼docker pså½ä»¤å°±çä¸å°è¯¥å®¹å¨äºï¼éè¦ä½¿ç¨docker ps -aæ¥æ¥çææå®¹å¨ï¼åæ¬å·²ç»åæ­¢çå®¹å¨ã\n\nå¯è½ä¼å¯¼è´éå¸¸å¤å·²ç»åæ­¢çå®¹å¨å ç¨ç³»ç»èµæºï¼æä»¥å»ºè®®docker runæ¶æ·»å --rmåæ°ï¼å¨å®¹å¨è¿è¡å®æ¯æ¶èªå¨æ¸é¤\n\ndocker execæ¯å¦ä½è¿å¥å°å®¹å¨ä¸­ç?\n\nè¯¥å½ä»¤ä¼åå»ºä¸ä¸ªæ°çè¿ç¨å å¥å°å®¹å¨çnamepsaceä¸­ã\n\n/proc/{è¿ç¨ID}/ns/ä¸çèææä»¶ä¼é¾æ¥å°çå®çNamespaceæä»¶ä¸ãéè¿æ¥çexecåå»ºçè¿ç¨nsæä»¶å¯ä»¥çåºåå®¹å¨çNamespaceæä»¶ä¸è´\n\n[root@k8s-master proc]# ll /proc/288948/ns/pid\nlrwxrwxrwx 1 root root 0 Jul  8 11:27 /proc/288948/ns/pid -> \'pid:[4026532247]\'\n\n[root@k8s-master proc]# ll /proc/289220/ns/pid\nlrwxrwxrwx 1 root root 0 Jul  8 11:27 /proc/289220/ns/pid -> \'pid:[4026532247]\'\n\n\n1\n2\n3\n4\n5\n\n\ndocker runådocker execçåºå«æ¯ä»ä¹?\n\nrunæ¯å°éåè¿è¡æå®¹å¨å¹¶æ§è¡å½ä»¤ï¼è¯¥å½ä»¤ä¸º1å·è¿ç¨ã\n\nexecæ¯å¨å®¹å¨ä¸­æ§è¡ä¸ä¸ªå½ä»¤ï¼è¯¥å½ä»¤æ¯å¦ä¸ä¸ªè¿ç¨ï¼å å¥å°äºå®¹å¨çnamespaceä¸­ã\n\n\n# å®¹å¨éå\n\n\n# éååé¨æºå¶\n\nå®¹å¨éååé¨æ¯ç±è®¸å¤çéåå±(Layer)ç»æçï¼æ¯å±é½æ¯åªè¯»ä¸å¯ä¿®æ¹çä¸ç»æä»¶ï¼ç¸åçå±å¯ä»¥å¨éåä¸­å±äº«ï¼ç¶åå¤ä¸ªå±åæ­ç§¯æ¨å å èµ·æ¥ï¼ä½¿ç¨**èåæä»¶ç³»ç»ï¼UnionFS)**å°å®ä»¬åå¹¶èµ·æ¥ï¼æç»å½¢æå®¹å¨çå°çæä»¶ç³»ç»ã\n\néåä¸­çå±çº§æ¯åªè¯»å±ï¼èå®¹å¨æå¨çå±çº§æ¯å¯è¯»åå±ã\n\n\n\néåçåå±ä¿¡æ¯å¯ä»¥éè¿å½ä»¤docker inspect éååç§°è·åï¼å¶ä¸­RootFsæ¯å¯¹åºçä¿¡æ¯\n\n>>> docker inspect b3log/siyuan\n\n.....\n"RootFS": {\n            "Type": "layers",\n            "Layers": [\n                "sha256:24302eb7d9085da80f016e7e4ae55417e412fb7e0a8021e95e3b60c67cde557d",\n                "sha256:e7356c89d8c31fc628769b331f73d6e036e1d5900d2d2a3990c89ef91bce707a",\n                "sha256:90358380b9ea63cfb8832ae627455faf85596e822ff8abe9e1d7c8bbd93804ad",\n                "sha256:c6d8ffacc07d179562cd70114402e549d9fce92b12a019d3f4003eb94944d089"\n            ]\n        }\n....\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¥½å¤æ¯ï¼å¦æå¤ä¸ªéåä½¿ç¨äºç¸åçå±ï¼å¯ä»¥ç´æ¥å±äº«ï¼åå°ç£çç©ºé´çå ç¨ãæ¯å¦nginxéååTomcatéåé½æ¯ç¨äºåºç¡éåcentosï¼é£ä¹è¯¥åºç¡éåå¯ä»¥å±äº«ã\n\n\n\nOverlayFS\n\néåå±åå®¹å¨æ¯å¦ä½åå¹¶çå¢ï¼\n\n\n\nlowerdiræ¯éåå±ï¼upperdiræ¯å®¹å¨å±ï¼å¦æåæ¹æç¸åæä»¶åå±ç¤ºå®¹å¨å±çæä»¶ã\n\nå¨å®¹å¨åæä»¶æ¶ï¼ä¼åä»éåå±æ·è´ä¸ä»½æä»¶å°å®¹å¨å±ï¼ç¶åååå¥ï¼ä½¿ç¨çæ¯**åæ¶å¤å¶(copy on write)**ç­ç¥\n\nä¾å­\n\noverlay2\nâââ lowerdirA\nâ   âââ a     åå®¹ï¼AA\nâ   âââ b     åå®¹ï¼AA\nâââ lowerdirB\nâ   âââ a     åå®¹: BB\nâââ merge\nâââ upper\nâââ work\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\næ§è¡ä»¥ä¸å½ä»¤ä½¿ç¨overlayè¿è¡åå¹¶å±\n\nmount -t overlay overlay -o lowerdir=lowerdirA:lowerdirB,upperdir=upper,workdir=work merge\n\n\n1\n\n\nlowerdirä¸ºéåå±ï¼upperdirä¸ºå®¹å¨å±ï¼mergeç®å½ä¸ºæç»å±ç¤ºå±ã\n\nå¯ä»¥çå°mergeç®å½ä¸­çaæä»¶åå®¹lowerdirAéåå±çåå®¹\n\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# cat merge/a \nAA\n\n\n1\n2\n\n\nå½æä»¬ä¿®æ¹megreç®å½ä¸­çaæä»¶æ¶ï¼å¯ä»¥çå°upperdirç®å½çä¼çæaæä»¶å¹¶ä¸åå®¹ä¿®æ¹åçåå®¹\n\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# ls upper/\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# echo upper > merge/a\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# ls upper/\na\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# cat upper/a\nupper\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# cat merge/a\nupper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå½å é¤æä»¶merge/aæ¶ï¼ä¼åºç°ä»ä¹æåµå¢?\n\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# rm merge/a\nrm: remove regular file âmerge/aâ? y\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# ll lowerdirA/\ntotal 8\n-rw-r--r-- 1 root root 3 Jul 12 19:11 a\n-rw-r--r-- 1 root root 3 Jul 12 19:10 b\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]# ll upper/\ntotal 0\nc--------- 1 root root 0, 0 Jul 12 19:31 a\n[root@iZwz93q4afq8ck02cesqh4Z k8s_learn]#\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå¯ä»¥çåºéåå±lowerdirAçæä»¶aæ¯ä¸åçï¼èå¨å®¹å¨å±upperä¸­çaæä»¶ç±»ååæäºcï¼è¯¥æä»¶ç±»åï¼æç»å¨å±ç¤ºå±çä¸å°è¯¥æä»¶äºã\n\nå¯ä»¥ä½¿ç¨å½ä»¤docker inspectæ¥æ¥çlayerçè·¯å¾\n\n>>> docker inspect xxx\n\n....\n"GraphDriver": {\n            "Data": {\n                "LowerDir": "/var/lib/docker/overlay2/641e486c54d15d2a8d807fd8964f4a4b8687cbcf95c176cd9a46553b1e80341d/diff:/var/lib/docker/overlay2/ed9ad4fb9d0f9bf3aea553c634e54fef89448cf43c5b662468d79f01cf41d0c3/diff:/var/lib/docker/overlay2/9db169e1ad2165f688e652ef06dfe9a3e465c31299f3c357a37a6919747efbc8/diff",\n                "MergedDir": "/var/lib/docker/overlay2/fa3166e545a2d1811dbeecb6f1fdda96b9f97b3cd629f32a8ea378aa79b1c780/merged",\n                "UpperDir": "/var/lib/docker/overlay2/fa3166e545a2d1811dbeecb6f1fdda96b9f97b3cd629f32a8ea378aa79b1c780/diff",\n                "WorkDir": "/var/lib/docker/overlay2/fa3166e545a2d1811dbeecb6f1fdda96b9f97b3cd629f32a8ea378aa79b1c780/work"\n            },\n            "Name": "overlay2"\n        },\n....\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# Dockerfile\n\nDockerfileæ¯ä¸ä¸ªç¨æ¥åå»ºéåçææ¬æä»¶ï¼è¯¥æä»¶ä¸­çæ¯ä¸æ¡å½ä»¤é½ä¼æçæä¸ä¸ªlayerã\n\nä¾å­ï¼\n\næç®åçDockerfileçä¾å­\n\nFROM busybox                  # éæ©åºç¡éå\nCMD echo "hello world"        # å¯å¨å®¹å¨æ¶é»è®¤è¿è¡çå½ä»¤\n\n\n1\n2\n\n\nFROMæä»¤æ¯æå»ºä½¿ç¨çåºç¡éå\n\nCMDæä»¤æ¯ç¨äºå¯å¨å®¹å¨æ¶é»è®¤è¿è¡çå½ä»¤\n\nä½¿ç¨docker build å³å¯æ§è¡åå»ºéå\n\ndocker build -f Dockerfile .\n\nSending build context to Docker daemon   7.68kB\nStep 1/2 : FROM busybox\n ---\x3e d38589532d97\nStep 2/2 : CMD echo "hello world"\n ---\x3e Running in c5a762edd1c8\nRemoving intermediate container c5a762edd1c8\n ---\x3e b61882f42db7\nSuccessfully built b61882f42db7\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# å®¹å¨ä¸å¤é¨çäº¤äº\n\nå¦ä½æ·è´å®¿ä¸»æºçæä»¶å°å®¹å¨å\n\nå¯ä»¥ä½¿ç¨docker cpå½ä»¤å°å®¿ä¸»æºçæä»¶æ·è´å°å®¹å¨ä¸­ã\n\ndocker cp a.txt 062:/tmp\n\n\n1\n\n\nå¶ä¸­ç062ä¸ºå®¹å¨IDï¼å¦ææ³å°å®¹å¨ä¸­çæä»¶æ·è´å°å®¿ä¸»æºä¸­ï¼åè¿æ¥å³å¯ã\n\ndocker cp 062:/tmp/a.txt /tmp\n\n\n1\n\n\næ³¨æï¼è¿éçæ·è´æ¯ä¸´æ¶çï¼æ·è´è¿å®¹å¨ä¸­çæä»¶åªå­å¨äºå®¹å¨ä¸­ï¼ä¸å­å¨ä¸éåä¸­ï¼å¦ææ³è¦å°æä»¶æ·è´å°éåä¸­ï¼å¨åDockerfileæ¶ä½¿ç¨copyå½ä»¤æ·è´å³å¯ã\n\nå®¿ä¸»æºä¸å®¹å¨å±äº«æä»¶å¤¹\n\nå¨ä½¿ç¨éåè¿è¡å®¹å¨æ¶ï¼ä½¿ç¨åæ°-vå¯ä»¥å°å®¿ä¸»æºä¸­çæä»¶å¤¹æ å°å°å®¹å¨ä¸­ï¼åæ¹ä¿®æ¹è¯¥æä»¶å¤¹ä¸­çåå®¹ï¼é½å¯ä»¥åæ¶çå°ã\n\ndocker run -d --rm -v /tmp:/tmp redis\n\n\n1\n\n\nå¦ä½å®ç°ç½ç»äºéï¼\n\ndockeræä¾ä¸ç§ç½ç»æ¨¡å¼ï¼\n\n * nullï¼æ ç½ç»\n * hostï¼ç´æ¥ä½¿ç¨å®¿ä¸»æºç½ç»ï¼å¨åå»ºå®¹å¨æ¶ï¼ä½¿ç¨--net=hoståæ°ã\n\nå¶å®å°±æ¯åå»ºæ°çnamespaceï¼èæ¯ç´æ¥å å¥å°å®¿ä¸»æºçnamesapce\n\ndocker run -d --rm --net=host nginx:alpine\n\n\n1\n\n * bridgeï¼æ¡¥æ¥æ¨¡å¼ï¼ç±è½¯ä»¶èæç½å¡ä¸ç½æ¡¥ï¼å®¹å¨åå®¿ä¸»æºé½æ¥å¥è¯¥ç½æ¡¥ï¼å³å¯æ­£å¸¸åéæ°æ®åãå¯ä»¥ä½¿ç¨åæ°--net=bridgeåå»ºå®¹å¨ï¼ä½è¿ä¸ªæ¯é»è®¤åæ°ã\n\ndocker run -d --rm nginx:alpine\n\n\n1\n\n\n\n\nç½ç»æ¨¡å¼     ä¼ç¹                        ç¼ºç¹\nhost     å ä¸ºæ¯ç´æ¥ä½¿ç¨å®¿ä¸»æºçç½ç»ï¼æçæ´é«        è¿è¡å¤ªå¤çå®¹å¨ï¼ä¼å¯¼è´ç«¯å£åçå²çª\nbridge   å ä¸ºæäºç½æ¡¥å¯ä»¥è®¾ç½®æ´å¤çç­ç¥ï¼æ¯å¦æµéæ§å¶ç­   éè¦è½¯ä»¶æ¨¡æèæç½å¡ä¸ç½æ¡¥ï¼æçæ´ä½\n\n\n\n\n\n\n# å³äºk8sä¸dockerçå³ç³»\n\nå¨2014å¹´çæ¶å,Dockerå¦æ¥ä¸­å¤©ï¼é£ä¹k8sèªç¶éæ©åºäºdockerä¸è¿è¡ã\n\nå¨2016å¹´k8så å¥äºCNCFï¼ä¸ä¸ªå¼æºçäºåçè®¡ç®åºéä¼ã\n\nå¹¶ä¸å¼å¥äºä¸ä¸ªæ¥å£æ åï¼CRIï¼Container Runtime Interfaceãä¹å°±æ¯è§å®kubeletè¯¥å¦ä½è°ç¨Container Runtimeå»ç®¡çå®¹å¨åéåï¼ä½è¿æ¯ä¸å¥å¨æ°çæ¥å£ï¼åä¹åçDockerå®å¨ä¸å¼å®¹ãç®çå¾ææ¾ï¼ä¸æ³ç»å®Dockerï¼å¯ä»¥éæ¶å°Dockerè¸¢æã\n\nå ä¸ºdockerå·²ç»éå¸¸æçï¼åå¤§ååä¸å¯è½å°Dockerå¨é¨æ¿æ¢ãæä»¥k8så¨kubeletåDockerä¸­é´å ä¸ä¸ª"ééå¨"ï¼æDockerçæ¥å£è½¬æ¢æç¬¦åCRIæ åçæ¥å£ã\n\n\n\nä»ä¹æ¯containerdï¼\n\nä¸è¿ Docker ä¹æ²¡æâåä»¥å¾æ¯âï¼èæ¯éåäºâæ­èæ±çâçç­ç¥ï¼æ¨å¨èªèº«çéæï¼æåæ¬åä½æ¶æç Docker Engine æåæäºå¤ä¸ªæ¨¡åï¼å¶ä¸­ç Docker daemon é¨åå°±æç®ç»äº CNCFï¼å½¢æäº containerdã\n\ncontainerd ä½ä¸º CNCF çæç®¡é¡¹ç®ï¼èªç¶æ¯è¦ç¬¦å CRI æ åçãä½ Docker åºäºèªå·±è¯¸å¤åå çèèï¼å®åªæ¯å¨ Docker Engine éè°ç¨äº containerdï¼å¤é¨çæ¥å£ä»ç¶ä¿æä¸åï¼ä¹å°±æ¯è¯´è¿ä¸ä¸ CRI å¼å®¹ã\n\nç±äº Docker çâåºæ§å·±è§âï¼è¿æ¶ Kubernetes éå°±åºç°äºä¸¤ç§è°ç¨é¾ï¼ç¬¬ä¸ç§æ¯ç¨ CRI æ¥å£è°ç¨ dockershimï¼ç¶å dockershim è°ç¨ Dockerï¼Docker åèµ° containerd å»æä½å®¹å¨ãç¬¬äºç§æ¯ç¨ CRI æ¥å£ç´æ¥è°ç¨ containerd å»æä½å®¹å¨ã\n\n\n\næ¾èæè§ï¼ä½¿ç¨ç¬¬äºç§çå»äºdockershimåDocker Engineä¸¤ä¸ªç¯èï¼æèæ´å°ï¼æ§è½ä¹æåäºã\n\næ­£å¼"å¼ç¨Docker"\n\nå¨2020å¹´K8så¼ç¨Dockeræ¯æï¼ä½è¯¥å¼ç¨æ¯æå¼ç¨äº"dockershim"çè¿ä¸ªç»ä»¶ï¼ä¹å°±æ¯ædockershimç§»åºkubeleteï¼åªæ¯ç»è¿Dockerï¼ç´æ¥è°ç¨äºDockeråé¨çcontainerdèå·²ã\n\nå¹¶ä¸å¯¹dockerä¹æ å½±åï¼å ä¸ºdockeråé¨ä¹æ¯ä½¿ç¨å¼æºçcontainerdã\n\n\n\nå¯ä¸å½±åçæ¯ï¼k8sæ¯ç´æ¥æä½containerdæä½å®¹å¨ï¼é£ä¹å®ådockeræ¯ç¬ç«çå·¥ä½ç¯å¢ï¼å½¼æ­¤é½ä¸è½è®¿é®å¯¹æ¹çå®¹å¨åéåï¼ä¹å°±æ¯docker psçä¸å°k8sè¿è¡çå®¹å¨ãæ¹ç¨crictlå½ä»¤ã\n\nDocker éæèªèº«ï¼åç¦»åº containerdï¼è¿æ¯å¦ç®æ¯ä¸ç§âèªæåå¢âçè¡ä¸ºå¢ï¼å¦ææ²¡æ containerdï¼é£ç°å¨çæå½¢ä¼æ¯æä¹æ ·çå¢ï¼\n\nDocker æ¯ä¸ä¸ªå®æ´çè½¯ä»¶äº§åçº¿ï¼ä¸æ­¢æ¯ containerdï¼å®è¿åæ¬äºéåæå»ºãååãæµè¯ç­è®¸å¤æå¡ï¼çè³å¨ Docker Desktop éè¿åç½®äº Kubernetesã\n\n> dockeråç¦»containerdæ¯ä¸ä¸ªå¾èªæçä¸¾å¨ï¼ä¸å¶å°æ¥è¢«äººåç¦»æèæå¼ä¸ç¨ï¼ä¸å¦æä¸»å¨é©æ°ï¼æKubernatesç»å¨æçæè½¦ä¸ï¼è¿æ ·criçç¬¬ä¸éæ©ä»ç¶æ¯dockerçèªå·±äººã\n> ä¸æ¶çéè®©æ¯ä¸ºäºæ´å¥½çå°æ¥ã',normalizedContent:'# dockerå®¹å¨\n\n\n# å®¹å¨æ¯ä»ä¹ï¼\n\nå®¹å¨ï¼å°±æ¯ä¸ä¸ªè¢«éç¦»çè¿ç¨ã\n\n\n# ä¸ºä»ä¹è¦éç¦»?\n\n 1. å°åºç¨ç¨åºä¸å¤çç³»ç»éç¦»ï¼ä¿è¯å®¹å¨å¤ç³»ç»å®å¨\n 2. èµæºéç¦»ï¼åªè½ä½¿ç¨æå®éé¢\n\n\n# åèææºçåºå«æ¯ä»ä¹?\n\nèææºï¼èæçæ¯ç¡¬ä»¶ï¼éè¦å¨ä¸é¢å®è£æä½ç³»ç»æè½è¿è¡åºç¨ç¨åºã\n\nå®¹å¨ï¼å±äº«ä¸å±çç¡¬ä»¶åæä½ç³»ç»ã\n\nä¸å¾æ¯å®æ¹çå¾\n\n\n\nå¶å®ä¸å¾å³äºå®¹å¨çé¨åå¹¶ä¸åç¡®ï¼appä¹å°±æ¯å®¹å¨å¹¶ä¸æ¯è¿è¡å¨dockerä¸çï¼dockeråªæ¯å¨å¸®å©ç¨æ·åå»ºè¿ç¨æ¶æ·»å äºåç§namespaceåæ°ï¼å®¹å¨æ¯ç¹æ®çè¿ç¨ï¼è¿æ¯è¿è¡å¨æä½ç³»ç»ä¸çã\n\n      å®ç°æ¹å¼             ä¼å¿             å£å¿\nèææº   èæåç¡¬ä»¶            éç¦»ç¨åº¦éå¸¸é«        èµæºæ¶èå¤§ï¼å¯å¨æ¢\nå®¹å¨    ç´æ¥å©ç¨ä¸å±çç¡¬ä»¶åæä½ç³»ç»   èµæºå©ç¨çé«ï¼è¿è¡éåº¦å¿«   éç¦»ç¨åº¦ä½, å®å¨æ§ä½\n\n 1. èææºæ¯ç¡¬ä»¶çº§å«çéç¦»ï¼èå®¹å¨åæ¯è¿ç¨é´çéç¦»ã\n\n 2. èæåéè¦æ¨¡æç¡¬ä»¶å ç¨é¨ååå­ï¼å¹¶ä¸å¯¹å®¿ä¸»æºæä½çç³»ç»è°ç¨éè¦ç»è¿èæåè½¯ä»¶çæ¦æªä¸è½¬æ¢ï¼é æèµæºçå¼éãèå®¹å¨å°±æ¯ä¸ä¸ªæ®éçè¿ç¨ï¼åºæ¬æ é¢å¤çè®¡ç®èµæºçå¼éã\n\n 3. å¨linuxåæ ¸ä¸­æé¨åçèµæºåå¯¹è±¡æ æ³namespaceåï¼å¦æ¶é´ã\n\n 4. å ä¸ºå®¹å¨æ¯å±äº«å®¿ä¸»æºåæ ¸ï¼æä»¥å¯¹å¤æ´é²çä¾ç»é¢éå¸¸çå¤§ã\n\n\n# ä»ä¹æ¯å®¹å¨ååºç¨ï¼\n\néåï¼å°±æ¯å°å®¹å¨çåå§åç¯å¢åºåä¸æ¥ï¼å°è¿è¡è¿ç¨æéè¦çæä»¶ç³»ç»ãä¾èµåºãç¯å¢åéãå¯å¨åæ°ç­æåæ´åå°ä¸èµ·ï¼ä¿å­æä¸ä¸ªéæçæä»¶ã\n\nå®¹å¨åç¯å¢å¯ä»¥éè¿éåå¿«ééå»ºå®¹å¨ï¼åºç¨ç¨åºçå°çå°±æ¯ä¸è´çè¿è¡ç¯å¢ã\n\nå®¹å¨ååºç¨ï¼ä¹å°±æ¯åºç¨ç¨åºä¸ç´æ¥ä¸æä½ç³»ç»å»æäº¤éï¼èæ¯å°åºç¨ç¨åºæåæéåï¼åäº¤ç»å®¹å¨ç¯å¢å»è¿è¡\n\néåä¸å®¹å¨çå³ç³»è¿å¯ä»¥ç¨"åºåå"å"ååºåå"æ¥çè§£ï¼éåå°±æ¯åºååå°ç£ççæ°æ®ï¼èå®¹å¨æ¯ååºååååå­ä¸­çå¯¹è±¡ã\n\n\n\n\n\n\n# dockeræ¶æ\n\nåå»ºå®¹å¨æ¶ï¼æä»¬éè¿dockerå½ä»¤è¯·æ±docker daemonæå¡ï¼ç¶åè¯¥æå¡åéè¿rpcè¯·æ±containerdè¿ç¨ï¼è¯¥è¿ç¨ä¼åå»ºcontainerd-shimè¿ç¨ï¼è¯¥è¿ç¨ä¼ååå»ºruncè¿ç¨ï¼è¯¥è¿ç¨æ¯çæ­£åå»ºå®¹å¨çæ¯è¿ç¨ï¼ç­å®¹å¨åå»ºå¥½åï¼runcä¼éåºï¼å®¹å¨çç¶è¿ç¨ä¼åæcontainerd-shimï¼å½å®¹å¨ç»ææ¶ï¼conatinerd-shimä¼åæ¶å®¹å¨è¿ç¨çèµæºï¼ä»¥é²æ­¢åµå°¸è¿ç¨ã\n\n\n\n\n# å¸¸ç¨éåæä½\n\nå½ä»¤              ä½ç¨\ndocker pull     ä»è¿ç«¯ä»åºæåéå\ndocker images   ååºå½åæ¬å°å·²æéå\ndocker rmi      å é¤ä¸åä½¿ç¨çéå\n\n\n# å¸¸ç¨å®¹å¨æä½\n\nå½ä»¤              ä½ç¨            ä¾å­\ndocker run      ä½¿ç¨éåå¯å¨å®¹å¨      \ndocker ps       ååºæ­£å¨è¿è¡çå®¹å¨     \ndocker exec     å¨å®¹å¨åæ§è¡å¦ä¸ä¸ªç¨åº   \ndocker stop     åæ­¢å®¹å¨          \ndocker start    å°åæ­¢çå®¹å¨åæ¬¡å¯å¨    \ndocker rm       å é¤å®¹å¨          \ndocker export   å°å®¹å¨åçæä»¶ç³»ç»å¯¼åº   docker export -o rootfs.tar å®¹å¨id\n\nå®¹å¨è¢«åæ­¢åï¼docker pså½ä»¤å°±çä¸å°è¯¥å®¹å¨äºï¼éè¦ä½¿ç¨docker ps -aæ¥æ¥çææå®¹å¨ï¼åæ¬å·²ç»åæ­¢çå®¹å¨ã\n\nå¯è½ä¼å¯¼è´éå¸¸å¤å·²ç»åæ­¢çå®¹å¨å ç¨ç³»ç»èµæºï¼æä»¥å»ºè®®docker runæ¶æ·»å --rmåæ°ï¼å¨å®¹å¨è¿è¡å®æ¯æ¶èªå¨æ¸é¤\n\ndocker execæ¯å¦ä½è¿å¥å°å®¹å¨ä¸­ç?\n\nè¯¥å½ä»¤ä¼åå»ºä¸ä¸ªæ°çè¿ç¨å å¥å°å®¹å¨çnamepsaceä¸­ã\n\n/proc/{è¿ç¨id}/ns/ä¸çèææä»¶ä¼é¾æ¥å°çå®çnamespaceæä»¶ä¸ãéè¿æ¥çexecåå»ºçè¿ç¨nsæä»¶å¯ä»¥çåºåå®¹å¨çnamespaceæä»¶ä¸è´\n\n[root@k8s-master proc]# ll /proc/288948/ns/pid\nlrwxrwxrwx 1 root root 0 jul  8 11:27 /proc/288948/ns/pid -> \'pid:[4026532247]\'\n\n[root@k8s-master proc]# ll /proc/289220/ns/pid\nlrwxrwxrwx 1 root root 0 jul  8 11:27 /proc/289220/ns/pid -> \'pid:[4026532247]\'\n\n\n1\n2\n3\n4\n5\n\n\ndocker runådocker execçåºå«æ¯ä»ä¹?\n\nrunæ¯å°éåè¿è¡æå®¹å¨å¹¶æ§è¡å½ä»¤ï¼è¯¥å½ä»¤ä¸º1å·è¿ç¨ã\n\nexecæ¯å¨å®¹å¨ä¸­æ§è¡ä¸ä¸ªå½ä»¤ï¼è¯¥å½ä»¤æ¯å¦ä¸ä¸ªè¿ç¨ï¼å å¥å°äºå®¹å¨çnamespaceä¸­ã\n\n\n# å®¹å¨éå\n\n\n# éååé¨æºå¶\n\nå®¹å¨éååé¨æ¯ç±è®¸å¤çéåå±(layer)ç»æçï¼æ¯å±é½æ¯åªè¯»ä¸å¯ä¿®æ¹çä¸ç»æä»¶ï¼ç¸åçå±å¯ä»¥å¨éåä¸­å±äº«ï¼ç¶åå¤ä¸ªå±åæ­ç§¯æ¨å å èµ·æ¥ï¼ä½¿ç¨**èåæä»¶ç³»ç»ï¼unionfs)**å°å®ä»¬åå¹¶èµ·æ¥ï¼æç»å½¢æå®¹å¨çå°çæä»¶ç³»ç»ã\n\néåä¸­çå±çº§æ¯åªè¯»å±ï¼èå®¹å¨æå¨çå±çº§æ¯å¯è¯»åå±ã\n\n\n\néåçåå±ä¿¡æ¯å¯ä»¥éè¿å½ä»¤docker inspect éååç§°è·åï¼å¶ä¸­rootfsæ¯å¯¹åºçä¿¡æ¯\n\n>>> docker inspect b3log/siyuan\n\n.....\n"rootfs": {\n            "type": "layers",\n            "layers": [\n                "sha256:24302eb7d9085da80f016e7e4ae55417e412fb7e0a8021e95e3b60c67cde557d",\n                "sha256:e7356c89d8c31fc628769b331f73d6e036e1d5900d2d2a3990c89ef91bce707a",\n                "sha256:90358380b9ea63cfb8832ae627455faf85596e822ff8abe9e1d7c8bbd93804ad",\n                "sha256:c6d8ffacc07d179562cd70114402e549d9fce92b12a019d3f4003eb94944d089"\n            ]\n        }\n....\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¥½å¤æ¯ï¼å¦æå¤ä¸ªéåä½¿ç¨äºç¸åçå±ï¼å¯ä»¥ç´æ¥å±äº«ï¼åå°ç£çç©ºé´çå ç¨ãæ¯å¦nginxéååtomcatéåé½æ¯ç¨äºåºç¡éåcentosï¼é£ä¹è¯¥åºç¡éåå¯ä»¥å±äº«ã\n\n\n\noverlayfs\n\néåå±åå®¹å¨æ¯å¦ä½åå¹¶çå¢ï¼\n\n\n\nlowerdiræ¯éåå±ï¼upperdiræ¯å®¹å¨å±ï¼å¦æåæ¹æç¸åæä»¶åå±ç¤ºå®¹å¨å±çæä»¶ã\n\nå¨å®¹å¨åæä»¶æ¶ï¼ä¼åä»éåå±æ·è´ä¸ä»½æä»¶å°å®¹å¨å±ï¼ç¶åååå¥ï¼ä½¿ç¨çæ¯**åæ¶å¤å¶(copy on write)**ç­ç¥\n\nä¾å­\n\noverlay2\nâââ lowerdira\nâ   âââ a     åå®¹ï¼aa\nâ   âââ b     åå®¹ï¼aa\nâââ lowerdirb\nâ   âââ a     åå®¹: bb\nâââ merge\nâââ upper\nâââ work\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\næ§è¡ä»¥ä¸å½ä»¤ä½¿ç¨overlayè¿è¡åå¹¶å±\n\nmount -t overlay overlay -o lowerdir=lowerdira:lowerdirb,upperdir=upper,workdir=work merge\n\n\n1\n\n\nlowerdirä¸ºéåå±ï¼upperdirä¸ºå®¹å¨å±ï¼mergeç®å½ä¸ºæç»å±ç¤ºå±ã\n\nå¯ä»¥çå°mergeç®å½ä¸­çaæä»¶åå®¹lowerdiraéåå±çåå®¹\n\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# cat merge/a \naa\n\n\n1\n2\n\n\nå½æä»¬ä¿®æ¹megreç®å½ä¸­çaæä»¶æ¶ï¼å¯ä»¥çå°upperdirç®å½çä¼çæaæä»¶å¹¶ä¸åå®¹ä¿®æ¹åçåå®¹\n\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# ls upper/\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# echo upper > merge/a\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# ls upper/\na\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# cat upper/a\nupper\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# cat merge/a\nupper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå½å é¤æä»¶merge/aæ¶ï¼ä¼åºç°ä»ä¹æåµå¢?\n\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# rm merge/a\nrm: remove regular file âmerge/aâ? y\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# ll lowerdira/\ntotal 8\n-rw-r--r-- 1 root root 3 jul 12 19:11 a\n-rw-r--r-- 1 root root 3 jul 12 19:10 b\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]# ll upper/\ntotal 0\nc--------- 1 root root 0, 0 jul 12 19:31 a\n[root@izwz93q4afq8ck02cesqh4z k8s_learn]#\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå¯ä»¥çåºéåå±lowerdiraçæä»¶aæ¯ä¸åçï¼èå¨å®¹å¨å±upperä¸­çaæä»¶ç±»ååæäºcï¼è¯¥æä»¶ç±»åï¼æç»å¨å±ç¤ºå±çä¸å°è¯¥æä»¶äºã\n\nå¯ä»¥ä½¿ç¨å½ä»¤docker inspectæ¥æ¥çlayerçè·¯å¾\n\n>>> docker inspect xxx\n\n....\n"graphdriver": {\n            "data": {\n                "lowerdir": "/var/lib/docker/overlay2/641e486c54d15d2a8d807fd8964f4a4b8687cbcf95c176cd9a46553b1e80341d/diff:/var/lib/docker/overlay2/ed9ad4fb9d0f9bf3aea553c634e54fef89448cf43c5b662468d79f01cf41d0c3/diff:/var/lib/docker/overlay2/9db169e1ad2165f688e652ef06dfe9a3e465c31299f3c357a37a6919747efbc8/diff",\n                "mergeddir": "/var/lib/docker/overlay2/fa3166e545a2d1811dbeecb6f1fdda96b9f97b3cd629f32a8ea378aa79b1c780/merged",\n                "upperdir": "/var/lib/docker/overlay2/fa3166e545a2d1811dbeecb6f1fdda96b9f97b3cd629f32a8ea378aa79b1c780/diff",\n                "workdir": "/var/lib/docker/overlay2/fa3166e545a2d1811dbeecb6f1fdda96b9f97b3cd629f32a8ea378aa79b1c780/work"\n            },\n            "name": "overlay2"\n        },\n....\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# dockerfile\n\ndockerfileæ¯ä¸ä¸ªç¨æ¥åå»ºéåçææ¬æä»¶ï¼è¯¥æä»¶ä¸­çæ¯ä¸æ¡å½ä»¤é½ä¼æçæä¸ä¸ªlayerã\n\nä¾å­ï¼\n\næç®åçdockerfileçä¾å­\n\nfrom busybox                  # éæ©åºç¡éå\ncmd echo "hello world"        # å¯å¨å®¹å¨æ¶é»è®¤è¿è¡çå½ä»¤\n\n\n1\n2\n\n\nfromæä»¤æ¯æå»ºä½¿ç¨çåºç¡éå\n\ncmdæä»¤æ¯ç¨äºå¯å¨å®¹å¨æ¶é»è®¤è¿è¡çå½ä»¤\n\nä½¿ç¨docker build å³å¯æ§è¡åå»ºéå\n\ndocker build -f dockerfile .\n\nsending build context to docker daemon   7.68kb\nstep 1/2 : from busybox\n ---\x3e d38589532d97\nstep 2/2 : cmd echo "hello world"\n ---\x3e running in c5a762edd1c8\nremoving intermediate container c5a762edd1c8\n ---\x3e b61882f42db7\nsuccessfully built b61882f42db7\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# å®¹å¨ä¸å¤é¨çäº¤äº\n\nå¦ä½æ·è´å®¿ä¸»æºçæä»¶å°å®¹å¨å\n\nå¯ä»¥ä½¿ç¨docker cpå½ä»¤å°å®¿ä¸»æºçæä»¶æ·è´å°å®¹å¨ä¸­ã\n\ndocker cp a.txt 062:/tmp\n\n\n1\n\n\nå¶ä¸­ç062ä¸ºå®¹å¨idï¼å¦ææ³å°å®¹å¨ä¸­çæä»¶æ·è´å°å®¿ä¸»æºä¸­ï¼åè¿æ¥å³å¯ã\n\ndocker cp 062:/tmp/a.txt /tmp\n\n\n1\n\n\næ³¨æï¼è¿éçæ·è´æ¯ä¸´æ¶çï¼æ·è´è¿å®¹å¨ä¸­çæä»¶åªå­å¨äºå®¹å¨ä¸­ï¼ä¸å­å¨ä¸éåä¸­ï¼å¦ææ³è¦å°æä»¶æ·è´å°éåä¸­ï¼å¨ådockerfileæ¶ä½¿ç¨copyå½ä»¤æ·è´å³å¯ã\n\nå®¿ä¸»æºä¸å®¹å¨å±äº«æä»¶å¤¹\n\nå¨ä½¿ç¨éåè¿è¡å®¹å¨æ¶ï¼ä½¿ç¨åæ°-vå¯ä»¥å°å®¿ä¸»æºä¸­çæä»¶å¤¹æ å°å°å®¹å¨ä¸­ï¼åæ¹ä¿®æ¹è¯¥æä»¶å¤¹ä¸­çåå®¹ï¼é½å¯ä»¥åæ¶çå°ã\n\ndocker run -d --rm -v /tmp:/tmp redis\n\n\n1\n\n\nå¦ä½å®ç°ç½ç»äºéï¼\n\ndockeræä¾ä¸ç§ç½ç»æ¨¡å¼ï¼\n\n * nullï¼æ ç½ç»\n * hostï¼ç´æ¥ä½¿ç¨å®¿ä¸»æºç½ç»ï¼å¨åå»ºå®¹å¨æ¶ï¼ä½¿ç¨--net=hoståæ°ã\n\nå¶å®å°±æ¯åå»ºæ°çnamespaceï¼èæ¯ç´æ¥å å¥å°å®¿ä¸»æºçnamesapce\n\ndocker run -d --rm --net=host nginx:alpine\n\n\n1\n\n * bridgeï¼æ¡¥æ¥æ¨¡å¼ï¼ç±è½¯ä»¶èæç½å¡ä¸ç½æ¡¥ï¼å®¹å¨åå®¿ä¸»æºé½æ¥å¥è¯¥ç½æ¡¥ï¼å³å¯æ­£å¸¸åéæ°æ®åãå¯ä»¥ä½¿ç¨åæ°--net=bridgeåå»ºå®¹å¨ï¼ä½è¿ä¸ªæ¯é»è®¤åæ°ã\n\ndocker run -d --rm nginx:alpine\n\n\n1\n\n\n\n\nç½ç»æ¨¡å¼     ä¼ç¹                        ç¼ºç¹\nhost     å ä¸ºæ¯ç´æ¥ä½¿ç¨å®¿ä¸»æºçç½ç»ï¼æçæ´é«        è¿è¡å¤ªå¤çå®¹å¨ï¼ä¼å¯¼è´ç«¯å£åçå²çª\nbridge   å ä¸ºæäºç½æ¡¥å¯ä»¥è®¾ç½®æ´å¤çç­ç¥ï¼æ¯å¦æµéæ§å¶ç­   éè¦è½¯ä»¶æ¨¡æèæç½å¡ä¸ç½æ¡¥ï¼æçæ´ä½\n\n\n\n\n\n\n# å³äºk8sä¸dockerçå³ç³»\n\nå¨2014å¹´çæ¶å,dockerå¦æ¥ä¸­å¤©ï¼é£ä¹k8sèªç¶éæ©åºäºdockerä¸è¿è¡ã\n\nå¨2016å¹´k8så å¥äºcncfï¼ä¸ä¸ªå¼æºçäºåçè®¡ç®åºéä¼ã\n\nå¹¶ä¸å¼å¥äºä¸ä¸ªæ¥å£æ åï¼criï¼container runtime interfaceãä¹å°±æ¯è§å®kubeletè¯¥å¦ä½è°ç¨container runtimeå»ç®¡çå®¹å¨åéåï¼ä½è¿æ¯ä¸å¥å¨æ°çæ¥å£ï¼åä¹åçdockerå®å¨ä¸å¼å®¹ãç®çå¾ææ¾ï¼ä¸æ³ç»å®dockerï¼å¯ä»¥éæ¶å°dockerè¸¢æã\n\nå ä¸ºdockerå·²ç»éå¸¸æçï¼åå¤§ååä¸å¯è½å°dockerå¨é¨æ¿æ¢ãæä»¥k8så¨kubeletådockerä¸­é´å ä¸ä¸ª"ééå¨"ï¼ædockerçæ¥å£è½¬æ¢æç¬¦åcriæ åçæ¥å£ã\n\n\n\nä»ä¹æ¯containerdï¼\n\nä¸è¿ docker ä¹æ²¡æâåä»¥å¾æ¯âï¼èæ¯éåäºâæ­èæ±çâçç­ç¥ï¼æ¨å¨èªèº«çéæï¼æåæ¬åä½æ¶æç docker engine æåæäºå¤ä¸ªæ¨¡åï¼å¶ä¸­ç docker daemon é¨åå°±æç®ç»äº cncfï¼å½¢æäº containerdã\n\ncontainerd ä½ä¸º cncf çæç®¡é¡¹ç®ï¼èªç¶æ¯è¦ç¬¦å cri æ åçãä½ docker åºäºèªå·±è¯¸å¤åå çèèï¼å®åªæ¯å¨ docker engine éè°ç¨äº containerdï¼å¤é¨çæ¥å£ä»ç¶ä¿æä¸åï¼ä¹å°±æ¯è¯´è¿ä¸ä¸ cri å¼å®¹ã\n\nç±äº docker çâåºæ§å·±è§âï¼è¿æ¶ kubernetes éå°±åºç°äºä¸¤ç§è°ç¨é¾ï¼ç¬¬ä¸ç§æ¯ç¨ cri æ¥å£è°ç¨ dockershimï¼ç¶å dockershim è°ç¨ dockerï¼docker åèµ° containerd å»æä½å®¹å¨ãç¬¬äºç§æ¯ç¨ cri æ¥å£ç´æ¥è°ç¨ containerd å»æä½å®¹å¨ã\n\n\n\næ¾èæè§ï¼ä½¿ç¨ç¬¬äºç§çå»äºdockershimådocker engineä¸¤ä¸ªç¯èï¼æèæ´å°ï¼æ§è½ä¹æåäºã\n\næ­£å¼"å¼ç¨docker"\n\nå¨2020å¹´k8så¼ç¨dockeræ¯æï¼ä½è¯¥å¼ç¨æ¯æå¼ç¨äº"dockershim"çè¿ä¸ªç»ä»¶ï¼ä¹å°±æ¯ædockershimç§»åºkubeleteï¼åªæ¯ç»è¿dockerï¼ç´æ¥è°ç¨äºdockeråé¨çcontainerdèå·²ã\n\nå¹¶ä¸å¯¹dockerä¹æ å½±åï¼å ä¸ºdockeråé¨ä¹æ¯ä½¿ç¨å¼æºçcontainerdã\n\n\n\nå¯ä¸å½±åçæ¯ï¼k8sæ¯ç´æ¥æä½containerdæä½å®¹å¨ï¼é£ä¹å®ådockeræ¯ç¬ç«çå·¥ä½ç¯å¢ï¼å½¼æ­¤é½ä¸è½è®¿é®å¯¹æ¹çå®¹å¨åéåï¼ä¹å°±æ¯docker psçä¸å°k8sè¿è¡çå®¹å¨ãæ¹ç¨crictlå½ä»¤ã\n\ndocker éæèªèº«ï¼åç¦»åº containerdï¼è¿æ¯å¦ç®æ¯ä¸ç§âèªæåå¢âçè¡ä¸ºå¢ï¼å¦ææ²¡æ containerdï¼é£ç°å¨çæå½¢ä¼æ¯æä¹æ ·çå¢ï¼\n\ndocker æ¯ä¸ä¸ªå®æ´çè½¯ä»¶äº§åçº¿ï¼ä¸æ­¢æ¯ containerdï¼å®è¿åæ¬äºéåæå»ºãååãæµè¯ç­è®¸å¤æå¡ï¼çè³å¨ docker desktop éè¿åç½®äº kubernetesã\n\n> dockeråç¦»containerdæ¯ä¸ä¸ªå¾èªæçä¸¾å¨ï¼ä¸å¶å°æ¥è¢«äººåç¦»æèæå¼ä¸ç¨ï¼ä¸å¦æä¸»å¨é©æ°ï¼ækubernatesç»å¨æçæè½¦ä¸ï¼è¿æ ·criçç¬¬ä¸éæ©ä»ç¶æ¯dockerçèªå·±äººã\n> ä¸æ¶çéè®©æ¯ä¸ºäºæ´å¥½çå°æ¥ã',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"k8sä¹Pod",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},title:"k8sä¹Pod",date:"2022-08-30T12:48:34.000Z",permalink:"/pages/2b547f/",description:"ä»ç»k8sä¸­çpodèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220331113937.png#crop=0&crop=0&crop=1&crop=1&id=mo242&originHeight=381&originWidth=481&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{name:"twitter:title",content:"k8sä¹Pod"},{name:"twitter:description",content:"ä»ç»k8sä¸­çpodèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220331113937.png#crop=0&crop=0&crop=1&crop=1&id=mo242&originHeight=381&originWidth=481&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/03.k8s%E4%B9%8Bpod.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹Pod"},{property:"og:description",content:"ä»ç»k8sä¸­çpodèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220331113937.png#crop=0&crop=0&crop=1&crop=1&id=mo242&originHeight=381&originWidth=481&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/03.k8s%E4%B9%8Bpod.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-30T12:48:34.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹Pod"},{itemprop:"description",content:"ä»ç»k8sä¸­çpodèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220331113937.png#crop=0&crop=0&crop=1&crop=1&id=mo242&originHeight=381&originWidth=481&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/03.k8s%E4%B9%8Bpod.html",relativePath:"01.äºåç/07.k8s/03.k8sä¹pod.md",key:"v-29274a29",path:"/pages/2b547f/",headers:[{level:2,title:"ä»ä¹æ¯pod?",slug:"ä»ä¹æ¯pod",normalizedTitle:"ä»ä¹æ¯pod?",charIndex:2},{level:2,title:"ä¸ºä»ä¹éè¦Pod?",slug:"ä¸ºä»ä¹éè¦pod",normalizedTitle:"ä¸ºä»ä¹éè¦pod?",charIndex:110},{level:2,title:"ä½¿ç¨Pod",slug:"ä½¿ç¨pod",normalizedTitle:"ä½¿ç¨pod",charIndex:615},{level:2,title:"å®¹å¨ç¶ææ¢é",slug:"å®¹å¨ç¶ææ¢é",normalizedTitle:"å®¹å¨ç¶ææ¢é",charIndex:1959},{level:2,title:"èµæºéç½®",slug:"èµæºéç½®",normalizedTitle:"èµæºéç½®",charIndex:2292}],headersStr:"ä»ä¹æ¯pod? ä¸ºä»ä¹éè¦Pod? ä½¿ç¨Pod å®¹å¨ç¶ææ¢é èµæºéç½®",content:'# ä»ä¹æ¯pod?\n\nPodæ¯ä¸ç»å±äº«äºæäºèµæºçå®¹å¨ã\n\nå®¹å¨çéç¦»æ¯éè¿åç§namespaceæ¥å®ç°çï¼Pod éçææå®¹å¨ï¼å¯ä»¥éè¿Namespaceæ¥å±äº«ç³»ç»èµæºï¼åNetwork Namepsaceã\n\n\n# ä¸ºä»ä¹éè¦Pod?\n\nä¼æå¨ç¥æå¨ç¥ï¼å®¹å¨æ¯ä¸ä¸ªç¹æ®çè¿ç¨ï¼ä½æäºåºæ¯æ¯ï¼ä¸ä¸ªåºç¨çè¿è¡ï¼æ¯éè¦å¤ä¸ªè¿ç¨ç»åä½¿ç¨ï¼å¹¶æä¸å®çä¾èµå³ç³»çãè½ç¶æä»¬ä¹å¯ä»¥ä½¿ç¨åç¬çå®¹å¨æ¥éç½®è¿è¡åºç¨ï¼ä½æ¯é½æ¯ç¬ç«çãèpodæ¯k8sçåå­è°åº¦ï¼podä¸­çå®¹å¨å¯ä»¥æå®åéå°åä¸ä¸ªèç¹ï¼ç»ä¸æç§èµæºè°åº¦ã\n\nä½¿ç¨dockerä¹å¯ä»¥å®ç°AãBå®¹å¨å±äº«ç½ç»åVolumeï¼ä½æ¯å®¹å¨Bå¿é¡»æ¯å®¹å¨Aåå¯å¨ï¼æ¯ä¸ä¸ªææç»æï¼èä¸æ¯å¹³ç­å³ç³»\n\n$ docker run --net=B --volumes-from=B --name=A image-A ...\n\n\n1\n\n\nå¨Podä¸­ï¼ååå»ºå¯å¨çæ¯Infraå®¹å¨ï¼è¯¥å®¹å¨ä¼å¤äºä¸ä¸ªç¦æ­¢ç¶æï¼èå¶ä»å®ä¹çå®¹å¨ï¼åéè¿Join Network Namespaceä¸Infraå®¹å¨è¿æ¥å¨ä¸èµ·ã\n\n\n\nå¨Podä¸­çå®¹å¨å¤äºåä¸ä¸ªNetwork Namespaceä¸­ï¼æä»¥å¯ä»¥éè¿localhostç´æ¥è¿è¡éä¿¡ï¼çå°çç½ç»è®¾å¤æ¯ä¸è´çãèPodççå½å¨æåInfraå®¹å¨ä¸è´ï¼åå®¹å¨AãBæ å³ã\n\nPodï¼å®éä¸æ¯å¨æ®æ¼ä¼ ç»åºç¡è®¾æ½éâèææºâçè§è²ï¼èå®¹å¨ï¼åæ¯è¿ä¸ªèææºéè¿è¡çç¨æ·ç¨åºã\n\n\n# ä½¿ç¨Pod\n\nä½¿ç¨yamlæ¥æè¿°ä¸ä¸ªPodã\n\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx-pod\n\nspec:\n  containers:\n  - name: nginx\n    image: nginx:laster\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nåä½¿ç¨kubectl applyæ¥åå»ºpod\n\n[root@k8s-worker1 zwf]# kubectl apply -f pod.yaml -n zwf\npod/nginx-pod created\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf -o wide\nNAME        READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES\nnginx-pod   1/1     Running   0          2m51s   10.222.126.60   k8s-worker2   <none>           <none>\n\n\n1\n2\n3\n4\n5\n6\n\n\næä»¬å¯ä»¥ä½¿ç¨curlè®¿é®å°podä¸­çnginxçæå¡äº\n\n[root@k8s-worker1 zwf]# curl 10.222.126.60:80\n<!DOCTYPE html>\n<html>\n<head>\n<title>Welcome to nginx!</title>\n<style>\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: Tahoma, Verdana, Arial, sans-serif; }\n</style>\n</head>\n<body>\n<h1>Welcome to nginx!</h1>\n<p>If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.</p>\n\n<p>For online documentation and support please refer to\n<a href="http://nginx.org/">nginx.org</a>.<br/>\nCommercial support is available at\n<a href="http://nginx.com/">nginx.com</a>.</p>\n\n<p><em>Thank you for using nginx.</em></p>\n</body>\n</html>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\nä¸è¬æä»¬ä¸ç´æ¥åå»ºPodï¼èæ¯éè¿åç§æ§å¶å¨æ¥ç®¡çåå»º\n\n\n# å®¹å¨ç¶ææ¢é\n\n * ReadinessProbe\n\nå°±ç»ªæ§æ¢éï¼å¤æ­å®¹å¨ä¸­çç¨åºæ¯å¦å¥åº·ï¼ä¸å¥åº·ï¼åä¼å°è¯¥podä»serviceå¯ç¨ç«¯ç¹åè¡¨ç§»é¤ã\n\n * livenessProbe\n\nå­æ´»æ§æ¢éï¼å¤æ­å®¹å¨æ¯å¦å¥åº·ï¼ä¸å¥åº·ï¼åä¼å°å®¹å¨éå¯ã æ³¨æï¼æ¯å°å®¹å¨éå¯èä¸æ¯pod\n\n * startupProbe\n\nå¨podå¯å¨åæç§éç½®æ§è¡ä¸æ¬¡ï¼å¦ææåï¼åä¸åæ§è¡ï¼å¦æå¤±è´¥ï¼åä¼éå¯pod. å¶ä»ä¸¤ä¸ªæ¢éæ¯å¨startupProbeè¿è¡æåä¹åé½æ¯æåçã\n\næ¢æµæ¹å¼\n\n * execï¼æ§è¡ä¸ä¸ªLinuxå½ä»¤ï¼çè¿åå¼\n\n * tcpSocketï¼ä½¿ç¨tcpå°è¯è¿æ¥æä¸ªç«¯å£ï¼çæ¯å¦è¿æ¥æå\n\n * httpGetï¼å°è¯ä½¿ç¨httpè¯·æ±ï¼çæ¯å¦è¯·æ±æå\n\n\n# èµæºéç½®\n\nå¨éç½®ä¸­ä½¿ç¨resourceså­æ®µæ¥è®¾ç½®éå¶å®¹å¨çèµæºã\n\n * requestsï¼ç³»ç»å¿é¡»é¢ççå¯ç¨èµæº\n\n * limitsï¼å®¹å¨å¯ç³è¯·ä½¿ç¨çæå¤§å¯ç¨èµæºï¼è¶è¿åä¼è¢«killçå¯è½æ§\n\nè¿éçcpuä½¿ç¨çæ¯m(milli)çåä½ï¼1000mä»£è¡¨1ä¸ªcpuï¼10mä»£è¡¨1%cpu\n\nèåå­ä½¿ç¨Miä»£è¡¨MBã\n\napiVersion: v1\nkind: Pod\nmetadata:\n  name: ngx-pod-resources\n\nspec:\n  containers:\n  - image: nginx:alpine\n    name: ngx\n\n    resources:\n      requests:\n        cpu: 10m\n        memory: 100Mi\n      limits:\n        cpu: 20m\n        memory: 200Mi\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\næä»¬åæ¥ççæ¯æä¹ä½¿ç¨cgroupæ¥éå¶podä¸­å®¹å¨çèµæº\n\nåæ¾å°podä¸­è¯¥å®¹å¨çID\n\n>>> kubectl describe pod -n zwf ngx-pod-resources\nName:         ngx-pod-resources\nNamespace:    zwf\nPriority:     0\nNode:         k8s-worker1/10.64.2.141\nStart Time:   Tue, 30 Aug 2022 16:11:45 +0800\nLabels:       <none>\nAnnotations:  cni.projectcalico.org/containerID: 4c8f23863e6589d44b96ded48a2abd857ca9e45637fb9dd6b106c3c217be0904\n              cni.projectcalico.org/podIP: 10.222.194.100/32\n              cni.projectcalico.org/podIPs: 10.222.194.100/32\nStatus:       Running\nIP:           10.222.194.100\nIPs:\n  IP:  10.222.194.100\nContainers:\n  ngx:\n    Container ID:   docker://c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859\n    Image:          nginx:alpine\n    Image ID:       docker-pullable://nginx@sha256:082f8c10bd47b6acc8ef15ae61ae45dd8fde0e9f389a8b5cb23c37408642bf5d\n    Port:           <none>\n    Host Port:      <none>\n    State:          Running\n      Started:      Tue, 30 Aug 2022 16:11:54 +0800\n    Ready:          True\n    Restart Count:  0\n    Limits:\n      cpu:     20m\n      memory:  200Mi\n    Requests:\n      cpu:        10m\n      memory:     100Mi\n    Environment:  <none>\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jcccn (ro)\n\n....\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nç¶ååéè¿docker inspectæ¾å°éå¶è¯¥å®¹å¨çcgroupçè·¯å¾\n\n>>> docker inspect c60e37 | grep Cgroup\n            "CgroupnsMode": "host",\n            "Cgroup": "",\n            "CgroupParent": "/kubepods/burstable/poda9ca2eed-ef7b-4564-b448-e35b06c7bdd0",\n            "DeviceCgroupRules": null\n\n\n1\n2\n3\n4\n5\n\n\næä»¬åè¿å¥å°/sys/fs/cgroup/cpu/kubepods/burstable/poda9ca2eed-ef7b-4564-b448-e35b06c7bdd0ï¼å¯ä»¥çå°æä¸¤ä¸ªå®¹å¨IDçç®å½ï¼å ä¸ºé¤äºæä»¬nginxå®¹å¨ä¹å¤ï¼è¿æä¸ä¸ªinfraå®¹å¨ã\n\n[root@k8s-worker1]# cd /sys/fs/cgroup/cpu/kubepods/burstable/poda9ca2eed-ef7b-4564-b448-e35b06c7bdd0\n\n[root@k8s-worker1]# ls\n4c8f23863e6589d44b96ded48a2abd857ca9e45637fb9dd6b106c3c217be0904  cpuacct.usage              cpuacct.usage_sys   cpu.rt_runtime_us\nc60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859  cpuacct.usage_all          cpuacct.usage_user  cpu.shares\ncgroup.clone_children                                             cpuacct.usage_percpu       cpu.cfs_period_us   cpu.stat\ncgroup.procs                                                      cpuacct.usage_percpu_sys   cpu.cfs_quota_us    notify_on_release\ncpuacct.stat                                                      cpuacct.usage_percpu_user  cpu.rt_period_us    tasks\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\næä»¬è¿å¥å°nginxçå®¹å¨IDç®å½ä¸ï¼æ¥çtasksæä»¶ï¼åç°æå¾å¤è¿ç¨IDï¼ä¸ºä»ä¹å¢ï¼\n\n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# cat tasks\n2733304\n2733402\n2733403\n2733404\n2733405\n2733406\n2733407\n2733408\n2733409\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå®¹å¨å°±æ¯ä¸ä¸ªéç¦»çè¿ç¨ï¼æä»¬çä¸è¯¥å®¹å¨çè¿ç¨IDï¼åéè¿è¯¥IDæ¾å°è¯¥è¿ç¨ï¼ç¡®å®æ¯nginxæ²¡éï¼ä¹å¨cgroupçtasksæä»¶ä¸­ï¼ä½æ¯å¶ä»çè¿ç¨IDæ¯ä»ä¹å¢ï¼\n\n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# docker inspect c60e | grep Pid\n            "Pid": 2733304,\n            "PidMode": "",\n            "PidsLimit": null,\n            \n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# ps aux | grep 2733304\nroot     2733304  0.0  0.0   6304  4544 ?        Ss   16:11   0:00 nginx: master process nginx -g daemon off;\nroot     2787238  0.0  0.0  12132  1156 pts/3    S+   16:45   0:00 grep --color=auto 2733304\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næéè¿ps auxæ¥æç´¢ä¸ä¸nginxï¼å®¹å¨IDä¸ºnginx masterï¼èå¶ä»çè¿ç¨IDé½æ¯nginxçworkerè¿ç¨ã\n\n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# ps aux | grep nginx\nroot     2733304  0.0  0.0   6304  4544 ?        Ss   16:11   0:00 nginx: master process nginx -g daemon off;\n101      2733402  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733403  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733404  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733405  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733406  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733407  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733408  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\n101      2733409  0.0  0.0   6760  1648 ?        S    16:11   0:00 nginx: worker process\nroot     2781594  0.0  0.0  12132  1164 pts/3    S+   16:41   0:00 grep --color=auto nginx\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n',normalizedContent:'# ä»ä¹æ¯pod?\n\npodæ¯ä¸ç»å±äº«äºæäºèµæºçå®¹å¨ã\n\nå®¹å¨çéç¦»æ¯éè¿åç§namespaceæ¥å®ç°çï¼pod éçææå®¹å¨ï¼å¯ä»¥éè¿namespaceæ¥å±äº«ç³»ç»èµæºï¼ånetwork namepsaceã\n\n\n# ä¸ºä»ä¹éè¦pod?\n\nä¼æå¨ç¥æå¨ç¥ï¼å®¹å¨æ¯ä¸ä¸ªç¹æ®çè¿ç¨ï¼ä½æäºåºæ¯æ¯ï¼ä¸ä¸ªåºç¨çè¿è¡ï¼æ¯éè¦å¤ä¸ªè¿ç¨ç»åä½¿ç¨ï¼å¹¶æä¸å®çä¾èµå³ç³»çãè½ç¶æä»¬ä¹å¯ä»¥ä½¿ç¨åç¬çå®¹å¨æ¥éç½®è¿è¡åºç¨ï¼ä½æ¯é½æ¯ç¬ç«çãèpodæ¯k8sçåå­è°åº¦ï¼podä¸­çå®¹å¨å¯ä»¥æå®åéå°åä¸ä¸ªèç¹ï¼ç»ä¸æç§èµæºè°åº¦ã\n\nä½¿ç¨dockerä¹å¯ä»¥å®ç°aãbå®¹å¨å±äº«ç½ç»åvolumeï¼ä½æ¯å®¹å¨bå¿é¡»æ¯å®¹å¨aåå¯å¨ï¼æ¯ä¸ä¸ªææç»æï¼èä¸æ¯å¹³ç­å³ç³»\n\n$ docker run --net=b --volumes-from=b --name=a image-a ...\n\n\n1\n\n\nå¨podä¸­ï¼ååå»ºå¯å¨çæ¯infraå®¹å¨ï¼è¯¥å®¹å¨ä¼å¤äºä¸ä¸ªç¦æ­¢ç¶æï¼èå¶ä»å®ä¹çå®¹å¨ï¼åéè¿join network namespaceä¸infraå®¹å¨è¿æ¥å¨ä¸èµ·ã\n\n\n\nå¨podä¸­çå®¹å¨å¤äºåä¸ä¸ªnetwork namespaceä¸­ï¼æä»¥å¯ä»¥éè¿localhostç´æ¥è¿è¡éä¿¡ï¼çå°çç½ç»è®¾å¤æ¯ä¸è´çãèpodççå½å¨æåinfraå®¹å¨ä¸è´ï¼åå®¹å¨aãbæ å³ã\n\npodï¼å®éä¸æ¯å¨æ®æ¼ä¼ ç»åºç¡è®¾æ½éâèææºâçè§è²ï¼èå®¹å¨ï¼åæ¯è¿ä¸ªèææºéè¿è¡çç¨æ·ç¨åºã\n\n\n# ä½¿ç¨pod\n\nä½¿ç¨yamlæ¥æè¿°ä¸ä¸ªpodã\n\napiversion: v1\nkind: pod\nmetadata:\n  name: nginx-pod\n\nspec:\n  containers:\n  - name: nginx\n    image: nginx:laster\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nåä½¿ç¨kubectl applyæ¥åå»ºpod\n\n[root@k8s-worker1 zwf]# kubectl apply -f pod.yaml -n zwf\npod/nginx-pod created\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf -o wide\nname        ready   status    restarts   age     ip              node          nominated node   readiness gates\nnginx-pod   1/1     running   0          2m51s   10.222.126.60   k8s-worker2   <none>           <none>\n\n\n1\n2\n3\n4\n5\n6\n\n\næä»¬å¯ä»¥ä½¿ç¨curlè®¿é®å°podä¸­çnginxçæå¡äº\n\n[root@k8s-worker1 zwf]# curl 10.222.126.60:80\n<!doctype html>\n<html>\n<head>\n<title>welcome to nginx!</title>\n<style>\nhtml { color-scheme: light dark; }\nbody { width: 35em; margin: 0 auto;\nfont-family: tahoma, verdana, arial, sans-serif; }\n</style>\n</head>\n<body>\n<h1>welcome to nginx!</h1>\n<p>if you see this page, the nginx web server is successfully installed and\nworking. further configuration is required.</p>\n\n<p>for online documentation and support please refer to\n<a href="http://nginx.org/">nginx.org</a>.<br/>\ncommercial support is available at\n<a href="http://nginx.com/">nginx.com</a>.</p>\n\n<p><em>thank you for using nginx.</em></p>\n</body>\n</html>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\nä¸è¬æä»¬ä¸ç´æ¥åå»ºpodï¼èæ¯éè¿åç§æ§å¶å¨æ¥ç®¡çåå»º\n\n\n# å®¹å¨ç¶ææ¢é\n\n * readinessprobe\n\nå°±ç»ªæ§æ¢éï¼å¤æ­å®¹å¨ä¸­çç¨åºæ¯å¦å¥åº·ï¼ä¸å¥åº·ï¼åä¼å°è¯¥podä»serviceå¯ç¨ç«¯ç¹åè¡¨ç§»é¤ã\n\n * livenessprobe\n\nå­æ´»æ§æ¢éï¼å¤æ­å®¹å¨æ¯å¦å¥åº·ï¼ä¸å¥åº·ï¼åä¼å°å®¹å¨éå¯ã æ³¨æï¼æ¯å°å®¹å¨éå¯èä¸æ¯pod\n\n * startupprobe\n\nå¨podå¯å¨åæç§éç½®æ§è¡ä¸æ¬¡ï¼å¦ææåï¼åä¸åæ§è¡ï¼å¦æå¤±è´¥ï¼åä¼éå¯pod. å¶ä»ä¸¤ä¸ªæ¢éæ¯å¨startupprobeè¿è¡æåä¹åé½æ¯æåçã\n\næ¢æµæ¹å¼\n\n * execï¼æ§è¡ä¸ä¸ªlinuxå½ä»¤ï¼çè¿åå¼\n\n * tcpsocketï¼ä½¿ç¨tcpå°è¯è¿æ¥æä¸ªç«¯å£ï¼çæ¯å¦è¿æ¥æå\n\n * httpgetï¼å°è¯ä½¿ç¨httpè¯·æ±ï¼çæ¯å¦è¯·æ±æå\n\n\n# èµæºéç½®\n\nå¨éç½®ä¸­ä½¿ç¨resourceså­æ®µæ¥è®¾ç½®éå¶å®¹å¨çèµæºã\n\n * requestsï¼ç³»ç»å¿é¡»é¢ççå¯ç¨èµæº\n\n * limitsï¼å®¹å¨å¯ç³è¯·ä½¿ç¨çæå¤§å¯ç¨èµæºï¼è¶è¿åä¼è¢«killçå¯è½æ§\n\nè¿éçcpuä½¿ç¨çæ¯m(milli)çåä½ï¼1000mä»£è¡¨1ä¸ªcpuï¼10mä»£è¡¨1%cpu\n\nèåå­ä½¿ç¨miä»£è¡¨mbã\n\napiversion: v1\nkind: pod\nmetadata:\n  name: ngx-pod-resources\n\nspec:\n  containers:\n  - image: nginx:alpine\n    name: ngx\n\n    resources:\n      requests:\n        cpu: 10m\n        memory: 100mi\n      limits:\n        cpu: 20m\n        memory: 200mi\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\næä»¬åæ¥ççæ¯æä¹ä½¿ç¨cgroupæ¥éå¶podä¸­å®¹å¨çèµæº\n\nåæ¾å°podä¸­è¯¥å®¹å¨çid\n\n>>> kubectl describe pod -n zwf ngx-pod-resources\nname:         ngx-pod-resources\nnamespace:    zwf\npriority:     0\nnode:         k8s-worker1/10.64.2.141\nstart time:   tue, 30 aug 2022 16:11:45 +0800\nlabels:       <none>\nannotations:  cni.projectcalico.org/containerid: 4c8f23863e6589d44b96ded48a2abd857ca9e45637fb9dd6b106c3c217be0904\n              cni.projectcalico.org/podip: 10.222.194.100/32\n              cni.projectcalico.org/podips: 10.222.194.100/32\nstatus:       running\nip:           10.222.194.100\nips:\n  ip:  10.222.194.100\ncontainers:\n  ngx:\n    container id:   docker://c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859\n    image:          nginx:alpine\n    image id:       docker-pullable://nginx@sha256:082f8c10bd47b6acc8ef15ae61ae45dd8fde0e9f389a8b5cb23c37408642bf5d\n    port:           <none>\n    host port:      <none>\n    state:          running\n      started:      tue, 30 aug 2022 16:11:54 +0800\n    ready:          true\n    restart count:  0\n    limits:\n      cpu:     20m\n      memory:  200mi\n    requests:\n      cpu:        10m\n      memory:     100mi\n    environment:  <none>\n    mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-jcccn (ro)\n\n....\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nç¶ååéè¿docker inspectæ¾å°éå¶è¯¥å®¹å¨çcgroupçè·¯å¾\n\n>>> docker inspect c60e37 | grep cgroup\n            "cgroupnsmode": "host",\n            "cgroup": "",\n            "cgroupparent": "/kubepods/burstable/poda9ca2eed-ef7b-4564-b448-e35b06c7bdd0",\n            "devicecgrouprules": null\n\n\n1\n2\n3\n4\n5\n\n\næä»¬åè¿å¥å°/sys/fs/cgroup/cpu/kubepods/burstable/poda9ca2eed-ef7b-4564-b448-e35b06c7bdd0ï¼å¯ä»¥çå°æä¸¤ä¸ªå®¹å¨idçç®å½ï¼å ä¸ºé¤äºæä»¬nginxå®¹å¨ä¹å¤ï¼è¿æä¸ä¸ªinfraå®¹å¨ã\n\n[root@k8s-worker1]# cd /sys/fs/cgroup/cpu/kubepods/burstable/poda9ca2eed-ef7b-4564-b448-e35b06c7bdd0\n\n[root@k8s-worker1]# ls\n4c8f23863e6589d44b96ded48a2abd857ca9e45637fb9dd6b106c3c217be0904  cpuacct.usage              cpuacct.usage_sys   cpu.rt_runtime_us\nc60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859  cpuacct.usage_all          cpuacct.usage_user  cpu.shares\ncgroup.clone_children                                             cpuacct.usage_percpu       cpu.cfs_period_us   cpu.stat\ncgroup.procs                                                      cpuacct.usage_percpu_sys   cpu.cfs_quota_us    notify_on_release\ncpuacct.stat                                                      cpuacct.usage_percpu_user  cpu.rt_period_us    tasks\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\næä»¬è¿å¥å°nginxçå®¹å¨idç®å½ä¸ï¼æ¥çtasksæä»¶ï¼åç°æå¾å¤è¿ç¨idï¼ä¸ºä»ä¹å¢ï¼\n\n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# cat tasks\n2733304\n2733402\n2733403\n2733404\n2733405\n2733406\n2733407\n2733408\n2733409\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå®¹å¨å°±æ¯ä¸ä¸ªéç¦»çè¿ç¨ï¼æä»¬çä¸è¯¥å®¹å¨çè¿ç¨idï¼åéè¿è¯¥idæ¾å°è¯¥è¿ç¨ï¼ç¡®å®æ¯nginxæ²¡éï¼ä¹å¨cgroupçtasksæä»¶ä¸­ï¼ä½æ¯å¶ä»çè¿ç¨idæ¯ä»ä¹å¢ï¼\n\n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# docker inspect c60e | grep pid\n            "pid": 2733304,\n            "pidmode": "",\n            "pidslimit": null,\n            \n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# ps aux | grep 2733304\nroot     2733304  0.0  0.0   6304  4544 ?        ss   16:11   0:00 nginx: master process nginx -g daemon off;\nroot     2787238  0.0  0.0  12132  1156 pts/3    s+   16:45   0:00 grep --color=auto 2733304\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næéè¿ps auxæ¥æç´¢ä¸ä¸nginxï¼å®¹å¨idä¸ºnginx masterï¼èå¶ä»çè¿ç¨idé½æ¯nginxçworkerè¿ç¨ã\n\n[root@k8s-worker1 c60e370dd413f240164aec3f98cb35a8d09f6a3833c414a6c7a767d51977b859]# ps aux | grep nginx\nroot     2733304  0.0  0.0   6304  4544 ?        ss   16:11   0:00 nginx: master process nginx -g daemon off;\n101      2733402  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733403  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733404  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733405  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733406  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733407  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733408  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\n101      2733409  0.0  0.0   6760  1648 ?        s    16:11   0:00 nginx: worker process\nroot     2781594  0.0  0.0  12132  1164 pts/3    s+   16:41   0:00 grep --color=auto nginx\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"k8sä¹Deployment",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},title:"k8sä¹Deployment",date:"2022-08-29T16:27:11.000Z",permalink:"/pages/d73c88/",description:"ä»ç»k8sä¸­çdeploymentèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220820143105.png"},{name:"twitter:title",content:"k8sä¹Deployment"},{name:"twitter:description",content:"ä»ç»k8sä¸­çdeploymentèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220820143105.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/04.k8s%E4%B9%8Bdeployment.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹Deployment"},{property:"og:description",content:"ä»ç»k8sä¸­çdeploymentèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220820143105.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/04.k8s%E4%B9%8Bdeployment.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-29T16:27:11.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹Deployment"},{itemprop:"description",content:"ä»ç»k8sä¸­çdeploymentèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220820143105.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/04.k8s%E4%B9%8Bdeployment.html",relativePath:"01.äºåç/07.k8s/04.k8sä¹deployment.md",key:"v-44df3b79",path:"/pages/d73c88/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ä½¿ç¨yamlæè¿°Deployment",slug:"ä½¿ç¨yamlæè¿°deployment",normalizedTitle:"ä½¿ç¨yamlæè¿°deployment",charIndex:86},{level:2,title:"æ¥çDeployment",slug:"æ¥çdeployment",normalizedTitle:"æ¥çdeployment",charIndex:730},{level:2,title:"ReplicaSet",slug:"replicaset",normalizedTitle:"replicaset",charIndex:1679},{level:2,title:"æ°´å¹³æ©ç¼©å®¹",slug:"æ°´å¹³æ©ç¼©å®¹",normalizedTitle:"æ°´å¹³æ©ç¼©å®¹",charIndex:3501},{level:2,title:"æ»å¨æ´æ°",slug:"æ»å¨æ´æ°",normalizedTitle:"æ»å¨æ´æ°",charIndex:4473}],headersStr:"ç®ä» ä½¿ç¨yamlæè¿°Deployment æ¥çDeployment ReplicaSet æ°´å¹³æ©ç¼©å®¹ æ»å¨æ´æ°",content:'# ç®ä»\n\nDeploymentæ¯k8sç¨æ¥ç®¡çé¨ç½²æ ç¶æPodçæ§å¶å¨ã\n\néç¨åºæ¯\n\næ ç¶æåºç¨ï¼ææçpodæ ä¾èµå³ç³»ï¼æ æå®èç¹è¿è¡ãæ ç¹æ®å¤ççæ¹å¼é¨ç½²\n\n\n# ä½¿ç¨yamlæè¿°Deployment\n\nä½¿ç¨ä¸é¢çyamlæä»¶ç¨æ¥åå»ºnginxçDeploymentå¯¹è±¡\n\nreplicasæ¯ç¨æ¥å®ä¹åå»ºpodçæ°éãtemplateä¸­çæ¯æç®¡ççPodæ¨¡æ¿ï¼Deploymentå°±æ¯æ ¹æ®è¯¥å­æ®µæ¥åå»ºpodèµæºå¯¹è±¡ãselectoræ¯ç¨æ¥ç­ééè¦ç®¡ççpodå¯¹è±¡ï¼templateä¸çlabelsçå¼éè¦ä¸selectorçå¼éè¦ä¿æä¸è´ï¼è¿æ ·Deploymentæè½æ¾å°éè¦æ§å¶çPodã\n\næ´å¤çå­æ®µè¯´æå¯ä»¥çå®ç½\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n  \nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: ngx-dep\n      \n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: nginx:alpine\n        name: nginx\n        ports:\n        - containerPort: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n\n# æ¥çDeployment\n\næä»¬æäºyamlæ¥æè¿°deploymentä¹åï¼å°±å¯ä»¥ä½¿ç¨kubectl applyæ¥åå»ºDeploymentå¯¹è±¡ã\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments.yaml  -n zwf\ndeployment.apps/ngx-dep created\n\n\n1\n2\n\n\næä¹ä¹å¯ä»¥ä½¿ç¨kubectl getæ¥æ¥çæä»¬åå»ºçdeplotmentå¯¹è±¡çä¿¡æ¯\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   2/2     2            2           19m\n\n\n1\n2\n3\n\n\nä¿¡æ¯ï¼\n\n * READYï¼å°±ç»ªä¸ªæ°/ææä¸ªæ°\n * UP-TO-DATEï¼å½åå¤äºææ°çæ¬çpodæ°\n * AVAILABLEï¼å½åå¯ç¨çPodæ°ï¼ä¹å°±æ¯å·²ç»ç»è¿readyä¹åçPod\n * ageï¼å­æ´»æ¶é´\n\næä»¬å°å¶ä¸­ä¸ä¸ªpodå é¤äºï¼ä¼åç°ä¸å°±åpodè¿ä¼èªå¨åå»ºï¼å ä¸ºk8sä¼æ ¹æ®yamlä¸­replicasçå¼ï¼è®©deploymentçå®éç¶æä¸æ­çåææç¶æé¼è¿ï¼æç»è¾¾å°ä¸ä¸ªåºç¨"æ°¸ä¸å®æº"\n\n[root@k8s-worker1 zwf]# kubectl delete pods ngx-dep-69b9455bcf-cfwgd -n zwf\npod "ngx-dep-69b9455bcf-cfwgd" deleted\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME                       READY   STATUS    RESTARTS   AGE\nngx-dep-69b9455bcf-ddjml   1/1     Running   0          13m\nngx-dep-69b9455bcf-fn6gw   1/1     Running   0          5s\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# ReplicaSet\n\nDeploymentå¹¶ä¸æ¯ç´æ¥ç®¡çPodï¼èæ¯éè¿ReplicaSetå¯¹è±¡é´æ¥ç®¡ççï¼ä¹å°±æ¯è¯´çæ­£ç®¡çpodçå¶å®æ¯replicaSetå¯¹è±¡.\n\næä»¬ä½¿ç¨kubectl get rså¯ä»¥æ¥çå°ReplicaSetå¯¹è±¡ï¼è¯¥å¯¹è±¡æ¯å¨åå»ºDeploymentæ¶åå»ºçï¼æ¥çä¸ä¸ReplicaSetå¯¹è±¡çä¿¡æ¯ï¼å¶ä¸­çDESIREDåCURRENTå¯¹åºå¨åDeploymentçREADYï¼READYåDeploymentä¸­çæ¯ä¸æ ·çã\n\n[root@k8s-worker1 zwf]# kubectl get rs -n zwf\nNAME                 DESIRED   CURRENT   READY   AGE\nngx-dep-69b9455bcf   2         2         2       43s\n\n\n1\n2\n3\n\n\néè¿kubectl describeæ¥çdeplomentçè¯¦æï¼å¯ä»¥çå°NewReplicaSetçå¼æåçæ¯ReplicaSetå¯¹è±¡ï¼å¹¶é´æ¥ç®¡çPodã\n\n[root@k8s-worker1 zwf]# kubectl describe deploy ngx-dep -n zwf \nName:                   ngx-dep\nNamespace:              zwf\nCreationTimestamp:      Tue, 30 Aug 2022 11:27:14 +0800\nLabels:                 app=ngx-dep\nAnnotations:            deployment.kubernetes.io/revision: 1\nSelector:               app=ngx-dep\nReplicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable\nStrategyType:           RollingUpdate\nMinReadySeconds:        0\nRollingUpdateStrategy:  25% max unavailable, 25% max surge\nPod Template:\n  Labels:  app=ngx-dep\n  Containers:\n   nginx:\n    Image:        mirrors.sangfor.com/nginx:alpine\n    Port:         80/TCP\n    Host Port:    0/TCP\n    Environment:  <none>\n    Mounts:       <none>\n  Volumes:        <none>\nConditions:\n  Type           Status  Reason\n  ----           ------  ------\n  Progressing    True    NewReplicaSetAvailable\n  Available      True    MinimumReplicasAvailable\nOldReplicaSets:  <none>\nNewReplicaSet:   ngx-dep-69b9455bcf (2/2 replicas created)\nEvents:\n  Type    Reason             Age   From                   Message\n  ----    ------             ----  ----                   -------\n  Normal  ScalingReplicaSet  13m   deployment-controller  Scaled up replica set ngx-dep-69b9455bcf to 2\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# æ°´å¹³æ©ç¼©å®¹\n\næ°´å¹³æ©ç¼©å®¹æ¯å¯ä»¥å¨æçæ¹åPodçæ°éï¼å¨é«å³°æå¯ä»¥æ©å¤§åºç¨çæ°éæé«å¹¶åï¼å¨ä½å³°æç¼©åPodåå°èµæºçä½¿ç¨ã\n\næä»¬ä½¿ç¨kubectl scaleå¨ææ¹åDeploymentçå¯æ¬æ°ï¼æ¥çDeploymentå¯¹è±¡å¯ä»¥çå°READYä»2/4å°4/4ï¼å¹¶ä¸AVALIABLEçå¼ä¹æ¯éæ¸çä»2å°4\n\n[root@k8s-worker1 zwf]# kubectl scale deploy ngx-dep -n zwf --replicas=4\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   2/4     4            2           18m\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   3/4     4            3           18m\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   4/4     4            4           18m\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\næä»¬åççReplicaSetå¯¹è±¡ï¼å¯ä»¥çå°å½åæ­£å¨è¿è¡Podæ°éä¹åçäºæ¹åãå ä¸ºæ°´å¹³æ©ç¼©å®¹çå®è´¨æ¯deplotmentå»ä¿®æ¹ReplicaSetçPodå¯æ¬çæ°éã\n\n[root@k8s-worker1 zwf]# kubectl get replicaset  -n zwf\nNAME                 DESIRED   CURRENT   READY   AGE\nngx-dep-69b9455bcf   4         4         4       50m\n\n\n1\n2\n3\n\n\n\n\n\n# æ»å¨æ´æ°\n\nå¨æ´æ°çè¿ç¨ï¼æ¯éæ¸å°æ§çReplicaSetæç®¡ççPodå é¤ï¼æ°çReplicaSetç®¡ççPodæ°å¢è¿ä¹ä¸ä¸ªè¿ç¨ã\n\næä»¬ä¿®æ¹Deploymentçyamlæä»¶ï¼å°containersçnameä¿®æ¹ä¸ºnginx2\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n  \nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: ngx-dep\n      \n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: nginx:alpine\n        name: nginx2   # ä¿®æ¹\n        ports:\n        - containerPort: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåä½¿ç¨kubectl applyæ§è¡ï¼æ´æ°Deploymentï¼å¯ä»¥çå°ï¼UP-TO-DATEæ¯éæ¸çä»1å°2ï¼æ§çpodä¼éæ¸çæ´æ°æææ°çpod.\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments.yaml -n zwf\ndeployment.apps/ngx-dep configured\n\n[root@k8s-worker1 zwf]# kubectl get deploy -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   2/2     1            2           55m\n\n[root@k8s-worker1 zwf]# kubectl get deploy -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   2/2     2            2           55m\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\næä»¬åçä¸ReplicaSetå¯¹è±¡ï¼å¯ä»¥çå°æä¸¤ä¸ªå¯¹è±¡ãè¿æ¯å ä¸ºæä»¬æ´æ°äºDeploymentä¸­çpod templateæ¨¡æ¿ï¼ä¹å°±æ¯ä¼æ´æ°podï¼æä»¬ç¥éDeploymentæ¯éè¿ReplicaSetæ¥ç®¡çå¯¹è±¡çï¼æä»¥ä¼åå»ºä¸ä¸ªæ°çæ¬çReplicaSetå¯¹è±¡ç¨æ¥åå»ºæ°çæ¬çPodå¹¶éæ¸å¢å ï¼ç¶åéæ¸å°æ§çæ¬çReplicaSetå¯¹è±¡ç®¡ççpodå é¤ç´è³ä¸º0ã\n\n[root@k8s-worker1 zwf]# kubectl get rs -n zwf\nNAME                 DESIRED   CURRENT   READY   AGE\nngx-dep-54d65f4d8c   2         2         2       2m54s\nngx-dep-69b9455bcf   0         0         0       58m\n\n\n1\n2\n3\n4\n\n\næä»¬åçDeploymentçè¯¦æï¼Eventså­æ®µæ¯ä»£è¡¨çDeploymentä¸­åççäºä»¶ï¼å¯ä»¥çå°ngx-dep-69b9455bcfæç®¡ççpodéæ¸åå°ï¼èngx-dep-69b9455bcfå¨éæ¸å¢å podçæ°éãè¿ä¹å°±è§£éäºä¸é¢ä¸ºä»ä¹æä¸¤ä¸ªReplicaSetå¯¹è±¡ï¼å ä¸ºä¸ä¸ªæ¯æ°å¯¹è±¡ï¼ä¸ä¸ªæ¯æ§å¯¹è±¡ï¼å¨æ´æ°Deploymentæ¶ï¼é½ä¼ä¿çä¸æ¥ã\n\n[root@k8s-worker1 zwf]# kubectl describe deploy ngx-dep -n zwf\nName:                   ngx-dep\nNamespace:              zwf\nCreationTimestamp:      Tue, 30 Aug 2022 11:27:14 +0800\nLabels:                 app=ngx-dep\nAnnotations:            deployment.kubernetes.io/revision: 2\nSelector:               app=ngx-dep\nReplicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable\nStrategyType:           RollingUpdate\nMinReadySeconds:        0\nRollingUpdateStrategy:  25% max unavailable, 25% max surge\nPod Template:\n  Labels:  app=ngx-dep\n  Containers:\n   nginx2:\n    Image:        mirrors.sangfor.com/nginx:alpine\n    Port:         80/TCP\n    Host Port:    0/TCP\n    Environment:  <none>\n    Mounts:       <none>\n  Volumes:        <none>\nConditions:\n  Type           Status  Reason\n  ----           ------  ------\n  Available      True    MinimumReplicasAvailable\n  Progressing    True    NewReplicaSetAvailable\nOldReplicaSets:  <none>\nNewReplicaSet:   ngx-dep-54d65f4d8c (2/2 replicas created)\nEvents:\n  Type    Reason             Age                  From                   Message\n  ----    ------             ----                 ----                   -------\n  Normal  ScalingReplicaSet  5m                   deployment-controller  Scaled up replica set ngx-dep-54d65f4d8c to 1\n  Normal  ScalingReplicaSet  4m58s                deployment-controller  Scaled down replica set ngx-dep-69b9455bcf to 1\n  Normal  ScalingReplicaSet  4m58s                deployment-controller  Scaled up replica set ngx-dep-54d65f4d8c to 2\n  Normal  ScalingReplicaSet  4m54s                deployment-controller  Scaled down replica set ngx-dep-69b9455bcf to 0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n\n\n',normalizedContent:'# ç®ä»\n\ndeploymentæ¯k8sç¨æ¥ç®¡çé¨ç½²æ ç¶æpodçæ§å¶å¨ã\n\néç¨åºæ¯\n\næ ç¶æåºç¨ï¼ææçpodæ ä¾èµå³ç³»ï¼æ æå®èç¹è¿è¡ãæ ç¹æ®å¤ççæ¹å¼é¨ç½²\n\n\n# ä½¿ç¨yamlæè¿°deployment\n\nä½¿ç¨ä¸é¢çyamlæä»¶ç¨æ¥åå»ºnginxçdeploymentå¯¹è±¡\n\nreplicasæ¯ç¨æ¥å®ä¹åå»ºpodçæ°éãtemplateä¸­çæ¯æç®¡ççpodæ¨¡æ¿ï¼deploymentå°±æ¯æ ¹æ®è¯¥å­æ®µæ¥åå»ºpodèµæºå¯¹è±¡ãselectoræ¯ç¨æ¥ç­ééè¦ç®¡ççpodå¯¹è±¡ï¼templateä¸çlabelsçå¼éè¦ä¸selectorçå¼éè¦ä¿æä¸è´ï¼è¿æ ·deploymentæè½æ¾å°éè¦æ§å¶çpodã\n\næ´å¤çå­æ®µè¯´æå¯ä»¥çå®ç½\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n  \nspec:\n  replicas: 2\n  selector:\n    matchlabels:\n      app: ngx-dep\n      \n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: nginx:alpine\n        name: nginx\n        ports:\n        - containerport: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n\n# æ¥çdeployment\n\næä»¬æäºyamlæ¥æè¿°deploymentä¹åï¼å°±å¯ä»¥ä½¿ç¨kubectl applyæ¥åå»ºdeploymentå¯¹è±¡ã\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments.yaml  -n zwf\ndeployment.apps/ngx-dep created\n\n\n1\n2\n\n\næä¹ä¹å¯ä»¥ä½¿ç¨kubectl getæ¥æ¥çæä»¬åå»ºçdeplotmentå¯¹è±¡çä¿¡æ¯\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nname      ready   up-to-date   available   age\nngx-dep   2/2     2            2           19m\n\n\n1\n2\n3\n\n\nä¿¡æ¯ï¼\n\n * readyï¼å°±ç»ªä¸ªæ°/ææä¸ªæ°\n * up-to-dateï¼å½åå¤äºææ°çæ¬çpodæ°\n * availableï¼å½åå¯ç¨çpodæ°ï¼ä¹å°±æ¯å·²ç»ç»è¿readyä¹åçpod\n * ageï¼å­æ´»æ¶é´\n\næä»¬å°å¶ä¸­ä¸ä¸ªpodå é¤äºï¼ä¼åç°ä¸å°±åpodè¿ä¼èªå¨åå»ºï¼å ä¸ºk8sä¼æ ¹æ®yamlä¸­replicasçå¼ï¼è®©deploymentçå®éç¶æä¸æ­çåææç¶æé¼è¿ï¼æç»è¾¾å°ä¸ä¸ªåºç¨"æ°¸ä¸å®æº"\n\n[root@k8s-worker1 zwf]# kubectl delete pods ngx-dep-69b9455bcf-cfwgd -n zwf\npod "ngx-dep-69b9455bcf-cfwgd" deleted\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname                       ready   status    restarts   age\nngx-dep-69b9455bcf-ddjml   1/1     running   0          13m\nngx-dep-69b9455bcf-fn6gw   1/1     running   0          5s\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# replicaset\n\ndeploymentå¹¶ä¸æ¯ç´æ¥ç®¡çpodï¼èæ¯éè¿replicasetå¯¹è±¡é´æ¥ç®¡ççï¼ä¹å°±æ¯è¯´çæ­£ç®¡çpodçå¶å®æ¯replicasetå¯¹è±¡.\n\næä»¬ä½¿ç¨kubectl get rså¯ä»¥æ¥çå°replicasetå¯¹è±¡ï¼è¯¥å¯¹è±¡æ¯å¨åå»ºdeploymentæ¶åå»ºçï¼æ¥çä¸ä¸replicasetå¯¹è±¡çä¿¡æ¯ï¼å¶ä¸­çdesiredåcurrentå¯¹åºå¨ådeploymentçreadyï¼readyådeploymentä¸­çæ¯ä¸æ ·çã\n\n[root@k8s-worker1 zwf]# kubectl get rs -n zwf\nname                 desired   current   ready   age\nngx-dep-69b9455bcf   2         2         2       43s\n\n\n1\n2\n3\n\n\néè¿kubectl describeæ¥çdeplomentçè¯¦æï¼å¯ä»¥çå°newreplicasetçå¼æåçæ¯replicasetå¯¹è±¡ï¼å¹¶é´æ¥ç®¡çpodã\n\n[root@k8s-worker1 zwf]# kubectl describe deploy ngx-dep -n zwf \nname:                   ngx-dep\nnamespace:              zwf\ncreationtimestamp:      tue, 30 aug 2022 11:27:14 +0800\nlabels:                 app=ngx-dep\nannotations:            deployment.kubernetes.io/revision: 1\nselector:               app=ngx-dep\nreplicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable\nstrategytype:           rollingupdate\nminreadyseconds:        0\nrollingupdatestrategy:  25% max unavailable, 25% max surge\npod template:\n  labels:  app=ngx-dep\n  containers:\n   nginx:\n    image:        mirrors.sangfor.com/nginx:alpine\n    port:         80/tcp\n    host port:    0/tcp\n    environment:  <none>\n    mounts:       <none>\n  volumes:        <none>\nconditions:\n  type           status  reason\n  ----           ------  ------\n  progressing    true    newreplicasetavailable\n  available      true    minimumreplicasavailable\noldreplicasets:  <none>\nnewreplicaset:   ngx-dep-69b9455bcf (2/2 replicas created)\nevents:\n  type    reason             age   from                   message\n  ----    ------             ----  ----                   -------\n  normal  scalingreplicaset  13m   deployment-controller  scaled up replica set ngx-dep-69b9455bcf to 2\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# æ°´å¹³æ©ç¼©å®¹\n\næ°´å¹³æ©ç¼©å®¹æ¯å¯ä»¥å¨æçæ¹åpodçæ°éï¼å¨é«å³°æå¯ä»¥æ©å¤§åºç¨çæ°éæé«å¹¶åï¼å¨ä½å³°æç¼©åpodåå°èµæºçä½¿ç¨ã\n\næä»¬ä½¿ç¨kubectl scaleå¨ææ¹ådeploymentçå¯æ¬æ°ï¼æ¥çdeploymentå¯¹è±¡å¯ä»¥çå°readyä»2/4å°4/4ï¼å¹¶ä¸avaliableçå¼ä¹æ¯éæ¸çä»2å°4\n\n[root@k8s-worker1 zwf]# kubectl scale deploy ngx-dep -n zwf --replicas=4\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nname      ready   up-to-date   available   age\nngx-dep   2/4     4            2           18m\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nname      ready   up-to-date   available   age\nngx-dep   3/4     4            3           18m\n\n[root@k8s-worker1 zwf]# kubectl get deployment -n zwf\nname      ready   up-to-date   available   age\nngx-dep   4/4     4            4           18m\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\næä»¬åççreplicasetå¯¹è±¡ï¼å¯ä»¥çå°å½åæ­£å¨è¿è¡podæ°éä¹åçäºæ¹åãå ä¸ºæ°´å¹³æ©ç¼©å®¹çå®è´¨æ¯deplotmentå»ä¿®æ¹replicasetçpodå¯æ¬çæ°éã\n\n[root@k8s-worker1 zwf]# kubectl get replicaset  -n zwf\nname                 desired   current   ready   age\nngx-dep-69b9455bcf   4         4         4       50m\n\n\n1\n2\n3\n\n\n\n\n\n# æ»å¨æ´æ°\n\nå¨æ´æ°çè¿ç¨ï¼æ¯éæ¸å°æ§çreplicasetæç®¡ççpodå é¤ï¼æ°çreplicasetç®¡ççpodæ°å¢è¿ä¹ä¸ä¸ªè¿ç¨ã\n\næä»¬ä¿®æ¹deploymentçyamlæä»¶ï¼å°containersçnameä¿®æ¹ä¸ºnginx2\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n  \nspec:\n  replicas: 2\n  selector:\n    matchlabels:\n      app: ngx-dep\n      \n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: nginx:alpine\n        name: nginx2   # ä¿®æ¹\n        ports:\n        - containerport: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåä½¿ç¨kubectl applyæ§è¡ï¼æ´æ°deploymentï¼å¯ä»¥çå°ï¼up-to-dateæ¯éæ¸çä»1å°2ï¼æ§çpodä¼éæ¸çæ´æ°æææ°çpod.\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments.yaml -n zwf\ndeployment.apps/ngx-dep configured\n\n[root@k8s-worker1 zwf]# kubectl get deploy -n zwf\nname      ready   up-to-date   available   age\nngx-dep   2/2     1            2           55m\n\n[root@k8s-worker1 zwf]# kubectl get deploy -n zwf\nname      ready   up-to-date   available   age\nngx-dep   2/2     2            2           55m\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\næä»¬åçä¸replicasetå¯¹è±¡ï¼å¯ä»¥çå°æä¸¤ä¸ªå¯¹è±¡ãè¿æ¯å ä¸ºæä»¬æ´æ°äºdeploymentä¸­çpod templateæ¨¡æ¿ï¼ä¹å°±æ¯ä¼æ´æ°podï¼æä»¬ç¥édeploymentæ¯éè¿replicasetæ¥ç®¡çå¯¹è±¡çï¼æä»¥ä¼åå»ºä¸ä¸ªæ°çæ¬çreplicasetå¯¹è±¡ç¨æ¥åå»ºæ°çæ¬çpodå¹¶éæ¸å¢å ï¼ç¶åéæ¸å°æ§çæ¬çreplicasetå¯¹è±¡ç®¡ççpodå é¤ç´è³ä¸º0ã\n\n[root@k8s-worker1 zwf]# kubectl get rs -n zwf\nname                 desired   current   ready   age\nngx-dep-54d65f4d8c   2         2         2       2m54s\nngx-dep-69b9455bcf   0         0         0       58m\n\n\n1\n2\n3\n4\n\n\næä»¬åçdeploymentçè¯¦æï¼eventså­æ®µæ¯ä»£è¡¨çdeploymentä¸­åççäºä»¶ï¼å¯ä»¥çå°ngx-dep-69b9455bcfæç®¡ççpodéæ¸åå°ï¼èngx-dep-69b9455bcfå¨éæ¸å¢å podçæ°éãè¿ä¹å°±è§£éäºä¸é¢ä¸ºä»ä¹æä¸¤ä¸ªreplicasetå¯¹è±¡ï¼å ä¸ºä¸ä¸ªæ¯æ°å¯¹è±¡ï¼ä¸ä¸ªæ¯æ§å¯¹è±¡ï¼å¨æ´æ°deploymentæ¶ï¼é½ä¼ä¿çä¸æ¥ã\n\n[root@k8s-worker1 zwf]# kubectl describe deploy ngx-dep -n zwf\nname:                   ngx-dep\nnamespace:              zwf\ncreationtimestamp:      tue, 30 aug 2022 11:27:14 +0800\nlabels:                 app=ngx-dep\nannotations:            deployment.kubernetes.io/revision: 2\nselector:               app=ngx-dep\nreplicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable\nstrategytype:           rollingupdate\nminreadyseconds:        0\nrollingupdatestrategy:  25% max unavailable, 25% max surge\npod template:\n  labels:  app=ngx-dep\n  containers:\n   nginx2:\n    image:        mirrors.sangfor.com/nginx:alpine\n    port:         80/tcp\n    host port:    0/tcp\n    environment:  <none>\n    mounts:       <none>\n  volumes:        <none>\nconditions:\n  type           status  reason\n  ----           ------  ------\n  available      true    minimumreplicasavailable\n  progressing    true    newreplicasetavailable\noldreplicasets:  <none>\nnewreplicaset:   ngx-dep-54d65f4d8c (2/2 replicas created)\nevents:\n  type    reason             age                  from                   message\n  ----    ------             ----                 ----                   -------\n  normal  scalingreplicaset  5m                   deployment-controller  scaled up replica set ngx-dep-54d65f4d8c to 1\n  normal  scalingreplicaset  4m58s                deployment-controller  scaled down replica set ngx-dep-69b9455bcf to 1\n  normal  scalingreplicaset  4m58s                deployment-controller  scaled up replica set ngx-dep-54d65f4d8c to 2\n  normal  scalingreplicaset  4m54s                deployment-controller  scaled down replica set ngx-dep-69b9455bcf to 0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n\n\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"dockerå®¹å¨åæºç½ç»",frontmatter:{title:"dockerå®¹å¨åæºç½ç»",date:"2023-01-08T10:52:41.000Z",permalink:"/pages/0ddeb7/",tags:["docker","äºåç","å®¹å¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦è®²è¿°dockerå®¹å¨çåç§ç½ç»æ¨¡å¼ï¼hostãbridgeãcontainerãnullï¼å¹¶ä»ç»å®ä»¬çä½¿ç¨æ¹æ³åå®ç°åçã",feed:{enable:!0},categories:["äºåç","docker"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731831018681673183100953.png"},{name:"twitter:title",content:"dockerå®¹å¨åæºç½ç»"},{name:"twitter:description",content:"æ¬æä¸»è¦è®²è¿°dockerå®¹å¨çåç§ç½ç»æ¨¡å¼ï¼hostãbridgeãcontainerãnullï¼å¹¶ä»ç»å®ä»¬çä½¿ç¨æ¹æ³åå®ç°åçã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731831018681673183100953.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/04.docker%E5%AE%B9%E5%99%A8%E5%8D%95%E6%9C%BA%E7%BD%91%E7%BB%9C.html"},{property:"og:type",content:"article"},{property:"og:title",content:"dockerå®¹å¨åæºç½ç»"},{property:"og:description",content:"æ¬æä¸»è¦è®²è¿°dockerå®¹å¨çåç§ç½ç»æ¨¡å¼ï¼hostãbridgeãcontainerãnullï¼å¹¶ä»ç»å®ä»¬çä½¿ç¨æ¹æ³åå®ç°åçã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731831018681673183100953.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/04.docker%E5%AE%B9%E5%99%A8%E5%8D%95%E6%9C%BA%E7%BD%91%E7%BB%9C.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-01-08T10:52:41.000Z"},{property:"article:tag",content:"docker"},{property:"article:tag",content:"äºåç"},{property:"article:tag",content:"å®¹å¨"},{itemprop:"name",content:"dockerå®¹å¨åæºç½ç»"},{itemprop:"description",content:"æ¬æä¸»è¦è®²è¿°dockerå®¹å¨çåç§ç½ç»æ¨¡å¼ï¼hostãbridgeãcontainerãnullï¼å¹¶ä»ç»å®ä»¬çä½¿ç¨æ¹æ³åå®ç°åçã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16731831018681673183100953.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/06.docker/04.docker%E5%AE%B9%E5%99%A8%E5%8D%95%E6%9C%BA%E7%BD%91%E7%BB%9C.html",relativePath:"01.äºåç/06.docker/04.dockerå®¹å¨åæºç½ç».md",key:"v-6430d054",path:"/pages/0ddeb7/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"host",slug:"host",normalizedTitle:"host",charIndex:146},{level:2,title:"bridge",slug:"bridge",normalizedTitle:"bridge",charIndex:548},{level:3,title:"åç",slug:"åç",normalizedTitle:"åç",charIndex:138},{level:3,title:"éªè¯",slug:"éªè¯",normalizedTitle:"éªè¯",charIndex:856},{level:3,title:"å®¹å¨ç½ç»äºé",slug:"å®¹å¨ç½ç»äºé",normalizedTitle:"å®¹å¨ç½ç»äºé",charIndex:3442},{level:3,title:"å®¹å¨è¿æ¥å¶ä»ä¸»æº",slug:"å®¹å¨è¿æ¥å¶ä»ä¸»æº",normalizedTitle:"å®¹å¨è¿æ¥å¶ä»ä¸»æº",charIndex:5783},{level:2,title:"container",slug:"container",normalizedTitle:"container",charIndex:6181},{level:2,title:"none",slug:"none",normalizedTitle:"none",charIndex:7668}],headersStr:"åè¨ host bridge åç éªè¯ å®¹å¨ç½ç»äºé å®¹å¨è¿æ¥å¶ä»ä¸»æº container none",content:"# åè¨\n\néè¿æç«  å®¹å¨çæ¬è´¨å¯ç¥ï¼å®¹å¨åªæ¯ä¸ä¸ªè¿ç¨ï¼èå®¹å¨æè½çå°çç½ç»æ ï¼æ¯éç¦»å¨èªå·±ç Network Namespace ä¸­ãdocker å®¹å¨åæºç½ç»æ¯æåç§ç½ç»æ¨¡å¼ï¼ä¹é½æ¯åºäº Network Namespace å®ç°çãæ¬æä¸»è¦æ¯ä»ç»è¿åç§æ¨¡å¼çä½¿ç¨æ¹æ³åå®ç°åçã\n\n\n# host\n\nä½¿ç¨è¯¥æ¨¡å¼çå®¹å¨åå®¿ä¸»æºæ¯å¨åä¸ä¸ª Network Namespace ä¸­çï¼æä»¥åå®¿ä¸»æºç¨çæ¯åä¸ä¸ªç½ç»æ ï¼é£ä¹å®¹å¨æ´é²çç«¯å£ï¼ä¹å°±æ¯å®¿ä¸»æºä¸ç«¯å£ã\n\n> æ³¨æï¼ä½¿ç¨è¯¥æ¨¡å¼ï¼éè¦å³æ³¨ç«¯å£å²çª\n\néè¿æ·»å  --net=host åæ°å³å¯å¼å¯ host æ¨¡å¼\n\ndocker run -d --net=host nginx\n\n\n1\n\n\nå ä¸ºåå®¿ä¸»æºä½¿ç¨çæ¯åä¸ä¸ªç½ç»æ ï¼æä»¥å®¹å¨ä¸å®¿ä¸»æºæ¯å¯ä»¥äºç¸è¿éçï¼å¨å®¿ä¸»æºä¸ç´æ¥å¯ä»¥éè¿ 127.0.0.1 è®¿é®å°è¯¥å®¹å¨ççç«¯å£ã\n\ncurl 127.0.0.1\n\n\n1\n\n\nè¿è¡å¦ä¸ä¸ªå®¹å¨è¿å¥å¶ä¸­æ§è¡ curl 127.0.0.1 å¯ä»¥çå°ä¸æ ·å¯ä»¥è®¿é®å° nginx æ´é²ç 80 ç«¯å£ï¼å ä¸ºé½æ¯ä½¿ç¨å®¿ä¸»æºç½ç»æ ã\n\n docker run -it --net=host curlimages/curl curl 127.0.0.1\n\n\n1\n\n\n\n# bridge\n\n\n# åç\n\nè¯¥æ¨¡å¼ä¸ºæ¡¥æ¥æ¨¡å¼ï¼åå»ºå®¹å¨æ¶ä¼åå»ºå±äºèªå·±ç Network Namepsaceï¼è¯¥å®¹å¨åå®¿ä¸»æºä½¿ç¨çæ¯ä¸åç Network Namespaceï¼ä¹å°±æ¯è¯´å®ä»¬ä½¿ç¨çæ¯ä¸åçç½ç»æ ã\n\nbridge ç½ç»æ¨¡åçå®ç°åçå¯ä»¥åèæç«  æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å\n\nå®¿ä¸»æºåå»ºäº docker0 ä½ä¸ºèæç½æ¡¥ï¼å¶ä½ç¨ä¸»è¦æ¯ä½ä¸ºäº¤æ¢æºå¨äºå±ç½ç»ï¼åå°ä½¿ç¨ bridge æ¨¡å¼åå»ºçå®¹å¨éè¿ veth pair è¿æ¥å° dcoker0 ä¸ï¼è¿æ ·è¿æ¥å° docker0 ä¸çå®¹å¨é½å¯ä»¥äºç¸ç½ç»éä¿¡ã\n\n> veth pair ç±»ä¼¼ä¸ä¸ªç®¡éï¼æ°æ®åä¼ä»ä¸ç«¯å°å¦ä¸ç«¯ã\n\n\n\n\n# éªè¯\n\né»è®¤è¿è¡å®¹å¨æ¶ä½¿ç¨çå°±æ¯ bridge æ¨¡å¼ï¼docker ä¼èªå¨ä¸ºå®¹å¨æ·»å  veth pair å¹¶éç½®å¥½å¶ ip å°åï¼è¿éç eth0 å°±æ¯å¶ä¸­çä¸ç«¯ï¼å¯ä»¥çå°å¶ ip å°åä¸º 172.17.0.2\n\n[root@localhost ~]# docker run -d --name nginx1 nginx\n\n[root@localhost ~]# docker exec -it nginx1 ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n20: eth0@if21: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nveth pair çå¦ä¸ç«¯ä¼æ¥å¥å° docker0 ä¸ï¼å¨å®¹å¨ä¸­æ§è¡ä»¥ä¸å½ä»¤å¯ä»¥çå° veth pair å¦ä¸ç«¯çåºå·\n\n[root@localhost ~]# docker exec nginx1 cat /sys/class/net/eth0/iflink\n21\n\n\n1\n2\n\n\nå¨å®¿ä¸»æºä¸å¯ä»¥çå° 21 åºå·ä¸ç veth pair çåç§°æ¯ veth702ba20ï¼ä¹å°±æ¯ç®¡éçå¦ä¸ç«¯ã\n\n[root@localhost ~]# ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: ens18: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether fe:fc:fe:af:4b:ea brd ff:ff:ff:ff:ff:ff\n    inet 10.61.74.37/23 brd 10.61.75.255 scope global noprefixroute ens18\n       valid_lft forever preferred_lft forever\n    inet6 fe80::1bdd:fe7:4a90:1a67/64 scope link noprefixroute \n       valid_lft forever preferred_lft forever\n3: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:84:c1:3b:ea brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:84ff:fec1:3bea/64 scope link \n       valid_lft forever preferred_lft forever\n21: veth702ba20@if20: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default \n    link/ether 0a:21:51:0c:7e:db brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet6 fe80::821:51ff:fe0c:7edb/64 scope link \n       valid_lft forever preferred_lft forever\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåæ¥ç docker0 æå¥çè®¾å¤å¯ä»¥åç° veth702ba20 æ¯æå¥å¨ docker0 ä¸çã\n\n[root@localhost ~]# brctl show\nbridge name     bridge id               STP enabled     interfaces\ndocker0         8000.024284c13bea       no              veth702ba20\n\n\n1\n2\n3\n\n\n\n# å®¹å¨ç½ç»äºé\n\nååå»ºå¦ä¸ä¸ªå®¹å¨ nginx2ï¼æ¥çå¶ ip ä¸º 172.17.0.3ï¼å¯ä»¥åç° nginx1 æ¯å¯ä»¥ ping é nginx2 çè¯¥ ip çã\n\n[root@localhost ~]# docker run -d --name nginx2 nginx\n[root@localhost ~]# docker exec nginx2 ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n54: eth0@if55: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä¸ºä»ä¹å¯ä»¥äºéå¢ï¼\n\næä»¬æ¥çä¸ nginx1 çè·¯ç±ï¼å½ ping nginx2 ç ip æ¶ï¼ä¼å¹éå°ç¬¬äºæ¡è·¯ç±ï¼ç¶åèµ° eth0 ç½å¡ï¼å ä¸ºå¶æ¯ veth pair çä¸ç«¯ï¼æ°æ®åä¼å¨å¦ä¸ç«¯åºç°ï¼å¦ä¸ç«¯æ¥å¥å°äº docker0 ä¸ï¼æç»æ°æ®åå°è¾¾ docker0\n\n[root@localhost ~]# docker exec nginx1 ip r\ndefault via 172.17.0.1 dev eth0 \n172.17.0.0/16 dev eth0  proto kernel  scope link  src 172.17.0.2 \n\n\n1\n2\n3\n\n\nå½éè¿ nginx1 ping nginx2 ç ip æ¶ï¼æè¿çå¬ docker0 ç½å¡çä¸ä¸æ°æ®åï¼\n\n[root@localhost ~]# docker exec -it nginx1 ping 172.17.0.3 -c 3\n\n[root@localhost ~]# tcpdump -i docker0\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on docker0, link-type EN10MB (Ethernet), capture size 262144 bytes\n04:32:57.596814 ARP, Request who-has 172.17.0.3 tell 172.17.0.2, length 28\n04:32:57.596848 ARP, Reply 172.17.0.3 is-at 02:42:ac:11:00:03 (oui Unknown), length 28\n04:32:57.596853 IP 172.17.0.2 > 172.17.0.3: ICMP echo request, id 17, seq 1, length 64\n04:32:57.596896 IP 172.17.0.3 > 172.17.0.2: ICMP echo reply, id 17, seq 1, length 64\n04:32:58.596437 IP 172.17.0.2 > 172.17.0.3: ICMP echo request, id 17, seq 2, length 64\n04:32:58.596492 IP 172.17.0.3 > 172.17.0.2: ICMP echo reply, id 17, seq 2, length 64\n04:32:59.596444 IP 172.17.0.2 > 172.17.0.3: ICMP echo request, id 17, seq 3, length 64\n04:32:59.596491 IP 172.17.0.3 > 172.17.0.2: ICMP echo reply, id 17, seq 3, length 64\n04:33:02.598361 ARP, Request who-has 172.17.0.2 tell 172.17.0.3, length 28\n04:33:02.598386 ARP, Reply 172.17.0.2 is-at 02:42:ac:11:00:02 (oui Unknown), length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nç±ä¸å¯ç¥ï¼nginx1(10.17.0.2) ä¼åé ARP è·å nginx2(10.17.0.3) ç mac å°åï¼ç¶åä½¿ç¨è¯¥ mac å°åéè¿äºå±è®¾å¤ bridge å nginx2 è½¬åæ°æ®åï¼è¿å¥å°äº nginx2 ç Network Namespace ä¸­ï¼ç±å®çç½ç»æ å¤çè¯¥æ°æ®åï¼æåååã\n\n\n\n\n# å®¹å¨è¿æ¥å¶ä»ä¸»æº\n\nå®¹å¨åè¿æ¥å¶ä»ä¸»æºæ¶ï¼æ¯å¦ ping 10.65.132.187 æ¶ï¼ä¼åéè¿ docker0 è¾¾å°å®¿ä¸»æºä¸ï¼ç¶åéè¿å®¿ä¸»æºçç½ç»æ å¤çã\n\néè¿æ¥çå®¿ä¸»æºè·¯ç±è¡¨ï¼å°è¾¾å®¿ä¸»æºçæ°æ®è¡¨ä¼èµ°ç¬¬ä¸æ¡é»è®¤è·¯ç±ï¼éè¿ eth0 ç½å¡ä¸ä¸è·³å° 10.61.74.1ï¼ç¶åæç»è¾¾å°å¦ä¸å°ä¸»æºç eth0 ä¸­ã\n\n[root@localhost ~]# ip r\ndefault via 10.61.74.1 dev eth0 proto static metric 100 \n10.61.74.0/23 dev eth0 proto kernel scope link src 10.61.74.37 metric 100 \n172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1\n\n\n1\n2\n3\n4\n\n\n\n\n\n# container\n\nä½¿ç¨è¯¥æ¨¡å¼çå®¹å¨ä¼å å¥å°æå®å®¹å¨ç Network Namespace ä¸­ï¼ä¹å°±æ¯ä¸¤ä¸ªå®¹å¨å±ç¨åä¸ä¸ªç½ç»æ ã\n\né¦åä½¿ç¨ bridge æ¨¡å¼åå»ºå®¹å¨ nginx1ï¼è¯¥å®¹å¨ä¼æ¥æèªå·±ç Network Namespaceï¼ç¶ååä½¿ç¨ container æ¨¡å¼åå»º nginx2 å®¹å¨å¹¶å å¥ nginx1 ç Network Namespace ä¸­ã\n\néè¿æ¥çä¸¤ä¸ªå®¹å¨çç½å¡å¯ä»¥åç°ä¸¤ä¸ªæ¯ä¸æ ·çã\n\n[root@localhost ~]# docker run -d --name nginx1 nginx\n[root@localhost ~]# docker exec -it nginx1 ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n56: eth0@if57: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n[root@localhost ~]# docker run -it --name nginx2 --net=container:nginx1 nginx /bin/bash\n\n[ root@20069e4c2bde:/etc/nginx ]$ ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n56: eth0@if57: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\n\n\n\n# none\n\nè¯¥æ¨¡å¼åå»ºå®¹å¨ä¹ä¼åå»ºæ°çå±äºèªå·±ç Network Namespaceï¼ä½æ¯å®¹å¨åä¸ä¼æä»»ä½çç½ç»éç½®ï¼æ²¡æç½å¡ãè·¯ç±ãè·¯ç±ç­ä¿¡æ¯ï¼éè¦ç±æä»¬èªå·±å»éç½®ã\n\n[root@localhost ~]# docker run -it --name nginx --net=none nginx /bin/bash\n\n[ root@52480b0a4725:/etc/nginx ]$ ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n[ root@52480b0a4725:/etc/nginx ]$ ip r\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n",normalizedContent:"# åè¨\n\néè¿æç«  å®¹å¨çæ¬è´¨å¯ç¥ï¼å®¹å¨åªæ¯ä¸ä¸ªè¿ç¨ï¼èå®¹å¨æè½çå°çç½ç»æ ï¼æ¯éç¦»å¨èªå·±ç network namespace ä¸­ãdocker å®¹å¨åæºç½ç»æ¯æåç§ç½ç»æ¨¡å¼ï¼ä¹é½æ¯åºäº network namespace å®ç°çãæ¬æä¸»è¦æ¯ä»ç»è¿åç§æ¨¡å¼çä½¿ç¨æ¹æ³åå®ç°åçã\n\n\n# host\n\nä½¿ç¨è¯¥æ¨¡å¼çå®¹å¨åå®¿ä¸»æºæ¯å¨åä¸ä¸ª network namespace ä¸­çï¼æä»¥åå®¿ä¸»æºç¨çæ¯åä¸ä¸ªç½ç»æ ï¼é£ä¹å®¹å¨æ´é²çç«¯å£ï¼ä¹å°±æ¯å®¿ä¸»æºä¸ç«¯å£ã\n\n> æ³¨æï¼ä½¿ç¨è¯¥æ¨¡å¼ï¼éè¦å³æ³¨ç«¯å£å²çª\n\néè¿æ·»å  --net=host åæ°å³å¯å¼å¯ host æ¨¡å¼\n\ndocker run -d --net=host nginx\n\n\n1\n\n\nå ä¸ºåå®¿ä¸»æºä½¿ç¨çæ¯åä¸ä¸ªç½ç»æ ï¼æä»¥å®¹å¨ä¸å®¿ä¸»æºæ¯å¯ä»¥äºç¸è¿éçï¼å¨å®¿ä¸»æºä¸ç´æ¥å¯ä»¥éè¿ 127.0.0.1 è®¿é®å°è¯¥å®¹å¨ççç«¯å£ã\n\ncurl 127.0.0.1\n\n\n1\n\n\nè¿è¡å¦ä¸ä¸ªå®¹å¨è¿å¥å¶ä¸­æ§è¡ curl 127.0.0.1 å¯ä»¥çå°ä¸æ ·å¯ä»¥è®¿é®å° nginx æ´é²ç 80 ç«¯å£ï¼å ä¸ºé½æ¯ä½¿ç¨å®¿ä¸»æºç½ç»æ ã\n\n docker run -it --net=host curlimages/curl curl 127.0.0.1\n\n\n1\n\n\n\n# bridge\n\n\n# åç\n\nè¯¥æ¨¡å¼ä¸ºæ¡¥æ¥æ¨¡å¼ï¼åå»ºå®¹å¨æ¶ä¼åå»ºå±äºèªå·±ç network namepsaceï¼è¯¥å®¹å¨åå®¿ä¸»æºä½¿ç¨çæ¯ä¸åç network namespaceï¼ä¹å°±æ¯è¯´å®ä»¬ä½¿ç¨çæ¯ä¸åçç½ç»æ ã\n\nbridge ç½ç»æ¨¡åçå®ç°åçå¯ä»¥åèæç«  æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å\n\nå®¿ä¸»æºåå»ºäº docker0 ä½ä¸ºèæç½æ¡¥ï¼å¶ä½ç¨ä¸»è¦æ¯ä½ä¸ºäº¤æ¢æºå¨äºå±ç½ç»ï¼åå°ä½¿ç¨ bridge æ¨¡å¼åå»ºçå®¹å¨éè¿ veth pair è¿æ¥å° dcoker0 ä¸ï¼è¿æ ·è¿æ¥å° docker0 ä¸çå®¹å¨é½å¯ä»¥äºç¸ç½ç»éä¿¡ã\n\n> veth pair ç±»ä¼¼ä¸ä¸ªç®¡éï¼æ°æ®åä¼ä»ä¸ç«¯å°å¦ä¸ç«¯ã\n\n\n\n\n# éªè¯\n\né»è®¤è¿è¡å®¹å¨æ¶ä½¿ç¨çå°±æ¯ bridge æ¨¡å¼ï¼docker ä¼èªå¨ä¸ºå®¹å¨æ·»å  veth pair å¹¶éç½®å¥½å¶ ip å°åï¼è¿éç eth0 å°±æ¯å¶ä¸­çä¸ç«¯ï¼å¯ä»¥çå°å¶ ip å°åä¸º 172.17.0.2\n\n[root@localhost ~]# docker run -d --name nginx1 nginx\n\n[root@localhost ~]# docker exec -it nginx1 ip a\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n20: eth0@if21: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up group default \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nveth pair çå¦ä¸ç«¯ä¼æ¥å¥å° docker0 ä¸ï¼å¨å®¹å¨ä¸­æ§è¡ä»¥ä¸å½ä»¤å¯ä»¥çå° veth pair å¦ä¸ç«¯çåºå·\n\n[root@localhost ~]# docker exec nginx1 cat /sys/class/net/eth0/iflink\n21\n\n\n1\n2\n\n\nå¨å®¿ä¸»æºä¸å¯ä»¥çå° 21 åºå·ä¸ç veth pair çåç§°æ¯ veth702ba20ï¼ä¹å°±æ¯ç®¡éçå¦ä¸ç«¯ã\n\n[root@localhost ~]# ip a\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: ens18: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state up group default qlen 1000\n    link/ether fe:fc:fe:af:4b:ea brd ff:ff:ff:ff:ff:ff\n    inet 10.61.74.37/23 brd 10.61.75.255 scope global noprefixroute ens18\n       valid_lft forever preferred_lft forever\n    inet6 fe80::1bdd:fe7:4a90:1a67/64 scope link noprefixroute \n       valid_lft forever preferred_lft forever\n3: docker0: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up group default \n    link/ether 02:42:84:c1:3b:ea brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:84ff:fec1:3bea/64 scope link \n       valid_lft forever preferred_lft forever\n21: veth702ba20@if20: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue master docker0 state up group default \n    link/ether 0a:21:51:0c:7e:db brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet6 fe80::821:51ff:fe0c:7edb/64 scope link \n       valid_lft forever preferred_lft forever\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåæ¥ç docker0 æå¥çè®¾å¤å¯ä»¥åç° veth702ba20 æ¯æå¥å¨ docker0 ä¸çã\n\n[root@localhost ~]# brctl show\nbridge name     bridge id               stp enabled     interfaces\ndocker0         8000.024284c13bea       no              veth702ba20\n\n\n1\n2\n3\n\n\n\n# å®¹å¨ç½ç»äºé\n\nååå»ºå¦ä¸ä¸ªå®¹å¨ nginx2ï¼æ¥çå¶ ip ä¸º 172.17.0.3ï¼å¯ä»¥åç° nginx1 æ¯å¯ä»¥ ping é nginx2 çè¯¥ ip çã\n\n[root@localhost ~]# docker run -d --name nginx2 nginx\n[root@localhost ~]# docker exec nginx2 ip a\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n54: eth0@if55: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up group default \n    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä¸ºä»ä¹å¯ä»¥äºéå¢ï¼\n\næä»¬æ¥çä¸ nginx1 çè·¯ç±ï¼å½ ping nginx2 ç ip æ¶ï¼ä¼å¹éå°ç¬¬äºæ¡è·¯ç±ï¼ç¶åèµ° eth0 ç½å¡ï¼å ä¸ºå¶æ¯ veth pair çä¸ç«¯ï¼æ°æ®åä¼å¨å¦ä¸ç«¯åºç°ï¼å¦ä¸ç«¯æ¥å¥å°äº docker0 ä¸ï¼æç»æ°æ®åå°è¾¾ docker0\n\n[root@localhost ~]# docker exec nginx1 ip r\ndefault via 172.17.0.1 dev eth0 \n172.17.0.0/16 dev eth0  proto kernel  scope link  src 172.17.0.2 \n\n\n1\n2\n3\n\n\nå½éè¿ nginx1 ping nginx2 ç ip æ¶ï¼æè¿çå¬ docker0 ç½å¡çä¸ä¸æ°æ®åï¼\n\n[root@localhost ~]# docker exec -it nginx1 ping 172.17.0.3 -c 3\n\n[root@localhost ~]# tcpdump -i docker0\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on docker0, link-type en10mb (ethernet), capture size 262144 bytes\n04:32:57.596814 arp, request who-has 172.17.0.3 tell 172.17.0.2, length 28\n04:32:57.596848 arp, reply 172.17.0.3 is-at 02:42:ac:11:00:03 (oui unknown), length 28\n04:32:57.596853 ip 172.17.0.2 > 172.17.0.3: icmp echo request, id 17, seq 1, length 64\n04:32:57.596896 ip 172.17.0.3 > 172.17.0.2: icmp echo reply, id 17, seq 1, length 64\n04:32:58.596437 ip 172.17.0.2 > 172.17.0.3: icmp echo request, id 17, seq 2, length 64\n04:32:58.596492 ip 172.17.0.3 > 172.17.0.2: icmp echo reply, id 17, seq 2, length 64\n04:32:59.596444 ip 172.17.0.2 > 172.17.0.3: icmp echo request, id 17, seq 3, length 64\n04:32:59.596491 ip 172.17.0.3 > 172.17.0.2: icmp echo reply, id 17, seq 3, length 64\n04:33:02.598361 arp, request who-has 172.17.0.2 tell 172.17.0.3, length 28\n04:33:02.598386 arp, reply 172.17.0.2 is-at 02:42:ac:11:00:02 (oui unknown), length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nç±ä¸å¯ç¥ï¼nginx1(10.17.0.2) ä¼åé arp è·å nginx2(10.17.0.3) ç mac å°åï¼ç¶åä½¿ç¨è¯¥ mac å°åéè¿äºå±è®¾å¤ bridge å nginx2 è½¬åæ°æ®åï¼è¿å¥å°äº nginx2 ç network namespace ä¸­ï¼ç±å®çç½ç»æ å¤çè¯¥æ°æ®åï¼æåååã\n\n\n\n\n# å®¹å¨è¿æ¥å¶ä»ä¸»æº\n\nå®¹å¨åè¿æ¥å¶ä»ä¸»æºæ¶ï¼æ¯å¦ ping 10.65.132.187 æ¶ï¼ä¼åéè¿ docker0 è¾¾å°å®¿ä¸»æºä¸ï¼ç¶åéè¿å®¿ä¸»æºçç½ç»æ å¤çã\n\néè¿æ¥çå®¿ä¸»æºè·¯ç±è¡¨ï¼å°è¾¾å®¿ä¸»æºçæ°æ®è¡¨ä¼èµ°ç¬¬ä¸æ¡é»è®¤è·¯ç±ï¼éè¿ eth0 ç½å¡ä¸ä¸è·³å° 10.61.74.1ï¼ç¶åæç»è¾¾å°å¦ä¸å°ä¸»æºç eth0 ä¸­ã\n\n[root@localhost ~]# ip r\ndefault via 10.61.74.1 dev eth0 proto static metric 100 \n10.61.74.0/23 dev eth0 proto kernel scope link src 10.61.74.37 metric 100 \n172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1\n\n\n1\n2\n3\n4\n\n\n\n\n\n# container\n\nä½¿ç¨è¯¥æ¨¡å¼çå®¹å¨ä¼å å¥å°æå®å®¹å¨ç network namespace ä¸­ï¼ä¹å°±æ¯ä¸¤ä¸ªå®¹å¨å±ç¨åä¸ä¸ªç½ç»æ ã\n\né¦åä½¿ç¨ bridge æ¨¡å¼åå»ºå®¹å¨ nginx1ï¼è¯¥å®¹å¨ä¼æ¥æèªå·±ç network namespaceï¼ç¶ååä½¿ç¨ container æ¨¡å¼åå»º nginx2 å®¹å¨å¹¶å å¥ nginx1 ç network namespace ä¸­ã\n\néè¿æ¥çä¸¤ä¸ªå®¹å¨çç½å¡å¯ä»¥åç°ä¸¤ä¸ªæ¯ä¸æ ·çã\n\n[root@localhost ~]# docker run -d --name nginx1 nginx\n[root@localhost ~]# docker exec -it nginx1 ip a\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n56: eth0@if57: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up group default \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n[root@localhost ~]# docker run -it --name nginx2 --net=container:nginx1 nginx /bin/bash\n\n[ root@20069e4c2bde:/etc/nginx ]$ ip a\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n56: eth0@if57: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up group default \n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\n\n\n\n# none\n\nè¯¥æ¨¡å¼åå»ºå®¹å¨ä¹ä¼åå»ºæ°çå±äºèªå·±ç network namespaceï¼ä½æ¯å®¹å¨åä¸ä¼æä»»ä½çç½ç»éç½®ï¼æ²¡æç½å¡ãè·¯ç±ãè·¯ç±ç­ä¿¡æ¯ï¼éè¦ç±æä»¬èªå·±å»éç½®ã\n\n[root@localhost ~]# docker run -it --name nginx --net=none nginx /bin/bash\n\n[ root@52480b0a4725:/etc/nginx ]$ ip a\n1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state unknown group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n[ root@52480b0a4725:/etc/nginx ]$ ip r\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n",charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"k8sä¹Service",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},title:"k8sä¹Service",date:"2022-08-30T16:59:37.000Z",permalink:"/pages/1f860b/",description:"ä»ç»k8sä¸­çserviceèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220808185926.png"},{name:"twitter:title",content:"k8sä¹Service"},{name:"twitter:description",content:"ä»ç»k8sä¸­çserviceèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220808185926.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/05.k8s%E4%B9%8Bservice.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹Service"},{property:"og:description",content:"ä»ç»k8sä¸­çserviceèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220808185926.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/05.k8s%E4%B9%8Bservice.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-30T16:59:37.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹Service"},{itemprop:"description",content:"ä»ç»k8sä¸­çserviceèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220808185926.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/05.k8s%E4%B9%8Bservice.html",relativePath:"01.äºåç/07.k8s/05.k8sä¹service.md",key:"v-341f9276",path:"/pages/1f860b/",headers:[{level:2,title:"ä»ä¹æ¯serviceï¼",slug:"ä»ä¹æ¯service",normalizedTitle:"ä»ä¹æ¯serviceï¼",charIndex:2},{level:2,title:"ä½¿ç¨ClusterIP Service",slug:"ä½¿ç¨clusterip-service",normalizedTitle:"ä½¿ç¨clusterip service",charIndex:372},{level:2,title:"ä½¿ç¨NodePort Service",slug:"ä½¿ç¨nodeport-service",normalizedTitle:"ä½¿ç¨nodeport service",charIndex:5163},{level:2,title:"å¦ä½å®ç°çä»£çï¼",slug:"å¦ä½å®ç°çä»£ç",normalizedTitle:"å¦ä½å®ç°çä»£çï¼",charIndex:6453}],headersStr:"ä»ä¹æ¯serviceï¼ ä½¿ç¨ClusterIP Service ä½¿ç¨NodePort Service å¦ä½å®ç°çä»£çï¼",content:"# ä»ä¹æ¯serviceï¼\n\nå°è¿è¡å¨ä¸ç» Pods ä¸çåºç¨ç¨åºå¬å¼ä¸ºç½ç»æå¡çæ½è±¡æ¹æ³ã\n\nä¸ºä»ä¹éè¦service?\n\n 1. podçæ°éãIPé½æ¯å¨æååçï¼serviceå¯ä»¥ç»è¯¥éåçPodä¸ä¸ªåºå®çIPï¼æ è®ºpodçéåå¦ä½æ¹åï¼é½å¯ä»¥éè¿serviceçåºå®IPæ¥è®¿é®å°åºç¨ã\n\n 2. å¯ä»¥ç»podéåæä¾è´è½½åè¡¡çåè½ã\n\nServiceç±»å\n\n * LoadBalanceï¼ä½¿ç¨äºæä¾åçè´è½½åè¡¡å¨åå¤é¨æ´é²æå¡ã\n * ExternalNameï¼å°æå¡æ å°å°æå®çååï¼è¿ä¸ªååå¯ä»¥éç¾¤åé¨ä¹å¯ä»¥æ¯å¤é¨çã\n * NodePortï¼æä¾çæå¡æ¢å¯å¯¹å¤é¨æå¡éè¿NodeIp:NodePortè®¿é®ï¼ä¹å¯ä»¥å¯¹éç¾¤åé¨éè¿ClusterIpè®¿é®\n * ClusterIPï¼serviceæä¾çè®¿é®IPä»å¨éç¾¤åé¨å¯è¾¾\n\n\n# ä½¿ç¨ClusterIP Service\n\næä»¬å®ä¹serviceå¦ä¸ï¼å¶ä¸­selectoræ¯ç¨æ¥ç­ééè¦ä»£ççpodï¼targetPortæ¯ç®æ podçç«¯å£ï¼portæ¯æè¯¥serviceçç«¯å£ã\n\nkind: Service \napiVersion: v1 \nmetadata: \n  name: demoapp-svc \nspec: \n  selector: \n    app: demoapp \n  ports: \n  - name: http \n    protocol: TCP    \n    port: 80\n    targetPort: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nä½¿ç¨ä¸é¢å®ä¹çyamlåå»ºserviceå¯¹è±¡ï¼å¹¶å¯ä»¥çå°SELECTORçå¼æ¯app=demoappï¼æä»¬éè¦åå»ºå¸¦æè¯¥æ ç­¾çpodï¼æè½å¤è¿è¡ä»£çã\n\n[root@k8s-worker1 zwf]# kubectl apply -f service.yaml -n zwf\nservice/demoapp-svc created\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf -o wide\nNAME          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE   SELECTOR\ndemoapp-svc   ClusterIP   10.0.0.74    <none>        80/TCP    18s   app=demoapp\n\n\n1\n2\n3\n4\n5\n6\n\n\nå®ä¹deploymentï¼ä¼åå»ºå¸¦æapp=demoappçPod\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: demoapp\n  name: demo-deploy\n\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: demoapp\n\n  template:\n    metadata:\n      labels:\n        app: demoapp\n    spec:\n      containers:\n      - image: mirrors.sangfor.com/ikubernetes/demoapp:v1.0\n        name: demoapp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåå»ºDeploymentå¯¹è±¡ï¼å¹¶ä¸å¯ä»¥çå°åå»ºäº2ä¸ªPod\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments_service.yaml -n zwf\ndeployment.apps/demo-deploy created\n\n[root@k8s-worker1 zwf]# kubectl get deploy -o wide -n zwf\nNAME          READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                                         SELECTOR\ndemo-deploy   2/2     2            2           2m37s   demoapp      mirrors.sangfor.com/ikubernetes/demoapp:v1.0   app=demoapp\n\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næ¥çpodçè¯¦æï¼å¯ä»¥çå°Labelsæä¸ä¸ªapp=demoappçæ ç­¾\n\n[root@k8s-worker1 zwf]# kubectl get pods -o wide -n zwf\nNAME                           READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES\ndemo-deploy-6c6d588789-h9gmd   1/1     Running   0          32s   10.222.126.1     k8s-worker2   <none>           <none>\ndemo-deploy-6c6d588789-nhzhl   1/1     Running   0          32s   10.222.194.104   k8s-worker1   <none>           <none>\n\n[root@k8s-worker1 zwf]# kubectl describe demo-deploy-6c6d588789-h9gmd -n zwf\nName:         demo-deploy-6c6d588789-h9gmd\nNamespace:    zwf\nPriority:     0\nNode:         k8s-worker2/10.64.2.153\nStart Time:   Tue, 30 Aug 2022 19:23:22 +0800\nLabels:       app=demoapp\n              pod-template-hash=6c6d588789\n\n....\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\néè¿æ¥çserviceçè¯¦æï¼æä»¬å¯ä»¥çå°Endpointsçå¼æ¯ä¸é¢åå»ºçä¸¤ä¸ªPodçIPã\n\n[root@k8s-worker1 zwf]# kubectl describe svc -n zwf\nName:              demoapp-svc\nNamespace:         zwf\nLabels:            <none>\nAnnotations:       <none>\nSelector:          app=demoapp\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.0.0.74\nIPs:               10.0.0.74\nPort:              http  80/TCP\nTargetPort:        80/TCP\nEndpoints:         10.222.126.1:80,10.222.194.104:80\nSession Affinity:  None\nEvents:            <none>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nEndpointsä¹æ¯ä¸ä¸ªèµæºå¯¹è±¡ï¼Serviceéè¿ç­éæ ç­¾å°çPodä¼æ·»å å°Endpintsä¸­ä¿å­\n\n[root@k8s-worker1 zwf]# kubectl get endpoints -n zwf\nNAME          ENDPOINTS                           AGE\ndemoapp-svc   10.222.126.1:80,10.222.194.104:80   15m\n\n\n1\n2\n3\n\n\nè¿ä¸ªæ¶åï¼æä»¬è®¿é®serviceç80ç«¯å£ï¼ä¼è®¿é®å°è½®è¯¢è®¿é®å°è¿ä¸¤ä¸ªpodä¸­ï¼æä»¬å°±å¯ä»¥éè¿è®¿é®serviceæ¥è®¿é®podéåã\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.141, ServerName: demo-deploy-6c6d588789-nhzhl, ServerIP: 10.222.194.104!\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.141, ServerName: demo-deploy-6c6d588789-h9gmd, ServerIP: 10.222.126.1!\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.141, ServerName: demo-deploy-6c6d588789-nhzhl, ServerIP: 10.222.194.104!\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.141, ServerName: demo-deploy-6c6d588789-h9gmd, ServerIP: 10.222.126.1!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\né¤äºéè¿ClusterIPè®¿é®ï¼å¨éç¾¤ä¸­ä¹è½éè¿ååè¿è¡è®¿é®ï¼è®¿é®æ¹å¼ï¼<serviceName>.<namespace>.svc.cluster.local\n\n[root@k8s-worker1 zwf]# kubectl exec -it demo-deploy-6c6d588789-h9gmd -n zwf  -- nslookup demoapp-svc.zwf.svc.cluster.local\nServer:         10.0.0.2\nAddress:        10.0.0.2#53\n\nName:   demoapp-svc.zwf.svc.cluster.local\nAddress: 10.0.0.74\n\n[root@k8s-worker1 zwf]# kubectl exec -it demo-deploy-6c6d588789-h9gmd -n zwf  -- curl demoapp-svc.zwf.svc.cluster.local\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.153, ServerName: demo-deploy-6c6d588789-h9gmd, ServerIP: 10.222.126.1!\n\n[root@k8s-worker1 zwf]# kubectl exec -it demo-deploy-6c6d588789-h9gmd -n zwf  -- curl demoapp-svc.zwf.svc.cluster.local\niKubernetes demoapp v1.0 !! ClientIP: 10.222.126.1, ServerName: demo-deploy-6c6d588789-nhzhl, ServerIP: 10.222.194.104!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# ä½¿ç¨NodePort Service\n\nå®ä¹NodePort Serviceå¦ä¸ï¼åClusterIP Serviceæ¯è¾ï¼æ°å¢type: NodePortä»£è¡¨è¯¥Serviceçç±»åæ¯NodePortï¼ç¶ånodePortæ¯èç¹çç«¯å£ï¼å¨æ¯ä¸å°Nodeä¸é½ä¼åå»ºè¿ä¹ä¸ä¸ªç«¯å£ç»éç¾¤å¤è°ç¨ã\n\nkind: Service\napiVersion: v1\nmetadata:\n  name: demoapp-nodeport-svc\nspec:\n  selector:\n    app: demoapp\n  ports:\n  - name: http\n    protocol: TCP\n    port: 80\n    targetPort: 80\n    nodePort: 31999\n  type: NodePort\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåå»ºè¯¥Serviceï¼å¯ä»¥çå°TYPEæ¯NodePortï¼PORTæ¯80:31999ä»£è¡¨çå°80ç«¯å£æ å°å°èç¹ç31999ç«¯å£\n\n[root@k8s-worker1 zwf]# kubectl apply -f service_nodeport.yaml -n zwf\nservice/demoapp-nodeport-svc created\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf -o wide\nNAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE   SELECTOR\ndemoapp-nodeport-svc   NodePort    10.0.0.144   <none>        80:31999/TCP   10s   app=demoapp\ndemoapp-svc            ClusterIP   10.0.0.74    <none>        80/TCP         47m   app=demoapp\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næä»¬å¯ä»¥å¨éç¾¤å¤éè¿èç¹çIP:31999ç«¯å£ä¸æ ·å¯ä»¥è®¿é®Podæå¡ã\n\nC:\\Users\\User>curl 10.64.2.141:31999\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.141, ServerName: demo-deploy-6c6d588789-nhzhl, ServerIP: 10.222.194.104!\n\nC:\\Users\\User>curl 10.64.2.141:31999\niKubernetes demoapp v1.0 !! ClientIP: 10.64.2.141, ServerName: demo-deploy-6c6d588789-h9gmd, ServerIP: 10.222.126.1!\n\n\n1\n2\n3\n4\n5\n\n\n\n# å¦ä½å®ç°çä»£çï¼\n\næ¯ä¸ªNodeé½ä¼æä¸ä¸ªkube-proxyè¿ç¨ï¼è¯¥è¿ç¨ä¼çæ§Serviceçåå»ºä¸EndPointsåè¡¨çæ·»å ä¸å é¤ï¼éç½®iptablesè§åï¼å½å®¢æ·ç«¯è¯·æ±ServiceçClusterIPåç«¯å£æ¶ï¼ä¼æ ¹æ®è§åè½®è¯¢è½¬åå°åç«¯çPodä¸­ã\n\n",normalizedContent:"# ä»ä¹æ¯serviceï¼\n\nå°è¿è¡å¨ä¸ç» pods ä¸çåºç¨ç¨åºå¬å¼ä¸ºç½ç»æå¡çæ½è±¡æ¹æ³ã\n\nä¸ºä»ä¹éè¦service?\n\n 1. podçæ°éãipé½æ¯å¨æååçï¼serviceå¯ä»¥ç»è¯¥éåçpodä¸ä¸ªåºå®çipï¼æ è®ºpodçéåå¦ä½æ¹åï¼é½å¯ä»¥éè¿serviceçåºå®ipæ¥è®¿é®å°åºç¨ã\n\n 2. å¯ä»¥ç»podéåæä¾è´è½½åè¡¡çåè½ã\n\nserviceç±»å\n\n * loadbalanceï¼ä½¿ç¨äºæä¾åçè´è½½åè¡¡å¨åå¤é¨æ´é²æå¡ã\n * externalnameï¼å°æå¡æ å°å°æå®çååï¼è¿ä¸ªååå¯ä»¥éç¾¤åé¨ä¹å¯ä»¥æ¯å¤é¨çã\n * nodeportï¼æä¾çæå¡æ¢å¯å¯¹å¤é¨æå¡éè¿nodeip:nodeportè®¿é®ï¼ä¹å¯ä»¥å¯¹éç¾¤åé¨éè¿clusteripè®¿é®\n * clusteripï¼serviceæä¾çè®¿é®ipä»å¨éç¾¤åé¨å¯è¾¾\n\n\n# ä½¿ç¨clusterip service\n\næä»¬å®ä¹serviceå¦ä¸ï¼å¶ä¸­selectoræ¯ç¨æ¥ç­ééè¦ä»£ççpodï¼targetportæ¯ç®æ podçç«¯å£ï¼portæ¯æè¯¥serviceçç«¯å£ã\n\nkind: service \napiversion: v1 \nmetadata: \n  name: demoapp-svc \nspec: \n  selector: \n    app: demoapp \n  ports: \n  - name: http \n    protocol: tcp    \n    port: 80\n    targetport: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nä½¿ç¨ä¸é¢å®ä¹çyamlåå»ºserviceå¯¹è±¡ï¼å¹¶å¯ä»¥çå°selectorçå¼æ¯app=demoappï¼æä»¬éè¦åå»ºå¸¦æè¯¥æ ç­¾çpodï¼æè½å¤è¿è¡ä»£çã\n\n[root@k8s-worker1 zwf]# kubectl apply -f service.yaml -n zwf\nservice/demoapp-svc created\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf -o wide\nname          type        cluster-ip   external-ip   port(s)   age   selector\ndemoapp-svc   clusterip   10.0.0.74    <none>        80/tcp    18s   app=demoapp\n\n\n1\n2\n3\n4\n5\n6\n\n\nå®ä¹deploymentï¼ä¼åå»ºå¸¦æapp=demoappçpod\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  labels:\n    app: demoapp\n  name: demo-deploy\n\nspec:\n  replicas: 2\n  selector:\n    matchlabels:\n      app: demoapp\n\n  template:\n    metadata:\n      labels:\n        app: demoapp\n    spec:\n      containers:\n      - image: mirrors.sangfor.com/ikubernetes/demoapp:v1.0\n        name: demoapp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåå»ºdeploymentå¯¹è±¡ï¼å¹¶ä¸å¯ä»¥çå°åå»ºäº2ä¸ªpod\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments_service.yaml -n zwf\ndeployment.apps/demo-deploy created\n\n[root@k8s-worker1 zwf]# kubectl get deploy -o wide -n zwf\nname          ready   up-to-date   available   age     containers   images                                         selector\ndemo-deploy   2/2     2            2           2m37s   demoapp      mirrors.sangfor.com/ikubernetes/demoapp:v1.0   app=demoapp\n\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næ¥çpodçè¯¦æï¼å¯ä»¥çå°labelsæä¸ä¸ªapp=demoappçæ ç­¾\n\n[root@k8s-worker1 zwf]# kubectl get pods -o wide -n zwf\nname                           ready   status    restarts   age   ip               node          nominated node   readiness gates\ndemo-deploy-6c6d588789-h9gmd   1/1     running   0          32s   10.222.126.1     k8s-worker2   <none>           <none>\ndemo-deploy-6c6d588789-nhzhl   1/1     running   0          32s   10.222.194.104   k8s-worker1   <none>           <none>\n\n[root@k8s-worker1 zwf]# kubectl describe demo-deploy-6c6d588789-h9gmd -n zwf\nname:         demo-deploy-6c6d588789-h9gmd\nnamespace:    zwf\npriority:     0\nnode:         k8s-worker2/10.64.2.153\nstart time:   tue, 30 aug 2022 19:23:22 +0800\nlabels:       app=demoapp\n              pod-template-hash=6c6d588789\n\n....\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\néè¿æ¥çserviceçè¯¦æï¼æä»¬å¯ä»¥çå°endpointsçå¼æ¯ä¸é¢åå»ºçä¸¤ä¸ªpodçipã\n\n[root@k8s-worker1 zwf]# kubectl describe svc -n zwf\nname:              demoapp-svc\nnamespace:         zwf\nlabels:            <none>\nannotations:       <none>\nselector:          app=demoapp\ntype:              clusterip\nip family policy:  singlestack\nip families:       ipv4\nip:                10.0.0.74\nips:               10.0.0.74\nport:              http  80/tcp\ntargetport:        80/tcp\nendpoints:         10.222.126.1:80,10.222.194.104:80\nsession affinity:  none\nevents:            <none>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nendpointsä¹æ¯ä¸ä¸ªèµæºå¯¹è±¡ï¼serviceéè¿ç­éæ ç­¾å°çpodä¼æ·»å å°endpintsä¸­ä¿å­\n\n[root@k8s-worker1 zwf]# kubectl get endpoints -n zwf\nname          endpoints                           age\ndemoapp-svc   10.222.126.1:80,10.222.194.104:80   15m\n\n\n1\n2\n3\n\n\nè¿ä¸ªæ¶åï¼æä»¬è®¿é®serviceç80ç«¯å£ï¼ä¼è®¿é®å°è½®è¯¢è®¿é®å°è¿ä¸¤ä¸ªpodä¸­ï¼æä»¬å°±å¯ä»¥éè¿è®¿é®serviceæ¥è®¿é®podéåã\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\nikubernetes demoapp v1.0 !! clientip: 10.64.2.141, servername: demo-deploy-6c6d588789-nhzhl, serverip: 10.222.194.104!\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\nikubernetes demoapp v1.0 !! clientip: 10.64.2.141, servername: demo-deploy-6c6d588789-h9gmd, serverip: 10.222.126.1!\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\nikubernetes demoapp v1.0 !! clientip: 10.64.2.141, servername: demo-deploy-6c6d588789-nhzhl, serverip: 10.222.194.104!\n\n[root@k8s-worker1 zwf]# curl 10.0.0.74\nikubernetes demoapp v1.0 !! clientip: 10.64.2.141, servername: demo-deploy-6c6d588789-h9gmd, serverip: 10.222.126.1!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\né¤äºéè¿clusteripè®¿é®ï¼å¨éç¾¤ä¸­ä¹è½éè¿ååè¿è¡è®¿é®ï¼è®¿é®æ¹å¼ï¼<servicename>.<namespace>.svc.cluster.local\n\n[root@k8s-worker1 zwf]# kubectl exec -it demo-deploy-6c6d588789-h9gmd -n zwf  -- nslookup demoapp-svc.zwf.svc.cluster.local\nserver:         10.0.0.2\naddress:        10.0.0.2#53\n\nname:   demoapp-svc.zwf.svc.cluster.local\naddress: 10.0.0.74\n\n[root@k8s-worker1 zwf]# kubectl exec -it demo-deploy-6c6d588789-h9gmd -n zwf  -- curl demoapp-svc.zwf.svc.cluster.local\nikubernetes demoapp v1.0 !! clientip: 10.64.2.153, servername: demo-deploy-6c6d588789-h9gmd, serverip: 10.222.126.1!\n\n[root@k8s-worker1 zwf]# kubectl exec -it demo-deploy-6c6d588789-h9gmd -n zwf  -- curl demoapp-svc.zwf.svc.cluster.local\nikubernetes demoapp v1.0 !! clientip: 10.222.126.1, servername: demo-deploy-6c6d588789-nhzhl, serverip: 10.222.194.104!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# ä½¿ç¨nodeport service\n\nå®ä¹nodeport serviceå¦ä¸ï¼åclusterip serviceæ¯è¾ï¼æ°å¢type: nodeportä»£è¡¨è¯¥serviceçç±»åæ¯nodeportï¼ç¶ånodeportæ¯èç¹çç«¯å£ï¼å¨æ¯ä¸å°nodeä¸é½ä¼åå»ºè¿ä¹ä¸ä¸ªç«¯å£ç»éç¾¤å¤è°ç¨ã\n\nkind: service\napiversion: v1\nmetadata:\n  name: demoapp-nodeport-svc\nspec:\n  selector:\n    app: demoapp\n  ports:\n  - name: http\n    protocol: tcp\n    port: 80\n    targetport: 80\n    nodeport: 31999\n  type: nodeport\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåå»ºè¯¥serviceï¼å¯ä»¥çå°typeæ¯nodeportï¼portæ¯80:31999ä»£è¡¨çå°80ç«¯å£æ å°å°èç¹ç31999ç«¯å£\n\n[root@k8s-worker1 zwf]# kubectl apply -f service_nodeport.yaml -n zwf\nservice/demoapp-nodeport-svc created\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf -o wide\nname                   type        cluster-ip   external-ip   port(s)        age   selector\ndemoapp-nodeport-svc   nodeport    10.0.0.144   <none>        80:31999/tcp   10s   app=demoapp\ndemoapp-svc            clusterip   10.0.0.74    <none>        80/tcp         47m   app=demoapp\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næä»¬å¯ä»¥å¨éç¾¤å¤éè¿èç¹çip:31999ç«¯å£ä¸æ ·å¯ä»¥è®¿é®podæå¡ã\n\nc:\\users\\user>curl 10.64.2.141:31999\nikubernetes demoapp v1.0 !! clientip: 10.64.2.141, servername: demo-deploy-6c6d588789-nhzhl, serverip: 10.222.194.104!\n\nc:\\users\\user>curl 10.64.2.141:31999\nikubernetes demoapp v1.0 !! clientip: 10.64.2.141, servername: demo-deploy-6c6d588789-h9gmd, serverip: 10.222.126.1!\n\n\n1\n2\n3\n4\n5\n\n\n\n# å¦ä½å®ç°çä»£çï¼\n\næ¯ä¸ªnodeé½ä¼æä¸ä¸ªkube-proxyè¿ç¨ï¼è¯¥è¿ç¨ä¼çæ§serviceçåå»ºä¸endpointsåè¡¨çæ·»å ä¸å é¤ï¼éç½®iptablesè§åï¼å½å®¢æ·ç«¯è¯·æ±serviceçclusteripåç«¯å£æ¶ï¼ä¼æ ¹æ®è§åè½®è¯¢è½¬åå°åç«¯çpodä¸­ã\n\n",charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"k8sä¹ConfigMapåSecret",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],title:"k8sä¹ConfigMapåSecret",date:"2022-08-30T21:16:09.000Z",permalink:"/pages/ff8188/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»k8sä¸­çconfigmapåsecretèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"twitter:title",content:"k8sä¹ConfigMapåSecret"},{name:"twitter:description",content:"ä»ç»k8sä¸­çconfigmapåsecretèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/06.k8s%E4%B9%8BConfigMap%E5%92%8CSecret.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹ConfigMapåSecret"},{property:"og:description",content:"ä»ç»k8sä¸­çconfigmapåsecretèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/06.k8s%E4%B9%8BConfigMap%E5%92%8CSecret.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-30T21:16:09.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹ConfigMapåSecret"},{itemprop:"description",content:"ä»ç»k8sä¸­çconfigmapåsecretèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/06.k8s%E4%B9%8BConfigMap%E5%92%8CSecret.html",relativePath:"01.äºåç/07.k8s/06.k8sä¹ConfigMapåSecret.md",key:"v-ba5a65c4",path:"/pages/ff8188/",headers:[{level:2,title:"ConfigMap",slug:"configmap",normalizedTitle:"configmap",charIndex:2},{level:3,title:"ä»ä¹æ¯ConfigMap?",slug:"ä»ä¹æ¯configmap",normalizedTitle:"ä»ä¹æ¯configmap?",charIndex:16},{level:3,title:"åå»ºConifgMap",slug:"åå»ºconifgmap",normalizedTitle:"åå»ºconifgmap",charIndex:54},{level:2,title:"Secret",slug:"secret",normalizedTitle:"secret",charIndex:526},{level:3,title:"ä»ä¹æ¯Secret?",slug:"ä»ä¹æ¯secret",normalizedTitle:"ä»ä¹æ¯secret?",charIndex:537},{level:3,title:"åå»ºSecret",slug:"åå»ºsecret",normalizedTitle:"åå»ºsecret",charIndex:650},{level:2,title:"å¦ä½ä½¿ç¨ConfigMap/Secret",slug:"å¦ä½ä½¿ç¨configmap-secret",normalizedTitle:"å¦ä½ä½¿ç¨configmap/secret",charIndex:2439},{level:3,title:"æ³¨å¥ç¯å¢åé",slug:"æ³¨å¥ç¯å¢åé",normalizedTitle:"æ³¨å¥ç¯å¢åé",charIndex:2544},{level:3,title:"æ³¨å¥éç½®æä»¶",slug:"æ³¨å¥éç½®æä»¶",normalizedTitle:"æ³¨å¥éç½®æä»¶",charIndex:4200}],headersStr:"ConfigMap ä»ä¹æ¯ConfigMap? åå»ºConifgMap Secret ä»ä¹æ¯Secret? åå»ºSecret å¦ä½ä½¿ç¨ConfigMap/Secret æ³¨å¥ç¯å¢åé æ³¨å¥éç½®æä»¶",content:'# ConfigMap\n\n\n# ä»ä¹æ¯ConfigMap?\n\nç¨æ¥å­å¨åºç¨æéè¦çææéç½®æ°æ®çã\n\n\n# åå»ºConifgMap\n\nä½¿ç¨yamlå®ä¹ConfigMapå¯¹è±¡ï¼å¨dataå­æ®µä¸­å®ä¹éç½®æ°æ®ã\n\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: info\n\ndata:\n  count: \'10\'\n  debug: \'on\'\n  path: \'/etc/systemd\'\n  greeting: |\n    say hello to kubernetes.\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nä½¿ç¨å®ä¹çyamlæä»¶åå»ºConfigMapå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f config.yaml  -n zwf\nconfigmap/info created\n\n[root@k8s-worker1 zwf]# kubectl get cm -n zwf\nNAME               DATA   AGE\ninfo               4      9s\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# Secret\n\n\n# ä»ä¹æ¯Secret?\n\nåConfigMapåºæ¬ç¸åï¼å·®å¼å¨äºå­å¨çæ¯å¯æçéç½®æ°æ®ã\n\nå·ä½çä½ç°å¨äºï¼ä½¿ç¨kubectl describeæ¶ï¼ConfigMapå¯ä»¥çå°éç½®ä¿¡æ¯ï¼èSecretæ¯çä¸å°å·ä½åå®¹çã\n\n\n# åå»ºSecret\n\nä½¿ç¨yamlæè¿°æä»¶åå»ºSecretå¯¹è±¡ï¼å¶ä¸­çæ°æ®å¿é¡»å¾æ¯base64ç¼ç çå¯æï¼å¦åä¼åå»ºå¤±è´¥ã\n\napiVersion: v1\nkind: Secret\nmetadata:\n  name: user\n\ndata:\n  name: cm9vdA==  # root\n  pwd: MTIzNDU2   # 123456\n  db: bXlzcWw=    # mysql\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nä½¿ç¨ä¸é¢çyamlæä»¶åå»ºSecretå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f secret.yaml -n zwf\nsecret/user created\n\n[root@k8s-worker1 zwf]# kubectl get secret -n zwf\nNAME                                 TYPE                                  DATA   AGE\nuser                                 Opaque                                3      9s\n\n\n1\n2\n3\n4\n5\n6\n\n\néè¿æ¥çSecretè¯¦æï¼ä¼åç°é½æ¯å¯æçï¼æ æ³æ¥ç\n\n[root@k8s-worker1 zwf]# kubectl describe secret user -n zwf\nName:         user\nNamespace:    zwf\nLabels:       <none>\nAnnotations:  <none>\n\nType:  Opaque\n\nData\n====\ndb:    5 bytes\nname:  4 bytes\npwd:   6 bytes\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nä½æ¯è¿æ¯å¯ä»¥éè¿èªå·±éè¿base64è§£ç æ¥è·å\n\n[root@k8s-worker1 zwf]# kubectl get secret user -n zwf -o json\n{\n    "apiVersion": "v1",\n    "data": {\n        "db": "bXlzcWw=",\n        "name": "cm9vdA==",\n        "pwd": "MTIzNDU2"\n    },\n    "kind": "Secret",\n    "metadata": {\n        "annotations": {\n            "kubectl.kubernetes.io/last-applied-configuration": "{\\"apiVersion\\":\\"v1\\",\\"data\\":{\\"db\\":\\"bXlzcWw=\\",\\"name\\":\\"cm9vdA==\\",\\"pwd\\":\\"MTIzNDU2\\"},\\"kind\\":\\"Secret\\",\\"metadata\\":{\\"annotations\\":{},\\"name\\":\\"user\\",\\"namespace\\":\\"zwf\\"}}\\n"\n        },\n        "creationTimestamp": "2022-08-31T01:43:30Z",\n        "name": "user",\n        "namespace": "zwf",\n        "resourceVersion": "17208325",\n        "uid": "c5082495-1b85-42ef-a202-596d65e2449c"\n    },\n    "type": "Opaque"\n}\n\n[root@k8s-worker1 zwf]#  kubectl get secret user -n zwf -o jsonpath="{.data.name}" | base64 --decode\nroot\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\n\n# å¦ä½ä½¿ç¨ConfigMap/Secret\n\nä½¿ç¨çæ¹å¼\n\n * å°éç½®ä»¥ç¯å¢åéçæ¹å¼æ³¨å¥å°å®¹å¨ä¸­ï¼åºç¨ç¨åºä»ç¯å¢åéä¸­è·åéç½®\n\n * å°éç½®ä»¥æä»¶çæ¹å¼æ¾å¨å®¹å¨çç®å½ä¸­ï¼åºç¨ç¨åºä»æä»¶ä¸­è·åéç½®ã\n\n\n# æ³¨å¥ç¯å¢åé\n\nå®ä¹Deploymentçyamlæä»¶ï¼å¨containersä¸çenvä¸­ä½¿ç¨configMapKeyRefæ¥ä½¿ç¨ConfigMapä¸­çå¼ä½ä¸ºç¯å¢åéã\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: ngx-dep\n\n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: mirrors.sangfor.com/nginx:alpine\n        name: nginx2\n        ports:\n        - containerPort: 80\n        env:\n        - name: count\n          valueFrom:\n            configMapKeyRef:\n              name: info\n              key: count\n        - name: debug\n          valueFrom:\n            configMapKeyRef:\n              name: info\n              key: debug\n        - name: pwd\n          valueFrom:\n            secretKeyRef:\n              name: user\n              key: pwd\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\nä½¿ç¨ä¸é¢å®ä¹çyamlåå»ºDeploymentå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments_cm.yaml -n zwf\ndeployment.apps/ngx-dep created\n\n[root@k8s-worker1 zwf]# kubectl get deploy -n zwf\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\nngx-dep   2/2     2            2           1h\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME                       READY   STATUS    RESTARTS   AGE\nngx-dep-6c659bcc45-nnkgz   1/1     Running   0          8s\nngx-dep-6c659bcc45-rgfxx   1/1     Running   0          6s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¿å¥å°å®¹å¨ä¸­ï¼å¯ä»¥æ¥çå°æä»¬è®¾ç½®debugãcountãpwdçå¼\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-6c659bcc45-nnkgz -n zwf -- /bin/sh\n/ # echo $debug\non\n/ # echo $count\n10\n/ # echo $pwd\n123456\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# æ³¨å¥éç½®æä»¶\n\nç¼åæè¿°Deploymentæä»¶ï¼å¨sepcä¸å®ä¹ä¸¤ä¸ªvolumeï¼ç¶åå¨containersä¸è¿è¡ä½¿ç¨volumeMountså­æ®µè¿è¡æè½½ã\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: ngx-dep\n\n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: mirrors.sangfor.com/nginx:alpine\n        name: nginx2\n        ports:\n        - containerPort: 80\n      - volumeMountsï¼\n        - mountPath: /tmp/cm-items\n          name: cm-vol\n        - mountPath: /tmp/sec-items\n          name: sec-vol\n\n      volumes:\n      - name: cm-vol\n        configMap:\n          name: info\n\t  - name: sec-vol \n\t    secret: \n\t    secretName: user\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nåå»ºè¯¥Deploymentå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments_cm_file.yaml -n zwf\ndeployment.apps/ngx-dep configured\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME                       READY   STATUS    RESTARTS   AGE\nngx-dep-798f6f6c4f-cg6lv   1/1     Running   0          9s\nngx-dep-798f6f6c4f-s8wws   1/1     Running   0          6s\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næä»¬å¯ä»¥çå°å¨å®¹å¨åé¨å¨tmpç®å½ä¸åå»ºäºcm-itemsåsec-itemsç®å½\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- ls /tmp/\ncm-items   sec-items\n\n\n1\n2\n\n\nåçå°è¿ä¸¤ä¸ªç®å½ä¸çæä»¶ï¼é½æ¯ä»¥ConfigMapåSecretä¸­å®ä¹çkeyä¸ºæä»¶åï¼valueä¸ºæä»¶ä¸­çåå®¹\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- ls /tmp/cm-items\ncount     debug     greeting  path\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- cat /tmp/cm-items/debug\non\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- ls /tmp/sec-items\ndb    name  pwd\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- cat /tmp/sec-items/pwd\n123456\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n',normalizedContent:'# configmap\n\n\n# ä»ä¹æ¯configmap?\n\nç¨æ¥å­å¨åºç¨æéè¦çææéç½®æ°æ®çã\n\n\n# åå»ºconifgmap\n\nä½¿ç¨yamlå®ä¹configmapå¯¹è±¡ï¼å¨dataå­æ®µä¸­å®ä¹éç½®æ°æ®ã\n\napiversion: v1\nkind: configmap\nmetadata:\n  name: info\n\ndata:\n  count: \'10\'\n  debug: \'on\'\n  path: \'/etc/systemd\'\n  greeting: |\n    say hello to kubernetes.\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nä½¿ç¨å®ä¹çyamlæä»¶åå»ºconfigmapå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f config.yaml  -n zwf\nconfigmap/info created\n\n[root@k8s-worker1 zwf]# kubectl get cm -n zwf\nname               data   age\ninfo               4      9s\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# secret\n\n\n# ä»ä¹æ¯secret?\n\nåconfigmapåºæ¬ç¸åï¼å·®å¼å¨äºå­å¨çæ¯å¯æçéç½®æ°æ®ã\n\nå·ä½çä½ç°å¨äºï¼ä½¿ç¨kubectl describeæ¶ï¼configmapå¯ä»¥çå°éç½®ä¿¡æ¯ï¼èsecretæ¯çä¸å°å·ä½åå®¹çã\n\n\n# åå»ºsecret\n\nä½¿ç¨yamlæè¿°æä»¶åå»ºsecretå¯¹è±¡ï¼å¶ä¸­çæ°æ®å¿é¡»å¾æ¯base64ç¼ç çå¯æï¼å¦åä¼åå»ºå¤±è´¥ã\n\napiversion: v1\nkind: secret\nmetadata:\n  name: user\n\ndata:\n  name: cm9vda==  # root\n  pwd: mtizndu2   # 123456\n  db: bxlzcww=    # mysql\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nä½¿ç¨ä¸é¢çyamlæä»¶åå»ºsecretå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f secret.yaml -n zwf\nsecret/user created\n\n[root@k8s-worker1 zwf]# kubectl get secret -n zwf\nname                                 type                                  data   age\nuser                                 opaque                                3      9s\n\n\n1\n2\n3\n4\n5\n6\n\n\néè¿æ¥çsecretè¯¦æï¼ä¼åç°é½æ¯å¯æçï¼æ æ³æ¥ç\n\n[root@k8s-worker1 zwf]# kubectl describe secret user -n zwf\nname:         user\nnamespace:    zwf\nlabels:       <none>\nannotations:  <none>\n\ntype:  opaque\n\ndata\n====\ndb:    5 bytes\nname:  4 bytes\npwd:   6 bytes\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nä½æ¯è¿æ¯å¯ä»¥éè¿èªå·±éè¿base64è§£ç æ¥è·å\n\n[root@k8s-worker1 zwf]# kubectl get secret user -n zwf -o json\n{\n    "apiversion": "v1",\n    "data": {\n        "db": "bxlzcww=",\n        "name": "cm9vda==",\n        "pwd": "mtizndu2"\n    },\n    "kind": "secret",\n    "metadata": {\n        "annotations": {\n            "kubectl.kubernetes.io/last-applied-configuration": "{\\"apiversion\\":\\"v1\\",\\"data\\":{\\"db\\":\\"bxlzcww=\\",\\"name\\":\\"cm9vda==\\",\\"pwd\\":\\"mtizndu2\\"},\\"kind\\":\\"secret\\",\\"metadata\\":{\\"annotations\\":{},\\"name\\":\\"user\\",\\"namespace\\":\\"zwf\\"}}\\n"\n        },\n        "creationtimestamp": "2022-08-31t01:43:30z",\n        "name": "user",\n        "namespace": "zwf",\n        "resourceversion": "17208325",\n        "uid": "c5082495-1b85-42ef-a202-596d65e2449c"\n    },\n    "type": "opaque"\n}\n\n[root@k8s-worker1 zwf]#  kubectl get secret user -n zwf -o jsonpath="{.data.name}" | base64 --decode\nroot\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\n\n# å¦ä½ä½¿ç¨configmap/secret\n\nä½¿ç¨çæ¹å¼\n\n * å°éç½®ä»¥ç¯å¢åéçæ¹å¼æ³¨å¥å°å®¹å¨ä¸­ï¼åºç¨ç¨åºä»ç¯å¢åéä¸­è·åéç½®\n\n * å°éç½®ä»¥æä»¶çæ¹å¼æ¾å¨å®¹å¨çç®å½ä¸­ï¼åºç¨ç¨åºä»æä»¶ä¸­è·åéç½®ã\n\n\n# æ³¨å¥ç¯å¢åé\n\nå®ä¹deploymentçyamlæä»¶ï¼å¨containersä¸çenvä¸­ä½¿ç¨configmapkeyrefæ¥ä½¿ç¨configmapä¸­çå¼ä½ä¸ºç¯å¢åéã\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n\nspec:\n  replicas: 2\n  selector:\n    matchlabels:\n      app: ngx-dep\n\n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: mirrors.sangfor.com/nginx:alpine\n        name: nginx2\n        ports:\n        - containerport: 80\n        env:\n        - name: count\n          valuefrom:\n            configmapkeyref:\n              name: info\n              key: count\n        - name: debug\n          valuefrom:\n            configmapkeyref:\n              name: info\n              key: debug\n        - name: pwd\n          valuefrom:\n            secretkeyref:\n              name: user\n              key: pwd\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\nä½¿ç¨ä¸é¢å®ä¹çyamlåå»ºdeploymentå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments_cm.yaml -n zwf\ndeployment.apps/ngx-dep created\n\n[root@k8s-worker1 zwf]# kubectl get deploy -n zwf\nname      ready   up-to-date   available   age\nngx-dep   2/2     2            2           1h\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname                       ready   status    restarts   age\nngx-dep-6c659bcc45-nnkgz   1/1     running   0          8s\nngx-dep-6c659bcc45-rgfxx   1/1     running   0          6s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¿å¥å°å®¹å¨ä¸­ï¼å¯ä»¥æ¥çå°æä»¬è®¾ç½®debugãcountãpwdçå¼\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-6c659bcc45-nnkgz -n zwf -- /bin/sh\n/ # echo $debug\non\n/ # echo $count\n10\n/ # echo $pwd\n123456\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# æ³¨å¥éç½®æä»¶\n\nç¼åæè¿°deploymentæä»¶ï¼å¨sepcä¸å®ä¹ä¸¤ä¸ªvolumeï¼ç¶åå¨containersä¸è¿è¡ä½¿ç¨volumemountså­æ®µè¿è¡æè½½ã\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  labels:\n    app: ngx-dep\n  name: ngx-dep\n\nspec:\n  replicas: 2\n  selector:\n    matchlabels:\n      app: ngx-dep\n\n  template:\n    metadata:\n      labels:\n        app: ngx-dep\n    spec:\n      containers:\n      - image: mirrors.sangfor.com/nginx:alpine\n        name: nginx2\n        ports:\n        - containerport: 80\n      - volumemountsï¼\n        - mountpath: /tmp/cm-items\n          name: cm-vol\n        - mountpath: /tmp/sec-items\n          name: sec-vol\n\n      volumes:\n      - name: cm-vol\n        configmap:\n          name: info\n\t  - name: sec-vol \n\t    secret: \n\t    secretname: user\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nåå»ºè¯¥deploymentå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f deployments_cm_file.yaml -n zwf\ndeployment.apps/ngx-dep configured\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname                       ready   status    restarts   age\nngx-dep-798f6f6c4f-cg6lv   1/1     running   0          9s\nngx-dep-798f6f6c4f-s8wws   1/1     running   0          6s\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næä»¬å¯ä»¥çå°å¨å®¹å¨åé¨å¨tmpç®å½ä¸åå»ºäºcm-itemsåsec-itemsç®å½\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- ls /tmp/\ncm-items   sec-items\n\n\n1\n2\n\n\nåçå°è¿ä¸¤ä¸ªç®å½ä¸çæä»¶ï¼é½æ¯ä»¥configmapåsecretä¸­å®ä¹çkeyä¸ºæä»¶åï¼valueä¸ºæä»¶ä¸­çåå®¹\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- ls /tmp/cm-items\ncount     debug     greeting  path\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- cat /tmp/cm-items/debug\non\n\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- ls /tmp/sec-items\ndb    name  pwd\n[root@k8s-worker1 zwf]# kubectl exec -it ngx-dep-798f6f6c4f-cg6lv -n zwf -- cat /tmp/sec-items/pwd\n123456\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"Goè¯­è¨é«æ§è½ç¼ç¨",frontmatter:{pageComponent:{name:"Catalogue",data:{path:"04.ç¼ç¨/02.goè¯­è¨/01.goè¯­è¨é«æ§è½ç¼ç¨",description:"goè¯­è¨é«æ§è½ç¼ç¨"}},title:"Goè¯­è¨é«æ§è½ç¼ç¨",date:"2025-06-14T23:31:00.000Z",permalink:"/go_performance/",sidebar:!1,article:!1,comment:!1,editLink:!1,feed:{enable:!0},author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"",meta:[{name:"twitter:title",content:"Goè¯­è¨é«æ§è½ç¼ç¨"},{name:"twitter:description",content:""},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/00.%E7%9B%AE%E5%BD%95%E9%A1%B5/01.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨é«æ§è½ç¼ç¨"},{property:"og:description",content:""},{property:"og:url",content:"https://www.zhengwenfeng.com/00.%E7%9B%AE%E5%BD%95%E9%A1%B5/01.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T23:31:00.000Z"},{itemprop:"name",content:"Goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"description",content:""}],readingShow:"top"},regularPath:"/00.%E7%9B%AE%E5%BD%95%E9%A1%B5/01.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B.html",relativePath:"00.ç®å½é¡µ/01.Goè¯­è¨é«æ§è½ç¼ç¨.md",key:"v-64f910e0",path:"/go_performance/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"k8sä¹JobåCronJob",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],title:"k8sä¹JobåCronJob",date:"2022-08-31T10:34:54.000Z",permalink:"/pages/c96905/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»k8sä¸­çjobèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220721102314.png"},{name:"twitter:title",content:"k8sä¹JobåCronJob"},{name:"twitter:description",content:"ä»ç»k8sä¸­çjobèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220721102314.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/07.k8s%E4%B9%8BJob%E5%92%8CCronJob.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹JobåCronJob"},{property:"og:description",content:"ä»ç»k8sä¸­çjobèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220721102314.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/07.k8s%E4%B9%8BJob%E5%92%8CCronJob.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-31T10:34:54.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹JobåCronJob"},{itemprop:"description",content:"ä»ç»k8sä¸­çjobèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220721102314.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/07.k8s%E4%B9%8BJob%E5%92%8CCronJob.html",relativePath:"01.äºåç/07.k8s/07.k8sä¹JobåCronJob.md",key:"v-3ff5ce46",path:"/pages/c96905/",headers:[{level:2,title:"Job",slug:"job",normalizedTitle:"job",charIndex:2},{level:3,title:"ä»ä¹æ¯Job?",slug:"ä»ä¹æ¯job",normalizedTitle:"ä»ä¹æ¯job?",charIndex:10},{level:3,title:"ä½¿ç¨Job",slug:"ä½¿ç¨job",normalizedTitle:"ä½¿ç¨job",charIndex:46},{level:2,title:"CronJob",slug:"cronjob",normalizedTitle:"cronjob",charIndex:1082},{level:3,title:"ä»ä¹æ¯ConJobï¼",slug:"ä»ä¹æ¯conjob",normalizedTitle:"ä»ä¹æ¯conjobï¼",charIndex:1094},{level:3,title:"ä½¿ç¨CronJob",slug:"ä½¿ç¨cronjob",normalizedTitle:"ä½¿ç¨cronjob",charIndex:1121}],headersStr:"Job ä»ä¹æ¯Job? ä½¿ç¨Job CronJob ä»ä¹æ¯ConJobï¼ ä½¿ç¨CronJob",content:'# Job\n\n\n# ä»ä¹æ¯Job?\n\nè¯¥å¯¹è±¡æ¯ç¨æ¥æ§è¡è¿è¡ä¸æ®µæ¶é´åä¼éåºçä»»å¡ã\n\n\n# ä½¿ç¨Job\n\nä½¿ç¨yamlæè¿°Jobå¯¹è±¡ï¼å¶ä¸­restartPolicyæ¯éå¯ç­ç¥ï¼éè¦è®¾å®ä¸ºOnFailureï¼ä»£è¡¨çå¦æå¤±è´¥åéå¯ï¼å¦ææ¯æ­£å¸¸æ§è¡å®æéåºï¼åä¸éè¦åæ¬¡å¯å¨ãé»è®¤çå¼æ¯Alwaysï¼ä¼ä¿æçè¯¥Podæ»æ¯è¿è¡çã\n\ntemplateä¸çPodæ¨¡æ¿ï¼Jobéè¿è¯¥æ¨¡æ¿æ¥åå»ºPodã\n\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: echo-job\n\nspec:\n  template:\n    spec:\n      restartPolicy: OnFailure\n      containers:\n      - image: busybox\n        name: echo-job\n        command: ["/bin/echo"]\n        args: ["hello", "world"]\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\n\n\nä½¿ç¨yamlæä»¶åå»ºJobï¼ç¶åæ¥çjobçpodå¯¹è±¡ï¼ä¼åç°å®çSTATUSç¶æä¸ºCompletedï¼å ä¸ºè¯¥jobæ­£å¸¸å®æç»æéåºäºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f job.yaml -n zwf\njob.batch/echo-job created\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME                       READY   STATUS      RESTARTS   AGE\necho-job-45pmc             0/1     Completed   0          5s\n\n\n1\n2\n3\n4\n5\n6\n\n\nåæ¥çä¸è¯¥Completedçlogï¼ä¼åç°å·²ç»è¾åºäºhello world\n\n[root@k8s-worker1 zwf]# kubectl logs echo-job-45pmc  -n zwf\nhello world\n\n\n1\n2\n\n\nJobçåæ°\n\n * activeDeadlineSecondsï¼è®¾ç½® Pod è¿è¡çè¶æ¶æ¶é´ã\n\n * backoffLimitï¼è®¾ç½® Pod çå¤±è´¥éè¯æ¬¡æ°ã\n\nä¸ºä»ä¹ä¸ç´æ¥å¨Podä¸å®ç°ï¼èè¦æ°åå»ºå¯¹è±¡Job?\n\nä¿æåä¸ååï¼å°ä¸å¡ç¹æ§ä¸å®¹å¨ç®¡çåå¼ã\n\n\n# CronJob\n\n\n# ä»ä¹æ¯ConJobï¼\n\nè¯¥å¯¹è±¡ç¨äºå®æ¶ä»»å¡ã\n\n\n# ä½¿ç¨CronJob\n\nä½¿ç¨Yamlæè¿°CronJobå¯¹è±¡ï¼ä¼åç°è¯¥å¯¹è±¡å¤äºä¸ä¸ªscheduleå­æ®µï¼è¿ä¸ªæ¯ç¨æ¥æè¿°å®æ¶ä»»å¡å¨æçè§åï¼jobTemplateæ¯Jobå¯¹è±¡çæ¨¡æ¿ï¼ä¹å°±æ¯å¨å®æ¶å¨æåä¸æ­åå»ºJobå¯¹è±¡æ¥è¾¾å°å®æ¶ä»»å¡çç®çï¼ä¹æ¯ä¸ç§ç»åçæ¹å¼ã\n\n\napiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: echo-cj\n\nspec:\n  schedule: \'*/1 * * * *\'\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          restartPolicy: OnFailure\n          containers:\n          - image: busybox\n            name: echo-cj\n            imagePullPolicy: IfNotPresent\n            command: ["/bin/echo"]\n            args: ["hello", "world"]\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\n\n\nä½¿ç¨å®ä¹çYamlåå»ºCronJob\n\n[root@k8s-worker1 zwf]# kubectl apply -f cronjob.yaml -n zwf\ncronjob.batch/echo-cj created\n\n[root@k8s-worker1 zwf]# kubectl get cronjob -n zwf\nNAME      SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE\necho-cj   */1 * * * *   False     1        1s              2m24s\n\n\n1\n2\n3\n4\n5\n6\n\n\nç­å¾3åéåï¼åå»ºäº3ä¸ªCronJobçPodï¼å¹¶ä¸éè¿AGEå¯ä»¥åç°æ¯æ¯åéåå»ºä¸ä¸ªã\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME                       READY   STATUS      RESTARTS   AGE\necho-cj-27698578-jtfxm     0/1     Completed   0          2m23s\necho-cj-27698579-cdzxg     0/1     Completed   0          83s\necho-cj-27698580-rfp72     0/1     Completed   0          23s\n\n1\n2\n3\n4\n',normalizedContent:'# job\n\n\n# ä»ä¹æ¯job?\n\nè¯¥å¯¹è±¡æ¯ç¨æ¥æ§è¡è¿è¡ä¸æ®µæ¶é´åä¼éåºçä»»å¡ã\n\n\n# ä½¿ç¨job\n\nä½¿ç¨yamlæè¿°jobå¯¹è±¡ï¼å¶ä¸­restartpolicyæ¯éå¯ç­ç¥ï¼éè¦è®¾å®ä¸ºonfailureï¼ä»£è¡¨çå¦æå¤±è´¥åéå¯ï¼å¦ææ¯æ­£å¸¸æ§è¡å®æéåºï¼åä¸éè¦åæ¬¡å¯å¨ãé»è®¤çå¼æ¯alwaysï¼ä¼ä¿æçè¯¥podæ»æ¯è¿è¡çã\n\ntemplateä¸çpodæ¨¡æ¿ï¼jobéè¿è¯¥æ¨¡æ¿æ¥åå»ºpodã\n\napiversion: batch/v1\nkind: job\nmetadata:\n  name: echo-job\n\nspec:\n  template:\n    spec:\n      restartpolicy: onfailure\n      containers:\n      - image: busybox\n        name: echo-job\n        command: ["/bin/echo"]\n        args: ["hello", "world"]\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\n\n\nä½¿ç¨yamlæä»¶åå»ºjobï¼ç¶åæ¥çjobçpodå¯¹è±¡ï¼ä¼åç°å®çstatusç¶æä¸ºcompletedï¼å ä¸ºè¯¥jobæ­£å¸¸å®æç»æéåºäºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f job.yaml -n zwf\njob.batch/echo-job created\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname                       ready   status      restarts   age\necho-job-45pmc             0/1     completed   0          5s\n\n\n1\n2\n3\n4\n5\n6\n\n\nåæ¥çä¸è¯¥completedçlogï¼ä¼åç°å·²ç»è¾åºäºhello world\n\n[root@k8s-worker1 zwf]# kubectl logs echo-job-45pmc  -n zwf\nhello world\n\n\n1\n2\n\n\njobçåæ°\n\n * activedeadlinesecondsï¼è®¾ç½® pod è¿è¡çè¶æ¶æ¶é´ã\n\n * backofflimitï¼è®¾ç½® pod çå¤±è´¥éè¯æ¬¡æ°ã\n\nä¸ºä»ä¹ä¸ç´æ¥å¨podä¸å®ç°ï¼èè¦æ°åå»ºå¯¹è±¡job?\n\nä¿æåä¸ååï¼å°ä¸å¡ç¹æ§ä¸å®¹å¨ç®¡çåå¼ã\n\n\n# cronjob\n\n\n# ä»ä¹æ¯conjobï¼\n\nè¯¥å¯¹è±¡ç¨äºå®æ¶ä»»å¡ã\n\n\n# ä½¿ç¨cronjob\n\nä½¿ç¨yamlæè¿°cronjobå¯¹è±¡ï¼ä¼åç°è¯¥å¯¹è±¡å¤äºä¸ä¸ªscheduleå­æ®µï¼è¿ä¸ªæ¯ç¨æ¥æè¿°å®æ¶ä»»å¡å¨æçè§åï¼jobtemplateæ¯jobå¯¹è±¡çæ¨¡æ¿ï¼ä¹å°±æ¯å¨å®æ¶å¨æåä¸æ­åå»ºjobå¯¹è±¡æ¥è¾¾å°å®æ¶ä»»å¡çç®çï¼ä¹æ¯ä¸ç§ç»åçæ¹å¼ã\n\n\napiversion: batch/v1\nkind: cronjob\nmetadata:\n  name: echo-cj\n\nspec:\n  schedule: \'*/1 * * * *\'\n  jobtemplate:\n    spec:\n      template:\n        spec:\n          restartpolicy: onfailure\n          containers:\n          - image: busybox\n            name: echo-cj\n            imagepullpolicy: ifnotpresent\n            command: ["/bin/echo"]\n            args: ["hello", "world"]\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\n\n\nä½¿ç¨å®ä¹çyamlåå»ºcronjob\n\n[root@k8s-worker1 zwf]# kubectl apply -f cronjob.yaml -n zwf\ncronjob.batch/echo-cj created\n\n[root@k8s-worker1 zwf]# kubectl get cronjob -n zwf\nname      schedule      suspend   active   last schedule   age\necho-cj   */1 * * * *   false     1        1s              2m24s\n\n\n1\n2\n3\n4\n5\n6\n\n\nç­å¾3åéåï¼åå»ºäº3ä¸ªcronjobçpodï¼å¹¶ä¸éè¿ageå¯ä»¥åç°æ¯æ¯åéåå»ºä¸ä¸ªã\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname                       ready   status      restarts   age\necho-cj-27698578-jtfxm     0/1     completed   0          2m23s\necho-cj-27698579-cdzxg     0/1     completed   0          83s\necho-cj-27698580-rfp72     0/1     completed   0          23s\n\n1\n2\n3\n4\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"Bug éç¼ä»¤",frontmatter:{pageComponent:{name:"Catalogue",data:{path:"02.Bug éç¼ä»¤",description:"ææ¥ Bug çç ´æ¡æ¥åã"}},title:"Bug éç¼ä»¤",date:"2025-09-14T10:59:00.000Z",permalink:"/bug_hunt/",sidebar:!1,article:!1,comment:!1,editLink:!1,feed:{enable:!0},author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"",meta:[{name:"twitter:title",content:"Bug éç¼ä»¤"},{name:"twitter:description",content:""},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/00.%E7%9B%AE%E5%BD%95%E9%A1%B5/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Bug éç¼ä»¤"},{property:"og:description",content:""},{property:"og:url",content:"https://www.zhengwenfeng.com/00.%E7%9B%AE%E5%BD%95%E9%A1%B5/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-09-14T10:59:00.000Z"},{itemprop:"name",content:"Bug éç¼ä»¤"},{itemprop:"description",content:""}],readingShow:"top"},regularPath:"/00.%E7%9B%AE%E5%BD%95%E9%A1%B5/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4.html",relativePath:"00.ç®å½é¡µ/02.Bug éç¼ä»¤.md",key:"v-470b5455",path:"/bug_hunt/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2025/09/14, 11:01:01",lastUpdatedTimestamp:1757818861e3},{title:"k8sä¹DaemonSet",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],title:"k8sä¹DaemonSet",date:"2022-08-31T11:06:48.000Z",permalink:"/pages/92bee4/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»k8sä¸­çdaemonsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"twitter:title",content:"k8sä¹DaemonSet"},{name:"twitter:description",content:"ä»ç»k8sä¸­çdaemonsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/08.k8s%E4%B9%8BDaemonSet.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹DaemonSet"},{property:"og:description",content:"ä»ç»k8sä¸­çdaemonsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/08.k8s%E4%B9%8BDaemonSet.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-31T11:06:48.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹DaemonSet"},{itemprop:"description",content:"ä»ç»k8sä¸­çdaemonsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/08.k8s%E4%B9%8BDaemonSet.html",relativePath:"01.äºåç/07.k8s/08.k8sä¹DaemonSet.md",key:"v-411a2b26",path:"/pages/92bee4/",headers:[{level:2,title:"ä»ä¹æ¯DaemonSetï¼",slug:"ä»ä¹æ¯daemonset",normalizedTitle:"ä»ä¹æ¯daemonsetï¼",charIndex:2},{level:2,title:"ä½¿ç¨DaemonSet",slug:"ä½¿ç¨daemonset",normalizedTitle:"ä½¿ç¨daemonset",charIndex:153}],headersStr:"ä»ä¹æ¯DaemonSetï¼ ä½¿ç¨DaemonSet",content:"# ä»ä¹æ¯DaemonSetï¼\n\nå¨K8séç¾¤ä¸­çæ¯ä¸ä¸ªNodeä¸­é½ä¼è¿è¡ä¸ä¸ªPodçæ§å¶å¨ã\n\nä½¿ç¨åºæ¯æ¯ï¼\n\n * æ¥å¿æ¶éï¼æ¯ä¸ªèç¹è¿è¡ä¸ä¸ªPodç¨äºæ¶éå®¹å¨äº§ççæ¥å¿\n * çæ§ç®¡çï¼æ¯ä¸ªèç¹è¿è¡ä¸ä¸ªpodç¨äºçæ§èç¹çç¶æ\n * ç½ç»åºç¨ï¼æ¯ä¸ªèç¹è¿è¡ä¸ä¸ªPodç¨äºå°èç¹å å¥k8sç½ç»\n\n\n# ä½¿ç¨DaemonSet\n\nä½¿ç¨yamlæè¿°DaemonSetå¯¹è±¡\n\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: nginx-ds\n  labels:\n    k8s-app: nginx-ds\nspec:\n  selector:\n    matchLabels:\n      name: nginx-ds\n  template:\n    metadata:\n      labels:\n        name: nginx-ds\n    spec:\n      containers:\n      - name: nginx-ds\n        image: nginx\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nåå»ºDaemonSetå¯¹è±¡ï¼ä¼çå°èªå¨çæ¯ä¸ä¸ªèç¹ä¸­é½åå»ºäºä¸ä¸ªpodã\n\n[root@k8s-worker1 zwf]# kubectl apply -f daemonset.yaml -n zwf\ndaemonset.apps/nginx-ds configured\n\n[root@k8s-worker1 zwf]# kubectl get nodes\nNAME          STATUS   ROLES    AGE    VERSION\nk8s-master    Ready    <none>   32d    v1.23.4\nk8s-worker1   Ready    <none>   152d   v1.23.4\nk8s-worker2   Ready    <none>   152d   v1.23.4\n\n[root@k8s-worker1 zwf]# kubectl get ds -n zwf\nNAME       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nnginx-ds   3         3         3       3            3           <none>          4m2s\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES\nnginx-ds-7w2kx   1/1     Running   0          81s   10.222.194.73    k8s-worker1   <none>           <none>\nnginx-ds-l5lmx   1/1     Running   0          46s   10.222.126.38    k8s-worker2   <none>           <none>\nnginx-ds-zdfgl   1/1     Running   0          82s   10.222.235.217   k8s-master    <none>           <none>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n",normalizedContent:"# ä»ä¹æ¯daemonsetï¼\n\nå¨k8séç¾¤ä¸­çæ¯ä¸ä¸ªnodeä¸­é½ä¼è¿è¡ä¸ä¸ªpodçæ§å¶å¨ã\n\nä½¿ç¨åºæ¯æ¯ï¼\n\n * æ¥å¿æ¶éï¼æ¯ä¸ªèç¹è¿è¡ä¸ä¸ªpodç¨äºæ¶éå®¹å¨äº§ççæ¥å¿\n * çæ§ç®¡çï¼æ¯ä¸ªèç¹è¿è¡ä¸ä¸ªpodç¨äºçæ§èç¹çç¶æ\n * ç½ç»åºç¨ï¼æ¯ä¸ªèç¹è¿è¡ä¸ä¸ªpodç¨äºå°èç¹å å¥k8sç½ç»\n\n\n# ä½¿ç¨daemonset\n\nä½¿ç¨yamlæè¿°daemonsetå¯¹è±¡\n\napiversion: apps/v1\nkind: daemonset\nmetadata:\n  name: nginx-ds\n  labels:\n    k8s-app: nginx-ds\nspec:\n  selector:\n    matchlabels:\n      name: nginx-ds\n  template:\n    metadata:\n      labels:\n        name: nginx-ds\n    spec:\n      containers:\n      - name: nginx-ds\n        image: nginx\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nåå»ºdaemonsetå¯¹è±¡ï¼ä¼çå°èªå¨çæ¯ä¸ä¸ªèç¹ä¸­é½åå»ºäºä¸ä¸ªpodã\n\n[root@k8s-worker1 zwf]# kubectl apply -f daemonset.yaml -n zwf\ndaemonset.apps/nginx-ds configured\n\n[root@k8s-worker1 zwf]# kubectl get nodes\nname          status   roles    age    version\nk8s-master    ready    <none>   32d    v1.23.4\nk8s-worker1   ready    <none>   152d   v1.23.4\nk8s-worker2   ready    <none>   152d   v1.23.4\n\n[root@k8s-worker1 zwf]# kubectl get ds -n zwf\nname       desired   current   ready   up-to-date   available   node selector   age\nnginx-ds   3         3         3       3            3           <none>          4m2s\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf -o wide\nname             ready   status    restarts   age   ip               node          nominated node   readiness gates\nnginx-ds-7w2kx   1/1     running   0          81s   10.222.194.73    k8s-worker1   <none>           <none>\nnginx-ds-l5lmx   1/1     running   0          46s   10.222.126.38    k8s-worker2   <none>           <none>\nnginx-ds-zdfgl   1/1     running   0          82s   10.222.235.217   k8s-master    <none>           <none>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n",charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"k8sä¹PVãPVCåStorageClass",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],title:"k8sä¹PVãPVCåStorageClass",date:"2022-08-31T15:03:37.000Z",permalink:"/pages/095c75/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»k8sä¸­çpvãpvcåstorageclassèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831163136.png"},{name:"twitter:title",content:"k8sä¹PVãPVCåStorageClass"},{name:"twitter:description",content:"ä»ç»k8sä¸­çpvãpvcåstorageclassèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831163136.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/09.k8s%E4%B9%8BPV%E3%80%81PVC%E5%92%8CStorageClass.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹PVãPVCåStorageClass"},{property:"og:description",content:"ä»ç»k8sä¸­çpvãpvcåstorageclassèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831163136.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/09.k8s%E4%B9%8BPV%E3%80%81PVC%E5%92%8CStorageClass.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-31T15:03:37.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹PVãPVCåStorageClass"},{itemprop:"description",content:"ä»ç»k8sä¸­çpvãpvcåstorageclassèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831163136.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/09.k8s%E4%B9%8BPV%E3%80%81PVC%E5%92%8CStorageClass.html",relativePath:"01.äºåç/07.k8s/09.k8sä¹PVãPVCåStorageClass.md",key:"v-14bd5c2a",path:"/pages/095c75/",headers:[{level:2,title:"PV",slug:"pv",normalizedTitle:"pv",charIndex:2},{level:3,title:"ä»ä¹æ¯PVï¼",slug:"ä»ä¹æ¯pv",normalizedTitle:"ä»ä¹æ¯pvï¼",charIndex:9},{level:3,title:"åå»ºPV",slug:"åå»ºpv",normalizedTitle:"åå»ºpv",charIndex:78},{level:2,title:"PVC",slug:"pvc",normalizedTitle:"pvc",charIndex:918},{level:3,title:"ä»ä¹æ¯PVCï¼",slug:"ä»ä¹æ¯pvc",normalizedTitle:"ä»ä¹æ¯pvcï¼",charIndex:926},{level:3,title:"åå»ºPVC",slug:"åå»ºpvc",normalizedTitle:"åå»ºpvc",charIndex:1095},{level:2,title:"å¨Podä¸­ç³è¯·PVC",slug:"å¨podä¸­ç³è¯·pvc",normalizedTitle:"å¨podä¸­ç³è¯·pvc",charIndex:1861},{level:2,title:"StorageClass",slug:"storageclass",normalizedTitle:"storageclass",charIndex:2832},{level:3,title:"éè¿StorageClasséç½®NFS Provisioner",slug:"éè¿storageclasséç½®nfs-provisioner",normalizedTitle:"éè¿storageclasséç½®nfs provisioner",charIndex:3020},{level:3,title:"ä½¿ç¨NFSå¨æå­å¨å·",slug:"ä½¿ç¨nfså¨æå­å¨å·",normalizedTitle:"ä½¿ç¨nfså¨æå­å¨å·",charIndex:4499}],headersStr:"PV ä»ä¹æ¯PVï¼ åå»ºPV PVC ä»ä¹æ¯PVCï¼ åå»ºPVC å¨Podä¸­ç³è¯·PVC StorageClass éè¿StorageClasséç½®NFS Provisioner ä½¿ç¨NFSå¨æå­å¨å·",content:'# PV\n\n\n# ä»ä¹æ¯PVï¼\n\nPV æè¿°çï¼åæ¯ä¸ä¸ªå·ä½ç Volume çå±æ§ï¼æ¯å¦ Volume çç±»åãæè½½ç®å½ãè¿ç¨å­å¨æå¡å¨å°åç­ã\n\n\n# åå»ºPV\n\nä½¿ç¨yamlæ¥å®ä¹PV\n\n\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: nfs-1g-pv\n\nspec:\n  storageClassName: nfs\n  accessModes:\n    - ReadWriteMany\n  capacity:\n    storage: 1Gi\n\n  nfs:\n    path: /root/zwf/share\n    server: 10.64.2.153\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nåæ°è¯´æï¼\n\n * storageClassNameçå¼ä¸ºnfsï¼ä½¿ç¨äºNFSç½ç»æä»¶ç³»ç»ä½ä¸ºå­å¨å·ï¼\n * accessModesçå¼ä¸ºReadWriteManyï¼æ¯æå¤ä¸ªèç¹åæ¶è¯»åè¯¥å±äº«ç®å½\n * storageçå¼ä¸º1Giï¼åéäº1Gçå­å¨ç©ºé´\n\nä½¿ç¨yamlå®ä¹çæè¿°æä»¶æ¥åå»ºPVå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f pv.yaml -n zwf\npersistentvolume/nfs-1g-pv created\n[root@k8s-worker1 zwf]# kubectl get pv -n zwf\nNAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                           STORAGECLASS   REASON   AGE\nnfs-1g-pv   1Gi        RWX            Retain           Available                                   nfs                     12s\n\n\n1\n2\n3\n4\n5\n\n\n\n# PVC\n\n\n# ä»ä¹æ¯PVCï¼\n\næä¾ç»åºç¨å¼åè·åå­å¨èµæºçå¯¹è±¡ï¼å¼åå°podä¸PVCè¿è¡ç»å®å¯ä»¥è¾¾å°æä¹åçå­å¨ç¶æï¼èPVCä¼ä¸ç¸å¯¹åºçPVç¸ç»å®ï¼æä¾å·ä½çå­å¨ç©ºé´ã\n\nPVåPVCæä»ä¹åºå«ï¼\n\nå®éä¸ç±»ä¼¼äºâæ¥å£âåâå®ç°âçææ³ãå¼åèåªè¦ç¥éå¹¶ä¼ä½¿ç¨âæ¥å£âï¼å³ï¼PVCï¼èè¿ç»´äººååè´è´£ç»âæ¥å£âç»å®å·ä½çå®ç°ï¼å³ï¼PVã\n\n\n\n\n# åå»ºPVC\n\næäºpvä¹åï¼åå»ºç³è¯·å­å¨çPVCå¯¹è±¡ï¼yamlå®ä¹å¦ä¸ï¼å®ä¹çåå®¹åPVåºæ¬ç¸åï¼ä½æ¯ä¸åå«NFSçå­å¨ç»èã\n\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: nfs-static-pvc\n\nspec:\n  storageClassName: nfs\n  accessModes:\n    - ReadWriteMany\n\n  resources:\n    requests:\n      storage: 1Gi\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåå»ºpvcå¯¹è±¡ï¼å¹¶ä¸å¯ä»¥çå°VOLUMEçå¼æ¯ä¸é¢åå»ºçpvå¯¹è±¡ï¼è¿æ ·ä¸¤èå°±è¿è¡ç»å®äºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f pvc.yaml -n zwf\npersistentvolumeclaim/nfs-static-pvc created\n[root@k8s-worker1 zwf]# \n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nNAME             STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nnfs-static-pvc   Bound    nfs-1g-pv   1Gi        RWX            nfs            9s\n\n\n1\n2\n3\n4\n5\n6\n\n\næä»¬åpvcæä»¶ä¸­å¹¶æ²¡æå¡«åpvçä»»ä½ä¿¡æ¯ï¼å®æ¯å¦ä½ç¥éè¯¥ç»å®é£ä¸ªpvå¯¹è±¡çå¢ï¼è¿æ¯å ä¸ºpvcä¼æ ¹æ®èªèº«éè¦çå®¹éå»æ¾å°å¯¹åºçpvè¿è¡å¹éç»å®ã\n\n\n# å¨Podä¸­ç³è¯·PVC\n\nPodçyamlå®ä¹å¦ä¸ï¼ä½¿ç¨volumeså®ä¹äºå­å¨å·ä½¿ç¨ä¸é¢åå»ºçpvcå¯¹è±¡nfs-static-pvcï¼å¨containersä¸­ä½¿ç¨vlumeMountså¨podä¸­æè½½äº/tmpç®å½å¨è¯¥å­å¨å·ä¸­ã\n\n\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nfs-static-pod\n\nspec:\n  volumes:\n  - name: nfs-pvc-vol\n    persistentVolumeClaim:\n      claimName: nfs-static-pvc\n\n  containers:\n    - name: nfs-pvc-test\n      image: nginx:alpine\n      ports:\n      - containerPort: 80\n\n      volumeMounts:\n        - name: nfs-pvc-vol\n          mountPath: /tmp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåå»ºpodåï¼æä»¬è¿å¥podä¸­å¨/tmpåå¥æ°æ®\n\n[root@k8s-worker1 zwf]# kubectl apply -f pod_pvc.yaml -n zwf\npod/nfs-static-pod created\n\n[root@k8s-worker1 zwf]# kubectl exec -it nfs-static-pod -n zwf -- /bin/sh\n/ # cd /tmp\n/tmp # echo 222 > 2.txt\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨nfsæå¡å¨ä¸­ç/root/zwf/shareä¸­ï¼æä»¬ä¹å¯ä»¥çå°ä¸é¢åçæ°æ®\n\n[root@k8s-worker2 share]# pwd\n/root/zwf/share\n[root@k8s-worker2 share]# ls\n2.txt\n[root@k8s-worker2 share]# cat 2.txt\n222\n\n\n1\n2\n3\n4\n5\n6\n\n\nPodãPVCãPV å NFS å­å¨çå³ç³»å¯ä»¥ç¨ä¸å¾æ¥å½¢è±¡å°è¡¨ç¤ºï¼\n\n\n\n\n# StorageClass\n\nä¸é¢çPVæ¯éè¦ç®¡çåæå¨åå»ºçï¼æ¯ä¸æ¬¡çå¼åé½éè¦æ ¹æ®éæ±éä¸ªåå»ºPVï¼å¹¶ä¸è¿éè¦ç²¾ç¡®åå»ºç©ºé´å¤§å°ï¼å¯¼è´å·¥ä½éå·¨å¤§ãæä»¥æä»¬éè¦å¨å¼åä¸­å¯ä»¥å¨æçåå»ºPVã\n\nStoreageClasså¯ä»¥ç¨æ¥ç»å®Provisionerå¯¹è±¡ï¼èè¿ä¸ªProvisionerå°±æ¯ä¸ä¸ªè½å¤èªå¨ç®¡çå­å¨ãåå»º PV çåºç¨ï¼ä»£æ¿äºåæ¥ç³»ç»ç®¡çåçæå·¥å³å¨ã\n\n\n\n\n# éè¿StorageClasséç½®NFS Provisioner\n\nk8sä¸­æ¯ä¸ç±»çå­å¨è®¾å¤é½æç¸åºçProvisionerï¼è¿éæä»¬ä½¿ç¨çæ¯NFS Provisioner(https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)\n\nå¨ GitHub ç deploy ç®å½éæ¯é¨ç½²å®æéç YAML æä»¶ï¼ä¸å±æä¸ä¸ªï¼åå«æ¯ rbac.yamlãclass.yamlå deployment.yamlã\n\n 1. é¦åå°rbac.yamlçnamespaceæ¹ækube-system\n 2. å¨ä¿®æ¹deployment.yamlçnamespaceä¹æ¹ä¸ºkube-systemï¼åä¿®æ¹å¶ä¸­çvolumes å env éç IP å°ååå±äº«ç®å½åï¼ä¸NFSæå¡å¨ä¿æä¸è´.\n\n\nspec:\n  template:\n    spec:\n      serviceAccountName: nfs-client-provisioner\n      containers:\n      ...\n          env:\n            - name: PROVISIONER_NAME\n              value: k8s-sigs.io/nfs-subdir-external-provisioner\n            - name: NFS_SERVER\n              value: 192.168.10.208        #æ¹IPå°å\n            - name: NFS_PATH\n              value: /tmp/nfs              #æ¹å±äº«ç®å½å\n      volumes:\n        - name: nfs-client-root\n          nfs:\n            server: 192.168.10.208         #æ¹IPå°å\n            Path: /tmp/nfs                 #æ¹å±äº«ç®å½å\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nåå°k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2æ¹æchronolaw/nfs-subdir-external-provisioner:v4.0.2\n\n 3. æååå»ºNFS Provisioner\n\nkubectl apply -f rbac.yaml\nkubectl apply -f class.yaml\nkubectl apply -f deployment.yaml\n\n\n1\n2\n3\n\n\næ¥çkube-systemçpodå¯ä»¥çå°nfsçprovisionerã\n\n[root@k8s-worker1 zwf]# kubectl get pods -n kube-system\nNAME                                      READY   STATUS    RESTARTS      AGE\nnfs-client-provisioner-57789d96b7-42q67   1/1     Running   0             22h\n\n\n1\n2\n3\n\n\n\n# ä½¿ç¨NFSå¨æå­å¨å·\n\nåå»ºStrogeClasså¯¹è±¡ï¼onDelete: "remain"ä»£è¡¨çå³ä½¿Podè¢«å é¤ï¼ä¹ä¼ä¿çåéçå­å¨ï¼ä¹ååæå¨å é¤ã\n\n\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: nfs-client\n\nprovisioner: k8s-sigs.io/nfs-subdir-external-provisioner \nparameters:\n  onDelete: "remain"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nåå»ºStrageClasså¯¹è±¡ï¼å¹¶å¯ä»¥çå°PROVISIONERå·²ç»ç»å®äºæä»¬ä¸é¢åå»ºçnfs-provisioneräºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f pvc_dyn.yaml -n zwf\nstorageclass.storage.k8s.io/nfs-client-retained created\n\n[root@k8s-worker1 zwf]# kubectl get sc -n zwf\nNAME                  PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE\nnfs-client   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           false                  21h\n\n\n1\n2\n3\n4\n5\n6\n\n\nå®ä¹PVCï¼éç½®storageClassName:nfs-clientä¸ä¸é¢çStrageClasså¯¹è±¡ç¸ç»å®ã\n\n\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: nfs-dyn-10m-pvc\n\nspec:\n  storageClassName: nfs-client\n  accessModes:\n    - ReadWriteMany\n\n  resources:\n    requests:\n      storage: 10Mi\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåå»ºPVCï¼ç¶åä½ ä¼åç°STATUSçç¶æä¸ºBoundï¼å·²ç»èªå¨çåå»ºäºPVï¼å¹¶ä¸å·²ç»ç¸äºç»å®ã\n\n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nNAME              STATUS    VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nnfs-dyn-10m-pvc   Pending                                         nfs-client     25s\n\n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nNAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nnfs-dyn-10m-pvc   Bound    pvc-292cfed3-bec8-4425-aeac-697e3740c76c   10Mi       RWX            nfs-client     9s\n\n[root@k8s-worker1 zwf]# kubectl get pv -n zwf\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                           STORAGECLASS   REASON   AGE\npvc-292cfed3-bec8-4425-aeac-697e3740c76c   10Mi       RWX            Delete           Bound    zwf/nfs-dyn-10m-pvc             nfs-client              47s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå»NFSæä»¶æå¡å¨çå±äº«ç®å½ä¸­æ¥çï¼å¯ä»¥çå°å¤åºæ¥äºä¸ä¸ªç®å½ï¼ç®å½åç§°ä¸ºå½åç©ºé´-pvcåç§°-pvcåç§°\n\n[root@k8s-worker2 share]# pwd\n/root/zwf/share\n[root@k8s-worker2 share]# ls\nzwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c\n\n\n1\n2\n3\n4\n\n\nå®ä¹Podï¼æè½½ä¸é¢åå»ºçPVCå°å®¹å¨ç/tmpç®å½ä¸­\n\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nfs-dyn-pod\n\nspec:\n  volumes:\n  - name: nfs-dyn-10m-vol\n    persistentVolumeClaim:\n      claimName: nfs-dyn-10m-pvc\n\n  containers:\n    - name: nfs-dyn-test\n      image: nginx:alpine\n\n      volumeMounts:\n        - name: nfs-dyn-10m-vol\n          mountPath: /tmp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nåå»ºPodæå\n\n[root@k8s-worker1 zwf]# kubectl apply -f pod_strageclass.yaml -n zwf\npod/nfs-dyn-pod created\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME          READY   STATUS    RESTARTS   AGE\nnfs-dyn-pod   1/1     Running   0          10s\n\n\n1\n2\n3\n4\n5\n\n\nè¿å¥å°æè½½äºpvcçpodï¼ç¶åå¨/tmpç®å½ä¸åä¸ä¸ªæä»¶\n\nkubectl exec -it nfs-dyn-pod -n zwf -- /bin/sh\n/ # cd /tmp\n/tmp # echo 111 > 3.txt\n\n\n1\n2\n3\n\n\nåå°NFSæå¡å¨ä¸çå±äº«ç®å½å¯¹åºçpvç®å½ä¸ï¼è½çå°ä¹ååçæä»¶ã\n\n[root@k8s-worker2 zwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c]# pwd\n/root/zwf/share/zwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c\n\n[root@k8s-worker2 zwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c]# cat 3.txt \n111\n\n\n1\n2\n3\n4\n5\n\n\nå³ç³»å¾å¦ä¸ï¼\n\n',normalizedContent:'# pv\n\n\n# ä»ä¹æ¯pvï¼\n\npv æè¿°çï¼åæ¯ä¸ä¸ªå·ä½ç volume çå±æ§ï¼æ¯å¦ volume çç±»åãæè½½ç®å½ãè¿ç¨å­å¨æå¡å¨å°åç­ã\n\n\n# åå»ºpv\n\nä½¿ç¨yamlæ¥å®ä¹pv\n\n\napiversion: v1\nkind: persistentvolume\nmetadata:\n  name: nfs-1g-pv\n\nspec:\n  storageclassname: nfs\n  accessmodes:\n    - readwritemany\n  capacity:\n    storage: 1gi\n\n  nfs:\n    path: /root/zwf/share\n    server: 10.64.2.153\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nåæ°è¯´æï¼\n\n * storageclassnameçå¼ä¸ºnfsï¼ä½¿ç¨äºnfsç½ç»æä»¶ç³»ç»ä½ä¸ºå­å¨å·ï¼\n * accessmodesçå¼ä¸ºreadwritemanyï¼æ¯æå¤ä¸ªèç¹åæ¶è¯»åè¯¥å±äº«ç®å½\n * storageçå¼ä¸º1giï¼åéäº1gçå­å¨ç©ºé´\n\nä½¿ç¨yamlå®ä¹çæè¿°æä»¶æ¥åå»ºpvå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f pv.yaml -n zwf\npersistentvolume/nfs-1g-pv created\n[root@k8s-worker1 zwf]# kubectl get pv -n zwf\nname        capacity   access modes   reclaim policy   status      claim                           storageclass   reason   age\nnfs-1g-pv   1gi        rwx            retain           available                                   nfs                     12s\n\n\n1\n2\n3\n4\n5\n\n\n\n# pvc\n\n\n# ä»ä¹æ¯pvcï¼\n\næä¾ç»åºç¨å¼åè·åå­å¨èµæºçå¯¹è±¡ï¼å¼åå°podä¸pvcè¿è¡ç»å®å¯ä»¥è¾¾å°æä¹åçå­å¨ç¶æï¼èpvcä¼ä¸ç¸å¯¹åºçpvç¸ç»å®ï¼æä¾å·ä½çå­å¨ç©ºé´ã\n\npvåpvcæä»ä¹åºå«ï¼\n\nå®éä¸ç±»ä¼¼äºâæ¥å£âåâå®ç°âçææ³ãå¼åèåªè¦ç¥éå¹¶ä¼ä½¿ç¨âæ¥å£âï¼å³ï¼pvcï¼èè¿ç»´äººååè´è´£ç»âæ¥å£âç»å®å·ä½çå®ç°ï¼å³ï¼pvã\n\n\n\n\n# åå»ºpvc\n\næäºpvä¹åï¼åå»ºç³è¯·å­å¨çpvcå¯¹è±¡ï¼yamlå®ä¹å¦ä¸ï¼å®ä¹çåå®¹åpvåºæ¬ç¸åï¼ä½æ¯ä¸åå«nfsçå­å¨ç»èã\n\napiversion: v1\nkind: persistentvolumeclaim\nmetadata:\n  name: nfs-static-pvc\n\nspec:\n  storageclassname: nfs\n  accessmodes:\n    - readwritemany\n\n  resources:\n    requests:\n      storage: 1gi\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåå»ºpvcå¯¹è±¡ï¼å¹¶ä¸å¯ä»¥çå°volumeçå¼æ¯ä¸é¢åå»ºçpvå¯¹è±¡ï¼è¿æ ·ä¸¤èå°±è¿è¡ç»å®äºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f pvc.yaml -n zwf\npersistentvolumeclaim/nfs-static-pvc created\n[root@k8s-worker1 zwf]# \n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nname             status   volume      capacity   access modes   storageclass   age\nnfs-static-pvc   bound    nfs-1g-pv   1gi        rwx            nfs            9s\n\n\n1\n2\n3\n4\n5\n6\n\n\næä»¬åpvcæä»¶ä¸­å¹¶æ²¡æå¡«åpvçä»»ä½ä¿¡æ¯ï¼å®æ¯å¦ä½ç¥éè¯¥ç»å®é£ä¸ªpvå¯¹è±¡çå¢ï¼è¿æ¯å ä¸ºpvcä¼æ ¹æ®èªèº«éè¦çå®¹éå»æ¾å°å¯¹åºçpvè¿è¡å¹éç»å®ã\n\n\n# å¨podä¸­ç³è¯·pvc\n\npodçyamlå®ä¹å¦ä¸ï¼ä½¿ç¨volumeså®ä¹äºå­å¨å·ä½¿ç¨ä¸é¢åå»ºçpvcå¯¹è±¡nfs-static-pvcï¼å¨containersä¸­ä½¿ç¨vlumemountså¨podä¸­æè½½äº/tmpç®å½å¨è¯¥å­å¨å·ä¸­ã\n\n\napiversion: v1\nkind: pod\nmetadata:\n  name: nfs-static-pod\n\nspec:\n  volumes:\n  - name: nfs-pvc-vol\n    persistentvolumeclaim:\n      claimname: nfs-static-pvc\n\n  containers:\n    - name: nfs-pvc-test\n      image: nginx:alpine\n      ports:\n      - containerport: 80\n\n      volumemounts:\n        - name: nfs-pvc-vol\n          mountpath: /tmp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåå»ºpodåï¼æä»¬è¿å¥podä¸­å¨/tmpåå¥æ°æ®\n\n[root@k8s-worker1 zwf]# kubectl apply -f pod_pvc.yaml -n zwf\npod/nfs-static-pod created\n\n[root@k8s-worker1 zwf]# kubectl exec -it nfs-static-pod -n zwf -- /bin/sh\n/ # cd /tmp\n/tmp # echo 222 > 2.txt\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨nfsæå¡å¨ä¸­ç/root/zwf/shareä¸­ï¼æä»¬ä¹å¯ä»¥çå°ä¸é¢åçæ°æ®\n\n[root@k8s-worker2 share]# pwd\n/root/zwf/share\n[root@k8s-worker2 share]# ls\n2.txt\n[root@k8s-worker2 share]# cat 2.txt\n222\n\n\n1\n2\n3\n4\n5\n6\n\n\npodãpvcãpv å nfs å­å¨çå³ç³»å¯ä»¥ç¨ä¸å¾æ¥å½¢è±¡å°è¡¨ç¤ºï¼\n\n\n\n\n# storageclass\n\nä¸é¢çpvæ¯éè¦ç®¡çåæå¨åå»ºçï¼æ¯ä¸æ¬¡çå¼åé½éè¦æ ¹æ®éæ±éä¸ªåå»ºpvï¼å¹¶ä¸è¿éè¦ç²¾ç¡®åå»ºç©ºé´å¤§å°ï¼å¯¼è´å·¥ä½éå·¨å¤§ãæä»¥æä»¬éè¦å¨å¼åä¸­å¯ä»¥å¨æçåå»ºpvã\n\nstoreageclasså¯ä»¥ç¨æ¥ç»å®provisionerå¯¹è±¡ï¼èè¿ä¸ªprovisionerå°±æ¯ä¸ä¸ªè½å¤èªå¨ç®¡çå­å¨ãåå»º pv çåºç¨ï¼ä»£æ¿äºåæ¥ç³»ç»ç®¡çåçæå·¥å³å¨ã\n\n\n\n\n# éè¿storageclasséç½®nfs provisioner\n\nk8sä¸­æ¯ä¸ç±»çå­å¨è®¾å¤é½æç¸åºçprovisionerï¼è¿éæä»¬ä½¿ç¨çæ¯nfs provisioner(https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)\n\nå¨ github ç deploy ç®å½éæ¯é¨ç½²å®æéç yaml æä»¶ï¼ä¸å±æä¸ä¸ªï¼åå«æ¯ rbac.yamlãclass.yamlå deployment.yamlã\n\n 1. é¦åå°rbac.yamlçnamespaceæ¹ækube-system\n 2. å¨ä¿®æ¹deployment.yamlçnamespaceä¹æ¹ä¸ºkube-systemï¼åä¿®æ¹å¶ä¸­çvolumes å env éç ip å°ååå±äº«ç®å½åï¼ä¸nfsæå¡å¨ä¿æä¸è´.\n\n\nspec:\n  template:\n    spec:\n      serviceaccountname: nfs-client-provisioner\n      containers:\n      ...\n          env:\n            - name: provisioner_name\n              value: k8s-sigs.io/nfs-subdir-external-provisioner\n            - name: nfs_server\n              value: 192.168.10.208        #æ¹ipå°å\n            - name: nfs_path\n              value: /tmp/nfs              #æ¹å±äº«ç®å½å\n      volumes:\n        - name: nfs-client-root\n          nfs:\n            server: 192.168.10.208         #æ¹ipå°å\n            path: /tmp/nfs                 #æ¹å±äº«ç®å½å\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nåå°k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2æ¹æchronolaw/nfs-subdir-external-provisioner:v4.0.2\n\n 3. æååå»ºnfs provisioner\n\nkubectl apply -f rbac.yaml\nkubectl apply -f class.yaml\nkubectl apply -f deployment.yaml\n\n\n1\n2\n3\n\n\næ¥çkube-systemçpodå¯ä»¥çå°nfsçprovisionerã\n\n[root@k8s-worker1 zwf]# kubectl get pods -n kube-system\nname                                      ready   status    restarts      age\nnfs-client-provisioner-57789d96b7-42q67   1/1     running   0             22h\n\n\n1\n2\n3\n\n\n\n# ä½¿ç¨nfså¨æå­å¨å·\n\nåå»ºstrogeclasså¯¹è±¡ï¼ondelete: "remain"ä»£è¡¨çå³ä½¿podè¢«å é¤ï¼ä¹ä¼ä¿çåéçå­å¨ï¼ä¹ååæå¨å é¤ã\n\n\napiversion: storage.k8s.io/v1\nkind: storageclass\nmetadata:\n  name: nfs-client\n\nprovisioner: k8s-sigs.io/nfs-subdir-external-provisioner \nparameters:\n  ondelete: "remain"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nåå»ºstrageclasså¯¹è±¡ï¼å¹¶å¯ä»¥çå°provisionerå·²ç»ç»å®äºæä»¬ä¸é¢åå»ºçnfs-provisioneräºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f pvc_dyn.yaml -n zwf\nstorageclass.storage.k8s.io/nfs-client-retained created\n\n[root@k8s-worker1 zwf]# kubectl get sc -n zwf\nname                  provisioner                                   reclaimpolicy   volumebindingmode   allowvolumeexpansion   age\nnfs-client   k8s-sigs.io/nfs-subdir-external-provisioner   delete          immediate           false                  21h\n\n\n1\n2\n3\n4\n5\n6\n\n\nå®ä¹pvcï¼éç½®storageclassname:nfs-clientä¸ä¸é¢çstrageclasså¯¹è±¡ç¸ç»å®ã\n\n\napiversion: v1\nkind: persistentvolumeclaim\nmetadata:\n  name: nfs-dyn-10m-pvc\n\nspec:\n  storageclassname: nfs-client\n  accessmodes:\n    - readwritemany\n\n  resources:\n    requests:\n      storage: 10mi\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåå»ºpvcï¼ç¶åä½ ä¼åç°statusçç¶æä¸ºboundï¼å·²ç»èªå¨çåå»ºäºpvï¼å¹¶ä¸å·²ç»ç¸äºç»å®ã\n\n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nname              status    volume      capacity   access modes   storageclass   age\nnfs-dyn-10m-pvc   pending                                         nfs-client     25s\n\n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nname              status   volume                                     capacity   access modes   storageclass   age\nnfs-dyn-10m-pvc   bound    pvc-292cfed3-bec8-4425-aeac-697e3740c76c   10mi       rwx            nfs-client     9s\n\n[root@k8s-worker1 zwf]# kubectl get pv -n zwf\nname                                       capacity   access modes   reclaim policy   status   claim                           storageclass   reason   age\npvc-292cfed3-bec8-4425-aeac-697e3740c76c   10mi       rwx            delete           bound    zwf/nfs-dyn-10m-pvc             nfs-client              47s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå»nfsæä»¶æå¡å¨çå±äº«ç®å½ä¸­æ¥çï¼å¯ä»¥çå°å¤åºæ¥äºä¸ä¸ªç®å½ï¼ç®å½åç§°ä¸ºå½åç©ºé´-pvcåç§°-pvcåç§°\n\n[root@k8s-worker2 share]# pwd\n/root/zwf/share\n[root@k8s-worker2 share]# ls\nzwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c\n\n\n1\n2\n3\n4\n\n\nå®ä¹podï¼æè½½ä¸é¢åå»ºçpvcå°å®¹å¨ç/tmpç®å½ä¸­\n\napiversion: v1\nkind: pod\nmetadata:\n  name: nfs-dyn-pod\n\nspec:\n  volumes:\n  - name: nfs-dyn-10m-vol\n    persistentvolumeclaim:\n      claimname: nfs-dyn-10m-pvc\n\n  containers:\n    - name: nfs-dyn-test\n      image: nginx:alpine\n\n      volumemounts:\n        - name: nfs-dyn-10m-vol\n          mountpath: /tmp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nåå»ºpodæå\n\n[root@k8s-worker1 zwf]# kubectl apply -f pod_strageclass.yaml -n zwf\npod/nfs-dyn-pod created\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname          ready   status    restarts   age\nnfs-dyn-pod   1/1     running   0          10s\n\n\n1\n2\n3\n4\n5\n\n\nè¿å¥å°æè½½äºpvcçpodï¼ç¶åå¨/tmpç®å½ä¸åä¸ä¸ªæä»¶\n\nkubectl exec -it nfs-dyn-pod -n zwf -- /bin/sh\n/ # cd /tmp\n/tmp # echo 111 > 3.txt\n\n\n1\n2\n3\n\n\nåå°nfsæå¡å¨ä¸çå±äº«ç®å½å¯¹åºçpvç®å½ä¸ï¼è½çå°ä¹ååçæä»¶ã\n\n[root@k8s-worker2 zwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c]# pwd\n/root/zwf/share/zwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c\n\n[root@k8s-worker2 zwf-nfs-dyn-10m-pvc-pvc-292cfed3-bec8-4425-aeac-697e3740c76c]# cat 3.txt \n111\n\n\n1\n2\n3\n4\n5\n\n\nå³ç³»å¾å¦ä¸ï¼\n\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"ä½¿ç¨kubeadmå®è£k8s",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],title:"ä½¿ç¨kubeadmå®è£k8s",date:"2022-09-13T20:14:37.000Z",permalink:"/pages/9e17c8/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»å¦ä½ä½¿ç¨kubeadmæ¥æ­å»ºä¸ä¸ªå°åçk8séç¾¤",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"twitter:title",content:"ä½¿ç¨kubeadmå®è£k8s"},{name:"twitter:description",content:"ä»ç»å¦ä½ä½¿ç¨kubeadmæ¥æ­å»ºä¸ä¸ªå°åçk8séç¾¤"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/11.%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85k8s.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä½¿ç¨kubeadmå®è£k8s"},{property:"og:description",content:"ä»ç»å¦ä½ä½¿ç¨kubeadmæ¥æ­å»ºä¸ä¸ªå°åçk8séç¾¤"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/11.%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85k8s.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-09-13T20:14:37.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"ä½¿ç¨kubeadmå®è£k8s"},{itemprop:"description",content:"ä»ç»å¦ä½ä½¿ç¨kubeadmæ¥æ­å»ºä¸ä¸ªå°åçk8séç¾¤"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/11.%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85k8s.html",relativePath:"01.äºåç/07.k8s/11.ä½¿ç¨kubeadmå®è£k8s.md",key:"v-0ee080d4",path:"/pages/9e17c8/",headers:[{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:2},{level:2,title:"å®è£éç½®",slug:"å®è£éç½®",normalizedTitle:"å®è£éç½®",charIndex:44},{level:2,title:"ä¸»èç¹æ§è¡",slug:"ä¸»èç¹æ§è¡",normalizedTitle:"ä¸»èç¹æ§è¡",charIndex:1557},{level:2,title:"å­èç¹å å¥éç¾¤",slug:"å­èç¹å å¥éç¾¤",normalizedTitle:"å­èç¹å å¥éç¾¤",charIndex:2189},{level:2,title:"æµè¯",slug:"æµè¯",normalizedTitle:"æµè¯",charIndex:2648},{level:2,title:"å¸¸è§éè¯¯",slug:"å¸¸è§éè¯¯",normalizedTitle:"å¸¸è§éè¯¯",charIndex:4155}],headersStr:"ç¸å³é¾æ¥ å®è£éç½® ä¸»èç¹æ§è¡ å­èç¹å å¥éç¾¤ æµè¯ å¸¸è§éè¯¯",content:'# ç¸å³é¾æ¥\n\nkubeadmå®è£å®ç½\n\nkubeadmå®è£k8så®æ´æç¨ â\n\n\n# å®è£éç½®\n\nä»¥ä¸æä½æ¯æ¯ä¸ªèç¹é½è¦æ§è¡çæ­¥éª¤\n\n 1. éç½®hosts\n\nå°ä¸»èç¹ä¸å­èç¹åå«éç½®hostnameå¦ä¸ï¼\n\nhostnamectl set-hostname master  # ä¸»èç¹\nhostnamectl set-hostname node1   # å­èç¹\nhostnamectl set-hostname node2   # å­èç¹\n\n\n1\n2\n3\n\n\nå¨/etc/hostsä¸­æ·»å æ¬æºhostnameä¸ipçæ å°å³ç³»\n\n1.1.1.1 master\n1.1.1.2 node1\n1.1.1.3 node2\n\n\n1\n2\n3\n\n 2. å³é­é²ç«å¢\n\néè¦å°ä¸»èç¹ä¸å­èç¹é½å³é­é²ç«å¢\n\nsystemctl stop firewalld\n\n\n1\n\n 3. éç½®yumæº\n\nå¨å®è£kubeadmä¹åï¼é½éè¦éç½®yumæºï¼åå»ºæä»¶/etc/yum.repos.d/kubernetes.repo\n\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=0\n\n\n1\n2\n3\n4\n5\n\n 4. å° SELinux è®¾ç½®ä¸º permissive æ¨¡å¼ï¼ç¸å½äºå°å¶ç¦ç¨ï¼\n\nsudo setenforce 0\nsudo sed -i \'s/^SELINUX=enforcing$/SELINUX=permissive/\' /etc/selinux/config\n\n\n1\n2\n\n 5. å®è£kubeadmãkubeletãkubectl\n\nsudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n\n\n1\n\n 6. å®è£dockerå¹¶å¼å¯\n\ncurl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun\nsystemctl enable --now docker\n\n\n1\n2\n\n 7. å¼å¯kubelet\n\nsudo systemctl enable --now kubelet\n\n\n1\n\n 8. æå¨éç½®containerdçéç½®\n\nèªå¨çæçæä»¶ä¼ä½¿ç¨k8s.gcr.io/pause:3.6éåï¼å½åæ æ³ä¸è½½ï¼å¯¼è´kubeadmåå§åå¤±è´¥ã\n\nçæ containerd çéç½®æä»¶\n\nmkdir -p /etc/containerd\ncontainerd config default > /etc/containerd/config.toml\n\n\n1\n2\n\n\nä¿®æ¹ SystemdCgroup ä¸º true\n\n# ç¼è¾æä»¶\nvi /etc/containerd/config.toml\n\n#æ´æ¹SystemdCgroupå¼ä¸ºtrue\nSystemdCgroup = true\n\n\n1\n2\n3\n4\n5\n\n\nä¿®æ¹ sandbox_image å¼\n\n# æ´æ¹k8s.gcr.io/pause:3.6ä¸ºregistry.aliyuncs.com/google_containers/pause:3.7\nsandbox_image = "registry.aliyuncs.com/google_containers/pause:3.7"\n\n\n1\n2\n\n\néå¯containerd\n\nsystemctl restart containerd\n\n\n1\n\n\n\n# ä¸»èç¹æ§è¡\n\n 1. ä½¿ç¨kubedam initåå§å\n\nkubeadm init --image-repository registry.aliyuncs.com/google_containers --v=5 --pod-network-cidr 10.244.0.0/16\n\n\n1\n\n 2. kubectlè¯»åk8sææè®¤è¯æä»¶\n\nå°å®å¨éç½®æä»¶æ¾å¨æå®ç®å½ä¸­ï¼è¯¥æä»¶æ¶kubectléè¦è¯»åçæææä»¶ï¼æ¾å¨æå®ç®å½ä¸ï¼kubectlæè½è¯»åå°å¹¶è®¿é®å°k8s\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n\n1\n2\n3\n\n\næèæ¾å¨ç¯å¢åéä¸­ï¼kubectlä¼è¯»åè¯¥ç¯å¢åéä¸­çæä»¶\n\nvim /etc/profile\nexport KUBECONFIG=/etc/kubernetes/admin.conf\nsource /etc/profile\n\n\n1\n2\n3\n\n 3. åå»ºç½ç»flannel\n\nkubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n\n\n1\n\n\nâ\n\n\n# å­èç¹å å¥éç¾¤\n\n 1. ä½¿ç¨kubeadm joinå å¥éç¾¤\n\nåå¨ä¸»èç¹ä½¿ç¨kubeadm token create --print-join-commandæ¥è·åå°å­èç¹å å¥ä¸»èç¹çå½ä»¤\n\n[root@master ~]# kubeadm token create --print-join-command\nkubeadm join 172.16.16.16:6443 --token vnu6yz.4zk8f7hdorb8fpl0 --discovery-token-ca-cert-hash sha256:ca4e1e3e2afe16f592c3623f17a6b0dc9cfebd4ec459755e02f4b8db779e21d4\n\n\n1\n2\n\n\nåå¨å­èç¹ä¸æ§è¡è¯¥å½ä»¤ï¼å³å¯å å¥éç¾¤\n\n 2. å°ä¸»èç¹çconfigç§»å¨å°å­èç¹\n\nå­èç¹ä¹éè¦ä¸»èç¹çconfigæä»¶ï¼æè½éè¿kubectlè®¿é®éç¾¤\n\nscp ~/.kube/config node1:~/.kube/config\n\n\n1\n\n\n\n# æµè¯\n\nå¨ä¸»èç¹åå»ºdeployment.yamlæä»¶å¦ä¸\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: demoapp\n  name: demo-deploy\n\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app: demoapp\n\n  template:\n    metadata:\n      labels:\n        app: demoapp\n    spec:\n      containers:\n      - image: ikubernetes/demoapp:v1.0\n        name: demoapp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåå»ºæ§å¶å¨\n\n[root@master ~]# kubectl apply -f deployment.yaml \ndeployment.apps/demo-deploy created\n\n\n1\n2\n\n\nå¯ä»¥çå°åå»ºæåï¼å¹¶ä¸ææçpodå·²ç»READY\n\n[root@master ~]# kubectl get deploy -n zwf\nNAME          READY   UP-TO-DATE   AVAILABLE   AGE\ndemo-deploy   10/10   10           10          3m15s\n\n\n1\n2\n3\n\n\nå¯ä»¥çå°podé½å·²ç»åå»ºæåã\n\n[root@master ~]# kubectl get pods -n zwf \nNAME                           READY   STATUS    RESTARTS   AGE\ndemo-deploy-55c5f88dcb-2nzbf   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-5kwc9   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-8jd9k   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-b7zjp   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-bs7tm   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-jrbzw   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-lsfff   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-mgqpq   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-wfzzb   1/1     Running   0          4m38s\ndemo-deploy-55c5f88dcb-wkbv2   1/1     Running   0          4m38s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# å¸¸è§éè¯¯\n\n * kubeadm init æ¥é âunknown service runtime.v1alpha2.RuntimeServiceâ\n\nè§£å³ï¼\n\nrm /etc/containerd/config.toml -f\nsystemctl restart containerd\n\n\n1\n2\n\n\n * å¦æå¨kubeadm initä¸­åºç°äºå¤±è´¥ï¼å¨è§£å³é®é¢åï¼éè¦æ§è¡kubeadm resetï¼å¦åä¼æ¥é\n\n * Failed to create pod sandbox: rpc error: code = Unknown desc = failed to get sandbox image "k8s.gcr.io/pause:3.6": failed to pull image "k8s.gcr.io/pause:3.6": failed to pull and unpack image "k8s.gcr.io/pause:3.6": failed to resolve reference "k8s.gcr.io/pause:3.6": failed to do request: Head "https://k8s.gcr.io/v2/pause/manifests/3.6": dial tcp 74.125.23.82:443: connect: connection refused\n\næ¯å ä¸ºæä¸å°k8så®æ¹çk8s.gcr.io/pause:3.6éåï¼ä½¿ç¨ä¸»èç¹containeréç½®å¯ä»¥è§£å³ã\n\n * kube-flannelæ¥éï¼\n   \n   running-error-CrashLoopBackOffãnodeâk8s-master-1âpodcidr not assigned\n\nhttps://blog.csdn.net/shm19990131/article/details/107115750/\n\nhttps://blog.csdn.net/anqixiang/article/details/107715591\n\n * plugin type="flannel" failed (add): failed to delegate add: failed to set bridge addr: "cni0" already has an IP address different from\n\nè§£å³åæ³:\n\nsudo ifconfig cni0 down  \nsudo ip link delete cni0\n\n\n1\n2\n\n\nç¸å³èµæï¼\n\nhttps://blog.csdn.net/ibless/article/details/107899009',normalizedContent:'# ç¸å³é¾æ¥\n\nkubeadmå®è£å®ç½\n\nkubeadmå®è£k8så®æ´æç¨ â\n\n\n# å®è£éç½®\n\nä»¥ä¸æä½æ¯æ¯ä¸ªèç¹é½è¦æ§è¡çæ­¥éª¤\n\n 1. éç½®hosts\n\nå°ä¸»èç¹ä¸å­èç¹åå«éç½®hostnameå¦ä¸ï¼\n\nhostnamectl set-hostname master  # ä¸»èç¹\nhostnamectl set-hostname node1   # å­èç¹\nhostnamectl set-hostname node2   # å­èç¹\n\n\n1\n2\n3\n\n\nå¨/etc/hostsä¸­æ·»å æ¬æºhostnameä¸ipçæ å°å³ç³»\n\n1.1.1.1 master\n1.1.1.2 node1\n1.1.1.3 node2\n\n\n1\n2\n3\n\n 2. å³é­é²ç«å¢\n\néè¦å°ä¸»èç¹ä¸å­èç¹é½å³é­é²ç«å¢\n\nsystemctl stop firewalld\n\n\n1\n\n 3. éç½®yumæº\n\nå¨å®è£kubeadmä¹åï¼é½éè¦éç½®yumæºï¼åå»ºæä»¶/etc/yum.repos.d/kubernetes.repo\n\n[kubernetes]\nname=kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=0\n\n\n1\n2\n3\n4\n5\n\n 4. å° selinux è®¾ç½®ä¸º permissive æ¨¡å¼ï¼ç¸å½äºå°å¶ç¦ç¨ï¼\n\nsudo setenforce 0\nsudo sed -i \'s/^selinux=enforcing$/selinux=permissive/\' /etc/selinux/config\n\n\n1\n2\n\n 5. å®è£kubeadmãkubeletãkubectl\n\nsudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n\n\n1\n\n 6. å®è£dockerå¹¶å¼å¯\n\ncurl -fssl https://get.docker.com | bash -s docker --mirror aliyun\nsystemctl enable --now docker\n\n\n1\n2\n\n 7. å¼å¯kubelet\n\nsudo systemctl enable --now kubelet\n\n\n1\n\n 8. æå¨éç½®containerdçéç½®\n\nèªå¨çæçæä»¶ä¼ä½¿ç¨k8s.gcr.io/pause:3.6éåï¼å½åæ æ³ä¸è½½ï¼å¯¼è´kubeadmåå§åå¤±è´¥ã\n\nçæ containerd çéç½®æä»¶\n\nmkdir -p /etc/containerd\ncontainerd config default > /etc/containerd/config.toml\n\n\n1\n2\n\n\nä¿®æ¹ systemdcgroup ä¸º true\n\n# ç¼è¾æä»¶\nvi /etc/containerd/config.toml\n\n#æ´æ¹systemdcgroupå¼ä¸ºtrue\nsystemdcgroup = true\n\n\n1\n2\n3\n4\n5\n\n\nä¿®æ¹ sandbox_image å¼\n\n# æ´æ¹k8s.gcr.io/pause:3.6ä¸ºregistry.aliyuncs.com/google_containers/pause:3.7\nsandbox_image = "registry.aliyuncs.com/google_containers/pause:3.7"\n\n\n1\n2\n\n\néå¯containerd\n\nsystemctl restart containerd\n\n\n1\n\n\n\n# ä¸»èç¹æ§è¡\n\n 1. ä½¿ç¨kubedam initåå§å\n\nkubeadm init --image-repository registry.aliyuncs.com/google_containers --v=5 --pod-network-cidr 10.244.0.0/16\n\n\n1\n\n 2. kubectlè¯»åk8sææè®¤è¯æä»¶\n\nå°å®å¨éç½®æä»¶æ¾å¨æå®ç®å½ä¸­ï¼è¯¥æä»¶æ¶kubectléè¦è¯»åçæææä»¶ï¼æ¾å¨æå®ç®å½ä¸ï¼kubectlæè½è¯»åå°å¹¶è®¿é®å°k8s\n\n  mkdir -p $home/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $home/.kube/config\n  sudo chown $(id -u):$(id -g) $home/.kube/config\n\n\n1\n2\n3\n\n\næèæ¾å¨ç¯å¢åéä¸­ï¼kubectlä¼è¯»åè¯¥ç¯å¢åéä¸­çæä»¶\n\nvim /etc/profile\nexport kubeconfig=/etc/kubernetes/admin.conf\nsource /etc/profile\n\n\n1\n2\n3\n\n 3. åå»ºç½ç»flannel\n\nkubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/documentation/kube-flannel.yml\n\n\n1\n\n\nâ\n\n\n# å­èç¹å å¥éç¾¤\n\n 1. ä½¿ç¨kubeadm joinå å¥éç¾¤\n\nåå¨ä¸»èç¹ä½¿ç¨kubeadm token create --print-join-commandæ¥è·åå°å­èç¹å å¥ä¸»èç¹çå½ä»¤\n\n[root@master ~]# kubeadm token create --print-join-command\nkubeadm join 172.16.16.16:6443 --token vnu6yz.4zk8f7hdorb8fpl0 --discovery-token-ca-cert-hash sha256:ca4e1e3e2afe16f592c3623f17a6b0dc9cfebd4ec459755e02f4b8db779e21d4\n\n\n1\n2\n\n\nåå¨å­èç¹ä¸æ§è¡è¯¥å½ä»¤ï¼å³å¯å å¥éç¾¤\n\n 2. å°ä¸»èç¹çconfigç§»å¨å°å­èç¹\n\nå­èç¹ä¹éè¦ä¸»èç¹çconfigæä»¶ï¼æè½éè¿kubectlè®¿é®éç¾¤\n\nscp ~/.kube/config node1:~/.kube/config\n\n\n1\n\n\n\n# æµè¯\n\nå¨ä¸»èç¹åå»ºdeployment.yamlæä»¶å¦ä¸\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  labels:\n    app: demoapp\n  name: demo-deploy\n\nspec:\n  replicas: 10\n  selector:\n    matchlabels:\n      app: demoapp\n\n  template:\n    metadata:\n      labels:\n        app: demoapp\n    spec:\n      containers:\n      - image: ikubernetes/demoapp:v1.0\n        name: demoapp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåå»ºæ§å¶å¨\n\n[root@master ~]# kubectl apply -f deployment.yaml \ndeployment.apps/demo-deploy created\n\n\n1\n2\n\n\nå¯ä»¥çå°åå»ºæåï¼å¹¶ä¸ææçpodå·²ç»ready\n\n[root@master ~]# kubectl get deploy -n zwf\nname          ready   up-to-date   available   age\ndemo-deploy   10/10   10           10          3m15s\n\n\n1\n2\n3\n\n\nå¯ä»¥çå°podé½å·²ç»åå»ºæåã\n\n[root@master ~]# kubectl get pods -n zwf \nname                           ready   status    restarts   age\ndemo-deploy-55c5f88dcb-2nzbf   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-5kwc9   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-8jd9k   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-b7zjp   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-bs7tm   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-jrbzw   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-lsfff   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-mgqpq   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-wfzzb   1/1     running   0          4m38s\ndemo-deploy-55c5f88dcb-wkbv2   1/1     running   0          4m38s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# å¸¸è§éè¯¯\n\n * kubeadm init æ¥é âunknown service runtime.v1alpha2.runtimeserviceâ\n\nè§£å³ï¼\n\nrm /etc/containerd/config.toml -f\nsystemctl restart containerd\n\n\n1\n2\n\n\n * å¦æå¨kubeadm initä¸­åºç°äºå¤±è´¥ï¼å¨è§£å³é®é¢åï¼éè¦æ§è¡kubeadm resetï¼å¦åä¼æ¥é\n\n * failed to create pod sandbox: rpc error: code = unknown desc = failed to get sandbox image "k8s.gcr.io/pause:3.6": failed to pull image "k8s.gcr.io/pause:3.6": failed to pull and unpack image "k8s.gcr.io/pause:3.6": failed to resolve reference "k8s.gcr.io/pause:3.6": failed to do request: head "https://k8s.gcr.io/v2/pause/manifests/3.6": dial tcp 74.125.23.82:443: connect: connection refused\n\næ¯å ä¸ºæä¸å°k8så®æ¹çk8s.gcr.io/pause:3.6éåï¼ä½¿ç¨ä¸»èç¹containeréç½®å¯ä»¥è§£å³ã\n\n * kube-flannelæ¥éï¼\n   \n   running-error-crashloopbackoffãnodeâk8s-master-1âpodcidr not assigned\n\nhttps://blog.csdn.net/shm19990131/article/details/107115750/\n\nhttps://blog.csdn.net/anqixiang/article/details/107715591\n\n * plugin type="flannel" failed (add): failed to delegate add: failed to set bridge addr: "cni0" already has an ip address different from\n\nè§£å³åæ³:\n\nsudo ifconfig cni0 down  \nsudo ip link delete cni0\n\n\n1\n2\n\n\nç¸å³èµæï¼\n\nhttps://blog.csdn.net/ibless/article/details/107899009',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"k8sä¹StatefulSet",frontmatter:{tags:["k8s","å®¹å¨","äºåç"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},title:"k8sä¹StatefulSet",date:"2022-08-31T14:55:02.000Z",permalink:"/pages/d178a2/",description:"ä»ç»k8sä¸­çstatefulsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾",feed:{enable:!0},categories:["äºåç","k8s"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831173844.png"},{name:"twitter:title",content:"k8sä¹StatefulSet"},{name:"twitter:description",content:"ä»ç»k8sä¸­çstatefulsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831173844.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/10.k8s%E4%B9%8BStatefulSet.html"},{property:"og:type",content:"article"},{property:"og:title",content:"k8sä¹StatefulSet"},{property:"og:description",content:"ä»ç»k8sä¸­çstatefulsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831173844.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/10.k8s%E4%B9%8BStatefulSet.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-31T14:55:02.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"k8sä¹StatefulSet"},{itemprop:"description",content:"ä»ç»k8sä¸­çstatefulsetèµæºå¯¹è±¡ï¼åå¶ä½¿ç¨æ¹æ³åæ¡ä¾"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220831173844.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/10.k8s%E4%B9%8BStatefulSet.html",relativePath:"01.äºåç/07.k8s/10.k8sä¹StatefulSet.md",key:"v-9fc226e2",path:"/pages/d178a2/",headers:[{level:2,title:"ä»ä¹æ¯StatefulSet?",slug:"ä»ä¹æ¯statefulset",normalizedTitle:"ä»ä¹æ¯statefulset?",charIndex:2},{level:2,title:"ä½¿ç¨StatefulSet",slug:"ä½¿ç¨statefulset",normalizedTitle:"ä½¿ç¨statefulset",charIndex:227},{level:3,title:"åå»ºStatefulSet",slug:"åå»ºstatefulset",normalizedTitle:"åå»ºstatefulset",charIndex:245},{level:3,title:"Serviceéç½®",slug:"serviceéç½®",normalizedTitle:"serviceéç½®",charIndex:1436},{level:3,title:"æä¹åéç½®",slug:"æä¹åéç½®",normalizedTitle:"æä¹åéç½®",charIndex:4150}],headersStr:"ä»ä¹æ¯StatefulSet? ä½¿ç¨StatefulSet åå»ºStatefulSet Serviceéç½® æä¹åéç½®",content:'# ä»ä¹æ¯StatefulSet?\n\næ¯ç¨æ¥åå»ºæç¶æåºç¨ï¼å¯ä»¥éè¿è¿æç§æ¹å¼è®°å½è¿äºç¶æï¼ç¶åå¨ Pod è¢«éæ°åå»ºæ¶ï¼è½å¤ä¸ºæ° Pod æ¢å¤è¿äºç¶æã\n\nä»ä¹æ¯æç¶æåºç¨ï¼\n\né¦åæ¯éè¦ææ°æ®çæä¹åï¼å³ä½¿Podè¢«éå¯åï¼ä¹è½æ¢å¤ï¼ä¸éå¯åä¿æä¸è´ãç¶åæ¯åºç¨åå»ºçææpodæä¾èµå³ç³»ï¼é¡ºåºçåå»ºãéè¦è¿è¡å¨æå®çå®¿ä¸»æºä¸ï¼å¹¶ä¸é½æå¯¹åºçç½ç»æ å¿ã\n\nåºç¨åºæ¯ï¼\n\nåå¸å¼åºç¨ï¼å®çå¤ä¸ªå®ä¾ä¹é´ï¼å¾å¾æä¾èµå³ç³»ï¼æ¯å¦ï¼ä¸»ä»å³ç³»ãä¸»å¤å³ç³»ã\n\n\n# ä½¿ç¨StatefulSet\n\n\n# åå»ºStatefulSet\n\nåå»ºyamlæä»¶å®ä¹StatefulSetå¯¹è±¡å¦ä¸ï¼ä¸Deploymentæ¯è¾ï¼å¤äºä¸ä¸ªserviceNameå­æ®µï¼è¿ä¸ªæ¯ç¨æ¥æå®StatefulSetæç®¡ççpodæ¯ç¨ååè®¿é®æ¯éè¿è¯¥serviceæè®¾å®çã\n\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: redis-sts\n\nspec:\n  serviceName: redis-svc\n  replicas: 2\n  selector:\n    matchLabels:\n      app: redis-sts\n\n  template:\n    metadata:\n      labels:\n        app: redis-sts\n    spec:\n      containers:\n      - image: redis\n        name: redis\n        ports:\n        - containerPort: 6379\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåå»ºStatefulSetå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f statefulset.yaml  -n zwf\nstatefulset.apps/redis-sts created\n\n[root@k8s-worker1 zwf]# kubectl get sts -n zwf\nNAME        READY   AGE\nredis-sts   2/2     54s\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥çåå»ºçPodä¼åç°ï¼å½åä¸åæ¯éæºåå»ºçåå­ï¼èæ¯æäºé¡ºåºå·ï¼ä»0å¼å§ï¼èk8sä¹ä¼æç§è¿ä¸ªé¡ºåºä¸æ¬¡åå»ºã\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME          READY   STATUS    RESTARTS   AGE\nredis-sts-0   1/1     Running   0          61s\nredis-sts-1   1/1     Running   0          54s\n\n\n1\n2\n3\n4\n\n\nè¾åºpodä¸­çhostnameåç°ä¸podçåç§°ä¹ä¿æä¸è´ï¼ä¹å°±æ¯åºç¨å¯ä»¥èªè¡å³å®ä¾èµå³ç³»ï¼æ¯å¦è¯¥ä¾å­ä¸­å¯ä»¥ä½¿ç¨0å·podä½ä¸ºä¸»å®ä¾ï¼è1å·podä½ä¸ºä»å®ä¾ã\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-sts-0 -n zwf -- hostname\nredis-sts-0\n\n\n1\n2\n\n\n\n# Serviceéç½®\n\nå®ä¹å¹éä¸é¢çåå»ºStatefulSetå¯¹è±¡ææç®¡ççServiceï¼ä¹å°±æ¯æ ç­¾ç­ééè¦åpodçæ ç­¾ä¿æä¸è´ï¼å¹¶ä¸è¿éçmetadata.nameä¹è¦ä¸StatefulSetä¸­çserviceNameä¸æ ·ã\n\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-svc\n\nspec:\n  selector:\n    app: redis-sts\n\n  ports:\n  - port: 6379\n    protocol: TCP\n    targetPort: 6379\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåå»ºServiceå¯¹è±¡ï¼æä»¬å¯ä»¥çå°å·²ç»å°StatefulSetæåå»ºçpodå å¥å°ç«¯ç¹åè¡¨äºï¼ä¹å°±æ¯å¯ä»¥ç¨³å®çéè¿Serviceæ¥è®¿é®å°Pod\n\n[root@k8s-worker1 zwf]# kubectl apply -f service_statefulset.yaml -n zwf\nkservice/redis-svc created\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf\nNAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE\nredis-svc              ClusterIP   10.0.0.246   <none>        6379/TCP       5s\n\n[root@k8s-worker1 zwf]# kubectl describe svc redis-svc -n zwf\nName:              redis-svc\nNamespace:         zwf\nLabels:            <none>\nAnnotations:       <none>\nSelector:          app=redis-sts\nType:              ClusterIP\nIP Family Policy:  SingleStack\nIP Families:       IPv4\nIP:                10.0.0.246\nIPs:               10.0.0.246\nPort:              <unset>  6379/TCP\nTargetPort:        6379/TCP\nEndpoints:         10.222.126.51:6379,10.222.194.84:6379\nSession Affinity:  None\nEvents:            <none>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nä½æ¯æä»¬çPodä¸æ¯ä¸è¬ççåºç¨ï¼æ¯æç¶æçåºç¨ï¼éè¦æç¨³å®çç½ç»æ è¯ï¼æä»¥ä¼ä¸ºæ¯ä¸ä¸ªPodä¹åå»ºä¸ä¸ªååï¼æ ¼å¼æ¯ï¼<podName>.<serviceName>.<namesapce>.svc.cluster.localã\n\næä»¬è¿å¥podä¸­éªè¯ä¸ä¸ï¼éè¿ping redis-sts-1.redis-svc.zwf.svc.cluster.localåç°æ¯å¯ä»¥pingéçï¼è½ç¶PodçIPä¼ååï¼ä½æ¯éè¿åºå®çååå°±è½è®¿é®å°æå®Podäºã\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-sts-0 -n zwf -- ping redis-sts-1.redis-svc.zwf.svc.cluster.local\nPING redis-sts-1.redis-svc.zwf.svc.cluster.local (10.222.126.51) 56(84) bytes of data.\n64 bytes from redis-sts-1.redis-svc.zwf.svc.cluster.local (10.222.126.51): icmp_seq=1 ttl=62 time=0.964 ms\n64 bytes from redis-sts-1.redis-svc.zwf.svc.cluster.local (10.222.126.51): icmp_seq=2 ttl=62 time=0.932 ms\n\n\n1\n2\n3\n4\n\n\næ¢ç¶æä»¬çpodæäºç¨³å®çç½ç»æ è¯ï¼Serviceä¹å°±ä¸éè¦ååéClusterIPäºï¼è¿ä¸ªæ¶åï¼åªéè¦æ·»å å­æ®µclusterIP: Noneï¼è¿æ ·å°±ä¸ä¼ååéIPäºï¼è¿æ ·çServiceç§°ä¸ºHeadless Service\n\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-svc\n\nspec:\n  clusterIP: None\n  selector:\n    app: redis-sts\n\n  ports:\n  - port: 6379\n    protocol: TCP\n    targetPort: 6379\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nåå»ºHeadless Serviceï¼å¯ä»¥çå°CLUSTER-IPä¸ºNone\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf\nNAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE\ndemoapp-nodeport-svc   NodePort    10.0.0.144   <none>        80:31999/TCP   21h\ndemoapp-svc            ClusterIP   10.0.0.74    <none>        80/TCP         22h\nredis-svc              ClusterIP   None         <none>        6379/TCP       4s\n\n\n1\n2\n3\n4\n5\n\n\nServiceåStatefulSetéç½®å¾å¦ä¸ï¼\n\n\n\n\n# æä¹åéç½®\n\næ¥ä¸æ¥æ¯ç»StatefulSetå¯¹è±¡æ·»å æä¹åéç½®ã\n\nå®ä¹StatefulSetæè¿°å¦ä¸ï¼\n\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: redis-pv-sts\n\nspec:\n  serviceName: redis-pv-svc\n\n  volumeClaimTemplates:\n  - metadata:\n      name: redis-100m-pvc\n    spec:\n      storageClassName: nfs-client\n      accessModes:\n        - ReadWriteMany\n      resources:\n        requests:\n          storage: 100Mi\n\n  replicas: 2\n  selector:\n    matchLabels:\n      app: redis-pv-sts\n\n  template:\n    metadata:\n      labels:\n        app: redis-pv-sts\n    spec:\n      containers:\n      - image: redis:5-alpine\n        name: redis\n\n        volumeMounts:\n        - name: redis-100m-pvc\n          mountPath: /data\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n\n\nåæ°ï¼\n\n * volumeClaimTemplatesï¼ç¨æ¥å°PVCçå®ä¹åµå¥å°StatefulSetä¸­çå­æ®µï¼æ¯åå»ºPVCçæ¨¡æ¿ï¼å¯ä»¥è®©æ¯ä¸ä¸ªPodé½è½èªå¨åå»ºPVC\n * voulumeMountsï¼æ¯ç¨æ¥éæ©ä¸é¢çPVCæè½½å¨å®¹å¨ç/dataç®å½ä¸­\n\nåå»ºStatefulSetå¯¹è±¡ï¼å¯ä»¥çå°podå·²ç»åå»ºèµ·æ¥äºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f statefulset_pvc.yaml -n zwf\nstatefulset.apps/redis-pv-sts created\n\n[root@k8s-worker1 zwf]# kubectl get sts -n zwf\nNAME           READY   AGE\nredis-pv-sts   2/2     25\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nNAME             READY   STATUS    RESTARTS   AGE\nredis-pv-sts-0   1/1     Running   0          63s\nredis-pv-sts-1   1/1     Running   0          54s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\næä»¬æ¥çpvcï¼ä¼åç°åå»ºäº2ä¸ªå¯¹è±¡ ï¼ä»¥PVCåç§°-podåç§°å½åã\n\n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nNAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nredis-100m-pvc-redis-pv-sts-0   Bound    pvc-2712daa4-36b4-4a63-ac2f-7d3b31e2a887   100Mi      RWX            nfs-client     109s\nredis-100m-pvc-redis-pv-sts-1   Bound    pvc-a3781354-e182-42f7-b6f6-983999603653   100Mi      RWX            nfs-client     100s\n\n\n1\n2\n3\n4\n\n\nè¿å¥å°podä¸­ï¼ä½¿ç¨redis-cliè¿è¡rediså®¢æ·ç«¯ï¼æ·»å ä¸äºæ°æ®\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-pv-sts-0 -n zwf /bin/bash\n[ root@redis-pv-sts-0:/data ]$ redis-cli  \n127.0.0.1:6379> set name zhangsan\nOK\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> keys *\n1) "name"\n2) "age"\n127.0.0.1:6379> quit\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå°podå é¤ï¼ç¶ååéæ°è¿å¥Podä¸­ï¼æ¥è¯¢ä¹ååå»ºçredisçkeyï¼è¿æ¯è½å¤æ¥è¯¢å°ã\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-pv-sts-0  -n zwf -- /bin/bash\n[ root@redis-pv-sts-0:/data ]$ redis-cli  \n127.0.0.1:6379> keys *\n1) "name"\n2) "age"\n127.0.0.1:6379> get name\n"zhangsan"\n127.0.0.1:6379> get age\n"18"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\néç½®çå³ç³»å¾å¦ä¸ï¼\n\n',normalizedContent:'# ä»ä¹æ¯statefulset?\n\næ¯ç¨æ¥åå»ºæç¶æåºç¨ï¼å¯ä»¥éè¿è¿æç§æ¹å¼è®°å½è¿äºç¶æï¼ç¶åå¨ pod è¢«éæ°åå»ºæ¶ï¼è½å¤ä¸ºæ° pod æ¢å¤è¿äºç¶æã\n\nä»ä¹æ¯æç¶æåºç¨ï¼\n\né¦åæ¯éè¦ææ°æ®çæä¹åï¼å³ä½¿podè¢«éå¯åï¼ä¹è½æ¢å¤ï¼ä¸éå¯åä¿æä¸è´ãç¶åæ¯åºç¨åå»ºçææpodæä¾èµå³ç³»ï¼é¡ºåºçåå»ºãéè¦è¿è¡å¨æå®çå®¿ä¸»æºä¸ï¼å¹¶ä¸é½æå¯¹åºçç½ç»æ å¿ã\n\nåºç¨åºæ¯ï¼\n\nåå¸å¼åºç¨ï¼å®çå¤ä¸ªå®ä¾ä¹é´ï¼å¾å¾æä¾èµå³ç³»ï¼æ¯å¦ï¼ä¸»ä»å³ç³»ãä¸»å¤å³ç³»ã\n\n\n# ä½¿ç¨statefulset\n\n\n# åå»ºstatefulset\n\nåå»ºyamlæä»¶å®ä¹statefulsetå¯¹è±¡å¦ä¸ï¼ä¸deploymentæ¯è¾ï¼å¤äºä¸ä¸ªservicenameå­æ®µï¼è¿ä¸ªæ¯ç¨æ¥æå®statefulsetæç®¡ççpodæ¯ç¨ååè®¿é®æ¯éè¿è¯¥serviceæè®¾å®çã\n\n\napiversion: apps/v1\nkind: statefulset\nmetadata:\n  name: redis-sts\n\nspec:\n  servicename: redis-svc\n  replicas: 2\n  selector:\n    matchlabels:\n      app: redis-sts\n\n  template:\n    metadata:\n      labels:\n        app: redis-sts\n    spec:\n      containers:\n      - image: redis\n        name: redis\n        ports:\n        - containerport: 6379\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåå»ºstatefulsetå¯¹è±¡\n\n[root@k8s-worker1 zwf]# kubectl apply -f statefulset.yaml  -n zwf\nstatefulset.apps/redis-sts created\n\n[root@k8s-worker1 zwf]# kubectl get sts -n zwf\nname        ready   age\nredis-sts   2/2     54s\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥çåå»ºçpodä¼åç°ï¼å½åä¸åæ¯éæºåå»ºçåå­ï¼èæ¯æäºé¡ºåºå·ï¼ä»0å¼å§ï¼èk8sä¹ä¼æç§è¿ä¸ªé¡ºåºä¸æ¬¡åå»ºã\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname          ready   status    restarts   age\nredis-sts-0   1/1     running   0          61s\nredis-sts-1   1/1     running   0          54s\n\n\n1\n2\n3\n4\n\n\nè¾åºpodä¸­çhostnameåç°ä¸podçåç§°ä¹ä¿æä¸è´ï¼ä¹å°±æ¯åºç¨å¯ä»¥èªè¡å³å®ä¾èµå³ç³»ï¼æ¯å¦è¯¥ä¾å­ä¸­å¯ä»¥ä½¿ç¨0å·podä½ä¸ºä¸»å®ä¾ï¼è1å·podä½ä¸ºä»å®ä¾ã\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-sts-0 -n zwf -- hostname\nredis-sts-0\n\n\n1\n2\n\n\n\n# serviceéç½®\n\nå®ä¹å¹éä¸é¢çåå»ºstatefulsetå¯¹è±¡ææç®¡ççserviceï¼ä¹å°±æ¯æ ç­¾ç­ééè¦åpodçæ ç­¾ä¿æä¸è´ï¼å¹¶ä¸è¿éçmetadata.nameä¹è¦ä¸statefulsetä¸­çservicenameä¸æ ·ã\n\n\napiversion: v1\nkind: service\nmetadata:\n  name: redis-svc\n\nspec:\n  selector:\n    app: redis-sts\n\n  ports:\n  - port: 6379\n    protocol: tcp\n    targetport: 6379\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåå»ºserviceå¯¹è±¡ï¼æä»¬å¯ä»¥çå°å·²ç»å°statefulsetæåå»ºçpodå å¥å°ç«¯ç¹åè¡¨äºï¼ä¹å°±æ¯å¯ä»¥ç¨³å®çéè¿serviceæ¥è®¿é®å°pod\n\n[root@k8s-worker1 zwf]# kubectl apply -f service_statefulset.yaml -n zwf\nkservice/redis-svc created\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf\nname                   type        cluster-ip   external-ip   port(s)        age\nredis-svc              clusterip   10.0.0.246   <none>        6379/tcp       5s\n\n[root@k8s-worker1 zwf]# kubectl describe svc redis-svc -n zwf\nname:              redis-svc\nnamespace:         zwf\nlabels:            <none>\nannotations:       <none>\nselector:          app=redis-sts\ntype:              clusterip\nip family policy:  singlestack\nip families:       ipv4\nip:                10.0.0.246\nips:               10.0.0.246\nport:              <unset>  6379/tcp\ntargetport:        6379/tcp\nendpoints:         10.222.126.51:6379,10.222.194.84:6379\nsession affinity:  none\nevents:            <none>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nä½æ¯æä»¬çpodä¸æ¯ä¸è¬ççåºç¨ï¼æ¯æç¶æçåºç¨ï¼éè¦æç¨³å®çç½ç»æ è¯ï¼æä»¥ä¼ä¸ºæ¯ä¸ä¸ªpodä¹åå»ºä¸ä¸ªååï¼æ ¼å¼æ¯ï¼<podname>.<servicename>.<namesapce>.svc.cluster.localã\n\næä»¬è¿å¥podä¸­éªè¯ä¸ä¸ï¼éè¿ping redis-sts-1.redis-svc.zwf.svc.cluster.localåç°æ¯å¯ä»¥pingéçï¼è½ç¶podçipä¼ååï¼ä½æ¯éè¿åºå®çååå°±è½è®¿é®å°æå®podäºã\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-sts-0 -n zwf -- ping redis-sts-1.redis-svc.zwf.svc.cluster.local\nping redis-sts-1.redis-svc.zwf.svc.cluster.local (10.222.126.51) 56(84) bytes of data.\n64 bytes from redis-sts-1.redis-svc.zwf.svc.cluster.local (10.222.126.51): icmp_seq=1 ttl=62 time=0.964 ms\n64 bytes from redis-sts-1.redis-svc.zwf.svc.cluster.local (10.222.126.51): icmp_seq=2 ttl=62 time=0.932 ms\n\n\n1\n2\n3\n4\n\n\næ¢ç¶æä»¬çpodæäºç¨³å®çç½ç»æ è¯ï¼serviceä¹å°±ä¸éè¦ååéclusteripäºï¼è¿ä¸ªæ¶åï¼åªéè¦æ·»å å­æ®µclusterip: noneï¼è¿æ ·å°±ä¸ä¼ååéipäºï¼è¿æ ·çserviceç§°ä¸ºheadless service\n\n\napiversion: v1\nkind: service\nmetadata:\n  name: redis-svc\n\nspec:\n  clusterip: none\n  selector:\n    app: redis-sts\n\n  ports:\n  - port: 6379\n    protocol: tcp\n    targetport: 6379\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nåå»ºheadless serviceï¼å¯ä»¥çå°cluster-ipä¸ºnone\n\n[root@k8s-worker1 zwf]# kubectl get svc -n zwf\nname                   type        cluster-ip   external-ip   port(s)        age\ndemoapp-nodeport-svc   nodeport    10.0.0.144   <none>        80:31999/tcp   21h\ndemoapp-svc            clusterip   10.0.0.74    <none>        80/tcp         22h\nredis-svc              clusterip   none         <none>        6379/tcp       4s\n\n\n1\n2\n3\n4\n5\n\n\nserviceåstatefulsetéç½®å¾å¦ä¸ï¼\n\n\n\n\n# æä¹åéç½®\n\næ¥ä¸æ¥æ¯ç»statefulsetå¯¹è±¡æ·»å æä¹åéç½®ã\n\nå®ä¹statefulsetæè¿°å¦ä¸ï¼\n\n\napiversion: apps/v1\nkind: statefulset\nmetadata:\n  name: redis-pv-sts\n\nspec:\n  servicename: redis-pv-svc\n\n  volumeclaimtemplates:\n  - metadata:\n      name: redis-100m-pvc\n    spec:\n      storageclassname: nfs-client\n      accessmodes:\n        - readwritemany\n      resources:\n        requests:\n          storage: 100mi\n\n  replicas: 2\n  selector:\n    matchlabels:\n      app: redis-pv-sts\n\n  template:\n    metadata:\n      labels:\n        app: redis-pv-sts\n    spec:\n      containers:\n      - image: redis:5-alpine\n        name: redis\n\n        volumemounts:\n        - name: redis-100m-pvc\n          mountpath: /data\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n\n\nåæ°ï¼\n\n * volumeclaimtemplatesï¼ç¨æ¥å°pvcçå®ä¹åµå¥å°statefulsetä¸­çå­æ®µï¼æ¯åå»ºpvcçæ¨¡æ¿ï¼å¯ä»¥è®©æ¯ä¸ä¸ªpodé½è½èªå¨åå»ºpvc\n * voulumemountsï¼æ¯ç¨æ¥éæ©ä¸é¢çpvcæè½½å¨å®¹å¨ç/dataç®å½ä¸­\n\nåå»ºstatefulsetå¯¹è±¡ï¼å¯ä»¥çå°podå·²ç»åå»ºèµ·æ¥äºã\n\n[root@k8s-worker1 zwf]# kubectl apply -f statefulset_pvc.yaml -n zwf\nstatefulset.apps/redis-pv-sts created\n\n[root@k8s-worker1 zwf]# kubectl get sts -n zwf\nname           ready   age\nredis-pv-sts   2/2     25\n\n[root@k8s-worker1 zwf]# kubectl get pods -n zwf\nname             ready   status    restarts   age\nredis-pv-sts-0   1/1     running   0          63s\nredis-pv-sts-1   1/1     running   0          54s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\næä»¬æ¥çpvcï¼ä¼åç°åå»ºäº2ä¸ªå¯¹è±¡ ï¼ä»¥pvcåç§°-podåç§°å½åã\n\n[root@k8s-worker1 zwf]# kubectl get pvc -n zwf\nname                            status   volume                                     capacity   access modes   storageclass   age\nredis-100m-pvc-redis-pv-sts-0   bound    pvc-2712daa4-36b4-4a63-ac2f-7d3b31e2a887   100mi      rwx            nfs-client     109s\nredis-100m-pvc-redis-pv-sts-1   bound    pvc-a3781354-e182-42f7-b6f6-983999603653   100mi      rwx            nfs-client     100s\n\n\n1\n2\n3\n4\n\n\nè¿å¥å°podä¸­ï¼ä½¿ç¨redis-cliè¿è¡rediså®¢æ·ç«¯ï¼æ·»å ä¸äºæ°æ®\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-pv-sts-0 -n zwf /bin/bash\n[ root@redis-pv-sts-0:/data ]$ redis-cli  \n127.0.0.1:6379> set name zhangsan\nok\n127.0.0.1:6379> set age 18\nok\n127.0.0.1:6379> keys *\n1) "name"\n2) "age"\n127.0.0.1:6379> quit\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå°podå é¤ï¼ç¶ååéæ°è¿å¥podä¸­ï¼æ¥è¯¢ä¹ååå»ºçredisçkeyï¼è¿æ¯è½å¤æ¥è¯¢å°ã\n\n[root@k8s-worker1 zwf]# kubectl exec -it redis-pv-sts-0  -n zwf -- /bin/bash\n[ root@redis-pv-sts-0:/data ]$ redis-cli  \n127.0.0.1:6379> keys *\n1) "name"\n2) "age"\n127.0.0.1:6379> get name\n"zhangsan"\n127.0.0.1:6379> get age\n"18"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\néç½®çå³ç³»å¾å¦ä¸ï¼\n\n',charsets:{cjk:!0},lastUpdated:"2023/01/15, 20:17:10",lastUpdatedTimestamp:167378503e4},{title:"djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§",frontmatter:{title:"djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§",date:"2023-02-21T11:05:03.000Z",permalink:"/pages/b1b4a3/",categories:["äºåç","k8s"],tags:[null],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"éè¿ææ çæ§å¯ä»¥è®¾ç½®å¯¹åºçåè­¦ï¼å¿«éåç°é®é¢ï¼å¹¶éè¿ç¸åºçææ å®ä½é®é¢ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230221110733.png"},{name:"twitter:title",content:"djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§"},{name:"twitter:description",content:"éè¿ææ çæ§å¯ä»¥è®¾ç½®å¯¹åºçåè­¦ï¼å¿«éåç°é®é¢ï¼å¹¶éè¿ç¸åºçææ å®ä½é®é¢ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230221110733.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/13.django%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E3%80%81logstash%E5%92%8Cflink%E6%8E%A5%E5%85%A5VictoriaMetrics%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7.html"},{property:"og:type",content:"article"},{property:"og:title",content:"djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§"},{property:"og:description",content:"éè¿ææ çæ§å¯ä»¥è®¾ç½®å¯¹åºçåè­¦ï¼å¿«éåç°é®é¢ï¼å¹¶éè¿ç¸åºçææ å®ä½é®é¢ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230221110733.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/13.django%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E3%80%81logstash%E5%92%8Cflink%E6%8E%A5%E5%85%A5VictoriaMetrics%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-02-21T11:05:03.000Z"},{property:"article:tag",content:null},{itemprop:"name",content:"djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§"},{itemprop:"description",content:"éè¿ææ çæ§å¯ä»¥è®¾ç½®å¯¹åºçåè­¦ï¼å¿«éåç°é®é¢ï¼å¹¶éè¿ç¸åºçææ å®ä½é®é¢ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230221110733.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/13.django%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E3%80%81logstash%E5%92%8Cflink%E6%8E%A5%E5%85%A5VictoriaMetrics%E6%8C%87%E6%A0%87%E7%9B%91%E6%8E%A7.html",relativePath:"01.äºåç/07.k8s/13.djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§.md",key:"v-c31c1604",path:"/pages/b1b4a3/",headers:[{level:2,title:"0.ç®ä»",slug:"_0-ç®ä»",normalizedTitle:"0.ç®ä»",charIndex:2},{level:2,title:"1.VictoriaMetrics",slug:"_1-victoriametrics",normalizedTitle:"1.victoriametrics",charIndex:172},{level:2,title:"2.django æå¡æ¥å¥",slug:"_2-django-æå¡æ¥å¥",normalizedTitle:"2.django æå¡æ¥å¥",charIndex:376},{level:2,title:"3.logstash æ¥å¥",slug:"_3-logstash-æ¥å¥",normalizedTitle:"3.logstash æ¥å¥",charIndex:799},{level:2,title:"4.flink æ¥å¥çæ§",slug:"_4-flink-æ¥å¥çæ§",normalizedTitle:"4.flink æ¥å¥çæ§",charIndex:1515},{level:2,title:"5.VMPodScrape",slug:"_5-vmpodscrape",normalizedTitle:"5.vmpodscrape",charIndex:1844}],headersStr:"0.ç®ä» 1.VictoriaMetrics 2.django æå¡æ¥å¥ 3.logstash æ¥å¥ 4.flink æ¥å¥çæ§ 5.VMPodScrape",content:'# 0.ç®ä»\n\néè¿ææ çæ§å¯ä»¥è®¾ç½®å¯¹åºçåè­¦ï¼å¿«éåç°é®é¢ï¼å¹¶éè¿ç¸åºçææ å®ä½é®é¢ã\n\nèæ¯ï¼ä½¿ç¨ç VictoriaMetrics(ç®ç§° VM) ä½ä¸ºçæ§çè§£å³æ¹æ¡ï¼éè¦å° django æå¡ãlogstash å flink å¼ææ¥å¥è¿æ¥ï¼VM å¯ä»¥å®æ¶çè·åå®ä»¬çææ å­å¨å¹¶è¿è¡çæ§åè­¦ï¼ä»¥ä¸çæå¡é½æ¯é¨ç½²å¨ k8s ä¸­çã\n\n\n# 1.VictoriaMetrics\n\nVictoriaMetricsï¼æ¯ä¸ä¸ªå¿«éé«æãç»æµå¹¶ä¸å¯æ©å±ççæ§è§£å³æ¹æ¡åæ¶åºæ°æ®åºãæ¯è¾åºåççæ§æ¹æ¡æ Promethuesï¼è VM æ¯å¼å®¹ Promethues çåç§è§èãéç½®ç­ï¼å¯ä»¥å¿«éçèå¥ Promethues çæçè³æ¯åä»£å®ã\n\nVM è·åæå¡ææ çæ¹å¼ä¹æ¯éè¿ä¸»å¨æåçæ¹å¼ï¼æ¯ä¸ªæå¡é½ä¼æ´é²ä¸ä¸ªç«¯å£ä¾ VM æ¥æåæå¡çææ ä¿¡æ¯\n\n\n\n\n# 2.django æå¡æ¥å¥\n\nå¯ä»¥éè¿ä½¿ç¨ç¬¬ä¸æ¹åº prometheus-client æ¥æ¶éæå¡çææ ä¿¡æ¯ï¼å¹¶æ´é²ç«¯å£ç» VM æåã\n\n * å®è£\n\npip install prometheus-client\n\n\n1\n\n * ä½¿ç¨\n\nå ä¸ºè¯¥æå¡ä½¿ç¨çæ¯ wsgi åè®®çï¼æä»¥å¨ wsgi.py æä»¶ä¸­æ·»å ä»¥ä¸ä»£ç ï¼ä¼å¼å¯ä¸ä¸ªæ°ççº¿ç¨çå¬ 9300 ç«¯å£ï¼è¯·æ±è¯¥ç«¯å£å¯ä»¥è·åå½åæå¡çåæ°ææ ã\n\nfrom prometheus_client import start_wsgi_server\nstart_wsgi_server(9300)\n\n\n1\n2\n\n\nå¦ææ³è¦ä¸æ¥ä¸å¡ææ ï¼å¯ä»¥éè¿è¯¥åºå¨ä¸å¡ä¸­è¿è¡åç¹åæ¶éã\n\nè¿éè¦å¨ pod ä¸­æ·»å  ports å±æ§æä¾ç» VM ä½¿ç¨ï¼è¿ä¸ªå¨åé¢è®²è§£ã\n\n- containerPort: 9300\n  name: exportport\n  protocol: TCP\n\n\n1\n2\n3\n\n\n\n# 3.logstash æ¥å¥\n\nlogstash æ¯æèªå·±çææ çæ§æå¡ï¼éè¦å¨éç½®æä»¶ logstash.yaml ä¸­å°å¶ç«¯å£æ´é²ã\n\nhttp.port: 9600\n\n\n1\n\n\nä½æ¯å¶ææ æ ¼å¼å prometheus çææ æ ¼å¼æ¯ä¸åçï¼æä»¥éè¦éè¿å¦ä¸ä¸ªç¨åº exporter æ¥å° logstash ææ è½¬æ¢æ prometheus ææ æ ¼å¼ã\n\nè¯¥ logstash æ¯é¨ç½²å¨ k8s ä¸­çï¼ä½¿ç¨å°å®¹å¨è®¾è®¡æ¨¡å¼ sidecarï¼å°±æ¯å¨ pod ä¸­æ°å¢ä¸ä¸ªå®¹å¨æ¥è¾å©ä¸»å®¹å¨ logstash æ¥åçæ§ææ çè½¬æ¢å¹¶æä¾ç» VM è°ç¨ã\n\n\n\nlogstash ç exporter å¯ä»¥ä½¿ç¨ prometheus-logstash-exporter æ¥å®æï¼å¯ä»¥å» docker hub ä¸­æ¾å°å¯¹åºçéåï¼å¹¶å°å¶ä¸è½½ä¸æ¥ä½¿ç¨ã\n\nå¨ logstash ç pod ä¸­æ·»å ä»¥ä¸éç½®æ¥è®¾ç½® exporterï¼å°æ´é² 9300 ç«¯å£ä½ä¸º logstash çææ çæ§ç«¯å£ç» VM æåãè¿ééè¦éç½® portsï¼å¨ VM ä¸­éè¦ä½¿ç¨è¯¥åæ°ã\n\n- name: logstash-exporter\nimage: alxrem/prometheus-logstash-exporter:0.7.0\nargs:\n- -logstash.host\n- 127.0.0.1\n- -logstash.port\n- 9600\n- -web.listen-address\n- 9300\nports:\n- name: exportport\n  containerPort: 9300\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# 4.flink æ¥å¥çæ§\n\nflink æ¬èº«æ¯æ¯æ prometheus çææ çæ§ï¼åªéè¦éè¿æ·»å éç½® flink çåæ°å³å¯å¼å¯ã\n\n  metrics.reporters: prom\n  metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter\n  metrics.reporter.prom.port: "9300"\n\n\n1\n2\n3\n\n\né¤äºä¸é¢çéç½®å¤ï¼è¿éè¦å¨ Pod ä¸­è®¾ç½® ports æ¥ä¾ VM ä½¿ç¨ã\n\nports:\n  - name: exportport\n\tcontainerPort: 9300\n\n\n1\n2\n3\n\n\n\n# 5.VMPodScrape\n\nè½ç¶ä¸é¢çæå¡é½æ´é²äºææ ç«¯å£ï¼VM å¦ä½æ¾å°å®ä»¬å¢ï¼éè¦éè¿åå»º VMPodScrape çèµæºå¯¹è±¡æ¥å¸®å© VM æ¥æ¾å°å®ä»¬ã\n\néç½®å¦ä¸ï¼\n\napiVersion: operator.victoriametrics.com/v1beta1\nkind: VMPodScrape\nmetadata:\n  labels:\n    prometheus: k8s\n  name: demo-pod-monitor          \n  namespace: monitor\nspec:\n  namespaceSelector:\n    any: true                   \n  podMetricsEndpoints:\n    - path: /metrics            \n      port: exportport          \n  selector:\n    matchLabels:\n      app: django\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n * spec.podMetricsEndpoints.portï¼è¿ä¸ªå°±æ¯å¨æ¯ä¸ª pod ä¸­æ·»å ç ports ä¸­å¯¹åºç nameï¼VM ä¼å»æ¾å°å¯¹åº name çç«¯å£è·åææ \n * spec.selector.matchLabelsï¼éè¿æ ç­¾è¿æ»¤æ¾å°æå®ç pod\n\néè¿ kubectl apply -f åå»ºè¯¥èµæºå¯¹è±¡ï¼VM å°±è½æ¾å°ææ æä¾çæå¡ã',normalizedContent:'# 0.ç®ä»\n\néè¿ææ çæ§å¯ä»¥è®¾ç½®å¯¹åºçåè­¦ï¼å¿«éåç°é®é¢ï¼å¹¶éè¿ç¸åºçææ å®ä½é®é¢ã\n\nèæ¯ï¼ä½¿ç¨ç victoriametrics(ç®ç§° vm) ä½ä¸ºçæ§çè§£å³æ¹æ¡ï¼éè¦å° django æå¡ãlogstash å flink å¼ææ¥å¥è¿æ¥ï¼vm å¯ä»¥å®æ¶çè·åå®ä»¬çææ å­å¨å¹¶è¿è¡çæ§åè­¦ï¼ä»¥ä¸çæå¡é½æ¯é¨ç½²å¨ k8s ä¸­çã\n\n\n# 1.victoriametrics\n\nvictoriametricsï¼æ¯ä¸ä¸ªå¿«éé«æãç»æµå¹¶ä¸å¯æ©å±ççæ§è§£å³æ¹æ¡åæ¶åºæ°æ®åºãæ¯è¾åºåççæ§æ¹æ¡æ promethuesï¼è vm æ¯å¼å®¹ promethues çåç§è§èãéç½®ç­ï¼å¯ä»¥å¿«éçèå¥ promethues çæçè³æ¯åä»£å®ã\n\nvm è·åæå¡ææ çæ¹å¼ä¹æ¯éè¿ä¸»å¨æåçæ¹å¼ï¼æ¯ä¸ªæå¡é½ä¼æ´é²ä¸ä¸ªç«¯å£ä¾ vm æ¥æåæå¡çææ ä¿¡æ¯\n\n\n\n\n# 2.django æå¡æ¥å¥\n\nå¯ä»¥éè¿ä½¿ç¨ç¬¬ä¸æ¹åº prometheus-client æ¥æ¶éæå¡çææ ä¿¡æ¯ï¼å¹¶æ´é²ç«¯å£ç» vm æåã\n\n * å®è£\n\npip install prometheus-client\n\n\n1\n\n * ä½¿ç¨\n\nå ä¸ºè¯¥æå¡ä½¿ç¨çæ¯ wsgi åè®®çï¼æä»¥å¨ wsgi.py æä»¶ä¸­æ·»å ä»¥ä¸ä»£ç ï¼ä¼å¼å¯ä¸ä¸ªæ°ççº¿ç¨çå¬ 9300 ç«¯å£ï¼è¯·æ±è¯¥ç«¯å£å¯ä»¥è·åå½åæå¡çåæ°ææ ã\n\nfrom prometheus_client import start_wsgi_server\nstart_wsgi_server(9300)\n\n\n1\n2\n\n\nå¦ææ³è¦ä¸æ¥ä¸å¡ææ ï¼å¯ä»¥éè¿è¯¥åºå¨ä¸å¡ä¸­è¿è¡åç¹åæ¶éã\n\nè¿éè¦å¨ pod ä¸­æ·»å  ports å±æ§æä¾ç» vm ä½¿ç¨ï¼è¿ä¸ªå¨åé¢è®²è§£ã\n\n- containerport: 9300\n  name: exportport\n  protocol: tcp\n\n\n1\n2\n3\n\n\n\n# 3.logstash æ¥å¥\n\nlogstash æ¯æèªå·±çææ çæ§æå¡ï¼éè¦å¨éç½®æä»¶ logstash.yaml ä¸­å°å¶ç«¯å£æ´é²ã\n\nhttp.port: 9600\n\n\n1\n\n\nä½æ¯å¶ææ æ ¼å¼å prometheus çææ æ ¼å¼æ¯ä¸åçï¼æä»¥éè¦éè¿å¦ä¸ä¸ªç¨åº exporter æ¥å° logstash ææ è½¬æ¢æ prometheus ææ æ ¼å¼ã\n\nè¯¥ logstash æ¯é¨ç½²å¨ k8s ä¸­çï¼ä½¿ç¨å°å®¹å¨è®¾è®¡æ¨¡å¼ sidecarï¼å°±æ¯å¨ pod ä¸­æ°å¢ä¸ä¸ªå®¹å¨æ¥è¾å©ä¸»å®¹å¨ logstash æ¥åçæ§ææ çè½¬æ¢å¹¶æä¾ç» vm è°ç¨ã\n\n\n\nlogstash ç exporter å¯ä»¥ä½¿ç¨ prometheus-logstash-exporter æ¥å®æï¼å¯ä»¥å» docker hub ä¸­æ¾å°å¯¹åºçéåï¼å¹¶å°å¶ä¸è½½ä¸æ¥ä½¿ç¨ã\n\nå¨ logstash ç pod ä¸­æ·»å ä»¥ä¸éç½®æ¥è®¾ç½® exporterï¼å°æ´é² 9300 ç«¯å£ä½ä¸º logstash çææ çæ§ç«¯å£ç» vm æåãè¿ééè¦éç½® portsï¼å¨ vm ä¸­éè¦ä½¿ç¨è¯¥åæ°ã\n\n- name: logstash-exporter\nimage: alxrem/prometheus-logstash-exporter:0.7.0\nargs:\n- -logstash.host\n- 127.0.0.1\n- -logstash.port\n- 9600\n- -web.listen-address\n- 9300\nports:\n- name: exportport\n  containerport: 9300\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# 4.flink æ¥å¥çæ§\n\nflink æ¬èº«æ¯æ¯æ prometheus çææ çæ§ï¼åªéè¦éè¿æ·»å éç½® flink çåæ°å³å¯å¼å¯ã\n\n  metrics.reporters: prom\n  metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.prometheusreporter\n  metrics.reporter.prom.port: "9300"\n\n\n1\n2\n3\n\n\né¤äºä¸é¢çéç½®å¤ï¼è¿éè¦å¨ pod ä¸­è®¾ç½® ports æ¥ä¾ vm ä½¿ç¨ã\n\nports:\n  - name: exportport\n\tcontainerport: 9300\n\n\n1\n2\n3\n\n\n\n# 5.vmpodscrape\n\nè½ç¶ä¸é¢çæå¡é½æ´é²äºææ ç«¯å£ï¼vm å¦ä½æ¾å°å®ä»¬å¢ï¼éè¦éè¿åå»º vmpodscrape çèµæºå¯¹è±¡æ¥å¸®å© vm æ¥æ¾å°å®ä»¬ã\n\néç½®å¦ä¸ï¼\n\napiversion: operator.victoriametrics.com/v1beta1\nkind: vmpodscrape\nmetadata:\n  labels:\n    prometheus: k8s\n  name: demo-pod-monitor          \n  namespace: monitor\nspec:\n  namespaceselector:\n    any: true                   \n  podmetricsendpoints:\n    - path: /metrics            \n      port: exportport          \n  selector:\n    matchlabels:\n      app: django\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n * spec.podmetricsendpoints.portï¼è¿ä¸ªå°±æ¯å¨æ¯ä¸ª pod ä¸­æ·»å ç ports ä¸­å¯¹åºç nameï¼vm ä¼å»æ¾å°å¯¹åº name çç«¯å£è·åææ \n * spec.selector.matchlabelsï¼éè¿æ ç­¾è¿æ»¤æ¾å°æå®ç pod\n\néè¿ kubectl apply -f åå»ºè¯¥èµæºå¯¹è±¡ï¼vm å°±è½æ¾å°ææ æä¾çæå¡ã',charsets:{cjk:!0},lastUpdated:"2023/02/21, 11:15:06",lastUpdatedTimestamp:1676949306e3},{title:"podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦»",frontmatter:{title:"podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦»",date:"2022-11-14T09:56:31.000Z",permalink:"/pages/27987d/",tags:["k8s","å®¹å¨","äºåç"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æä»¬å¨åå»ºä¸ä¸ª python ç web æå¡çéåæ¶ï¼ä¸è¬çåæ³æ¯ï¼å° python ç¯å¢ä¸ä»£ç æåæä¸ä¸ªéåï¼ç¶åå°è¿ä¸ªéåè¿è¡åå¸ã",categories:["äºåç","k8s"],comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20221114095752.png"},{name:"twitter:title",content:"podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦»"},{name:"twitter:description",content:"æä»¬å¨åå»ºä¸ä¸ª python ç web æå¡çéåæ¶ï¼ä¸è¬çåæ³æ¯ï¼å° python ç¯å¢ä¸ä»£ç æåæä¸ä¸ªéåï¼ç¶åå°è¿ä¸ªéåè¿è¡åå¸ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20221114095752.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/12.pod%E4%B8%AD%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%8E%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E5%88%86%E7%A6%BB.html"},{property:"og:type",content:"article"},{property:"og:title",content:"podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦»"},{property:"og:description",content:"æä»¬å¨åå»ºä¸ä¸ª python ç web æå¡çéåæ¶ï¼ä¸è¬çåæ³æ¯ï¼å° python ç¯å¢ä¸ä»£ç æåæä¸ä¸ªéåï¼ç¶åå°è¿ä¸ªéåè¿è¡åå¸ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20221114095752.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/12.pod%E4%B8%AD%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%8E%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E5%88%86%E7%A6%BB.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-11-14T09:56:31.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{itemprop:"name",content:"podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦»"},{itemprop:"description",content:"æä»¬å¨åå»ºä¸ä¸ª python ç web æå¡çéåæ¶ï¼ä¸è¬çåæ³æ¯ï¼å° python ç¯å¢ä¸ä»£ç æåæä¸ä¸ªéåï¼ç¶åå°è¿ä¸ªéåè¿è¡åå¸ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20221114095752.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/12.pod%E4%B8%AD%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%8E%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E5%88%86%E7%A6%BB.html",relativePath:"01.äºåç/07.k8s/12.podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦».md",key:"v-476540fe",path:"/pages/27987d/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. æè·¯",slug:"_1-æè·¯",normalizedTitle:"1. æè·¯",charIndex:171},{level:2,title:"2. æ¡ä¾",slug:"_2-æ¡ä¾",normalizedTitle:"2. æ¡ä¾",charIndex:337},{level:3,title:"2.1 åå»ºä»£ç éå",slug:"_2-1-åå»ºä»£ç éå",normalizedTitle:"2.1 åå»ºä»£ç éå",charIndex:347},{level:3,title:"2.2 åå»º python è¿è¡ç¯å¢",slug:"_2-2-åå»º-python-è¿è¡ç¯å¢",normalizedTitle:"2.2 åå»º python è¿è¡ç¯å¢",charIndex:802},{level:3,title:"2.3 å®¹å¨ç¼æ",slug:"_2-3-å®¹å¨ç¼æ",normalizedTitle:"2.3 å®¹å¨ç¼æ",charIndex:1078},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:2797}],headersStr:"0. åè¨ 1. æè·¯ 2. æ¡ä¾ 2.1 åå»ºä»£ç éå 2.2 åå»º python è¿è¡ç¯å¢ 2.3 å®¹å¨ç¼æ 3. æ»ç»",content:'# 0. åè¨\n\næä»¬å¨åå»ºä¸ä¸ª python ç web æå¡çéåæ¶ï¼ä¸è¬çåæ³æ¯ï¼å° python ç¯å¢ä¸ä»£ç æåæä¸ä¸ªéåï¼ç¶åå°è¿ä¸ªéåè¿è¡åå¸ã\n\nç°å¨æä¸ªéæ±å°±æ¯å° python ç¯å¢åä»£ç åå«æé æä¸¤ä¸ªéåï¼è®©ä»ä»¬è¿è¡è§£è¦ï¼å¹¶ä¸å°ä»ä»¬ç¼æå¨ä¸ä¸ª pod ä¸­ã\n\næ¬æä»ç»å¦ä½å° pod ä¸­çä»£ç ä¸è¿è¡çç¯å¢è¿è¡æåã\n\n\n# 1. æè·¯\n\né¦åæä»¬å°ä»£ç æåæéå Aï¼åå° python è¿è¡ç¯å¢æåæéå Bï¼éè¿ç¼æå¨ Pod ä¸­ç InitContainer è®¾ç½®ä¸ºéå Aï¼å¹¶å°å¶åçä»£ç æ·è´å°æè½½ç emptyDir å­å¨å·ä¸­ï¼ç¶åå¨éå B ä¸­æè½½ç¸åçå­å¨å·ï¼å¨ä½¿ç¨è¿è¡ç¯å¢ä¸­ç python å»æ§è¡å­å¨å·ä¸­æ·è´è¿æ¥çä»£ç å³å¯ã\n\n\n\n\n# 2. æ¡ä¾\n\n\n# 2.1 åå»ºä»£ç éå\n\nååå»ºä¸ä¸ªç®åç python web ç¨åº main.py\n\nfrom flask import Flask\n\napp = Flask(__name__)\n\n\n@app.route("/")\ndef hello_world():\n    return "Hello, World!"\n\napp.run(host="0.0.0.0")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\næä»¬ååå»ºåå«ä»£ç éåç Dockerfileï¼åçäºææ¯å° main.py æä»¶æ·è´å°éåçæ ¹ç®å½ä¸ï¼æä»¶å½åä¸ºDockerfile_code\n\nFROM busybox:latest\nCOPY main.py /\n\n\n1\n2\n\n\næä»¬éè¿ docker build å¼å§åå»ºéåï¼éååç§°ä¸º demo_codeï¼é»è®¤ tagä¸º latest\n\ndocker build . -t "demo_code" -f Dockerfile_code\n\n\n1\n\n\nè¿ä¸ªæ¶åæä»¬çä»£ç éååå»ºå¥½äºã\n\n\n# 2.2 åå»º python è¿è¡ç¯å¢\n\næä»¬å¼å§åå»º python è¿è¡ç¯å¢éåç Dockerfileï¼ä»¥ python3 çéåä¸ºåºç¡ï¼å¹¶å®è£ flask åºï¼æä»¶åä¸º Dockerfile_runtime\n\nFROM python:3\nRUN pip install flask\n\n\n1\n2\n\n\nåæå»ºä¸ä¸è¿ä¸ªéåï¼éååä¸º demo_runtimeï¼é»è®¤ tag æ¯ latest\n\ndocker build . -t "demo_runtime" -f Dockerfile_runtime\n\n\n1\n\n\nè¿ä¸ªæ¶åï¼ä¸¤ä¸ªéåé½å·²åå¤å¥½\n\n\n# 2.3 å®¹å¨ç¼æ\n\nåå»º deployments.yaml æä»¶ï¼å¨ Pod ä¸­ç initContainers ä¸­éç½®ä»£ç éå, ç¶åæè½½ä¸´æ¶å­å¨å·ï¼å°ä»£ç å¤å¶å°å­å¨å·ä¸­ã\n\nç¶ååéç½®åºç¨å®¹å¨ python è¿è¡ç¯å¢ï¼æè½½ä¸é¢ç¸åçä¸´æ¶å­å¨å·ï¼ç¶ååä½¿ç¨ python å°ä»£ç è¿è¡ã\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: demo\n  labels:\n    app: demo\nspec:\n  selector:\n    matchLabels:\n      app: demo\n  template:\n    metadata:\n      labels:\n        app: demo\n    spec:\n      initContainers:\n        - image: demo_code:latest\n          name: code\n          imagePullPolicy: IfNotPresent\n          volumeMounts:\n          - mountPath: /opt/demo\n            name: app-volume\n          command: ["cp", "/main.py", "/opt/demo/"]\n      containers:\n        - name: runtime\n          image: demo_runtime:latest\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 5000\n              hostPort: 5000\n              protocol: TCP\n              name: http\n          volumeMounts:\n            - mountPath: /opt/demo\n              name: app-volume\n          command: ["python", "/opt/demo/main.py"]\n      volumes:\n      - name: app-volume\n        emptyDir: { }\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\næä»¬éè¿ kubectl apply åå»º deployments\n\nkubectl apply -f deployments.yaml\n\n\n1\n\n\næä»¬éè¿ kubectl get pods å¯ä»¥çå° pod å·²ç»åå»ºæåï¼ç¶åæ¾å° pod æå¨çèç¹ãéè¿èç¹ ip+ç«¯å£å³å¯è®¿é®å°å®¹å¨çä¸­æ¥å£ã\n\n[root@k8s-master-07rf9 test]# kubectl get pods -o wide\nNAME                    READY   STATUS    RESTARTS   AGE     IP               NODE               NOMINATED NODE   READINESS GATES\ndemo-6f49db5d6c-25vss   1/1     Running   0          4m58s   10.244.132.130   k8s-master-07rf9   <none>           <none>\n\n\n[root@k8s-master-07rf9 test]# curl 10.65.132.187:5000\nHello, World!\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# 3. æ»ç»\n\næ¬æçç¼ææ¹å¼åªæ¯ pod çè®¾è®¡æ¨¡å¼çä¸ç§ãæå´è¶£çå¯ä»¥äºè§£æ´å¤ã\n\néè¿è¿ç§æ¹å¼å¯ä»¥è®©ä»£ç ä¸è¿è¡ç¯å¢è§£è¦ï¼å½æä»¬æ´æ°ä»£ç æ¶ï¼å¹¶ä¸ä¼å½±åå°è¿è¡ç¯å¢ã',normalizedContent:'# 0. åè¨\n\næä»¬å¨åå»ºä¸ä¸ª python ç web æå¡çéåæ¶ï¼ä¸è¬çåæ³æ¯ï¼å° python ç¯å¢ä¸ä»£ç æåæä¸ä¸ªéåï¼ç¶åå°è¿ä¸ªéåè¿è¡åå¸ã\n\nç°å¨æä¸ªéæ±å°±æ¯å° python ç¯å¢åä»£ç åå«æé æä¸¤ä¸ªéåï¼è®©ä»ä»¬è¿è¡è§£è¦ï¼å¹¶ä¸å°ä»ä»¬ç¼æå¨ä¸ä¸ª pod ä¸­ã\n\næ¬æä»ç»å¦ä½å° pod ä¸­çä»£ç ä¸è¿è¡çç¯å¢è¿è¡æåã\n\n\n# 1. æè·¯\n\né¦åæä»¬å°ä»£ç æåæéå aï¼åå° python è¿è¡ç¯å¢æåæéå bï¼éè¿ç¼æå¨ pod ä¸­ç initcontainer è®¾ç½®ä¸ºéå aï¼å¹¶å°å¶åçä»£ç æ·è´å°æè½½ç emptydir å­å¨å·ä¸­ï¼ç¶åå¨éå b ä¸­æè½½ç¸åçå­å¨å·ï¼å¨ä½¿ç¨è¿è¡ç¯å¢ä¸­ç python å»æ§è¡å­å¨å·ä¸­æ·è´è¿æ¥çä»£ç å³å¯ã\n\n\n\n\n# 2. æ¡ä¾\n\n\n# 2.1 åå»ºä»£ç éå\n\nååå»ºä¸ä¸ªç®åç python web ç¨åº main.py\n\nfrom flask import flask\n\napp = flask(__name__)\n\n\n@app.route("/")\ndef hello_world():\n    return "hello, world!"\n\napp.run(host="0.0.0.0")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\næä»¬ååå»ºåå«ä»£ç éåç dockerfileï¼åçäºææ¯å° main.py æä»¶æ·è´å°éåçæ ¹ç®å½ä¸ï¼æä»¶å½åä¸ºdockerfile_code\n\nfrom busybox:latest\ncopy main.py /\n\n\n1\n2\n\n\næä»¬éè¿ docker build å¼å§åå»ºéåï¼éååç§°ä¸º demo_codeï¼é»è®¤ tagä¸º latest\n\ndocker build . -t "demo_code" -f dockerfile_code\n\n\n1\n\n\nè¿ä¸ªæ¶åæä»¬çä»£ç éååå»ºå¥½äºã\n\n\n# 2.2 åå»º python è¿è¡ç¯å¢\n\næä»¬å¼å§åå»º python è¿è¡ç¯å¢éåç dockerfileï¼ä»¥ python3 çéåä¸ºåºç¡ï¼å¹¶å®è£ flask åºï¼æä»¶åä¸º dockerfile_runtime\n\nfrom python:3\nrun pip install flask\n\n\n1\n2\n\n\nåæå»ºä¸ä¸è¿ä¸ªéåï¼éååä¸º demo_runtimeï¼é»è®¤ tag æ¯ latest\n\ndocker build . -t "demo_runtime" -f dockerfile_runtime\n\n\n1\n\n\nè¿ä¸ªæ¶åï¼ä¸¤ä¸ªéåé½å·²åå¤å¥½\n\n\n# 2.3 å®¹å¨ç¼æ\n\nåå»º deployments.yaml æä»¶ï¼å¨ pod ä¸­ç initcontainers ä¸­éç½®ä»£ç éå, ç¶åæè½½ä¸´æ¶å­å¨å·ï¼å°ä»£ç å¤å¶å°å­å¨å·ä¸­ã\n\nç¶ååéç½®åºç¨å®¹å¨ python è¿è¡ç¯å¢ï¼æè½½ä¸é¢ç¸åçä¸´æ¶å­å¨å·ï¼ç¶ååä½¿ç¨ python å°ä»£ç è¿è¡ã\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  name: demo\n  labels:\n    app: demo\nspec:\n  selector:\n    matchlabels:\n      app: demo\n  template:\n    metadata:\n      labels:\n        app: demo\n    spec:\n      initcontainers:\n        - image: demo_code:latest\n          name: code\n          imagepullpolicy: ifnotpresent\n          volumemounts:\n          - mountpath: /opt/demo\n            name: app-volume\n          command: ["cp", "/main.py", "/opt/demo/"]\n      containers:\n        - name: runtime\n          image: demo_runtime:latest\n          imagepullpolicy: ifnotpresent\n          ports:\n            - containerport: 5000\n              hostport: 5000\n              protocol: tcp\n              name: http\n          volumemounts:\n            - mountpath: /opt/demo\n              name: app-volume\n          command: ["python", "/opt/demo/main.py"]\n      volumes:\n      - name: app-volume\n        emptydir: { }\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\næä»¬éè¿ kubectl apply åå»º deployments\n\nkubectl apply -f deployments.yaml\n\n\n1\n\n\næä»¬éè¿ kubectl get pods å¯ä»¥çå° pod å·²ç»åå»ºæåï¼ç¶åæ¾å° pod æå¨çèç¹ãéè¿èç¹ ip+ç«¯å£å³å¯è®¿é®å°å®¹å¨çä¸­æ¥å£ã\n\n[root@k8s-master-07rf9 test]# kubectl get pods -o wide\nname                    ready   status    restarts   age     ip               node               nominated node   readiness gates\ndemo-6f49db5d6c-25vss   1/1     running   0          4m58s   10.244.132.130   k8s-master-07rf9   <none>           <none>\n\n\n[root@k8s-master-07rf9 test]# curl 10.65.132.187:5000\nhello, world!\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# 3. æ»ç»\n\næ¬æçç¼ææ¹å¼åªæ¯ pod çè®¾è®¡æ¨¡å¼çä¸ç§ãæå´è¶£çå¯ä»¥äºè§£æ´å¤ã\n\néè¿è¿ç§æ¹å¼å¯ä»¥è®©ä»£ç ä¸è¿è¡ç¯å¢è§£è¦ï¼å½æä»¬æ´æ°ä»£ç æ¶ï¼å¹¶ä¸ä¼å½±åå°è¿è¡ç¯å¢ã',charsets:{cjk:!0},lastUpdated:"2023/02/07, 09:44:40",lastUpdatedTimestamp:167573428e4},{title:"çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç",frontmatter:{title:"çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç",date:"2023-06-03T11:04:25.000Z",permalink:"/pages/f0f725/",categories:["äºåç","k8s"],tags:["k8s","å®¹å¨","äºåç","è®¡ç®æºç½ç»","Linuxç½ç»èæå"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"Calicoæ¯k8sä¸­å¸¸ç¨çå®¹å¨è§£å³æ¹æ¡çæä»¶ï¼æ¬æä¸»è¦ä»ç»BGPæ¨¡å¼åIPIPæ¨¡å¼æ¯å¦ä½è§£å³çï¼å¹¶è¯¦ç»äºè§£å¶åçï¼å¹¶éè¿å®éªå æ·±çè§£ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_calico.png"},{name:"twitter:title",content:"çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç"},{name:"twitter:description",content:"Calicoæ¯k8sä¸­å¸¸ç¨çå®¹å¨è§£å³æ¹æ¡çæä»¶ï¼æ¬æä¸»è¦ä»ç»BGPæ¨¡å¼åIPIPæ¨¡å¼æ¯å¦ä½è§£å³çï¼å¹¶è¯¦ç»äºè§£å¶åçï¼å¹¶éè¿å®éªå æ·±çè§£ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_calico.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/15.%E7%90%86%E8%A7%A3calico%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86.html"},{property:"og:type",content:"article"},{property:"og:title",content:"çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç"},{property:"og:description",content:"Calicoæ¯k8sä¸­å¸¸ç¨çå®¹å¨è§£å³æ¹æ¡çæä»¶ï¼æ¬æä¸»è¦ä»ç»BGPæ¨¡å¼åIPIPæ¨¡å¼æ¯å¦ä½è§£å³çï¼å¹¶è¯¦ç»äºè§£å¶åçï¼å¹¶éè¿å®éªå æ·±çè§£ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_calico.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/15.%E7%90%86%E8%A7%A3calico%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-06-03T11:04:25.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"Linuxç½ç»èæå"},{itemprop:"name",content:"çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç"},{itemprop:"description",content:"Calicoæ¯k8sä¸­å¸¸ç¨çå®¹å¨è§£å³æ¹æ¡çæä»¶ï¼æ¬æä¸»è¦ä»ç»BGPæ¨¡å¼åIPIPæ¨¡å¼æ¯å¦ä½è§£å³çï¼å¹¶è¯¦ç»äºè§£å¶åçï¼å¹¶éè¿å®éªå æ·±çè§£ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_calico.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/15.%E7%90%86%E8%A7%A3calico%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86.html",relativePath:"01.äºåç/07.k8s/15.çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç.md",key:"v-38f161f6",path:"/pages/f0f725/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. ä»ç»Calico",slug:"_1-ä»ç»calico",normalizedTitle:"1. ä»ç»calico",charIndex:82},{level:2,title:"2. Calioæ¶æ",slug:"_2-calioæ¶æ",normalizedTitle:"2. calioæ¶æ",charIndex:585},{level:2,title:"3. BGPæ¨¡å¼",slug:"_3-bgpæ¨¡å¼",normalizedTitle:"3. bgpæ¨¡å¼",charIndex:1154},{level:2,title:"4. æå¨æ¨¡æBGPæ¨¡å¼å®éª",slug:"_4-æå¨æ¨¡æbgpæ¨¡å¼å®éª",normalizedTitle:"4. æå¨æ¨¡æbgpæ¨¡å¼å®éª",charIndex:1397},{level:3,title:"4.1 æä½",slug:"_4-1-æä½",normalizedTitle:"4.1 æä½",charIndex:1418},{level:3,title:"4.2 åæ",slug:"_4-2-åæ",normalizedTitle:"4.2 åæ",charIndex:3211},{level:2,title:"5. IPIPé§éæ¨¡å¼",slug:"_5-ipipé§éæ¨¡å¼",normalizedTitle:"5. ipipé§éæ¨¡å¼",charIndex:5636}],headersStr:"0. åè¨ 1. ä»ç»Calico 2. Calioæ¶æ 3. BGPæ¨¡å¼ 4. æå¨æ¨¡æBGPæ¨¡å¼å®éª 4.1 æä½ 4.2 åæ 5. IPIPé§éæ¨¡å¼",content:"# 0. åè¨\n\nCalicoæ¯k8sä¸­å¸¸ç¨çå®¹å¨è§£å³æ¹æ¡çæä»¶ï¼æ¬æä¸»è¦ä»ç»BGPæ¨¡å¼åIPIPæ¨¡å¼æ¯å¦ä½è§£å³çï¼å¹¶è¯¦ç»äºè§£å¶åçï¼å¹¶éè¿å®éªå æ·±çè§£ã\n\n\n# 1. ä»ç»Calico\n\nCalicoæ¯å±äºçº¯3å±çç½ç»æ¨¡åï¼æ¯ä¸ªå®¹å¨é½éè¿IPç´æ¥éä¿¡ï¼ä¸­é´éè¿è·¯ç±è½¬åæ¾å°å¯¹æ¹ãå®¹å¨æå¨çèç¹ç±»ä¼¼äºä¼ ç»çè·¯ç±å¨ï¼æä¾äºè·¯ç±æ¥æ¾çåè½ãæ¯ä¸ªå®¹å¨æå¨çä¸»æºèç¹æ®æ¼äºèæè·¯ç±å¨ ï¼vRouterï¼çåè½ï¼vRouterå¿é¡»ææç§æ¹æ³ï¼è½å¤ç¥éæ´ä¸ªéç¾¤çè·¯ç±ä¿¡æ¯ã\n\nä¹åæå°çFlannelHost Gatewayæ¨¡å¼æ¹æ¡æ¯ä¸è½è·¨äºå±ç½ç»ï¼æ¯å ä¸ºå®åªè½ä¿®æ¹ä¸»æºè·¯ç±ï¼Calicoææ¹è·¯ç±è¡¨çåæ³æ¢æäºæ åçBGPè·¯ç±åè®®ãç¸å½äºå¨æ¯ä¸ªèç¹ä¸æ¨¡æåºä¸ä¸ªé¢å¤çè·¯ç±å¨ï¼ç±äºéç¨çæ¯æ ååè®®ï¼Calicoæ¨¡æè·¯ç±å¨çè·¯ç±è¡¨ä¿¡æ¯å¯ä»¥è¢«ä¼ æ­å°ç½ç»çå¶ä»è·¯ç±è®¾å¤ä¸­ï¼è¿æ ·å°±å®ç°äºå¨ä¸å±ç½ç»ä¸çé«éè·¨èç¹ç½ç»ã\n\n> BGPï¼Border Gateway Protocolï¼æ¯ä¸ç§ç¨äºå¨äºèç½ä¸­äº¤æ¢è·¯ç±ä¿¡æ¯çåè®®ãå®æ¯ä¸ç§èªæ²»ç³»ç»ï¼ASï¼ä¹é´çè·¯ç±åè®®ï¼ç¨äºå¨ä¸åçèªæ²»ç³»ç»ä¹é´äº¤æ¢è·¯ç±ä¿¡æ¯ãBGPåè®®çä¸»è¦ä½ç¨æ¯å°è·¯ç±ä¿¡æ¯ä»ä¸ä¸ªèªæ²»ç³»ç»ä¼ éå°å¦ä¸ä¸ªèªæ²»ç³»ç»ï¼ä»¥ä¾¿å®ç°äºèç½çå¨çè·¯ç±ã\n\nä½ç°å®ä¸­çç½ç»å¹¶ä¸ä¸å®æ¯æBGPè·¯ç±ï¼å¨è¿ç§æåµä¸å¯ä»¥ä½¿ç¨IPIPé§éæ¨¡å¼æ¥ä¼ è¾æ°æ®ã\n\n\n# 2. Calioæ¶æ\n\n\n\nFelix\n\nFelixæ¯ä¸ä¸ªå®æ¤ç¨åºï¼ä½ä¸ºagentè¿è¡å¨æç®¡å®¹å¨æèææºçCalicoèç¹ä¸ãFelixè´è´£å·æ°ä¸»æºè·¯ç±åACLè§åç­ï¼ä»¥ä¾¿ä¸ºè¯¥ä¸»æºä¸çEndpointæ­£å¸¸è¿è¡æä¾æéçç½ç»è¿æ¥åç®¡çãè¿åºå®¹å¨ãèææºåç©çä¸»æºçæææµéé½ä¼éåCalicoï¼å©ç¨Linuxåæ ¸åççè·¯ç±åiptablesçæçè§åã\n\nBGP Client\n\nCalicoå¨æ¯ä¸ªè¿è¡Felixæå¡çèç¹ä¸é½é¨ç½²ä¸ä¸ªBGP Clientï¼BGPå®¢æ·ç«¯ï¼ãBGPå®¢æ·ç«¯çä½ç¨æ¯è¯»åFelixç¼åå°åæ ¸ä¸­çè·¯ç±ä¿¡æ¯ï¼ç±BGPå®¢æ·ç«¯å¯¹è¿äºè·¯ç±ä¿¡æ¯è¿è¡ååãå½Felixå°è·¯ç±æå¥Linuxåæ ¸æ¶ï¼BGPå®¢æ·ç«¯å°æ¥æ¶å®ä»¬ï¼å¹¶å°å®ä»¬ååå°éç¾¤ä¸­çå¶ä»å·¥ä½èç¹ã\n\nNode-to-Node Mesh\n\nè¯¥æ¨¡å¼ä¸ºé»è®¤æ¨¡å¼ï¼å¨BGPä¸ï¼éç¾¤ä¸­çæ¯ä¸ä¸ªèç¹çBGP Clienté½éè¦åå¶ä»ææèç¹çBGP Clientè¿è¡éä¿¡æ¥äº¤æ¢è·¯ç±ã\nä½éçèç¹æ°éå¢å ï¼è¿æ¥æ°ä¼ä»¥N^2è§æ¨¡å¢å ï¼ç»éç¾¤ç½ç»å¸¦æ¥å·¨å¤§çååã\n\nBGP Route Reflector\n\nCalicoä¼æå®å ä¸ªèç¹è´è´£ä¸é¨è·å¶ä»ææèç¹è¿è¡è¿æ¥å¹¶äº¤æ¢è·¯ç±ä¿¡æ¯ï¼ä»èå­¦ä¹ å°å¨å±çè·¯ç±ä¿¡æ¯ãèå¶ä»èç¹ä¹åªéè¦è·è¿å ä¸ªèç¹è¿è¡éä¿¡æ¥è·åå°æ´ä¸ªéç¾¤çè§åä¿¡æ¯ã\n\n\n\n\n# 3. BGPæ¨¡å¼\n\n\n\næ¯ä¸ªå®¹å¨é½ä¼åå»ºä¸å¯¹veth pairç½å¡ï¼ä¸ç«¯æ¾å¨å®¹å¨åé¨ï¼å¦ä¸ç«¯æ¾å¨å®¿ä¸»æºä¸­ï¼å®¹å¨ä¸­åéçIPåéè¿veth pairç½å¡å¯ä»¥è¾¾å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ã\n\nFelixä¼éè¿çå¬etcdæ¥è·åå¶ä»èç¹çç¸å³ä¿¡æ¯ï¼ç¶åæ·»å æ¬å°è·¯ç±ï¼\n\n 1. éå¾å¶ä»èç¹å®¹å¨çIPåä¸ä¸æ¡å°å¶èç¹ç©çç½å¡ä¸­ã\n 2. éè¿æ¬æºèç¹å®¹å¨çIPåå°calixxxç½å¡ä¸­ï¼ç¶åè¿å¥å°å®¹å¨ä¸­ã\n\nBGP Clientä¼è¯»åFelixåå¥å°æ¬å°çè·¯ç±ï¼åéè¿è¿è¡ååå°ç½ç»ä¸­ã\n\n\n# 4. æå¨æ¨¡æBGPæ¨¡å¼å®éª\n\n\n\n\n# 4.1 æä½\n\né¦åå¨Node1ä¸­åå»ºNetwork Namespaceå½åä¸ºnet1\n\nip netns add net1\n\n\n1\n\n\nç¶ååå»ºä¸å¯¹veth pairè®¾å¤veth0åveth1ï¼å°veth0æ¾å°net1ä¸­ï¼æèµ·å¹¶è®¾ç½®å¥½ipå°å172.19.1.2/24ï¼veth1ä¹æåä½ä¸ç¨è®¾ç½®IPå°åï¼ä½éè¦è®¾ç½®é»è®¤çMACå°åä¸ºee:ee:ee:ee:ee:ee\n\nip link add veth0 type veth peer name veth1\nip link set dev veth0 netns net1\nip netns exec net1 ip link set veth0 up\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\n\nip link set dev veth1 up\nip link set dev veth1 address ee:ee:ee:ee:ee:ee\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nnet1éç½®çè·¯ç±æç¹ææï¼åä¸è¬éç½®çè·¯ç±ä¸åï¼ææçæ¥æé½éè¦éè¿veth0è®¾å¤åéå°ä¸ä¸è·³çå°åä¸º169.254.1.1ï¼èè¿ä¸ªå°åå¨æ´ä¸ªå¹³å°æ¾æ¯ä¸å­å¨çï¼è¿æ¯ä¸ä¸ªé»è®¤çç½å³ï¼é£å¦ä½è¾¾å°è¯¥å°åå¢ï¼\n\nip netns exec net1 ip r a 169.254.1.1 dev veth0 \nip netns exec net1 ip r a default via 169.254.1.1 dev veth0 \n\n\n1\n2\n\n\néè¿è®¾ç½®veth1è®¾å¤proxy_arpï¼å¯ä»¥å¯¹äºä»»ä½ARPè¯·æ±å°è¾¾veth1æ¶ï¼é½ååºèªå·±çMacå°åï¼ä¹å°±æ¯ee:ee:ee:ee:ee:ee\n\nå½è®¿é®ç½å³çæ¶åï¼é¦åæ¯éè¦è¿è¡ARPè¯·æ±ï¼è¯·æ±éè¿veth0è®¾å¤è¾¾å°äºveth1ä¸­ï¼å ä¸ºè®¾ç½®proxy_arpï¼ä¼å°èªèº«çmacå°åee:ee:ee:ee:ee:eeä½ä¸ºarpåå¤ã\n\nèå®¹å¨çåç»­æ¥æç®çIPå°åæ¯ç®çå®¹å¨çIPå°åï¼èmacå°ååæäºç½å³MACå°åee:ee:ee:ee:ee:eeï¼èç½å³çIPå°åå¹¶ä¸ä¼åºç°å¨ä»»ä½çæ°æ®åä¸­ï¼ä¹æ²¡äººå³å¿è¿ä¸ªå·ä½çå°åæ¯ä»ä¹ï¼åªè¦è½æ¾å°arpå°±è¡ã\n\necho 1 > /proc/sys/net/ipv4/conf/veth1/proxy_arp\n\n\n1\n\n\næ°æ®åå·²ç»ä»net1ä¸­éè¿veth1ä½ä¸ºç½å³è¾¾å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ï¼åéè¿è®¾ç½®å®¿ä¸»æºè·¯ç±è¡¨ï¼å°ç®çå°åä¸ºNode2å®¹å¨ç½æ®µçæ°æ®åéè¿Node2 ens18ç½å¡å°åä½ä¸ºä¸ä¸è·³å°åã\n\nip r add 172.19.2.0/24 via 10.65.132.188 dev ens18\n\n\n1\n\n\nç®çå°åä¸ºNode1çnet1æ¶ï¼éè¦éç½®éè¿è·¯ç±è¡¨å°è¾¾veth1ç½å¡ï¼ç¶ååè¿å¥å°net1ä¸­ã\n\nip r add 172.19.1.2 dev veth1\n\n\n1\n\n\nåå¨Node2ä¸­éå¤Node1çæä½åå»ºNetwork Namespace net2ï¼å¹¶åå§åç½ç»éç½®ã\n\nip netns add net2\nip link add veth0 type veth peer name veth1\nip link set dev veth0 netns net2\nip netns exec net2 ip addr add 172.19.2.2/24 dev veth0 \nip netns exec net2 ip link set veth0 up\n\nip link set dev veth1 up\nip link set dev veth1 address ee:ee:ee:ee:ee:ee\n\nip netns exec net2 ip r a 169.254.1.1 dev veth0 \nip netns exec net2 ip r a default via 169.254.1.1 dev veth0 \nip r add 172.19.1.0/24 via 10.65.132.187 dev ens18\nip r add 172.19.2.2/32 dev veth1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# 4.2 åæ\n\nå¨Node1 net1ä¸­ping Node2 net2ï¼ç¶åä½¿ç¨tcpdumpçå¬Node1çveth1ï¼ç»æå¦ä¸ï¼\n\n# tcpdump -i veth1 -ne\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on veth1, link-type EN10MB (Ethernet), capture size 262144 bytes\n10:38:29.713322 02:1c:9c:83:87:f2 > Broadcast, ethertype ARP (0x0806), length 42: Request who-has 169.254.1.1 tell 172.19.1.2, length 28\n10:38:30.205862 ee:ee:ee:ee:ee:ee > 02:1c:9c:83:87:f2, ethertype ARP (0x0806), length 42: Reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee, length 28\n10:38:30.205922 02:1c:9c:83:87:f2 > ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 172.19.1.2 > 172.19.2.2: ICMP echo request, id 37475, seq 1, length 64\n10:38:30.206393 ee:ee:ee:ee:ee:ee > 02:1c:9c:83:87:f2, ethertype IPv4 (0x0800), length 98: 172.19.2.2 > 172.19.1.2: ICMP echo reply, id 37475, seq 1, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¯ä»¥çå°ï¼åæ¯åéarpè¯·æ±è·å172.19.1.2çmacå°åï¼å ä¸ºè®¾ç½®äºproxy_arpï¼æä»¥ä¼å°èªèº«çMacå°åè¿è¡åå¤ï¼å¨åé¢çICMPåä¸­ï¼ç®çIPå°åä¸ºç®çå®¹å¨IPå°å172.19.2.2ï¼èç®çMacå°åä¸ºveth1çMacå°åee:ee:ee:ee:ee:ee\n\nåä½¿ç¨tcpdumpçå¬Node2çens18ç½å¡ï¼ç»æå¦ä¸ï¼\n\n# tcpdump -i ens18 host 172.19.2.2 -en\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type EN10MB (Ethernet), capture size 262144 bytes\n10:52:43.993140 fa:16:3e:d3:f6:3a > fa:16:3e:b1:9a:65, ethertype IPv4 (0x0800), length 98: 172.19.1.2 > 172.19.2.2: ICMP echo request, id 4349, seq 1, length 64\n10:52:43.993291 fa:16:3e:b1:9a:65 > fa:16:3e:d3:f6:3a, ethertype IPv4 (0x0800), length 98: 172.19.2.2 > 172.19.1.2: ICMP echo reply, id 4349, seq 1, length 64\n\n\n1\n2\n3\n4\n5\n6\n\n\næ°æ®åä»Node1ä¸­å°è¾¾äºNode2 ens18ç½å¡ï¼æºIPåç®çIPåå«ä¸ºnet1ånet2çIPå°åï¼èmacå°åæ¯Node1åNode2çç©çç½å¡ens18 Macå°å.\n\nä½¿ç¨tcpdumpçå¬veth1ç½å¡ï¼ç»æå¦ä¸ï¼\n\n# tcpdump -i veth1 -en\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on veth1, link-type EN10MB (Ethernet), capture size 262144 bytes\n10:58:13.780247 ee:ee:ee:ee:ee:ee > fa:63:d4:dc:25:01, ethertype IPv4 (0x0800), length 98: 172.19.1.2 > 172.19.2.2: ICMP echo request, id 41971, seq 1, length 64\n10:58:13.780288 fa:63:d4:dc:25:01 > ee:ee:ee:ee:ee:ee, ethertype IPv4 (0x0800), length 98: 172.19.2.2 > 172.19.1.2: ICMP echo reply, id 41971, seq 1, length 64\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥çNode2çè·¯ç±\n\n# ip r\n...\n172.19.2.2 dev veth1 scope link \n...\n\n\n1\n2\n3\n4\n\n\næ°æ®åè¾¾å°Node2 ens18ç½å¡åï¼è§£å¼macå¤´ï¼å°è¾¾ç½ç»åè®®æ ä¸­ï¼éè¿è·¯ç±ï¼å°ç®çå°åä¸º172.19.2.2çæ°æ®åé½è¿å¥å°veth1ç½å¡ä¸­ï¼æç»è¿å¥å°net2ä¸­\n\n\n# 5. IPIPé§éæ¨¡å¼\n\nè¯¥æ¨¡å¼çè§£å³æ¹å¼æ¯å¨ç©çæºAåç©çæºBä¹é´æä¸ä¸ªé§éï¼è¿ä¸ªé§éæä¸¤ä¸ªç«¯ç¹ï¼å¨ç«¯ç¹ä¸è¿è¡å°è£ï¼å°å®¹å¨çIPä½ä¸ºä¹å®¢åè®®æ¾å¨é§ééé¢ï¼èç©çä¸»æºçIPæ¾å¨å¤é¢ä½ä¸ºæ¿è½½åè®®ãè¿æ ·ä¸ç®¡å¤å±çIPéè¿ä¼ ç»çç©çç½ç»ï¼èµ°å¤å°è·³å°è¾¾ç®æ ç©çæºï¼ä»é§éä¸¤ç«¯çèµ·æ¥ï¼ç©çæºAçä¸ä¸è·³å°±æ¯ç©çæºBã",normalizedContent:"# 0. åè¨\n\ncalicoæ¯k8sä¸­å¸¸ç¨çå®¹å¨è§£å³æ¹æ¡çæä»¶ï¼æ¬æä¸»è¦ä»ç»bgpæ¨¡å¼åipipæ¨¡å¼æ¯å¦ä½è§£å³çï¼å¹¶è¯¦ç»äºè§£å¶åçï¼å¹¶éè¿å®éªå æ·±çè§£ã\n\n\n# 1. ä»ç»calico\n\ncalicoæ¯å±äºçº¯3å±çç½ç»æ¨¡åï¼æ¯ä¸ªå®¹å¨é½éè¿ipç´æ¥éä¿¡ï¼ä¸­é´éè¿è·¯ç±è½¬åæ¾å°å¯¹æ¹ãå®¹å¨æå¨çèç¹ç±»ä¼¼äºä¼ ç»çè·¯ç±å¨ï¼æä¾äºè·¯ç±æ¥æ¾çåè½ãæ¯ä¸ªå®¹å¨æå¨çä¸»æºèç¹æ®æ¼äºèæè·¯ç±å¨ ï¼vrouterï¼çåè½ï¼vrouterå¿é¡»ææç§æ¹æ³ï¼è½å¤ç¥éæ´ä¸ªéç¾¤çè·¯ç±ä¿¡æ¯ã\n\nä¹åæå°çflannelhost gatewayæ¨¡å¼æ¹æ¡æ¯ä¸è½è·¨äºå±ç½ç»ï¼æ¯å ä¸ºå®åªè½ä¿®æ¹ä¸»æºè·¯ç±ï¼calicoææ¹è·¯ç±è¡¨çåæ³æ¢æäºæ åçbgpè·¯ç±åè®®ãç¸å½äºå¨æ¯ä¸ªèç¹ä¸æ¨¡æåºä¸ä¸ªé¢å¤çè·¯ç±å¨ï¼ç±äºéç¨çæ¯æ ååè®®ï¼calicoæ¨¡æè·¯ç±å¨çè·¯ç±è¡¨ä¿¡æ¯å¯ä»¥è¢«ä¼ æ­å°ç½ç»çå¶ä»è·¯ç±è®¾å¤ä¸­ï¼è¿æ ·å°±å®ç°äºå¨ä¸å±ç½ç»ä¸çé«éè·¨èç¹ç½ç»ã\n\n> bgpï¼border gateway protocolï¼æ¯ä¸ç§ç¨äºå¨äºèç½ä¸­äº¤æ¢è·¯ç±ä¿¡æ¯çåè®®ãå®æ¯ä¸ç§èªæ²»ç³»ç»ï¼asï¼ä¹é´çè·¯ç±åè®®ï¼ç¨äºå¨ä¸åçèªæ²»ç³»ç»ä¹é´äº¤æ¢è·¯ç±ä¿¡æ¯ãbgpåè®®çä¸»è¦ä½ç¨æ¯å°è·¯ç±ä¿¡æ¯ä»ä¸ä¸ªèªæ²»ç³»ç»ä¼ éå°å¦ä¸ä¸ªèªæ²»ç³»ç»ï¼ä»¥ä¾¿å®ç°äºèç½çå¨çè·¯ç±ã\n\nä½ç°å®ä¸­çç½ç»å¹¶ä¸ä¸å®æ¯æbgpè·¯ç±ï¼å¨è¿ç§æåµä¸å¯ä»¥ä½¿ç¨ipipé§éæ¨¡å¼æ¥ä¼ è¾æ°æ®ã\n\n\n# 2. calioæ¶æ\n\n\n\nfelix\n\nfelixæ¯ä¸ä¸ªå®æ¤ç¨åºï¼ä½ä¸ºagentè¿è¡å¨æç®¡å®¹å¨æèææºçcalicoèç¹ä¸ãfelixè´è´£å·æ°ä¸»æºè·¯ç±åaclè§åç­ï¼ä»¥ä¾¿ä¸ºè¯¥ä¸»æºä¸çendpointæ­£å¸¸è¿è¡æä¾æéçç½ç»è¿æ¥åç®¡çãè¿åºå®¹å¨ãèææºåç©çä¸»æºçæææµéé½ä¼éåcalicoï¼å©ç¨linuxåæ ¸åççè·¯ç±åiptablesçæçè§åã\n\nbgp client\n\ncalicoå¨æ¯ä¸ªè¿è¡felixæå¡çèç¹ä¸é½é¨ç½²ä¸ä¸ªbgp clientï¼bgpå®¢æ·ç«¯ï¼ãbgpå®¢æ·ç«¯çä½ç¨æ¯è¯»åfelixç¼åå°åæ ¸ä¸­çè·¯ç±ä¿¡æ¯ï¼ç±bgpå®¢æ·ç«¯å¯¹è¿äºè·¯ç±ä¿¡æ¯è¿è¡ååãå½felixå°è·¯ç±æå¥linuxåæ ¸æ¶ï¼bgpå®¢æ·ç«¯å°æ¥æ¶å®ä»¬ï¼å¹¶å°å®ä»¬ååå°éç¾¤ä¸­çå¶ä»å·¥ä½èç¹ã\n\nnode-to-node mesh\n\nè¯¥æ¨¡å¼ä¸ºé»è®¤æ¨¡å¼ï¼å¨bgpä¸ï¼éç¾¤ä¸­çæ¯ä¸ä¸ªèç¹çbgp clienté½éè¦åå¶ä»ææèç¹çbgp clientè¿è¡éä¿¡æ¥äº¤æ¢è·¯ç±ã\nä½éçèç¹æ°éå¢å ï¼è¿æ¥æ°ä¼ä»¥n^2è§æ¨¡å¢å ï¼ç»éç¾¤ç½ç»å¸¦æ¥å·¨å¤§çååã\n\nbgp route reflector\n\ncalicoä¼æå®å ä¸ªèç¹è´è´£ä¸é¨è·å¶ä»ææèç¹è¿è¡è¿æ¥å¹¶äº¤æ¢è·¯ç±ä¿¡æ¯ï¼ä»èå­¦ä¹ å°å¨å±çè·¯ç±ä¿¡æ¯ãèå¶ä»èç¹ä¹åªéè¦è·è¿å ä¸ªèç¹è¿è¡éä¿¡æ¥è·åå°æ´ä¸ªéç¾¤çè§åä¿¡æ¯ã\n\n\n\n\n# 3. bgpæ¨¡å¼\n\n\n\næ¯ä¸ªå®¹å¨é½ä¼åå»ºä¸å¯¹veth pairç½å¡ï¼ä¸ç«¯æ¾å¨å®¹å¨åé¨ï¼å¦ä¸ç«¯æ¾å¨å®¿ä¸»æºä¸­ï¼å®¹å¨ä¸­åéçipåéè¿veth pairç½å¡å¯ä»¥è¾¾å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ã\n\nfelixä¼éè¿çå¬etcdæ¥è·åå¶ä»èç¹çç¸å³ä¿¡æ¯ï¼ç¶åæ·»å æ¬å°è·¯ç±ï¼\n\n 1. éå¾å¶ä»èç¹å®¹å¨çipåä¸ä¸æ¡å°å¶èç¹ç©çç½å¡ä¸­ã\n 2. éè¿æ¬æºèç¹å®¹å¨çipåå°calixxxç½å¡ä¸­ï¼ç¶åè¿å¥å°å®¹å¨ä¸­ã\n\nbgp clientä¼è¯»åfelixåå¥å°æ¬å°çè·¯ç±ï¼åéè¿è¿è¡ååå°ç½ç»ä¸­ã\n\n\n# 4. æå¨æ¨¡æbgpæ¨¡å¼å®éª\n\n\n\n\n# 4.1 æä½\n\né¦åå¨node1ä¸­åå»ºnetwork namespaceå½åä¸ºnet1\n\nip netns add net1\n\n\n1\n\n\nç¶ååå»ºä¸å¯¹veth pairè®¾å¤veth0åveth1ï¼å°veth0æ¾å°net1ä¸­ï¼æèµ·å¹¶è®¾ç½®å¥½ipå°å172.19.1.2/24ï¼veth1ä¹æåä½ä¸ç¨è®¾ç½®ipå°åï¼ä½éè¦è®¾ç½®é»è®¤çmacå°åä¸ºee:ee:ee:ee:ee:ee\n\nip link add veth0 type veth peer name veth1\nip link set dev veth0 netns net1\nip netns exec net1 ip link set veth0 up\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\n\nip link set dev veth1 up\nip link set dev veth1 address ee:ee:ee:ee:ee:ee\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nnet1éç½®çè·¯ç±æç¹ææï¼åä¸è¬éç½®çè·¯ç±ä¸åï¼ææçæ¥æé½éè¦éè¿veth0è®¾å¤åéå°ä¸ä¸è·³çå°åä¸º169.254.1.1ï¼èè¿ä¸ªå°åå¨æ´ä¸ªå¹³å°æ¾æ¯ä¸å­å¨çï¼è¿æ¯ä¸ä¸ªé»è®¤çç½å³ï¼é£å¦ä½è¾¾å°è¯¥å°åå¢ï¼\n\nip netns exec net1 ip r a 169.254.1.1 dev veth0 \nip netns exec net1 ip r a default via 169.254.1.1 dev veth0 \n\n\n1\n2\n\n\néè¿è®¾ç½®veth1è®¾å¤proxy_arpï¼å¯ä»¥å¯¹äºä»»ä½arpè¯·æ±å°è¾¾veth1æ¶ï¼é½ååºèªå·±çmacå°åï¼ä¹å°±æ¯ee:ee:ee:ee:ee:ee\n\nå½è®¿é®ç½å³çæ¶åï¼é¦åæ¯éè¦è¿è¡arpè¯·æ±ï¼è¯·æ±éè¿veth0è®¾å¤è¾¾å°äºveth1ä¸­ï¼å ä¸ºè®¾ç½®proxy_arpï¼ä¼å°èªèº«çmacå°åee:ee:ee:ee:ee:eeä½ä¸ºarpåå¤ã\n\nèå®¹å¨çåç»­æ¥æç®çipå°åæ¯ç®çå®¹å¨çipå°åï¼èmacå°ååæäºç½å³macå°åee:ee:ee:ee:ee:eeï¼èç½å³çipå°åå¹¶ä¸ä¼åºç°å¨ä»»ä½çæ°æ®åä¸­ï¼ä¹æ²¡äººå³å¿è¿ä¸ªå·ä½çå°åæ¯ä»ä¹ï¼åªè¦è½æ¾å°arpå°±è¡ã\n\necho 1 > /proc/sys/net/ipv4/conf/veth1/proxy_arp\n\n\n1\n\n\næ°æ®åå·²ç»ä»net1ä¸­éè¿veth1ä½ä¸ºç½å³è¾¾å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ï¼åéè¿è®¾ç½®å®¿ä¸»æºè·¯ç±è¡¨ï¼å°ç®çå°åä¸ºnode2å®¹å¨ç½æ®µçæ°æ®åéè¿node2 ens18ç½å¡å°åä½ä¸ºä¸ä¸è·³å°åã\n\nip r add 172.19.2.0/24 via 10.65.132.188 dev ens18\n\n\n1\n\n\nç®çå°åä¸ºnode1çnet1æ¶ï¼éè¦éç½®éè¿è·¯ç±è¡¨å°è¾¾veth1ç½å¡ï¼ç¶ååè¿å¥å°net1ä¸­ã\n\nip r add 172.19.1.2 dev veth1\n\n\n1\n\n\nåå¨node2ä¸­éå¤node1çæä½åå»ºnetwork namespace net2ï¼å¹¶åå§åç½ç»éç½®ã\n\nip netns add net2\nip link add veth0 type veth peer name veth1\nip link set dev veth0 netns net2\nip netns exec net2 ip addr add 172.19.2.2/24 dev veth0 \nip netns exec net2 ip link set veth0 up\n\nip link set dev veth1 up\nip link set dev veth1 address ee:ee:ee:ee:ee:ee\n\nip netns exec net2 ip r a 169.254.1.1 dev veth0 \nip netns exec net2 ip r a default via 169.254.1.1 dev veth0 \nip r add 172.19.1.0/24 via 10.65.132.187 dev ens18\nip r add 172.19.2.2/32 dev veth1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# 4.2 åæ\n\nå¨node1 net1ä¸­ping node2 net2ï¼ç¶åä½¿ç¨tcpdumpçå¬node1çveth1ï¼ç»æå¦ä¸ï¼\n\n# tcpdump -i veth1 -ne\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on veth1, link-type en10mb (ethernet), capture size 262144 bytes\n10:38:29.713322 02:1c:9c:83:87:f2 > broadcast, ethertype arp (0x0806), length 42: request who-has 169.254.1.1 tell 172.19.1.2, length 28\n10:38:30.205862 ee:ee:ee:ee:ee:ee > 02:1c:9c:83:87:f2, ethertype arp (0x0806), length 42: reply 169.254.1.1 is-at ee:ee:ee:ee:ee:ee, length 28\n10:38:30.205922 02:1c:9c:83:87:f2 > ee:ee:ee:ee:ee:ee, ethertype ipv4 (0x0800), length 98: 172.19.1.2 > 172.19.2.2: icmp echo request, id 37475, seq 1, length 64\n10:38:30.206393 ee:ee:ee:ee:ee:ee > 02:1c:9c:83:87:f2, ethertype ipv4 (0x0800), length 98: 172.19.2.2 > 172.19.1.2: icmp echo reply, id 37475, seq 1, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¯ä»¥çå°ï¼åæ¯åéarpè¯·æ±è·å172.19.1.2çmacå°åï¼å ä¸ºè®¾ç½®äºproxy_arpï¼æä»¥ä¼å°èªèº«çmacå°åè¿è¡åå¤ï¼å¨åé¢çicmpåä¸­ï¼ç®çipå°åä¸ºç®çå®¹å¨ipå°å172.19.2.2ï¼èç®çmacå°åä¸ºveth1çmacå°åee:ee:ee:ee:ee:ee\n\nåä½¿ç¨tcpdumpçå¬node2çens18ç½å¡ï¼ç»æå¦ä¸ï¼\n\n# tcpdump -i ens18 host 172.19.2.2 -en\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type en10mb (ethernet), capture size 262144 bytes\n10:52:43.993140 fa:16:3e:d3:f6:3a > fa:16:3e:b1:9a:65, ethertype ipv4 (0x0800), length 98: 172.19.1.2 > 172.19.2.2: icmp echo request, id 4349, seq 1, length 64\n10:52:43.993291 fa:16:3e:b1:9a:65 > fa:16:3e:d3:f6:3a, ethertype ipv4 (0x0800), length 98: 172.19.2.2 > 172.19.1.2: icmp echo reply, id 4349, seq 1, length 64\n\n\n1\n2\n3\n4\n5\n6\n\n\næ°æ®åä»node1ä¸­å°è¾¾äºnode2 ens18ç½å¡ï¼æºipåç®çipåå«ä¸ºnet1ånet2çipå°åï¼èmacå°åæ¯node1ånode2çç©çç½å¡ens18 macå°å.\n\nä½¿ç¨tcpdumpçå¬veth1ç½å¡ï¼ç»æå¦ä¸ï¼\n\n# tcpdump -i veth1 -en\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on veth1, link-type en10mb (ethernet), capture size 262144 bytes\n10:58:13.780247 ee:ee:ee:ee:ee:ee > fa:63:d4:dc:25:01, ethertype ipv4 (0x0800), length 98: 172.19.1.2 > 172.19.2.2: icmp echo request, id 41971, seq 1, length 64\n10:58:13.780288 fa:63:d4:dc:25:01 > ee:ee:ee:ee:ee:ee, ethertype ipv4 (0x0800), length 98: 172.19.2.2 > 172.19.1.2: icmp echo reply, id 41971, seq 1, length 64\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥çnode2çè·¯ç±\n\n# ip r\n...\n172.19.2.2 dev veth1 scope link \n...\n\n\n1\n2\n3\n4\n\n\næ°æ®åè¾¾å°node2 ens18ç½å¡åï¼è§£å¼macå¤´ï¼å°è¾¾ç½ç»åè®®æ ä¸­ï¼éè¿è·¯ç±ï¼å°ç®çå°åä¸º172.19.2.2çæ°æ®åé½è¿å¥å°veth1ç½å¡ä¸­ï¼æç»è¿å¥å°net2ä¸­\n\n\n# 5. ipipé§éæ¨¡å¼\n\nè¯¥æ¨¡å¼çè§£å³æ¹å¼æ¯å¨ç©çæºaåç©çæºbä¹é´æä¸ä¸ªé§éï¼è¿ä¸ªé§éæä¸¤ä¸ªç«¯ç¹ï¼å¨ç«¯ç¹ä¸è¿è¡å°è£ï¼å°å®¹å¨çipä½ä¸ºä¹å®¢åè®®æ¾å¨é§ééé¢ï¼èç©çä¸»æºçipæ¾å¨å¤é¢ä½ä¸ºæ¿è½½åè®®ãè¿æ ·ä¸ç®¡å¤å±çipéè¿ä¼ ç»çç©çç½ç»ï¼èµ°å¤å°è·³å°è¾¾ç®æ ç©çæºï¼ä»é§éä¸¤ç«¯çèµ·æ¥ï¼ç©çæºaçä¸ä¸è·³å°±æ¯ç©çæºbã",charsets:{cjk:!0},lastUpdated:"2023/07/07, 08:56:29",lastUpdatedTimestamp:1688691389e3},{title:"çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç",frontmatter:{title:"çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç",date:"2023-06-01T12:56:36.000Z",permalink:"/pages/d9d0ce/",categories:["äºåç","k8s"],tags:["k8s","å®¹å¨","äºåç","è®¡ç®æºç½ç»","Linuxç½ç»èæå"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦ä»ç»flannelå¨k8sç½ç»ä¸­ä½ä¸ºç½ç»æä»¶éè¿UDPãVXLANãHOST-GATEWAYä¸ç§æ¨¡å¼æ¥è§£å³å®¹å¨è·¨ä¸»æºç½ç»éä¿¡çï¼å¹¶éè¿æå¨å®ç°è¿ä¸ç§æ¨¡å¼æ·±å¥çè§£å¶åçã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603100424.png"},{name:"twitter:title",content:"çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç"},{name:"twitter:description",content:"æ¬æä¸»è¦ä»ç»flannelå¨k8sç½ç»ä¸­ä½ä¸ºç½ç»æä»¶éè¿UDPãVXLANãHOST-GATEWAYä¸ç§æ¨¡å¼æ¥è§£å³å®¹å¨è·¨ä¸»æºç½ç»éä¿¡çï¼å¹¶éè¿æå¨å®ç°è¿ä¸ç§æ¨¡å¼æ·±å¥çè§£å¶åçã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603100424.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/14.%E7%90%86%E8%A7%A3flannel%E7%9A%84%E4%B8%89%E7%A7%8D%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86.html"},{property:"og:type",content:"article"},{property:"og:title",content:"çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç"},{property:"og:description",content:"æ¬æä¸»è¦ä»ç»flannelå¨k8sç½ç»ä¸­ä½ä¸ºç½ç»æä»¶éè¿UDPãVXLANãHOST-GATEWAYä¸ç§æ¨¡å¼æ¥è§£å³å®¹å¨è·¨ä¸»æºç½ç»éä¿¡çï¼å¹¶éè¿æå¨å®ç°è¿ä¸ç§æ¨¡å¼æ·±å¥çè§£å¶åçã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603100424.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/14.%E7%90%86%E8%A7%A3flannel%E7%9A%84%E4%B8%89%E7%A7%8D%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-06-01T12:56:36.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"å®¹å¨"},{property:"article:tag",content:"äºåç"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"Linuxç½ç»èæå"},{itemprop:"name",content:"çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç"},{itemprop:"description",content:"æ¬æä¸»è¦ä»ç»flannelå¨k8sç½ç»ä¸­ä½ä¸ºç½ç»æä»¶éè¿UDPãVXLANãHOST-GATEWAYä¸ç§æ¨¡å¼æ¥è§£å³å®¹å¨è·¨ä¸»æºç½ç»éä¿¡çï¼å¹¶éè¿æå¨å®ç°è¿ä¸ç§æ¨¡å¼æ·±å¥çè§£å¶åçã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603100424.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/14.%E7%90%86%E8%A7%A3flannel%E7%9A%84%E4%B8%89%E7%A7%8D%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86.html",relativePath:"01.äºåç/07.k8s/14.çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç.md",key:"v-44e743b8",path:"/pages/d9d0ce/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. flannelå¨å±ç½ç»å°ååéæºå¶",slug:"_1-flannelå¨å±ç½ç»å°ååéæºå¶",normalizedTitle:"1. flannelå¨å±ç½ç»å°ååéæºå¶",charIndex:102},{level:2,title:"2. UDPæ¨¡å¼",slug:"_2-udpæ¨¡å¼",normalizedTitle:"2. udpæ¨¡å¼",charIndex:353},{level:3,title:"2.1 ç®ä»",slug:"_2-1-ç®ä»",normalizedTitle:"2.1 ç®ä»",charIndex:366},{level:3,title:"2.2 flannelå®ç°UDPæµç¨",slug:"_2-2-flannelå®ç°udpæµç¨",normalizedTitle:"2.2 flannelå®ç°udpæµç¨",charIndex:542},{level:3,title:"2.3 æå¨æ¨¡æflannelå®ç°udpå®éª",slug:"_2-3-æå¨æ¨¡æflannelå®ç°udpå®éª",normalizedTitle:"2.3 æå¨æ¨¡æflannelå®ç°udpå®éª",charIndex:975},{level:3,title:"2.4 åæ",slug:"_2-4-åæ",normalizedTitle:"2.4 åæ",charIndex:4474},{level:2,title:"3. VXLANæ¨¡å¼",slug:"_3-vxlanæ¨¡å¼",normalizedTitle:"3. vxlanæ¨¡å¼",charIndex:5076},{level:3,title:"3.1 ç®ä»",slug:"_3-1-ç®ä»",normalizedTitle:"3.1 ç®ä»",charIndex:5091},{level:3,title:"3.3 flannelå®ç°vxlanæ¨¡å¼æµç¨",slug:"_3-3-flannelå®ç°vxlanæ¨¡å¼æµç¨",normalizedTitle:"3.3 flannelå®ç°vxlanæ¨¡å¼æµç¨",charIndex:5396},{level:3,title:"3.4 æå¨æ¨¡æflanneldç»´æ¤VTEPç»å®è·µ",slug:"_3-4-æå¨æ¨¡æflanneldç»´æ¤vtepç»å®è·µ",normalizedTitle:"3.4 æå¨æ¨¡æflanneldç»´æ¤vtepç»å®è·µ",charIndex:5837},{level:2,title:"4. Host Gatewayæ¨¡å¼",slug:"_4-host-gatewayæ¨¡å¼",normalizedTitle:"4. host gatewayæ¨¡å¼",charIndex:8588},{level:3,title:"4.1 ç®ä»",slug:"_4-1-ç®ä»",normalizedTitle:"4.1 ç®ä»",charIndex:8610},{level:3,title:"4.3 flannelå®ç°Host Gatewayæ¨¡å¼æµç¨",slug:"_4-3-flannelå®ç°host-gatewayæ¨¡å¼æµç¨",normalizedTitle:"4.3 flannelå®ç°host gatewayæ¨¡å¼æµç¨",charIndex:8879},{level:3,title:"4.4 æå¨æ¨¡æflannelå®ç°Host Gatewayæ¨¡å¼å®éª",slug:"_4-4-æå¨æ¨¡æflannelå®ç°host-gatewayæ¨¡å¼å®éª",normalizedTitle:"4.4 æå¨æ¨¡æflannelå®ç°host gatewayæ¨¡å¼å®éª",charIndex:9078},{level:2,title:"5. å·¨äººçè©è",slug:"_5-å·¨äººçè©è",normalizedTitle:"5. å·¨äººçè©è",charIndex:10926}],headersStr:"0. åè¨ 1. flannelå¨å±ç½ç»å°ååéæºå¶ 2. UDPæ¨¡å¼ 2.1 ç®ä» 2.2 flannelå®ç°UDPæµç¨ 2.3 æå¨æ¨¡æflannelå®ç°udpå®éª 2.4 åæ 3. VXLANæ¨¡å¼ 3.1 ç®ä» 3.3 flannelå®ç°vxlanæ¨¡å¼æµç¨ 3.4 æå¨æ¨¡æflanneldç»´æ¤VTEPç»å®è·µ 4. Host Gatewayæ¨¡å¼ 4.1 ç®ä» 4.3 flannelå®ç°Host Gatewayæ¨¡å¼æµç¨ 4.4 æå¨æ¨¡æflannelå®ç°Host Gatewayæ¨¡å¼å®éª 5. å·¨äººçè©è",content:'# 0. åè¨\n\næ¬æä¸»è¦ä»ç»flannelå¨k8sç½ç»ä¸­ä½ä¸ºç½ç»æä»¶éè¿UDPãVXLANãHOST-GATEWAYä¸ç§æ¨¡å¼æ¥è§£å³å®¹å¨è·¨ä¸»æºç½ç»éä¿¡çï¼å¹¶éè¿æå¨å®ç°è¿ä¸ç§æ¨¡å¼æ·±å¥çè§£å¶åçã\n\n\n# 1. flannelå¨å±ç½ç»å°ååéæºå¶\n\næ¯å°èç¹ä¸å®¹å¨çIPå°åæ¯ç±æå±èç¹èªå¨åéçï¼é£ä¹ä¼å­å¨ä¸ä¸ªé®é¢æ¯ï¼ä¸åèç¹ä¸çå®¹å¨æåéçIPå°ååå¯è½ä¼æéå¤çæåµã\n\nflannelè®¾è®¡äºä¸ç§å¨å±çç½ç»å°ååéæºå¶ï¼flannelä¼ä¸ºæ¯å°èç¹ç³è¯·ä¸ä¸ªç¬ä¸æ äºçç½æ®µï¼å¹¶å­å¨å¨etcdä¸­ï¼flannelä¼å°è¯¥ç½æ®µéç½®å°åä¸ªèç¹ä¸çDocker(æèå¶ä»å®¹å¨å·¥å·)ï¼å½åèç¹ä¸çå®¹å¨ åªä»åéçç½æ®µéä¸­è·åIPå°åã\n\n> ä¿®æ¹dockerå¯å¨åæ°--bipæ¥éå¶èç¹å®¹å¨è·å¾çIPèå´ã\n\n\n\n\n# 2. UDPæ¨¡å¼\n\n\n# 2.1 ç®ä»\n\nå¨FlannelçUDPæ¨¡å¼ä¸­ï¼æ¯ä¸ªèç¹é½ä¼å¯å¨ä¸ä¸ªUDPæå¡å¨ï¼ç¨äºçå¬æ¥èªå¶ä»èç¹çæ°æ®åãå½ä¸ä¸ªå®¹å¨åå¦ä¸ä¸ªå®¹å¨åéæ°æ®åæ¶ï¼å®ä¼å°æ°æ®ååéå°ç®æ å®¹å¨çIPå°ååç«¯å£å·ãFlannelä¼å°è¯¥æ°æ®åå°è£å¨ä¸ä¸ªUDPæ°æ®åä¸­ï¼å¹¶å°å¶åéå°ç®æ èç¹çUDPæå¡å¨ãç®æ èç¹çUDPæå¡å¨ä¼è§£æè¯¥æ°æ®åï¼å¹¶å°å¶ä¼ éç»ç®æ å®¹å¨ã\n\n\n# 2.2 flannelå®ç°UDPæµç¨\n\n\n\nflanneldå¯å¨åä¼éè¿æå¼/dev/net/tunçæ¹å¼åå»ºtunè®¾å¤ï¼åç§°ä¸ºflannel0ï¼è¯¥è®¾å¤æ¯ç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®åäº¤äºçééãç¶ååå°ä»tunè®¾å¤è·åçIPæ°æ®åå°è£å°UDPæ°æ®åä¸­éè¿ç©çç½å¡åéå°å¶ä»èç¹ä¸­ï¼åæ ¸éè¿UDPç«¯å£è½¬åç»flanneldç¶åè§£åï¼å¾å°å¶ä¸­çIPæ°æ®åï¼ç¶ååéè¿tunè®¾å¤è¿å¥åæ ¸ç©ºé´ä¸­ï¼éè¿è·¯ç±å°è¾¾ç½æ¡¥ï¼ç¶ååå°ç®çå®¹å¨ä¸­ã\n\nflanneldå¨å¶ä¸­ä¸»è¦åäºï¼\n\n 1. å¼å¯äºudpæå¡ï¼å¹¶å¯¹udpæ°æ®åå°ååè§£å\n 2. èç¹ä¸è·¯ç±è¡¨çå¨ææ´æ°ï¼ä¹å°±æ¯ä»ç½æ¡¥åºæ¥çæ°æ®åç®çIPä¸ºå¶ä»èç¹å®¹å¨IPæ¶ï¼éè¦è·¯ç±å°flanneldä¸­è¿è¡å°åï¼å¹¶ä¸å¨flanneldæ¥æ¶UDPååè§£å°åºæ¥çIPåéè¦éè¿è·¯ç±å°ç½æ¡¥docker0ä¸­\n\nç¼ºç¹å¾ææ¾ï¼ä»ä¸æ¬¡ç½ç»ä¼ è¾çæ°æ®åç»åäº2æ¬¡ç¨æ·æä¸åæ ¸æçåæ¢ï¼èåæ¢çæçæ¯ä¸é«çï¼æ¯ä¸æ¬¡çåæ¢é½æ¯ä¸æ¬¡æ°æ®çå¤å¶ã\n\n\n\n\n# 2.3 æå¨æ¨¡æflannelå®ç°udpå®éª\n\né¦ååå»ºNetwork Namesapce net1ç¨æ¥æ¨¡æå®¹å¨\n\nip netns add net1\n\n\n1\n\n\nç¶ååå»ºä¸å¯¹veth pairç½å¡veth0åveth1ï¼å¹¶å°veth0æ¾å°net1ä¸­ï¼æèµ·å¹¶è®¾ç½®veth0çipå°åä¸º172.19.1.2/24\n\nip link add veth0 type veth peer name veth1\n\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n\n1\n2\n3\n4\n5\n\n\nåå»ºç½æ¡¥è®¾å¤ï¼æèµ·å¹¶è®¾ç½®ipå°åä¸º172.19.1.1/24ï¼å°veth1æèµ·å¹¶ç»å®å°ç½æ¡¥bridge0ä¸­\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.1.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¨net1ä¸­æ·»å é»è®¤è·¯ç±ï¼è®¾ç½®ä¸ä¸æ¡å°åä¸ºç½æ¡¥bridge0çIPå°åï¼ä»ç½æ¡¥è¿å¥å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ã\n\nip netns exec net1 ip r add default via 172.19.1.1 dev veth0\n\n\n1\n\n\nåè¿è¡ä»¥ä¸ä»£ç ï¼è¯¥ä»£ç æ¯ç¨æ¥æ¨¡æflanneldç¨åºï¼ä¸»è¦ä½ç¨æ¯åå»ºäºtunè®¾å¤flannel0ï¼å¼å¯äºUDPæå¡æ¶åUDPåï¼ç¶åå°±æ¯å¯¹å®¹å¨IPåçå°è£ä¸è§£å°ã\n\nimport os\nimport socket\nimport struct\nimport threading\nfrom fcntl import ioctl\nimport click\n\nBIND_ADDRESS = (\'0.0.0.0\', 8285)\nBUFFER_SIZE = 4096\n\nTUNSETIFF = 0x400454ca\nIFF_TUN = 0x0001\nIFF_TAP = 0x0002\n\n\ndef create_tunnel(tun_name=\'flannel%d\', tun_mode=IFF_TUN):\n    tun_fd = os.open("/dev/net/tun", os.O_RDWR)\n    ifn = ioctl(tun_fd, TUNSETIFF, struct.pack(b"16sH", tun_name.encode(), tun_mode))\n    tun_name = ifn[:16].decode().strip("\\x00")\n    return tun_fd, tun_name\n\n\ndef start_tunnel(tun_name):\n    os.popen(f"ip link set {tun_name} up")\n\n\ndef udp_server(udp_socket, tun_fd):\n    while True:\n        data, addr = udp_socket.recvfrom(2048)\n        print("get data from udp.")\n        if not data:\n            break\n\n        os.write(tun_fd, data)\n\n\n@click.command()\n@click.option("--peer_node_ip", "-p", required=True, help="å¯¹ç«¯èç¹IP")\ndef main(peer_node_ip):\n    peer_node_addr = (peer_node_ip, 7000)\n\n    tun_fd, tun_name = create_tunnel()\n    start_tunnel(tun_name)\n\n    udp_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n    udp_socket.bind(BIND_ADDRESS)\n\n    t = threading.Thread(target=udp_server, args=(udp_socket, tun_fd))\n    t.daemon = True\n    t.start()\n\n    while True:\n        data = os.read(tun_fd, BUFFER_SIZE)\n        print(f"get data from tun. data size = {len(data)}")\n        udp_socket.sendto(data, peer_node_addr)\n\n\nif __name__ == \'__main__\':\n    main()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n\n\nå¨Node1ä¸­è¿è¡è¯¥ç¨åºï¼è®¾ç½®Node2 IP\n\npython3 tun_app.py -p 10.65.132.188\n\n\n1\n\n\nå¯ä»¥çå°å·²ç»åå»ºäºtunè®¾å¤\n\n# ip link show flannel0\n...\n109: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet6 fe80::8e98:91a4:6537:d77a/64 scope link flags 800 \n       valid_lft forever preferred_lft forever\n...\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå¨è®¾ç½®å®¿ä¸»æºçè·¯ç±ï¼å°ææå°Node2å®¹å¨çIPåï¼é½è½¬åå°flannel0è®¾å¤ä¸­ã\n\nip r add 172.19.2.0/24 dev flannel0\n\n\n1\n\n\næåéå¤Node1çæä½éç½®Node2\n\n# åå»ºnet3\nip netns add net3\n\n# åå»ºveth pair\nip link add veth0 type veth peer name veth1\n\n# è®¾ç½®net1ç½ç»\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.2.2/24 dev veth0\nip netns exec net3 ip link set veth0 up\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.2.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n# éç½®net3è·¯ç±\nip netns exec net3 ip r add default via 172.19.2.1 dev veth0\n\n# åå»ºflannel0\npython3 flanneld.py -p 10.65.132.187\n\n# éç½®å°flannel0çè·¯ç±\nip r add 172.19.1.0/24 dev flannel0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n\n\n\n# 2.4 åæ\n\nå¨Node1çnet1ä¸­ping Node2çnet2çip 172.19.2.2ï¼å¯ä»¥çå°æ¯å¯ä»¥pingéç\n\n# ping 172.19.2.2 -c 1\nPING 172.19.2.2 (172.19.2.2) 56(84) bytes of data.\n64 bytes from 172.19.2.2: icmp_seq=1 ttl=63 time=0.641 ms\n\n--- 172.19.2.2 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 0.641/0.641/0.641/0.000 ms\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå¨Node1çflanneld.pyä¸­çå°æ¥å¿ï¼ä»tunä¸­æ¶å°äºæ¥èªå®¹å¨çIPæ°æ®å\n\n# python3 flanneld.py -p 10.65.132.188\nget data from tun. data size = 88\n\n\n1\n2\n\n\nå¨Node2çflanneld.pyä¸­çå°æ¥å¿ï¼æ¥æ¶å°äºNode1åéè¿æ¥çudpæ°æ®åã\n\n# python3 flanneld.py -p 10.65.132.187\nget data from udp.\n\n\n1\n2\n\n\n\n# 3. VXLANæ¨¡å¼\n\n\n# 3.1 ç®ä»\n\nå¨FlannelçVXLANæ¨¡å¼ä¸­ï¼æ¯ä¸ªèç¹é½ä¼å¯å¨ä¸ä¸ªVXLANé§éï¼ç¨äºå°å®¹å¨ä¹é´çæ°æ®åå°è£å¨VXLANåè®®ä¸­è¿è¡ä¼ è¾ãå½ä¸ä¸ªå®¹å¨åå¦ä¸ä¸ªå®¹å¨åéæ°æ®åæ¶ï¼å®ä¼å°æ°æ®ååéå°ç®æ å®¹å¨çIPå°ååèæç½ç»IDãFlannelä¼å°è¯¥æ°æ®åå°è£å¨ä¸ä¸ªVXLANæ°æ®åä¸­ï¼å¹¶å°å¶åéå°ç®æ èç¹çVXLANé§éãç®æ èç¹çVXLANé§éä¼è§£æè¯¥æ°æ®åï¼å¹¶å°å¶ä¼ éç»ç®æ å®¹å¨ã\n\nvxlanæ¨¡å¼ä¹æ¯éè¿å°åä¸è§£åçå½¢å¼æ¥å®ç°é§éè¾¾å°å®¹å¨çè·¨ä¸»æºè®¿é®ï¼é£åUDPæ¨¡å¼æä»ä¹åºå«å¢ï¼ åºå«å¨äºï¼VXLANçå°åä¸è§£åé½æ¯å¨åæ ¸æå®æçï¼å¯¹æ¯UDPæ¨¡å¼ç¨æ·æä¸åæ ¸æçåæ¢æ¥è¯´ï¼æçå¤§å¤§çæåäºã\n\n\n# 3.3 flannelå®ç°vxlanæ¨¡å¼æµç¨\n\n\n\nå¨Node1çnet1ä¸­ping Node2çnet3ï¼æ°æ®æµå¦ä¸ï¼\n\n 1. bridgeä½ä¸ºnet1çä¸ä¸è·³ç½å³ï¼æä»¥ä¼ååéARPè·åbridgeçmacå°å\n 2. è·åå°åï¼ç¶ååéICMPæ°æ®åéè¿bridgeè¿å¥å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ï¼éè¿è·¯ç±è¡¨ï¼ä¼è¿å¥å°flannel.1ä¸­ï¼ä¸ä¸è·³å°åä¸ºNode2çflannel.1çå°å\n 3. æ¬æ¥æ¯è¦åéARPæ¥è·åNode2çflannel.1çå°åï¼å ä¸ºå·²ç»æå¨éç½®äºARPè¡¨ï¼å¯ä»¥ç´æ¥è·åå°å°MACå°åï¼ç¶åå°å¶å¡«ååå±äºå±å¤´ä¸­ã\n 4. åéè¿æ¥è¯¢FDBè¡¨ï¼æ¾å°å¤å±UDPåä¸­ç®çIPå°åï¼ä¹å°±æ¯Node2çIPå°åï¼å¡«åå°å¤é¨IPå¤´ä¸­ãæç»éè¿ç©çç½å¡ens18èµ°å¤é¨ç½ç»è¾¾å°Node2ä¸­ã\n 5. è¾¾å°Node2åï¼éè¿ç«¯å£8472ï¼å°åè½¬åç»VTEPè®¾å¤flannel.1è¿è¡è§£åï¼è§£å°åçIPåç»è¿è·¯ç±è¡¨è¾¾å°bridgeä¸­ï¼æç»è½¬åå°net3ä¸­ã\n\n\n# 3.4 æå¨æ¨¡æflanneldç»´æ¤VTEPç»å®è·µ\n\nåå»ºVTEPè®¾å¤å½åä¸ºflannel.1ï¼ç¶åflannel.1éç½®ipå°åä¸º172.19.1.0/32\n\n# æ·»å VTEPè®¾å¤\nip link add flannel.1 type vxlan id 42 dstport 8472 local 10.65.132.187 dev ens18 nolearning proxy\n\n# éç½®flannel.1\nip link set flannel.1 up\nip a add 172.19.1.0/32 dev flannel.1\n\n\n1\n2\n3\n4\n5\n6\n\n * åªéè¦å¡«ålocalå°å\n * nolearningï¼VTEPä¸è¦éè¿æ¶å°çæ¥æå­¦ä¹ FDBè¡¨é¡¹çåå®¹ï¼åå°å¹¿æ­é£æ´ï¼æé«æçã\n * proxyï¼VTEPæ¿æARPä»£çåè½ï¼æ¶å°ARPè¯·æ±æ¶ï¼å¦ææç¼å­åç´æ¥åºç­ï¼åå°å¹¿æ­é£æ´ï¼æé«æçã\n\næ·»å network namespace net1ï¼åå»ºveth pairï¼å°å¶ä¸­ä¸ç«¯æ¾è¿net1ä¸­ï¼å¹¶éç½®å¥½ipå°åï¼åæ·»å é»è®¤è·¯ç±é½èµ°veth0\n\nip netns add net1\nip link add veth0 type veth peer name veth1\nip link set dev veth0 up\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n# é»è®¤è·¯ç±\nip netns exec net1 ip r add default via 172.19.1.1 dev veth0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nåå»ºç½æ¡¥è®¾å¤å½åä¸ºbridge0ï¼å¹¶å°veth1æå°å¶ä¸\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.1.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå°è¾¾net3çæ°æ®åä¸ä¸è·³ä¸ºNode2çVTEPè®¾å¤IPéè¿flannel.1è®¾å¤ï¼éè¦æ·»å onlinkï¼å ä¸ºä¸ä¸è·³ç½å³ä¸åæ¬å°å°åå¨åä¸ç½æ®µï¼è·¯ç±æ·»å æ¶è¾åºè·¯ç±ä¸å¯è¾¾çéè¯¯ï¼onlinkçæä¹å¨äºåè®®æ è½ç¶æ¾ä¸å°é¾è·¯å±ç´è¿è·¯ç±ï¼ä½æ¯è¿æ¯ä¼åå¸éå¯¹viaç½å³çarpè¯·æ±ç.\n\nip r add 172.19.2.0/24 via 172.19.2.0 dev flannel.1 onlink\n\n\n1\n\n\nå¨Node2èç¹ä¸­éå¤ä¸é¢æä½åå»ºVETPè®¾å¤åç¸å³ç½ç»éç½®\n\n# æ·»å VTEPè®¾å¤\nip link add flannel.1 type vxlan id 42 dstport 8472 local 10.65.132.188 dev ens18\nip link set flannel.1 up\nip a add 172.19.2.0/32 dev flannel.1\nip r add 172.19.1.0/24 via 172.19.1.0 dev flannel.1 onlink\n\n\n# æ·»å net3æ¨¡æå®¹å¨\nip netns add net3\nip link add veth0 type veth peer name veth1\n\n# è®¾ç½®net3ä¸­ç½ç»éç½®\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.2.2/24 dev veth0\nip netns exec net3 ip link set veth0 up\nip netns exec net3 ip r add default dev veth0\nip netns exec net3 ip r add default via 172.19.2.1 dev veth0\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip a add 172.19.2.1/24 dev bridge0\nip link set bridge0 up\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\nå¨Node1èç¹ä¸­éè¦åæ°å¢ARPç¼å­ï¼Node1ä¸­æ·»å è·¯ç±çä¸ä¸è·³å°åæ¯Node2çVTEPè®¾å¤ï¼æä»¥éè¦å¨arpæ·»å VTEP IPåMACå°åçç¼å­ã\n\narp -s 172.19.2.0 8a:8b:4d:10:82:56 dev flannel.1\n\n\n1\n\n\nåå¨èç¹FDBè¡¨ä¸­æ·»å å¯¹ç«¯VETP MACå°ååå¯¹å¤IPï¼ç©çç½å¡IPï¼çæ å°å³ç³»è¡¨é¡¹\n\nbridge fdb add 8a:8b:4d:10:82:56 dev flannel.1 dst 10.65.132.188\n\n\n1\n\n\néå¤Node1æä½ï¼éç½®Node2çARPç¼å­åFDBè¡¨ã\n\narp -s 172.19.1.0 1e:b7:5e:19:ab:90 dev flannel.1\nbridge fdb add 1e:b7:5e:19:ab:90 dev flannel.1 dst 10.65.132.187\n\n\n1\n2\n\n\néè¿ä»¥ä¸æä½å®æäºç¯å¢çæ­å»ºï¼æ¥ä¸æ¥ï¼æä»¬å¨Node1çnet1ä¸­è¿è¡ping Node2çnet3ï¼å¯ä»¥åç°æ¯å¯ä»¥pingéç\n\n# ip netns exec net1 ping 172.19.2.2 -c 2\nPING 172.19.2.2 (172.19.2.2) 56(84) bytes of data.\n64 bytes from 172.19.2.2: icmp_seq=1 ttl=62 time=0.547 ms\n64 bytes from 172.19.2.2: icmp_seq=2 ttl=62 time=0.560 ms\n\n\n1\n2\n3\n4\n\n\n\n# 4. Host Gatewayæ¨¡å¼\n\n\n# 4.1 ç®ä»\n\néè¿æä¸»æºå½ä½ç½å³å®ç°è·¨èç¹ç½ç»éä¿¡çãå æ­¤éä¿¡åæ¹çå®¿ä¸»æºè¦æ±è½å¤ç´æ¥è·¯ç±ï¼å¿é¡»å¨åä¸ä¸ªç½ç»ï¼è¿ä¸ªéå¶ä½¿å¾host-gwæ¨¡å¼æ æ³éç¨äºéç¾¤è§æ¨¡è¾å¤§ä¸éè¦å¯¹èç¹è¿è¡ç½æ®µååçåºæ¯ãhost-gwçå¦å¤ä¸ä¸ªéå¶åæ¯éçéç¾¤ä¸­èç¹è§æ¨¡çå¢å¤§ï¼flanneldç»´æ¤ä¸»æºä¸æåä¸ä¸æ¡è·¯ç±è¡¨çå¨ææ´æ°ä¹æ¯ä¸ä¸ªä¸å°çååã\n\nflanneldçå¯ä¸ä½ç¨å°±æ¯è´è´£ä¸»æºä¸è·¯ç±è¡¨çå¨æï¼ä½å ä¸ºåªè½ä¿®æ¹ä¸»æºçè·¯ç±ï¼æä»¥åä¸ªä¸»æºå¿é¡»äºå±ç½ç»äºéã\n\nè·VXLANæ¨¡å¼åUDPæ¨¡å¼æ¯è¾ï¼ä¼ç¹ä¸»è¦æ¯æ²¡æå°åä¸è§£åçæä½ï¼å¤§å¤§çæé«äºæ§è½ã\n\n\n# 4.3 flannelå®ç°Host Gatewayæ¨¡å¼æµç¨\n\n\n\nå¨Node1çnet1ä¸­ping Node2çnet3ï¼æ°æ®æµå¦ä¸ï¼\n\n 1. æ°æ®åä»å®¹å¨è¿å¥å°å®¿ä¸»æºç½ç»åè®®æ é»è¾ä¸VXLANæ¨¡å¼ä¸è´\n 2. éè¿è·¯ç±è¡¨å¯ç¥ï¼è¯¥æ°æ®åéè¿ens18ç½å¡å°è¾¾ä¸ä¸è·³ç½å³Node2çens18\n 3. éè¿ç©çç½ç»ï¼è¾¾å°Node2å¹¶è¿å¥ç½ç»åè®®æ ï¼éè¿è·¯ç±è¾¾å°bridgeè¿å¥å°net3ä¸­\n\n\n# 4.4 æå¨æ¨¡æflannelå®ç°Host Gatewayæ¨¡å¼å®éª\n\nå¨Node1ä¸­åå»ºNetwork Namesapce net1ãvethpairåç½æ¡¥ï¼å¹¶éç½®å¥½å¶ç½ç»ã\n\nip netns add net1\nip link add veth0 type veth peer name veth1\nip link set dev veth0 up\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n# é»è®¤è·¯ç±\nip netns exec net1 ip r add default via 172.19.1.1 dev veth0\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.1.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåæ·»å è·¯ç±ï¼å°Node2æåéå°çå®¹å¨ç½æ®µä¸ºç®çæ°æ®åé½å°Node2ä½ä¸ºä¸ä¸è·³ç½å³ã\n\nip r add 172.19.2.0/24 via 10.65.132.188 dev ens18\n\n\n1\n\n\néå¤Node1çéç½®ï¼å¹¶æ·»å å°Node1æåéå°çå®¹å¨ç½æ®µä¸ºç®çæ°æ®åé½å°Node1ä½ä¸ºä¸ä¸è·³ç½å³ã\n\n# æ·»å net3æ¨¡æå®¹å¨\nip netns add net3\nip link add veth0 type veth peer name veth1\n\n# è®¾ç½®net3ä¸­ç½ç»éç½®\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.2.2/24 dev veth0\nip netns exec net3 ip link set veth0 up\nip netns exec net3 ip r add default via 172.19.2.1 dev veth0\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip a add 172.19.2.1/24 dev bridge0\nip link set bridge0 up\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n# è·¯ç±\nip r add 172.19.1.0/24 via 10.65.132.187 dev ens18\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nå¨Node1çnet1ä¸­ping Node2çnet2ï¼æ¯å¯ä»¥pingéçï¼è¯´æç½ç»äºéäºã\n\nå¨éè¿tcpdumpæåNode2 ens18ç½å¡çåï¼å¯ä»¥çå°ICMPæ°æ®åå°äºNode2èç¹ã\n\n# tcpdump -i ens18 host 172.19.2.2\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type EN10MB (Ethernet), capture size 262144 bytes\n15:07:00.072677 IP 172.19.1.2 > 172.19.2.2: ICMP echo request, id 52240, seq 8, length 64\n15:07:00.072782 IP 172.19.2.2 > 172.19.1.2: ICMP echo reply, id 52240, seq 8, length 64\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# 5. å·¨äººçè©è\n\n * Flannel Vxlanå°ååçåæ\n * ãkubernetesç½ç»æå¨æåã\n * ãæå®¢æ¶é´-æ·±å¥åæKubernetesã',normalizedContent:'# 0. åè¨\n\næ¬æä¸»è¦ä»ç»flannelå¨k8sç½ç»ä¸­ä½ä¸ºç½ç»æä»¶éè¿udpãvxlanãhost-gatewayä¸ç§æ¨¡å¼æ¥è§£å³å®¹å¨è·¨ä¸»æºç½ç»éä¿¡çï¼å¹¶éè¿æå¨å®ç°è¿ä¸ç§æ¨¡å¼æ·±å¥çè§£å¶åçã\n\n\n# 1. flannelå¨å±ç½ç»å°ååéæºå¶\n\næ¯å°èç¹ä¸å®¹å¨çipå°åæ¯ç±æå±èç¹èªå¨åéçï¼é£ä¹ä¼å­å¨ä¸ä¸ªé®é¢æ¯ï¼ä¸åèç¹ä¸çå®¹å¨æåéçipå°ååå¯è½ä¼æéå¤çæåµã\n\nflannelè®¾è®¡äºä¸ç§å¨å±çç½ç»å°ååéæºå¶ï¼flannelä¼ä¸ºæ¯å°èç¹ç³è¯·ä¸ä¸ªç¬ä¸æ äºçç½æ®µï¼å¹¶å­å¨å¨etcdä¸­ï¼flannelä¼å°è¯¥ç½æ®µéç½®å°åä¸ªèç¹ä¸çdocker(æèå¶ä»å®¹å¨å·¥å·)ï¼å½åèç¹ä¸çå®¹å¨ åªä»åéçç½æ®µéä¸­è·åipå°åã\n\n> ä¿®æ¹dockerå¯å¨åæ°--bipæ¥éå¶èç¹å®¹å¨è·å¾çipèå´ã\n\n\n\n\n# 2. udpæ¨¡å¼\n\n\n# 2.1 ç®ä»\n\nå¨flannelçudpæ¨¡å¼ä¸­ï¼æ¯ä¸ªèç¹é½ä¼å¯å¨ä¸ä¸ªudpæå¡å¨ï¼ç¨äºçå¬æ¥èªå¶ä»èç¹çæ°æ®åãå½ä¸ä¸ªå®¹å¨åå¦ä¸ä¸ªå®¹å¨åéæ°æ®åæ¶ï¼å®ä¼å°æ°æ®ååéå°ç®æ å®¹å¨çipå°ååç«¯å£å·ãflannelä¼å°è¯¥æ°æ®åå°è£å¨ä¸ä¸ªudpæ°æ®åä¸­ï¼å¹¶å°å¶åéå°ç®æ èç¹çudpæå¡å¨ãç®æ èç¹çudpæå¡å¨ä¼è§£æè¯¥æ°æ®åï¼å¹¶å°å¶ä¼ éç»ç®æ å®¹å¨ã\n\n\n# 2.2 flannelå®ç°udpæµç¨\n\n\n\nflanneldå¯å¨åä¼éè¿æå¼/dev/net/tunçæ¹å¼åå»ºtunè®¾å¤ï¼åç§°ä¸ºflannel0ï¼è¯¥è®¾å¤æ¯ç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®åäº¤äºçééãç¶ååå°ä»tunè®¾å¤è·åçipæ°æ®åå°è£å°udpæ°æ®åä¸­éè¿ç©çç½å¡åéå°å¶ä»èç¹ä¸­ï¼åæ ¸éè¿udpç«¯å£è½¬åç»flanneldç¶åè§£åï¼å¾å°å¶ä¸­çipæ°æ®åï¼ç¶ååéè¿tunè®¾å¤è¿å¥åæ ¸ç©ºé´ä¸­ï¼éè¿è·¯ç±å°è¾¾ç½æ¡¥ï¼ç¶ååå°ç®çå®¹å¨ä¸­ã\n\nflanneldå¨å¶ä¸­ä¸»è¦åäºï¼\n\n 1. å¼å¯äºudpæå¡ï¼å¹¶å¯¹udpæ°æ®åå°ååè§£å\n 2. èç¹ä¸è·¯ç±è¡¨çå¨ææ´æ°ï¼ä¹å°±æ¯ä»ç½æ¡¥åºæ¥çæ°æ®åç®çipä¸ºå¶ä»èç¹å®¹å¨ipæ¶ï¼éè¦è·¯ç±å°flanneldä¸­è¿è¡å°åï¼å¹¶ä¸å¨flanneldæ¥æ¶udpååè§£å°åºæ¥çipåéè¦éè¿è·¯ç±å°ç½æ¡¥docker0ä¸­\n\nç¼ºç¹å¾ææ¾ï¼ä»ä¸æ¬¡ç½ç»ä¼ è¾çæ°æ®åç»åäº2æ¬¡ç¨æ·æä¸åæ ¸æçåæ¢ï¼èåæ¢çæçæ¯ä¸é«çï¼æ¯ä¸æ¬¡çåæ¢é½æ¯ä¸æ¬¡æ°æ®çå¤å¶ã\n\n\n\n\n# 2.3 æå¨æ¨¡æflannelå®ç°udpå®éª\n\né¦ååå»ºnetwork namesapce net1ç¨æ¥æ¨¡æå®¹å¨\n\nip netns add net1\n\n\n1\n\n\nç¶ååå»ºä¸å¯¹veth pairç½å¡veth0åveth1ï¼å¹¶å°veth0æ¾å°net1ä¸­ï¼æèµ·å¹¶è®¾ç½®veth0çipå°åä¸º172.19.1.2/24\n\nip link add veth0 type veth peer name veth1\n\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n\n1\n2\n3\n4\n5\n\n\nåå»ºç½æ¡¥è®¾å¤ï¼æèµ·å¹¶è®¾ç½®ipå°åä¸º172.19.1.1/24ï¼å°veth1æèµ·å¹¶ç»å®å°ç½æ¡¥bridge0ä¸­\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.1.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¨net1ä¸­æ·»å é»è®¤è·¯ç±ï¼è®¾ç½®ä¸ä¸æ¡å°åä¸ºç½æ¡¥bridge0çipå°åï¼ä»ç½æ¡¥è¿å¥å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ã\n\nip netns exec net1 ip r add default via 172.19.1.1 dev veth0\n\n\n1\n\n\nåè¿è¡ä»¥ä¸ä»£ç ï¼è¯¥ä»£ç æ¯ç¨æ¥æ¨¡æflanneldç¨åºï¼ä¸»è¦ä½ç¨æ¯åå»ºäºtunè®¾å¤flannel0ï¼å¼å¯äºudpæå¡æ¶åudpåï¼ç¶åå°±æ¯å¯¹å®¹å¨ipåçå°è£ä¸è§£å°ã\n\nimport os\nimport socket\nimport struct\nimport threading\nfrom fcntl import ioctl\nimport click\n\nbind_address = (\'0.0.0.0\', 8285)\nbuffer_size = 4096\n\ntunsetiff = 0x400454ca\niff_tun = 0x0001\niff_tap = 0x0002\n\n\ndef create_tunnel(tun_name=\'flannel%d\', tun_mode=iff_tun):\n    tun_fd = os.open("/dev/net/tun", os.o_rdwr)\n    ifn = ioctl(tun_fd, tunsetiff, struct.pack(b"16sh", tun_name.encode(), tun_mode))\n    tun_name = ifn[:16].decode().strip("\\x00")\n    return tun_fd, tun_name\n\n\ndef start_tunnel(tun_name):\n    os.popen(f"ip link set {tun_name} up")\n\n\ndef udp_server(udp_socket, tun_fd):\n    while true:\n        data, addr = udp_socket.recvfrom(2048)\n        print("get data from udp.")\n        if not data:\n            break\n\n        os.write(tun_fd, data)\n\n\n@click.command()\n@click.option("--peer_node_ip", "-p", required=true, help="å¯¹ç«¯èç¹ip")\ndef main(peer_node_ip):\n    peer_node_addr = (peer_node_ip, 7000)\n\n    tun_fd, tun_name = create_tunnel()\n    start_tunnel(tun_name)\n\n    udp_socket = socket.socket(socket.af_inet, socket.sock_dgram)\n    udp_socket.bind(bind_address)\n\n    t = threading.thread(target=udp_server, args=(udp_socket, tun_fd))\n    t.daemon = true\n    t.start()\n\n    while true:\n        data = os.read(tun_fd, buffer_size)\n        print(f"get data from tun. data size = {len(data)}")\n        udp_socket.sendto(data, peer_node_addr)\n\n\nif __name__ == \'__main__\':\n    main()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n\n\nå¨node1ä¸­è¿è¡è¯¥ç¨åºï¼è®¾ç½®node2 ip\n\npython3 tun_app.py -p 10.65.132.188\n\n\n1\n\n\nå¯ä»¥çå°å·²ç»åå»ºäºtunè®¾å¤\n\n# ip link show flannel0\n...\n109: tun0: <pointopoint,multicast,noarp,up,lower_up> mtu 1500 qdisc pfifo_fast state unknown group default qlen 500\n    link/none \n    inet6 fe80::8e98:91a4:6537:d77a/64 scope link flags 800 \n       valid_lft forever preferred_lft forever\n...\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå¨è®¾ç½®å®¿ä¸»æºçè·¯ç±ï¼å°ææå°node2å®¹å¨çipåï¼é½è½¬åå°flannel0è®¾å¤ä¸­ã\n\nip r add 172.19.2.0/24 dev flannel0\n\n\n1\n\n\næåéå¤node1çæä½éç½®node2\n\n# åå»ºnet3\nip netns add net3\n\n# åå»ºveth pair\nip link add veth0 type veth peer name veth1\n\n# è®¾ç½®net1ç½ç»\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.2.2/24 dev veth0\nip netns exec net3 ip link set veth0 up\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.2.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n# éç½®net3è·¯ç±\nip netns exec net3 ip r add default via 172.19.2.1 dev veth0\n\n# åå»ºflannel0\npython3 flanneld.py -p 10.65.132.187\n\n# éç½®å°flannel0çè·¯ç±\nip r add 172.19.1.0/24 dev flannel0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n\n\n\n# 2.4 åæ\n\nå¨node1çnet1ä¸­ping node2çnet2çip 172.19.2.2ï¼å¯ä»¥çå°æ¯å¯ä»¥pingéç\n\n# ping 172.19.2.2 -c 1\nping 172.19.2.2 (172.19.2.2) 56(84) bytes of data.\n64 bytes from 172.19.2.2: icmp_seq=1 ttl=63 time=0.641 ms\n\n--- 172.19.2.2 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 0.641/0.641/0.641/0.000 ms\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå¨node1çflanneld.pyä¸­çå°æ¥å¿ï¼ä»tunä¸­æ¶å°äºæ¥èªå®¹å¨çipæ°æ®å\n\n# python3 flanneld.py -p 10.65.132.188\nget data from tun. data size = 88\n\n\n1\n2\n\n\nå¨node2çflanneld.pyä¸­çå°æ¥å¿ï¼æ¥æ¶å°äºnode1åéè¿æ¥çudpæ°æ®åã\n\n# python3 flanneld.py -p 10.65.132.187\nget data from udp.\n\n\n1\n2\n\n\n\n# 3. vxlanæ¨¡å¼\n\n\n# 3.1 ç®ä»\n\nå¨flannelçvxlanæ¨¡å¼ä¸­ï¼æ¯ä¸ªèç¹é½ä¼å¯å¨ä¸ä¸ªvxlané§éï¼ç¨äºå°å®¹å¨ä¹é´çæ°æ®åå°è£å¨vxlanåè®®ä¸­è¿è¡ä¼ è¾ãå½ä¸ä¸ªå®¹å¨åå¦ä¸ä¸ªå®¹å¨åéæ°æ®åæ¶ï¼å®ä¼å°æ°æ®ååéå°ç®æ å®¹å¨çipå°ååèæç½ç»idãflannelä¼å°è¯¥æ°æ®åå°è£å¨ä¸ä¸ªvxlanæ°æ®åä¸­ï¼å¹¶å°å¶åéå°ç®æ èç¹çvxlané§éãç®æ èç¹çvxlané§éä¼è§£æè¯¥æ°æ®åï¼å¹¶å°å¶ä¼ éç»ç®æ å®¹å¨ã\n\nvxlanæ¨¡å¼ä¹æ¯éè¿å°åä¸è§£åçå½¢å¼æ¥å®ç°é§éè¾¾å°å®¹å¨çè·¨ä¸»æºè®¿é®ï¼é£åudpæ¨¡å¼æä»ä¹åºå«å¢ï¼ åºå«å¨äºï¼vxlançå°åä¸è§£åé½æ¯å¨åæ ¸æå®æçï¼å¯¹æ¯udpæ¨¡å¼ç¨æ·æä¸åæ ¸æçåæ¢æ¥è¯´ï¼æçå¤§å¤§çæåäºã\n\n\n# 3.3 flannelå®ç°vxlanæ¨¡å¼æµç¨\n\n\n\nå¨node1çnet1ä¸­ping node2çnet3ï¼æ°æ®æµå¦ä¸ï¼\n\n 1. bridgeä½ä¸ºnet1çä¸ä¸è·³ç½å³ï¼æä»¥ä¼ååéarpè·åbridgeçmacå°å\n 2. è·åå°åï¼ç¶ååéicmpæ°æ®åéè¿bridgeè¿å¥å°å®¿ä¸»æºçç½ç»åè®®æ ä¸­ï¼éè¿è·¯ç±è¡¨ï¼ä¼è¿å¥å°flannel.1ä¸­ï¼ä¸ä¸è·³å°åä¸ºnode2çflannel.1çå°å\n 3. æ¬æ¥æ¯è¦åéarpæ¥è·ånode2çflannel.1çå°åï¼å ä¸ºå·²ç»æå¨éç½®äºarpè¡¨ï¼å¯ä»¥ç´æ¥è·åå°å°macå°åï¼ç¶åå°å¶å¡«ååå±äºå±å¤´ä¸­ã\n 4. åéè¿æ¥è¯¢fdbè¡¨ï¼æ¾å°å¤å±udpåä¸­ç®çipå°åï¼ä¹å°±æ¯node2çipå°åï¼å¡«åå°å¤é¨ipå¤´ä¸­ãæç»éè¿ç©çç½å¡ens18èµ°å¤é¨ç½ç»è¾¾å°node2ä¸­ã\n 5. è¾¾å°node2åï¼éè¿ç«¯å£8472ï¼å°åè½¬åç»vtepè®¾å¤flannel.1è¿è¡è§£åï¼è§£å°åçipåç»è¿è·¯ç±è¡¨è¾¾å°bridgeä¸­ï¼æç»è½¬åå°net3ä¸­ã\n\n\n# 3.4 æå¨æ¨¡æflanneldç»´æ¤vtepç»å®è·µ\n\nåå»ºvtepè®¾å¤å½åä¸ºflannel.1ï¼ç¶åflannel.1éç½®ipå°åä¸º172.19.1.0/32\n\n# æ·»å vtepè®¾å¤\nip link add flannel.1 type vxlan id 42 dstport 8472 local 10.65.132.187 dev ens18 nolearning proxy\n\n# éç½®flannel.1\nip link set flannel.1 up\nip a add 172.19.1.0/32 dev flannel.1\n\n\n1\n2\n3\n4\n5\n6\n\n * åªéè¦å¡«ålocalå°å\n * nolearningï¼vtepä¸è¦éè¿æ¶å°çæ¥æå­¦ä¹ fdbè¡¨é¡¹çåå®¹ï¼åå°å¹¿æ­é£æ´ï¼æé«æçã\n * proxyï¼vtepæ¿æarpä»£çåè½ï¼æ¶å°arpè¯·æ±æ¶ï¼å¦ææç¼å­åç´æ¥åºç­ï¼åå°å¹¿æ­é£æ´ï¼æé«æçã\n\næ·»å network namespace net1ï¼åå»ºveth pairï¼å°å¶ä¸­ä¸ç«¯æ¾è¿net1ä¸­ï¼å¹¶éç½®å¥½ipå°åï¼åæ·»å é»è®¤è·¯ç±é½èµ°veth0\n\nip netns add net1\nip link add veth0 type veth peer name veth1\nip link set dev veth0 up\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n# é»è®¤è·¯ç±\nip netns exec net1 ip r add default via 172.19.1.1 dev veth0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nåå»ºç½æ¡¥è®¾å¤å½åä¸ºbridge0ï¼å¹¶å°veth1æå°å¶ä¸\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.1.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå°è¾¾net3çæ°æ®åä¸ä¸è·³ä¸ºnode2çvtepè®¾å¤ipéè¿flannel.1è®¾å¤ï¼éè¦æ·»å onlinkï¼å ä¸ºä¸ä¸è·³ç½å³ä¸åæ¬å°å°åå¨åä¸ç½æ®µï¼è·¯ç±æ·»å æ¶è¾åºè·¯ç±ä¸å¯è¾¾çéè¯¯ï¼onlinkçæä¹å¨äºåè®®æ è½ç¶æ¾ä¸å°é¾è·¯å±ç´è¿è·¯ç±ï¼ä½æ¯è¿æ¯ä¼åå¸éå¯¹viaç½å³çarpè¯·æ±ç.\n\nip r add 172.19.2.0/24 via 172.19.2.0 dev flannel.1 onlink\n\n\n1\n\n\nå¨node2èç¹ä¸­éå¤ä¸é¢æä½åå»ºvetpè®¾å¤åç¸å³ç½ç»éç½®\n\n# æ·»å vtepè®¾å¤\nip link add flannel.1 type vxlan id 42 dstport 8472 local 10.65.132.188 dev ens18\nip link set flannel.1 up\nip a add 172.19.2.0/32 dev flannel.1\nip r add 172.19.1.0/24 via 172.19.1.0 dev flannel.1 onlink\n\n\n# æ·»å net3æ¨¡æå®¹å¨\nip netns add net3\nip link add veth0 type veth peer name veth1\n\n# è®¾ç½®net3ä¸­ç½ç»éç½®\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.2.2/24 dev veth0\nip netns exec net3 ip link set veth0 up\nip netns exec net3 ip r add default dev veth0\nip netns exec net3 ip r add default via 172.19.2.1 dev veth0\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip a add 172.19.2.1/24 dev bridge0\nip link set bridge0 up\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\nå¨node1èç¹ä¸­éè¦åæ°å¢arpç¼å­ï¼node1ä¸­æ·»å è·¯ç±çä¸ä¸è·³å°åæ¯node2çvtepè®¾å¤ï¼æä»¥éè¦å¨arpæ·»å vtep ipåmacå°åçç¼å­ã\n\narp -s 172.19.2.0 8a:8b:4d:10:82:56 dev flannel.1\n\n\n1\n\n\nåå¨èç¹fdbè¡¨ä¸­æ·»å å¯¹ç«¯vetp macå°ååå¯¹å¤ipï¼ç©çç½å¡ipï¼çæ å°å³ç³»è¡¨é¡¹\n\nbridge fdb add 8a:8b:4d:10:82:56 dev flannel.1 dst 10.65.132.188\n\n\n1\n\n\néå¤node1æä½ï¼éç½®node2çarpç¼å­åfdbè¡¨ã\n\narp -s 172.19.1.0 1e:b7:5e:19:ab:90 dev flannel.1\nbridge fdb add 1e:b7:5e:19:ab:90 dev flannel.1 dst 10.65.132.187\n\n\n1\n2\n\n\néè¿ä»¥ä¸æä½å®æäºç¯å¢çæ­å»ºï¼æ¥ä¸æ¥ï¼æä»¬å¨node1çnet1ä¸­è¿è¡ping node2çnet3ï¼å¯ä»¥åç°æ¯å¯ä»¥pingéç\n\n# ip netns exec net1 ping 172.19.2.2 -c 2\nping 172.19.2.2 (172.19.2.2) 56(84) bytes of data.\n64 bytes from 172.19.2.2: icmp_seq=1 ttl=62 time=0.547 ms\n64 bytes from 172.19.2.2: icmp_seq=2 ttl=62 time=0.560 ms\n\n\n1\n2\n3\n4\n\n\n\n# 4. host gatewayæ¨¡å¼\n\n\n# 4.1 ç®ä»\n\néè¿æä¸»æºå½ä½ç½å³å®ç°è·¨èç¹ç½ç»éä¿¡çãå æ­¤éä¿¡åæ¹çå®¿ä¸»æºè¦æ±è½å¤ç´æ¥è·¯ç±ï¼å¿é¡»å¨åä¸ä¸ªç½ç»ï¼è¿ä¸ªéå¶ä½¿å¾host-gwæ¨¡å¼æ æ³éç¨äºéç¾¤è§æ¨¡è¾å¤§ä¸éè¦å¯¹èç¹è¿è¡ç½æ®µååçåºæ¯ãhost-gwçå¦å¤ä¸ä¸ªéå¶åæ¯éçéç¾¤ä¸­èç¹è§æ¨¡çå¢å¤§ï¼flanneldç»´æ¤ä¸»æºä¸æåä¸ä¸æ¡è·¯ç±è¡¨çå¨ææ´æ°ä¹æ¯ä¸ä¸ªä¸å°çååã\n\nflanneldçå¯ä¸ä½ç¨å°±æ¯è´è´£ä¸»æºä¸è·¯ç±è¡¨çå¨æï¼ä½å ä¸ºåªè½ä¿®æ¹ä¸»æºçè·¯ç±ï¼æä»¥åä¸ªä¸»æºå¿é¡»äºå±ç½ç»äºéã\n\nè·vxlanæ¨¡å¼åudpæ¨¡å¼æ¯è¾ï¼ä¼ç¹ä¸»è¦æ¯æ²¡æå°åä¸è§£åçæä½ï¼å¤§å¤§çæé«äºæ§è½ã\n\n\n# 4.3 flannelå®ç°host gatewayæ¨¡å¼æµç¨\n\n\n\nå¨node1çnet1ä¸­ping node2çnet3ï¼æ°æ®æµå¦ä¸ï¼\n\n 1. æ°æ®åä»å®¹å¨è¿å¥å°å®¿ä¸»æºç½ç»åè®®æ é»è¾ä¸vxlanæ¨¡å¼ä¸è´\n 2. éè¿è·¯ç±è¡¨å¯ç¥ï¼è¯¥æ°æ®åéè¿ens18ç½å¡å°è¾¾ä¸ä¸è·³ç½å³node2çens18\n 3. éè¿ç©çç½ç»ï¼è¾¾å°node2å¹¶è¿å¥ç½ç»åè®®æ ï¼éè¿è·¯ç±è¾¾å°bridgeè¿å¥å°net3ä¸­\n\n\n# 4.4 æå¨æ¨¡æflannelå®ç°host gatewayæ¨¡å¼å®éª\n\nå¨node1ä¸­åå»ºnetwork namesapce net1ãvethpairåç½æ¡¥ï¼å¹¶éç½®å¥½å¶ç½ç»ã\n\nip netns add net1\nip link add veth0 type veth peer name veth1\nip link set dev veth0 up\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n# é»è®¤è·¯ç±\nip netns exec net1 ip r add default via 172.19.1.1 dev veth0\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set bridge0 up\nip a add 172.19.1.1/24 dev bridge0\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nåæ·»å è·¯ç±ï¼å°node2æåéå°çå®¹å¨ç½æ®µä¸ºç®çæ°æ®åé½å°node2ä½ä¸ºä¸ä¸è·³ç½å³ã\n\nip r add 172.19.2.0/24 via 10.65.132.188 dev ens18\n\n\n1\n\n\néå¤node1çéç½®ï¼å¹¶æ·»å å°node1æåéå°çå®¹å¨ç½æ®µä¸ºç®çæ°æ®åé½å°node1ä½ä¸ºä¸ä¸è·³ç½å³ã\n\n# æ·»å net3æ¨¡æå®¹å¨\nip netns add net3\nip link add veth0 type veth peer name veth1\n\n# è®¾ç½®net3ä¸­ç½ç»éç½®\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.2.2/24 dev veth0\nip netns exec net3 ip link set veth0 up\nip netns exec net3 ip r add default via 172.19.2.1 dev veth0\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip a add 172.19.2.1/24 dev bridge0\nip link set bridge0 up\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n# è·¯ç±\nip r add 172.19.1.0/24 via 10.65.132.187 dev ens18\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nå¨node1çnet1ä¸­ping node2çnet2ï¼æ¯å¯ä»¥pingéçï¼è¯´æç½ç»äºéäºã\n\nå¨éè¿tcpdumpæånode2 ens18ç½å¡çåï¼å¯ä»¥çå°icmpæ°æ®åå°äºnode2èç¹ã\n\n# tcpdump -i ens18 host 172.19.2.2\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type en10mb (ethernet), capture size 262144 bytes\n15:07:00.072677 ip 172.19.1.2 > 172.19.2.2: icmp echo request, id 52240, seq 8, length 64\n15:07:00.072782 ip 172.19.2.2 > 172.19.1.2: icmp echo reply, id 52240, seq 8, length 64\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# 5. å·¨äººçè©è\n\n * flannel vxlanå°ååçåæ\n * ãkubernetesç½ç»æå¨æåã\n * ãæå®¢æ¶é´-æ·±å¥åækubernetesã',charsets:{cjk:!0},lastUpdated:"2023/06/06, 18:33:56",lastUpdatedTimestamp:1686047636e3},{title:"kubernetes serviceå¦ä½éè¿iptablesè½¬å",frontmatter:{title:"kubernetes serviceå¦ä½éè¿iptablesè½¬å",date:"2024-01-18T16:40:30.000Z",permalink:"/pages/b3955c/",categories:["äºåç","k8s"],tags:["k8s","è®¡ç®æºç½ç»"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦æ¯ä»ç»kubernetesçserviceæ¯å¦ä½å©ç¨iptablesæ¥è¿è¡æµéçè½¬åè¾¾å°æµéçè´è½½åè¡¡çï¼å¹¶ä¼éè¿å®è·µæä½æ¥æ´å¥½ççè§£ä¸éªè¯å¶åçã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png"},{name:"twitter:title",content:"kubernetes serviceå¦ä½éè¿iptablesè½¬å"},{name:"twitter:description",content:"æ¬æä¸»è¦æ¯ä»ç»kubernetesçserviceæ¯å¦ä½å©ç¨iptablesæ¥è¿è¡æµéçè½¬åè¾¾å°æµéçè´è½½åè¡¡çï¼å¹¶ä¼éè¿å®è·µæä½æ¥æ´å¥½ççè§£ä¸éªè¯å¶åçã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/16.kubernetes%20service%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87iptables%E8%BD%AC%E5%8F%91.html"},{property:"og:type",content:"article"},{property:"og:title",content:"kubernetes serviceå¦ä½éè¿iptablesè½¬å"},{property:"og:description",content:"æ¬æä¸»è¦æ¯ä»ç»kubernetesçserviceæ¯å¦ä½å©ç¨iptablesæ¥è¿è¡æµéçè½¬åè¾¾å°æµéçè´è½½åè¡¡çï¼å¹¶ä¼éè¿å®è·µæä½æ¥æ´å¥½ççè§£ä¸éªè¯å¶åçã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/16.kubernetes%20service%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87iptables%E8%BD%AC%E5%8F%91.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2024-01-18T16:40:30.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{itemprop:"name",content:"kubernetes serviceå¦ä½éè¿iptablesè½¬å"},{itemprop:"description",content:"æ¬æä¸»è¦æ¯ä»ç»kubernetesçserviceæ¯å¦ä½å©ç¨iptablesæ¥è¿è¡æµéçè½¬åè¾¾å°æµéçè´è½½åè¡¡çï¼å¹¶ä¼éè¿å®è·µæä½æ¥æ´å¥½ççè§£ä¸éªè¯å¶åçã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240110142336-wl40wxw.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/16.kubernetes%20service%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87iptables%E8%BD%AC%E5%8F%91.html",relativePath:"01.äºåç/07.k8s/16.kubernetes serviceå¦ä½éè¿iptablesè½¬å.md",key:"v-2f20c458",path:"/pages/b3955c/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:39},{level:2,title:"ç¯å¢æ­å»º",slug:"ç¯å¢æ­å»º",normalizedTitle:"ç¯å¢æ­å»º",charIndex:126},{level:2,title:"KUBE-SERVICES",slug:"kube-services",normalizedTitle:"kube-services",charIndex:2150},{level:2,title:"POSTROUTING",slug:"postrouting",normalizedTitle:"postrouting",charIndex:5322},{level:2,title:"SNAT",slug:"snat",normalizedTitle:"snat",charIndex:5941},{level:3,title:"ä¸ºä»ä¹éç¾¤å¤é¨è®¿é®è¯¥serviceéè¦è¢«SNATï¼",slug:"ä¸ºä»ä¹éç¾¤å¤é¨è®¿é®è¯¥serviceéè¦è¢«snat",normalizedTitle:"ä¸ºä»ä¹éç¾¤å¤é¨è®¿é®è¯¥serviceéè¦è¢«snatï¼",charIndex:6449},{level:3,title:"conntrack",slug:"conntrack",normalizedTitle:"conntrack",charIndex:6624},{level:2,title:"æºåç®çIPç¸å",slug:"æºåç®çipç¸å",normalizedTitle:"æºåç®çipç¸å",charIndex:7440},{level:2,title:"NodePort",slug:"nodeport",normalizedTitle:"nodeport",charIndex:7954},{level:3,title:"æ­å»ºç¯å¢",slug:"æ­å»ºç¯å¢",normalizedTitle:"æ­å»ºç¯å¢",charIndex:132},{level:3,title:"è¯·æ±clusterip",slug:"è¯·æ±clusterip",normalizedTitle:"è¯·æ±clusterip",charIndex:8672},{level:3,title:"è¯·æ±èç¹IP",slug:"è¯·æ±èç¹ip",normalizedTitle:"è¯·æ±èç¹ip",charIndex:10190},{level:2,title:"åèé¾æ¥",slug:"åèé¾æ¥",normalizedTitle:"åèé¾æ¥",charIndex:10887}],headersStr:"åè¨ ç¯å¢æ­å»º KUBE-SERVICES POSTROUTING SNAT ä¸ºä»ä¹éç¾¤å¤é¨è®¿é®è¯¥serviceéè¦è¢«SNATï¼ conntrack æºåç®çIPç¸å NodePort æ­å»ºç¯å¢ è¯·æ±clusterip è¯·æ±èç¹IP åèé¾æ¥",content:"# kubernetes serviceå¦ä½éè¿iptablesè½¬å\n\n\n# åè¨\n\næ¬æä¸»è¦æ¯ä»ç»kubernetesçserviceæ¯å¦ä½å©ç¨iptablesæ¥è¿è¡æµéçè½¬åè¾¾å°æµéçè´è½½åè¡¡çï¼å¹¶ä¼éè¿å®è·µæä½æ¥æ´å¥½ççè§£ä¸éªè¯å¶åçã\n\n\n# ç¯å¢æ­å»º\n\næ­å»ºç¯å¢å¦ä¸å¾æç¤ºï¼\n\n\n\n 1. åå»ºä¸ä¸ªdeployï¼è®¾ç½®å¶å¯æ¬æ°ä¸º3\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: demoapp-deployment\n  labels:\n    app: demoapp\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: demoapp\n  template:\n    metadata:\n      labels:\n        app: demoapp\n    spec:\n      containers:\n        - name: ubuntu\n          image: ikubernetes/demoapp:v1.0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n 2. åå»ºserviceï¼ä¸ºä¸é¢deploymentç3ä¸ªpodè¿è¡è´è½½åè¡¡è®¿é®\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: demoapp-service\nspec:\n  selector:\n    app: demoapp\n  clusterIP: 192.44.140.73\n  ports:\n    - name: http\n      protocol: TCP\n      port: 80\n      targetPort: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n 3. éªè¯\n\nåå»ºå®åï¼ç¯å¢å¦ä¸ï¼\n\n# kubectl get pods -n zwf -o wide\nNAME                                  READY   STATUS    RESTARTS   AGE     IP\ndemoapp-deployment-64bdcb8666-4prbk   1/1     Running   0          7d17h   192.33.229.12   dmoc-fa163eee1e30\ndemoapp-deployment-64bdcb8666-cxmmz   1/1     Running   0          7d17h   192.33.73.139   dmoc-fa163e7188d6\ndemoapp-deployment-64bdcb8666-kkzsg   1/1     Running   0          7d17h   192.33.206.93   dmoc-fa163ee6bbe1\ndemoapp-pod                           1/1     Running   0          4d17h   192.33.73.172   dmoc-fa163e7188d6\n\n# kubectl get svc -n zwf\nNAME                       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\ndemoapp-service            ClusterIP   192.44.140.73    <none>        80/TCP         7s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå¯ä»¥ç´æ¥å¨ç¯å¢ä¸­è¯·æ±serviceçclusteripå°åï¼ä¼éæºè®¿é®å°ä¸ä¸ªpodï¼è¾åºçä¿¡æ¯åå«äºè¯·æ±IPåç®çIPã\n\n# curl 192.44.140.73\niKubernetes demoapp v1.0 !! ClientIP: 10.10.10.16, ServerName: demoapp-deployment-64bdcb8666-kkzsg, ServerIP: 192.33.206.93!\n\n# curl 192.44.140.73\niKubernetes demoapp v1.0 !! ClientIP: 10.65.196.41, ServerName: demoapp-deployment-64bdcb8666-cxmmz, ServerIP: 192.33.73.139!\n\n# curl 192.44.140.73\niKubernetes demoapp v1.0 !! ClientIP: 10.10.10.16, ServerName: demoapp-deployment-64bdcb8666-4prbk, ServerIP: 192.33.229.12!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# KUBE-SERVICES\n\nå¨PREROUTING åOUTPUT é¾çnatè¡¨ä¸­ï¼é½åå«äºKUBE-SERVICES å­é¾ï¼è¯¥å­é¾ä¸­å°±åå«äºserivceçiptablesè§åçéç½®ã\n\n# iptables -L PREROUTING -t nat\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination       \nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */\ncali-PREROUTING  all  --  anywhere             anywhere             /* cali:6gwbT8clXdHdC1b1 */\n\n# iptables -L OUTPUT -t nat\nChain OUTPUT (policy ACCEPT)\ntarget     prot opt source               destination       \nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */\ncali-OUTPUT  all  --  anywhere             anywhere             /* cali:tVnHkvAo15HuiPy0 */\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä¸ºä»ä¹å¨PREROUTINGåOUTPUTé¾ä¸­æ·»å serviceè§åï¼\n\nserviceçä½ç¨æ¯è´è½½åè¡¡ï¼ä¹å°±æ¯éè¦å°IPåè¿è¡DNATæä½ï¼èè¿ä¸ªæä½éè¦å¨æé è¿åéçä½ç½®ãç½å¡æ¶å°çåè¿å¥å°ç½ç»åè®®æ æ¶ï¼æåè¿å¥çå°±æ¯PREROUTINGé¾ï¼ä¹å°±æ¯èç¹å¤é¨çæµéè¿å¥çå¥å£ãOUTPUTæ¯æ¬å°è¿ç¨ååºçåæåè¿å¥çé¾ãæä»¥éè¦å¨è¿ä¸¤æ¡é¾ä¸­æ·»å KUBE-SERVICESï¼è¯¦æå¯åèå¿«éäºè§£iptables\n\nä¸ºä»ä¹natè¡¨ï¼\n\nå ä¸ºè¦åDNATæä½ï¼æä»¥å¨natè¡¨ã\n\nKUBE-SERVICESä¸é¢æè®¸å¤KUBE-SVC-XXXçå­é¾ï¼æ¯ä¸æ¡å­é¾é½æ¯ä¸ä¸ªéç¾¤ä¸­ä¸ä¸ªserviceçéç½®ï¼ç­éä¸ä¸\n\néè¿ç­édemoapp-service å¾å°ä¸é¢çå­é¾ï¼åªæè®¿é®ç®çå°åä¸º192.44.140.73æè½è¿å¥å°è¯¥å­é¾ä¸­ã\n\n# iptables -L KUBE-SERVICES -t nat | grep demoapp-service\nKUBE-SVC-FIHIHDNRZEG5VQEQ  tcp  --  anywhere             192.44.140.73        /* zwf/demoapp-service:http cluster IP */ tcp dpt:http\n\n\n1\n2\n\n\næ¥çUBE-SVC-FIHIHDNRZEG5VQEQ é¾ä¸­åå®¹ï¼å¶ä¸­åå«äºåæ¡å­é¾ã\n\n# iptables -L KUBE-SVC-FIHIHDNRZEG5VQEQ -t nat -n\nChain KUBE-SVC-FIHIHDNRZEG5VQEQ (1 references)\ntarget     prot opt source               destination       \nKUBE-MARK-MASQ  tcp  -- !192.33.0.0/16        192.44.140.73        /* zwf/demoapp-service:http cluster IP */ tcp dpt:80\nKUBE-SEP-FO7YK2K5DAKTCVSE  all  --  0.0.0.0/0            0.0.0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability 0.33333333349\nKUBE-SEP-IPKL7NSNTVGKI4T5  all  --  0.0.0.0/0            0.0.0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability 0.50000000000\nKUBE-SEP-BPER562ISF3UFYOQ  all  --  0.0.0.0/0            0.0.0.0/0            /* zwf/demoapp-service:http */\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nç¬¬ä¸æ¡é¾æ¯ï¼æºIPä¸å¨192.33.0.0/16æ®µãç®çIPä¸º192.44.140.73å¹¶ä¸ç®çç«¯å£æ¯80çæ°æ®åä¼å¹éå°è¯¥æ¡å­é¾è¿è¡è·³è½¬ãå¶ä¸­192.33.0.0/16æ¯podçç½æ®µï¼å¦æä¸æ¯éç¾¤åçæµéï¼åä¼å¹éä¸è¯¥æ¡å­é¾ï¼ä¼æä¸0x4000çæ è®°ã\n\n# iptables -L KUBE-MARK-MASQ -t nat -n\nChain KUBE-MARK-MASQ (548 references)\ntarget     prot opt source               destination       \nMARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000\n\n\n1\n2\n3\n4\n\n\nåé¢çä¸æ¡é¾æ¯ä¸ºäºå°æµééæºçåéå°ä»»æä¸ä¸ªpodä¸­ãç¬¬äºæ¡é¾ä»£è¡¨çæ1/3çæ¦çä¼å¹éå°è¯¥é¾ï¼èç¬¬ä¸æ¡é¾ä»£è¡¨ç1/2ï¼æåä¸æ¡é¾ä»£è¡¨çç¾åç¾ã\n\nçç¬¬äºæ¡é¾ä¸­çè§åï¼ç¬¬ä¸æ¡è§åæ¯è·³è½¬å°å­é¾KUBE-MARK-MASQ ï¼æºIPä¸º192.33.206.93çæ°æ®åæä¸äº0x4000æ è®°ï¼åå°ç®çIP DNATæ192.33.206.93ï¼è¯´æå¦æèªå·±è®¿é®èªå·±ï¼ä¹ä¼è¢«æä¸æ è®°ã\n\nè¿éç192.33.206.93æ¯æ¬èº«serviceæå¹éä¸çpod IPå°åï¼å¦æè°ç¨èªå·±çserviceåä¼å¹éä¸è¯¥é¾ï¼æä¸0x4000æ è®°ã\n\nèç¬¬äºæ¡è§åæ¯ä¸ä¸ªDNATæä½ï¼ä¼å°ç®æ å°åæ¹ä¸º192.33.206.93:80ï¼ä¹å°±æ¯podçå°åã\n\n # iptables -L KUBE-SEP-FO7YK2K5DAKTCVSE -t nat\nChain KUBE-SEP-FO7YK2K5DAKTCVSE (1 references)\ntarget     prot opt source               destination   \nKUBE-MARK-MASQ  all  --  192.33.206.93        anywhere             /* zwf/demoapp-service:http */\nDNAT       tcp  --  anywhere             anywhere             /* zwf/demoapp-service:http */ tcp to:192.33.206.93:80\n\n\n1\n2\n3\n4\n5\n\n\nå©ä¸çç¬¬3ã4æ¡è§åä¹æ¯ä¸æ ·çæä½ï¼ä¼å°æµéDNATå°å¯¹åºçpodä¸­ã\n\n\n# POSTROUTING\n\nPOSTROUTINGä¸­åå«äºä¸æ¡KUBE-POSTROUTINGå­é¾ï¼å­é¾ä¹æ¯ç±kube-porxyæ¥åå¥çã\n\n# iptables -L POSTROUTING -t nat\nChain POSTROUTING (policy ACCEPT)\ntarget     prot opt source               destination       \nKUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */\ncali-POSTROUTING  all  --  anywhere             anywhere             /* cali:O3lYWMrLQYEMJtB5 */\n\n\n1\n2\n3\n4\n5\n\n\næ¥çå­é¾KUBE-POSTROUTING åå®¹ï¼\n\n 1. ç¬¬ä¸æ¡è§åæ¯æ²¡ææ è®°ä¸º0x400çæ°æ®åä¼returnï¼ä¸æ§è¡ä¸é¢çå­é¾ãè¿è®°å¾å¨KUBE-PREROUTING ä¸­æä¸¤æ¬¡æä¸0x4000æ è®°ï¼ä»£è¡¨çè®¿é®æ¯éç¾¤å¤é¨è®¿é®è¯¥serviceæèæ¯æºåç®çä¸æ ·ï¼é½ä¼å¾ä¸èµ°ã\n 2. ç¬¬äºæ¡è§åæ¯å¯¹æ°æ®åçæ è®°å¼è¿è¡å¼æï¼èè¿éæ¯0x4000ä¸0x4000è¿è¡å¼æï¼ä¹å°±æ¯0\n 3. ç¬¬ä¸æ¡è§åæ¶å¯¹è¯¥æ°æ®åè¿è¡SNATï¼random-fullyæ¯å¯¹æºç«¯å£è¿è¡éæºè·åã\n\n# iptables -L KUBE-POSTROUTING -t nat\nChain KUBE-POSTROUTING (1 references)\ntarget     prot opt source               destination       \nRETURN     all  --  anywhere             anywhere             mark match ! 0x4000/0x4000\nMARK       all  --  anywhere             anywhere             MARK xor 0x4000\nMASQUERADE  all  --  anywhere             anywhere             /* kubernetes service traffic requiring SNAT */ random-fully\n\n\n1\n2\n3\n4\n5\n6\n\n\nè¿éæä¸¤ç§æåµä¼è¢«SNATï¼è¯´è¯´ä¸ºä»ä¹ã\n\n\n# SNAT\n\n\n# ä¸ºä»ä¹éç¾¤å¤é¨è®¿é®è¯¥serviceéè¦è¢«SNATï¼\n\næ°æ®åéè¦ååï¼å¦ææ²¡æSNATï¼é£ä¹ååçç®çIPæ¯å®¢æ·ç«¯çIPï¼èæºIPæ¯PodçIPï¼èå®¢æ·ç«¯å¹¶ä¸è®¤è¯¥æ°æ®åï¼åä¼è¢«ä¸¢å¼ã\n\nâ\n\nå¦ææåçSNATï¼é£ä¹ååçæ¶åå¯ä»¥åå°Node1çèç¹ï¼ååå°clientã\n\nâ\n\nä½é®é¢åæ¥äºï¼æ¯æä¹ä»Node1åååå°clientçå¢ï¼\n\n\n# conntrack\n\nconntrackæ¯ä¸ä¸ªè¿½è¸ªè¡¨ï¼å¨æ¯ä¸ä¸ªæ°æ®åè¿å¥å°netfilterçæ¶åï¼é½ä¼è®°å½ä¸æ¡è®°å½ï¼å½æä»¬è¿è¡SNATåDNATçæ¶åä¹é½ä¼æ´æ°è¯¥è¡¨ä¸­çè®°å½ã\n\næä»¥å¨Node1ååç»clientæ¶åï¼å¯ä»¥éè¿æ¥è¯¢è¿ä¸ªè¡¨ä¸­çè®°å½ï¼ç¶ååæ¬¡SNATåDNATæ¢å¤åå»å°±å¯ä»¥è¿è¡æ­£å¸¸çååäºã\n\n\n\nå¯ä»¥çä¸conntrackéé¢çè®°å½é¿ä»ä¹æ ·å­ã\n\nåå¨æä¸å°èç¹ä¸curl serviceçipï¼ä¸å¾çclientå¶å®ä¹æ¯å¨Node1ä¸çï¼å ä¸ºNode1ä¸æä¸¤å¼ ç½å¡ï¼Node1åNode2çéä¿¡ä½¿ç¨çç½å¡eth2 ipä¸º10.10.10.16ï¼å ä¸ºè½¬åå°å¶ä»èç¹ï¼æä»¥ä¼è¢«SNATã\n\n# curl 192.44.140.73\niKubernetes demoapp v1.0 !! ClientIP: 10.10.10.16, ServerName: demoapp-deployment-64bdcb8666-4prbk, ServerIP: 192.33.229.12!\n\n\n1\n2\n\n\nè¿éä¸»è¦æ¯çsrcådståå«æ¯clientè¯·æ±serviceçç®çIPï¼ç¶ååé¢åæä¸ä¸ªsrcådstå®æ¯ç±Node2ååç»Node1çæºåç®çIPï¼ä¹å°±æ¯æºæ¯podçIPï¼dstæ¯Node1èç¹IPã\n\nåé¢æ¯åéåçæ¹åï¼åé¢æ¯ååçæ¹åãéè¿æ¥è¯¢è¯¥è¡¨ï¼å³å¯ä»¥ä»Node1ååç»client\n\n# conntrack -L | grep 192.33.229.12\ntcp      6 107 TIME_WAIT src=10.65.196.41 dst=192.44.140.73 sport=33468 dport=80 src=192.33.229.12 dst=10.10.10.16 sport=80 dport=18623 [ASSURED] mark=0 use=1\n\n\n1\n2\n\n\nâ\n\n\n# æºåç®çIPç¸å\n\nå½podè®¿é®serviceæ¶ï¼æ­£å¥½DNATæèªå·±çIPï¼é£ä¹å°±å­å¨æºåç®çIPä¸æ ·çæåµã\n\n\n\nè¿ç§æ°æ®åæ¯å¾ç¹æ®çå­å¨ï¼ç½ç»è®¾å¤å¯è½ä¼å°è¿ç§æ°æ®åè§ä¸ºæ ææèå¼å¸¸çåè¢«ä¸¢å¼ï¼æå¥½ä¸è¦ä¸æ ·ï¼æä»¥ä¼å°æºIP SNATä¸ºä¸»æºçIPï¼è§£å³è¯¥é®é¢ã\n\nå®éª\n\n\n\nå½åèç¹çIPä¸ºï¼10.65.196.41ï¼ç¶åè¿å¥å¨å½åèç¹çPodåï¼å½åpodçipä¸ºï¼192.33.73.139\n\nkubectl exec -it -n zwf demoapp-deployment-64bdcb8666-cxmmz -- sh\n\n\n\n1\n2\n\n\nè¿è¡å¤æ¬¡curl service ipï¼å½æä¸æ¬¡è¯·æ±å°æ¬PODçIPæ¶ï¼æ¥çå¶ClientIPï¼åç°å¶æºIPæ¯ï¼10.65.196.41ï¼è¿ä¸ªå½åèç¹çIP\n\n# curl 192.44.140.73\niKubernetes demoapp v1.0 !! ClientIP: 10.65.196.41, ServerName: demoapp-deployment-64bdcb8666-cxmmz, ServerIP: 192.33.73.139!\n\n\n1\n2\n\n\n\n# NodePort\n\nä¸é¢ä»ç»çæ¯serivi type=ClusterIPæ¹å¼çï¼é£ä¹NodePortæä»ä¹åºå«å¢ï¼\n\n\n# æ­å»ºç¯å¢\n\nåå°clusterIPçserviceå äºï¼é²æ­¢å¹²æ°ã\n\nkubectl delete svc -n zwf demoapp-service\n\n\n1\n\n\nåå»ºNodePortçserviceæä»¶demo_service_nodeport.yaml\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: demoapp-nodeport-service\nspec:\n  selector:\n    app: demoapp\n  ports:\n    - name: http\n      protocol: TCP\n      port: 80\n      targetPort: 80\n  type: NodePort\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåå»ºService\n\n# kubectl apply -n zwf -f demo_service_nodeport.yaml \n\n# kubectl get svc -n zwf\nNAME                       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\ndemoapp-nodeport-service   NodePort   192.44.152.223   <none>        80:30337/TCP   64s\n\n\n1\n2\n3\n4\n5\n\n\n\n# è¯·æ±clusterip\n\néè¿clusterip+ç«¯å£çæ¹å¼è¯·æ±serviceï¼åçåä¸é¢å°æ¯ä¸æ ·çã\n\nå¨POSTROUTINGåOUTPUTä¸­æ·»å äºKUBE-SERVICESé¾ï¼å¶ä¸­åå«äºæ°å¢çserviceå¯¹åºçKUBE-SVC-XXXå­é¾ï¼å½è®¿é®çæ¯å¶clusteripæ¶ï¼åå¹éä¸è¯¥é¾ãå¨å¶ä¸­åå«äºä»å¤ä¸ªpodä¸­éæºéæ©ä¸ä¸ªè¿è¡DNATæä½ï¼æä¸æ è®°ï¼å¨POSTROUTINGä¸­åSNATã\n\n# iptables -L PREROUTING -t nat\nChain PREROUTING (policy ACCEPT)\ntarget     prot opt source               destination       \nKUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */\ncali-PREROUTING  all  --  anywhere             anywhere             /* cali:6gwbT8clXdHdC1b1 */\n\n\n# iptables -L KUBE-SERVICES -t nat | grep zwf\nKUBE-SVC-YSWRJGOK5VEB6HOG  tcp  --  anywhere             192.44.152.223       /* zwf/demoapp-nodeport-service:http cluster IP */ tcp dpt:http\n\n# iptables -L KUBE-SVC-YSWRJGOK5VEB6HOG -t nat |grep zwf\nKUBE-MARK-MASQ  tcp  -- !192.33.0.0/16        192.44.152.223       /* zwf/demoapp-nodeport-service:http cluster IP */ tcp dpt:http\nKUBE-MARK-MASQ  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337\nKUBE-SEP-NMMBRSZXI4OIWDPB  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability 0.33333333349\nKUBE-SEP-PXDORKZI3GD2RUMC  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability 0.50000000000\nKUBE-SEP-YLPOR67MTHPHIZAB  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# è¯·æ±èç¹IP\n\nä½æ¯å¦æä¸æ¯éè¿ClusterIPèæ¯éè¿èç¹IPè¯·æ±serviceå¢ï¼å®æ¯æä¹åçï¼\n\nå ä¸ºæ¯èç¹IPï¼æä»¥æ æ³å¹éä¸è¯¥serviceçKUBE-SVC-XXXå­é¾ï¼ä½æ¯æä¸æ¡KUBE-NODEPORTS\n\n# iptables -L KUBE-SERVICES  -t nat | grep KUBE-NODEPORTS\nKUBE-NODEPORTS  all  --  anywhere             anywhere             /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL\n\n\n1\n2\n\n\nå¨å¶ä¸­åå«äºä¸æ¡å­é¾KUBE-SVC-YSWRJGOK5VEB6HOG ï¼åªè¦ç®çç«¯å£ä¸º30337å°±è½å¹éä¸ï¼èè¿ä¸ªç«¯å£æ­£å¥½å°±æ¯demoapp-nodeport-service çNodePortç«¯å£ã\n\nè¿æ¡å­é¾åä¸é¢å¹éclusterIPæ¶æ¯åä¸ä¸ªé¾ï¼é½æ¯è¿è¡ä¸ä¸ªDNATæä½ã\n\n# # iptables -L KUBE-NODEPORTS -t nat | grep zwf\nKUBE-SVC-YSWRJGOK5VEB6HOG  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337\n\n\n1\n2\n\n\nâ\n\n\n# åèé¾æ¥\n\n * netfilter é¾æ¥è·è¸ªæºå¶ä¸NATåç\n * k8s ä¹ service ip\n * è¿æ¥è·è¸ª conntrack",normalizedContent:"# kubernetes serviceå¦ä½éè¿iptablesè½¬å\n\n\n# åè¨\n\næ¬æä¸»è¦æ¯ä»ç»kubernetesçserviceæ¯å¦ä½å©ç¨iptablesæ¥è¿è¡æµéçè½¬åè¾¾å°æµéçè´è½½åè¡¡çï¼å¹¶ä¼éè¿å®è·µæä½æ¥æ´å¥½ççè§£ä¸éªè¯å¶åçã\n\n\n# ç¯å¢æ­å»º\n\næ­å»ºç¯å¢å¦ä¸å¾æç¤ºï¼\n\n\n\n 1. åå»ºä¸ä¸ªdeployï¼è®¾ç½®å¶å¯æ¬æ°ä¸º3\n\napiversion: apps/v1\nkind: deployment\nmetadata:\n  name: demoapp-deployment\n  labels:\n    app: demoapp\nspec:\n  replicas: 3\n  selector:\n    matchlabels:\n      app: demoapp\n  template:\n    metadata:\n      labels:\n        app: demoapp\n    spec:\n      containers:\n        - name: ubuntu\n          image: ikubernetes/demoapp:v1.0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n 2. åå»ºserviceï¼ä¸ºä¸é¢deploymentç3ä¸ªpodè¿è¡è´è½½åè¡¡è®¿é®\n\napiversion: v1\nkind: service\nmetadata:\n  name: demoapp-service\nspec:\n  selector:\n    app: demoapp\n  clusterip: 192.44.140.73\n  ports:\n    - name: http\n      protocol: tcp\n      port: 80\n      targetport: 80\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n 3. éªè¯\n\nåå»ºå®åï¼ç¯å¢å¦ä¸ï¼\n\n# kubectl get pods -n zwf -o wide\nname                                  ready   status    restarts   age     ip\ndemoapp-deployment-64bdcb8666-4prbk   1/1     running   0          7d17h   192.33.229.12   dmoc-fa163eee1e30\ndemoapp-deployment-64bdcb8666-cxmmz   1/1     running   0          7d17h   192.33.73.139   dmoc-fa163e7188d6\ndemoapp-deployment-64bdcb8666-kkzsg   1/1     running   0          7d17h   192.33.206.93   dmoc-fa163ee6bbe1\ndemoapp-pod                           1/1     running   0          4d17h   192.33.73.172   dmoc-fa163e7188d6\n\n# kubectl get svc -n zwf\nname                       type        cluster-ip       external-ip   port(s)        age\ndemoapp-service            clusterip   192.44.140.73    <none>        80/tcp         7s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nå¯ä»¥ç´æ¥å¨ç¯å¢ä¸­è¯·æ±serviceçclusteripå°åï¼ä¼éæºè®¿é®å°ä¸ä¸ªpodï¼è¾åºçä¿¡æ¯åå«äºè¯·æ±ipåç®çipã\n\n# curl 192.44.140.73\nikubernetes demoapp v1.0 !! clientip: 10.10.10.16, servername: demoapp-deployment-64bdcb8666-kkzsg, serverip: 192.33.206.93!\n\n# curl 192.44.140.73\nikubernetes demoapp v1.0 !! clientip: 10.65.196.41, servername: demoapp-deployment-64bdcb8666-cxmmz, serverip: 192.33.73.139!\n\n# curl 192.44.140.73\nikubernetes demoapp v1.0 !! clientip: 10.10.10.16, servername: demoapp-deployment-64bdcb8666-4prbk, serverip: 192.33.229.12!\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# kube-services\n\nå¨prerouting åoutput é¾çnatè¡¨ä¸­ï¼é½åå«äºkube-services å­é¾ï¼è¯¥å­é¾ä¸­å°±åå«äºserivceçiptablesè§åçéç½®ã\n\n# iptables -l prerouting -t nat\nchain prerouting (policy accept)\ntarget     prot opt source               destination       \nkube-services  all  --  anywhere             anywhere             /* kubernetes service portals */\ncali-prerouting  all  --  anywhere             anywhere             /* cali:6gwbt8clxdhdc1b1 */\n\n# iptables -l output -t nat\nchain output (policy accept)\ntarget     prot opt source               destination       \nkube-services  all  --  anywhere             anywhere             /* kubernetes service portals */\ncali-output  all  --  anywhere             anywhere             /* cali:tvnhkvao15huipy0 */\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä¸ºä»ä¹å¨preroutingåoutputé¾ä¸­æ·»å serviceè§åï¼\n\nserviceçä½ç¨æ¯è´è½½åè¡¡ï¼ä¹å°±æ¯éè¦å°ipåè¿è¡dnatæä½ï¼èè¿ä¸ªæä½éè¦å¨æé è¿åéçä½ç½®ãç½å¡æ¶å°çåè¿å¥å°ç½ç»åè®®æ æ¶ï¼æåè¿å¥çå°±æ¯preroutingé¾ï¼ä¹å°±æ¯èç¹å¤é¨çæµéè¿å¥çå¥å£ãoutputæ¯æ¬å°è¿ç¨ååºçåæåè¿å¥çé¾ãæä»¥éè¦å¨è¿ä¸¤æ¡é¾ä¸­æ·»å kube-servicesï¼è¯¦æå¯åèå¿«éäºè§£iptables\n\nä¸ºä»ä¹natè¡¨ï¼\n\nå ä¸ºè¦ådnatæä½ï¼æä»¥å¨natè¡¨ã\n\nkube-servicesä¸é¢æè®¸å¤kube-svc-xxxçå­é¾ï¼æ¯ä¸æ¡å­é¾é½æ¯ä¸ä¸ªéç¾¤ä¸­ä¸ä¸ªserviceçéç½®ï¼ç­éä¸ä¸\n\néè¿ç­édemoapp-service å¾å°ä¸é¢çå­é¾ï¼åªæè®¿é®ç®çå°åä¸º192.44.140.73æè½è¿å¥å°è¯¥å­é¾ä¸­ã\n\n# iptables -l kube-services -t nat | grep demoapp-service\nkube-svc-fihihdnrzeg5vqeq  tcp  --  anywhere             192.44.140.73        /* zwf/demoapp-service:http cluster ip */ tcp dpt:http\n\n\n1\n2\n\n\næ¥çube-svc-fihihdnrzeg5vqeq é¾ä¸­åå®¹ï¼å¶ä¸­åå«äºåæ¡å­é¾ã\n\n# iptables -l kube-svc-fihihdnrzeg5vqeq -t nat -n\nchain kube-svc-fihihdnrzeg5vqeq (1 references)\ntarget     prot opt source               destination       \nkube-mark-masq  tcp  -- !192.33.0.0/16        192.44.140.73        /* zwf/demoapp-service:http cluster ip */ tcp dpt:80\nkube-sep-fo7yk2k5daktcvse  all  --  0.0.0.0/0            0.0.0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability 0.33333333349\nkube-sep-ipkl7nsntvgki4t5  all  --  0.0.0.0/0            0.0.0.0/0            /* zwf/demoapp-service:http */ statistic mode random probability 0.50000000000\nkube-sep-bper562isf3ufyoq  all  --  0.0.0.0/0            0.0.0.0/0            /* zwf/demoapp-service:http */\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nç¬¬ä¸æ¡é¾æ¯ï¼æºipä¸å¨192.33.0.0/16æ®µãç®çipä¸º192.44.140.73å¹¶ä¸ç®çç«¯å£æ¯80çæ°æ®åä¼å¹éå°è¯¥æ¡å­é¾è¿è¡è·³è½¬ãå¶ä¸­192.33.0.0/16æ¯podçç½æ®µï¼å¦æä¸æ¯éç¾¤åçæµéï¼åä¼å¹éä¸è¯¥æ¡å­é¾ï¼ä¼æä¸0x4000çæ è®°ã\n\n# iptables -l kube-mark-masq -t nat -n\nchain kube-mark-masq (548 references)\ntarget     prot opt source               destination       \nmark       all  --  0.0.0.0/0            0.0.0.0/0            mark or 0x4000\n\n\n1\n2\n3\n4\n\n\nåé¢çä¸æ¡é¾æ¯ä¸ºäºå°æµééæºçåéå°ä»»æä¸ä¸ªpodä¸­ãç¬¬äºæ¡é¾ä»£è¡¨çæ1/3çæ¦çä¼å¹éå°è¯¥é¾ï¼èç¬¬ä¸æ¡é¾ä»£è¡¨ç1/2ï¼æåä¸æ¡é¾ä»£è¡¨çç¾åç¾ã\n\nçç¬¬äºæ¡é¾ä¸­çè§åï¼ç¬¬ä¸æ¡è§åæ¯è·³è½¬å°å­é¾kube-mark-masq ï¼æºipä¸º192.33.206.93çæ°æ®åæä¸äº0x4000æ è®°ï¼åå°ç®çip dnatæ192.33.206.93ï¼è¯´æå¦æèªå·±è®¿é®èªå·±ï¼ä¹ä¼è¢«æä¸æ è®°ã\n\nè¿éç192.33.206.93æ¯æ¬èº«serviceæå¹éä¸çpod ipå°åï¼å¦æè°ç¨èªå·±çserviceåä¼å¹éä¸è¯¥é¾ï¼æä¸0x4000æ è®°ã\n\nèç¬¬äºæ¡è§åæ¯ä¸ä¸ªdnatæä½ï¼ä¼å°ç®æ å°åæ¹ä¸º192.33.206.93:80ï¼ä¹å°±æ¯podçå°åã\n\n # iptables -l kube-sep-fo7yk2k5daktcvse -t nat\nchain kube-sep-fo7yk2k5daktcvse (1 references)\ntarget     prot opt source               destination   \nkube-mark-masq  all  --  192.33.206.93        anywhere             /* zwf/demoapp-service:http */\ndnat       tcp  --  anywhere             anywhere             /* zwf/demoapp-service:http */ tcp to:192.33.206.93:80\n\n\n1\n2\n3\n4\n5\n\n\nå©ä¸çç¬¬3ã4æ¡è§åä¹æ¯ä¸æ ·çæä½ï¼ä¼å°æµédnatå°å¯¹åºçpodä¸­ã\n\n\n# postrouting\n\npostroutingä¸­åå«äºä¸æ¡kube-postroutingå­é¾ï¼å­é¾ä¹æ¯ç±kube-porxyæ¥åå¥çã\n\n# iptables -l postrouting -t nat\nchain postrouting (policy accept)\ntarget     prot opt source               destination       \nkube-postrouting  all  --  anywhere             anywhere             /* kubernetes postrouting rules */\ncali-postrouting  all  --  anywhere             anywhere             /* cali:o3lywmrlqyemjtb5 */\n\n\n1\n2\n3\n4\n5\n\n\næ¥çå­é¾kube-postrouting åå®¹ï¼\n\n 1. ç¬¬ä¸æ¡è§åæ¯æ²¡ææ è®°ä¸º0x400çæ°æ®åä¼returnï¼ä¸æ§è¡ä¸é¢çå­é¾ãè¿è®°å¾å¨kube-prerouting ä¸­æä¸¤æ¬¡æä¸0x4000æ è®°ï¼ä»£è¡¨çè®¿é®æ¯éç¾¤å¤é¨è®¿é®è¯¥serviceæèæ¯æºåç®çä¸æ ·ï¼é½ä¼å¾ä¸èµ°ã\n 2. ç¬¬äºæ¡è§åæ¯å¯¹æ°æ®åçæ è®°å¼è¿è¡å¼æï¼èè¿éæ¯0x4000ä¸0x4000è¿è¡å¼æï¼ä¹å°±æ¯0\n 3. ç¬¬ä¸æ¡è§åæ¶å¯¹è¯¥æ°æ®åè¿è¡snatï¼random-fullyæ¯å¯¹æºç«¯å£è¿è¡éæºè·åã\n\n# iptables -l kube-postrouting -t nat\nchain kube-postrouting (1 references)\ntarget     prot opt source               destination       \nreturn     all  --  anywhere             anywhere             mark match ! 0x4000/0x4000\nmark       all  --  anywhere             anywhere             mark xor 0x4000\nmasquerade  all  --  anywhere             anywhere             /* kubernetes service traffic requiring snat */ random-fully\n\n\n1\n2\n3\n4\n5\n6\n\n\nè¿éæä¸¤ç§æåµä¼è¢«snatï¼è¯´è¯´ä¸ºä»ä¹ã\n\n\n# snat\n\n\n# ä¸ºä»ä¹éç¾¤å¤é¨è®¿é®è¯¥serviceéè¦è¢«snatï¼\n\næ°æ®åéè¦ååï¼å¦ææ²¡æsnatï¼é£ä¹ååçç®çipæ¯å®¢æ·ç«¯çipï¼èæºipæ¯podçipï¼èå®¢æ·ç«¯å¹¶ä¸è®¤è¯¥æ°æ®åï¼åä¼è¢«ä¸¢å¼ã\n\nâ\n\nå¦ææåçsnatï¼é£ä¹ååçæ¶åå¯ä»¥åå°node1çèç¹ï¼ååå°clientã\n\nâ\n\nä½é®é¢åæ¥äºï¼æ¯æä¹ä»node1åååå°clientçå¢ï¼\n\n\n# conntrack\n\nconntrackæ¯ä¸ä¸ªè¿½è¸ªè¡¨ï¼å¨æ¯ä¸ä¸ªæ°æ®åè¿å¥å°netfilterçæ¶åï¼é½ä¼è®°å½ä¸æ¡è®°å½ï¼å½æä»¬è¿è¡snatådnatçæ¶åä¹é½ä¼æ´æ°è¯¥è¡¨ä¸­çè®°å½ã\n\næä»¥å¨node1ååç»clientæ¶åï¼å¯ä»¥éè¿æ¥è¯¢è¿ä¸ªè¡¨ä¸­çè®°å½ï¼ç¶ååæ¬¡snatådnatæ¢å¤åå»å°±å¯ä»¥è¿è¡æ­£å¸¸çååäºã\n\n\n\nå¯ä»¥çä¸conntrackéé¢çè®°å½é¿ä»ä¹æ ·å­ã\n\nåå¨æä¸å°èç¹ä¸curl serviceçipï¼ä¸å¾çclientå¶å®ä¹æ¯å¨node1ä¸çï¼å ä¸ºnode1ä¸æä¸¤å¼ ç½å¡ï¼node1ånode2çéä¿¡ä½¿ç¨çç½å¡eth2 ipä¸º10.10.10.16ï¼å ä¸ºè½¬åå°å¶ä»èç¹ï¼æä»¥ä¼è¢«snatã\n\n# curl 192.44.140.73\nikubernetes demoapp v1.0 !! clientip: 10.10.10.16, servername: demoapp-deployment-64bdcb8666-4prbk, serverip: 192.33.229.12!\n\n\n1\n2\n\n\nè¿éä¸»è¦æ¯çsrcådståå«æ¯clientè¯·æ±serviceçç®çipï¼ç¶ååé¢åæä¸ä¸ªsrcådstå®æ¯ç±node2ååç»node1çæºåç®çipï¼ä¹å°±æ¯æºæ¯podçipï¼dstæ¯node1èç¹ipã\n\nåé¢æ¯åéåçæ¹åï¼åé¢æ¯ååçæ¹åãéè¿æ¥è¯¢è¯¥è¡¨ï¼å³å¯ä»¥ä»node1ååç»client\n\n# conntrack -l | grep 192.33.229.12\ntcp      6 107 time_wait src=10.65.196.41 dst=192.44.140.73 sport=33468 dport=80 src=192.33.229.12 dst=10.10.10.16 sport=80 dport=18623 [assured] mark=0 use=1\n\n\n1\n2\n\n\nâ\n\n\n# æºåç®çipç¸å\n\nå½podè®¿é®serviceæ¶ï¼æ­£å¥½dnatæèªå·±çipï¼é£ä¹å°±å­å¨æºåç®çipä¸æ ·çæåµã\n\n\n\nè¿ç§æ°æ®åæ¯å¾ç¹æ®çå­å¨ï¼ç½ç»è®¾å¤å¯è½ä¼å°è¿ç§æ°æ®åè§ä¸ºæ ææèå¼å¸¸çåè¢«ä¸¢å¼ï¼æå¥½ä¸è¦ä¸æ ·ï¼æä»¥ä¼å°æºip snatä¸ºä¸»æºçipï¼è§£å³è¯¥é®é¢ã\n\nå®éª\n\n\n\nå½åèç¹çipä¸ºï¼10.65.196.41ï¼ç¶åè¿å¥å¨å½åèç¹çpodåï¼å½åpodçipä¸ºï¼192.33.73.139\n\nkubectl exec -it -n zwf demoapp-deployment-64bdcb8666-cxmmz -- sh\n\n\n\n1\n2\n\n\nè¿è¡å¤æ¬¡curl service ipï¼å½æä¸æ¬¡è¯·æ±å°æ¬podçipæ¶ï¼æ¥çå¶clientipï¼åç°å¶æºipæ¯ï¼10.65.196.41ï¼è¿ä¸ªå½åèç¹çip\n\n# curl 192.44.140.73\nikubernetes demoapp v1.0 !! clientip: 10.65.196.41, servername: demoapp-deployment-64bdcb8666-cxmmz, serverip: 192.33.73.139!\n\n\n1\n2\n\n\n\n# nodeport\n\nä¸é¢ä»ç»çæ¯serivi type=clusteripæ¹å¼çï¼é£ä¹nodeportæä»ä¹åºå«å¢ï¼\n\n\n# æ­å»ºç¯å¢\n\nåå°clusteripçserviceå äºï¼é²æ­¢å¹²æ°ã\n\nkubectl delete svc -n zwf demoapp-service\n\n\n1\n\n\nåå»ºnodeportçserviceæä»¶demo_service_nodeport.yaml\n\napiversion: v1\nkind: service\nmetadata:\n  name: demoapp-nodeport-service\nspec:\n  selector:\n    app: demoapp\n  ports:\n    - name: http\n      protocol: tcp\n      port: 80\n      targetport: 80\n  type: nodeport\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåå»ºservice\n\n# kubectl apply -n zwf -f demo_service_nodeport.yaml \n\n# kubectl get svc -n zwf\nname                       type       cluster-ip       external-ip   port(s)        age\ndemoapp-nodeport-service   nodeport   192.44.152.223   <none>        80:30337/tcp   64s\n\n\n1\n2\n3\n4\n5\n\n\n\n# è¯·æ±clusterip\n\néè¿clusterip+ç«¯å£çæ¹å¼è¯·æ±serviceï¼åçåä¸é¢å°æ¯ä¸æ ·çã\n\nå¨postroutingåoutputä¸­æ·»å äºkube-servicesé¾ï¼å¶ä¸­åå«äºæ°å¢çserviceå¯¹åºçkube-svc-xxxå­é¾ï¼å½è®¿é®çæ¯å¶clusteripæ¶ï¼åå¹éä¸è¯¥é¾ãå¨å¶ä¸­åå«äºä»å¤ä¸ªpodä¸­éæºéæ©ä¸ä¸ªè¿è¡dnatæä½ï¼æä¸æ è®°ï¼å¨postroutingä¸­åsnatã\n\n# iptables -l prerouting -t nat\nchain prerouting (policy accept)\ntarget     prot opt source               destination       \nkube-services  all  --  anywhere             anywhere             /* kubernetes service portals */\ncali-prerouting  all  --  anywhere             anywhere             /* cali:6gwbt8clxdhdc1b1 */\n\n\n# iptables -l kube-services -t nat | grep zwf\nkube-svc-yswrjgok5veb6hog  tcp  --  anywhere             192.44.152.223       /* zwf/demoapp-nodeport-service:http cluster ip */ tcp dpt:http\n\n# iptables -l kube-svc-yswrjgok5veb6hog -t nat |grep zwf\nkube-mark-masq  tcp  -- !192.33.0.0/16        192.44.152.223       /* zwf/demoapp-nodeport-service:http cluster ip */ tcp dpt:http\nkube-mark-masq  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337\nkube-sep-nmmbrszxi4oiwdpb  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability 0.33333333349\nkube-sep-pxdorkzi3gd2rumc  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ statistic mode random probability 0.50000000000\nkube-sep-ylpor67mthphizab  all  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# è¯·æ±èç¹ip\n\nä½æ¯å¦æä¸æ¯éè¿clusteripèæ¯éè¿èç¹ipè¯·æ±serviceå¢ï¼å®æ¯æä¹åçï¼\n\nå ä¸ºæ¯èç¹ipï¼æä»¥æ æ³å¹éä¸è¯¥serviceçkube-svc-xxxå­é¾ï¼ä½æ¯æä¸æ¡kube-nodeports\n\n# iptables -l kube-services  -t nat | grep kube-nodeports\nkube-nodeports  all  --  anywhere             anywhere             /* kubernetes service nodeports; note: this must be the last rule in this chain */ addrtype match dst-type local\n\n\n1\n2\n\n\nå¨å¶ä¸­åå«äºä¸æ¡å­é¾kube-svc-yswrjgok5veb6hog ï¼åªè¦ç®çç«¯å£ä¸º30337å°±è½å¹éä¸ï¼èè¿ä¸ªç«¯å£æ­£å¥½å°±æ¯demoapp-nodeport-service çnodeportç«¯å£ã\n\nè¿æ¡å­é¾åä¸é¢å¹éclusteripæ¶æ¯åä¸ä¸ªé¾ï¼é½æ¯è¿è¡ä¸ä¸ªdnatæä½ã\n\n# # iptables -l kube-nodeports -t nat | grep zwf\nkube-svc-yswrjgok5veb6hog  tcp  --  anywhere             anywhere             /* zwf/demoapp-nodeport-service:http */ tcp dpt:30337\n\n\n1\n2\n\n\nâ\n\n\n# åèé¾æ¥\n\n * netfilter é¾æ¥è·è¸ªæºå¶ä¸natåç\n * k8s ä¹ service ip\n * è¿æ¥è·è¸ª conntrack",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥",frontmatter:{title:"ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥",date:"2025-09-14T10:07:39.000Z",permalink:"/pages/cf65ba/",categories:["Bug éç¼ä»¤"],tags:["PostgreSQL","sqlalchemy","python","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æè¯¦ç»åæäºä¸æ¬¡å PostgreSQLè¡¨DDLæ§è¡è¶æ¶å¤±è´¥èå¯¼è´çæå¡åçº§é®é¢ï¼éè¿SQLæ¥è¯¢åä»£ç å®¡æ¥å®ä½å°é®é¢æ ¹æºï¼æ­ç¤ºäºæ°æ®åºéæºå¶åèµæºç®¡ççéè¦æ§ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17578168418231757816840915.png"},{name:"twitter:title",content:"ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥"},{name:"twitter:description",content:"æ¬æè¯¦ç»åæäºä¸æ¬¡å PostgreSQLè¡¨DDLæ§è¡è¶æ¶å¤±è´¥èå¯¼è´çæå¡åçº§é®é¢ï¼éè¿SQLæ¥è¯¢åä»£ç å®¡æ¥å®ä½å°é®é¢æ ¹æºï¼æ­ç¤ºäºæ°æ®åºéæºå¶åèµæºç®¡ççéè¦æ§ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17578168418231757816840915.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4/01.%E4%B8%80%E6%AC%A1%E6%9C%8D%E5%8A%A1%E5%8D%87%E7%BA%A7%E6%97%B6pg%E8%A1%A8DDL%E6%89%A7%E8%A1%8C%E8%B6%85%E6%97%B6%E5%A4%B1%E8%B4%A5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥"},{property:"og:description",content:"æ¬æè¯¦ç»åæäºä¸æ¬¡å PostgreSQLè¡¨DDLæ§è¡è¶æ¶å¤±è´¥èå¯¼è´çæå¡åçº§é®é¢ï¼éè¿SQLæ¥è¯¢åä»£ç å®¡æ¥å®ä½å°é®é¢æ ¹æºï¼æ­ç¤ºäºæ°æ®åºéæºå¶åèµæºç®¡ççéè¦æ§ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17578168418231757816840915.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4/01.%E4%B8%80%E6%AC%A1%E6%9C%8D%E5%8A%A1%E5%8D%87%E7%BA%A7%E6%97%B6pg%E8%A1%A8DDL%E6%89%A7%E8%A1%8C%E8%B6%85%E6%97%B6%E5%A4%B1%E8%B4%A5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-09-14T10:07:39.000Z"},{property:"article:tag",content:"PostgreSQL"},{property:"article:tag",content:"sqlalchemy"},{property:"article:tag",content:"python"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥"},{itemprop:"description",content:"æ¬æè¯¦ç»åæäºä¸æ¬¡å PostgreSQLè¡¨DDLæ§è¡è¶æ¶å¤±è´¥èå¯¼è´çæå¡åçº§é®é¢ï¼éè¿SQLæ¥è¯¢åä»£ç å®¡æ¥å®ä½å°é®é¢æ ¹æºï¼æ­ç¤ºäºæ°æ®åºéæºå¶åèµæºç®¡ççéè¦æ§ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17578168418231757816840915.png"}],readingShow:"top"},regularPath:"/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4/01.%E4%B8%80%E6%AC%A1%E6%9C%8D%E5%8A%A1%E5%8D%87%E7%BA%A7%E6%97%B6pg%E8%A1%A8DDL%E6%89%A7%E8%A1%8C%E8%B6%85%E6%97%B6%E5%A4%B1%E8%B4%A5.html",relativePath:"02.Bug éç¼ä»¤/01.ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥.md",key:"v-e543b750",path:"/pages/cf65ba/",headers:[{level:2,title:"èæ¯",slug:"èæ¯",normalizedTitle:"èæ¯",charIndex:2},{level:2,title:"åæ",slug:"åæ",normalizedTitle:"åæ",charIndex:126},{level:2,title:"åå ",slug:"åå ",normalizedTitle:"åå ",charIndex:1260},{level:2,title:"ç»è®º",slug:"ç»è®º",normalizedTitle:"ç»è®º",charIndex:2327}],headersStr:"èæ¯ åæ åå  ç»è®º",content:'# èæ¯\n\nå¨ä¸æ¬¡ä¸å¡åçº§è¿ç¨ä¸­ï¼éè¦éå¯¹ Postgresql ä½¿ç¨ DDL å¯¹æä¸ªè¡¨æ°å¢ä¸ä¸ªå­æ®µï¼åçº§è¿ç¨ä¸­å¤±è´¥äºï¼æ¥éä¿¡æ¯å¦ä¸ï¼\n\nERROR:  canceling statement due to lock tiemout\n\n\n1\n\n\n\n# åæ\n\nDDL å¨æ§è¡çæ¶åéè¦æ¿å° ACCESS EXCLUSIVE éï¼èå®æ¯æå¼ºçè¡¨çº§éï¼åªæå½è¡¨ä¸­æ²¡æä»»ä½æ´»å¨çäºå¡æ¶æè½æ¿å°è¯¥éã\n\næ¥è¯¢ lock timeout åç°å¶è®¾ç½®ä¸º 2 åéã\n\néè¿æ¥éä¿¡æ¯å¯ä»¥çå°å®è·åéå¤±è´¥äºï¼æä»¥æä»¬å¤§èççæµä¸ä¸æ¯æä¸å¡ä¸­æäºå¡è¶è¿ 2 åéï¼ä»èå¯¼è´ DDL ä¸ç´æ æ³æ¿å°éã\n\néè¿ä¸é¢ç SQL æ¥æ¥è¯¢å½åè¶è¿ 2 åéçæ´»å¨æ¥è¯¢ï¼å¯ä»¥å®ä½ææ¡ SQLã\n\nSELECT \n    pid,\n    now() - query_start AS duration,\n    state,\n    query,\n    application_name,\n    client_addr,\n    client_application_name,\n    xact_start,\n    query_start\nFROM pg_stat_activity \nWHERE state = \'active\'\n  AND now() - query_start > interval \'2 minutes\'\n  AND pid <> pg_backend_pid()  -- æé¤å½åæ¥è¯¢èªèº«\n  AND datname = \'your_database_name\'  -- æ¿æ¢ä¸ºä½ çæ°æ®åºå\nORDER BY query_start;\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\næåæ¾å°äºä¸æ¡æ¥è¯¢ SQLï¼æ¥è¯¢æ¶ä¼æ¿ ACCESS SHARE éï¼æä»¥å¶é»å¡äº DDL çæ§è¡ã\n\nè¿éåä¸ä¸ªæµè¯ postgresql æ¿éå¤±è´¥çæµè¯ã\n\nä½¿ç¨ postgresql å®¢æ·ç«¯åå»ºä¸ä¸ªäºå¡ï¼å¯¹ä¸ä¸ªè¡¨è¿è¡æ¥è¯¢ï¼ä½æ¯ä¸å³é­ã\n\n# begin;\nBEGIN\n# select * from apollo.task limit 1;\n....\n\n\n1\n2\n3\n4\n\n\nèåå¨å¦ä¸ä¸ªå®¢æ·ç«¯éå¯¹è¯¥è¡¨ä¸­æ§è¡ä¸ä¸ª DDL è¯­å¥ï¼åç°å¶è¶æ¶äºã\n\n# ALTER TABLE apollo.task ADD COLUMN IF NOT EXISTS test int;\nERROR:  canceling statement due to lock timeout\n\n\n1\n2\n\n\næåå¨ç¬¬ä¸ä¸ªå®¢æ·ç«¯ä¸­ç»æäºå¡\n\n# end;\nCOMMIT\n\n\n1\n2\n\n\nåå¨ç¬¬äºä¸ªå®¢æ·ç«¯åæ¬¡æ§è¡ DDL è¯­å¥ï¼æ¾èæè§çæåäºã\n\n# ALTER TABLE apollo.task ADD COLUMN IF NOT EXISTS test2 int;\nALTER TABLE\n\n\n1\n2\n\n\n\n# åå \n\nç°å¨æä»¬éè¿è¯¥æ¡ SQL ä»ä¸å¡ä»£ç ä¸­å»æ¾å°æ§è¡çå°æ¹ã\n\næååç°æ¯å¨ä»£ç ä¸­ä½¿ç¨äºä¸ä¸ªå·²ç»å³é­çsessionï¼å¯¼è´session æç»­è¢«æå¼èæ²¡æå³é­ï¼ä»£ç å¦ä¸ï¼\n\nfrom sqlalchemy.orm.session import sessionmaker\n_Session = sessionmaker()\n\n@contextmanager\ndef open_session():\n    """\n    éç¨psqlçsessionä¸ä¸æç®¡çå¨\n    """\n\n    try:\n        session = _Session()\n        yield session\n        session.commit()\n    except OperationalError as e:\n        logging.error(f"Postgresql connection error: {e}, track: {traceback.format_exc()}")\n        reconnection()\n    except Exception:\n        session.rollback()\n        raise\n    finally:\n        session.close()\n\nwith open_session() as session:\n    pass\n\ntask = TaskModel.get_by_id(session, task_id)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\nå¯ä»¥çå°æä½¿ç¨ä¸ä¸ªä¸ä¸æç®¡çå¨æ¥ç®¡çsessionçåå»ºä¸å³é­ï¼èæåä¸è¡å¨ with çä½ç¨åå¤é¢ä½¿ç¨äº sessionï¼ä½æ¯è¯¥sessionæ¯å¨ with ç»ææ¶æ¯è°ç¨äº session.close() æ¹æ³çã\n\néè¿æ¥ç sqlalchemy å®ç½æ¥è¯¢ï¼å³ä½¿æ¯ close() ä¾ç¶å¯è½åæ¬¡è¢«ä½¿ç¨ã\n\nhttps://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.close\n\n\n\nä¹å°±æ¯è¯´ï¼æåä¸è¡ä½¿ç¨äº session ä½æ¯æ²¡æåæ¬¡å¯¹å¶è¿è¡å³é­ï¼å¯¼è´å¶æç»­æ´»å¨ï¼å¯¼è´æ§è¡ DDL æ æ³è·åå° ACCESS EXCLUSIVE éï¼æç»è¶æ¶å¤±è´¥ã\n\n\n# ç»è®º\n\n 1. å³ä½¿æ¯è¢«close()çå¯¹è±¡ä¸è½åæ¬¡è¢«ä½¿ç¨ï¼æéèçé£é©ã\n 2. ä½¿ç¨å®èµæºåï¼ä¸å®è¦è®°å¾å³é­ã',normalizedContent:'# èæ¯\n\nå¨ä¸æ¬¡ä¸å¡åçº§è¿ç¨ä¸­ï¼éè¦éå¯¹ postgresql ä½¿ç¨ ddl å¯¹æä¸ªè¡¨æ°å¢ä¸ä¸ªå­æ®µï¼åçº§è¿ç¨ä¸­å¤±è´¥äºï¼æ¥éä¿¡æ¯å¦ä¸ï¼\n\nerror:  canceling statement due to lock tiemout\n\n\n1\n\n\n\n# åæ\n\nddl å¨æ§è¡çæ¶åéè¦æ¿å° access exclusive éï¼èå®æ¯æå¼ºçè¡¨çº§éï¼åªæå½è¡¨ä¸­æ²¡æä»»ä½æ´»å¨çäºå¡æ¶æè½æ¿å°è¯¥éã\n\næ¥è¯¢ lock timeout åç°å¶è®¾ç½®ä¸º 2 åéã\n\néè¿æ¥éä¿¡æ¯å¯ä»¥çå°å®è·åéå¤±è´¥äºï¼æä»¥æä»¬å¤§èççæµä¸ä¸æ¯æä¸å¡ä¸­æäºå¡è¶è¿ 2 åéï¼ä»èå¯¼è´ ddl ä¸ç´æ æ³æ¿å°éã\n\néè¿ä¸é¢ç sql æ¥æ¥è¯¢å½åè¶è¿ 2 åéçæ´»å¨æ¥è¯¢ï¼å¯ä»¥å®ä½ææ¡ sqlã\n\nselect \n    pid,\n    now() - query_start as duration,\n    state,\n    query,\n    application_name,\n    client_addr,\n    client_application_name,\n    xact_start,\n    query_start\nfrom pg_stat_activity \nwhere state = \'active\'\n  and now() - query_start > interval \'2 minutes\'\n  and pid <> pg_backend_pid()  -- æé¤å½åæ¥è¯¢èªèº«\n  and datname = \'your_database_name\'  -- æ¿æ¢ä¸ºä½ çæ°æ®åºå\norder by query_start;\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\næåæ¾å°äºä¸æ¡æ¥è¯¢ sqlï¼æ¥è¯¢æ¶ä¼æ¿ access share éï¼æä»¥å¶é»å¡äº ddl çæ§è¡ã\n\nè¿éåä¸ä¸ªæµè¯ postgresql æ¿éå¤±è´¥çæµè¯ã\n\nä½¿ç¨ postgresql å®¢æ·ç«¯åå»ºä¸ä¸ªäºå¡ï¼å¯¹ä¸ä¸ªè¡¨è¿è¡æ¥è¯¢ï¼ä½æ¯ä¸å³é­ã\n\n# begin;\nbegin\n# select * from apollo.task limit 1;\n....\n\n\n1\n2\n3\n4\n\n\nèåå¨å¦ä¸ä¸ªå®¢æ·ç«¯éå¯¹è¯¥è¡¨ä¸­æ§è¡ä¸ä¸ª ddl è¯­å¥ï¼åç°å¶è¶æ¶äºã\n\n# alter table apollo.task add column if not exists test int;\nerror:  canceling statement due to lock timeout\n\n\n1\n2\n\n\næåå¨ç¬¬ä¸ä¸ªå®¢æ·ç«¯ä¸­ç»æäºå¡\n\n# end;\ncommit\n\n\n1\n2\n\n\nåå¨ç¬¬äºä¸ªå®¢æ·ç«¯åæ¬¡æ§è¡ ddl è¯­å¥ï¼æ¾èæè§çæåäºã\n\n# alter table apollo.task add column if not exists test2 int;\nalter table\n\n\n1\n2\n\n\n\n# åå \n\nç°å¨æä»¬éè¿è¯¥æ¡ sql ä»ä¸å¡ä»£ç ä¸­å»æ¾å°æ§è¡çå°æ¹ã\n\næååç°æ¯å¨ä»£ç ä¸­ä½¿ç¨äºä¸ä¸ªå·²ç»å³é­çsessionï¼å¯¼è´session æç»­è¢«æå¼èæ²¡æå³é­ï¼ä»£ç å¦ä¸ï¼\n\nfrom sqlalchemy.orm.session import sessionmaker\n_session = sessionmaker()\n\n@contextmanager\ndef open_session():\n    """\n    éç¨psqlçsessionä¸ä¸æç®¡çå¨\n    """\n\n    try:\n        session = _session()\n        yield session\n        session.commit()\n    except operationalerror as e:\n        logging.error(f"postgresql connection error: {e}, track: {traceback.format_exc()}")\n        reconnection()\n    except exception:\n        session.rollback()\n        raise\n    finally:\n        session.close()\n\nwith open_session() as session:\n    pass\n\ntask = taskmodel.get_by_id(session, task_id)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\nå¯ä»¥çå°æä½¿ç¨ä¸ä¸ªä¸ä¸æç®¡çå¨æ¥ç®¡çsessionçåå»ºä¸å³é­ï¼èæåä¸è¡å¨ with çä½ç¨åå¤é¢ä½¿ç¨äº sessionï¼ä½æ¯è¯¥sessionæ¯å¨ with ç»ææ¶æ¯è°ç¨äº session.close() æ¹æ³çã\n\néè¿æ¥ç sqlalchemy å®ç½æ¥è¯¢ï¼å³ä½¿æ¯ close() ä¾ç¶å¯è½åæ¬¡è¢«ä½¿ç¨ã\n\nhttps://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.session.close\n\n\n\nä¹å°±æ¯è¯´ï¼æåä¸è¡ä½¿ç¨äº session ä½æ¯æ²¡æåæ¬¡å¯¹å¶è¿è¡å³é­ï¼å¯¼è´å¶æç»­æ´»å¨ï¼å¯¼è´æ§è¡ ddl æ æ³è·åå° access exclusive éï¼æç»è¶æ¶å¤±è´¥ã\n\n\n# ç»è®º\n\n 1. å³ä½¿æ¯è¢«close()çå¯¹è±¡ä¸è½åæ¬¡è¢«ä½¿ç¨ï¼æéèçé£é©ã\n 2. ä½¿ç¨å®èµæºåï¼ä¸å®è¦è®°å¾å³é­ã',charsets:{cjk:!0},lastUpdated:"2025/09/14, 11:01:01",lastUpdatedTimestamp:1757818861e3},{title:"kube-proxyæºç åæ",frontmatter:{title:"kube-proxyæºç åæ",date:"2024-01-18T16:43:23.000Z",permalink:"/pages/6e0045/",categories:["äºåç","k8s"],tags:["k8s","æºç åæ","go"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦æ¯å¯¹kube-proxyçæºç åæï¼äºè§£å¶ä»£ç ç»æåå®ç°åçãè¿éæ¯æ ¹æ®[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)çæ¬æ¥è¿è¡åæçãå¨ä¸é¢è´´ä¸çä»£ç ä¼ä¸å®è£åªï¼ä¸»è¦ç¨äºçè§£ä¸»æµç¨ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png"},{name:"twitter:title",content:"kube-proxyæºç åæ"},{name:"twitter:description",content:"æ¬æä¸»è¦æ¯å¯¹kube-proxyçæºç åæï¼äºè§£å¶ä»£ç ç»æåå®ç°åçãè¿éæ¯æ ¹æ®[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)çæ¬æ¥è¿è¡åæçãå¨ä¸é¢è´´ä¸çä»£ç ä¼ä¸å®è£åªï¼ä¸»è¦ç¨äºçè§£ä¸»æµç¨ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/17.kube-proxy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:type",content:"article"},{property:"og:title",content:"kube-proxyæºç åæ"},{property:"og:description",content:"æ¬æä¸»è¦æ¯å¯¹kube-proxyçæºç åæï¼äºè§£å¶ä»£ç ç»æåå®ç°åçãè¿éæ¯æ ¹æ®[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)çæ¬æ¥è¿è¡åæçãå¨ä¸é¢è´´ä¸çä»£ç ä¼ä¸å®è£åªï¼ä¸»è¦ç¨äºçè§£ä¸»æµç¨ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/17.kube-proxy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2024-01-18T16:43:23.000Z"},{property:"article:tag",content:"k8s"},{property:"article:tag",content:"æºç åæ"},{property:"article:tag",content:"go"},{itemprop:"name",content:"kube-proxyæºç åæ"},{itemprop:"description",content:"æ¬æä¸»è¦æ¯å¯¹kube-proxyçæºç åæï¼äºè§£å¶ä»£ç ç»æåå®ç°åçãè¿éæ¯æ ¹æ®[kubernetes1.23.9](https://github.com/kubernetes/kubernetes/tree/v1.23.9)çæ¬æ¥è¿è¡åæçãå¨ä¸é¢è´´ä¸çä»£ç ä¼ä¸å®è£åªï¼ä¸»è¦ç¨äºçè§£ä¸»æµç¨ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/image-20240118162033-mma8vs8.png"}],readingShow:"top"},regularPath:"/01.%E4%BA%91%E5%8E%9F%E7%94%9F/07.k8s/17.kube-proxy%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html",relativePath:"01.äºåç/07.k8s/17.kube-proxyæºç åæ.md",key:"v-3c54c66f",path:"/pages/6e0045/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:21},{level:2,title:"åå§å",slug:"åå§å",normalizedTitle:"åå§å",charIndex:119},{level:2,title:"Run",slug:"run",normalizedTitle:"run",charIndex:225},{level:2,title:"service å endpointslice åæ´äºä»¶",slug:"service-å-endpointslice-åæ´äºä»¶",normalizedTitle:"service å endpointslice åæ´äºä»¶",charIndex:12013},{level:2,title:"BoundedFrequencyRunner",slug:"boundedfrequencyrunner",normalizedTitle:"boundedfrequencyrunner",charIndex:9187},{level:2,title:"syncProxyRules",slug:"syncproxyrules",normalizedTitle:"syncproxyrules",charIndex:9117},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:19890},{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:20381}],headersStr:"ç®ä» åå§å Run service å endpointslice åæ´äºä»¶ BoundedFrequencyRunner syncProxyRules æ»ç» ç¸å³é¾æ¥",content:'# kube-proxyæºç åæ\n\n\n# ç®ä»\n\næ¬æä¸»è¦æ¯å¯¹kube-proxyçæºç åæï¼äºè§£å¶ä»£ç ç»æåå®ç°åçãè¿éæ¯æ ¹æ®kubernetes1.23.9çæ¬æ¥è¿è¡åæçãå¨ä¸é¢è´´ä¸çä»£ç ä¼ä¸å®è£åªï¼ä¸»è¦ç¨äºçè§£ä¸»æµç¨ã\n\n\n# åå§å\n\nkube-proxyå¥å£æä»¶å¨cmd/kube-proxy/proxy.go\n\nfunc main() {\n\tcommand := app.NewProxyCommand()\n\tcode := cli.Run(command)\n\tos.Exit(code)\n}\n\n\n1\n2\n3\n4\n5\n\n\næ¥çapp.NewProxyCommand()æ¹æ³ï¼ä½¿ç¨çcobraå½ä»¤è¡è§£æåºæ¥ä½ä¸ºç¨åºå¥å£\n\nfunc NewProxyCommand() *cobra.Command {\n\topts := NewOptions()\n\n\tcmd := &cobra.Command{\n\t\tUse: "kube-proxy",\n\t\tLong: `The Kubernetes network proxy runs on each node. This\nreflects services as defined in the Kubernetes API on each node and can do simple\nTCP, UDP, and SCTP stream forwarding or round robin TCP, UDP, and SCTP forwarding across a set of backends.\nService cluster IPs and ports are currently found through Docker-links-compatible\nenvironment variables specifying ports opened by the service proxy. There is an optional\naddon that provides cluster DNS for these cluster IPs. The user must create a service\nwith the apiserver API to configure the proxy.`,\n\t\tRunE: func(cmd *cobra.Command, args []string) error {\n\t\t\tverflag.PrintAndExitIfRequested()\n\t\t\tcliflag.PrintFlags(cmd.Flags())\n\n\t\t\tif err := initForOS(opts.WindowsService); err != nil {\n\t\t\t\treturn fmt.Errorf("failed os init: %w", err)\n\t\t\t}\n\n\t\t\t// 1. å è½½éç½®æä»¶kubeproxyconfig.KubeProxyConfiguration\n\t\t\t// 2. çæ§æä»¶åå\n\t\t\tif err := opts.Complete(); err != nil {\n\t\t\t\treturn fmt.Errorf("failed complete: %w", err)\n\t\t\t}\n\n\t\t\t// éç½®åæ°çæ ¡éª\n\t\t\tif err := opts.Validate(); err != nil {\n\t\t\t\treturn fmt.Errorf("failed validate: %w", err)\n\t\t\t}\n\n\t\t\t// è¿è¡æå¡\n\t\t\tif err := opts.Run(); err != nil {\n\t\t\t\tklog.ErrorS(err, "Error running ProxyServer")\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\treturn nil\n\t\t},\n\t\tArgs: func(cmd *cobra.Command, args []string) error {\n\t\t\tfor _, arg := range args {\n\t\t\t\tif len(arg) > 0 {\n\t\t\t\t\treturn fmt.Errorf("%q does not take any arguments, got %q", cmd.CommandPath(), args)\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn nil\n\t\t},\n\t}\n\n\tvar err error\n    // å¡«åä¸äºé»è®¤éç½®\n\topts.config, err = opts.ApplyDefaults(opts.config)\n\tif err != nil {\n\t\tklog.ErrorS(err, "Unable to create flag defaults")\n\t\t// ACTION REQUIRED: Exit code changed from 255 to 1\n\t\tos.Exit(1)\n\t}\n\n\tfs := cmd.Flags()\n\topts.AddFlags(fs)\n\t// å°goçå½ä»¤è¡åæ°ä¹å å°å½ä»¤è¡åæ°ä¸­\n\tfs.AddGoFlagSet(goflag.CommandLine) // for --boot-id-file and --machine-id-file\n\n\t_ = cmd.MarkFlagFilename("config", "yaml", "yml", "json")\n\n\treturn cmd\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n\n 1. è¯»åéç½®æä»¶KubeProxyConfigurationï¼å¹¶çå¬ååæ¶å°å¯¹åºçäºä»¶\n 2. å¯¹éç½®KubeProxyConfigurationè¿è¡æ ¡éª\n 3. å¯å¨æå¡\n\nåæ¥çopts.Run() æå¡å¯å¨çå®ç°\n\nfunc (o *Options) Run() error {\n\tdefer close(o.errCh)\n\n    // å¦æéç½®äºè¯¥å­æ®µï¼å°éç½®æä»¶åå¥æå®ä½ç½®ï¼ç¶åéåº\n\tif len(o.WriteConfigTo) > 0 {\n\t\treturn o.writeConfigFile()\n\t}\n\n    // åå»ºä»£çæå¡\n\tproxyServer, err := NewProxyServer(o)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// æ¸é¤ææçiptablesè§å\n\tif o.CleanupAndExit {\n\t\treturn proxyServer.CleanupAndExit()\n\t}\n\n\t// å¯å¨ä»£çæå¡\n\to.proxyServer = proxyServer\n\treturn o.runLoop()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåçNewProxyServer() çå®ç°ï¼ä¸»è¦æ¯ç¨æ¥åå»ºproxyServerå¯¹è±¡ï¼å¹¶ä¸å¨å¶ä¸­æ ¹æ®å½åçç½ç»æ¨¡å¼ï¼éè¿iptables.NewProxieræ¥åå»ºproxierå¯¹è±¡ã\n\nfunc NewProxyServer(o *Options) (*ProxyServer, error) {\n\treturn newProxyServer(o.config, o.CleanupAndExit, o.master)\n}\n\nfunc newProxyServer(\n\tconfig *proxyconfigapi.KubeProxyConfiguration,\n\tcleanupAndExit bool,\n\tmaster string) (*ProxyServer, error) {\n\n\t// æ§è¡æ¬å°å½ä»¤çæ§å¶å¨\n\texecer := exec.New()\n\n\tkernelHandler = ipvs.NewLinuxKernelHandler() \n    // åå»ºipsetå½ä»¤çæ§è¡å¨\n\tipsetInterface = utilipset.New(execer)\n    // å¤æ­æ¯å¦æ¯æipvs\n\tcanUseIPVS, err := ipvs.CanUseIPVSProxier(kernelHandler, ipsetInterface, config.IPVS.Scheduler)\n\tif string(config.Mode) == proxyModeIPVS && err != nil {\n\t\tklog.ErrorS(err, "Can\'t use the IPVS proxier")\n\t}\n\n\tif canUseIPVS {\n        // å¦ææ¯æçè¯ï¼åå»ºipvsæ§è¡å¨\n\t\tipvsInterface = utilipvs.New()\n\t}\n\n\t// åå»ºäºä»¶è®°å½å¨\n\teventBroadcaster := events.NewBroadcaster(&events.EventSinkImpl{Interface: client.EventsV1()})\n\trecorder := eventBroadcaster.NewRecorder(scheme.Scheme, "kube-proxy")\n\n\t// åå»ºå¥åº·æ£æ¥æå¡\n\tvar healthzServer healthcheck.ProxierHealthUpdater\n\tif len(config.HealthzBindAddress) > 0 {\n\t\thealthzServer = healthcheck.NewProxierHealthServer(config.HealthzBindAddress, 2*config.IPTables.SyncPeriod.Duration, recorder, nodeRef)\n\t}\n\n    // è·åå½åçä»£çæ¨¡å¼\n\tproxyMode := getProxyMode(string(config.Mode), canUseIPVS, iptables.LinuxKernelCompatTester{})\n\t\n    // è·åå½åçä¸»è¦çIPåè®®\n\tprimaryProtocol := utiliptables.ProtocolIPv4\n\tif netutils.IsIPv6(nodeIP) {\n\t\tprimaryProtocol = utiliptables.ProtocolIPv6\n\t}\n\n\t// åå»ºiptablesæ§è¡å¨\n\tiptInterface = utiliptables.New(execer, primaryProtocol)\n\n\t// å¯è½æ¯æipv4åipv6ä¸¤ç§æ§è¡å¨\n\tvar ipt [2]utiliptables.Interface\n\tdualStack := true // While we assume that node supports, we do further checks below\n\n\t// å¦ææ¯æçæ¯iptablesæ¨¡å¼\n\tif proxyMode == proxyModeIPTables {\n\n\t\t// åç«¯æ¨¡å¼ï¼æ¯æIP4åIPV6\n\t\tif dualStack {\n\t\t\tproxier, err = iptables.NewDualStackProxier(\n\t\t\t\tipt,\n\t\t\t\tutilsysctl.New(),\n\t\t\t\texecer,\n\t\t\t\tconfig.IPTables.SyncPeriod.Duration,\n\t\t\t\tconfig.IPTables.MinSyncPeriod.Duration,\n\t\t\t\tconfig.IPTables.MasqueradeAll,\n\t\t\t\tint(*config.IPTables.MasqueradeBit),\n\t\t\t\tlocalDetectors,\n\t\t\t\thostname,\n\t\t\t\tnodeIPTuple(config.BindAddress),\n\t\t\t\trecorder,\n\t\t\t\thealthzServer,\n\t\t\t\tconfig.NodePortAddresses,\n\t\t\t)\n\t\t} else {\n\t\t\tproxier, err = iptables.NewProxier(\n\t\t\t\tiptInterface,\n\t\t\t\tutilsysctl.New(),\n\t\t\t\texecer,\n\t\t\t\tconfig.IPTables.SyncPeriod.Duration,\n\t\t\t\tconfig.IPTables.MinSyncPeriod.Duration,\n\t\t\t\tconfig.IPTables.MasqueradeAll,\n\t\t\t\tint(*config.IPTables.MasqueradeBit),\n\t\t\t\tlocalDetector,\n\t\t\t\thostname,\n\t\t\t\tnodeIP,\n\t\t\t\trecorder,\n\t\t\t\thealthzServer,\n\t\t\t\tconfig.NodePortAddresses,\n\t\t\t)\n\t\t}\n\n\t\tif err != nil {\n\t\t\treturn nil, fmt.Errorf("unable to create proxier: %v", err)\n\t\t}\n\t\tproxymetrics.RegisterMetrics()\n\n\telse if proxyMode == proxyModeIPVS {\n\t\t...\n\t}\n\n\treturn &ProxyServer{\n\t\tClient:                 client,\n\t\tEventClient:            eventClient,\n\t\tIptInterface:           iptInterface,\n\t\tIpvsInterface:          ipvsInterface,\n\t\tIpsetInterface:         ipsetInterface,\n\t\texecer:                 execer,\n\t\tProxier:                proxier,\n\t\tBroadcaster:            eventBroadcaster,\n\t\tRecorder:               recorder,\n\t\tConntrackConfiguration: config.Conntrack,\n\t\tConntracker:            &realConntracker{},\n\t\tProxyMode:              proxyMode,\n\t\tNodeRef:                nodeRef,\n\t\tMetricsBindAddress:     config.MetricsBindAddress,\n\t\tBindAddressHardFail:    config.BindAddressHardFail,\n\t\tEnableProfiling:        config.EnableProfiling,\n\t\tOOMScoreAdj:            config.OOMScoreAdj,\n\t\tConfigSyncPeriod:       config.ConfigSyncPeriod.Duration,\n\t\tHealthzServer:          healthzServer,\n\t\tUseEndpointSlices:      useEndpointSlices,\n\t}, nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n76\n77\n78\n79\n80\n81\n82\n83\n84\n85\n86\n87\n88\n89\n90\n91\n92\n93\n94\n95\n96\n97\n98\n99\n100\n101\n102\n103\n104\n105\n106\n107\n108\n109\n110\n111\n112\n113\n114\n115\n116\n117\n118\n119\n120\n121\n122\n\n\nåæ¥çiptables.NewProxier() æ¹æ³\n\nfunc NewProxier(ipt utiliptables.Interface,\n\tsysctl utilsysctl.Interface,\n\texec utilexec.Interface,\n\tsyncPeriod time.Duration,\n\tminSyncPeriod time.Duration,\n\tmasqueradeAll bool,\n\tmasqueradeBit int,\n\tlocalDetector proxyutiliptables.LocalTrafficDetector,\n\thostname string,\n\tnodeIP net.IP,\n\trecorder events.EventRecorder,\n\thealthzServer healthcheck.ProxierHealthUpdater,\n\tnodePortAddresses []string,\n) (*Proxier, error) {\n\n\t// è¿ä¸ªå°±æ¯0x4000ï¼ä¹å°±æ¯ç»æ°æ®åæä¸æ è®°ï¼å¨åºä¸»æºçæ¶åä¼è¿è¡SNAT\n\tmasqueradeValue := 1 << uint(masqueradeBit)\n\tmasqueradeMark := fmt.Sprintf("%#08x", masqueradeValue)\n\n    // åå»ºå¥åº·æ£æ¥æå¡\n\tserviceHealthServer := healthcheck.NewServiceHealthServer(hostname, recorder, nodePortAddresses)\n\n\tproxier := &Proxier{\n\t\tserviceMap:               make(proxy.ServiceMap),\n\t\tserviceChanges:           proxy.NewServiceChangeTracker(newServiceInfo, ipFamily, recorder, nil),\n\t\tendpointsMap:             make(proxy.EndpointsMap),\n\t\tendpointsChanges:         proxy.NewEndpointChangeTracker(hostname, newEndpointInfo, ipFamily, recorder, nil),\n\t\tsyncPeriod:               syncPeriod,\n\t\tiptables:                 ipt,\n\t\tmasqueradeAll:            masqueradeAll,\n\t\tmasqueradeMark:           masqueradeMark,\n\t\texec:                     exec,\n\t\tlocalDetector:            localDetector,\n\t\thostname:                 hostname,\n\t\tnodeIP:                   nodeIP,\n\t\trecorder:                 recorder,\n\t\tserviceHealthServer:      serviceHealthServer,\n\t\thealthzServer:            healthzServer,\n\t\tprecomputedProbabilities: make([]string, 0, 1001),\n\t\tiptablesData:             bytes.NewBuffer(nil),\n\t\texistingFilterChainsData: bytes.NewBuffer(nil),\n\t\tfilterChains:             utilproxy.LineBuffer{},\n\t\tfilterRules:              utilproxy.LineBuffer{},\n\t\tnatChains:                utilproxy.LineBuffer{},\n\t\tnatRules:                 utilproxy.LineBuffer{},\n\t\tnodePortAddresses:        nodePortAddresses,\n\t\tnetworkInterfacer:        utilproxy.RealNetwork{},\n\t}\n\n\tburstSyncs := 2\n    // syncRunneræ¯ç¨æ¥æ§å¶å·æ°iptablesè§åé¢ççè¿è¡å¨ï¼proxier.syncProxyRulesæ¹æ³å°±æ¯çæ­£å·æ°iptablesè§åçæ¹æ³\n   \tproxier.syncRunner = async.NewBoundedFrequencyRunner("sync-runner", proxier.syncProxyRules, minSyncPeriod, time.Hour, burstSyncs)\n\n\t// è¿éå¯ç¨ä¸ä¸ªgoroutineãå¨ä¸ä¸ªè¡¨ä¸­é½åå»ºä¸ä¸ªKUBE-PROXY-CANARYå­é¾ï¼éè¿å­é¾æ¯å¦å­å¨æ¥å¤æ­iptablesæ¯å¦è¢«å·æã\n\t// å¦æè¯¥é¾ä¸å­å¨ï¼è¯´æiptablesè¢«å·æäºï¼åæ¬¡æ§è¡syncProxyRulesæ¹æ³å·åæ¥ã\n\tgo ipt.Monitor(kubeProxyCanaryChain, []utiliptables.Table{utiliptables.TableMangle, utiliptables.TableNAT, utiliptables.TableFilter},\n\t\tproxier.syncProxyRules, syncPeriod, wait.NeverStop)\n\treturn proxier, nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n\n\nä»¥ä¸ä¸»è¦çå¯¹è±¡å·²ç»åå§åå®æäºã\n\n\n# Run\n\nåå°o.Run() æ¹æ³ä¸­ï¼åæ¯åå»ºProxyServerå¯¹è±¡ï¼ç¶åå¨å¶ä¸­ååå»ºproxierå¯¹è±¡ï¼åäºä¸ç³»ååå§åå¨ä½ï¼æ¥ä¸æ¥å°±æ¯è¿è¡ä»£çæå¡äºï¼ç°å¨çårunLoop æ¹æ³\n\nfunc (o *Options) runLoop() error {\n\t// å¼å¯æä»¶çå¬\n\tif o.watcher != nil {\n\t\to.watcher.Run()\n\t}\n\n\t// run the proxy in goroutine\n\tgo func() {\n\t\terr := o.proxyServer.Run()\n\t\to.errCh <- err\n\t}()\n\n    // å¦ææ¥åå°errChååæ­¢æå¡\n\tfor {\n\t\terr := <-o.errCh\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nåçåo.proxyServer.Run() æ¹æ³ï¼è¿è¡ä»£çæå¡çä¸»æµç¨ã\n\nfunc (s *ProxyServer) Run() error {\n\t// è®¾ç½®å½åè¿ç¨çOOMåæ°ï¼èµæºç´§å¼ æ¶ï¼ä¸ä¼åkillækube-proxy\n\tvar oomAdjuster *oom.OOMAdjuster\n\tif s.OOMScoreAdj != nil {\n\t\toomAdjuster = oom.NewOOMAdjuster()\n\t\tif err := oomAdjuster.ApplyOOMScoreAdj(0, int(*s.OOMScoreAdj)); err != nil {\n\t\t\tklog.V(2).InfoS("Failed to apply OOMScore", "err", err)\n\t\t}\n\t}\n\n\t// å¼å¯å¥åº·æ£æ¥æå¡\n\tserveHealthz(s.HealthzServer, errCh)\n\n\t// å¼å¯ææ ä¸æ¥æå¡\n\tserveMetrics(s.MetricsBindAddress, s.ProxyMode, s.EnableProfiling, errCh)\n\n\t// åå»ºinformer\n\tinformerFactory := informers.NewSharedInformerFactoryWithOptions(s.Client, s.ConfigSyncPeriod,\n\t\tinformers.WithTweakListOptions(func(options *metav1.ListOptions) {\n\t\t\toptions.LabelSelector = labelSelector.String()\n\t\t}))\n\n\t// çå¬serviceåendpointå¹¶æ³¨åäºä»¶ï¼å½åçååæ¶ï¼åä¼è¿è¡å·æ°iptablesè§å\n\tserviceConfig := config.NewServiceConfig(informerFactory.Core().V1().Services(), s.ConfigSyncPeriod)\n\tserviceConfig.RegisterEventHandler(s.Proxier)\n\tgo serviceConfig.Run(wait.NeverStop)\n\n\tif endpointsHandler, ok := s.Proxier.(config.EndpointsHandler); ok && !s.UseEndpointSlices {\n\t\tendpointsConfig := config.NewEndpointsConfig(informerFactory.Core().V1().Endpoints(), s.ConfigSyncPeriod)\n\t\tendpointsConfig.RegisterEventHandler(endpointsHandler)\n\t\tgo endpointsConfig.Run(wait.NeverStop)\n\t} else {\n\t\tendpointSliceConfig := config.NewEndpointSliceConfig(informerFactory.Discovery().V1().EndpointSlices(), s.ConfigSyncPeriod)\n\t\tendpointSliceConfig.RegisterEventHandler(s.Proxier)\n\t\tgo endpointSliceConfig.Run(wait.NeverStop)\n\t}\n\n\tinformerFactory.Start(wait.NeverStop)\n\n\t// åéå¯å¨äºä»¶\n\ts.birthCry()\n\n\tgo s.Proxier.SyncLoop()\n\n\treturn <-errCh\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n\n\n\n# service å endpointslice åæ´äºä»¶\n\nç¨åºä¸­æ¯éè¿informeræ¥å®ç°å¯¹serviceåendpointåçååççå¬ï¼æç¥ååï¼å¹¶è§¦åäºä»¶å¹¶è¿è¡ç¸åºçå¤çã\n\nåçä¸ä¸NewServiceConfig() æ¹æ³ï¼å¶ä¸­æ³¨åäºå½serviceåçå¢ãå ãæ¹äºä»¶æ¶ï¼åå«æ§è¡result.handleAddService ãresult.handleUpdateService ãresult.handleDeleteService æ¹æ³ã\n\nfunc NewServiceConfig(serviceInformer coreinformers.ServiceInformer, resyncPeriod time.Duration) *ServiceConfig {\n\tresult := &ServiceConfig{\n\t\tlisterSynced: serviceInformer.Informer().HasSynced,\n\t}\n\n\t// æ³¨ååæ´äºä»¶\n\tserviceInformer.Informer().AddEventHandlerWithResyncPeriod(\n\t\tcache.ResourceEventHandlerFuncs{\n\t\t\tAddFunc:    result.handleAddService,\n\t\t\tUpdateFunc: result.handleUpdateService,\n\t\t\tDeleteFunc: result.handleDeleteService,\n\t\t},\n\t\tresyncPeriod,\n\t)\n\n\treturn result\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nåççå¶ä¸­çhandleAddService() æ¹æ³ï¼ä¼ å¥çåæ°objå°±æ¯æ°å¢çserviceå¯¹è±¡ï¼ç¶åä¼ å¥eventHandler.OnServiceAdd()æ¹æ³è¿è¡å¤çã\n\nfunc (c *ServiceConfig) handleAddService(obj interface{}) {\n\tservice, ok := obj.(*v1.Service)\n\tif !ok {\n\t\tutilruntime.HandleError(fmt.Errorf("unexpected object type: %v", obj))\n\t\treturn\n\t}\n\tfor i := range c.eventHandlers {\n\t\tklog.V(4).InfoS("Calling handler.OnServiceAdd")\n\t\tc.eventHandlers[i].OnServiceAdd(service)\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¿éc.eventHanlderså¶å®å°±æ¯proxierå¯¹è±¡ï¼å¨RegisterEventHandler()æ¹æ³ä¸­å°å¶æ·»å è¿å»çã\n\nserviceConfig.RegisterEventHandler(s.Proxier)\n\n\n1\n\n\nä¹å°±æ¯è¯´ï¼proxier.OnServiceAdd()ææ¯éè¦è§¦åçå¤çæ¹æ³\n\nfunc (proxier *Proxier) OnServiceAdd(service *v1.Service) {\n\tproxier.OnServiceUpdate(nil, service)\n}\n\n\n1\n2\n3\n\n\nç¬¬ä¸ä¸ªåæ°ä¸ºæ§çserviceï¼ç¬¬äºåæ°ä¸ºæ°çåæ°ãè¯¥æ¹æ³ç»å¯ä»¥OnServiceAdd å¤ç¨ï¼ä¼ å¥çç¬¬ä¸ä¸ªåæ°ä¸ºnilï¼ç¬¬äºä¸ªåæ°ä¸ä¸ºnilï¼å°±æ¯æ°å¢çæä½ã\n\nfunc (proxier *Proxier) OnServiceUpdate(oldService, service *v1.Service) {\n\tif proxier.serviceChanges.Update(oldService, service) && proxier.isInitialized() {\n\t\tproxier.Sync()\n\t}\n}\n\n\n1\n2\n3\n4\n5\n\n\nè¿å¯ä»¥çå°å é¤æä½ä¹è½å¤ç¨ï¼ææ§çserviceï¼èæ°serviceä¸ºnilä»£è¡¨å é¤ã\n\n// OnServiceDelete is called whenever deletion of an existing service\n// object is observed.\nfunc (proxier *Proxier) OnServiceDelete(service *v1.Service) {\n\tproxier.OnServiceUpdate(service, nil)\n}\n\n\n1\n2\n3\n4\n5\n\n\næ è®ºæ¯å¢ãå ãæ¹é½ä¼æ§è¡å°proxier.Sync()æ¹æ³\n\nfunc (proxier *Proxier) Sync() {\n\tif proxier.healthzServer != nil {\n\t\tproxier.healthzServer.QueuedUpdate()\n\t}\n\tmetrics.SyncProxyRulesLastQueuedTimestamp.SetToCurrentTime()\n\tproxier.syncRunner.Run()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næç»å°proxier.syncRunner.Run() æ¹æ³ï¼å¯ä»¥çåºå®ä¼åéä¸ä¸ªä¿¡å·å°bfr.runç®¡éä¸­ãè¯¥æ¹æ³é¤äºæ¯serviceåçäºä»¶æ§è¡æä½çç»ç¹å¤ï¼endpointåçäºä»¶åæç»ä¹ä¼æ§è¡å°è¿éã\n\nfunc (bfr *BoundedFrequencyRunner) Run() {\n\t// If it takes a lot of time to run the underlying function, noone is really\n\t// processing elements from <run> channel. So to avoid blocking here on the\n\t// putting element to it, we simply skip it if there is already an element\n\t// in it.\n\tselect {\n\tcase bfr.run <- struct{}{}:\n\tdefault:\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# BoundedFrequencyRunner\n\næä»¬ååå°ä»£çæå¡çProxyServe.Run æ¹æ³ï¼æåæ§è¡äºs.Proxier.SyncLoop()\n\nfunc (proxier *Proxier) SyncLoop() {\n\t// Update healthz timestamp at beginning in case Sync() never succeeds.\n\tif proxier.healthzServer != nil {\n\t\tproxier.healthzServer.Updated()\n\t}\n\n\t// synthesize "last change queued" time as the informers are syncing.\n\tmetrics.SyncProxyRulesLastQueuedTimestamp.SetToCurrentTime()\n\tproxier.syncRunner.Loop(wait.NeverStop)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nç¶ååæ§è¡proxier.syncRunner.Loop() æ¹æ³\n\nfunc (bfr *BoundedFrequencyRunner) Loop(stop <-chan struct{}) {\n\tklog.V(3).Infof("%s Loop running", bfr.name)\n\tbfr.timer.Reset(bfr.maxInterval)\n\tfor {\n\t\tselect {\n\t\tcase <-stop:\n\t\t\tbfr.stop()\n\t\t\tklog.V(3).Infof("%s Loop stopping", bfr.name)\n\t\t\treturn\n\t\tcase <-bfr.timer.C():\n\t\t\tbfr.tryRun()\n\t\tcase <-bfr.run:\n\t\t\tbfr.tryRun()\n\t\tcase <-bfr.retry:\n\t\t\tbfr.doRetry()\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå¯ä»¥çå°å¦æbfr.runç®¡éæ¥æ¶å°äºä¿¡å·ï¼ä¼æ§è¡brf.tryRun() æ¹æ³ï¼å¨è¿ä¸ªæ¹æ³ä¸­ä¼æ§è¡proxier.syncProxyRules() è¿è¡å·æ°iptablesè§åã\n\n// assumes the lock is not held\nfunc (bfr *BoundedFrequencyRunner) tryRun() {\n\tbfr.mu.Lock()\n\tdefer bfr.mu.Unlock()\n\n    // è¿éä¼éå¶è®¿é®éçï¼çæ¯å¦å¯ä»¥æ§è¡ã\n\tif bfr.limiter.TryAccept() {\n        // è¿éçfnå°±æ¯proxier.syncProxyRulesæ¹æ³\n\t\tbfr.fn()\n\t\tbfr.lastRun = bfr.timer.Now()\n\t\tbfr.timer.Stop()\n\t\tbfr.timer.Reset(bfr.maxInterval)\n\t\tklog.V(3).Infof("%s: ran, next possible in %v, periodic in %v", bfr.name, bfr.minInterval, bfr.maxInterval)\n\t\treturn\n\t}\n\n\t// It can\'t run right now, figure out when it can run next.\n\telapsed := bfr.timer.Since(bfr.lastRun)   // how long since last run\n\tnextPossible := bfr.minInterval - elapsed // time to next possible run\n\tnextScheduled := bfr.timer.Remaining()    // time to next scheduled run\n\tklog.V(4).Infof("%s: %v since last run, possible in %v, scheduled in %v", bfr.name, elapsed, nextPossible, nextScheduled)\n\n\t// It\'s hard to avoid race conditions in the unit tests unless we always reset\n\t// the timer here, even when it\'s unchanged\n\tif nextPossible < nextScheduled {\n\t\tnextScheduled = nextPossible\n\t}\n\tbfr.timer.Stop()\n\tbfr.timer.Reset(nextScheduled)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\n\n# syncProxyRules\n\nè¯¥æ¹æ³ä¸»è¦æ¯æ´æ°èç¹ä¸çiptablesè§åã\n\nfunc (proxier *Proxier) syncProxyRules() {\n\n\t// è·åserviceåendpointåçååçæ°æ®\n\tserviceUpdateResult := proxier.serviceMap.Update(proxier.serviceChanges)\n\tendpointUpdateResult := proxier.endpointsMap.Update(proxier.endpointsChanges)\n\n\n\t// åå»ºä¸äºå¿è¦çiptablesé¾\n\tfor _, jump := range iptablesJumpChains {\n\t\tif _, err := proxier.iptables.EnsureChain(jump.table, jump.dstChain); err != nil {\n\t\t\tklog.ErrorS(err, "Failed to ensure chain exists", "table", jump.table, "chain", jump.dstChain)\n\t\t\treturn\n\t\t}\n\t\targs := append(jump.extraArgs,\n\t\t\t"-m", "comment", "--comment", jump.comment,\n\t\t\t"-j", string(jump.dstChain),\n\t\t)\n\t\tif _, err := proxier.iptables.EnsureRule(utiliptables.Prepend, jump.table, jump.srcChain, args...); err != nil {\n\t\t\tklog.ErrorS(err, "Failed to ensure chain jumps", "table", jump.table, "srcChain", jump.srcChain, "dstChain", jump.dstChain)\n\t\t\treturn\n\t\t}\n\t}\n\n\tfor _, ch := range iptablesEnsureChains {\n\t\tif _, err := proxier.iptables.EnsureChain(ch.table, ch.chain); err != nil {\n\t\t\tklog.ErrorS(err, "Failed to ensure chain exists", "table", ch.table, "chain", ch.chain)\n\t\t\treturn\n\t\t}\n\t}\n\n\t// å°å½åfilterè¡¨ä¸­ææå­å¨çè§ååå¥existingFilterChainsDataä¸­\n\tproxier.existingFilterChainsData.Reset()\n\terr := proxier.iptables.SaveInto(utiliptables.TableFilter, proxier.existingFilterChainsData)\n\n\t// å°natè¡¨ä¸­ææå­å¨çè§ååå¥iptablesDataä¸­\n\tproxier.iptablesData.Reset()\n\terr = proxier.iptables.SaveInto(utiliptables.TableNAT, proxier.iptablesData)\n\n\t// å°filterånaté¾ä¸­å¿è¦æ·»å çå­é¾ï¼éè¿å­ç¬¦ä¸²æ¼æ¥çæ¹å¼åå¥åéfilterChainsånatChainsä¸­\n\tfor _, chainName := range []utiliptables.Chain{kubeServicesChain, kubeExternalServicesChain, kubeForwardChain, kubeNodePortsChain} {\n\t\tif chain, ok := existingFilterChains[chainName]; ok {\n\t\t\tproxier.filterChains.WriteBytes(chain)\n\t\t} else {\n\t\t\tproxier.filterChains.Write(utiliptables.MakeChainLine(chainName))\n\t\t}\n\t}\n\tfor _, chainName := range []utiliptables.Chain{kubeServicesChain, kubeNodePortsChain, kubePostroutingChain, KubeMarkMasqChain} {\n\t\tif chain, ok := existingNATChains[chainName]; ok {\n\t\t\tproxier.natChains.WriteBytes(chain)\n\t\t} else {\n\t\t\tproxier.natChains.Write(utiliptables.MakeChainLine(chainName))\n\t\t}\n\t}\n\n\t// åé¢å°±æ¯å°åç§çiptablesè§åéè¿å­ç¬¦ä¸²æ¼æ¥èµ·æ¥\n    ...\n\n\t// å°ææé¾åè§åçiptableså¨é¨éæå°ä¸èµ·iptablesDataï¼ç¶ååéè¿iptables-restoreå½ä»¤å·æ°å°èç¹ä¸­ã\n\tproxier.iptablesData.Reset()\n\tproxier.iptablesData.Write(proxier.filterChains.Bytes())\n\tproxier.iptablesData.Write(proxier.filterRules.Bytes())\n\tproxier.iptablesData.Write(proxier.natChains.Bytes())\n\tproxier.iptablesData.Write(proxier.natRules.Bytes())\n\terr = proxier.iptables.RestoreAll(proxier.iptablesData.Bytes(), utiliptables.NoFlushTables, utiliptables.RestoreCounters)\n\tif err != nil {\n\t\tklog.ErrorS(err, "Failed to execute iptables-restore")\n\t\tmetrics.IptablesRestoreFailuresTotal.Inc()\n\t\treturn\n\t}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n\n\næ»ç»\n\n 1. è·ååçåæ´ç service å endpoint ä¿¡æ¯\n 2. åå»ºä¸äºå¿è¦çé¾\n 3. ä½¿ç¨ iptables-save å½ä»¤ï¼å°å½åç¯å¢ä¸­ nat å filter è¡¨ä¸­ç iptables è§åå¨é¨å è½½å°ç¨åºä¸­ã\n 4. éè¿æ¼æ¥å­ç¬¦ä¸²ï¼æé åºéè¦åå»ºç iptables è§åå­ç¬¦ä¸²ã\n 5. éè¿ iptables-restore å½ä»¤ï¼å°æé ç iptables è§åå­ç¬¦ä¸²å¨é¨åå·æ°å°èç¹ä¸\n\næè\n\nå ä¸ºæ¯ä¸æ¬¡é½ä¼å°å½åææçiptablesè§åå¨é¨å·æ°å°èç¹ä¸ï¼å¦æè§åéè¿å¤§çè¯ï¼æ§è½ä¼åå°å½±åï¼æä»¥ææipvsæ¨¡å¼ã\n\n\n# æ»ç»\n\næ´ä½ä»£ç æµç¨å¦ä¸ï¼\n\n 1. é¦åæ¯åç§å¯¹è±¡å¥å¨å¼çåå§åï¼Options->ProxyServier->proxier->syncRunner\n 2. ç¶åæ¯åinformerä¸­æ³¨åserviceåendpointäºä»¶ï¼å½åçæ¹å¨æ¶ï¼ä¼ç»bfr.runåéä¿¡å·\n 3. syncRunneræ¶å°ä¿¡å·ä¼å»æ§è¡proxier.syncProxyRules()æ¹æ³ï¼å·æ°ä¸»æºçiptablesè§å\n\n\n\n\n# ç¸å³é¾æ¥\n\nkubernetes æºç -kube-proxy åçåæºç åæï¼ä¸ï¼\n\nkube-proxy æºç è§£æ\n\nkube-proxy ä¿å§çº§å«æºç éè¯»\n\nè¿æ¥è·è¸ª conntrack\n\nkubernetes ä¹ client-go ä¹ informer å·¥ä½åçæºç è§£æ\n\nKubernetes EndpointSlice å Endpoint å¯¹è±¡çåºå«\n\nâ',normalizedContent:'# kube-proxyæºç åæ\n\n\n# ç®ä»\n\næ¬æä¸»è¦æ¯å¯¹kube-proxyçæºç åæï¼äºè§£å¶ä»£ç ç»æåå®ç°åçãè¿éæ¯æ ¹æ®kubernetes1.23.9çæ¬æ¥è¿è¡åæçãå¨ä¸é¢è´´ä¸çä»£ç ä¼ä¸å®è£åªï¼ä¸»è¦ç¨äºçè§£ä¸»æµç¨ã\n\n\n# åå§å\n\nkube-proxyå¥å£æä»¶å¨cmd/kube-proxy/proxy.go\n\nfunc main() {\n\tcommand := app.newproxycommand()\n\tcode := cli.run(command)\n\tos.exit(code)\n}\n\n\n1\n2\n3\n4\n5\n\n\næ¥çapp.newproxycommand()æ¹æ³ï¼ä½¿ç¨çcobraå½ä»¤è¡è§£æåºæ¥ä½ä¸ºç¨åºå¥å£\n\nfunc newproxycommand() *cobra.command {\n\topts := newoptions()\n\n\tcmd := &cobra.command{\n\t\tuse: "kube-proxy",\n\t\tlong: `the kubernetes network proxy runs on each node. this\nreflects services as defined in the kubernetes api on each node and can do simple\ntcp, udp, and sctp stream forwarding or round robin tcp, udp, and sctp forwarding across a set of backends.\nservice cluster ips and ports are currently found through docker-links-compatible\nenvironment variables specifying ports opened by the service proxy. there is an optional\naddon that provides cluster dns for these cluster ips. the user must create a service\nwith the apiserver api to configure the proxy.`,\n\t\trune: func(cmd *cobra.command, args []string) error {\n\t\t\tverflag.printandexitifrequested()\n\t\t\tcliflag.printflags(cmd.flags())\n\n\t\t\tif err := initforos(opts.windowsservice); err != nil {\n\t\t\t\treturn fmt.errorf("failed os init: %w", err)\n\t\t\t}\n\n\t\t\t// 1. å è½½éç½®æä»¶kubeproxyconfig.kubeproxyconfiguration\n\t\t\t// 2. çæ§æä»¶åå\n\t\t\tif err := opts.complete(); err != nil {\n\t\t\t\treturn fmt.errorf("failed complete: %w", err)\n\t\t\t}\n\n\t\t\t// éç½®åæ°çæ ¡éª\n\t\t\tif err := opts.validate(); err != nil {\n\t\t\t\treturn fmt.errorf("failed validate: %w", err)\n\t\t\t}\n\n\t\t\t// è¿è¡æå¡\n\t\t\tif err := opts.run(); err != nil {\n\t\t\t\tklog.errors(err, "error running proxyserver")\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\treturn nil\n\t\t},\n\t\targs: func(cmd *cobra.command, args []string) error {\n\t\t\tfor _, arg := range args {\n\t\t\t\tif len(arg) > 0 {\n\t\t\t\t\treturn fmt.errorf("%q does not take any arguments, got %q", cmd.commandpath(), args)\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn nil\n\t\t},\n\t}\n\n\tvar err error\n    // å¡«åä¸äºé»è®¤éç½®\n\topts.config, err = opts.applydefaults(opts.config)\n\tif err != nil {\n\t\tklog.errors(err, "unable to create flag defaults")\n\t\t// action required: exit code changed from 255 to 1\n\t\tos.exit(1)\n\t}\n\n\tfs := cmd.flags()\n\topts.addflags(fs)\n\t// å°goçå½ä»¤è¡åæ°ä¹å å°å½ä»¤è¡åæ°ä¸­\n\tfs.addgoflagset(goflag.commandline) // for --boot-id-file and --machine-id-file\n\n\t_ = cmd.markflagfilename("config", "yaml", "yml", "json")\n\n\treturn cmd\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n\n 1. è¯»åéç½®æä»¶kubeproxyconfigurationï¼å¹¶çå¬ååæ¶å°å¯¹åºçäºä»¶\n 2. å¯¹éç½®kubeproxyconfigurationè¿è¡æ ¡éª\n 3. å¯å¨æå¡\n\nåæ¥çopts.run() æå¡å¯å¨çå®ç°\n\nfunc (o *options) run() error {\n\tdefer close(o.errch)\n\n    // å¦æéç½®äºè¯¥å­æ®µï¼å°éç½®æä»¶åå¥æå®ä½ç½®ï¼ç¶åéåº\n\tif len(o.writeconfigto) > 0 {\n\t\treturn o.writeconfigfile()\n\t}\n\n    // åå»ºä»£çæå¡\n\tproxyserver, err := newproxyserver(o)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// æ¸é¤ææçiptablesè§å\n\tif o.cleanupandexit {\n\t\treturn proxyserver.cleanupandexit()\n\t}\n\n\t// å¯å¨ä»£çæå¡\n\to.proxyserver = proxyserver\n\treturn o.runloop()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåçnewproxyserver() çå®ç°ï¼ä¸»è¦æ¯ç¨æ¥åå»ºproxyserverå¯¹è±¡ï¼å¹¶ä¸å¨å¶ä¸­æ ¹æ®å½åçç½ç»æ¨¡å¼ï¼éè¿iptables.newproxieræ¥åå»ºproxierå¯¹è±¡ã\n\nfunc newproxyserver(o *options) (*proxyserver, error) {\n\treturn newproxyserver(o.config, o.cleanupandexit, o.master)\n}\n\nfunc newproxyserver(\n\tconfig *proxyconfigapi.kubeproxyconfiguration,\n\tcleanupandexit bool,\n\tmaster string) (*proxyserver, error) {\n\n\t// æ§è¡æ¬å°å½ä»¤çæ§å¶å¨\n\texecer := exec.new()\n\n\tkernelhandler = ipvs.newlinuxkernelhandler() \n    // åå»ºipsetå½ä»¤çæ§è¡å¨\n\tipsetinterface = utilipset.new(execer)\n    // å¤æ­æ¯å¦æ¯æipvs\n\tcanuseipvs, err := ipvs.canuseipvsproxier(kernelhandler, ipsetinterface, config.ipvs.scheduler)\n\tif string(config.mode) == proxymodeipvs && err != nil {\n\t\tklog.errors(err, "can\'t use the ipvs proxier")\n\t}\n\n\tif canuseipvs {\n        // å¦ææ¯æçè¯ï¼åå»ºipvsæ§è¡å¨\n\t\tipvsinterface = utilipvs.new()\n\t}\n\n\t// åå»ºäºä»¶è®°å½å¨\n\teventbroadcaster := events.newbroadcaster(&events.eventsinkimpl{interface: client.eventsv1()})\n\trecorder := eventbroadcaster.newrecorder(scheme.scheme, "kube-proxy")\n\n\t// åå»ºå¥åº·æ£æ¥æå¡\n\tvar healthzserver healthcheck.proxierhealthupdater\n\tif len(config.healthzbindaddress) > 0 {\n\t\thealthzserver = healthcheck.newproxierhealthserver(config.healthzbindaddress, 2*config.iptables.syncperiod.duration, recorder, noderef)\n\t}\n\n    // è·åå½åçä»£çæ¨¡å¼\n\tproxymode := getproxymode(string(config.mode), canuseipvs, iptables.linuxkernelcompattester{})\n\t\n    // è·åå½åçä¸»è¦çipåè®®\n\tprimaryprotocol := utiliptables.protocolipv4\n\tif netutils.isipv6(nodeip) {\n\t\tprimaryprotocol = utiliptables.protocolipv6\n\t}\n\n\t// åå»ºiptablesæ§è¡å¨\n\tiptinterface = utiliptables.new(execer, primaryprotocol)\n\n\t// å¯è½æ¯æipv4åipv6ä¸¤ç§æ§è¡å¨\n\tvar ipt [2]utiliptables.interface\n\tdualstack := true // while we assume that node supports, we do further checks below\n\n\t// å¦ææ¯æçæ¯iptablesæ¨¡å¼\n\tif proxymode == proxymodeiptables {\n\n\t\t// åç«¯æ¨¡å¼ï¼æ¯æip4åipv6\n\t\tif dualstack {\n\t\t\tproxier, err = iptables.newdualstackproxier(\n\t\t\t\tipt,\n\t\t\t\tutilsysctl.new(),\n\t\t\t\texecer,\n\t\t\t\tconfig.iptables.syncperiod.duration,\n\t\t\t\tconfig.iptables.minsyncperiod.duration,\n\t\t\t\tconfig.iptables.masqueradeall,\n\t\t\t\tint(*config.iptables.masqueradebit),\n\t\t\t\tlocaldetectors,\n\t\t\t\thostname,\n\t\t\t\tnodeiptuple(config.bindaddress),\n\t\t\t\trecorder,\n\t\t\t\thealthzserver,\n\t\t\t\tconfig.nodeportaddresses,\n\t\t\t)\n\t\t} else {\n\t\t\tproxier, err = iptables.newproxier(\n\t\t\t\tiptinterface,\n\t\t\t\tutilsysctl.new(),\n\t\t\t\texecer,\n\t\t\t\tconfig.iptables.syncperiod.duration,\n\t\t\t\tconfig.iptables.minsyncperiod.duration,\n\t\t\t\tconfig.iptables.masqueradeall,\n\t\t\t\tint(*config.iptables.masqueradebit),\n\t\t\t\tlocaldetector,\n\t\t\t\thostname,\n\t\t\t\tnodeip,\n\t\t\t\trecorder,\n\t\t\t\thealthzserver,\n\t\t\t\tconfig.nodeportaddresses,\n\t\t\t)\n\t\t}\n\n\t\tif err != nil {\n\t\t\treturn nil, fmt.errorf("unable to create proxier: %v", err)\n\t\t}\n\t\tproxymetrics.registermetrics()\n\n\telse if proxymode == proxymodeipvs {\n\t\t...\n\t}\n\n\treturn &proxyserver{\n\t\tclient:                 client,\n\t\teventclient:            eventclient,\n\t\tiptinterface:           iptinterface,\n\t\tipvsinterface:          ipvsinterface,\n\t\tipsetinterface:         ipsetinterface,\n\t\texecer:                 execer,\n\t\tproxier:                proxier,\n\t\tbroadcaster:            eventbroadcaster,\n\t\trecorder:               recorder,\n\t\tconntrackconfiguration: config.conntrack,\n\t\tconntracker:            &realconntracker{},\n\t\tproxymode:              proxymode,\n\t\tnoderef:                noderef,\n\t\tmetricsbindaddress:     config.metricsbindaddress,\n\t\tbindaddresshardfail:    config.bindaddresshardfail,\n\t\tenableprofiling:        config.enableprofiling,\n\t\toomscoreadj:            config.oomscoreadj,\n\t\tconfigsyncperiod:       config.configsyncperiod.duration,\n\t\thealthzserver:          healthzserver,\n\t\tuseendpointslices:      useendpointslices,\n\t}, nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n76\n77\n78\n79\n80\n81\n82\n83\n84\n85\n86\n87\n88\n89\n90\n91\n92\n93\n94\n95\n96\n97\n98\n99\n100\n101\n102\n103\n104\n105\n106\n107\n108\n109\n110\n111\n112\n113\n114\n115\n116\n117\n118\n119\n120\n121\n122\n\n\nåæ¥çiptables.newproxier() æ¹æ³\n\nfunc newproxier(ipt utiliptables.interface,\n\tsysctl utilsysctl.interface,\n\texec utilexec.interface,\n\tsyncperiod time.duration,\n\tminsyncperiod time.duration,\n\tmasqueradeall bool,\n\tmasqueradebit int,\n\tlocaldetector proxyutiliptables.localtrafficdetector,\n\thostname string,\n\tnodeip net.ip,\n\trecorder events.eventrecorder,\n\thealthzserver healthcheck.proxierhealthupdater,\n\tnodeportaddresses []string,\n) (*proxier, error) {\n\n\t// è¿ä¸ªå°±æ¯0x4000ï¼ä¹å°±æ¯ç»æ°æ®åæä¸æ è®°ï¼å¨åºä¸»æºçæ¶åä¼è¿è¡snat\n\tmasqueradevalue := 1 << uint(masqueradebit)\n\tmasquerademark := fmt.sprintf("%#08x", masqueradevalue)\n\n    // åå»ºå¥åº·æ£æ¥æå¡\n\tservicehealthserver := healthcheck.newservicehealthserver(hostname, recorder, nodeportaddresses)\n\n\tproxier := &proxier{\n\t\tservicemap:               make(proxy.servicemap),\n\t\tservicechanges:           proxy.newservicechangetracker(newserviceinfo, ipfamily, recorder, nil),\n\t\tendpointsmap:             make(proxy.endpointsmap),\n\t\tendpointschanges:         proxy.newendpointchangetracker(hostname, newendpointinfo, ipfamily, recorder, nil),\n\t\tsyncperiod:               syncperiod,\n\t\tiptables:                 ipt,\n\t\tmasqueradeall:            masqueradeall,\n\t\tmasquerademark:           masquerademark,\n\t\texec:                     exec,\n\t\tlocaldetector:            localdetector,\n\t\thostname:                 hostname,\n\t\tnodeip:                   nodeip,\n\t\trecorder:                 recorder,\n\t\tservicehealthserver:      servicehealthserver,\n\t\thealthzserver:            healthzserver,\n\t\tprecomputedprobabilities: make([]string, 0, 1001),\n\t\tiptablesdata:             bytes.newbuffer(nil),\n\t\texistingfilterchainsdata: bytes.newbuffer(nil),\n\t\tfilterchains:             utilproxy.linebuffer{},\n\t\tfilterrules:              utilproxy.linebuffer{},\n\t\tnatchains:                utilproxy.linebuffer{},\n\t\tnatrules:                 utilproxy.linebuffer{},\n\t\tnodeportaddresses:        nodeportaddresses,\n\t\tnetworkinterfacer:        utilproxy.realnetwork{},\n\t}\n\n\tburstsyncs := 2\n    // syncrunneræ¯ç¨æ¥æ§å¶å·æ°iptablesè§åé¢ççè¿è¡å¨ï¼proxier.syncproxyrulesæ¹æ³å°±æ¯çæ­£å·æ°iptablesè§åçæ¹æ³\n   \tproxier.syncrunner = async.newboundedfrequencyrunner("sync-runner", proxier.syncproxyrules, minsyncperiod, time.hour, burstsyncs)\n\n\t// è¿éå¯ç¨ä¸ä¸ªgoroutineãå¨ä¸ä¸ªè¡¨ä¸­é½åå»ºä¸ä¸ªkube-proxy-canaryå­é¾ï¼éè¿å­é¾æ¯å¦å­å¨æ¥å¤æ­iptablesæ¯å¦è¢«å·æã\n\t// å¦æè¯¥é¾ä¸å­å¨ï¼è¯´æiptablesè¢«å·æäºï¼åæ¬¡æ§è¡syncproxyrulesæ¹æ³å·åæ¥ã\n\tgo ipt.monitor(kubeproxycanarychain, []utiliptables.table{utiliptables.tablemangle, utiliptables.tablenat, utiliptables.tablefilter},\n\t\tproxier.syncproxyrules, syncperiod, wait.neverstop)\n\treturn proxier, nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n\n\nä»¥ä¸ä¸»è¦çå¯¹è±¡å·²ç»åå§åå®æäºã\n\n\n# run\n\nåå°o.run() æ¹æ³ä¸­ï¼åæ¯åå»ºproxyserverå¯¹è±¡ï¼ç¶åå¨å¶ä¸­ååå»ºproxierå¯¹è±¡ï¼åäºä¸ç³»ååå§åå¨ä½ï¼æ¥ä¸æ¥å°±æ¯è¿è¡ä»£çæå¡äºï¼ç°å¨çårunloop æ¹æ³\n\nfunc (o *options) runloop() error {\n\t// å¼å¯æä»¶çå¬\n\tif o.watcher != nil {\n\t\to.watcher.run()\n\t}\n\n\t// run the proxy in goroutine\n\tgo func() {\n\t\terr := o.proxyserver.run()\n\t\to.errch <- err\n\t}()\n\n    // å¦ææ¥åå°errchååæ­¢æå¡\n\tfor {\n\t\terr := <-o.errch\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nåçåo.proxyserver.run() æ¹æ³ï¼è¿è¡ä»£çæå¡çä¸»æµç¨ã\n\nfunc (s *proxyserver) run() error {\n\t// è®¾ç½®å½åè¿ç¨çoomåæ°ï¼èµæºç´§å¼ æ¶ï¼ä¸ä¼åkillækube-proxy\n\tvar oomadjuster *oom.oomadjuster\n\tif s.oomscoreadj != nil {\n\t\toomadjuster = oom.newoomadjuster()\n\t\tif err := oomadjuster.applyoomscoreadj(0, int(*s.oomscoreadj)); err != nil {\n\t\t\tklog.v(2).infos("failed to apply oomscore", "err", err)\n\t\t}\n\t}\n\n\t// å¼å¯å¥åº·æ£æ¥æå¡\n\tservehealthz(s.healthzserver, errch)\n\n\t// å¼å¯ææ ä¸æ¥æå¡\n\tservemetrics(s.metricsbindaddress, s.proxymode, s.enableprofiling, errch)\n\n\t// åå»ºinformer\n\tinformerfactory := informers.newsharedinformerfactorywithoptions(s.client, s.configsyncperiod,\n\t\tinformers.withtweaklistoptions(func(options *metav1.listoptions) {\n\t\t\toptions.labelselector = labelselector.string()\n\t\t}))\n\n\t// çå¬serviceåendpointå¹¶æ³¨åäºä»¶ï¼å½åçååæ¶ï¼åä¼è¿è¡å·æ°iptablesè§å\n\tserviceconfig := config.newserviceconfig(informerfactory.core().v1().services(), s.configsyncperiod)\n\tserviceconfig.registereventhandler(s.proxier)\n\tgo serviceconfig.run(wait.neverstop)\n\n\tif endpointshandler, ok := s.proxier.(config.endpointshandler); ok && !s.useendpointslices {\n\t\tendpointsconfig := config.newendpointsconfig(informerfactory.core().v1().endpoints(), s.configsyncperiod)\n\t\tendpointsconfig.registereventhandler(endpointshandler)\n\t\tgo endpointsconfig.run(wait.neverstop)\n\t} else {\n\t\tendpointsliceconfig := config.newendpointsliceconfig(informerfactory.discovery().v1().endpointslices(), s.configsyncperiod)\n\t\tendpointsliceconfig.registereventhandler(s.proxier)\n\t\tgo endpointsliceconfig.run(wait.neverstop)\n\t}\n\n\tinformerfactory.start(wait.neverstop)\n\n\t// åéå¯å¨äºä»¶\n\ts.birthcry()\n\n\tgo s.proxier.syncloop()\n\n\treturn <-errch\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n\n\n\n# service å endpointslice åæ´äºä»¶\n\nç¨åºä¸­æ¯éè¿informeræ¥å®ç°å¯¹serviceåendpointåçååççå¬ï¼æç¥ååï¼å¹¶è§¦åäºä»¶å¹¶è¿è¡ç¸åºçå¤çã\n\nåçä¸ä¸newserviceconfig() æ¹æ³ï¼å¶ä¸­æ³¨åäºå½serviceåçå¢ãå ãæ¹äºä»¶æ¶ï¼åå«æ§è¡result.handleaddservice ãresult.handleupdateservice ãresult.handledeleteservice æ¹æ³ã\n\nfunc newserviceconfig(serviceinformer coreinformers.serviceinformer, resyncperiod time.duration) *serviceconfig {\n\tresult := &serviceconfig{\n\t\tlistersynced: serviceinformer.informer().hassynced,\n\t}\n\n\t// æ³¨ååæ´äºä»¶\n\tserviceinformer.informer().addeventhandlerwithresyncperiod(\n\t\tcache.resourceeventhandlerfuncs{\n\t\t\taddfunc:    result.handleaddservice,\n\t\t\tupdatefunc: result.handleupdateservice,\n\t\t\tdeletefunc: result.handledeleteservice,\n\t\t},\n\t\tresyncperiod,\n\t)\n\n\treturn result\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nåççå¶ä¸­çhandleaddservice() æ¹æ³ï¼ä¼ å¥çåæ°objå°±æ¯æ°å¢çserviceå¯¹è±¡ï¼ç¶åä¼ å¥eventhandler.onserviceadd()æ¹æ³è¿è¡å¤çã\n\nfunc (c *serviceconfig) handleaddservice(obj interface{}) {\n\tservice, ok := obj.(*v1.service)\n\tif !ok {\n\t\tutilruntime.handleerror(fmt.errorf("unexpected object type: %v", obj))\n\t\treturn\n\t}\n\tfor i := range c.eventhandlers {\n\t\tklog.v(4).infos("calling handler.onserviceadd")\n\t\tc.eventhandlers[i].onserviceadd(service)\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¿éc.eventhanlderså¶å®å°±æ¯proxierå¯¹è±¡ï¼å¨registereventhandler()æ¹æ³ä¸­å°å¶æ·»å è¿å»çã\n\nserviceconfig.registereventhandler(s.proxier)\n\n\n1\n\n\nä¹å°±æ¯è¯´ï¼proxier.onserviceadd()ææ¯éè¦è§¦åçå¤çæ¹æ³\n\nfunc (proxier *proxier) onserviceadd(service *v1.service) {\n\tproxier.onserviceupdate(nil, service)\n}\n\n\n1\n2\n3\n\n\nç¬¬ä¸ä¸ªåæ°ä¸ºæ§çserviceï¼ç¬¬äºåæ°ä¸ºæ°çåæ°ãè¯¥æ¹æ³ç»å¯ä»¥onserviceadd å¤ç¨ï¼ä¼ å¥çç¬¬ä¸ä¸ªåæ°ä¸ºnilï¼ç¬¬äºä¸ªåæ°ä¸ä¸ºnilï¼å°±æ¯æ°å¢çæä½ã\n\nfunc (proxier *proxier) onserviceupdate(oldservice, service *v1.service) {\n\tif proxier.servicechanges.update(oldservice, service) && proxier.isinitialized() {\n\t\tproxier.sync()\n\t}\n}\n\n\n1\n2\n3\n4\n5\n\n\nè¿å¯ä»¥çå°å é¤æä½ä¹è½å¤ç¨ï¼ææ§çserviceï¼èæ°serviceä¸ºnilä»£è¡¨å é¤ã\n\n// onservicedelete is called whenever deletion of an existing service\n// object is observed.\nfunc (proxier *proxier) onservicedelete(service *v1.service) {\n\tproxier.onserviceupdate(service, nil)\n}\n\n\n1\n2\n3\n4\n5\n\n\næ è®ºæ¯å¢ãå ãæ¹é½ä¼æ§è¡å°proxier.sync()æ¹æ³\n\nfunc (proxier *proxier) sync() {\n\tif proxier.healthzserver != nil {\n\t\tproxier.healthzserver.queuedupdate()\n\t}\n\tmetrics.syncproxyruleslastqueuedtimestamp.settocurrenttime()\n\tproxier.syncrunner.run()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næç»å°proxier.syncrunner.run() æ¹æ³ï¼å¯ä»¥çåºå®ä¼åéä¸ä¸ªä¿¡å·å°bfr.runç®¡éä¸­ãè¯¥æ¹æ³é¤äºæ¯serviceåçäºä»¶æ§è¡æä½çç»ç¹å¤ï¼endpointåçäºä»¶åæç»ä¹ä¼æ§è¡å°è¿éã\n\nfunc (bfr *boundedfrequencyrunner) run() {\n\t// if it takes a lot of time to run the underlying function, noone is really\n\t// processing elements from <run> channel. so to avoid blocking here on the\n\t// putting element to it, we simply skip it if there is already an element\n\t// in it.\n\tselect {\n\tcase bfr.run <- struct{}{}:\n\tdefault:\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# boundedfrequencyrunner\n\næä»¬ååå°ä»£çæå¡çproxyserve.run æ¹æ³ï¼æåæ§è¡äºs.proxier.syncloop()\n\nfunc (proxier *proxier) syncloop() {\n\t// update healthz timestamp at beginning in case sync() never succeeds.\n\tif proxier.healthzserver != nil {\n\t\tproxier.healthzserver.updated()\n\t}\n\n\t// synthesize "last change queued" time as the informers are syncing.\n\tmetrics.syncproxyruleslastqueuedtimestamp.settocurrenttime()\n\tproxier.syncrunner.loop(wait.neverstop)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nç¶ååæ§è¡proxier.syncrunner.loop() æ¹æ³\n\nfunc (bfr *boundedfrequencyrunner) loop(stop <-chan struct{}) {\n\tklog.v(3).infof("%s loop running", bfr.name)\n\tbfr.timer.reset(bfr.maxinterval)\n\tfor {\n\t\tselect {\n\t\tcase <-stop:\n\t\t\tbfr.stop()\n\t\t\tklog.v(3).infof("%s loop stopping", bfr.name)\n\t\t\treturn\n\t\tcase <-bfr.timer.c():\n\t\t\tbfr.tryrun()\n\t\tcase <-bfr.run:\n\t\t\tbfr.tryrun()\n\t\tcase <-bfr.retry:\n\t\t\tbfr.doretry()\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå¯ä»¥çå°å¦æbfr.runç®¡éæ¥æ¶å°äºä¿¡å·ï¼ä¼æ§è¡brf.tryrun() æ¹æ³ï¼å¨è¿ä¸ªæ¹æ³ä¸­ä¼æ§è¡proxier.syncproxyrules() è¿è¡å·æ°iptablesè§åã\n\n// assumes the lock is not held\nfunc (bfr *boundedfrequencyrunner) tryrun() {\n\tbfr.mu.lock()\n\tdefer bfr.mu.unlock()\n\n    // è¿éä¼éå¶è®¿é®éçï¼çæ¯å¦å¯ä»¥æ§è¡ã\n\tif bfr.limiter.tryaccept() {\n        // è¿éçfnå°±æ¯proxier.syncproxyrulesæ¹æ³\n\t\tbfr.fn()\n\t\tbfr.lastrun = bfr.timer.now()\n\t\tbfr.timer.stop()\n\t\tbfr.timer.reset(bfr.maxinterval)\n\t\tklog.v(3).infof("%s: ran, next possible in %v, periodic in %v", bfr.name, bfr.mininterval, bfr.maxinterval)\n\t\treturn\n\t}\n\n\t// it can\'t run right now, figure out when it can run next.\n\telapsed := bfr.timer.since(bfr.lastrun)   // how long since last run\n\tnextpossible := bfr.mininterval - elapsed // time to next possible run\n\tnextscheduled := bfr.timer.remaining()    // time to next scheduled run\n\tklog.v(4).infof("%s: %v since last run, possible in %v, scheduled in %v", bfr.name, elapsed, nextpossible, nextscheduled)\n\n\t// it\'s hard to avoid race conditions in the unit tests unless we always reset\n\t// the timer here, even when it\'s unchanged\n\tif nextpossible < nextscheduled {\n\t\tnextscheduled = nextpossible\n\t}\n\tbfr.timer.stop()\n\tbfr.timer.reset(nextscheduled)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\n\n# syncproxyrules\n\nè¯¥æ¹æ³ä¸»è¦æ¯æ´æ°èç¹ä¸çiptablesè§åã\n\nfunc (proxier *proxier) syncproxyrules() {\n\n\t// è·åserviceåendpointåçååçæ°æ®\n\tserviceupdateresult := proxier.servicemap.update(proxier.servicechanges)\n\tendpointupdateresult := proxier.endpointsmap.update(proxier.endpointschanges)\n\n\n\t// åå»ºä¸äºå¿è¦çiptablesé¾\n\tfor _, jump := range iptablesjumpchains {\n\t\tif _, err := proxier.iptables.ensurechain(jump.table, jump.dstchain); err != nil {\n\t\t\tklog.errors(err, "failed to ensure chain exists", "table", jump.table, "chain", jump.dstchain)\n\t\t\treturn\n\t\t}\n\t\targs := append(jump.extraargs,\n\t\t\t"-m", "comment", "--comment", jump.comment,\n\t\t\t"-j", string(jump.dstchain),\n\t\t)\n\t\tif _, err := proxier.iptables.ensurerule(utiliptables.prepend, jump.table, jump.srcchain, args...); err != nil {\n\t\t\tklog.errors(err, "failed to ensure chain jumps", "table", jump.table, "srcchain", jump.srcchain, "dstchain", jump.dstchain)\n\t\t\treturn\n\t\t}\n\t}\n\n\tfor _, ch := range iptablesensurechains {\n\t\tif _, err := proxier.iptables.ensurechain(ch.table, ch.chain); err != nil {\n\t\t\tklog.errors(err, "failed to ensure chain exists", "table", ch.table, "chain", ch.chain)\n\t\t\treturn\n\t\t}\n\t}\n\n\t// å°å½åfilterè¡¨ä¸­ææå­å¨çè§ååå¥existingfilterchainsdataä¸­\n\tproxier.existingfilterchainsdata.reset()\n\terr := proxier.iptables.saveinto(utiliptables.tablefilter, proxier.existingfilterchainsdata)\n\n\t// å°natè¡¨ä¸­ææå­å¨çè§ååå¥iptablesdataä¸­\n\tproxier.iptablesdata.reset()\n\terr = proxier.iptables.saveinto(utiliptables.tablenat, proxier.iptablesdata)\n\n\t// å°filterånaté¾ä¸­å¿è¦æ·»å çå­é¾ï¼éè¿å­ç¬¦ä¸²æ¼æ¥çæ¹å¼åå¥åéfilterchainsånatchainsä¸­\n\tfor _, chainname := range []utiliptables.chain{kubeserviceschain, kubeexternalserviceschain, kubeforwardchain, kubenodeportschain} {\n\t\tif chain, ok := existingfilterchains[chainname]; ok {\n\t\t\tproxier.filterchains.writebytes(chain)\n\t\t} else {\n\t\t\tproxier.filterchains.write(utiliptables.makechainline(chainname))\n\t\t}\n\t}\n\tfor _, chainname := range []utiliptables.chain{kubeserviceschain, kubenodeportschain, kubepostroutingchain, kubemarkmasqchain} {\n\t\tif chain, ok := existingnatchains[chainname]; ok {\n\t\t\tproxier.natchains.writebytes(chain)\n\t\t} else {\n\t\t\tproxier.natchains.write(utiliptables.makechainline(chainname))\n\t\t}\n\t}\n\n\t// åé¢å°±æ¯å°åç§çiptablesè§åéè¿å­ç¬¦ä¸²æ¼æ¥èµ·æ¥\n    ...\n\n\t// å°ææé¾åè§åçiptableså¨é¨éæå°ä¸èµ·iptablesdataï¼ç¶ååéè¿iptables-restoreå½ä»¤å·æ°å°èç¹ä¸­ã\n\tproxier.iptablesdata.reset()\n\tproxier.iptablesdata.write(proxier.filterchains.bytes())\n\tproxier.iptablesdata.write(proxier.filterrules.bytes())\n\tproxier.iptablesdata.write(proxier.natchains.bytes())\n\tproxier.iptablesdata.write(proxier.natrules.bytes())\n\terr = proxier.iptables.restoreall(proxier.iptablesdata.bytes(), utiliptables.noflushtables, utiliptables.restorecounters)\n\tif err != nil {\n\t\tklog.errors(err, "failed to execute iptables-restore")\n\t\tmetrics.iptablesrestorefailurestotal.inc()\n\t\treturn\n\t}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n\n\næ»ç»\n\n 1. è·ååçåæ´ç service å endpoint ä¿¡æ¯\n 2. åå»ºä¸äºå¿è¦çé¾\n 3. ä½¿ç¨ iptables-save å½ä»¤ï¼å°å½åç¯å¢ä¸­ nat å filter è¡¨ä¸­ç iptables è§åå¨é¨å è½½å°ç¨åºä¸­ã\n 4. éè¿æ¼æ¥å­ç¬¦ä¸²ï¼æé åºéè¦åå»ºç iptables è§åå­ç¬¦ä¸²ã\n 5. éè¿ iptables-restore å½ä»¤ï¼å°æé ç iptables è§åå­ç¬¦ä¸²å¨é¨åå·æ°å°èç¹ä¸\n\næè\n\nå ä¸ºæ¯ä¸æ¬¡é½ä¼å°å½åææçiptablesè§åå¨é¨å·æ°å°èç¹ä¸ï¼å¦æè§åéè¿å¤§çè¯ï¼æ§è½ä¼åå°å½±åï¼æä»¥ææipvsæ¨¡å¼ã\n\n\n# æ»ç»\n\næ´ä½ä»£ç æµç¨å¦ä¸ï¼\n\n 1. é¦åæ¯åç§å¯¹è±¡å¥å¨å¼çåå§åï¼options->proxyservier->proxier->syncrunner\n 2. ç¶åæ¯åinformerä¸­æ³¨åserviceåendpointäºä»¶ï¼å½åçæ¹å¨æ¶ï¼ä¼ç»bfr.runåéä¿¡å·\n 3. syncrunneræ¶å°ä¿¡å·ä¼å»æ§è¡proxier.syncproxyrules()æ¹æ³ï¼å·æ°ä¸»æºçiptablesè§å\n\n\n\n\n# ç¸å³é¾æ¥\n\nkubernetes æºç -kube-proxy åçåæºç åæï¼ä¸ï¼\n\nkube-proxy æºç è§£æ\n\nkube-proxy ä¿å§çº§å«æºç éè¯»\n\nè¿æ¥è·è¸ª conntrack\n\nkubernetes ä¹ client-go ä¹ informer å·¥ä½åçæºç è§£æ\n\nkubernetes endpointslice å endpoint å¯¹è±¡çåºå«\n\nâ',charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"æå¡å¯å¨æ¶åºç° OOM",frontmatter:{title:"æå¡å¯å¨æ¶åºç° OOM",date:"2025-09-22T15:39:13.000Z",permalink:"/pages/de98b1/",categories:["Bug éç¼ä»¤"],tags:["goè¯­è¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æè¯¦ç»è®°å½äºä¸æ¬¡å¨Kubernetesç¯å¢ä¸­Golangæå¡å¯å¨æ¶åºç°OOMï¼Out of Memoryï¼é®é¢çææ¥åè§£å³è¿ç¨ãæå¡å¨å¯å¨çº¦2åéååºç°åå­æº¢åºï¼éè¿pprofå·¥å·åæåç°ä¸»è¦é®é¢æºäºbytes.Bufferå¯¹è±¡çé¢ç¹æ©å®¹ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17585287225681758528722158.png"},{name:"twitter:title",content:"æå¡å¯å¨æ¶åºç° OOM"},{name:"twitter:description",content:"æ¬æè¯¦ç»è®°å½äºä¸æ¬¡å¨Kubernetesç¯å¢ä¸­Golangæå¡å¯å¨æ¶åºç°OOMï¼Out of Memoryï¼é®é¢çææ¥åè§£å³è¿ç¨ãæå¡å¨å¯å¨çº¦2åéååºç°åå­æº¢åºï¼éè¿pprofå·¥å·åæåç°ä¸»è¦é®é¢æºäºbytes.Bufferå¯¹è±¡çé¢ç¹æ©å®¹ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17585287225681758528722158.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4/02.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%97%B6%E5%87%BA%E7%8E%B0%20OOM.html"},{property:"og:type",content:"article"},{property:"og:title",content:"æå¡å¯å¨æ¶åºç° OOM"},{property:"og:description",content:"æ¬æè¯¦ç»è®°å½äºä¸æ¬¡å¨Kubernetesç¯å¢ä¸­Golangæå¡å¯å¨æ¶åºç°OOMï¼Out of Memoryï¼é®é¢çææ¥åè§£å³è¿ç¨ãæå¡å¨å¯å¨çº¦2åéååºç°åå­æº¢åºï¼éè¿pprofå·¥å·åæåç°ä¸»è¦é®é¢æºäºbytes.Bufferå¯¹è±¡çé¢ç¹æ©å®¹ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17585287225681758528722158.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4/02.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%97%B6%E5%87%BA%E7%8E%B0%20OOM.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-09-22T15:39:13.000Z"},{property:"article:tag",content:"goè¯­è¨"},{itemprop:"name",content:"æå¡å¯å¨æ¶åºç° OOM"},{itemprop:"description",content:"æ¬æè¯¦ç»è®°å½äºä¸æ¬¡å¨Kubernetesç¯å¢ä¸­Golangæå¡å¯å¨æ¶åºç°OOMï¼Out of Memoryï¼é®é¢çææ¥åè§£å³è¿ç¨ãæå¡å¨å¯å¨çº¦2åéååºç°åå­æº¢åºï¼éè¿pprofå·¥å·åæåç°ä¸»è¦é®é¢æºäºbytes.Bufferå¯¹è±¡çé¢ç¹æ©å®¹ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17585287225681758528722158.png"}],readingShow:"top"},regularPath:"/02.Bug%20%E9%80%9A%E7%BC%89%E4%BB%A4/02.%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%97%B6%E5%87%BA%E7%8E%B0%20OOM.html",relativePath:"02.Bug éç¼ä»¤/02.æå¡å¯å¨æ¶åºç° OOM.md",key:"v-7c3ad306",path:"/pages/de98b1/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"ç°è±¡",slug:"ç°è±¡",normalizedTitle:"ç°è±¡",charIndex:132},{level:2,title:"åæ",slug:"åæ",normalizedTitle:"åæ",charIndex:97},{level:2,title:"è§£å³åæ³",slug:"è§£å³åæ³",normalizedTitle:"è§£å³åæ³",charIndex:1683},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:2414}],headersStr:"åè¨ ç°è±¡ åæ è§£å³åæ³ æ»ç»",content:'# åè¨\n\næ¬æè¯¦ç»è®°å½äºä¸æ¬¡å¨Kubernetesç¯å¢ä¸­Golangæå¡å¯å¨æ¶åºç°OOMï¼Out of Memoryï¼é®é¢çææ¥åè§£å³è¿ç¨ãæå¡å¨å¯å¨çº¦2åéååºç°åå­æº¢åºï¼éè¿pprofå·¥å·åæåç°ä¸»è¦é®é¢æºäºbytes.Bufferå¯¹è±¡çé¢ç¹æ©å®¹ã\n\n\n# ç°è±¡\n\næä¸ä¸ªgolangåå°æå¡è·å¨äºk8séç¾¤ä¸ï¼å¨å¯å¨è¿ç¨ä¸­ï¼å¤§çº¦ 2 åéåï¼è¯¥æå¡æå¨çpodåºç°äº OOMï¼ä¹å°±æ¯è¶è¿äºé¨ç½²è¯¥ POD ç limit åå­å¤§å°ã\n\n\n# åæ\n\nè¯¥ç°è±¡æ¯å¯å¤ç°çï¼æä»¥æéè¿éå¯è¯¥podï¼å¨å¶è¿æ²¡åºç° OOM æ¶ä½¿ç¨ pprof å°æå¡ç profile æä»¶ç»è·åå°ã\n\ncurl http://localhost:8080/debug/pprof/heap -o profile\n\n\n1\n\n\nç¶åä½¿ç¨ä¸é¢çå½ä»¤å¨ç½é¡µä¸æ¥çæå¡çåå­ä½¿ç¨æåµã\n\ngo tool pprof -http=:8081 profile\n\n\n1\n\n\nå¨ç½é¡µä¸ï¼å¨é¡¶é¨çå¯¼èªæ ä¸­ï¼éæ© View -> Topï¼SAMPLES -> alloc_spaceï¼æ¥æ¥çä»æå¡å¯å¨æ¶ï¼ç³è¯·åå­Topã\n\n\n\né¦åå¯ä»¥çå°ç¬¬ä¸åç³è¯·çåå­æ¯ bytes.makeSliceï¼çåå­å¤§èççæµï¼æ¯å ä¸ºåçåå­ç³è¯·è¿å¤å¯¼è´çï¼æ¥ä¸æ¥éè¦éªè¯ã\n\néä¸­è¯¥è¡ï¼ç¶åéæ© View -> Graphï¼å°±ä¼è¿å¥è¿å¥å°ä¸ä¸ªå½æ°è°ç¨é¾ã\n\n\n\næä»¬åæ¾å°è°ç¨é¾çåºç«¯ï¼å¯ä»¥çå° bytes.makeSlice å ç¨äº1.12G åå­ï¼è°ç¨èæ¯ bytes(*Buffer).growï¼éè¿æºç åææ¯ Buffer å¯¹è±¡æ©å®¹å¯¼è´çã\n\n\n\néè¿è°ç¨é¾å¾ä¸æ¾å°å¨ä¸å¡ä»£ç ä¸åå»ºå¹¶ä½¿ç¨ Buffer å¯¹è±¡çå°æ¹ï¼æç»æ¾å°äº Serialize å½æ°ã\n\n\n\næä»¬çæ³è¯¥å½æ°ï¼è¯¥å½æ°çä½ç¨æ¯ï¼å°valueå¯¹è±¡åºååæbyteæ°ç»ãç¶åçå°å¶åå»ºäº Buffer å¯¹è±¡ï¼å¹¶å° value å¯¹è±¡åºååå­å¨å°å¶ä¸­ã\n\nfunc Serialize(value interface{}) ([]byte, error) {\n\t// gob.Register(value)\n\tbuf := bytes.Buffer{}\n\tif err := gob.NewEncoder(&buf).Encode(&value); err != nil {\n\t\treturn nil, err\n\t}\n\treturn buf.Bytes(), nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nä½æä»¬ç«é©¬åç°äºé®é¢ï¼æä»¬åå»º Buffer{} å¹¶æ²¡ææå®å¶å¤§å°ï¼å¯ä»¥çå°å¶ç»æä½ä¹æ²¡æé»è®¤å¤§å°ï¼å½åå¥æ°æ®æ¶ï¼åä¼è¿è¡è°ç¨ grow è¿è¡æ©å®¹ã\n\ntype Buffer struct {\n\tbuf      []byte // contents are the bytes buf[off : len(buf)]\n\toff      int    // read at &buf[off], write at &buf[len(buf)]\n\tlastRead readOp // last read operation, so that Unread* can work correctly.\n}\n\nfunc (b *Buffer) Write(p []byte) (n int, err error) {\n\tb.lastRead = opInvalid\n\tm, ok := b.tryGrowByReslice(len(p))\n\tif !ok {\n\t\tm = b.grow(len(p))\n\t}\n\treturn copy(b.buf[m:], p), nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåç»åä¸å¡è¿è¡åæï¼æå¡å¯å¨æ¶ä¼æå¤§éçæ°æ®éè¦è¿è¡åºååï¼æ¯æ¬¡è°ç¨è¯¥å½æ°é½æ¯åå»ºä¸ä¸ªæªæå®å¤§å°ç Buffer å¯¹è±¡ï¼ç¶ååºååæ¶è¿è¡ä¸æ­å°æ©å®¹ï¼ä»èå¯¼è´åå­è¿éå¢å ï¼ä»èå¯¼è´ OOMã\n\n\n# è§£å³åæ³\n\nä½¿ç¨ sync.Pool æ¥å¤ç¨ Buffer å¯¹è±¡ï¼å¹¶ä¸å¨åå»º Buffer å¯¹è±¡æ¶æå®ä¸ä¸ªåéçå¤§å°ï¼è¿æ ·å°±å¯ä»¥åå°åå­çç³è¯·ä»èé¿åäº OOMã\n\n// ç¼å²åºæ± ï¼å¤ç¨ bytes.Buffer å¯¹è±¡\nvar bufferPool = sync.Pool{\n\tNew: func() interface{} {\n\t\t// é¢åé 1KB å®¹éï¼åå°æ©å®¹æ¬¡æ°\n\t\tbuf := make([]byte, 0, 1024)\n\t\treturn bytes.NewBuffer(buf)\n\t},\n}\n\nfunc Serialize(value interface{}) ([]byte, error) {\n\tif value == nil {\n\t\treturn nil, fmt.Errorf("input nil value")\n\t}\n\n\t// ä»æ± ä¸­è·åç¼å²åº\n\tbuf := bufferPool.Get().(*bytes.Buffer)\n\tdefer func() {\n\t\tbuf.Reset()\n\t\tbufferPool.Put(buf)\n\t}()\n\n\tencoder := gob.NewEncoder(buf)\n\tif err := encoder.Encode(&value); err != nil {\n\t\treturn nil, err\n\t}\n\n\t// é«æçå­èåçåéè¿åæ°æ®\n\treturn bytesClone(buf.Bytes()), nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\n\n# æ»ç»\n\n 1. å¨ç¼ç æ¹é¢éè¦æ³¨æåå­ç®¡çåå¯¹è±¡å¤ç¨å¯¹ç³»ç»ç¨³å®æ§çéè¦æ§ã\n 2. åäºå©ç¨å·¥å·æ¥è¾å©ææ¥é®é¢ã',normalizedContent:'# åè¨\n\næ¬æè¯¦ç»è®°å½äºä¸æ¬¡å¨kubernetesç¯å¢ä¸­golangæå¡å¯å¨æ¶åºç°oomï¼out of memoryï¼é®é¢çææ¥åè§£å³è¿ç¨ãæå¡å¨å¯å¨çº¦2åéååºç°åå­æº¢åºï¼éè¿pprofå·¥å·åæåç°ä¸»è¦é®é¢æºäºbytes.bufferå¯¹è±¡çé¢ç¹æ©å®¹ã\n\n\n# ç°è±¡\n\næä¸ä¸ªgolangåå°æå¡è·å¨äºk8séç¾¤ä¸ï¼å¨å¯å¨è¿ç¨ä¸­ï¼å¤§çº¦ 2 åéåï¼è¯¥æå¡æå¨çpodåºç°äº oomï¼ä¹å°±æ¯è¶è¿äºé¨ç½²è¯¥ pod ç limit åå­å¤§å°ã\n\n\n# åæ\n\nè¯¥ç°è±¡æ¯å¯å¤ç°çï¼æä»¥æéè¿éå¯è¯¥podï¼å¨å¶è¿æ²¡åºç° oom æ¶ä½¿ç¨ pprof å°æå¡ç profile æä»¶ç»è·åå°ã\n\ncurl http://localhost:8080/debug/pprof/heap -o profile\n\n\n1\n\n\nç¶åä½¿ç¨ä¸é¢çå½ä»¤å¨ç½é¡µä¸æ¥çæå¡çåå­ä½¿ç¨æåµã\n\ngo tool pprof -http=:8081 profile\n\n\n1\n\n\nå¨ç½é¡µä¸ï¼å¨é¡¶é¨çå¯¼èªæ ä¸­ï¼éæ© view -> topï¼samples -> alloc_spaceï¼æ¥æ¥çä»æå¡å¯å¨æ¶ï¼ç³è¯·åå­topã\n\n\n\né¦åå¯ä»¥çå°ç¬¬ä¸åç³è¯·çåå­æ¯ bytes.makesliceï¼çåå­å¤§èççæµï¼æ¯å ä¸ºåçåå­ç³è¯·è¿å¤å¯¼è´çï¼æ¥ä¸æ¥éè¦éªè¯ã\n\néä¸­è¯¥è¡ï¼ç¶åéæ© view -> graphï¼å°±ä¼è¿å¥è¿å¥å°ä¸ä¸ªå½æ°è°ç¨é¾ã\n\n\n\næä»¬åæ¾å°è°ç¨é¾çåºç«¯ï¼å¯ä»¥çå° bytes.makeslice å ç¨äº1.12g åå­ï¼è°ç¨èæ¯ bytes(*buffer).growï¼éè¿æºç åææ¯ buffer å¯¹è±¡æ©å®¹å¯¼è´çã\n\n\n\néè¿è°ç¨é¾å¾ä¸æ¾å°å¨ä¸å¡ä»£ç ä¸åå»ºå¹¶ä½¿ç¨ buffer å¯¹è±¡çå°æ¹ï¼æç»æ¾å°äº serialize å½æ°ã\n\n\n\næä»¬çæ³è¯¥å½æ°ï¼è¯¥å½æ°çä½ç¨æ¯ï¼å°valueå¯¹è±¡åºååæbyteæ°ç»ãç¶åçå°å¶åå»ºäº buffer å¯¹è±¡ï¼å¹¶å° value å¯¹è±¡åºååå­å¨å°å¶ä¸­ã\n\nfunc serialize(value interface{}) ([]byte, error) {\n\t// gob.register(value)\n\tbuf := bytes.buffer{}\n\tif err := gob.newencoder(&buf).encode(&value); err != nil {\n\t\treturn nil, err\n\t}\n\treturn buf.bytes(), nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nä½æä»¬ç«é©¬åç°äºé®é¢ï¼æä»¬åå»º buffer{} å¹¶æ²¡ææå®å¶å¤§å°ï¼å¯ä»¥çå°å¶ç»æä½ä¹æ²¡æé»è®¤å¤§å°ï¼å½åå¥æ°æ®æ¶ï¼åä¼è¿è¡è°ç¨ grow è¿è¡æ©å®¹ã\n\ntype buffer struct {\n\tbuf      []byte // contents are the bytes buf[off : len(buf)]\n\toff      int    // read at &buf[off], write at &buf[len(buf)]\n\tlastread readop // last read operation, so that unread* can work correctly.\n}\n\nfunc (b *buffer) write(p []byte) (n int, err error) {\n\tb.lastread = opinvalid\n\tm, ok := b.trygrowbyreslice(len(p))\n\tif !ok {\n\t\tm = b.grow(len(p))\n\t}\n\treturn copy(b.buf[m:], p), nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nåç»åä¸å¡è¿è¡åæï¼æå¡å¯å¨æ¶ä¼æå¤§éçæ°æ®éè¦è¿è¡åºååï¼æ¯æ¬¡è°ç¨è¯¥å½æ°é½æ¯åå»ºä¸ä¸ªæªæå®å¤§å°ç buffer å¯¹è±¡ï¼ç¶ååºååæ¶è¿è¡ä¸æ­å°æ©å®¹ï¼ä»èå¯¼è´åå­è¿éå¢å ï¼ä»èå¯¼è´ oomã\n\n\n# è§£å³åæ³\n\nä½¿ç¨ sync.pool æ¥å¤ç¨ buffer å¯¹è±¡ï¼å¹¶ä¸å¨åå»º buffer å¯¹è±¡æ¶æå®ä¸ä¸ªåéçå¤§å°ï¼è¿æ ·å°±å¯ä»¥åå°åå­çç³è¯·ä»èé¿åäº oomã\n\n// ç¼å²åºæ± ï¼å¤ç¨ bytes.buffer å¯¹è±¡\nvar bufferpool = sync.pool{\n\tnew: func() interface{} {\n\t\t// é¢åé 1kb å®¹éï¼åå°æ©å®¹æ¬¡æ°\n\t\tbuf := make([]byte, 0, 1024)\n\t\treturn bytes.newbuffer(buf)\n\t},\n}\n\nfunc serialize(value interface{}) ([]byte, error) {\n\tif value == nil {\n\t\treturn nil, fmt.errorf("input nil value")\n\t}\n\n\t// ä»æ± ä¸­è·åç¼å²åº\n\tbuf := bufferpool.get().(*bytes.buffer)\n\tdefer func() {\n\t\tbuf.reset()\n\t\tbufferpool.put(buf)\n\t}()\n\n\tencoder := gob.newencoder(buf)\n\tif err := encoder.encode(&value); err != nil {\n\t\treturn nil, err\n\t}\n\n\t// é«æçå­èåçåéè¿åæ°æ®\n\treturn bytesclone(buf.bytes()), nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\n\n# æ»ç»\n\n 1. å¨ç¼ç æ¹é¢éè¦æ³¨æåå­ç®¡çåå¯¹è±¡å¤ç¨å¯¹ç³»ç»ç¨³å®æ§çéè¦æ§ã\n 2. åäºå©ç¨å·¥å·æ¥è¾å©ææ¥é®é¢ã',charsets:{cjk:!0},lastUpdated:"2025/09/22, 16:52:15",lastUpdatedTimestamp:1758531135e3},{title:"kafkaä¸­listeneråadvertised.listenersçä½ç¨",frontmatter:{title:"kafkaä¸­listeneråadvertised.listenersçä½ç¨",date:"2023-05-01T17:41:02.000Z",permalink:"/pages/fa114f/",categories:["ä¸­é´ä»¶","kafka"],tags:["kafka","ä¸­é´ä»¶"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¦ä¸éç½®ï¼",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"kafkaä¸­listeneråadvertised.listenersçä½ç¨"},{name:"twitter:description",content:"å¦ä¸éç½®ï¼"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/01.kafka/01.listener%E5%92%8Cadvertised.listeners%E7%9A%84%E4%BD%9C%E7%94%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"kafkaä¸­listeneråadvertised.listenersçä½ç¨"},{property:"og:description",content:"å¦ä¸éç½®ï¼"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/01.kafka/01.listener%E5%92%8Cadvertised.listeners%E7%9A%84%E4%BD%9C%E7%94%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-05-01T17:41:02.000Z"},{property:"article:tag",content:"kafka"},{property:"article:tag",content:"ä¸­é´ä»¶"},{itemprop:"name",content:"kafkaä¸­listeneråadvertised.listenersçä½ç¨"},{itemprop:"description",content:"å¦ä¸éç½®ï¼"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/01.kafka/01.listener%E5%92%8Cadvertised.listeners%E7%9A%84%E4%BD%9C%E7%94%A8.html",relativePath:"03.ä¸­é´ä»¶/01.kafka/01.listeneråadvertised.listenersçä½ç¨.md",key:"v-5793b4fb",path:"/pages/fa114f/",headers:[{level:2,title:"listener",slug:"listener",normalizedTitle:"listener",charIndex:2},{level:2,title:"advertised.listeners",slug:"advertised-listeners",normalizedTitle:"advertised.listeners",charIndex:630},{level:2,title:"åå¤ç½åæµ",slug:"åå¤ç½åæµ",normalizedTitle:"åå¤ç½åæµ",charIndex:1647},{level:2,title:"åèé¾æ¥",slug:"åèé¾æ¥",normalizedTitle:"åèé¾æ¥",charIndex:2246}],headersStr:"listener advertised.listeners åå¤ç½åæµ åèé¾æ¥",content:'# listener\n\nlisteneréç½®æ¯ç¨æ¥ç»å®BrokerIP+ç«¯å£å°å çï¼ä¹å°±æ¯åªæéè¿ç»å®çå°åæè½å¤è®¿é®å°è¯¥Brokerãé¤äºç»å®å°åä¹å¤ï¼è¿å¯ä»¥éç½®è¯¥çå¬å°åçè®¤è¯åè®®ï¼ä¹å°±æ¯ä½¿ç¨è¯¥å°åè¿æ¥Brokeræ¶éè¦æå®ä½¿ç¨ä½ç§åè®®æ¹å¼è¿è¡è¿æ¥ã\n\nå¦ä¸éç½®ï¼\n\nlisteners: INTERNAL://172.17.0.10:9092,EXTERNAL://172.17.0.10:9094\nkafka_listener_security_protocol_map: "INTERNAL:SASL_PLAINTEXT,EXTERNAL:SASL_PLAINTEXT"\n\n\n1\n2\n\n\nè¿æ¥è¯¥Brokerçå®¢æ·ç«¯åªè½éè¿172.17.0.10:9092 å172.17.0.10:9094 è¿ä¸¤ä¸ªå°åè®¿é®kafkaï¼å¹¶ç»åä¸ä¸ªå°åè®¾ç½®listeneråç§°ä¸ºINTERNAL ï¼åä¸ä¸ªä¸ºEXTERNAL\n\nå¨kafka_listener_security_protocol_map éç½®ä¸­è®¾ç½®listeneræä½¿ç¨çéä¿¡åè®®ï¼INTERNALè®¾ç½®çæ¯SASL_PLAINTEXT ï¼è¿ä¹æ¯å¸¸è§çç¨æ·ååå¯ç è®¤è¯åè®®ï¼EXTERNAL è®¾ç½®ä¹æ¯è¯¥åè®®ã\n\næç»ï¼kafka å®¢æ·ç«¯è¿æ¥è¯¥kafka brokerï¼éè¦éè¿172.17.0.10:9092 æ172.17.0.10:9094 å°åè¿è¡è¿æ¥ï¼å¹¶ä¸é½éè¦ä½¿ç¨ç¨æ·ååå¯ç è¿è¡è®¤è¯ã\n\n\n# advertised.listeners\n\nè¯¥éç½®æå®Kafka Brokerå¯¹å¤å¬å¼çç½ç»IPåç«¯å£ï¼ç¨äºåç¥å®¢æ·ç«¯å¦ä½è¿æ¥å°Kafka Brokerãå¬å¼çæ¹å¼æ¯éè¿å­å¨å¨zookeeperä¸­è¿è¡å±äº«æ°æ®çã\n\nå¦ä¸éç½®ï¼\n\nlisteners: INTERNAL://172.17.0.10:9092,EXTERNAL://172.17.0.10:9094\nadvertised_listeners: INTERNAL://172.17.0.10:9092,EXTERNAL://å¬ç½IP:ç«¯å£\nkafka_listener_security_protocol_map: "INTERNAL:SASL_PLAINTEXT,EXTERNAL:SASL_PLAINTEXT"\n\n\n1\n2\n3\n\n\nlisteners åkafka_listener_security_protocol_map çéç½®åä¸é¢è®²çä¸æ ·ï¼èadvertised_listeners çéç½®ålisteners éç½®å«ä¹åºæ¬ä¸è´ï¼ä½æ¯å®ä¼ä¿å­å¨zookeeperä¸­/brokers/ids/0 çendpointséã\n\n...\n"endpoints":["INTERNAL://172.17.0.10:9092","EXTERNAL://172.17.0.10:9094"]\n...\n\n\n1\n2\n3\n\n\nkafkaå®¢æ·ç«¯è¿æ¥kafka brokeræ¶ï¼ä¼åè·åææbrokersçåæ°æ®ä¿¡æ¯ï¼è·åå°endpointsçä¿¡æ¯ï¼ç¶ååéè¿å¶ä¸­çendpintè¿è¡å¯¹brokerè¿è¡è¿æ¥æä½ã\n\né®é¢æ¥äºï¼æé½ç¥éäºkafka brokerçIPå°å+ç«¯å£äºï¼ä¸ºä»ä¹è¿éè¦advertised.listeners?\n\nå¨éè¦ä»£çæè½è¿æ¥kafka brokeræ¶ï¼å¨è¿ç§åºæ¯æ¶ï¼éè¦å°advertised.listeners è®¾ç½®ä¸ºä»£ççå°åã\n\nå¨å¬æäºåºæ¯ä¸é¨ç½²kafkaéç¾¤ï¼å¬ç½IPä¸æ¯å¨æ¬èç¹ç½å¡ä¸çï¼æä»¥æ æ³éè¿listenerè¿è¡ç»å®ï¼æä»¥åªè½éè¿0.0.0.0è¿è¡ç»å®ãä½æ¯å¨éç¾¤å¤é¨æ¶ï¼kafkaå®¢æ·ç«¯è¿è¡è¿æ¥ï¼å®æ¯éè¦æè½åè®¿é®kafkaçæ¯ä¸ä¸ªbrokerèç¹çï¼æä»¥éè¦å¨advertised.listenersä¸­éç½®å¬ç½IPï¼å¹¶å­å¨å¨zookeeperä¸­ï¼è¿æ ·kafkaå®¢æ·ç«¯å°±è½æ¿å°ææbrokerèç¹çå¬ç½IPå¹¶è¿è¡è®¿é®ã\n\n\n# åå¤ç½åæµ\n\nå¨å¬æäºåºæ¯ä¸ï¼æä»¬å¸æå¨éç¾¤åé¨å®¢æ·ç«¯è®¿é®æ¶ä¸éè¦è®¤è¯ï¼èå¤é¨å®¢æ·ç«¯è®¿é®æ¶éè¦èµ°è®¤è¯å å¯è®¿é®ãéç½®å¦ä¸ï¼\n\nlisteners: INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094\nadvertised_listeners: INTERNAL://åç½IP:9092,EXTERNAL://å¬ç½IP:9094\nkafka_listener_security_protocol_map: "INTERNAL:PLAINTEXT,EXTERNAL:SASL_PLAINTEXT"\n\n\n1\n2\n3\n\n\nlistenersé½è®¾ç½®æå¯¹0.0.0.0è¿è¡çå¬ä¹å°±æ¯çå¬ææçç½å¡ï¼ä½å®ä»¬çç«¯å£ä¸åï¼9092ç«¯å£ä½¿ç¨PLAINTEXTåè®®ï¼è9094ç«¯å£èµ°çæ¯SASL_PLAINTEXTåè®®\n\nadvertised_listenersï¼åç½IPä½¿ç¨PLAINTEXTåè®®ï¼å¬ç½IPä½¿ç¨SASL_PLAINTEXTåè®®ã\n\nå½åç½å®¢æ·ç«¯è®¿é®æ¶ï¼ä¼åè·åå°ææbrokersçadvertised_listenersä¿¡æ¯ï¼ç¶åéè¿PLAINTEXTåè®®èµ°åç½IPè®¿é®kafkaéç¾¤ã\n\nå½å¬ç½å®¢æ·ç«¯è®¿é®æ¶ï¼ä¼åè·åå°ææbrokersçadvertised_listenersä¿¡æ¯ï¼ç¶åéè¿SASL_PLAINTEXTèµ°å¬ç½IPè¿è¡è®¿é®ã\n\nâ\n\n\n# åèé¾æ¥\n\n * https://www.finclip.com/news/f/30226.html\n * https://juejin.cn/post/6893410969611927566',normalizedContent:'# listener\n\nlisteneréç½®æ¯ç¨æ¥ç»å®brokerip+ç«¯å£å°å çï¼ä¹å°±æ¯åªæéè¿ç»å®çå°åæè½å¤è®¿é®å°è¯¥brokerãé¤äºç»å®å°åä¹å¤ï¼è¿å¯ä»¥éç½®è¯¥çå¬å°åçè®¤è¯åè®®ï¼ä¹å°±æ¯ä½¿ç¨è¯¥å°åè¿æ¥brokeræ¶éè¦æå®ä½¿ç¨ä½ç§åè®®æ¹å¼è¿è¡è¿æ¥ã\n\nå¦ä¸éç½®ï¼\n\nlisteners: internal://172.17.0.10:9092,external://172.17.0.10:9094\nkafka_listener_security_protocol_map: "internal:sasl_plaintext,external:sasl_plaintext"\n\n\n1\n2\n\n\nè¿æ¥è¯¥brokerçå®¢æ·ç«¯åªè½éè¿172.17.0.10:9092 å172.17.0.10:9094 è¿ä¸¤ä¸ªå°åè®¿é®kafkaï¼å¹¶ç»åä¸ä¸ªå°åè®¾ç½®listeneråç§°ä¸ºinternal ï¼åä¸ä¸ªä¸ºexternal\n\nå¨kafka_listener_security_protocol_map éç½®ä¸­è®¾ç½®listeneræä½¿ç¨çéä¿¡åè®®ï¼internalè®¾ç½®çæ¯sasl_plaintext ï¼è¿ä¹æ¯å¸¸è§çç¨æ·ååå¯ç è®¤è¯åè®®ï¼external è®¾ç½®ä¹æ¯è¯¥åè®®ã\n\næç»ï¼kafka å®¢æ·ç«¯è¿æ¥è¯¥kafka brokerï¼éè¦éè¿172.17.0.10:9092 æ172.17.0.10:9094 å°åè¿è¡è¿æ¥ï¼å¹¶ä¸é½éè¦ä½¿ç¨ç¨æ·ååå¯ç è¿è¡è®¤è¯ã\n\n\n# advertised.listeners\n\nè¯¥éç½®æå®kafka brokerå¯¹å¤å¬å¼çç½ç»ipåç«¯å£ï¼ç¨äºåç¥å®¢æ·ç«¯å¦ä½è¿æ¥å°kafka brokerãå¬å¼çæ¹å¼æ¯éè¿å­å¨å¨zookeeperä¸­è¿è¡å±äº«æ°æ®çã\n\nå¦ä¸éç½®ï¼\n\nlisteners: internal://172.17.0.10:9092,external://172.17.0.10:9094\nadvertised_listeners: internal://172.17.0.10:9092,external://å¬ç½ip:ç«¯å£\nkafka_listener_security_protocol_map: "internal:sasl_plaintext,external:sasl_plaintext"\n\n\n1\n2\n3\n\n\nlisteners åkafka_listener_security_protocol_map çéç½®åä¸é¢è®²çä¸æ ·ï¼èadvertised_listeners çéç½®ålisteners éç½®å«ä¹åºæ¬ä¸è´ï¼ä½æ¯å®ä¼ä¿å­å¨zookeeperä¸­/brokers/ids/0 çendpointséã\n\n...\n"endpoints":["internal://172.17.0.10:9092","external://172.17.0.10:9094"]\n...\n\n\n1\n2\n3\n\n\nkafkaå®¢æ·ç«¯è¿æ¥kafka brokeræ¶ï¼ä¼åè·åææbrokersçåæ°æ®ä¿¡æ¯ï¼è·åå°endpointsçä¿¡æ¯ï¼ç¶ååéè¿å¶ä¸­çendpintè¿è¡å¯¹brokerè¿è¡è¿æ¥æä½ã\n\né®é¢æ¥äºï¼æé½ç¥éäºkafka brokerçipå°å+ç«¯å£äºï¼ä¸ºä»ä¹è¿éè¦advertised.listeners?\n\nå¨éè¦ä»£çæè½è¿æ¥kafka brokeræ¶ï¼å¨è¿ç§åºæ¯æ¶ï¼éè¦å°advertised.listeners è®¾ç½®ä¸ºä»£ççå°åã\n\nå¨å¬æäºåºæ¯ä¸é¨ç½²kafkaéç¾¤ï¼å¬ç½ipä¸æ¯å¨æ¬èç¹ç½å¡ä¸çï¼æä»¥æ æ³éè¿listenerè¿è¡ç»å®ï¼æä»¥åªè½éè¿0.0.0.0è¿è¡ç»å®ãä½æ¯å¨éç¾¤å¤é¨æ¶ï¼kafkaå®¢æ·ç«¯è¿è¡è¿æ¥ï¼å®æ¯éè¦æè½åè®¿é®kafkaçæ¯ä¸ä¸ªbrokerèç¹çï¼æä»¥éè¦å¨advertised.listenersä¸­éç½®å¬ç½ipï¼å¹¶å­å¨å¨zookeeperä¸­ï¼è¿æ ·kafkaå®¢æ·ç«¯å°±è½æ¿å°ææbrokerèç¹çå¬ç½ipå¹¶è¿è¡è®¿é®ã\n\n\n# åå¤ç½åæµ\n\nå¨å¬æäºåºæ¯ä¸ï¼æä»¬å¸æå¨éç¾¤åé¨å®¢æ·ç«¯è®¿é®æ¶ä¸éè¦è®¤è¯ï¼èå¤é¨å®¢æ·ç«¯è®¿é®æ¶éè¦èµ°è®¤è¯å å¯è®¿é®ãéç½®å¦ä¸ï¼\n\nlisteners: internal://0.0.0.0:9092,external://0.0.0.0:9094\nadvertised_listeners: internal://åç½ip:9092,external://å¬ç½ip:9094\nkafka_listener_security_protocol_map: "internal:plaintext,external:sasl_plaintext"\n\n\n1\n2\n3\n\n\nlistenersé½è®¾ç½®æå¯¹0.0.0.0è¿è¡çå¬ä¹å°±æ¯çå¬ææçç½å¡ï¼ä½å®ä»¬çç«¯å£ä¸åï¼9092ç«¯å£ä½¿ç¨plaintextåè®®ï¼è9094ç«¯å£èµ°çæ¯sasl_plaintextåè®®\n\nadvertised_listenersï¼åç½ipä½¿ç¨plaintextåè®®ï¼å¬ç½ipä½¿ç¨sasl_plaintextåè®®ã\n\nå½åç½å®¢æ·ç«¯è®¿é®æ¶ï¼ä¼åè·åå°ææbrokersçadvertised_listenersä¿¡æ¯ï¼ç¶åéè¿plaintextåè®®èµ°åç½ipè®¿é®kafkaéç¾¤ã\n\nå½å¬ç½å®¢æ·ç«¯è®¿é®æ¶ï¼ä¼åè·åå°ææbrokersçadvertised_listenersä¿¡æ¯ï¼ç¶åéè¿sasl_plaintextèµ°å¬ç½ipè¿è¡è®¿é®ã\n\nâ\n\n\n# åèé¾æ¥\n\n * https://www.finclip.com/news/f/30226.html\n * https://juejin.cn/post/6893410969611927566',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"mysqlä¹æ¥å¿",frontmatter:{title:"mysqlä¹æ¥å¿",date:"2023-01-01T20:23:07.000Z",permalink:"/pages/2d69c7/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä¸æ¡æ°æ®å¨æ´æ°è¿ç¨å½ä¸­ï¼å¦æä¸­é mysql crash äºï¼mysql æ¯å¦ä½ä¿è¯æ°æ®çä¸è´æ§åæä¹æ§çï¼å¨è¿ä¸ªè¿ç¨ä¸­ mysql çæ¥å¿ç³»ç»èµ·å°äºè³å³éè¦çä½ç¨ãæ¬æå°ä¼ä»ç» mysql ä¸­ç undo logãredo log å bin log å¨è¿å¶ä¸­çä½ç¨ã",feed:{enable:!0},tags:["mysql","æ°æ®åº"],categories:["æ°æ®åº","mysql"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16699026890611669902688907.png"},{name:"twitter:title",content:"mysqlä¹æ¥å¿"},{name:"twitter:description",content:"ä¸æ¡æ°æ®å¨æ´æ°è¿ç¨å½ä¸­ï¼å¦æä¸­é mysql crash äºï¼mysql æ¯å¦ä½ä¿è¯æ°æ®çä¸è´æ§åæä¹æ§çï¼å¨è¿ä¸ªè¿ç¨ä¸­ mysql çæ¥å¿ç³»ç»èµ·å°äºè³å³éè¦çä½ç¨ãæ¬æå°ä¼ä»ç» mysql ä¸­ç undo logãredo log å bin log å¨è¿å¶ä¸­çä½ç¨ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16699026890611669902688907.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/03.mysql/01.mysql%E4%B9%8B%E6%97%A5%E5%BF%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"mysqlä¹æ¥å¿"},{property:"og:description",content:"ä¸æ¡æ°æ®å¨æ´æ°è¿ç¨å½ä¸­ï¼å¦æä¸­é mysql crash äºï¼mysql æ¯å¦ä½ä¿è¯æ°æ®çä¸è´æ§åæä¹æ§çï¼å¨è¿ä¸ªè¿ç¨ä¸­ mysql çæ¥å¿ç³»ç»èµ·å°äºè³å³éè¦çä½ç¨ãæ¬æå°ä¼ä»ç» mysql ä¸­ç undo logãredo log å bin log å¨è¿å¶ä¸­çä½ç¨ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16699026890611669902688907.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/03.mysql/01.mysql%E4%B9%8B%E6%97%A5%E5%BF%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-01-01T20:23:07.000Z"},{property:"article:tag",content:"mysql"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"mysqlä¹æ¥å¿"},{itemprop:"description",content:"ä¸æ¡æ°æ®å¨æ´æ°è¿ç¨å½ä¸­ï¼å¦æä¸­é mysql crash äºï¼mysql æ¯å¦ä½ä¿è¯æ°æ®çä¸è´æ§åæä¹æ§çï¼å¨è¿ä¸ªè¿ç¨ä¸­ mysql çæ¥å¿ç³»ç»èµ·å°äºè³å³éè¦çä½ç¨ãæ¬æå°ä¼ä»ç» mysql ä¸­ç undo logãredo log å bin log å¨è¿å¶ä¸­çä½ç¨ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16699026890611669902688907.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/03.mysql/01.mysql%E4%B9%8B%E6%97%A5%E5%BF%97.html",relativePath:"03.ä¸­é´ä»¶/03.mysql/01.mysqlä¹æ¥å¿.md",key:"v-967c62b6",path:"/pages/2d69c7/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"buffer pool",slug:"buffer-pool",normalizedTitle:"buffer pool",charIndex:146},{level:2,title:"undo log",slug:"undo-log",normalizedTitle:"undo log",charIndex:105},{level:2,title:"redo log",slug:"redo-log",normalizedTitle:"redo log",charIndex:114},{level:3,title:"redo log çä½ç¨",slug:"redo-log-çä½ç¨",normalizedTitle:"redo log çä½ç¨",charIndex:537},{level:3,title:"redo logæä»¶ç»æ",slug:"redo-logæä»¶ç»æ",normalizedTitle:"redo logæä»¶ç»æ",charIndex:1128},{level:2,title:"binlog",slug:"binlog",normalizedTitle:"binlog",charIndex:1333},{level:2,title:"ä¸¤é¶æ®µæäº¤",slug:"ä¸¤é¶æ®µæäº¤",normalizedTitle:"ä¸¤é¶æ®µæäº¤",charIndex:1764},{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:2647}],headersStr:"åè¨ buffer pool undo log redo log redo log çä½ç¨ redo logæä»¶ç»æ binlog ä¸¤é¶æ®µæäº¤ ç¸å³é¾æ¥",content:"# åè¨\n\nä¸æ¡æ°æ®å¨æ´æ°è¿ç¨å½ä¸­ï¼å¦æä¸­é mysql crash äºï¼mysql æ¯å¦ä½ä¿è¯æ°æ®çä¸è´æ§åæä¹æ§çï¼å¨è¿ä¸ªè¿ç¨ä¸­ mysql çæ¥å¿ç³»ç»èµ·å°äºè³å³éè¦çä½ç¨ãæ¬æå°ä¼ä»ç» mysql ä¸­ç undo logãredo log å bin log å¨è¿å¶ä¸­çä½ç¨ã\n\n\n# buffer pool\n\nå¨æ°æ®æ´æ°çæ¶åï¼æ°æ®å¹¶ä¸æ¯å®æ¶åæ­¥å°ç¡¬çä¸­ï¼èæ¯å¨ä¸åç¼å­ buffer pool ä¸­æ´æ°ï¼å¦æç¼å­ä¸­æ²¡ææ¥è¯¢å°è¯¥æ°æ®ï¼åä»ç£çä¸­å è½½å° buffer pool ä¸­ã\n\nå½ç¶ï¼ç¼å­çä½ç¨æ¯ä¸ºäºæé« IO æ§è½ï¼å¯ä»¥éè¿å°æ°æ®åä¿çå¨ç¼å­ä¸­ï¼ç¶åå¨éå½çæ¶æºï¼æ¹éåå¥å°ç¡¬çä¸­ã\n\nå¹¶ä¸å¨æ¥è¯¢æ°æ®æ¶ï¼åæ¯ä»ç¼å­ä¸­è¿è¡æ¥è¯¢ï¼ä¸ç¨å»ç£çä¸­æ¥æ¾ï¼åå° IO çæä½ï¼å å¿«æ¥è¯¢çéåº¦ã\n\n\n# undo log\n\næä»¬ç¥é InnoDB æ¯æ¯æäºå¡çï¼å¨äºå¡æäº¤å¤±è´¥æ¶ï¼æ¯ä¼åæ»å°æ§è¡ä¹åçç¶æï¼é£ä¹è¯å®æ¯éè¦ä¿å­ä¹åçç¶ææå¯ä»¥è¿è¡æ¢å¤çï¼è¿ä¸ªå°±æ¯éè¿ undo log æ¥å®ç°çã\n\nå¨æ°æ®åå¥ buffer pool çåæ¶ä¼å°æ´æ°åçæ°æ®ä¿å­å¨ undo log ä¸­ï¼éè¿è¯¥æ¥å¿è¯­å¥ä¾¿å¯ä»¥å¨äºå¡åæ»æ¶ï¼æ¢å¤å°ä¹åçç¶æã\n\n\n# redo log\n\n\n# redo log çä½ç¨\n\nååå° buffer pool ï¼å ä¸ºå®æ¯ç¼å­ï¼æ¯å¨åå­ä¸­ï¼ææå®çç¼ºç¹ä¹æ¾èæè§ï¼é£å°±æ¯å½æå¡å¨å®æºä¸­ï¼ç¼å­ä¸­çæ°æ®ä¼ä¸¢å¤±ï¼é£ä¹ mysql æ¯å¦ä½ä¿è¯æ°æ®çæä¹æ§å¢ï¼è¿ä¸ªæ¶åå°±è¦æ¥ä»ç»ä»ç» redo log äºã\n\nå¨æ°æ®æ´æ°å° buffer pool åï¼è¿ä¸ªæ¶åä¼å°æ´æ°åçæ°æ®è®°å½å° redo log buffer ä¸­ï¼è¿ä¸ªä¹æ¯ä¸ä¸ªç¼å­åºï¼å®å½ç¶ä¹å·å¤äºç¼å­ä¼ç¼ºç¹ï¼å¹¶ä¸é»è®¤æ¯å¨æäº¤äºå¡çæ¶ååå¥å° redo log ä¸­ï¼å·ççç­ç¥å¯ä»¥æ ¹æ® innodb_flush_log_at_trx_commit æ¥è®¾ç½®\n\n * 0ï¼ä¸å·å¥ç£ç\n * 1ï¼ç«å³å·å¥ç£çï¼é»è®¤ï¼\n * 2ï¼åå·å¥å° os cache ä¸­\n\nå ä¸º redo log æ¯é¡ºåºåå¥ï¼æä»¥ IO æ§è½ä¸ä¼å¤ªå·®ã\n\nå½ buffer pool ä¸­çæ°æ®è¿æ²¡æåå¥å°ç£çä¸­æ¶ï¼åçäºå®æºï¼å½ mysql éå¯æ¶ï¼ä¼è¯»åå·²ç»æä¹å redo log ä¸­çæ°æ®ï¼åæ¢å¤å° buffer pool ä¸­ã\n\nå¨å¼å¯äºå¡åå¤æ´æ°ä¸æ¡è®°å½æ¶ï¼InnoDB ä¼åå¨ buffer pool ä¸­æ´æ°æ°æ®ï¼ç¶åå°æ´æ°åçæ°æ®è®°å½å° redo log buffer ä¸­ï¼è¿ä¹æ¯ä¸ä¸ªç¼å­ãå½ç¶è¿ä¸ªæ¶åä¹æ¯ä¼åçå®æºï¼ä½æ¯æ²¡å³ç³»ï¼å¦æè¯¥é¨åæ°æ®ä¸¢å¤±ï¼åè®¤ä¸ºè¯¥æ¬¡äºå¡æäº¤å¤±è´¥ï¼æ°æ®ä¼æ¢å¤å°ä¹åçç¶æã\n\n\n# redo logæä»¶ç»æ\n\nredolog æ¯ç±å¤ä¸ªåºå®å¤§å°çæä»¶ç»æçä¸ä¸ªç¯å½¢ç»æï¼å¹¶å¨è¿ä¸ªç¯å½¢ç»æä¸­ä¸æ­çåå¥ä¸è¦ççè¿ç¨ã\n\n * write posï¼è®°å½å½åçä½ç½®\n * checkpointï¼å½åè¦æ¦é¤çä½ç½®\n\nå½ææ°ç redo log åå¥æ¶ï¼ä» wirte pos ä½ç½®å¾ååï¼è check point æ¯ä¸ä¸æ¬¡å·²ç»å·å¥ç£ççæ°æ®çä½ç½®ï¼ä¹æ¯è¦ä¸æ­çå¾åæ¨è¿ï¼ç¶åå°æ°æ®å·å¥ç£çä¸­ã\n\n\n# binlog\n\næ¯å¨ mysql å±çº§è®°å½çæ¥å¿ï¼ä¸»è¦æ¯ç¨äºä¸»ä»å¤å¶åæ°æ®æ¢å¤ï¼å¯ä»¥éè¿æä¸ªæ¶é´çå¨éå¤ä»½+binlog æ¥æ¢å¤å°ä»»ææ¶é´åçç¶æã\n\nå redo log çåºå«\n\næ§è´¨   REDO LOG                      BIN LOG                        \nå®ç°   innodb ç¬æå®ç°                   mysql server å±çº§å®ç°ï¼ææçå¼æé½å¯ä»¥ä½¿ç¨   \nåå®¹   ç©ç log, è®°å½çæ¯âå¨æä¸ªæ°æ®é¡µä¸åäºä»ä¹ä¿®æ¹â   é»è¾ logï¼ç» ID=2 è¿ä¸è¡ç c å­æ®µå  1     \nåå¥   å¾ªç¯åå¥                          è¿½å åï¼åå°ä¸å®å¤§å°åæ¢ä¸ä¸ä¸ªæä»¶ç»§ç»­å           \nåºç¨   å´©æºæ¢å¤(crash-safe)              ä¸»ä»åæ­¥ï¼æ°æ®æ¢å¤                      \n\n\n# ä¸¤é¶æ®µæäº¤\n\nä¸ºä»ä¹éè¦ä¸¤é¶æ®µæäº¤ï¼\n\næ¯ä¸ºäºè®© redo log å bin log ä¿æé»è¾ä¸è´æ§ã\n\n 1. å¦æåå redolog åå bin logãåè®¾ redo log åå®ï¼å bin log æ¶ crash äºã\n\nå ä¸º redo log åå®äºï¼æä»¥å³ä½¿ç³»ç»å´©æºï¼ä¹å¯ä»¥æ¢å¤æ°æ®ï¼ä½æ¯ bin log æ²¡åå® crash äºï¼è¿ä¸ªæ¶å bin log ä¸­å°äºè¯¥æ¡è¯­å¥ï¼å æ­¤æ°æ®å¤ä»½çæ¶åï¼å¦æä½¿ç¨äºè¯¥ä»½ bin log åä¼å°ä¸æ¬¡æ´æ°ã\n\n 2. å¦æåå bin log åå redo logãåè®¾ bin log åå®ï¼å redo log æ¶ crash äºã\n\nå ä¸º redo log æ²¡åå®ï¼æä»¥è¯¥äºå¡æ²¡æçæï¼ä½æ¯ binlog ä¸­å·²ç»æè¯¥æ¡è®°å½ï¼æä»¥ä½¿ç¨ bin log æ¶ï¼ä¼å¤åºä¸ä¸ªäºå¡ï¼ä¸åæ¥çæ°æ®ä¸ä¸è´ã\n\næä»¥ä½¿ç¨ä¸¤é¶æ®µæäº¤å¯ä»¥è§£å³ä¸é¢ä¸¤ç§åºæ¯ã\n\nä¸¤é¶æ®µæäº¤çå®ç°é»è¾\n\n 1. å¨æ´æ°æ°æ®æ¶ï¼ä¼åå¨ redo log ä¸­è®°å½å½åæ´æ°çæ°æ®ï¼å¹¶ä¸æ è®°ä¸º prepare ç¶æ\n 2. binlog åè¿è¡åå¥\n 3. äºå¡æäº¤æ¶ï¼ redo log åå°è¯¥æ¡è®°å½æ è®°ä¸º commit ç¶æå¹¶ä¸å·å¥å°ç£çä¸­ã\n\néè¿ prepare å commit ä¸¤ç§ç¶ææ¥å®æä¸¤é¶æ®µçæäº¤å®ç°ã\n\néªè¯ä¸¤é¶æ®µæäº¤\n\n 1. å¦æå¨ä¸¤é¶æ®µæäº¤çç¬¬ä¸æ­¥ååç crashï¼ä¹å°±æ¯ redo log å·²ç»æ´æ°äºæ°æ®å¹¶ä¸ä¸º Prepare ç¶æï¼ä½æ¯ binlog è¿æªåå¥å°±åºç°äº crashï¼è¿ä¸ªæ¶åï¼mysql éå¯åï¼å ä¸º redo log æª commitï¼å¯ä»¥éè¿åæ»å°æ°æ®æ¢å¤ã\n 2. å¦æå¨ç¬¬äºæ­¥åç crashï¼ä¹å°±æ¯ redo log ä¸º prepare ç¶æï¼å¹¶ä¸ binlog å·²ç»åå¥ï¼ä½æ¯è¿æ¶ååºç°äº crashï¼å¨ mysql éå¯åï¼å ä¸º binlog å·²ç»æäºè®°å½ï¼æä»¥ä¼ç»§ç»­æäº¤è¯¥äºå¡ï¼å¦å bin log ä¸­æ°æ®æ°å¢äºä¸æ¡ï¼è redo log æ²¡æäº¤åå¯è½åçä¸¤èæ°æ®ä¸ä¸è´çæåµã\n\n\n# ç¸å³é¾æ¥\n\n * ä¸æ¡ SQL çæ§è¡è¿ç¨è¯¦è§£\n * åºäºRedo LogåUndo LogçMySQLå´©æºæ¢å¤æµç¨",normalizedContent:"# åè¨\n\nä¸æ¡æ°æ®å¨æ´æ°è¿ç¨å½ä¸­ï¼å¦æä¸­é mysql crash äºï¼mysql æ¯å¦ä½ä¿è¯æ°æ®çä¸è´æ§åæä¹æ§çï¼å¨è¿ä¸ªè¿ç¨ä¸­ mysql çæ¥å¿ç³»ç»èµ·å°äºè³å³éè¦çä½ç¨ãæ¬æå°ä¼ä»ç» mysql ä¸­ç undo logãredo log å bin log å¨è¿å¶ä¸­çä½ç¨ã\n\n\n# buffer pool\n\nå¨æ°æ®æ´æ°çæ¶åï¼æ°æ®å¹¶ä¸æ¯å®æ¶åæ­¥å°ç¡¬çä¸­ï¼èæ¯å¨ä¸åç¼å­ buffer pool ä¸­æ´æ°ï¼å¦æç¼å­ä¸­æ²¡ææ¥è¯¢å°è¯¥æ°æ®ï¼åä»ç£çä¸­å è½½å° buffer pool ä¸­ã\n\nå½ç¶ï¼ç¼å­çä½ç¨æ¯ä¸ºäºæé« io æ§è½ï¼å¯ä»¥éè¿å°æ°æ®åä¿çå¨ç¼å­ä¸­ï¼ç¶åå¨éå½çæ¶æºï¼æ¹éåå¥å°ç¡¬çä¸­ã\n\nå¹¶ä¸å¨æ¥è¯¢æ°æ®æ¶ï¼åæ¯ä»ç¼å­ä¸­è¿è¡æ¥è¯¢ï¼ä¸ç¨å»ç£çä¸­æ¥æ¾ï¼åå° io çæä½ï¼å å¿«æ¥è¯¢çéåº¦ã\n\n\n# undo log\n\næä»¬ç¥é innodb æ¯æ¯æäºå¡çï¼å¨äºå¡æäº¤å¤±è´¥æ¶ï¼æ¯ä¼åæ»å°æ§è¡ä¹åçç¶æï¼é£ä¹è¯å®æ¯éè¦ä¿å­ä¹åçç¶ææå¯ä»¥è¿è¡æ¢å¤çï¼è¿ä¸ªå°±æ¯éè¿ undo log æ¥å®ç°çã\n\nå¨æ°æ®åå¥ buffer pool çåæ¶ä¼å°æ´æ°åçæ°æ®ä¿å­å¨ undo log ä¸­ï¼éè¿è¯¥æ¥å¿è¯­å¥ä¾¿å¯ä»¥å¨äºå¡åæ»æ¶ï¼æ¢å¤å°ä¹åçç¶æã\n\n\n# redo log\n\n\n# redo log çä½ç¨\n\nååå° buffer pool ï¼å ä¸ºå®æ¯ç¼å­ï¼æ¯å¨åå­ä¸­ï¼ææå®çç¼ºç¹ä¹æ¾èæè§ï¼é£å°±æ¯å½æå¡å¨å®æºä¸­ï¼ç¼å­ä¸­çæ°æ®ä¼ä¸¢å¤±ï¼é£ä¹ mysql æ¯å¦ä½ä¿è¯æ°æ®çæä¹æ§å¢ï¼è¿ä¸ªæ¶åå°±è¦æ¥ä»ç»ä»ç» redo log äºã\n\nå¨æ°æ®æ´æ°å° buffer pool åï¼è¿ä¸ªæ¶åä¼å°æ´æ°åçæ°æ®è®°å½å° redo log buffer ä¸­ï¼è¿ä¸ªä¹æ¯ä¸ä¸ªç¼å­åºï¼å®å½ç¶ä¹å·å¤äºç¼å­ä¼ç¼ºç¹ï¼å¹¶ä¸é»è®¤æ¯å¨æäº¤äºå¡çæ¶ååå¥å° redo log ä¸­ï¼å·ççç­ç¥å¯ä»¥æ ¹æ® innodb_flush_log_at_trx_commit æ¥è®¾ç½®\n\n * 0ï¼ä¸å·å¥ç£ç\n * 1ï¼ç«å³å·å¥ç£çï¼é»è®¤ï¼\n * 2ï¼åå·å¥å° os cache ä¸­\n\nå ä¸º redo log æ¯é¡ºåºåå¥ï¼æä»¥ io æ§è½ä¸ä¼å¤ªå·®ã\n\nå½ buffer pool ä¸­çæ°æ®è¿æ²¡æåå¥å°ç£çä¸­æ¶ï¼åçäºå®æºï¼å½ mysql éå¯æ¶ï¼ä¼è¯»åå·²ç»æä¹å redo log ä¸­çæ°æ®ï¼åæ¢å¤å° buffer pool ä¸­ã\n\nå¨å¼å¯äºå¡åå¤æ´æ°ä¸æ¡è®°å½æ¶ï¼innodb ä¼åå¨ buffer pool ä¸­æ´æ°æ°æ®ï¼ç¶åå°æ´æ°åçæ°æ®è®°å½å° redo log buffer ä¸­ï¼è¿ä¹æ¯ä¸ä¸ªç¼å­ãå½ç¶è¿ä¸ªæ¶åä¹æ¯ä¼åçå®æºï¼ä½æ¯æ²¡å³ç³»ï¼å¦æè¯¥é¨åæ°æ®ä¸¢å¤±ï¼åè®¤ä¸ºè¯¥æ¬¡äºå¡æäº¤å¤±è´¥ï¼æ°æ®ä¼æ¢å¤å°ä¹åçç¶æã\n\n\n# redo logæä»¶ç»æ\n\nredolog æ¯ç±å¤ä¸ªåºå®å¤§å°çæä»¶ç»æçä¸ä¸ªç¯å½¢ç»æï¼å¹¶å¨è¿ä¸ªç¯å½¢ç»æä¸­ä¸æ­çåå¥ä¸è¦ççè¿ç¨ã\n\n * write posï¼è®°å½å½åçä½ç½®\n * checkpointï¼å½åè¦æ¦é¤çä½ç½®\n\nå½ææ°ç redo log åå¥æ¶ï¼ä» wirte pos ä½ç½®å¾ååï¼è check point æ¯ä¸ä¸æ¬¡å·²ç»å·å¥ç£ççæ°æ®çä½ç½®ï¼ä¹æ¯è¦ä¸æ­çå¾åæ¨è¿ï¼ç¶åå°æ°æ®å·å¥ç£çä¸­ã\n\n\n# binlog\n\næ¯å¨ mysql å±çº§è®°å½çæ¥å¿ï¼ä¸»è¦æ¯ç¨äºä¸»ä»å¤å¶åæ°æ®æ¢å¤ï¼å¯ä»¥éè¿æä¸ªæ¶é´çå¨éå¤ä»½+binlog æ¥æ¢å¤å°ä»»ææ¶é´åçç¶æã\n\nå redo log çåºå«\n\næ§è´¨   redo log                      bin log                        \nå®ç°   innodb ç¬æå®ç°                   mysql server å±çº§å®ç°ï¼ææçå¼æé½å¯ä»¥ä½¿ç¨   \nåå®¹   ç©ç log, è®°å½çæ¯âå¨æä¸ªæ°æ®é¡µä¸åäºä»ä¹ä¿®æ¹â   é»è¾ logï¼ç» id=2 è¿ä¸è¡ç c å­æ®µå  1     \nåå¥   å¾ªç¯åå¥                          è¿½å åï¼åå°ä¸å®å¤§å°åæ¢ä¸ä¸ä¸ªæä»¶ç»§ç»­å           \nåºç¨   å´©æºæ¢å¤(crash-safe)              ä¸»ä»åæ­¥ï¼æ°æ®æ¢å¤                      \n\n\n# ä¸¤é¶æ®µæäº¤\n\nä¸ºä»ä¹éè¦ä¸¤é¶æ®µæäº¤ï¼\n\næ¯ä¸ºäºè®© redo log å bin log ä¿æé»è¾ä¸è´æ§ã\n\n 1. å¦æåå redolog åå bin logãåè®¾ redo log åå®ï¼å bin log æ¶ crash äºã\n\nå ä¸º redo log åå®äºï¼æä»¥å³ä½¿ç³»ç»å´©æºï¼ä¹å¯ä»¥æ¢å¤æ°æ®ï¼ä½æ¯ bin log æ²¡åå® crash äºï¼è¿ä¸ªæ¶å bin log ä¸­å°äºè¯¥æ¡è¯­å¥ï¼å æ­¤æ°æ®å¤ä»½çæ¶åï¼å¦æä½¿ç¨äºè¯¥ä»½ bin log åä¼å°ä¸æ¬¡æ´æ°ã\n\n 2. å¦æåå bin log åå redo logãåè®¾ bin log åå®ï¼å redo log æ¶ crash äºã\n\nå ä¸º redo log æ²¡åå®ï¼æä»¥è¯¥äºå¡æ²¡æçæï¼ä½æ¯ binlog ä¸­å·²ç»æè¯¥æ¡è®°å½ï¼æä»¥ä½¿ç¨ bin log æ¶ï¼ä¼å¤åºä¸ä¸ªäºå¡ï¼ä¸åæ¥çæ°æ®ä¸ä¸è´ã\n\næä»¥ä½¿ç¨ä¸¤é¶æ®µæäº¤å¯ä»¥è§£å³ä¸é¢ä¸¤ç§åºæ¯ã\n\nä¸¤é¶æ®µæäº¤çå®ç°é»è¾\n\n 1. å¨æ´æ°æ°æ®æ¶ï¼ä¼åå¨ redo log ä¸­è®°å½å½åæ´æ°çæ°æ®ï¼å¹¶ä¸æ è®°ä¸º prepare ç¶æ\n 2. binlog åè¿è¡åå¥\n 3. äºå¡æäº¤æ¶ï¼ redo log åå°è¯¥æ¡è®°å½æ è®°ä¸º commit ç¶æå¹¶ä¸å·å¥å°ç£çä¸­ã\n\néè¿ prepare å commit ä¸¤ç§ç¶ææ¥å®æä¸¤é¶æ®µçæäº¤å®ç°ã\n\néªè¯ä¸¤é¶æ®µæäº¤\n\n 1. å¦æå¨ä¸¤é¶æ®µæäº¤çç¬¬ä¸æ­¥ååç crashï¼ä¹å°±æ¯ redo log å·²ç»æ´æ°äºæ°æ®å¹¶ä¸ä¸º prepare ç¶æï¼ä½æ¯ binlog è¿æªåå¥å°±åºç°äº crashï¼è¿ä¸ªæ¶åï¼mysql éå¯åï¼å ä¸º redo log æª commitï¼å¯ä»¥éè¿åæ»å°æ°æ®æ¢å¤ã\n 2. å¦æå¨ç¬¬äºæ­¥åç crashï¼ä¹å°±æ¯ redo log ä¸º prepare ç¶æï¼å¹¶ä¸ binlog å·²ç»åå¥ï¼ä½æ¯è¿æ¶ååºç°äº crashï¼å¨ mysql éå¯åï¼å ä¸º binlog å·²ç»æäºè®°å½ï¼æä»¥ä¼ç»§ç»­æäº¤è¯¥äºå¡ï¼å¦å bin log ä¸­æ°æ®æ°å¢äºä¸æ¡ï¼è redo log æ²¡æäº¤åå¯è½åçä¸¤èæ°æ®ä¸ä¸è´çæåµã\n\n\n# ç¸å³é¾æ¥\n\n * ä¸æ¡ sql çæ§è¡è¿ç¨è¯¦è§£\n * åºäºredo logåundo logçmysqlå´©æºæ¢å¤æµç¨",charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"mysqlä¹MVCCåç",frontmatter:{title:"mysqlä¹MVCCåç",date:"2023-01-01T20:23:21.000Z",permalink:"/pages/0d8f4a/",tags:["mysql","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"MVCC çå¨ç§°æ¯ Multi- [Version](https://so.csdn.net/so/search?q=Version&spm=1001.2101.3001.7020)Â Concurrency Controlï¼ä¹å°±æ¯å¤çæ¬å¹¶åæ§å¶ï¼è¯¥æºå¶æ¯åªææ¯æäºå¡ç InnoDB å¼æä¸æå­å¨çï¼ç¨æ¥å®ç°æé«æ°æ®åºçå¹¶åæ§è½ï¼å¯ä»¥åå°ï¼è¯»ä¸å éï¼è¯»åä¸å²çªã",feed:{enable:!0},categories:["æ°æ®åº","mysql"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210821150008.png"},{name:"twitter:title",content:"mysqlä¹MVCCåç"},{name:"twitter:description",content:"MVCC çå¨ç§°æ¯ Multi- [Version](https://so.csdn.net/so/search?q=Version&spm=1001.2101.3001.7020)Â Concurrency Controlï¼ä¹å°±æ¯å¤çæ¬å¹¶åæ§å¶ï¼è¯¥æºå¶æ¯åªææ¯æäºå¡ç InnoDB å¼æä¸æå­å¨çï¼ç¨æ¥å®ç°æé«æ°æ®åºçå¹¶åæ§è½ï¼å¯ä»¥åå°ï¼è¯»ä¸å éï¼è¯»åä¸å²çªã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210821150008.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/03.mysql/02.mysql%E4%B9%8BMVCC%E5%8E%9F%E7%90%86.html"},{property:"og:type",content:"article"},{property:"og:title",content:"mysqlä¹MVCCåç"},{property:"og:description",content:"MVCC çå¨ç§°æ¯ Multi- [Version](https://so.csdn.net/so/search?q=Version&spm=1001.2101.3001.7020)Â Concurrency Controlï¼ä¹å°±æ¯å¤çæ¬å¹¶åæ§å¶ï¼è¯¥æºå¶æ¯åªææ¯æäºå¡ç InnoDB å¼æä¸æå­å¨çï¼ç¨æ¥å®ç°æé«æ°æ®åºçå¹¶åæ§è½ï¼å¯ä»¥åå°ï¼è¯»ä¸å éï¼è¯»åä¸å²çªã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210821150008.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/03.mysql/02.mysql%E4%B9%8BMVCC%E5%8E%9F%E7%90%86.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-01-01T20:23:21.000Z"},{property:"article:tag",content:"mysql"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"mysqlä¹MVCCåç"},{itemprop:"description",content:"MVCC çå¨ç§°æ¯ Multi- [Version](https://so.csdn.net/so/search?q=Version&spm=1001.2101.3001.7020)Â Concurrency Controlï¼ä¹å°±æ¯å¤çæ¬å¹¶åæ§å¶ï¼è¯¥æºå¶æ¯åªææ¯æäºå¡ç InnoDB å¼æä¸æå­å¨çï¼ç¨æ¥å®ç°æé«æ°æ®åºçå¹¶åæ§è½ï¼å¯ä»¥åå°ï¼è¯»ä¸å éï¼è¯»åä¸å²çªã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210821150008.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/03.mysql/02.mysql%E4%B9%8BMVCC%E5%8E%9F%E7%90%86.html",relativePath:"03.ä¸­é´ä»¶/03.mysql/02.mysqlä¹MVCCåç.md",key:"v-097050d4",path:"/pages/0d8f4a/",headers:[{level:2,title:"ä»ä¹æ¯ MVCC?",slug:"ä»ä¹æ¯-mvcc",normalizedTitle:"ä»ä¹æ¯ mvcc?",charIndex:2},{level:2,title:"MVCC çå®ç°åç",slug:"mvcc-çå®ç°åç",normalizedTitle:"mvcc çå®ç°åç",charIndex:145},{level:2,title:"ReadView",slug:"readview",normalizedTitle:"readview",charIndex:373},{level:2,title:"Undo æ¥å¿",slug:"undo-æ¥å¿",normalizedTitle:"undo æ¥å¿",charIndex:824},{level:2,title:"å¿«ç§è¯»åå½åè¯»",slug:"å¿«ç§è¯»åå½åè¯»",normalizedTitle:"å¿«ç§è¯»åå½åè¯»",charIndex:1026},{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:1314}],headersStr:"ä»ä¹æ¯ MVCC? MVCC çå®ç°åç ReadView Undo æ¥å¿ å¿«ç§è¯»åå½åè¯» ç¸å³é¾æ¥",content:"# ä»ä¹æ¯ MVCC?\n\nMVCC çå¨ç§°æ¯ Multi- VersionÂ Concurrency Controlï¼ä¹å°±æ¯å¤çæ¬å¹¶åæ§å¶ï¼è¯¥æºå¶æ¯åªææ¯æäºå¡ç InnoDB å¼æä¸æå­å¨çï¼ç¨æ¥å®ç°æé«æ°æ®åºçå¹¶åæ§è½ï¼å¯ä»¥åå°ï¼è¯»ä¸å éï¼è¯»åä¸å²çªã\n\né£ä¹å®æ¯å¦ä½å®ç°çå¢ï¼\n\n\n# MVCC çå®ç°åç\n\nå¨ Innodb çæ¯ä¸è¡æ°æ®ä¸­é½ä¼ä¿å­å¤ä¸ªçæ¬ï¼æ¯ä¸ªçæ¬é½æå¯¹åºçäºå¡ IDã\n\nå¨å¼å¯æ¯ä¸ä¸ªäºå¡æ¶ï¼é½ä¼çæå½åäºå¡ççæ¬å·ï¼å½å¨è¯¥äºå¡ä¸­æä½ä¿®æ¹æ°æ®æ¶ï¼é½ä¼çæä¸ä¸ªæ°çæ°æ®è¡ï¼è¯¥æ°æ®è¡å¨æäº¤ä¹åå¯¹å¶ä»äºå¡æ¥è¯´æ¯ä¸å¯è§çï¼ç¶åå°çæ¬å·æ´æ°å°æ°æ®è¡ä¸­ï¼è¿æ ·å°±ä¿è¯äºæ¯ä¸ªäºå¡æä½çæ°æ®é½æ¯äºä¸å½±åçï¼ä¹ä¸å­å¨éçé®é¢ã\n\nå¨è¯»æä½æ¶ï¼æä»¬åªå»å¿«ç§è¯»ï¼èä¸è¯»åæ­£å¨ä¿®æ¹çæ°æ®ï¼è¿æ¯ä¸¤ä¸ªä¸åçæ¬çæ°æ®ï¼æä»¥æä½ä¸ä¸ä¼åçå²çªã\n\n\n# ReadView\n\nRead View æ¯æ¥è¡¨ç¤ºå½åäºå¡çå¯è§æ§çï¼éè¿ä¸é¢ç MVCC åçç¥éææçè¡æ°æ®é½æ¯æçæ¬çï¼é£ä¹åªäºçæ¬çæ°æ®å¨å½åäºå¡æ¯å¯è§çï¼ä¹å°±æ¯å¯è¯»å°çï¼åªäºæ¯ä¸å¯è§çã\n\nåå»º Read View æ¶ï¼ä¼æé ä¸ä¸ªæ°ç»æ¥ä¿å­å½åäºå¡å¯å¨ç¬é´å¯å¨äºä½æ¯æ²¡ææäº¤çäºå¡ IDã\n\n * å¦æå°äºæå°å¼ï¼åæ¯å·²ç»æäº¤çäºå¡ï¼æ¯å¯è§ç\n * å¦æå¤§äºæå¤§å¼ï¼åä»£è¡¨æ¯å°æ¥å¯å¨çäºå¡ï¼ä¸å¯è§\n * å¦æå¨æ°ç»åè¡¨ä¸­ï¼è¡¨ç¤ºè¿æ²¡æäº¤çäºå¡ï¼ä¸å¯è§\n * å¦æå¤§äºæå°å¼ï¼å°äºæå¤§å¼ï¼ä½ä¸å¨æ°ç»ä¸­ï¼è¡¨ç¤ºæ¯å·²ç»æäº¤äºçäºå¡ï¼å¯è§\n\nåå»º Read View çæ¶æºå¨ä¸åçéç¦»çº§å«æ¯ä¸åã\n\n * å¨è¯»æªæäº¤ä¸­ï¼ç´æ¥è¯»åçæ¯ææ°çæ¬çæ°æ®\n * å¨è¯»å·²æäº¤ä¸­ï¼å¨æ¯æ¬¡è¯»åæ°æ®åï¼å°±ä¼çæä¸ä¸ª Read Viewï¼ç¶ååè¯»åå¯è§çæ¬çæ°æ®ã\n * å¨å¯éå¤è¯»ä¸­ï¼å¨æ¯æ¬¡å¼å¯äºå¡çæ¶åï¼å°±ä¼çæ Read Viewï¼å¨æäº¤ä¹åé½ä¸ç´å¦æ­¤ä½¿ç¨ã\n * å¨ä¸²è¡åä¸­ï¼æ¯éè¿å éçæ¹å¼æ¥è®¿é®æ°æ®ã\n\n\n# Undo æ¥å¿\n\næ¯æ¡è®°å½æ´æ°æ¶ï¼é½ä¼åæ¶è®°å½ä¸æ¡åæ»æä½ãè®°å½ä¸çææ°å¼é½å¯éè¿åæ»æä½å¾å°åä¸ä¸ªç¶æå¼\n\nå¨è§å¾ AãBãC éé¢ï¼è¿ä¸ä¸ªè®°å½çå¼åå«æ¯ 1ã2ã4ï¼åä¸æ¡è®°å½å¨ç³»ç»ä¸­å¯ä»¥å­å¨å¤ä¸ªçæ¬ï¼å°±æ¯æ°æ®åºçå¤çæ¬å¹¶åæ§å¶ï¼MVCCï¼ãç³»ç»ä¼å¤æ­å¨æ²¡æäºå¡éè¦ç¨å°åæ»æ¥å¿æ¶ï¼åæ»æ¥å¿ä¼è¢«å é¤\n\nä¸å»ºè®®ä½¿ç¨é¿äºå¡çåå æ¯ï¼å¨äºå¡æäº¤ä¹åï¼åæ»æ¥å¿é½éè¦ä¿å­ï¼å¯¼è´å ç¨å¤§éå­å¨ç©ºé´ã\n\n\n\n\n# å¿«ç§è¯»åå½åè¯»\n\nå¿«ç§è¯»ï¼å°±æ¯å½è¿è¡æ¥è¯¢æ¶ï¼æ¯æ ¹æ® Read View çè§å¾å¯è§æ§æ¥è¯»åå¯¹åºçæ¬çæ°æ®ã\n\næè¿ä¹ä¸ä¸ªåºæ¯ï¼å½åæ¯å¯éå¤è¯»çéç¦»çå«ï¼å¼å§äºå¡çé¡ºåºåå«æ¯ AãBãCï¼äºå¡ C æ´æ° K ä¹åï¼ææ°ççæ¬ 102ï¼å½äºå¡ Bï¼æ ¹æ® Read View æ¯çä¸å° 102 çæ¬çæ°æ®ï¼é£ä¹å¶æ´æ°åªè½å¨ 90 çæ¬ä¸å»+1ï¼è¿æ ·çç»æè¯å®æ¯ä¸å¯¹çï¼å ä¸ºä¸æ¯å¨ææ°çç»æä¸è¿è¡+1ï¼æä»¥è¿ééè¦ç¨å° å½åè¯»ï¼ä¹å°±æ¯å»è¯»åå½åæ°æ®çææ°çæ¬çæ°æ®ï¼ç¶ååè¿è¡+1ãè¯¥å½åè¯»ä¼å¯¹è¯¥è¡æ°æ®è¿è¡å éï¼å¨è¯¥äºå¡ commit ä¹åï¼å¶ä»äºå¡é½ä¸è½å¯¹å¶è¿è¡æä½ã\n\n\n\n\n# ç¸å³é¾æ¥\n\n * https://blog.csdn.net/SIESTA030/article/details/123113437\n * https://blog.csdn.net/huaishu/article/details/89924250",normalizedContent:"# ä»ä¹æ¯ mvcc?\n\nmvcc çå¨ç§°æ¯ multi- versionÂ concurrency controlï¼ä¹å°±æ¯å¤çæ¬å¹¶åæ§å¶ï¼è¯¥æºå¶æ¯åªææ¯æäºå¡ç innodb å¼æä¸æå­å¨çï¼ç¨æ¥å®ç°æé«æ°æ®åºçå¹¶åæ§è½ï¼å¯ä»¥åå°ï¼è¯»ä¸å éï¼è¯»åä¸å²çªã\n\né£ä¹å®æ¯å¦ä½å®ç°çå¢ï¼\n\n\n# mvcc çå®ç°åç\n\nå¨ innodb çæ¯ä¸è¡æ°æ®ä¸­é½ä¼ä¿å­å¤ä¸ªçæ¬ï¼æ¯ä¸ªçæ¬é½æå¯¹åºçäºå¡ idã\n\nå¨å¼å¯æ¯ä¸ä¸ªäºå¡æ¶ï¼é½ä¼çæå½åäºå¡ççæ¬å·ï¼å½å¨è¯¥äºå¡ä¸­æä½ä¿®æ¹æ°æ®æ¶ï¼é½ä¼çæä¸ä¸ªæ°çæ°æ®è¡ï¼è¯¥æ°æ®è¡å¨æäº¤ä¹åå¯¹å¶ä»äºå¡æ¥è¯´æ¯ä¸å¯è§çï¼ç¶åå°çæ¬å·æ´æ°å°æ°æ®è¡ä¸­ï¼è¿æ ·å°±ä¿è¯äºæ¯ä¸ªäºå¡æä½çæ°æ®é½æ¯äºä¸å½±åçï¼ä¹ä¸å­å¨éçé®é¢ã\n\nå¨è¯»æä½æ¶ï¼æä»¬åªå»å¿«ç§è¯»ï¼èä¸è¯»åæ­£å¨ä¿®æ¹çæ°æ®ï¼è¿æ¯ä¸¤ä¸ªä¸åçæ¬çæ°æ®ï¼æä»¥æä½ä¸ä¸ä¼åçå²çªã\n\n\n# readview\n\nread view æ¯æ¥è¡¨ç¤ºå½åäºå¡çå¯è§æ§çï¼éè¿ä¸é¢ç mvcc åçç¥éææçè¡æ°æ®é½æ¯æçæ¬çï¼é£ä¹åªäºçæ¬çæ°æ®å¨å½åäºå¡æ¯å¯è§çï¼ä¹å°±æ¯å¯è¯»å°çï¼åªäºæ¯ä¸å¯è§çã\n\nåå»º read view æ¶ï¼ä¼æé ä¸ä¸ªæ°ç»æ¥ä¿å­å½åäºå¡å¯å¨ç¬é´å¯å¨äºä½æ¯æ²¡ææäº¤çäºå¡ idã\n\n * å¦æå°äºæå°å¼ï¼åæ¯å·²ç»æäº¤çäºå¡ï¼æ¯å¯è§ç\n * å¦æå¤§äºæå¤§å¼ï¼åä»£è¡¨æ¯å°æ¥å¯å¨çäºå¡ï¼ä¸å¯è§\n * å¦æå¨æ°ç»åè¡¨ä¸­ï¼è¡¨ç¤ºè¿æ²¡æäº¤çäºå¡ï¼ä¸å¯è§\n * å¦æå¤§äºæå°å¼ï¼å°äºæå¤§å¼ï¼ä½ä¸å¨æ°ç»ä¸­ï¼è¡¨ç¤ºæ¯å·²ç»æäº¤äºçäºå¡ï¼å¯è§\n\nåå»º read view çæ¶æºå¨ä¸åçéç¦»çº§å«æ¯ä¸åã\n\n * å¨è¯»æªæäº¤ä¸­ï¼ç´æ¥è¯»åçæ¯ææ°çæ¬çæ°æ®\n * å¨è¯»å·²æäº¤ä¸­ï¼å¨æ¯æ¬¡è¯»åæ°æ®åï¼å°±ä¼çæä¸ä¸ª read viewï¼ç¶ååè¯»åå¯è§çæ¬çæ°æ®ã\n * å¨å¯éå¤è¯»ä¸­ï¼å¨æ¯æ¬¡å¼å¯äºå¡çæ¶åï¼å°±ä¼çæ read viewï¼å¨æäº¤ä¹åé½ä¸ç´å¦æ­¤ä½¿ç¨ã\n * å¨ä¸²è¡åä¸­ï¼æ¯éè¿å éçæ¹å¼æ¥è®¿é®æ°æ®ã\n\n\n# undo æ¥å¿\n\næ¯æ¡è®°å½æ´æ°æ¶ï¼é½ä¼åæ¶è®°å½ä¸æ¡åæ»æä½ãè®°å½ä¸çææ°å¼é½å¯éè¿åæ»æä½å¾å°åä¸ä¸ªç¶æå¼\n\nå¨è§å¾ aãbãc éé¢ï¼è¿ä¸ä¸ªè®°å½çå¼åå«æ¯ 1ã2ã4ï¼åä¸æ¡è®°å½å¨ç³»ç»ä¸­å¯ä»¥å­å¨å¤ä¸ªçæ¬ï¼å°±æ¯æ°æ®åºçå¤çæ¬å¹¶åæ§å¶ï¼mvccï¼ãç³»ç»ä¼å¤æ­å¨æ²¡æäºå¡éè¦ç¨å°åæ»æ¥å¿æ¶ï¼åæ»æ¥å¿ä¼è¢«å é¤\n\nä¸å»ºè®®ä½¿ç¨é¿äºå¡çåå æ¯ï¼å¨äºå¡æäº¤ä¹åï¼åæ»æ¥å¿é½éè¦ä¿å­ï¼å¯¼è´å ç¨å¤§éå­å¨ç©ºé´ã\n\n\n\n\n# å¿«ç§è¯»åå½åè¯»\n\nå¿«ç§è¯»ï¼å°±æ¯å½è¿è¡æ¥è¯¢æ¶ï¼æ¯æ ¹æ® read view çè§å¾å¯è§æ§æ¥è¯»åå¯¹åºçæ¬çæ°æ®ã\n\næè¿ä¹ä¸ä¸ªåºæ¯ï¼å½åæ¯å¯éå¤è¯»çéç¦»çå«ï¼å¼å§äºå¡çé¡ºåºåå«æ¯ aãbãcï¼äºå¡ c æ´æ° k ä¹åï¼ææ°ççæ¬ 102ï¼å½äºå¡ bï¼æ ¹æ® read view æ¯çä¸å° 102 çæ¬çæ°æ®ï¼é£ä¹å¶æ´æ°åªè½å¨ 90 çæ¬ä¸å»+1ï¼è¿æ ·çç»æè¯å®æ¯ä¸å¯¹çï¼å ä¸ºä¸æ¯å¨ææ°çç»æä¸è¿è¡+1ï¼æä»¥è¿ééè¦ç¨å° å½åè¯»ï¼ä¹å°±æ¯å»è¯»åå½åæ°æ®çææ°çæ¬çæ°æ®ï¼ç¶ååè¿è¡+1ãè¯¥å½åè¯»ä¼å¯¹è¯¥è¡æ°æ®è¿è¡å éï¼å¨è¯¥äºå¡ commit ä¹åï¼å¶ä»äºå¡é½ä¸è½å¯¹å¶è¿è¡æä½ã\n\n\n\n\n# ç¸å³é¾æ¥\n\n * https://blog.csdn.net/siesta030/article/details/123113437\n * https://blog.csdn.net/huaishu/article/details/89924250",charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"redisä¹äºç§åºæ¬æ°æ®ç±»å",frontmatter:{title:"redisä¹äºç§åºæ¬æ°æ®ç±»å",date:"2022-12-01T15:16:14.000Z",permalink:"/pages/2bbeb3/",tags:["redis","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦è®²è§£ redis çäºç§åºæ¬æ°æ®ç±»åï¼StringãListãSetãSorted SetãHashãå­¦ä¹ å¦ä½ä½¿ç¨å®ä»¬ï¼å¹¶ä¸äºè§£å®ä»¬çåºå±æ°æ®ç»æå®ç°ï¼è¿æ ·æä»¬æè½å¨éå½çåºç¨åºæ¯éæ©æéåçæ°æ®ç±»åæ¥è§£å³æä»¬çéæ±ã",feed:{enable:!0},categories:["æ°æ®åº","redis"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210820163352.png"},{name:"twitter:title",content:"redisä¹äºç§åºæ¬æ°æ®ç±»å"},{name:"twitter:description",content:"æ¬æä¸»è¦è®²è§£ redis çäºç§åºæ¬æ°æ®ç±»åï¼StringãListãSetãSorted SetãHashãå­¦ä¹ å¦ä½ä½¿ç¨å®ä»¬ï¼å¹¶ä¸äºè§£å®ä»¬çåºå±æ°æ®ç»æå®ç°ï¼è¿æ ·æä»¬æè½å¨éå½çåºç¨åºæ¯éæ©æéåçæ°æ®ç±»åæ¥è§£å³æä»¬çéæ±ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210820163352.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/01.redis%E4%B9%8B%E4%BA%94%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.html"},{property:"og:type",content:"article"},{property:"og:title",content:"redisä¹äºç§åºæ¬æ°æ®ç±»å"},{property:"og:description",content:"æ¬æä¸»è¦è®²è§£ redis çäºç§åºæ¬æ°æ®ç±»åï¼StringãListãSetãSorted SetãHashãå­¦ä¹ å¦ä½ä½¿ç¨å®ä»¬ï¼å¹¶ä¸äºè§£å®ä»¬çåºå±æ°æ®ç»æå®ç°ï¼è¿æ ·æä»¬æè½å¨éå½çåºç¨åºæ¯éæ©æéåçæ°æ®ç±»åæ¥è§£å³æä»¬çéæ±ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210820163352.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/01.redis%E4%B9%8B%E4%BA%94%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-01T15:16:14.000Z"},{property:"article:tag",content:"redis"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"redisä¹äºç§åºæ¬æ°æ®ç±»å"},{itemprop:"description",content:"æ¬æä¸»è¦è®²è§£ redis çäºç§åºæ¬æ°æ®ç±»åï¼StringãListãSetãSorted SetãHashãå­¦ä¹ å¦ä½ä½¿ç¨å®ä»¬ï¼å¹¶ä¸äºè§£å®ä»¬çåºå±æ°æ®ç»æå®ç°ï¼è¿æ ·æä»¬æè½å¨éå½çåºç¨åºæ¯éæ©æéåçæ°æ®ç±»åæ¥è§£å³æä»¬çéæ±ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210820163352.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/01.redis%E4%B9%8B%E4%BA%94%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.html",relativePath:"03.ä¸­é´ä»¶/05.redis/01.redisä¹äºç§åºæ¬æ°æ®ç±»å.md",key:"v-2ecc148c",path:"/pages/2bbeb3/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. String",slug:"_1-string",normalizedTitle:"1. string",charIndex:127},{level:3,title:"1.1 ç®åä½¿ç¨",slug:"_1-1-ç®åä½¿ç¨",normalizedTitle:"1.1 ç®åä½¿ç¨",charIndex:141},{level:3,title:"1.2 æ°æ®ç¼ç ",slug:"_1-2-æ°æ®ç¼ç ",normalizedTitle:"1.2 æ°æ®ç¼ç ",charIndex:843},{level:3,title:"1.3 ç®åå¨æå­ç¬¦ä¸²(SDS)",slug:"_1-3-ç®åå¨æå­ç¬¦ä¸²-sds",normalizedTitle:"1.3 ç®åå¨æå­ç¬¦ä¸²(sds)",charIndex:1330},{level:3,title:"1.4 ä½¿ç¨åºæ¯",slug:"_1-4-ä½¿ç¨åºæ¯",normalizedTitle:"1.4 ä½¿ç¨åºæ¯",charIndex:2193},{level:2,title:"2. List",slug:"_2-list",normalizedTitle:"2. list",charIndex:2267},{level:3,title:"2.1 ç®åä½¿ç¨",slug:"_2-1-ç®åä½¿ç¨",normalizedTitle:"2.1 ç®åä½¿ç¨",charIndex:2279},{level:3,title:"2.2 æ°æ®ç¼ç ",slug:"_2-2-æ°æ®ç¼ç ",normalizedTitle:"2.2 æ°æ®ç¼ç ",charIndex:2884},{level:3,title:"2.3 åç¼©åè¡¨(ziplist)",slug:"_2-3-åç¼©åè¡¨-ziplist",normalizedTitle:"2.3 åç¼©åè¡¨(ziplist)",charIndex:3066},{level:3,title:"2.4 å¿«éåè¡¨(quicklist)",slug:"_2-4-å¿«éåè¡¨-quicklist",normalizedTitle:"2.4 å¿«éåè¡¨(quicklist)",charIndex:4017},{level:3,title:"2.5 ä½¿ç¨åºæ¯",slug:"_2-5-ä½¿ç¨åºæ¯",normalizedTitle:"2.5 ä½¿ç¨åºæ¯",charIndex:4241},{level:2,title:"3. Set",slug:"_3-set",normalizedTitle:"3. set",charIndex:4274},{level:3,title:"3.1 ç®åä½¿ç¨",slug:"_3-1-ç®åä½¿ç¨",normalizedTitle:"3.1 ç®åä½¿ç¨",charIndex:4319},{level:3,title:"3.2 æ°æ®ç¼ç ",slug:"_3-2-æ°æ®ç¼ç ",normalizedTitle:"3.2 æ°æ®ç¼ç ",charIndex:4685},{level:3,title:"3.3 æ´åæ°ç»(intset)",slug:"_3-3-æ´åæ°ç»-intset",normalizedTitle:"3.3 æ´åæ°ç»(intset)",charIndex:4986},{level:3,title:"3.4 ä½¿ç¨åºæ¯",slug:"_3-4-ä½¿ç¨åºæ¯",normalizedTitle:"3.4 ä½¿ç¨åºæ¯",charIndex:5534},{level:2,title:"4. Sorted Set",slug:"_4-sorted-set",normalizedTitle:"4. sorted set",charIndex:5618},{level:3,title:"4.1 ç®åä½¿ç¨",slug:"_4-1-ç®åä½¿ç¨",normalizedTitle:"4.1 ç®åä½¿ç¨",charIndex:5680},{level:3,title:"4.2 æ°æ®ç¼ç ",slug:"_4-2-æ°æ®ç¼ç ",normalizedTitle:"4.2 æ°æ®ç¼ç ",charIndex:6235},{level:3,title:"4.3 è·³è¡¨(skiplist)",slug:"_4-3-è·³è¡¨-skiplist",normalizedTitle:"4.3 è·³è¡¨(skiplist)",charIndex:6528},{level:3,title:"4.4 ä½¿ç¨åºæ¯",slug:"_4-4-ä½¿ç¨åºæ¯",normalizedTitle:"4.4 ä½¿ç¨åºæ¯",charIndex:6643},{level:2,title:"5. hash",slug:"_5-hash",normalizedTitle:"5. hash",charIndex:6684},{level:3,title:"5.1 ç®åä½¿ç¨",slug:"_5-1-ç®åä½¿ç¨",normalizedTitle:"5.1 ç®åä½¿ç¨",charIndex:6725},{level:3,title:"5.2 æ°æ®ç¼ç ",slug:"_5-2-æ°æ®ç¼ç ",normalizedTitle:"5.2 æ°æ®ç¼ç ",charIndex:7229},{level:3,title:"5.3 ä½¿ç¨åºæ¯",slug:"_5-3-ä½¿ç¨åºæ¯",normalizedTitle:"5.3 ä½¿ç¨åºæ¯",charIndex:7365},{level:2,title:"6. æ»ç»",slug:"_6-æ»ç»",normalizedTitle:"6. æ»ç»",charIndex:7391},{level:2,title:"7. ç¸å³é¾æ¥",slug:"_7-ç¸å³é¾æ¥",normalizedTitle:"7. ç¸å³é¾æ¥",charIndex:7469}],headersStr:"0. åè¨ 1. String 1.1 ç®åä½¿ç¨ 1.2 æ°æ®ç¼ç  1.3 ç®åå¨æå­ç¬¦ä¸²(SDS) 1.4 ä½¿ç¨åºæ¯ 2. List 2.1 ç®åä½¿ç¨ 2.2 æ°æ®ç¼ç  2.3 åç¼©åè¡¨(ziplist) 2.4 å¿«éåè¡¨(quicklist) 2.5 ä½¿ç¨åºæ¯ 3. Set 3.1 ç®åä½¿ç¨ 3.2 æ°æ®ç¼ç  3.3 æ´åæ°ç»(intset) 3.4 ä½¿ç¨åºæ¯ 4. Sorted Set 4.1 ç®åä½¿ç¨ 4.2 æ°æ®ç¼ç  4.3 è·³è¡¨(skiplist) 4.4 ä½¿ç¨åºæ¯ 5. hash 5.1 ç®åä½¿ç¨ 5.2 æ°æ®ç¼ç  5.3 ä½¿ç¨åºæ¯ 6. æ»ç» 7. ç¸å³é¾æ¥",content:'# 0. åè¨\n\næ¬æä¸»è¦è®²è§£ redis çäºç§åºæ¬æ°æ®ç±»åï¼StringãListãSetãSorted SetãHashãå­¦ä¹ å¦ä½ä½¿ç¨å®ä»¬ï¼å¹¶ä¸äºè§£å®ä»¬çåºå±æ°æ®ç»æå®ç°ï¼è¿æ ·æä»¬æè½å¨éå½çåºç¨åºæ¯éæ©æéåçæ°æ®ç±»åæ¥è§£å³æä»¬çéæ±ã\n\n\n# 1. String\n\n\n# 1.1 ç®åä½¿ç¨\n\nString æ¯ redis æç®åçä¸æå¸¸ç¨çæ°æ®ç±»åï¼å¯ä»¥ç¨æ¥å­å¨å­ç¬¦ä¸²ãæ´åä»¥åæµ®ç¹åã\n\n * å­ç¬¦ä¸²\n\n127.0.0.1:6379> set name zhangsan\nOK\n127.0.0.1:6379> get name\n"zhangsan"\n\n\n1\n2\n3\n4\n\n * æ´å\n\nè½ç¶ get age æ¶è¿åçæ¯å­ç¬¦ä¸²ï¼ä½æ¯å¯ä»¥éè¿ object encoding age çå°å¶çæ­£çç±»åã\n\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> get age\n"18"\n127.0.0.1:6379> object encoding age\n"int"\n\n# èªå¢\n127.0.0.1:6379> incr age\n(integer) 19\n\n# èªå\n127.0.0.1:6379> decr age\n(integer) 18\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n * æµ®ç¹å\n\nåå¥çæµ®ç¹åï¼ä½è¿æ¯éè¿å­ç¬¦ä¸²æ¥ä¿å­çï¼ä½æ¯å¨ä½¿ç¨çæ¶åï¼ä¼å°å­ç¬¦ä¸²è½¬æ¢ææµ®ç¹æ°ã\n\n127.0.0.1:6379> set height 1.77\nOK\n127.0.0.1:6379> get height\n"1.77"\n127.0.0.1:6379> object encoding height\n"embstr"\n\n# æµ®ç¹æ°æä½\n127.0.0.1:6379> incrbyfloat height 1\n"2.77"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\næ´å¤çæä½è¯·åèå®ç½\n\n\n# 1.2 æ°æ®ç¼ç \n\nString æ¯æçç¼ç ç±»åæ intãembstr å rawï¼å¨ä¸åæ¡ä»¶æ¶ï¼ä¼è½¬æ¢æå¯¹åºçç¼ç ã\n\n * int å½å­å¨çæ°æ®ä¸ºæ´åæ¶ï¼ä¼ä½¿ç¨ int ç¼ç ãå¶å®ç°æ¯ï¼ä¼ç´æ¥å°æ´åå¼å­å¨å¨ redisObject ç ptrï¼å° void* è½¬æ¢æ longï¼ ä¸­ï¼å¹¶ä¸å°å­ç¬¦ä¸²çå¯¹è±¡çç¼ç è®¾ç½®ä¸º intã\n\n * raw è¯¥ç§ç¼ç æ¯ä½¿ç¨ä¸ç§ç®åå¨æå­ç¬¦ä¸²(SDS)çæ°æ®ç»æå­å¨ï¼å½å­ç¬¦ä¸²çé¿åº¦å¤§äº 44 æ¶ï¼ä¼ä½¿ç¨è¯¥ç§æ°æ®ç¼ç æ¹å¼ã\n\n * embstr ä¹æ¯ä½¿ç¨ ç®åå¨æå­ç¬¦ä¸²(SDS)çæ°æ®ç»æå­å¨ï¼æ¯å½å­ç¬¦ä¸²é¿åº¦å°äºç­äº 44 æ¶ä½¿ç¨ã\n\nembstr å raw çåºå«æ¯ä»ä¹å¢ï¼\n\nåå»º string ä½¿ç¨ raw ç¼ç æ¶ï¼ä¼è°ç¨ä¸¤æ¬¡åå­åéæ¥åå»º redisObject å sds çæ°æ®ç»æï¼è embstr åªä¼è°ç¨ä¸æ¬¡æ¥åå»ºè¿ç»­çåå­ç©ºé´æ¥å­å¨ redisObject å sds ã\n\nå½å­ç¬¦ä¸²è¾å°æ¶ï¼embstr å°è°ç¨ä¸æ¬¡åå­åéï¼éæ¾ä¹åªéè¦ä¸æ¬¡ï¼ææ¾æ´å¿«ï¼å¹¶ä¸è¿ç»­çåå­ç©ºé´å¯ä»¥æ´å¥½çå©ç¨ cpu ç¼å­ã\n\n\n# 1.3 ç®åå¨æå­ç¬¦ä¸²(SDS)\n\nå¨æ°æ®ç¼ç ä¸­æå° embstr å raw é½æ¯ä½¿ç¨ SDS æ°æ®ç»æï¼é£ä¹è¿ç§æ°æ®ç»æçæ¯æä¹æ ·çï¼æä»ä¹å¥½å¤å¢ï¼\n\næ°æ®ç»æå¦ä¸å¾æç¤ºï¼\n\nstruct sdshdr {\n    //è®°å½bufæ°ç»ä¸­å·²ä½¿ç¨å­èçæ°éï¼ç­äºSDSæä¿å­å­ç¬¦ä¸²çé¿åº¦\n    int len;\n \n    //è®°å½buf æ°ç»ä¸­æªä½¿ç¨å­èçæ°é\n    int free;\n \n    //å­èæ°ç»ï¼ç¨äºä¿å­å­ç¬¦ä¸²\n    char buf[];\n};\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n * free: è¡¨ç¤ºè¿æå¤å°ç©ºä½ç©ºé´\n * len: å·²ä½¿ç¨å¤å°ç©ºé´\n * buf: å­å¨å­ç¬¦ä¸²çæ°ç»\n\né®é¢ï¼String ä¸ºä»ä¹ä½¿ç¨ç®åå¨æå­ç¬¦ä¸²æ¥å®ç°ï¼èä¸æ¯ä½¿ç¨ C ä¼ ç»å­ç¬¦ä¸²æ¥å®ç°å¢ï¼\n\n * é²æ­¢ç¼å­åºæº¢åº\n\nå¨æ©åå­ç¬¦ä¸²æ¶ï¼éè¦èèç¼å²åºæ¯å¦è¶³å¤ï¼SDS æä¾ API æ¥å¸®å©æä»¬å¤æ­å¹¶æ©åç©ºé´ã\n\n * å¸¸æ°è·åå­ç¬¦ä¸²é¿åº¦\n\nC ä¼ ç»å­ç¬¦ä¸²éè¦éåæè½ç¥éå·ä½çé¿åº¦ï¼æ¶é´å¤æåº¦ä¸º O(n)ï¼è SDS å¯ä»¥ç´æ¥è¯» len å±æ§è·åé¿åº¦ï¼æ¶é´å¤æåº¦ä¸º O(1)\n\n * åå°åå­åéçæ¬¡æ°\n\nå¨æ©å¤§å­ç¬¦ä¸²é¿åº¦æ¶ï¼éè¦éæ°ç³è¯·æ´å¤§çåå­ç©ºé´ï¼ç¶åæ·è´å°æ°çåå­ç©ºé´ä¸­ï¼ç¶ååéæ¾æ§çåå­ç©ºé´ã\n\nå¨ç¼©å°æ¶ä¹æ¯ä¸æ ·ï¼éè¦ç³è¯·æ°çç©ºé´ï¼åéæ¾æ§çç©ºé´ã\n\nå¨ SDS ä¸­å¯ä»¥éè¿ä»¥ä¸çæ¹å¼æ¥åå°åå­åéåéæ¾ï¼æé«æçã\n\n 1. ç©ºé´é¢åéï¼å¨åéç©ºé´æ¶ï¼é¤äºå¿è¦çç©ºé´å¤ï¼å¯ä»¥é¢å¤çåéæªä½¿ç¨çç©ºé´ï¼å¨ä¸æ¬¡ä½¿ç¨ï¼å¯ä»¥å¿«éä½¿ç¨è¿é¨åçç©ºé´ï¼èä¸å¿éæ°åéã\n 2. æ°æ§éæ¾ç©ºé´ï¼å¨ç¼©å°å­ç¬¦ä¸²æ¶ï¼ä¸éè¦é©¬ä¸éæ¾å¤ä½çç©ºé´ï¼å¯ä»¥é¢çç»ä¸æ¬¡ä½¿ç¨ã\n\n * äºè¿å¶å®å¨\n\nC è¯­è¨ä¸­æ¯ä»¥ç©ºå­ç¬¦æ¥è¡¨ç¤ºå­ç¬¦ä¸²çç»æï¼èä¸äºäºè¿å¶æä»¶åå®¹å¯è½æ¯åå«ç©ºå­ç¬¦ä¸²çï¼å æ­¤ C è¯­è¨å­ç¬¦ä¸²æ æ³æ­£ç¡®è¯»åï¼æä»¥ SDS é½æ¯ä»¥äºè¿å¶æ¹å¼å¤ç bufï¼å¹¶ä¸ä¸ä»¥ç©ºå­ç¬¦ä¸²å¤æ­æ¯å¦ç»æï¼èæ¯ç¨ len æ¥å¤æ­ã\n\n\n# 1.4 ä½¿ç¨åºæ¯\n\n * ç¼å­ï¼å­å¨ç­ç¹æ°æ®ä½ä¸ºç¼å­ï¼éä½æä¹åæ°æ®åºçè¯»åååã\n * åå¸å¼é\n * è®¡æ°å¨ï¼å¯ä»¥ä½¿ç¨ incr å½ä»¤\n\n\n# 2. List\n\n\n# 2.1 ç®åä½¿ç¨\n\nå½ä»¤       è¯´æ\nlpush    å°å¼ä»å·¦è¾¹æ¨å¥åè¡¨\nrpush    å°å¼ä»å³è¾¹æ¨å¥åè¡¨\nlpop     å°å¼ä»åè¡¨å·¦è¾¹å¼¹åºè¿å\nrpop     å°å¼ä»åè¡¨å³è¾¹å¼¹åºè¿å\nlrange   æ ¹æ®ç´¢å¼æ¥çåè¡¨ä¸­çæ°æ®\n\n127.0.0.1:6379> lpush mylist 1 2 3\n(integer) 3\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "3"\n2) "2"\n3) "1"\n\n127.0.0.1:6379> rpush mylist 4\n(integer) 4\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "3"\n2) "2"\n3) "1"\n4) "4"\n\n127.0.0.1:6379> lpop mylist\n"3"\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "2"\n2) "1"\n3) "4"\n\n127.0.0.1:6379> rpop mylist\n"4"\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "2"\n2) "1"\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# 2.2 æ°æ®ç¼ç \n\nå¨ redis3.2 ä¹åä½¿ç¨çæ¯ ziplist å linkedlist ä¸¤ç§ç¼ç æ¹å¼ãå¨æ°æ®éå°çæ¶åä½¿ç¨ ziplistï¼èæ°æ®å¤çæ¶åä½¿ç¨ linkedlistã\n\nèä¹åççæ¬ä½¿ç¨çæ¯ quicklist\n\n127.0.0.1:6379> object encoding mylist\n"quicklist"\n\n\n1\n2\n\n\n\n# 2.3 åç¼©åè¡¨(ziplist)\n\nè¯¥æ°æ®ç»æç±»ä¼¼äºä¸ä¸ªæ°ç»ï¼å¨æ°ç»çè¡¨å¤´æ·»å ä¸ä¸ªå­æ®µ zlbytesãzltailãzlenï¼åå¨è¡¨å°¾æ·»å  zlend è¡¨ç¤ºåè¡¨ç»æã\n\n\n\n * zlbytesï¼åå­å­èæ°\n * zltailï¼åè¡¨å°¾åç§»é\n * zllenï¼åè¡¨åç´ ä¸ªæ°\n * zlendï¼åè¡¨ç»ææ è®°\n\néè¿è¿å ä¸ªå­æ®µå¯ä»¥å¿«éå®ä½ç¬¬ä¸ä¸ªåç´ åæååç´ ï¼æ¶é´å¤æåº¦ä¸º O(1)ã\n\né¤äºè¡¨å¤´ä¸è¡¨å°¾ä¹å¤ï¼å¶ä»åç´ é½æ¯èç¹ï¼èç¹çæ°æ®ç»æå¦ä¸å¾ï¼\n\n\n\n * previous_entry_length : ä¸ä¸ä¸ªèç¹çé¿åº¦ãå¯ä»¥æ¨ç®åºä¸ä¸ä¸ªèç¹çå°å\n * encoding: è¯¥èç¹çæ°æ®ç±»ååé¿åº¦\n * content: èç¹çå¼\n\nè¿éæ´æ°é®é¢\n\nå¯¹äº previous_entry_lengthï¼\n\n * åä¸ä¸ªèç¹é¿åº¦å°äº 254 å­èï¼previous_entry_length é¿åº¦éè¦ç¨ 1 å­èä¿å­é¿åº¦å¼\n * åä¸ä¸ªèç¹é¿åº¦å¤§äº 254 å­èï¼previous_entry_length é¿åº¦éè¦ç¨ 5 å­èä¿å­é¿åº¦å¼\n\næè¿ä¸ç§åºæ¯ï¼å¦æåç¼©åè¡¨ä¸­æå¤ä¸ªè¿ç»­çèç¹é¿åº¦å¨ 250-253 å­èä¹é´ï¼è¿äºèç¹ previous_entry_length ä½¿ç¨ 1 ä¸ªå­èå­å¨å¤§å°ã\n\n * å½å¨æåæ¹æ·»å ä¸ä¸ªèç¹å¤§äºç­äº 254 å­èçèç¹æ¶ï¼åé¢çèç¹ previous_entry_length é½éè¦ä» 1 å­èæ©åå° 5 å­èï¼èµ·å°è¿éæ´æ°ï¼åé¢çèç¹é½éè¦æ´æ°ã\n\n\n\n * å½å é¤å¶ä¸­ small èç¹æ¶ï¼å¶åèç¹ previous_entry_length éè¦ä¿å­åé¢ç big èç¹ï¼éè¦æ©åèç¹ç©ºé´ï¼å¹¶ä¸åé¢åçè¿éæ´æ°\n\n\n\nè½ç¶è¿éæ´æ°å¤æåº¦å¾é«ï¼ä½æ¯é æçå¯è½æ§å¾ä½ã\n\n * é¿åº¦éè¦å¨ 250 å° 253 å­èä¹é´\n * è¢«æ´æ°çèç¹æ°éä¸å¤ï¼ä¹ä¸ä¼é ææ§è½å½±å\n\nä¼ç¹\n\n * åå­å°åè¿ç»­ï¼åå°äºåå­ç¢çåï¼å¯ä»¥ä½¿ç¨å°ç¼å­è¿è¡ä¼å\n * å¦ææ¯ååé¾è¡¨ï¼èç¹çå¤´å°¾é½éè¦æéæ¥æåä¸ä¸ä¸ªæèä¸ä¸ä¸ªèç¹ï¼èåç¼©åè¡¨çå»äºè¯¥é¨ååå­ç©ºé´çå ç¨ã\n\nç¼ºç¹\n\n * å¯¹äºå é¤åæå¥æä½é½éè¦ç§»å¨è¯¥èç¹ä½ç½®åé¢çåç´ ï¼å¹¶ä¸å¯è½ä¼è§¦åè¿éæ´æ°ååº\n\n\n# 2.4 å¿«éåè¡¨(quicklist)\n\nquicklist æ¯åç¼©åè¡¨åååé¾è¡¨ç»åå®ç°çï¼å¨å®è§ä¸å®æ¯ä¸ä¸ªååé¾è¡¨ï¼ç¶åå¶æ¯ä¸ªç»ç¹ä¸é½æäºä¸ä¸ª ziplistãå¦ä¸å¾æç¤ºï¼\n\nziplist å¨åè¡¨æ°éå¤§çæ¶åæ§è½ä¼ä¸éï¼å¾é¾åéä¸å¤§åè¿ç»­çåå­ç©ºé´ï¼å¹¶ä¸å¨å é¤åæå¥æä½æ§è½ä¸éçæ´ä¸ºåå®³ã\n\nèååé¾è¡¨ä¼å¯¼è´å¤§éçç¢çåç©ºé´ï¼èä¸æ¯ä¸ªèç¹çå¤´å°¾æéé½ä¼å ç¨ä¸å®çåå­ç©ºé´ã\n\nè quicklist ç®æ¯å¨ä¸¤èä¹é´åå¾äºä¸ä¸ªå¹³è¡¡ã\n\n\n# 2.5 ä½¿ç¨åºæ¯\n\n * æ¶æ¯éå\n * åè¡¨ååé¡µå±ç¤º\n\n\n# 3. Set\n\næ¯ä¸ä¸ªæ åºçéåï¼éååç´ æ¯å¯ä¸çï¼ä¼èªå¨å¯¹æ·»å çæ°æ®è¿è¡å»éã\n\n\n# 3.1 ç®åä½¿ç¨\n\nå½ä»¤          è¯´æ\nSADD        åéåæ·»å ä¸ä¸ªæå¤ä¸ªåç´ \nSCARD       è·åéåçæ°é\nSMEMBERS    è·åéåå¨é¨åç´ \nSISMEMBER   å¤æ­éåä¸­æ¯å¦æå®åç´ \n\n127.0.0.1:6379> sadd myset zheng wen feng zheng\n(integer) 3\n\n127.0.0.1:6379> scard myset\n(integer) 3\n\n127.0.0.1:6379> smembers myset\n1) "zheng"\n2) "feng"\n3) "wen"\n\n127.0.0.1:6379> sismember myset feng\n(integer) 1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# 3.2 æ°æ®ç¼ç \n\nè¯¥æ°æ®ç±»åä½¿ç¨æ°æ®ç¼ç çæ¯ intset æè hashtableï¼å½ set æ»¡è¶³ä»¥ä¸æ¡ä»¶æ¶ï¼ä½¿ç¨ç insetï¼å¶ä»æåµé½æ¯ hashtableã\n\n * å½ææçåç´ é½æ¯æ´æ°å¼æ¶\n * åç´ ä¸ªæ°ä¸è¶è¿ 512 ä¸ªæ¶\n\n127.0.0.1:6379> sadd myset2 1 2 4 4\n(integer) 3\n\n127.0.0.1:6379> SMEMBERS myset2\n1) "1"\n2) "2"\n3) "4"\n\n127.0.0.1:6379> OBJECT ENCODING myset2\n"intset"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# 3.3 æ´åæ°ç»(intset)\n\nintset æ°æ®ç»æå¦ä¸æç¤ºï¼\n\ntypedef struct intset {\n    // ç¼ç æ¹å¼\n    uint32_t encoding;\n    // éååå«çåç´ æ°é\n    uint32_t length;\n    // ä¿å­åç´ çæ°ç»\n    int8_t contents[];\n} intset;\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n * encodingï¼contents ä¸­å­å¨çæ°æ®ç±»ååå³äºè¯¥å­æ®µ\n * length: æ°ç»é¿åº¦\n * contnets: å­å¨æ°æ®çæ´åæ°ç»ï¼æ°æ®çæ°æ®ç±»ååå³äº encodingï¼ä»å°å°å¤§æåº\n\ncontents æ°ç»ä¸­æ¯ä¸ä¸ªåç´ çç±»åé½æ¯ç± encoding å³å®çï¼ä½æ¯å½åæ¥çæ°æ®ç±»åæ¯ int16 æ¶ï¼ç°å¨è¦æå¥ä¸ä¸ª int32 æ¶ï¼è¯¥å¦ä½æä½å¢ï¼\n\nåçº§\n\nè¿ä¸ªæ¶åéè¦å¯¹ contents ä¸­çæ¯ä¸ªåç´ é½è¿è¡åçº§ï¼\n\n * æ ¹æ®æ°åç´ çç±»åï¼æ©å¤§ contents æ°ç»çç©ºé´å¤§å°\n * å°æ°ç»çææåç´ è½¬æ¢ææ°åç´ ç¸åçç±»åå¹¶æ¾å¥æ°ç»ä¸­\n * æåæ¹å encoding çå¼\n\nè¿ä¹åçå¥½å¤æ¯ï¼å½ææçæ°æ®é½æ¯å°æ´åæ¶ï¼å¯ä»¥èçåå­çå¼éã\n\nç®åä¸æ¯æéçº§ã\n\n\n# 3.4 ä½¿ç¨åºæ¯\n\n * æ ç­¾ï¼ç»ç¨æ·æä¸æ ç­¾ï¼ä»¥æ ç­¾ä¸º keyï¼ç¨æ· ID ä¸º value æ¾å¥ set ä¸­\n * ç¹èµï¼æ¶èç­ï¼å©ç¨ set çå¯ä¸ç¹æ§ã\n\n\n# 4. Sorted Set\n\næ¯ä¸ä¸ªä¸åè®¸éå¤åç´ çéåï¼ä½æ¯æ¯ä¸ªåç´ ä¼å³èä¸ä¸ªåæ°ï¼å¯ä»¥éè¿åæ°å¯¹éåè¿è¡æåºã\n\n\n# 4.1 ç®åä½¿ç¨\n\nå½ä»¤       è¯´æ\nZADD     åéåæ·»å ä¸ä¸ªæå¤ä¸ªåç´ \nZRANGE   æ ¹æ®ä½ç½®æ¥è¯¢è·åéåå¤ä¸ªåç´ \nZREM     å¦æåç´ å­å¨éåä¸­ï¼åè¿è¡å é¤\n\n127.0.0.1:6379> zadd myzset 100 zheng 99 wen 80 feng\n(integer) 3\n\n127.0.0.1:6379> zrange myzset 0 -1\n1) "feng"\n2) "wen"\n3) "zheng"\n\n127.0.0.1:6379> zadd myzset 91 hello\n(integer) 1\n\n# é»è®¤æ¯æ ¹æ®scoreååºæ¥è¯¢\n127.0.0.1:6379> zrange myzset 0 -1\n1) "feng"\n2) "hello"\n3) "wen"\n4) "zheng"\n\n127.0.0.1:6379> zrem myzset wen\n(integer) 1\n\n127.0.0.1:6379> zrange myzset 0 -1\n1) "feng"\n2) "hello"\n3) "zheng"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\n\n# 4.2 æ°æ®ç¼ç \n\nè¯¥ç±»åçæ°æ®ç¼ç å¯ä»¥ä¸º ziplist æè skiplistï¼å½æ»¡è¶³ä»¥ä¸æ¡ä»¶æ¶ï¼ä½¿ç¨ç ziplistï¼å¶ä»æåµæ¯ skiplist\n\n * åç´ æ°éå°äº 128\n * æç´¢åç´ é¿åº¦å°äº 64\n\nå½æ°æ®ç¼ç ä¸º skiplist æ¶ï¼redis ä¸­ä½¿ç¨çå­å¨ç»ææ¯ zset æ°æ®ç»æï¼å¶ä¸­åå«äº zskiplist å dict\n\ntypedef struct zset {\n    zskiplist *zs1;\n    dict *dict;\n}\n\n\n1\n2\n3\n4\n\n\néè¿ zskiplist å¯ä»¥å¿«éçèå´æ¥è¯¢ï¼dict å¯ä»¥å¿«éå®ä½åä¸ªåç´ ã\n\n\n# 4.3 è·³è¡¨(skiplist)\n\nå¨æåºçé¾è¡¨ä¸æ·»å äºå¤çº§ç´¢å¼ï¼éè¿ç´¢å¼ä½ç½®çè·³è½¬ï¼å®ç°æ°æ®çå¿«éå®ä½ãå¦ä¸å¾æç¤ºï¼\n\nä¼ç¹ï¼\n\n 1. å¨éè¿èå´æ¥è¯¢ææåºæ¶ï¼å¯ä»¥å¨è·³è¡¨ä¸­åæ¾å°æå°å¼ï¼ç¶ååå¨æåºå±é¾è¡¨ä¸­éåè·åã\n\n\n# 4.4 ä½¿ç¨åºæ¯\n\n * æè¡æ¦ï¼éè¿ç»è§é¢ãæç« æåï¼ç¶åè¿è¡æåºå±ç¤º\n\n\n# 5. hash\n\nç¨äºå­å¨ string ç±»åçé®å¼å¯¹ï¼éç¨äºå­å¨å¯¹è±¡ã\n\n\n# 5.1 ç®åä½¿ç¨\n\nå½ä»¤        è¯´æ\nhset      è®¾ç½®é®å¼å¯¹\nhget      è·åæå® hash çé®å¯¹åºçå¼\nhgetall   è·åæå® hash ä¸­çææé®å¼å¯¹\nhdel      å é¤æå® hash ä¸­çé®å¼å¯¹\n\n127.0.0.1:6379> hset person name zhangsan\n(integer) 1\n\n127.0.0.1:6379> hset person age 18\n(integer) 1\n\n127.0.0.1:6379> hget persion name\n"zhangsan"\n\n127.0.0.1:6379> hgetall person\n1) "name"\n2) "zhangsan"\n3) "age"\n4) "18"\n\n127.0.0.1:6379> hdel person age\n(integer) 1\n\n127.0.0.1:6379> hgetall person\n1) "name"\n2) "zhangsan"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\n\n# 5.2 æ°æ®ç¼ç \n\nä½¿ç¨çæ°æ®ç¼ç æ¯ ziplist æ hashtableï¼æ»¡è¶³ä»¥ä¸æ¡ä»¶éæ©ä½¿ç¨ ziplistï¼å¶ä»æåµä½¿ç¨ hashtable\n\n * hash å¯¹è±¡ä¿å­çé®åå¼å­ç¬¦ä¸²é¿åº¦é½å°äº 64 å­è\n * hash å¯¹è±¡ä¿å­çé®å¼å¯¹æ°éå°äº 512\n\n\n# 5.3 ä½¿ç¨åºæ¯\n\n * ç¨æ¥å­å¨å¯¹è±¡ä¿¡æ¯\n\n\n# 6. æ»ç»\n\nredis ä¹æä»¥å¿«ï¼æ­£æ¯å ä¸ºå¶æçä¸°å¯çæ°æ®ç»æï¼æä»¥æä»¬éè¦çè§£å®ä»¬ï¼å¨è®¾è®¡æ¹æ¡æ¶ï¼å°±è½æ­£ç¡®çéæ©æ°æ®ç±»åæ¥å®ç°æä»¬çä¸å¡éæ±ã\n\n\n# 7. ç¸å³é¾æ¥\n\n * Redis è®¾è®¡ä¸å®ç°\n * å¾è§£ redis äºç§æ°æ®ç»æåºå±å®ç°\n * Redis è®¾è®¡ä¸å®ç°\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥',normalizedContent:'# 0. åè¨\n\næ¬æä¸»è¦è®²è§£ redis çäºç§åºæ¬æ°æ®ç±»åï¼stringãlistãsetãsorted setãhashãå­¦ä¹ å¦ä½ä½¿ç¨å®ä»¬ï¼å¹¶ä¸äºè§£å®ä»¬çåºå±æ°æ®ç»æå®ç°ï¼è¿æ ·æä»¬æè½å¨éå½çåºç¨åºæ¯éæ©æéåçæ°æ®ç±»åæ¥è§£å³æä»¬çéæ±ã\n\n\n# 1. string\n\n\n# 1.1 ç®åä½¿ç¨\n\nstring æ¯ redis æç®åçä¸æå¸¸ç¨çæ°æ®ç±»åï¼å¯ä»¥ç¨æ¥å­å¨å­ç¬¦ä¸²ãæ´åä»¥åæµ®ç¹åã\n\n * å­ç¬¦ä¸²\n\n127.0.0.1:6379> set name zhangsan\nok\n127.0.0.1:6379> get name\n"zhangsan"\n\n\n1\n2\n3\n4\n\n * æ´å\n\nè½ç¶ get age æ¶è¿åçæ¯å­ç¬¦ä¸²ï¼ä½æ¯å¯ä»¥éè¿ object encoding age çå°å¶çæ­£çç±»åã\n\n127.0.0.1:6379> set age 18\nok\n127.0.0.1:6379> get age\n"18"\n127.0.0.1:6379> object encoding age\n"int"\n\n# èªå¢\n127.0.0.1:6379> incr age\n(integer) 19\n\n# èªå\n127.0.0.1:6379> decr age\n(integer) 18\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n * æµ®ç¹å\n\nåå¥çæµ®ç¹åï¼ä½è¿æ¯éè¿å­ç¬¦ä¸²æ¥ä¿å­çï¼ä½æ¯å¨ä½¿ç¨çæ¶åï¼ä¼å°å­ç¬¦ä¸²è½¬æ¢ææµ®ç¹æ°ã\n\n127.0.0.1:6379> set height 1.77\nok\n127.0.0.1:6379> get height\n"1.77"\n127.0.0.1:6379> object encoding height\n"embstr"\n\n# æµ®ç¹æ°æä½\n127.0.0.1:6379> incrbyfloat height 1\n"2.77"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\næ´å¤çæä½è¯·åèå®ç½\n\n\n# 1.2 æ°æ®ç¼ç \n\nstring æ¯æçç¼ç ç±»åæ intãembstr å rawï¼å¨ä¸åæ¡ä»¶æ¶ï¼ä¼è½¬æ¢æå¯¹åºçç¼ç ã\n\n * int å½å­å¨çæ°æ®ä¸ºæ´åæ¶ï¼ä¼ä½¿ç¨ int ç¼ç ãå¶å®ç°æ¯ï¼ä¼ç´æ¥å°æ´åå¼å­å¨å¨ redisobject ç ptrï¼å° void* è½¬æ¢æ longï¼ ä¸­ï¼å¹¶ä¸å°å­ç¬¦ä¸²çå¯¹è±¡çç¼ç è®¾ç½®ä¸º intã\n\n * raw è¯¥ç§ç¼ç æ¯ä½¿ç¨ä¸ç§ç®åå¨æå­ç¬¦ä¸²(sds)çæ°æ®ç»æå­å¨ï¼å½å­ç¬¦ä¸²çé¿åº¦å¤§äº 44 æ¶ï¼ä¼ä½¿ç¨è¯¥ç§æ°æ®ç¼ç æ¹å¼ã\n\n * embstr ä¹æ¯ä½¿ç¨ ç®åå¨æå­ç¬¦ä¸²(sds)çæ°æ®ç»æå­å¨ï¼æ¯å½å­ç¬¦ä¸²é¿åº¦å°äºç­äº 44 æ¶ä½¿ç¨ã\n\nembstr å raw çåºå«æ¯ä»ä¹å¢ï¼\n\nåå»º string ä½¿ç¨ raw ç¼ç æ¶ï¼ä¼è°ç¨ä¸¤æ¬¡åå­åéæ¥åå»º redisobject å sds çæ°æ®ç»æï¼è embstr åªä¼è°ç¨ä¸æ¬¡æ¥åå»ºè¿ç»­çåå­ç©ºé´æ¥å­å¨ redisobject å sds ã\n\nå½å­ç¬¦ä¸²è¾å°æ¶ï¼embstr å°è°ç¨ä¸æ¬¡åå­åéï¼éæ¾ä¹åªéè¦ä¸æ¬¡ï¼ææ¾æ´å¿«ï¼å¹¶ä¸è¿ç»­çåå­ç©ºé´å¯ä»¥æ´å¥½çå©ç¨ cpu ç¼å­ã\n\n\n# 1.3 ç®åå¨æå­ç¬¦ä¸²(sds)\n\nå¨æ°æ®ç¼ç ä¸­æå° embstr å raw é½æ¯ä½¿ç¨ sds æ°æ®ç»æï¼é£ä¹è¿ç§æ°æ®ç»æçæ¯æä¹æ ·çï¼æä»ä¹å¥½å¤å¢ï¼\n\næ°æ®ç»æå¦ä¸å¾æç¤ºï¼\n\nstruct sdshdr {\n    //è®°å½bufæ°ç»ä¸­å·²ä½¿ç¨å­èçæ°éï¼ç­äºsdsæä¿å­å­ç¬¦ä¸²çé¿åº¦\n    int len;\n \n    //è®°å½buf æ°ç»ä¸­æªä½¿ç¨å­èçæ°é\n    int free;\n \n    //å­èæ°ç»ï¼ç¨äºä¿å­å­ç¬¦ä¸²\n    char buf[];\n};\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n * free: è¡¨ç¤ºè¿æå¤å°ç©ºä½ç©ºé´\n * len: å·²ä½¿ç¨å¤å°ç©ºé´\n * buf: å­å¨å­ç¬¦ä¸²çæ°ç»\n\né®é¢ï¼string ä¸ºä»ä¹ä½¿ç¨ç®åå¨æå­ç¬¦ä¸²æ¥å®ç°ï¼èä¸æ¯ä½¿ç¨ c ä¼ ç»å­ç¬¦ä¸²æ¥å®ç°å¢ï¼\n\n * é²æ­¢ç¼å­åºæº¢åº\n\nå¨æ©åå­ç¬¦ä¸²æ¶ï¼éè¦èèç¼å²åºæ¯å¦è¶³å¤ï¼sds æä¾ api æ¥å¸®å©æä»¬å¤æ­å¹¶æ©åç©ºé´ã\n\n * å¸¸æ°è·åå­ç¬¦ä¸²é¿åº¦\n\nc ä¼ ç»å­ç¬¦ä¸²éè¦éåæè½ç¥éå·ä½çé¿åº¦ï¼æ¶é´å¤æåº¦ä¸º o(n)ï¼è sds å¯ä»¥ç´æ¥è¯» len å±æ§è·åé¿åº¦ï¼æ¶é´å¤æåº¦ä¸º o(1)\n\n * åå°åå­åéçæ¬¡æ°\n\nå¨æ©å¤§å­ç¬¦ä¸²é¿åº¦æ¶ï¼éè¦éæ°ç³è¯·æ´å¤§çåå­ç©ºé´ï¼ç¶åæ·è´å°æ°çåå­ç©ºé´ä¸­ï¼ç¶ååéæ¾æ§çåå­ç©ºé´ã\n\nå¨ç¼©å°æ¶ä¹æ¯ä¸æ ·ï¼éè¦ç³è¯·æ°çç©ºé´ï¼åéæ¾æ§çç©ºé´ã\n\nå¨ sds ä¸­å¯ä»¥éè¿ä»¥ä¸çæ¹å¼æ¥åå°åå­åéåéæ¾ï¼æé«æçã\n\n 1. ç©ºé´é¢åéï¼å¨åéç©ºé´æ¶ï¼é¤äºå¿è¦çç©ºé´å¤ï¼å¯ä»¥é¢å¤çåéæªä½¿ç¨çç©ºé´ï¼å¨ä¸æ¬¡ä½¿ç¨ï¼å¯ä»¥å¿«éä½¿ç¨è¿é¨åçç©ºé´ï¼èä¸å¿éæ°åéã\n 2. æ°æ§éæ¾ç©ºé´ï¼å¨ç¼©å°å­ç¬¦ä¸²æ¶ï¼ä¸éè¦é©¬ä¸éæ¾å¤ä½çç©ºé´ï¼å¯ä»¥é¢çç»ä¸æ¬¡ä½¿ç¨ã\n\n * äºè¿å¶å®å¨\n\nc è¯­è¨ä¸­æ¯ä»¥ç©ºå­ç¬¦æ¥è¡¨ç¤ºå­ç¬¦ä¸²çç»æï¼èä¸äºäºè¿å¶æä»¶åå®¹å¯è½æ¯åå«ç©ºå­ç¬¦ä¸²çï¼å æ­¤ c è¯­è¨å­ç¬¦ä¸²æ æ³æ­£ç¡®è¯»åï¼æä»¥ sds é½æ¯ä»¥äºè¿å¶æ¹å¼å¤ç bufï¼å¹¶ä¸ä¸ä»¥ç©ºå­ç¬¦ä¸²å¤æ­æ¯å¦ç»æï¼èæ¯ç¨ len æ¥å¤æ­ã\n\n\n# 1.4 ä½¿ç¨åºæ¯\n\n * ç¼å­ï¼å­å¨ç­ç¹æ°æ®ä½ä¸ºç¼å­ï¼éä½æä¹åæ°æ®åºçè¯»åååã\n * åå¸å¼é\n * è®¡æ°å¨ï¼å¯ä»¥ä½¿ç¨ incr å½ä»¤\n\n\n# 2. list\n\n\n# 2.1 ç®åä½¿ç¨\n\nå½ä»¤       è¯´æ\nlpush    å°å¼ä»å·¦è¾¹æ¨å¥åè¡¨\nrpush    å°å¼ä»å³è¾¹æ¨å¥åè¡¨\nlpop     å°å¼ä»åè¡¨å·¦è¾¹å¼¹åºè¿å\nrpop     å°å¼ä»åè¡¨å³è¾¹å¼¹åºè¿å\nlrange   æ ¹æ®ç´¢å¼æ¥çåè¡¨ä¸­çæ°æ®\n\n127.0.0.1:6379> lpush mylist 1 2 3\n(integer) 3\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "3"\n2) "2"\n3) "1"\n\n127.0.0.1:6379> rpush mylist 4\n(integer) 4\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "3"\n2) "2"\n3) "1"\n4) "4"\n\n127.0.0.1:6379> lpop mylist\n"3"\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "2"\n2) "1"\n3) "4"\n\n127.0.0.1:6379> rpop mylist\n"4"\n\n127.0.0.1:6379> lrange mylist 0 -1\n1) "2"\n2) "1"\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# 2.2 æ°æ®ç¼ç \n\nå¨ redis3.2 ä¹åä½¿ç¨çæ¯ ziplist å linkedlist ä¸¤ç§ç¼ç æ¹å¼ãå¨æ°æ®éå°çæ¶åä½¿ç¨ ziplistï¼èæ°æ®å¤çæ¶åä½¿ç¨ linkedlistã\n\nèä¹åççæ¬ä½¿ç¨çæ¯ quicklist\n\n127.0.0.1:6379> object encoding mylist\n"quicklist"\n\n\n1\n2\n\n\n\n# 2.3 åç¼©åè¡¨(ziplist)\n\nè¯¥æ°æ®ç»æç±»ä¼¼äºä¸ä¸ªæ°ç»ï¼å¨æ°ç»çè¡¨å¤´æ·»å ä¸ä¸ªå­æ®µ zlbytesãzltailãzlenï¼åå¨è¡¨å°¾æ·»å  zlend è¡¨ç¤ºåè¡¨ç»æã\n\n\n\n * zlbytesï¼åå­å­èæ°\n * zltailï¼åè¡¨å°¾åç§»é\n * zllenï¼åè¡¨åç´ ä¸ªæ°\n * zlendï¼åè¡¨ç»ææ è®°\n\néè¿è¿å ä¸ªå­æ®µå¯ä»¥å¿«éå®ä½ç¬¬ä¸ä¸ªåç´ åæååç´ ï¼æ¶é´å¤æåº¦ä¸º o(1)ã\n\né¤äºè¡¨å¤´ä¸è¡¨å°¾ä¹å¤ï¼å¶ä»åç´ é½æ¯èç¹ï¼èç¹çæ°æ®ç»æå¦ä¸å¾ï¼\n\n\n\n * previous_entry_length : ä¸ä¸ä¸ªèç¹çé¿åº¦ãå¯ä»¥æ¨ç®åºä¸ä¸ä¸ªèç¹çå°å\n * encoding: è¯¥èç¹çæ°æ®ç±»ååé¿åº¦\n * content: èç¹çå¼\n\nè¿éæ´æ°é®é¢\n\nå¯¹äº previous_entry_lengthï¼\n\n * åä¸ä¸ªèç¹é¿åº¦å°äº 254 å­èï¼previous_entry_length é¿åº¦éè¦ç¨ 1 å­èä¿å­é¿åº¦å¼\n * åä¸ä¸ªèç¹é¿åº¦å¤§äº 254 å­èï¼previous_entry_length é¿åº¦éè¦ç¨ 5 å­èä¿å­é¿åº¦å¼\n\næè¿ä¸ç§åºæ¯ï¼å¦æåç¼©åè¡¨ä¸­æå¤ä¸ªè¿ç»­çèç¹é¿åº¦å¨ 250-253 å­èä¹é´ï¼è¿äºèç¹ previous_entry_length ä½¿ç¨ 1 ä¸ªå­èå­å¨å¤§å°ã\n\n * å½å¨æåæ¹æ·»å ä¸ä¸ªèç¹å¤§äºç­äº 254 å­èçèç¹æ¶ï¼åé¢çèç¹ previous_entry_length é½éè¦ä» 1 å­èæ©åå° 5 å­èï¼èµ·å°è¿éæ´æ°ï¼åé¢çèç¹é½éè¦æ´æ°ã\n\n\n\n * å½å é¤å¶ä¸­ small èç¹æ¶ï¼å¶åèç¹ previous_entry_length éè¦ä¿å­åé¢ç big èç¹ï¼éè¦æ©åèç¹ç©ºé´ï¼å¹¶ä¸åé¢åçè¿éæ´æ°\n\n\n\nè½ç¶è¿éæ´æ°å¤æåº¦å¾é«ï¼ä½æ¯é æçå¯è½æ§å¾ä½ã\n\n * é¿åº¦éè¦å¨ 250 å° 253 å­èä¹é´\n * è¢«æ´æ°çèç¹æ°éä¸å¤ï¼ä¹ä¸ä¼é ææ§è½å½±å\n\nä¼ç¹\n\n * åå­å°åè¿ç»­ï¼åå°äºåå­ç¢çåï¼å¯ä»¥ä½¿ç¨å°ç¼å­è¿è¡ä¼å\n * å¦ææ¯ååé¾è¡¨ï¼èç¹çå¤´å°¾é½éè¦æéæ¥æåä¸ä¸ä¸ªæèä¸ä¸ä¸ªèç¹ï¼èåç¼©åè¡¨çå»äºè¯¥é¨ååå­ç©ºé´çå ç¨ã\n\nç¼ºç¹\n\n * å¯¹äºå é¤åæå¥æä½é½éè¦ç§»å¨è¯¥èç¹ä½ç½®åé¢çåç´ ï¼å¹¶ä¸å¯è½ä¼è§¦åè¿éæ´æ°ååº\n\n\n# 2.4 å¿«éåè¡¨(quicklist)\n\nquicklist æ¯åç¼©åè¡¨åååé¾è¡¨ç»åå®ç°çï¼å¨å®è§ä¸å®æ¯ä¸ä¸ªååé¾è¡¨ï¼ç¶åå¶æ¯ä¸ªç»ç¹ä¸é½æäºä¸ä¸ª ziplistãå¦ä¸å¾æç¤ºï¼\n\nziplist å¨åè¡¨æ°éå¤§çæ¶åæ§è½ä¼ä¸éï¼å¾é¾åéä¸å¤§åè¿ç»­çåå­ç©ºé´ï¼å¹¶ä¸å¨å é¤åæå¥æä½æ§è½ä¸éçæ´ä¸ºåå®³ã\n\nèååé¾è¡¨ä¼å¯¼è´å¤§éçç¢çåç©ºé´ï¼èä¸æ¯ä¸ªèç¹çå¤´å°¾æéé½ä¼å ç¨ä¸å®çåå­ç©ºé´ã\n\nè quicklist ç®æ¯å¨ä¸¤èä¹é´åå¾äºä¸ä¸ªå¹³è¡¡ã\n\n\n# 2.5 ä½¿ç¨åºæ¯\n\n * æ¶æ¯éå\n * åè¡¨ååé¡µå±ç¤º\n\n\n# 3. set\n\næ¯ä¸ä¸ªæ åºçéåï¼éååç´ æ¯å¯ä¸çï¼ä¼èªå¨å¯¹æ·»å çæ°æ®è¿è¡å»éã\n\n\n# 3.1 ç®åä½¿ç¨\n\nå½ä»¤          è¯´æ\nsadd        åéåæ·»å ä¸ä¸ªæå¤ä¸ªåç´ \nscard       è·åéåçæ°é\nsmembers    è·åéåå¨é¨åç´ \nsismember   å¤æ­éåä¸­æ¯å¦æå®åç´ \n\n127.0.0.1:6379> sadd myset zheng wen feng zheng\n(integer) 3\n\n127.0.0.1:6379> scard myset\n(integer) 3\n\n127.0.0.1:6379> smembers myset\n1) "zheng"\n2) "feng"\n3) "wen"\n\n127.0.0.1:6379> sismember myset feng\n(integer) 1\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# 3.2 æ°æ®ç¼ç \n\nè¯¥æ°æ®ç±»åä½¿ç¨æ°æ®ç¼ç çæ¯ intset æè hashtableï¼å½ set æ»¡è¶³ä»¥ä¸æ¡ä»¶æ¶ï¼ä½¿ç¨ç insetï¼å¶ä»æåµé½æ¯ hashtableã\n\n * å½ææçåç´ é½æ¯æ´æ°å¼æ¶\n * åç´ ä¸ªæ°ä¸è¶è¿ 512 ä¸ªæ¶\n\n127.0.0.1:6379> sadd myset2 1 2 4 4\n(integer) 3\n\n127.0.0.1:6379> smembers myset2\n1) "1"\n2) "2"\n3) "4"\n\n127.0.0.1:6379> object encoding myset2\n"intset"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# 3.3 æ´åæ°ç»(intset)\n\nintset æ°æ®ç»æå¦ä¸æç¤ºï¼\n\ntypedef struct intset {\n    // ç¼ç æ¹å¼\n    uint32_t encoding;\n    // éååå«çåç´ æ°é\n    uint32_t length;\n    // ä¿å­åç´ çæ°ç»\n    int8_t contents[];\n} intset;\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n * encodingï¼contents ä¸­å­å¨çæ°æ®ç±»ååå³äºè¯¥å­æ®µ\n * length: æ°ç»é¿åº¦\n * contnets: å­å¨æ°æ®çæ´åæ°ç»ï¼æ°æ®çæ°æ®ç±»ååå³äº encodingï¼ä»å°å°å¤§æåº\n\ncontents æ°ç»ä¸­æ¯ä¸ä¸ªåç´ çç±»åé½æ¯ç± encoding å³å®çï¼ä½æ¯å½åæ¥çæ°æ®ç±»åæ¯ int16 æ¶ï¼ç°å¨è¦æå¥ä¸ä¸ª int32 æ¶ï¼è¯¥å¦ä½æä½å¢ï¼\n\nåçº§\n\nè¿ä¸ªæ¶åéè¦å¯¹ contents ä¸­çæ¯ä¸ªåç´ é½è¿è¡åçº§ï¼\n\n * æ ¹æ®æ°åç´ çç±»åï¼æ©å¤§ contents æ°ç»çç©ºé´å¤§å°\n * å°æ°ç»çææåç´ è½¬æ¢ææ°åç´ ç¸åçç±»åå¹¶æ¾å¥æ°ç»ä¸­\n * æåæ¹å encoding çå¼\n\nè¿ä¹åçå¥½å¤æ¯ï¼å½ææçæ°æ®é½æ¯å°æ´åæ¶ï¼å¯ä»¥èçåå­çå¼éã\n\nç®åä¸æ¯æéçº§ã\n\n\n# 3.4 ä½¿ç¨åºæ¯\n\n * æ ç­¾ï¼ç»ç¨æ·æä¸æ ç­¾ï¼ä»¥æ ç­¾ä¸º keyï¼ç¨æ· id ä¸º value æ¾å¥ set ä¸­\n * ç¹èµï¼æ¶èç­ï¼å©ç¨ set çå¯ä¸ç¹æ§ã\n\n\n# 4. sorted set\n\næ¯ä¸ä¸ªä¸åè®¸éå¤åç´ çéåï¼ä½æ¯æ¯ä¸ªåç´ ä¼å³èä¸ä¸ªåæ°ï¼å¯ä»¥éè¿åæ°å¯¹éåè¿è¡æåºã\n\n\n# 4.1 ç®åä½¿ç¨\n\nå½ä»¤       è¯´æ\nzadd     åéåæ·»å ä¸ä¸ªæå¤ä¸ªåç´ \nzrange   æ ¹æ®ä½ç½®æ¥è¯¢è·åéåå¤ä¸ªåç´ \nzrem     å¦æåç´ å­å¨éåä¸­ï¼åè¿è¡å é¤\n\n127.0.0.1:6379> zadd myzset 100 zheng 99 wen 80 feng\n(integer) 3\n\n127.0.0.1:6379> zrange myzset 0 -1\n1) "feng"\n2) "wen"\n3) "zheng"\n\n127.0.0.1:6379> zadd myzset 91 hello\n(integer) 1\n\n# é»è®¤æ¯æ ¹æ®scoreååºæ¥è¯¢\n127.0.0.1:6379> zrange myzset 0 -1\n1) "feng"\n2) "hello"\n3) "wen"\n4) "zheng"\n\n127.0.0.1:6379> zrem myzset wen\n(integer) 1\n\n127.0.0.1:6379> zrange myzset 0 -1\n1) "feng"\n2) "hello"\n3) "zheng"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\n\n# 4.2 æ°æ®ç¼ç \n\nè¯¥ç±»åçæ°æ®ç¼ç å¯ä»¥ä¸º ziplist æè skiplistï¼å½æ»¡è¶³ä»¥ä¸æ¡ä»¶æ¶ï¼ä½¿ç¨ç ziplistï¼å¶ä»æåµæ¯ skiplist\n\n * åç´ æ°éå°äº 128\n * æç´¢åç´ é¿åº¦å°äº 64\n\nå½æ°æ®ç¼ç ä¸º skiplist æ¶ï¼redis ä¸­ä½¿ç¨çå­å¨ç»ææ¯ zset æ°æ®ç»æï¼å¶ä¸­åå«äº zskiplist å dict\n\ntypedef struct zset {\n    zskiplist *zs1;\n    dict *dict;\n}\n\n\n1\n2\n3\n4\n\n\néè¿ zskiplist å¯ä»¥å¿«éçèå´æ¥è¯¢ï¼dict å¯ä»¥å¿«éå®ä½åä¸ªåç´ ã\n\n\n# 4.3 è·³è¡¨(skiplist)\n\nå¨æåºçé¾è¡¨ä¸æ·»å äºå¤çº§ç´¢å¼ï¼éè¿ç´¢å¼ä½ç½®çè·³è½¬ï¼å®ç°æ°æ®çå¿«éå®ä½ãå¦ä¸å¾æç¤ºï¼\n\nä¼ç¹ï¼\n\n 1. å¨éè¿èå´æ¥è¯¢ææåºæ¶ï¼å¯ä»¥å¨è·³è¡¨ä¸­åæ¾å°æå°å¼ï¼ç¶ååå¨æåºå±é¾è¡¨ä¸­éåè·åã\n\n\n# 4.4 ä½¿ç¨åºæ¯\n\n * æè¡æ¦ï¼éè¿ç»è§é¢ãæç« æåï¼ç¶åè¿è¡æåºå±ç¤º\n\n\n# 5. hash\n\nç¨äºå­å¨ string ç±»åçé®å¼å¯¹ï¼éç¨äºå­å¨å¯¹è±¡ã\n\n\n# 5.1 ç®åä½¿ç¨\n\nå½ä»¤        è¯´æ\nhset      è®¾ç½®é®å¼å¯¹\nhget      è·åæå® hash çé®å¯¹åºçå¼\nhgetall   è·åæå® hash ä¸­çææé®å¼å¯¹\nhdel      å é¤æå® hash ä¸­çé®å¼å¯¹\n\n127.0.0.1:6379> hset person name zhangsan\n(integer) 1\n\n127.0.0.1:6379> hset person age 18\n(integer) 1\n\n127.0.0.1:6379> hget persion name\n"zhangsan"\n\n127.0.0.1:6379> hgetall person\n1) "name"\n2) "zhangsan"\n3) "age"\n4) "18"\n\n127.0.0.1:6379> hdel person age\n(integer) 1\n\n127.0.0.1:6379> hgetall person\n1) "name"\n2) "zhangsan"\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\n\n# 5.2 æ°æ®ç¼ç \n\nä½¿ç¨çæ°æ®ç¼ç æ¯ ziplist æ hashtableï¼æ»¡è¶³ä»¥ä¸æ¡ä»¶éæ©ä½¿ç¨ ziplistï¼å¶ä»æåµä½¿ç¨ hashtable\n\n * hash å¯¹è±¡ä¿å­çé®åå¼å­ç¬¦ä¸²é¿åº¦é½å°äº 64 å­è\n * hash å¯¹è±¡ä¿å­çé®å¼å¯¹æ°éå°äº 512\n\n\n# 5.3 ä½¿ç¨åºæ¯\n\n * ç¨æ¥å­å¨å¯¹è±¡ä¿¡æ¯\n\n\n# 6. æ»ç»\n\nredis ä¹æä»¥å¿«ï¼æ­£æ¯å ä¸ºå¶æçä¸°å¯çæ°æ®ç»æï¼æä»¥æä»¬éè¦çè§£å®ä»¬ï¼å¨è®¾è®¡æ¹æ¡æ¶ï¼å°±è½æ­£ç¡®çéæ©æ°æ®ç±»åæ¥å®ç°æä»¬çä¸å¡éæ±ã\n\n\n# 7. ç¸å³é¾æ¥\n\n * redis è®¾è®¡ä¸å®ç°\n * å¾è§£ redis äºç§æ°æ®ç»æåºå±å®ç°\n * redis è®¾è®¡ä¸å®ç°\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥',charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"redisä¹æä¹å",frontmatter:{title:"redisä¹æä¹å",date:"2022-12-01T15:18:02.000Z",permalink:"/pages/4c6b13/",tags:["redis","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦æ¯ä»ç» redis æ¯å¦ä½è¿è¡æä¹åæ°æ®çï¼æä»¬ç¥é redis æ¯åºäºåå­çæ°æ®åºï¼é£ä¹åªè¦æå¡å¨ä¸æ¦å®æºï¼é£ä¹æ°æ®åå°å¨é¨ä¸¢å¤±ï¼å¦æä»åç«¯æ°æ®åºè¿è¡æ¢å¤ï¼åå¯è½å¯¼è´æ§è½åæ¢ï¼é£ä¹ redis éè¦èªèº«æä¹åï¼èä¸éè¿åç«¯æ°æ®åºæ¥æ¢å¤æ°æ®æ¯éè¦çã",feed:{enable:!0},categories:["æ°æ®åº","redis"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210805185829.png"},{name:"twitter:title",content:"redisä¹æä¹å"},{name:"twitter:description",content:"æ¬æä¸»è¦æ¯ä»ç» redis æ¯å¦ä½è¿è¡æä¹åæ°æ®çï¼æä»¬ç¥é redis æ¯åºäºåå­çæ°æ®åºï¼é£ä¹åªè¦æå¡å¨ä¸æ¦å®æºï¼é£ä¹æ°æ®åå°å¨é¨ä¸¢å¤±ï¼å¦æä»åç«¯æ°æ®åºè¿è¡æ¢å¤ï¼åå¯è½å¯¼è´æ§è½åæ¢ï¼é£ä¹ redis éè¦èªèº«æä¹åï¼èä¸éè¿åç«¯æ°æ®åºæ¥æ¢å¤æ°æ®æ¯éè¦çã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210805185829.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/02.redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96.html"},{property:"og:type",content:"article"},{property:"og:title",content:"redisä¹æä¹å"},{property:"og:description",content:"æ¬æä¸»è¦æ¯ä»ç» redis æ¯å¦ä½è¿è¡æä¹åæ°æ®çï¼æä»¬ç¥é redis æ¯åºäºåå­çæ°æ®åºï¼é£ä¹åªè¦æå¡å¨ä¸æ¦å®æºï¼é£ä¹æ°æ®åå°å¨é¨ä¸¢å¤±ï¼å¦æä»åç«¯æ°æ®åºè¿è¡æ¢å¤ï¼åå¯è½å¯¼è´æ§è½åæ¢ï¼é£ä¹ redis éè¦èªèº«æä¹åï¼èä¸éè¿åç«¯æ°æ®åºæ¥æ¢å¤æ°æ®æ¯éè¦çã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210805185829.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/02.redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-01T15:18:02.000Z"},{property:"article:tag",content:"redis"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"redisä¹æä¹å"},{itemprop:"description",content:"æ¬æä¸»è¦æ¯ä»ç» redis æ¯å¦ä½è¿è¡æä¹åæ°æ®çï¼æä»¬ç¥é redis æ¯åºäºåå­çæ°æ®åºï¼é£ä¹åªè¦æå¡å¨ä¸æ¦å®æºï¼é£ä¹æ°æ®åå°å¨é¨ä¸¢å¤±ï¼å¦æä»åç«¯æ°æ®åºè¿è¡æ¢å¤ï¼åå¯è½å¯¼è´æ§è½åæ¢ï¼é£ä¹ redis éè¦èªèº«æä¹åï¼èä¸éè¿åç«¯æ°æ®åºæ¥æ¢å¤æ°æ®æ¯éè¦çã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210805185829.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/02.redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96.html",relativePath:"03.ä¸­é´ä»¶/05.redis/02.redisä¹æä¹å.md",key:"v-278df89e",path:"/pages/4c6b13/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. AOF",slug:"_1-aof",normalizedTitle:"1. aof",charIndex:143},{level:3,title:"1.1 ä¸ºä»ä¹æ¯ AOF ?",slug:"_1-1-ä¸ºä»ä¹æ¯-aof",normalizedTitle:"1.1 ä¸ºä»ä¹æ¯ aof ?",charIndex:204},{level:3,title:"1.2 AOF éåæºå¶",slug:"_1-2-aof-éåæºå¶",normalizedTitle:"1.2 aof éåæºå¶",charIndex:461},{level:2,title:"2. RDB åå­å¿«ç§",slug:"_2-rdb-åå­å¿«ç§",normalizedTitle:"2. rdb åå­å¿«ç§",charIndex:1331},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:2178},{level:2,title:"4. åèæç« ",slug:"_4-åèæç« ",normalizedTitle:"4. åèæç« ",charIndex:2449}],headersStr:"0. åè¨ 1. AOF 1.1 ä¸ºä»ä¹æ¯ AOF ? 1.2 AOF éåæºå¶ 2. RDB åå­å¿«ç§ 3. æ»ç» 4. åèæç« ",content:"# 0. åè¨\n\næ¬æä¸»è¦æ¯ä»ç» redis æ¯å¦ä½è¿è¡æä¹åæ°æ®çï¼æä»¬ç¥é redis æ¯åºäºåå­çæ°æ®åºï¼é£ä¹åªè¦æå¡å¨ä¸æ¦å®æºï¼é£ä¹æ°æ®åå°å¨é¨ä¸¢å¤±ï¼å¦æä»åç«¯æ°æ®åºè¿è¡æ¢å¤ï¼åå¯è½å¯¼è´æ§è½åæ¢ï¼é£ä¹ redis éè¦èªèº«æä¹åï¼èä¸éè¿åç«¯æ°æ®åºæ¥æ¢å¤æ°æ®æ¯éè¦çã\n\n\n# 1. AOF\n\nAOFï¼ç§°ä¸ºååæ¥å¿ï¼å°±æ¯åæ§è¡å½ä»¤ï¼ææ°æ®åå¥å°æ°æ®åºä¸­ä¹åï¼åè¿è¡è®°å½æ¥å¿ãè¿ç¨å¦ä¸å¾æç¤ºï¼\n\n\n# 1.1 ä¸ºä»ä¹æ¯ AOF ?\n\nRedis å AOF åæ¥å¿æ¶ï¼å¹¶ä¸ä¼æ ¡éªå½ä»¤çè¯­æ³ï¼å¦æåè®°æ¥å¿ï¼åå¯è½ä¿å­äºéè¯¯çå½ä»¤å¯¼è´åºéãæä»¥è®©ç³»ç»åæ§è¡å½ä»¤ï¼æ§è¡æåååè®°å½æ¥å¿ã\n\nååæ¥å¿ä¹ä¸ä¼é»å¡å½åæä½ï¼ä½æ¯ä¸ä¸æ¬¡æä½æé»å¡é£é©ãAOF ä¹æ¯å¨ä¸»çº¿ç¨æ§è¡ï¼å¦æåå¥çæ¶åç£çååè¿å¤§ï¼å°±å¯è½ä¼å¤§è´é»å¡ã\n\nä½è¯¥ç§æ¹å¼æé£é©ï¼å¦æåå¥åå­æåï¼è®°æ¥å¿æ¶åçå®æºï¼åä¼ä¸¢å¤±æ¥å¿ã\n\næ­£å ä¸ºæè¿ä¸ªé£é©ï¼æä»¥ redis æä¾ä¸ç§åå¥ç­ç¥ï¼\n\nè¿ä¸ç§ç­ç¥å°±æ¯æ§è½ä¸å¯é æ§çæè¡¡ï¼å¯ä»¥æ ¹æ®å·ä½çä¸å¡è¿è¡éæ©ã\n\n\n# 1.2 AOF éåæºå¶\n\nAOF è®°å½çæ¯ Redis çæ¯ä¸æ¡å½ä»¤ï¼ä»¥ææ¬å½¢å¼ä¿å­ï¼é£ä¹å½ AOF æ¥å¿åçè¶æ¥è¶å¤çæ¶åï¼AOF æä»¶è¶æ¥è¶å¤§ï¼ä»¥åéè¿ AOF æ¢å¤æ°æ®ä¹ä¼åå¾å¾æ¢ï¼redis æä¾äº AOF éåæºå¶æ¥åå° AOF æ¥å¿æä»¶ã\n\nå° AOF æä»¶çæçææ°æ°æ®çæææ°çæä½æ¥å¿å¹¶è®°å½å°æ°ç AOF æä»¶ä¸­ï¼è¿æ ·æ°ç AOF æä»¶ä¸­å°±æ²¡æäºåä½å½ä»¤ï¼åæ¿æ¢ææ§ç AOF æä»¶ã\n\nAOF éåè¿ç¨\n\nAOF éåçè¿ç¨ä¼ fork åº bgrewriteof åå°å­è¿ç¨ï¼fork ä¼å°ä¸»çº¿ç¨çæ°æ®åå­æ·è´å°å­è¿ç¨ï¼å­è¿ç¨å¨ä¸å½±åä¸»çº¿ç¨çæåµä¸å°æ·è´çæ°æ®è½¬æ¢ææä½åå¥å°éåæ¥å¿ä¸­ã\n\nå¨éåæ¥å¿æ¶ï¼ä¸»çº¿ç¨ä»»ç¶æ¥åæ°çæä½ï¼æä½ä¼è®°å½å° AOF ç¼å²å AOF éåç¼å²åºï¼AOF æ¥å¿ä¸ä¼ä¸¢å¤±ææ°çæä½ï¼å¨æ·è´æ°æ®éåå®æåï¼åå° AOF éåç¼å²åºçæ¥å¿è®°å½åå¥æ°ç AOF æä»¶ä¸­ï¼ä¿è¯æ°ç AOF æä»¶çæ°æ®ä¹æ¯ææ°çç¶æãæ­¤æ¶å°±å¯ä»¥æ¾å¿å°æ°åå¥ç AOF æä»¶ä»£æ¿æ§æä»¶ã\n\n\n\nåæ¶å¤å¶ copy on write\n\nfork éç¨æä½ç³»ç»ç åæ¶å¤å¶æºå¶ï¼é¿åä¸æ¬¡æ§æ·è´å¤§éåå­æ°æ®ç»å­è¿ç¨ãfork å­è¿ç¨æ¶ï¼å­è¿ç¨ä¼æ·è´ç¶è¿ç¨çåå­é¡µè¡¨(èæåå­åç©çåå­çæ å°ç´¢å¼è¡¨)èä¸ä¼æ·è´å¶ææçç©çåå­æ°æ®ï¼è¿æ ·ä¸¤ä¸ªè¿ç¨ä½¿ç¨çæ°æ®æ¯åä¸ä»½åå­ç©ºé´ãå½ä¸»çº¿ç¨åå¥æ°æ°æ®æ¶ï¼ä¼æ·è´ä¸ä»½æ°æ°æ®å¹¶è¿è¡ä¿®æ¹ï¼è¿æ ·å¹¶ä¸å½±åå­è¿ç¨çè¯»åã\n\nAOF éåé»å¡ç¹\n\n * å¨ fork å­è¿ç¨æ¶ï¼å³ä½¿æ¯æ·è´é¡µè¡¨åä¸äºå¿è¦çæ°æ®ç»æä¹æ¯éè¦æ¶èå¤§éç CPUï¼ä¼å¯¹ä¸»çº¿ç¨è¿è¡é»å¡\n * å¨ AOF éåè¿ç¨ä¸­ï¼å¦ææ big key åå¥æ¶ï¼ä¼æ·è´æ§æ°æ®å°åå»ºçæ°åå­ç©ºé´ä¸­ï¼ä¹ä¼è¿è¡é»å¡ã\n\nAOF éåæ¥å¿ä¸ºä»ä¹ä¸å±äº« AOF æ¬èº«æ¥å¿ï¼\n\n * ä¸¤ä¸ªè¿ç¨æä½åä¸ä¸ªæä»¶ï¼å­å¨ç«äºé®é¢ï¼å½±åç¶è¿ç¨æ§è½\n * å¦æéåå¤±è´¥ï¼AOF æ¥å¿åè¢«æ±¡æäºï¼æ æ³æ¢å¤ä½¿ç¨ãéåä¸ä¸ªæä»¶ï¼å¦æéåå¤±è´¥ï¼å é¤éæ¥å³å¯ã\n\n\n# 2. RDB åå­å¿«ç§\n\nAOF æ¹æ³æ¢å¤æ°æ®éè¦å°æä½æ¥å¿å¨é¨æ§è¡ä¸éï¼å¦ææ¥å¿éå¸¸å¤ï¼åæ¢å¤çè¿ç¨ç¼æ¢ãèåå­å¿«ç§æ¯å°æä¸æ¶å»çæ°æ®ä»¥æä»¶(RDB)è®°å½å°ç£çä¸ï¼å¨æ¢å¤çæ¶åï¼ç´æ¥è¯»å¥åå­å³å¯ã\n\nä¼ä¸ä¼é»å¡ä¸»çº¿ç¨?\n\nRedis æä¾ save å bgsave ä¸¤ä¸ªå½ä»¤çæ RDB æä»¶\n\n * save æ¯å¨ä¸»çº¿ç¨æ§è¡ä¼é»å¡ï¼ä¸å»ºè®®å¨çº¿ä¸ä½¿ç¨\n * bgsave ä¼åå»ºå­è¿ç¨çæ RDBï¼é»è®¤ã\n\nå¦æå¨è§¦åå¿«ç§æ¶ï¼è½ä¿®æ¹æ°æ®åï¼\n\nå¦æå¨ t æ¶å»ï¼éè¦å¿«ç§æ°æ® Aï¼å¨å¿«ç§æ¶ä¿®æ¹äº A æ°æ®ä¸º A'ï¼è¿æ¶ç ´åäºå¿«ç§çå®æ´æ§ï¼è¿æ¶ A'å¹¶ä¸æ¯ t æ¶å»çç¶æã\n\nå¦æå¨å¿«ç§æ¶ï¼ä¸åè®¸ä¿®æ¹ï¼è½ç¶è§£å³äºä¸é¢çé®é¢ï¼ä½æ¯ä¼å½±åä¸å¡ã\n\nè¿éè§£å³åæ³è¿æ¯ä½¿ç¨äºæä½ç³»ç»ç åæ¶å¤å¶æºå¶ï¼å¨æ°çæ°æ®éè¦åå¥æ¶ï¼ä¸»çº¿ç¨ä¼å°è¯¥æ°æ®å¤å¶ä¸ä»½ï¼ç¶åå¯¹è¯¥å¯æ¬è¿è¡ä¿®æ¹ï¼èå­è¿ç¨ä½¿ç¨åæ¥çæ°æ®è¿è¡å¿«ç§ã\n\n\n\næ¢ç¶å¯ä»¥ä½¿ç¨ RDB å¿«éæ¢å¤æ°æ®ï¼é£ä¹æ¯å¦å¯ä»¥æ¯ç§åä¸æ¬¡å¿«ç§å¢ï¼\n\nä¸¤æ¬¡å¿«ç§ä¹é´çæ°æ®ï¼å¦æéå°å®æºï¼å¯è½ä¼åçä¸¢å¤±ï¼æä»¥éè¦å°½éç­çæ¶é´åå¿«ç§ã\n\nä½è½ç¶çæ RDB æä»¶ä½¿ç¨å­è¿ç¨ï¼ä½æ¯é¢ç¹çæ§è¡å¨éå¿«ç§è¿æ¯ä¼å¸¦æ¥é¢å¤çå¼éï¼\n\n * é¢ç¹çåç£çï¼å¢å¤§ç£çåå\n * fork å­è¿ç¨æ¶ï¼å¦ææ°æ®åå­è¿å¤§ï¼æ¯ä¼é»å¡ä¸»çº¿ç¨çã\n\nå¦ä½è§£å³å¿«ç§é´ä¸¢å¤±æ°æ®ï¼\n\nå¢éå¿«ç§ãæ··åä½¿ç¨ AOF æ¥å¿ååå­å¿«ç§ã\n\nä½¿ç¨ AOF è®°å½ä¸¤æ¬¡å¿«ç§é´çæä½ãå¨çæå¿«ç§æ¶ï¼ä½¿ç¨ AOF æ¥å¿è®°å½æ°è¿å¥çä¿®æ¹æä½ï¼å¨ä¸ä¸æ¬¡å¿«ç§åå®æºé½å¯ä»¥éè¿ AOF æ¥å¿è¿è¡æ¢å¤ãä¸ä¸æ¬¡å¿«ç§æ¶å¯ä»¥åæ¸ç©º AOF æ¥å¿éæ°è®°å½\n\n\n\nå¦ä½å¨ AOF å RDB è¿è¡éæ©?\n\n * æ°æ®ä¸è½ä¸¢å¤±æ¶ï¼åå­å¿«ç§å AOF çæ··åä½¿ç¨æ¯ä¸ä¸ªå¾å¥½çéæ©ï¼\n * å¦æåè®¸åéçº§å«çæ°æ®ä¸¢å¤±ï¼å¯ä»¥åªä½¿ç¨ RDBï¼\n * å¦æåªç¨ AOFï¼ä¼åä½¿ç¨ everysec çéç½®éé¡¹ï¼å ä¸ºå®å¨å¯é æ§åæ§è½ä¹é´åäºä¸ä¸ªå¹³è¡¡ã\n\n\n# 3. æ»ç»\n\néè¿ä¸é¢çä»ç»ï¼äºè§£å° RDB å AOF é½æ¯éè¿ fork å­è¿ç¨æ¥å®æçï¼æ¯ä¸ºäºä¸ä¼é æä¸»çº¿ç¨çé»å¡ï¼ä½æ¯ä¹å¹¶ä¸è½å®å¨é¿åï¼æä»¥æä»¬éè¦å°½å¯è½çéä½ fork çé¢çã\n\nå¹¶ä¸é½ä½¿ç¨äºæä½ç³»ç»ç COW æºå¶ï¼è¯¥æºå¶å¯ä»¥å¤§å¤§çåå° cpu ä¸åå­çæ¶èï¼æä»¬å¨å¾å¤ç»ä»¶ä¸­ä¼åç°å®ä»¬é½ç¨å°äº linux çä¸äºå¥½ç¨çæºå¶ï¼å Kafka ç¨å°çé¶æ·è´å PageCache ç­ç­ãæä»¬å¨è®¾è®¡ä¸­éè¦åç¨è¿äºæºå¶ï¼å¯ä»¥éå¸¸å¤§çä¼åç¨åºçæ§è½ï¼å¹¶ä¸ç®åæä»¬éè¦åçæ¶åäº¤ç»æä½ç³»ç»å»å®æï¼å¹¶ä¸å®æçæ¯æä»¬åçæ´å¥½æ´ç¨³å®ã\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",normalizedContent:"# 0. åè¨\n\næ¬æä¸»è¦æ¯ä»ç» redis æ¯å¦ä½è¿è¡æä¹åæ°æ®çï¼æä»¬ç¥é redis æ¯åºäºåå­çæ°æ®åºï¼é£ä¹åªè¦æå¡å¨ä¸æ¦å®æºï¼é£ä¹æ°æ®åå°å¨é¨ä¸¢å¤±ï¼å¦æä»åç«¯æ°æ®åºè¿è¡æ¢å¤ï¼åå¯è½å¯¼è´æ§è½åæ¢ï¼é£ä¹ redis éè¦èªèº«æä¹åï¼èä¸éè¿åç«¯æ°æ®åºæ¥æ¢å¤æ°æ®æ¯éè¦çã\n\n\n# 1. aof\n\naofï¼ç§°ä¸ºååæ¥å¿ï¼å°±æ¯åæ§è¡å½ä»¤ï¼ææ°æ®åå¥å°æ°æ®åºä¸­ä¹åï¼åè¿è¡è®°å½æ¥å¿ãè¿ç¨å¦ä¸å¾æç¤ºï¼\n\n\n# 1.1 ä¸ºä»ä¹æ¯ aof ?\n\nredis å aof åæ¥å¿æ¶ï¼å¹¶ä¸ä¼æ ¡éªå½ä»¤çè¯­æ³ï¼å¦æåè®°æ¥å¿ï¼åå¯è½ä¿å­äºéè¯¯çå½ä»¤å¯¼è´åºéãæä»¥è®©ç³»ç»åæ§è¡å½ä»¤ï¼æ§è¡æåååè®°å½æ¥å¿ã\n\nååæ¥å¿ä¹ä¸ä¼é»å¡å½åæä½ï¼ä½æ¯ä¸ä¸æ¬¡æä½æé»å¡é£é©ãaof ä¹æ¯å¨ä¸»çº¿ç¨æ§è¡ï¼å¦æåå¥çæ¶åç£çååè¿å¤§ï¼å°±å¯è½ä¼å¤§è´é»å¡ã\n\nä½è¯¥ç§æ¹å¼æé£é©ï¼å¦æåå¥åå­æåï¼è®°æ¥å¿æ¶åçå®æºï¼åä¼ä¸¢å¤±æ¥å¿ã\n\næ­£å ä¸ºæè¿ä¸ªé£é©ï¼æä»¥ redis æä¾ä¸ç§åå¥ç­ç¥ï¼\n\nè¿ä¸ç§ç­ç¥å°±æ¯æ§è½ä¸å¯é æ§çæè¡¡ï¼å¯ä»¥æ ¹æ®å·ä½çä¸å¡è¿è¡éæ©ã\n\n\n# 1.2 aof éåæºå¶\n\naof è®°å½çæ¯ redis çæ¯ä¸æ¡å½ä»¤ï¼ä»¥ææ¬å½¢å¼ä¿å­ï¼é£ä¹å½ aof æ¥å¿åçè¶æ¥è¶å¤çæ¶åï¼aof æä»¶è¶æ¥è¶å¤§ï¼ä»¥åéè¿ aof æ¢å¤æ°æ®ä¹ä¼åå¾å¾æ¢ï¼redis æä¾äº aof éåæºå¶æ¥åå° aof æ¥å¿æä»¶ã\n\nå° aof æä»¶çæçææ°æ°æ®çæææ°çæä½æ¥å¿å¹¶è®°å½å°æ°ç aof æä»¶ä¸­ï¼è¿æ ·æ°ç aof æä»¶ä¸­å°±æ²¡æäºåä½å½ä»¤ï¼åæ¿æ¢ææ§ç aof æä»¶ã\n\naof éåè¿ç¨\n\naof éåçè¿ç¨ä¼ fork åº bgrewriteof åå°å­è¿ç¨ï¼fork ä¼å°ä¸»çº¿ç¨çæ°æ®åå­æ·è´å°å­è¿ç¨ï¼å­è¿ç¨å¨ä¸å½±åä¸»çº¿ç¨çæåµä¸å°æ·è´çæ°æ®è½¬æ¢ææä½åå¥å°éåæ¥å¿ä¸­ã\n\nå¨éåæ¥å¿æ¶ï¼ä¸»çº¿ç¨ä»»ç¶æ¥åæ°çæä½ï¼æä½ä¼è®°å½å° aof ç¼å²å aof éåç¼å²åºï¼aof æ¥å¿ä¸ä¼ä¸¢å¤±ææ°çæä½ï¼å¨æ·è´æ°æ®éåå®æåï¼åå° aof éåç¼å²åºçæ¥å¿è®°å½åå¥æ°ç aof æä»¶ä¸­ï¼ä¿è¯æ°ç aof æä»¶çæ°æ®ä¹æ¯ææ°çç¶æãæ­¤æ¶å°±å¯ä»¥æ¾å¿å°æ°åå¥ç aof æä»¶ä»£æ¿æ§æä»¶ã\n\n\n\nåæ¶å¤å¶ copy on write\n\nfork éç¨æä½ç³»ç»ç åæ¶å¤å¶æºå¶ï¼é¿åä¸æ¬¡æ§æ·è´å¤§éåå­æ°æ®ç»å­è¿ç¨ãfork å­è¿ç¨æ¶ï¼å­è¿ç¨ä¼æ·è´ç¶è¿ç¨çåå­é¡µè¡¨(èæåå­åç©çåå­çæ å°ç´¢å¼è¡¨)èä¸ä¼æ·è´å¶ææçç©çåå­æ°æ®ï¼è¿æ ·ä¸¤ä¸ªè¿ç¨ä½¿ç¨çæ°æ®æ¯åä¸ä»½åå­ç©ºé´ãå½ä¸»çº¿ç¨åå¥æ°æ°æ®æ¶ï¼ä¼æ·è´ä¸ä»½æ°æ°æ®å¹¶è¿è¡ä¿®æ¹ï¼è¿æ ·å¹¶ä¸å½±åå­è¿ç¨çè¯»åã\n\naof éåé»å¡ç¹\n\n * å¨ fork å­è¿ç¨æ¶ï¼å³ä½¿æ¯æ·è´é¡µè¡¨åä¸äºå¿è¦çæ°æ®ç»æä¹æ¯éè¦æ¶èå¤§éç cpuï¼ä¼å¯¹ä¸»çº¿ç¨è¿è¡é»å¡\n * å¨ aof éåè¿ç¨ä¸­ï¼å¦ææ big key åå¥æ¶ï¼ä¼æ·è´æ§æ°æ®å°åå»ºçæ°åå­ç©ºé´ä¸­ï¼ä¹ä¼è¿è¡é»å¡ã\n\naof éåæ¥å¿ä¸ºä»ä¹ä¸å±äº« aof æ¬èº«æ¥å¿ï¼\n\n * ä¸¤ä¸ªè¿ç¨æä½åä¸ä¸ªæä»¶ï¼å­å¨ç«äºé®é¢ï¼å½±åç¶è¿ç¨æ§è½\n * å¦æéåå¤±è´¥ï¼aof æ¥å¿åè¢«æ±¡æäºï¼æ æ³æ¢å¤ä½¿ç¨ãéåä¸ä¸ªæä»¶ï¼å¦æéåå¤±è´¥ï¼å é¤éæ¥å³å¯ã\n\n\n# 2. rdb åå­å¿«ç§\n\naof æ¹æ³æ¢å¤æ°æ®éè¦å°æä½æ¥å¿å¨é¨æ§è¡ä¸éï¼å¦ææ¥å¿éå¸¸å¤ï¼åæ¢å¤çè¿ç¨ç¼æ¢ãèåå­å¿«ç§æ¯å°æä¸æ¶å»çæ°æ®ä»¥æä»¶(rdb)è®°å½å°ç£çä¸ï¼å¨æ¢å¤çæ¶åï¼ç´æ¥è¯»å¥åå­å³å¯ã\n\nä¼ä¸ä¼é»å¡ä¸»çº¿ç¨?\n\nredis æä¾ save å bgsave ä¸¤ä¸ªå½ä»¤çæ rdb æä»¶\n\n * save æ¯å¨ä¸»çº¿ç¨æ§è¡ä¼é»å¡ï¼ä¸å»ºè®®å¨çº¿ä¸ä½¿ç¨\n * bgsave ä¼åå»ºå­è¿ç¨çæ rdbï¼é»è®¤ã\n\nå¦æå¨è§¦åå¿«ç§æ¶ï¼è½ä¿®æ¹æ°æ®åï¼\n\nå¦æå¨ t æ¶å»ï¼éè¦å¿«ç§æ°æ® aï¼å¨å¿«ç§æ¶ä¿®æ¹äº a æ°æ®ä¸º a'ï¼è¿æ¶ç ´åäºå¿«ç§çå®æ´æ§ï¼è¿æ¶ a'å¹¶ä¸æ¯ t æ¶å»çç¶æã\n\nå¦æå¨å¿«ç§æ¶ï¼ä¸åè®¸ä¿®æ¹ï¼è½ç¶è§£å³äºä¸é¢çé®é¢ï¼ä½æ¯ä¼å½±åä¸å¡ã\n\nè¿éè§£å³åæ³è¿æ¯ä½¿ç¨äºæä½ç³»ç»ç åæ¶å¤å¶æºå¶ï¼å¨æ°çæ°æ®éè¦åå¥æ¶ï¼ä¸»çº¿ç¨ä¼å°è¯¥æ°æ®å¤å¶ä¸ä»½ï¼ç¶åå¯¹è¯¥å¯æ¬è¿è¡ä¿®æ¹ï¼èå­è¿ç¨ä½¿ç¨åæ¥çæ°æ®è¿è¡å¿«ç§ã\n\n\n\næ¢ç¶å¯ä»¥ä½¿ç¨ rdb å¿«éæ¢å¤æ°æ®ï¼é£ä¹æ¯å¦å¯ä»¥æ¯ç§åä¸æ¬¡å¿«ç§å¢ï¼\n\nä¸¤æ¬¡å¿«ç§ä¹é´çæ°æ®ï¼å¦æéå°å®æºï¼å¯è½ä¼åçä¸¢å¤±ï¼æä»¥éè¦å°½éç­çæ¶é´åå¿«ç§ã\n\nä½è½ç¶çæ rdb æä»¶ä½¿ç¨å­è¿ç¨ï¼ä½æ¯é¢ç¹çæ§è¡å¨éå¿«ç§è¿æ¯ä¼å¸¦æ¥é¢å¤çå¼éï¼\n\n * é¢ç¹çåç£çï¼å¢å¤§ç£çåå\n * fork å­è¿ç¨æ¶ï¼å¦ææ°æ®åå­è¿å¤§ï¼æ¯ä¼é»å¡ä¸»çº¿ç¨çã\n\nå¦ä½è§£å³å¿«ç§é´ä¸¢å¤±æ°æ®ï¼\n\nå¢éå¿«ç§ãæ··åä½¿ç¨ aof æ¥å¿ååå­å¿«ç§ã\n\nä½¿ç¨ aof è®°å½ä¸¤æ¬¡å¿«ç§é´çæä½ãå¨çæå¿«ç§æ¶ï¼ä½¿ç¨ aof æ¥å¿è®°å½æ°è¿å¥çä¿®æ¹æä½ï¼å¨ä¸ä¸æ¬¡å¿«ç§åå®æºé½å¯ä»¥éè¿ aof æ¥å¿è¿è¡æ¢å¤ãä¸ä¸æ¬¡å¿«ç§æ¶å¯ä»¥åæ¸ç©º aof æ¥å¿éæ°è®°å½\n\n\n\nå¦ä½å¨ aof å rdb è¿è¡éæ©?\n\n * æ°æ®ä¸è½ä¸¢å¤±æ¶ï¼åå­å¿«ç§å aof çæ··åä½¿ç¨æ¯ä¸ä¸ªå¾å¥½çéæ©ï¼\n * å¦æåè®¸åéçº§å«çæ°æ®ä¸¢å¤±ï¼å¯ä»¥åªä½¿ç¨ rdbï¼\n * å¦æåªç¨ aofï¼ä¼åä½¿ç¨ everysec çéç½®éé¡¹ï¼å ä¸ºå®å¨å¯é æ§åæ§è½ä¹é´åäºä¸ä¸ªå¹³è¡¡ã\n\n\n# 3. æ»ç»\n\néè¿ä¸é¢çä»ç»ï¼äºè§£å° rdb å aof é½æ¯éè¿ fork å­è¿ç¨æ¥å®æçï¼æ¯ä¸ºäºä¸ä¼é æä¸»çº¿ç¨çé»å¡ï¼ä½æ¯ä¹å¹¶ä¸è½å®å¨é¿åï¼æä»¥æä»¬éè¦å°½å¯è½çéä½ fork çé¢çã\n\nå¹¶ä¸é½ä½¿ç¨äºæä½ç³»ç»ç cow æºå¶ï¼è¯¥æºå¶å¯ä»¥å¤§å¤§çåå° cpu ä¸åå­çæ¶èï¼æä»¬å¨å¾å¤ç»ä»¶ä¸­ä¼åç°å®ä»¬é½ç¨å°äº linux çä¸äºå¥½ç¨çæºå¶ï¼å kafka ç¨å°çé¶æ·è´å pagecache ç­ç­ãæä»¬å¨è®¾è®¡ä¸­éè¦åç¨è¿äºæºå¶ï¼å¯ä»¥éå¸¸å¤§çä¼åç¨åºçæ§è½ï¼å¹¶ä¸ç®åæä»¬éè¦åçæ¶åäº¤ç»æä½ç³»ç»å»å®æï¼å¹¶ä¸å®æçæ¯æä»¬åçæ´å¥½æ´ç¨³å®ã\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"redisä¹ä¸»ä»åºåæ­¥",frontmatter:{title:"redisä¹ä¸»ä»åºåæ­¥",date:"2022-12-01T15:18:20.000Z",permalink:"/pages/8072eb/",tags:["redis","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨åç¹æéåï¼æä»¬éè¦ä¿è¯æå¡ä¸é´æ­ï¼æä»¥éè¦ä½¿ç¨åä½çå¯æ¬æä¾éç¾¤æå¡ï¼ä»èè¾¾å°æå¡çé«å¯ç¨ãredis æä¾äºä¸»ä»åºæ°æ®åæ­¥æºå¶ï¼ä»èä¿è¯æ°æ®å¯æ¬çä¸è´æ§ï¼èä¸»ä»åºä½¿ç¨çæ¯è¯»ååç¦»çæºå¶ã",feed:{enable:!0},categories:["æ°æ®åº","redis"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210806172905.png"},{name:"twitter:title",content:"redisä¹ä¸»ä»åºåæ­¥"},{name:"twitter:description",content:"å¨åç¹æéåï¼æä»¬éè¦ä¿è¯æå¡ä¸é´æ­ï¼æä»¥éè¦ä½¿ç¨åä½çå¯æ¬æä¾éç¾¤æå¡ï¼ä»èè¾¾å°æå¡çé«å¯ç¨ãredis æä¾äºä¸»ä»åºæ°æ®åæ­¥æºå¶ï¼ä»èä¿è¯æ°æ®å¯æ¬çä¸è´æ§ï¼èä¸»ä»åºä½¿ç¨çæ¯è¯»ååç¦»çæºå¶ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210806172905.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/03.%20redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%BA%93%E5%90%8C%E6%AD%A5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"redisä¹ä¸»ä»åºåæ­¥"},{property:"og:description",content:"å¨åç¹æéåï¼æä»¬éè¦ä¿è¯æå¡ä¸é´æ­ï¼æä»¥éè¦ä½¿ç¨åä½çå¯æ¬æä¾éç¾¤æå¡ï¼ä»èè¾¾å°æå¡çé«å¯ç¨ãredis æä¾äºä¸»ä»åºæ°æ®åæ­¥æºå¶ï¼ä»èä¿è¯æ°æ®å¯æ¬çä¸è´æ§ï¼èä¸»ä»åºä½¿ç¨çæ¯è¯»ååç¦»çæºå¶ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210806172905.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/03.%20redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%BA%93%E5%90%8C%E6%AD%A5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-01T15:18:20.000Z"},{property:"article:tag",content:"redis"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"redisä¹ä¸»ä»åºåæ­¥"},{itemprop:"description",content:"å¨åç¹æéåï¼æä»¬éè¦ä¿è¯æå¡ä¸é´æ­ï¼æä»¥éè¦ä½¿ç¨åä½çå¯æ¬æä¾éç¾¤æå¡ï¼ä»èè¾¾å°æå¡çé«å¯ç¨ãredis æä¾äºä¸»ä»åºæ°æ®åæ­¥æºå¶ï¼ä»èä¿è¯æ°æ®å¯æ¬çä¸è´æ§ï¼èä¸»ä»åºä½¿ç¨çæ¯è¯»ååç¦»çæºå¶ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210806172905.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/03.%20redis%E4%B9%8B%E4%B8%BB%E4%BB%8E%E5%BA%93%E5%90%8C%E6%AD%A5.html",relativePath:"03.ä¸­é´ä»¶/05.redis/03. redisä¹ä¸»ä»åºåæ­¥.md",key:"v-61296d7f",path:"/pages/8072eb/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. è¯»ååç¦»æ¨¡å¼",slug:"_1-è¯»ååç¦»æ¨¡å¼",normalizedTitle:"1. è¯»ååç¦»æ¨¡å¼",charIndex:110},{level:2,title:"2. å¨éå¤å¶",slug:"_2-å¨éå¤å¶",normalizedTitle:"2. å¨éå¤å¶",charIndex:314},{level:3,title:"2.1 ä¸»ä»åºåæ­¥çè¿ç¨",slug:"_2-1-ä¸»ä»åºåæ­¥çè¿ç¨",normalizedTitle:"2.1 ä¸»ä»åºåæ­¥çè¿ç¨",charIndex:326},{level:3,title:"2.2 å¦ä½åå°ä¸»ä»åæ­¥æ¶ï¼å¯¹ä¸»åºçåå?",slug:"_2-2-å¦ä½åå°ä¸»ä»åæ­¥æ¶-å¯¹ä¸»åºçåå",normalizedTitle:"2.2 å¦ä½åå°ä¸»ä»åæ­¥æ¶ï¼å¯¹ä¸»åºçåå?",charIndex:692},{level:2,title:"3. å¢éå¤å¶",slug:"_3-å¢éå¤å¶",normalizedTitle:"3. å¢éå¤å¶",charIndex:905},{level:3,title:"3.1 å¢éå¤å¶çè¿ç¨",slug:"_3-1-å¢éå¤å¶çè¿ç¨",normalizedTitle:"3.1 å¢éå¤å¶çè¿ç¨",charIndex:1106},{level:2,title:"4. åèæç« ",slug:"_4-åèæç« ",normalizedTitle:"4. åèæç« ",charIndex:1760}],headersStr:"0. åè¨ 1. è¯»ååç¦»æ¨¡å¼ 2. å¨éå¤å¶ 2.1 ä¸»ä»åºåæ­¥çè¿ç¨ 2.2 å¦ä½åå°ä¸»ä»åæ­¥æ¶ï¼å¯¹ä¸»åºçåå? 3. å¢éå¤å¶ 3.1 å¢éå¤å¶çè¿ç¨ 4. åèæç« ",content:"# 0. åè¨\n\nå¨åç¹æéåï¼æä»¬éè¦ä¿è¯æå¡ä¸é´æ­ï¼æä»¥éè¦ä½¿ç¨åä½çå¯æ¬æä¾éç¾¤æå¡ï¼ä»èè¾¾å°æå¡çé«å¯ç¨ãredis æä¾äºä¸»ä»åºæ°æ®åæ­¥æºå¶ï¼ä»èä¿è¯æ°æ®å¯æ¬çä¸è´æ§ï¼èä¸»ä»åºä½¿ç¨çæ¯è¯»ååç¦»çæºå¶ã\n\n\n# 1. è¯»ååç¦»æ¨¡å¼\n\néè¿è¯¥æ¨¡å¼æå»ºå¤ä¸ªæ°æ®å¯æ¬ï¼ä½¿ç¨è¯»ååç¦»çæ¹å¼\n\n * è¯»æä½: ä¸»ä»åºé½å¯ä»¥è¿è¡è¯»åã\n * åæä½: ååå¥å°ä¸»åºï¼å¨åæ­¥å°ä»åºã\n\n\n\nä¸ºä»ä¹è¦è¯»ååç¦»å¢ï¼\n\nå¦æä»åºä¹å¯ä»¥è¿è¡åæä½ï¼é£ä¹ä¸»ä»åºå¨åä¸ä¸ª key ä¸­å­å¨çå¼å¯è½ä¼ä¸ä¸è´ï¼å¦æè¦ä¿è¯ä¸è´æ§ï¼éè¦éè¿å éæ¥è§£å³ï¼ä½è¿æ ·ä¼é ææ§è½çæèã\n\nä½å¦æåªæä¸»åºåå¥ï¼å¨åæ­¥ç»ä»åºï¼åè½ä¿è¯ææå®ä¾ä¸­æ°æ®çä¸è´æ§ã\n\n\n# 2. å¨éå¤å¶\n\n\n# 2.1 ä¸»ä»åºåæ­¥çè¿ç¨\n\nç¬¬ä¸é¶æ®µ\n\nä»åºåä¸»åºåépsyncå½ä»¤è¿è¡æ°æ®åæ­¥ï¼è¯¥å½ä»¤åå«ä¸»åºçrunIDåå¤å¶è¿åº¦offset\n\n * runIDï¼æ¯ä¸ªå®ä¾èªå¨çæçéæº IDï¼ç¬¬ä¸æ¬¡ä»åºä¸ç¥éä¸»åº runIDï¼è®¾ç½®ä¸º?\n * offsetï¼è®°å½å¤å¶çè¿åº¦ï¼ç¬¬ä¸æ¬¡è¿åº¦è®¾ç½®ä¸º-1\n\nä¸»åºä¼åå¤ runID å offset ç»ä»åº\n\nç¬¬äºé¶æ®µ\n\nä¸»ä»ç¬¬ä¸æ¬¡åæ­¥æ¯éç¨å¨éå¤å¶çæ¹å¼ï¼ä¸»åºçæ RDB æä»¶ï¼ç¶ååéç»ä»åºï¼ä»åºæ¸ç©ºå½åæ°æ®åè¯»å¥ RDB æä»¶å®æç¬¬ä¸æ¬¡åæ­¥ã\n\nå¨çæ RDB æä»¶æ¶ï¼è¿æ¯ä¼ææ°çæä½çä¼è¿è¡ï¼ä¸ºäºä¿ææ°æ®çä¸è´æ§ï¼ä¼å°æ°çæä½è®°å½å° replication buffer ä¸­ã\n\nç¬¬ä¸é¶æ®µ\n\nRDB æä»¶åéå°ä»åºåï¼å replication buffer ä¸­çæä½ååéç»ä»åºã\n\n\n# 2.2 å¦ä½åå°ä¸»ä»åæ­¥æ¶ï¼å¯¹ä¸»åºçåå?\n\nä¸»ä»åæ­¥æåªäºååï¼\n\n * çæ RDBï¼è¿ä¸ªæä½ä¼ fork å­è¿ç¨ï¼ä¼é»å¡ä¸»çº¿ç¨çæ­£å¸¸è¯·æ±ã\n * ä¼ è¾ RDBï¼ä¼å ç¨ä¸»åºçç½ç»å¸¦å®½\n\nä¸»-ä»-ä»æ¨¡å¼\n\nå¯ä»¥æå¨éæ©ä¸ä¸ªä»åºï¼æ¯å¦éæ©åå­èµæºéç½®è¾é«çä»åºï¼ï¼ç¨äºçº§èå¶ä»çä»åºãç±ä»åºçæ RDB åä¼ è¾ç»ä»åºï¼åå°äºä¸»åºçååã\n\nå¨ä¸»åºå¨éå¤å¶ä¹åï¼ä¼ç»´æ¤ä¸ä¸ªé¿è¿æ¥ï¼åéçæä½å½ä»¤éè¿è¯¥è¿æ¥åæ­¥ç»ä»åº\n\n\n\n\n# 3. å¢éå¤å¶\n\nå¨éå¤å¶æ¯éè¿çæ RDB åéå°ä»åºç¶åè¿è¡è¯»ååè¿è¡åæ­¥ãæä»¬ç¥éçæ RDB æ¬èº«å°±æ¯ä¸ä¸ªæ¶è CPU çæä½ï¼å¹¶ä¸å­å¨é»å¡ä¸»çº¿ç¨çé£é©ï¼æä»¥æä»¬éè¦å°½éå°çæ§è¡å¨éå¤å¶çæä½ã\n\næä»¥å¨ç¬¬ä¸æ¬¡ä½¿ç¨ RDB å¨éå¤å¶åï¼ä¸»ä»åºä¼å»ºç«ä¸ä¸ªé¿è¿æ¥ï¼ä¸»åºæ¶å°çæ°å½ä»¤ä¼ååæ­¥å°ä»åºï¼è¿æ ·å°±é¿åé¢ç¹å¨éå¤å¶ã\n\nä½æ¯æä¸ä¸ªé£é©ç¹æ¯ï¼å¦æè¿ç¨åçäºç½ç»ä¸­æ­æèé»å¡ï¼è¯¥å¦ä½è§£å³ï¼\n\n\n# 3.1 å¢éå¤å¶çè¿ç¨\n\nå½ä¸»ä»è¿æ¥æ¶ï¼ä¼å°æ°çæä½çå½ä»¤åå¥ replication buffer å repl_backlog_buffer ç¼å²åºä¸­\n\nrepl_backlog_buffer æ¯ä¸ä¸ªç¯å½¢ç¼å²åºï¼ä¸»åºä¼è®°å½å½åçåç§»é master_repl_offsetï¼è®°å½èªå·±åå°çä½ç½®ï¼èä»åºå¨ä¸é¢ä¹æå¯¹åºçåç§»é slave_repl_offsetï¼è®°å½èªå·±æ­£å¨è¯»å°çåç§»éã\n\nå¨æ¢å¤è¿æ¥æ¶ï¼ä»åºä¼éè¿ psync å½ä»¤å°èªå·±çåç§»é slave_repl_offset åéç»ä¸»åºï¼ä¸»åºä¼å° slave_repl_offset å master_repl_offset ä¹é´çå½ä»¤åæ­¥ç»ä»åºå³å¯ã\n\n\n\nä¸¾äºä¾å­ï¼ ä¸»åºåä»åºä¹é´ç¸å·®äº put d e å put d f ä¸¤ä¸ªæä½ï¼å¨å¢éå¤å¶æ¶ï¼ä¸»åºåªéè¦æå®ä»¬åæ­¥ç»ä»åºï¼å°±è¡äºã\n\nå ä¸º replication buffer æ¯ä¸ä¸ªç¯å½¢çç¼å­ï¼å½ä¸»ä»åºé¿ææ­å¼æ¶ï¼æ¯æå¯è½è¢«è¦çææ§çæ°æ®ï¼è¿ä¸ªæ¶åæ¯ä¼éæ°åèµ·å¨éå¤å¶ï¼ä¸»åºæ ¹æ®ä»åºåéç slave_repl_offset æ¥å¤æ­æ¯å¢éè¿æ¯å¨éçå¤å¶ã\n\né£ä¸ºä»ä¹å¨éå¤å¶ä½¿ç¨ RDB èä¸æ¯ä½¿ç¨ AOF å¢ï¼\n\n * RDB æä»¶æ¯ç»è¿åç¼©çäºè¿å¶æä»¶ï¼AOF æä»¶æ¯è®°å½æ¯ä¸æ¬¡çæä½ï¼åå«å¯¹åä¸ä¸ª key çå¤æ¬¡åä½æä½ï¼æä»¶æ¯ RDB è¦å¤§çå¤ï¼ä½¿ç¨ AOF å¯ä»¥åå°å¸¦å®½\n * RDB æ¯äºè¿å¶æ°æ®ï¼ä»åºè¿åéåº¦å¿«ãè AOF éè¦ä¾æ¬¡éæ¾æ¯ä¸ä¸ªå½ä»¤ï¼æ¢å¤éåº¦æ¢ã\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",normalizedContent:"# 0. åè¨\n\nå¨åç¹æéåï¼æä»¬éè¦ä¿è¯æå¡ä¸é´æ­ï¼æä»¥éè¦ä½¿ç¨åä½çå¯æ¬æä¾éç¾¤æå¡ï¼ä»èè¾¾å°æå¡çé«å¯ç¨ãredis æä¾äºä¸»ä»åºæ°æ®åæ­¥æºå¶ï¼ä»èä¿è¯æ°æ®å¯æ¬çä¸è´æ§ï¼èä¸»ä»åºä½¿ç¨çæ¯è¯»ååç¦»çæºå¶ã\n\n\n# 1. è¯»ååç¦»æ¨¡å¼\n\néè¿è¯¥æ¨¡å¼æå»ºå¤ä¸ªæ°æ®å¯æ¬ï¼ä½¿ç¨è¯»ååç¦»çæ¹å¼\n\n * è¯»æä½: ä¸»ä»åºé½å¯ä»¥è¿è¡è¯»åã\n * åæä½: ååå¥å°ä¸»åºï¼å¨åæ­¥å°ä»åºã\n\n\n\nä¸ºä»ä¹è¦è¯»ååç¦»å¢ï¼\n\nå¦æä»åºä¹å¯ä»¥è¿è¡åæä½ï¼é£ä¹ä¸»ä»åºå¨åä¸ä¸ª key ä¸­å­å¨çå¼å¯è½ä¼ä¸ä¸è´ï¼å¦æè¦ä¿è¯ä¸è´æ§ï¼éè¦éè¿å éæ¥è§£å³ï¼ä½è¿æ ·ä¼é ææ§è½çæèã\n\nä½å¦æåªæä¸»åºåå¥ï¼å¨åæ­¥ç»ä»åºï¼åè½ä¿è¯ææå®ä¾ä¸­æ°æ®çä¸è´æ§ã\n\n\n# 2. å¨éå¤å¶\n\n\n# 2.1 ä¸»ä»åºåæ­¥çè¿ç¨\n\nç¬¬ä¸é¶æ®µ\n\nä»åºåä¸»åºåépsyncå½ä»¤è¿è¡æ°æ®åæ­¥ï¼è¯¥å½ä»¤åå«ä¸»åºçrunidåå¤å¶è¿åº¦offset\n\n * runidï¼æ¯ä¸ªå®ä¾èªå¨çæçéæº idï¼ç¬¬ä¸æ¬¡ä»åºä¸ç¥éä¸»åº runidï¼è®¾ç½®ä¸º?\n * offsetï¼è®°å½å¤å¶çè¿åº¦ï¼ç¬¬ä¸æ¬¡è¿åº¦è®¾ç½®ä¸º-1\n\nä¸»åºä¼åå¤ runid å offset ç»ä»åº\n\nç¬¬äºé¶æ®µ\n\nä¸»ä»ç¬¬ä¸æ¬¡åæ­¥æ¯éç¨å¨éå¤å¶çæ¹å¼ï¼ä¸»åºçæ rdb æä»¶ï¼ç¶ååéç»ä»åºï¼ä»åºæ¸ç©ºå½åæ°æ®åè¯»å¥ rdb æä»¶å®æç¬¬ä¸æ¬¡åæ­¥ã\n\nå¨çæ rdb æä»¶æ¶ï¼è¿æ¯ä¼ææ°çæä½çä¼è¿è¡ï¼ä¸ºäºä¿ææ°æ®çä¸è´æ§ï¼ä¼å°æ°çæä½è®°å½å° replication buffer ä¸­ã\n\nç¬¬ä¸é¶æ®µ\n\nrdb æä»¶åéå°ä»åºåï¼å replication buffer ä¸­çæä½ååéç»ä»åºã\n\n\n# 2.2 å¦ä½åå°ä¸»ä»åæ­¥æ¶ï¼å¯¹ä¸»åºçåå?\n\nä¸»ä»åæ­¥æåªäºååï¼\n\n * çæ rdbï¼è¿ä¸ªæä½ä¼ fork å­è¿ç¨ï¼ä¼é»å¡ä¸»çº¿ç¨çæ­£å¸¸è¯·æ±ã\n * ä¼ è¾ rdbï¼ä¼å ç¨ä¸»åºçç½ç»å¸¦å®½\n\nä¸»-ä»-ä»æ¨¡å¼\n\nå¯ä»¥æå¨éæ©ä¸ä¸ªä»åºï¼æ¯å¦éæ©åå­èµæºéç½®è¾é«çä»åºï¼ï¼ç¨äºçº§èå¶ä»çä»åºãç±ä»åºçæ rdb åä¼ è¾ç»ä»åºï¼åå°äºä¸»åºçååã\n\nå¨ä¸»åºå¨éå¤å¶ä¹åï¼ä¼ç»´æ¤ä¸ä¸ªé¿è¿æ¥ï¼åéçæä½å½ä»¤éè¿è¯¥è¿æ¥åæ­¥ç»ä»åº\n\n\n\n\n# 3. å¢éå¤å¶\n\nå¨éå¤å¶æ¯éè¿çæ rdb åéå°ä»åºç¶åè¿è¡è¯»ååè¿è¡åæ­¥ãæä»¬ç¥éçæ rdb æ¬èº«å°±æ¯ä¸ä¸ªæ¶è cpu çæä½ï¼å¹¶ä¸å­å¨é»å¡ä¸»çº¿ç¨çé£é©ï¼æä»¥æä»¬éè¦å°½éå°çæ§è¡å¨éå¤å¶çæä½ã\n\næä»¥å¨ç¬¬ä¸æ¬¡ä½¿ç¨ rdb å¨éå¤å¶åï¼ä¸»ä»åºä¼å»ºç«ä¸ä¸ªé¿è¿æ¥ï¼ä¸»åºæ¶å°çæ°å½ä»¤ä¼ååæ­¥å°ä»åºï¼è¿æ ·å°±é¿åé¢ç¹å¨éå¤å¶ã\n\nä½æ¯æä¸ä¸ªé£é©ç¹æ¯ï¼å¦æè¿ç¨åçäºç½ç»ä¸­æ­æèé»å¡ï¼è¯¥å¦ä½è§£å³ï¼\n\n\n# 3.1 å¢éå¤å¶çè¿ç¨\n\nå½ä¸»ä»è¿æ¥æ¶ï¼ä¼å°æ°çæä½çå½ä»¤åå¥ replication buffer å repl_backlog_buffer ç¼å²åºä¸­\n\nrepl_backlog_buffer æ¯ä¸ä¸ªç¯å½¢ç¼å²åºï¼ä¸»åºä¼è®°å½å½åçåç§»é master_repl_offsetï¼è®°å½èªå·±åå°çä½ç½®ï¼èä»åºå¨ä¸é¢ä¹æå¯¹åºçåç§»é slave_repl_offsetï¼è®°å½èªå·±æ­£å¨è¯»å°çåç§»éã\n\nå¨æ¢å¤è¿æ¥æ¶ï¼ä»åºä¼éè¿ psync å½ä»¤å°èªå·±çåç§»é slave_repl_offset åéç»ä¸»åºï¼ä¸»åºä¼å° slave_repl_offset å master_repl_offset ä¹é´çå½ä»¤åæ­¥ç»ä»åºå³å¯ã\n\n\n\nä¸¾äºä¾å­ï¼ ä¸»åºåä»åºä¹é´ç¸å·®äº put d e å put d f ä¸¤ä¸ªæä½ï¼å¨å¢éå¤å¶æ¶ï¼ä¸»åºåªéè¦æå®ä»¬åæ­¥ç»ä»åºï¼å°±è¡äºã\n\nå ä¸º replication buffer æ¯ä¸ä¸ªç¯å½¢çç¼å­ï¼å½ä¸»ä»åºé¿ææ­å¼æ¶ï¼æ¯æå¯è½è¢«è¦çææ§çæ°æ®ï¼è¿ä¸ªæ¶åæ¯ä¼éæ°åèµ·å¨éå¤å¶ï¼ä¸»åºæ ¹æ®ä»åºåéç slave_repl_offset æ¥å¤æ­æ¯å¢éè¿æ¯å¨éçå¤å¶ã\n\né£ä¸ºä»ä¹å¨éå¤å¶ä½¿ç¨ rdb èä¸æ¯ä½¿ç¨ aof å¢ï¼\n\n * rdb æä»¶æ¯ç»è¿åç¼©çäºè¿å¶æä»¶ï¼aof æä»¶æ¯è®°å½æ¯ä¸æ¬¡çæä½ï¼åå«å¯¹åä¸ä¸ª key çå¤æ¬¡åä½æä½ï¼æä»¶æ¯ rdb è¦å¤§çå¤ï¼ä½¿ç¨ aof å¯ä»¥åå°å¸¦å®½\n * rdb æ¯äºè¿å¶æ°æ®ï¼ä»åºè¿åéåº¦å¿«ãè aof éè¦ä¾æ¬¡éæ¾æ¯ä¸ä¸ªå½ä»¤ï¼æ¢å¤éåº¦æ¢ã\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"redisä¹å¨åµæºå¶",frontmatter:{title:"redisä¹å¨åµæºå¶",date:"2022-12-01T15:18:35.000Z",permalink:"/pages/ffee9e/",tags:["redis","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦ä»ç»çæ¯ Redis æä¾çå¨åµæºå¶ï¼éè¿å¨åµçæ§ä¸»åºçç¶åµï¼å¦æåç°ä¸»åºä¸çº¿ï¼åä¼ä»ä»åºä¸­éæ©ä¸ä¸ªç¶æä¼ç§çå½åä¸»åºï¼ä»èä¿è¯æå¡çé«å¯ç¨ã",feed:{enable:!0},categories:["æ°æ®åº","redis"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210807101732.png"},{name:"twitter:title",content:"redisä¹å¨åµæºå¶"},{name:"twitter:description",content:"æ¬æä¸»è¦ä»ç»çæ¯ Redis æä¾çå¨åµæºå¶ï¼éè¿å¨åµçæ§ä¸»åºçç¶åµï¼å¦æåç°ä¸»åºä¸çº¿ï¼åä¼ä»ä»åºä¸­éæ©ä¸ä¸ªç¶æä¼ç§çå½åä¸»åºï¼ä»èä¿è¯æå¡çé«å¯ç¨ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210807101732.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/04.%20redis%E4%B9%8B%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6.html"},{property:"og:type",content:"article"},{property:"og:title",content:"redisä¹å¨åµæºå¶"},{property:"og:description",content:"æ¬æä¸»è¦ä»ç»çæ¯ Redis æä¾çå¨åµæºå¶ï¼éè¿å¨åµçæ§ä¸»åºçç¶åµï¼å¦æåç°ä¸»åºä¸çº¿ï¼åä¼ä»ä»åºä¸­éæ©ä¸ä¸ªç¶æä¼ç§çå½åä¸»åºï¼ä»èä¿è¯æå¡çé«å¯ç¨ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210807101732.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/04.%20redis%E4%B9%8B%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-01T15:18:35.000Z"},{property:"article:tag",content:"redis"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"redisä¹å¨åµæºå¶"},{itemprop:"description",content:"æ¬æä¸»è¦ä»ç»çæ¯ Redis æä¾çå¨åµæºå¶ï¼éè¿å¨åµçæ§ä¸»åºçç¶åµï¼å¦æåç°ä¸»åºä¸çº¿ï¼åä¼ä»ä»åºä¸­éæ©ä¸ä¸ªç¶æä¼ç§çå½åä¸»åºï¼ä»èä¿è¯æå¡çé«å¯ç¨ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210807101732.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/04.%20redis%E4%B9%8B%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6.html",relativePath:"03.ä¸­é´ä»¶/05.redis/04. redisä¹å¨åµæºå¶.md",key:"v-be37f416",path:"/pages/ffee9e/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. å¨åµå¦ä½ä¿è¯é«å¯ç¨ï¼",slug:"_1-å¨åµå¦ä½ä¿è¯é«å¯ç¨",normalizedTitle:"1. å¨åµå¦ä½ä¿è¯é«å¯ç¨ï¼",charIndex:140},{level:3,title:"1.1 çæ§",slug:"_1-1-çæ§",normalizedTitle:"1.1 çæ§",charIndex:158},{level:3,title:"1.2 éæ©æ°ä¸»åº",slug:"_1-2-éæ©æ°ä¸»åº",normalizedTitle:"1.2 éæ©æ°ä¸»åº",charIndex:297},{level:3,title:"1.3 éç¥",slug:"_1-3-éç¥",normalizedTitle:"1.3 éç¥",charIndex:457},{level:2,title:"2. å¨åµéç¾¤çç»å»º",slug:"_2-å¨åµéç¾¤çç»å»º",normalizedTitle:"2. å¨åµéç¾¤çç»å»º",charIndex:562},{level:3,title:"2.1 å¨åµä¸ä»åºå»ºç«è¿æ¥",slug:"_2-1-å¨åµä¸ä»åºå»ºç«è¿æ¥",normalizedTitle:"2.1 å¨åµä¸ä»åºå»ºç«è¿æ¥",charIndex:748},{level:3,title:"2.2 å¨åµä¸å®¢æ·ç«¯å»ºç«è¿æ¥",slug:"_2-2-å¨åµä¸å®¢æ·ç«¯å»ºç«è¿æ¥",normalizedTitle:"2.2 å¨åµä¸å®¢æ·ç«¯å»ºç«è¿æ¥",charIndex:868},{level:2,title:"3. ç±åªä¸ªå¨åµæ¥æ§è¡ä¸»ä»åæ¢ ï¼",slug:"_3-ç±åªä¸ªå¨åµæ¥æ§è¡ä¸»ä»åæ¢",normalizedTitle:"3. ç±åªä¸ªå¨åµæ¥æ§è¡ä¸»ä»åæ¢ ï¼",charIndex:1019},{level:2,title:"4. åèæç« ",slug:"_4-åèæç« ",normalizedTitle:"4. åèæç« ",charIndex:1248}],headersStr:"0. åè¨ 1. å¨åµå¦ä½ä¿è¯é«å¯ç¨ï¼ 1.1 çæ§ 1.2 éæ©æ°ä¸»åº 1.3 éç¥ 2. å¨åµéç¾¤çç»å»º 2.1 å¨åµä¸ä»åºå»ºç«è¿æ¥ 2.2 å¨åµä¸å®¢æ·ç«¯å»ºç«è¿æ¥ 3. ç±åªä¸ªå¨åµæ¥æ§è¡ä¸»ä»åæ¢ ï¼ 4. åèæç« ",content:'# 0. åè¨\n\næä»¬ç¥éï¼åªæä¸»åºæè½æåæä½ï¼èä»åºåªè½è¿è¡è¯»æä½ï¼é£ä¹å½ä¸»åºå®æºåï¼å¦ä½ä¿è¯æå¡çæ­£å¸¸è¿è¡å¢ï¼\n\næ¬æä¸»è¦ä»ç»çæ¯ Redis æä¾çå¨åµæºå¶ï¼éè¿å¨åµçæ§ä¸»åºçç¶åµï¼å¦æåç°ä¸»åºä¸çº¿ï¼åä¼ä»ä»åºä¸­éæ©ä¸ä¸ªç¶æä¼ç§çå½åä¸»åºï¼ä»èä¿è¯æå¡çé«å¯ç¨ã\n\n\n# 1. å¨åµå¦ä½ä¿è¯é«å¯ç¨ï¼\n\n\n# 1.1 çæ§\n\nå¨åµè¿ç¨ä¼åé PING å½ä»¤ç»ä¸»ä»åºæ£æµç½ç»è¿æ¥ï¼å¦æè¶æ¶ï¼åå¤æ­ä¸º"ä¸»è§ä¸çº¿"ã\n\nä½æ¯å¦æå¨åµè¯¯å¤å¯è½ä¼å¯¼è´ä¸»ä»åæ¢ï¼å¯¼è´æ§è½çé¢å¤å¼éï¼æä»¥å¼å¥äºå¨åµéç¾¤ï¼åªæå¤æ°å¨åµè®¤ä¸ºä¸»åºå·²ç»ä¸»è§ä¸çº¿ï¼ä¸»åºä¼è¢«æ è®°ä¸º"å®¢è§ä¸çº¿"ï¼è¿æ¶æä¼è¿è¡ä¸»ä»åæ¢ã\n\n\n\n\n# 1.2 éæ©æ°ä¸»åº\n\néè¿ä¸å®çç­éæ¡ä»¶ï¼æä¸ç¬¦åæ¡ä»¶çä»åºå»æï¼åæç§ä¸å®è§åç»ä»åºæåï¼å¾åæé«çä¸ºæ°ä¸»åº\n\n\n\nç­éæ¡ä»¶ï¼\n\n * å½åä»åºçç¶æ\n * ä¹åä¸æ®µæ¶é´çç½ç»ç¶æ\n\næåè§åï¼\n\n * ç¨æ·å¯ä»¥ç»ä»åº slave-priority éç½®ä¼åçº§\n * ä¸»ä»åºåæ­¥ç¨åº¦\n * ID å·å°çå¾åé«\n\n\n# 1.3 éç¥\n\nå¨åµä¼ææ°ä¸»åºçè¿æ¥ä¿¡æ¯åç»å¶ä»ä»åºï¼è®©å®ä»¬æ§è¡ replicaof å½ä»¤ï¼åæ°ä¸»åºå»ºç«è¿æ¥ï¼å¹¶è¿è¡æ°æ®å¤å¶ãåæ¶ï¼å¨åµä¼ææ°ä¸»åºçè¿æ¥ä¿¡æ¯éç¥ç»å®¢æ·ç«¯ï¼è®©å®ä»¬æè¯·æ±æä½åå°æ°ä¸»åºä¸ã\n\n\n# 2. å¨åµéç¾¤çç»å»º\n\nå¨åµå®ä¾ä¹é´äºç¸åç°æ¯åºäº Redis æä¾ç pub/sub æºå¶ï¼åå¸/è®¢éæºå¶ã\n\nå¨åµåªè¦ä¸ä¸»åºå»ºç«è¿æ¥ï¼ä¼å¨ä¸»åº __sentinel__:hello é¢éä¸åå¸æ¶æ¯ï¼æ¯å¦èªå·±ç ip å°ååç«¯å£ä¿¡æ¯ï¼è®¢éäºè¯¥é¢éçå¶ä»å¨åµä¼è·åå°åå¸æ¶æ¯å¨åµç IP åç«¯å£ï¼å³å¯ä»¥ä¸å¶å»ºç«ç½ç»è¿æ¥ï¼ä¹åç¸äºé´å°±å¯ä»¥éè¿ç½ç»è¿æ¥è¿è¡éä¿¡ã\n\n\n\n\n# 2.1 å¨åµä¸ä»åºå»ºç«è¿æ¥\n\nå¨åµè¿éè¦åä»åºå»ºç«è¿æ¥ï¼è¿æ ·æè½çæ§ä»åºçè¿æ¥ç¶æï¼å½ä¸»åºä¸çº¿åï¼æè½ä»å®ä»¬ä¸­éä¸¾åºæ°çä¸»åºã\n\nå¨åµä½¿ç¨ INFO å½ä»¤åéç»ä¸»åºï¼ä¸»åºä¼è¿åä»åºåè¡¨è¿æ¥ä¿¡æ¯ï¼è¿æ ·ä¹è½åä»åºå»ºç«è¿æ¥å¹¶è¿è¡çæ§\n\n\n\n\n# 2.2 å¨åµä¸å®¢æ·ç«¯å»ºç«è¿æ¥\n\nå½ä¸»åºä¸çº¿åï¼å®¢æ·ç«¯éè¦å¾ç¥ä¸»åºä¸çº¿çæ¶æ¯ï¼åæä½éè¦åæ¢å°æ°çä¸»åºä¸­ï¼æä»¥å¨åµéè¦ä¸å®¢æ·ç«¯å»ºç«è¿æ¥ï¼å¹¶åæ¶éç¥å®¢æ·ç«¯ã\n\nå®¢æ·ç«¯å¯ä»¥ä»å¨åµè®¢éæ¶æ¯ï¼è·åå°ä¸»ä»åæ¢çåç§äºä»¶ã\n\nå®¢æ·ç«¯è¯»åå¨åµçéç½®æä»¶ï¼è·åå¨åµçå°ååç«¯å£ï¼å»ºç«è¿æ¥ï¼ç¶åå³å¯è®¢éæ¶æ¯ã\n\n\n\n\n# 3. ç±åªä¸ªå¨åµæ¥æ§è¡ä¸»ä»åæ¢ ï¼\n\nä»»ä½ä¸ä¸ªå¨åµå¤æ­ä¸»åº ä¸»è§ä¸çº¿ å°±ä¼åå¶ä»å¨åµåé is-master-down-by-addr å½ä»¤ãå¶ä»å®ä¾ä¼æ´å·èªå·±ä¸ä¸»åºçè¿æ¥æåµæåºèµæç¥¨æåå¯¹ç¥¨ãå½å¤æ°å¨åµæèµæç¥¨æ¶ï¼åä¸»åºè¢«è®¤ä¸º å®¢è§ä¸çº¿ã\n\næ­¤æ¶ï¼è¯¥å¨åµååå½ä»¤ç»å¶ä»å¨åµè¿è¡ leaderéä¸¾ï¼å¸æç±èªå·±æ¥è¿è¡ä¸»ä»åæ¢ãå¨è¿ä¸ªè¿ç¨ä¸­ï¼ä»»ä½ä¸ä¸ªå¨åµé½å¯ä»¥åä¸éä¸¾ï¼åªè¦ç¥¨æ°åæ°ä»¥ä¸å¹¶ä¸å¤§äºç­äº quorum å¼ï¼åå¯ä»¥æä¸º leader\n\n\n\n\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥',normalizedContent:'# 0. åè¨\n\næä»¬ç¥éï¼åªæä¸»åºæè½æåæä½ï¼èä»åºåªè½è¿è¡è¯»æä½ï¼é£ä¹å½ä¸»åºå®æºåï¼å¦ä½ä¿è¯æå¡çæ­£å¸¸è¿è¡å¢ï¼\n\næ¬æä¸»è¦ä»ç»çæ¯ redis æä¾çå¨åµæºå¶ï¼éè¿å¨åµçæ§ä¸»åºçç¶åµï¼å¦æåç°ä¸»åºä¸çº¿ï¼åä¼ä»ä»åºä¸­éæ©ä¸ä¸ªç¶æä¼ç§çå½åä¸»åºï¼ä»èä¿è¯æå¡çé«å¯ç¨ã\n\n\n# 1. å¨åµå¦ä½ä¿è¯é«å¯ç¨ï¼\n\n\n# 1.1 çæ§\n\nå¨åµè¿ç¨ä¼åé ping å½ä»¤ç»ä¸»ä»åºæ£æµç½ç»è¿æ¥ï¼å¦æè¶æ¶ï¼åå¤æ­ä¸º"ä¸»è§ä¸çº¿"ã\n\nä½æ¯å¦æå¨åµè¯¯å¤å¯è½ä¼å¯¼è´ä¸»ä»åæ¢ï¼å¯¼è´æ§è½çé¢å¤å¼éï¼æä»¥å¼å¥äºå¨åµéç¾¤ï¼åªæå¤æ°å¨åµè®¤ä¸ºä¸»åºå·²ç»ä¸»è§ä¸çº¿ï¼ä¸»åºä¼è¢«æ è®°ä¸º"å®¢è§ä¸çº¿"ï¼è¿æ¶æä¼è¿è¡ä¸»ä»åæ¢ã\n\n\n\n\n# 1.2 éæ©æ°ä¸»åº\n\néè¿ä¸å®çç­éæ¡ä»¶ï¼æä¸ç¬¦åæ¡ä»¶çä»åºå»æï¼åæç§ä¸å®è§åç»ä»åºæåï¼å¾åæé«çä¸ºæ°ä¸»åº\n\n\n\nç­éæ¡ä»¶ï¼\n\n * å½åä»åºçç¶æ\n * ä¹åä¸æ®µæ¶é´çç½ç»ç¶æ\n\næåè§åï¼\n\n * ç¨æ·å¯ä»¥ç»ä»åº slave-priority éç½®ä¼åçº§\n * ä¸»ä»åºåæ­¥ç¨åº¦\n * id å·å°çå¾åé«\n\n\n# 1.3 éç¥\n\nå¨åµä¼ææ°ä¸»åºçè¿æ¥ä¿¡æ¯åç»å¶ä»ä»åºï¼è®©å®ä»¬æ§è¡ replicaof å½ä»¤ï¼åæ°ä¸»åºå»ºç«è¿æ¥ï¼å¹¶è¿è¡æ°æ®å¤å¶ãåæ¶ï¼å¨åµä¼ææ°ä¸»åºçè¿æ¥ä¿¡æ¯éç¥ç»å®¢æ·ç«¯ï¼è®©å®ä»¬æè¯·æ±æä½åå°æ°ä¸»åºä¸ã\n\n\n# 2. å¨åµéç¾¤çç»å»º\n\nå¨åµå®ä¾ä¹é´äºç¸åç°æ¯åºäº redis æä¾ç pub/sub æºå¶ï¼åå¸/è®¢éæºå¶ã\n\nå¨åµåªè¦ä¸ä¸»åºå»ºç«è¿æ¥ï¼ä¼å¨ä¸»åº __sentinel__:hello é¢éä¸åå¸æ¶æ¯ï¼æ¯å¦èªå·±ç ip å°ååç«¯å£ä¿¡æ¯ï¼è®¢éäºè¯¥é¢éçå¶ä»å¨åµä¼è·åå°åå¸æ¶æ¯å¨åµç ip åç«¯å£ï¼å³å¯ä»¥ä¸å¶å»ºç«ç½ç»è¿æ¥ï¼ä¹åç¸äºé´å°±å¯ä»¥éè¿ç½ç»è¿æ¥è¿è¡éä¿¡ã\n\n\n\n\n# 2.1 å¨åµä¸ä»åºå»ºç«è¿æ¥\n\nå¨åµè¿éè¦åä»åºå»ºç«è¿æ¥ï¼è¿æ ·æè½çæ§ä»åºçè¿æ¥ç¶æï¼å½ä¸»åºä¸çº¿åï¼æè½ä»å®ä»¬ä¸­éä¸¾åºæ°çä¸»åºã\n\nå¨åµä½¿ç¨ info å½ä»¤åéç»ä¸»åºï¼ä¸»åºä¼è¿åä»åºåè¡¨è¿æ¥ä¿¡æ¯ï¼è¿æ ·ä¹è½åä»åºå»ºç«è¿æ¥å¹¶è¿è¡çæ§\n\n\n\n\n# 2.2 å¨åµä¸å®¢æ·ç«¯å»ºç«è¿æ¥\n\nå½ä¸»åºä¸çº¿åï¼å®¢æ·ç«¯éè¦å¾ç¥ä¸»åºä¸çº¿çæ¶æ¯ï¼åæä½éè¦åæ¢å°æ°çä¸»åºä¸­ï¼æä»¥å¨åµéè¦ä¸å®¢æ·ç«¯å»ºç«è¿æ¥ï¼å¹¶åæ¶éç¥å®¢æ·ç«¯ã\n\nå®¢æ·ç«¯å¯ä»¥ä»å¨åµè®¢éæ¶æ¯ï¼è·åå°ä¸»ä»åæ¢çåç§äºä»¶ã\n\nå®¢æ·ç«¯è¯»åå¨åµçéç½®æä»¶ï¼è·åå¨åµçå°ååç«¯å£ï¼å»ºç«è¿æ¥ï¼ç¶åå³å¯è®¢éæ¶æ¯ã\n\n\n\n\n# 3. ç±åªä¸ªå¨åµæ¥æ§è¡ä¸»ä»åæ¢ ï¼\n\nä»»ä½ä¸ä¸ªå¨åµå¤æ­ä¸»åº ä¸»è§ä¸çº¿ å°±ä¼åå¶ä»å¨åµåé is-master-down-by-addr å½ä»¤ãå¶ä»å®ä¾ä¼æ´å·èªå·±ä¸ä¸»åºçè¿æ¥æåµæåºèµæç¥¨æåå¯¹ç¥¨ãå½å¤æ°å¨åµæèµæç¥¨æ¶ï¼åä¸»åºè¢«è®¤ä¸º å®¢è§ä¸çº¿ã\n\næ­¤æ¶ï¼è¯¥å¨åµååå½ä»¤ç»å¶ä»å¨åµè¿è¡ leaderéä¸¾ï¼å¸æç±èªå·±æ¥è¿è¡ä¸»ä»åæ¢ãå¨è¿ä¸ªè¿ç¨ä¸­ï¼ä»»ä½ä¸ä¸ªå¨åµé½å¯ä»¥åä¸éä¸¾ï¼åªè¦ç¥¨æ°åæ°ä»¥ä¸å¹¶ä¸å¤§äºç­äº quorum å¼ï¼åå¯ä»¥æä¸º leader\n\n\n\n\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥',charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"redisä¹åçéç¾¤",frontmatter:{title:"redisä¹åçéç¾¤",date:"2022-12-01T15:18:45.000Z",permalink:"/pages/1c2914/",tags:["redis","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨æµ·éçæ°æ®é¢åï¼åä¸ª redis å®ä¾çè½åæ¯æéçï¼æ å¯è½æ éå¢å¤§çåå­ï¼æä»¥å¿é¡»è¦æå»ºåçéç¾¤ï¼æ¥æ¨ªåæå±æ¥æ¯æä¿å­æ´å¤çæ°æ®ã",feed:{enable:!0},categories:["æ°æ®åº","redis"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210808133416.png"},{name:"twitter:title",content:"redisä¹åçéç¾¤"},{name:"twitter:description",content:"å¨æµ·éçæ°æ®é¢åï¼åä¸ª redis å®ä¾çè½åæ¯æéçï¼æ å¯è½æ éå¢å¤§çåå­ï¼æä»¥å¿é¡»è¦æå»ºåçéç¾¤ï¼æ¥æ¨ªåæå±æ¥æ¯æä¿å­æ´å¤çæ°æ®ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210808133416.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/05.%20redis%E4%B9%8B%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4.html"},{property:"og:type",content:"article"},{property:"og:title",content:"redisä¹åçéç¾¤"},{property:"og:description",content:"å¨æµ·éçæ°æ®é¢åï¼åä¸ª redis å®ä¾çè½åæ¯æéçï¼æ å¯è½æ éå¢å¤§çåå­ï¼æä»¥å¿é¡»è¦æå»ºåçéç¾¤ï¼æ¥æ¨ªåæå±æ¥æ¯æä¿å­æ´å¤çæ°æ®ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210808133416.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/05.%20redis%E4%B9%8B%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-01T15:18:45.000Z"},{property:"article:tag",content:"redis"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"redisä¹åçéç¾¤"},{itemprop:"description",content:"å¨æµ·éçæ°æ®é¢åï¼åä¸ª redis å®ä¾çè½åæ¯æéçï¼æ å¯è½æ éå¢å¤§çåå­ï¼æä»¥å¿é¡»è¦æå»ºåçéç¾¤ï¼æ¥æ¨ªåæå±æ¥æ¯æä¿å­æ´å¤çæ°æ®ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20210808133416.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/05.%20redis%E4%B9%8B%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4.html",relativePath:"03.ä¸­é´ä»¶/05.redis/05. redisä¹åçéç¾¤.md",key:"v-ae93950e",path:"/pages/1c2914/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. åçéç¾¤æ¯ä»ä¹ï¼",slug:"_1-åçéç¾¤æ¯ä»ä¹",normalizedTitle:"1. åçéç¾¤æ¯ä»ä¹ï¼",charIndex:81},{level:2,title:"2. åçéç¾¤çç»å»º",slug:"_2-åçéç¾¤çç»å»º",normalizedTitle:"2. åçéç¾¤çç»å»º",charIndex:279},{level:2,title:"3. å®¢æ·ç«¯å¦ä½è¯»ååçéç¾¤",slug:"_3-å®¢æ·ç«¯å¦ä½è¯»ååçéç¾¤",normalizedTitle:"3. å®¢æ·ç«¯å¦ä½è¯»ååçéç¾¤",charIndex:587},{level:2,title:"4. åèæç« ",slug:"_4-åèæç« ",normalizedTitle:"4. åèæç« ",charIndex:1418}],headersStr:"0. åè¨ 1. åçéç¾¤æ¯ä»ä¹ï¼ 2. åçéç¾¤çç»å»º 3. å®¢æ·ç«¯å¦ä½è¯»ååçéç¾¤ 4. åèæç« ",content:"# 0. åè¨\n\nå¨æµ·éçæ°æ®é¢åï¼åä¸ª redis å®ä¾çè½åæ¯æéçï¼æ å¯è½æ éå¢å¤§çåå­ï¼æä»¥å¿é¡»è¦æå»ºåçéç¾¤ï¼æ¥æ¨ªåæå±æ¥æ¯æä¿å­æ´å¤çæ°æ®ã\n\n\n# 1. åçéç¾¤æ¯ä»ä¹ï¼\n\nåçéç¾¤ä¸»è¦æ¯å° redis çæ°æ®ååæå¤ä»½ï¼æ¯ä¸ä»½é½ç±ä¸ä¸ªå®ä¾æ¥ä¿å­ï¼ç¶åç±å¤ä¸ªå®ä¾æ¥ç»æä¸ä¸ªä¸ä¸ªéç¾¤ã\n\nä¸ºä»ä¹ä½¿ç¨åçéç¾¤èä¸æ¯å¢å åå­ï¼\n\n * å¨ RDB è¿è¡æä¹åæ¶ï¼ä¼ fork å­è¿ç¨æ¥å®æï¼fork æä½ä¼é»å¡ä¸»çº¿ç¨çæ¶é¿ä¸æ°æ®éææ­£æ¯ã\n * ç¡¬ä»¶ææ¬ï¼æåå­ä» 32GB æ©å±å° 64GB è¿ç®å®¹æï¼ä½æ¯ï¼è¦æ³æ©åå° 1TBï¼ææ¬å¤ªé«ã\n\n\n# 2. åçéç¾¤çç»å»º\n\nå¨ Redis Cluster æ¹æ¡ä¸­ï¼ä¸ä¸ªåçéç¾¤æ 16384 ä¸ªåå¸æ§½ï¼æ¯ä¸ªé®å¼å¯¹ç key ä¼è¿è¡è®¡ç®å¹¶å¯¹ 16384 åæ¨¡ï¼åéå°ä¸ä¸ªå¯¹åºç¼å·çåå¸æ§½ã\n\nå¨ä½¿ç¨ cluster create å½ä»¤åå»ºéç¾¤æ¶ï¼ä¼èªå¨å° 16384 ä¸ªæ§½å¹³ååéå°éç¾¤å®ä¾ä¸­ãä¹å¯ä»¥éè¿ cluster meet å½ä»¤æå¨å»ºç«å®ä¾é´çè¿æ¥å½¢æéç¾¤ï¼åä½¿ç¨ cluster addslots å½ä»¤æå®æ¯ä¸ªå®ä¾ä¸çåå¸æ§½çä¸ªæ°ã\n\nå¨æå¨åéåå¸æ§½æ¶ï¼éè¦æ 16384 ä¸ªæ§½é½åéå®ï¼å¦å Redis éç¾¤æ æ³æ­£å¸¸å·¥ä½ã\n\næ°æ®åéå°åªä¸ªå®ä¾?\n\næ°æ®æ ¹æ®åéå°åå¸æ§½ç¼å·åå¥å°å¯¹åºçå®ä¾ä¸­ã\n\n\n# 3. å®¢æ·ç«¯å¦ä½è¯»ååçéç¾¤\n\nå®¢æ·ç«¯ä»åªä¸ªå®ä¾ä¸­è¯»åæ°æ®ï¼\n\nå®¢æ·ç«¯ä¸éç¾¤å»ºç«è¿æ¥åï¼å®ä¾ä¼å°åå¸æ§½çåéä¿¡æ¯åéç»å®¢æ·ç«¯ãå®¢æ·ç«¯å°åå¸æ§½ä¿¡æ¯ç¼å­å¨æ¬å°ï¼å½å®¢æ·ç«¯æä½é®å¼å¯¹æ¶ï¼åè®¡ç®å¾å°å¯¹åºçåå¸æ§½ï¼ååéè¯·æ±å°ç¸åºçå®ä¾ã\n\nä½åå¸æ§½ä¸å®ä¾çæ å°å³ç³»å¹¶ä¸æ¯ä¸æä¸åçï¼å¯è½ä¼åçååï¼\n\n * éç¾¤ä¸­ï¼å®ä¾ææ°å¢æå é¤ï¼redis ä¼éæ°åéåå¸æ§½\n * ä¸ºäºè´è½½åè¡¡ï¼redis ä¼å°åå¸æ§½å¨ææå®ä¾ä¸­éæ°åå¸ã\n\nå½æ å°å³ç³»ååæ¶ï¼å®¢æ·ç«¯å¦ä½æç¥ï¼\n\néå®åæºå¶ãå®¢æ·ç«¯åéæ°æ®ç»ä¸ä¸ªå®ä¾ï¼ä½æ¯å¹¶æ²¡æè¿ä¸ªé®å¼å¯¹çåå¸æ§½ä¿¡æ¯ï¼åå®ä¾ä¼åé MOVED å½ä»¤ç»æç»å®¢æ·ç«¯ï¼åå«æ°å®ä¾çè®¿é®å°åãå®¢æ·ç«¯æ´æ°æ¬å°ç¼å­å®ä¾ä¸åå¸æ§½çæ å°å³ç³»ï¼å¹¶åæ°å®ä¾åéè¯·æ±ã\n\nGET hello:key\n(error) MOVED 13320 172.16.19.5:6379\n\n\n1\n2\n\n\nå®¢æ·ç«¯è¯·æ±çåå¸æ§½ 13320 å¨ 172.16.19.5 è¿ä¸ªå®ä¾ä¸\n\n\n\nå¦æè®¿é®çæ°æ®æ­£å¨è¿ç§»çåå¸æ§½ï¼è¯¥å¦ä½è®¿é®æ°æ®?\n\nSlot 2 æ­£å¨ä»å®ä¾ 2 å¾å®ä¾ 3 è¿ç§»ï¼key1 å key2 å·²ç»è¿ç§»è¿å»ï¼key3 å key4 è¿å¨å®ä¾ 2ãå®¢æ·ç«¯åå®ä¾ 2 è¯·æ± key2 åï¼å°±ä¼æ¶å°å®ä¾ 2 è¿åç ASK å½ä»¤ã\n\nASK å½ä»¤è¡¨ç¤ºä¸¤å±å«ä¹ï¼ç¬¬ä¸ï¼è¡¨æ Slot æ°æ®è¿å¨è¿ç§»ä¸­ï¼ç¬¬äºï¼ASK å½ä»¤æå®¢æ·ç«¯æè¯·æ±æ°æ®çææ°å®ä¾å°åè¿åç»å®¢æ·ç«¯ï¼æ­¤æ¶ï¼å®¢æ·ç«¯éè¦ç»å®ä¾ 3 åé ASKING å½ä»¤ï¼ç¶åååéæä½å½ä»¤ã\n\nå MOVED å½ä»¤ä¸åï¼ASK å½ä»¤å¹¶ä¸ä¼æ´æ°å®¢æ·ç«¯ç¼å­çåå¸æ§½åéä¿¡æ¯ã\n\nASK å½ä»¤çä½ç¨åªæ¯è®©å®¢æ·ç«¯è½ç»æ°å®ä¾åéä¸æ¬¡è¯·æ±ï¼èä¸å MOVED å½ä»¤é£æ ·ï¼ä¼æ´æ¹æ¬å°ç¼å­ï¼è®©åç»­ææå½ä»¤é½åå¾æ°å®ä¾ã\n\n\n\nå®¢æ·ç«¯ä¸ºä»ä¹å¯ä»¥å¨ä»»æä¸ä¸ªå®ä¾è·åææçåå¸æ§½ä¿¡æ¯ï¼\n\nredis å®ä¾ä¹é´ä¹ä¼å»ºç«è¿æ¥ï¼åäº«èªå·±çåå¸æ§½ä¿¡æ¯ã\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",normalizedContent:"# 0. åè¨\n\nå¨æµ·éçæ°æ®é¢åï¼åä¸ª redis å®ä¾çè½åæ¯æéçï¼æ å¯è½æ éå¢å¤§çåå­ï¼æä»¥å¿é¡»è¦æå»ºåçéç¾¤ï¼æ¥æ¨ªåæå±æ¥æ¯æä¿å­æ´å¤çæ°æ®ã\n\n\n# 1. åçéç¾¤æ¯ä»ä¹ï¼\n\nåçéç¾¤ä¸»è¦æ¯å° redis çæ°æ®ååæå¤ä»½ï¼æ¯ä¸ä»½é½ç±ä¸ä¸ªå®ä¾æ¥ä¿å­ï¼ç¶åç±å¤ä¸ªå®ä¾æ¥ç»æä¸ä¸ªä¸ä¸ªéç¾¤ã\n\nä¸ºä»ä¹ä½¿ç¨åçéç¾¤èä¸æ¯å¢å åå­ï¼\n\n * å¨ rdb è¿è¡æä¹åæ¶ï¼ä¼ fork å­è¿ç¨æ¥å®æï¼fork æä½ä¼é»å¡ä¸»çº¿ç¨çæ¶é¿ä¸æ°æ®éææ­£æ¯ã\n * ç¡¬ä»¶ææ¬ï¼æåå­ä» 32gb æ©å±å° 64gb è¿ç®å®¹æï¼ä½æ¯ï¼è¦æ³æ©åå° 1tbï¼ææ¬å¤ªé«ã\n\n\n# 2. åçéç¾¤çç»å»º\n\nå¨ redis cluster æ¹æ¡ä¸­ï¼ä¸ä¸ªåçéç¾¤æ 16384 ä¸ªåå¸æ§½ï¼æ¯ä¸ªé®å¼å¯¹ç key ä¼è¿è¡è®¡ç®å¹¶å¯¹ 16384 åæ¨¡ï¼åéå°ä¸ä¸ªå¯¹åºç¼å·çåå¸æ§½ã\n\nå¨ä½¿ç¨ cluster create å½ä»¤åå»ºéç¾¤æ¶ï¼ä¼èªå¨å° 16384 ä¸ªæ§½å¹³ååéå°éç¾¤å®ä¾ä¸­ãä¹å¯ä»¥éè¿ cluster meet å½ä»¤æå¨å»ºç«å®ä¾é´çè¿æ¥å½¢æéç¾¤ï¼åä½¿ç¨ cluster addslots å½ä»¤æå®æ¯ä¸ªå®ä¾ä¸çåå¸æ§½çä¸ªæ°ã\n\nå¨æå¨åéåå¸æ§½æ¶ï¼éè¦æ 16384 ä¸ªæ§½é½åéå®ï¼å¦å redis éç¾¤æ æ³æ­£å¸¸å·¥ä½ã\n\næ°æ®åéå°åªä¸ªå®ä¾?\n\næ°æ®æ ¹æ®åéå°åå¸æ§½ç¼å·åå¥å°å¯¹åºçå®ä¾ä¸­ã\n\n\n# 3. å®¢æ·ç«¯å¦ä½è¯»ååçéç¾¤\n\nå®¢æ·ç«¯ä»åªä¸ªå®ä¾ä¸­è¯»åæ°æ®ï¼\n\nå®¢æ·ç«¯ä¸éç¾¤å»ºç«è¿æ¥åï¼å®ä¾ä¼å°åå¸æ§½çåéä¿¡æ¯åéç»å®¢æ·ç«¯ãå®¢æ·ç«¯å°åå¸æ§½ä¿¡æ¯ç¼å­å¨æ¬å°ï¼å½å®¢æ·ç«¯æä½é®å¼å¯¹æ¶ï¼åè®¡ç®å¾å°å¯¹åºçåå¸æ§½ï¼ååéè¯·æ±å°ç¸åºçå®ä¾ã\n\nä½åå¸æ§½ä¸å®ä¾çæ å°å³ç³»å¹¶ä¸æ¯ä¸æä¸åçï¼å¯è½ä¼åçååï¼\n\n * éç¾¤ä¸­ï¼å®ä¾ææ°å¢æå é¤ï¼redis ä¼éæ°åéåå¸æ§½\n * ä¸ºäºè´è½½åè¡¡ï¼redis ä¼å°åå¸æ§½å¨ææå®ä¾ä¸­éæ°åå¸ã\n\nå½æ å°å³ç³»ååæ¶ï¼å®¢æ·ç«¯å¦ä½æç¥ï¼\n\néå®åæºå¶ãå®¢æ·ç«¯åéæ°æ®ç»ä¸ä¸ªå®ä¾ï¼ä½æ¯å¹¶æ²¡æè¿ä¸ªé®å¼å¯¹çåå¸æ§½ä¿¡æ¯ï¼åå®ä¾ä¼åé moved å½ä»¤ç»æç»å®¢æ·ç«¯ï¼åå«æ°å®ä¾çè®¿é®å°åãå®¢æ·ç«¯æ´æ°æ¬å°ç¼å­å®ä¾ä¸åå¸æ§½çæ å°å³ç³»ï¼å¹¶åæ°å®ä¾åéè¯·æ±ã\n\nget hello:key\n(error) moved 13320 172.16.19.5:6379\n\n\n1\n2\n\n\nå®¢æ·ç«¯è¯·æ±çåå¸æ§½ 13320 å¨ 172.16.19.5 è¿ä¸ªå®ä¾ä¸\n\n\n\nå¦æè®¿é®çæ°æ®æ­£å¨è¿ç§»çåå¸æ§½ï¼è¯¥å¦ä½è®¿é®æ°æ®?\n\nslot 2 æ­£å¨ä»å®ä¾ 2 å¾å®ä¾ 3 è¿ç§»ï¼key1 å key2 å·²ç»è¿ç§»è¿å»ï¼key3 å key4 è¿å¨å®ä¾ 2ãå®¢æ·ç«¯åå®ä¾ 2 è¯·æ± key2 åï¼å°±ä¼æ¶å°å®ä¾ 2 è¿åç ask å½ä»¤ã\n\nask å½ä»¤è¡¨ç¤ºä¸¤å±å«ä¹ï¼ç¬¬ä¸ï¼è¡¨æ slot æ°æ®è¿å¨è¿ç§»ä¸­ï¼ç¬¬äºï¼ask å½ä»¤æå®¢æ·ç«¯æè¯·æ±æ°æ®çææ°å®ä¾å°åè¿åç»å®¢æ·ç«¯ï¼æ­¤æ¶ï¼å®¢æ·ç«¯éè¦ç»å®ä¾ 3 åé asking å½ä»¤ï¼ç¶åååéæä½å½ä»¤ã\n\nå moved å½ä»¤ä¸åï¼ask å½ä»¤å¹¶ä¸ä¼æ´æ°å®¢æ·ç«¯ç¼å­çåå¸æ§½åéä¿¡æ¯ã\n\nask å½ä»¤çä½ç¨åªæ¯è®©å®¢æ·ç«¯è½ç»æ°å®ä¾åéä¸æ¬¡è¯·æ±ï¼èä¸å moved å½ä»¤é£æ ·ï¼ä¼æ´æ¹æ¬å°ç¼å­ï¼è®©åç»­ææå½ä»¤é½åå¾æ°å®ä¾ã\n\n\n\nå®¢æ·ç«¯ä¸ºä»ä¹å¯ä»¥å¨ä»»æä¸ä¸ªå®ä¾è·åææçåå¸æ§½ä¿¡æ¯ï¼\n\nredis å®ä¾ä¹é´ä¹ä¼å»ºç«è¿æ¥ï¼åäº«èªå·±çåå¸æ§½ä¿¡æ¯ã\n\n\n# 4. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"redisä¹ç¼å­",frontmatter:{title:"redisä¹ç¼å­",date:"2022-12-01T15:18:55.000Z",permalink:"/pages/0d7b25/",tags:["redis","æ°æ®åº"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"reids æ¯åºäºåå­çæ°æ®åºï¼å®çç¹æ§ä¹ä¸å°±å¿«ï¼ç¼å­æ¯å¶æä¸»è¦çåºç¨åºæ¯ï¼æ¬æä¸»è¦ä»ç» redis çç¼å­ç¹æ§ï¼ä»¥åè¯¥å¦ä½æ­£ç¡®çä½¿ç¨å®ã",feed:{enable:!0},categories:["æ°æ®åº","redis"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16698736280551669873627898.png"},{name:"twitter:title",content:"redisä¹ç¼å­"},{name:"twitter:description",content:"reids æ¯åºäºåå­çæ°æ®åºï¼å®çç¹æ§ä¹ä¸å°±å¿«ï¼ç¼å­æ¯å¶æä¸»è¦çåºç¨åºæ¯ï¼æ¬æä¸»è¦ä»ç» redis çç¼å­ç¹æ§ï¼ä»¥åè¯¥å¦ä½æ­£ç¡®çä½¿ç¨å®ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16698736280551669873627898.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/06.%20redis%E4%B9%8B%E7%BC%93%E5%AD%98.html"},{property:"og:type",content:"article"},{property:"og:title",content:"redisä¹ç¼å­"},{property:"og:description",content:"reids æ¯åºäºåå­çæ°æ®åºï¼å®çç¹æ§ä¹ä¸å°±å¿«ï¼ç¼å­æ¯å¶æä¸»è¦çåºç¨åºæ¯ï¼æ¬æä¸»è¦ä»ç» redis çç¼å­ç¹æ§ï¼ä»¥åè¯¥å¦ä½æ­£ç¡®çä½¿ç¨å®ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16698736280551669873627898.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/06.%20redis%E4%B9%8B%E7%BC%93%E5%AD%98.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-01T15:18:55.000Z"},{property:"article:tag",content:"redis"},{property:"article:tag",content:"æ°æ®åº"},{itemprop:"name",content:"redisä¹ç¼å­"},{itemprop:"description",content:"reids æ¯åºäºåå­çæ°æ®åºï¼å®çç¹æ§ä¹ä¸å°±å¿«ï¼ç¼å­æ¯å¶æä¸»è¦çåºç¨åºæ¯ï¼æ¬æä¸»è¦ä»ç» redis çç¼å­ç¹æ§ï¼ä»¥åè¯¥å¦ä½æ­£ç¡®çä½¿ç¨å®ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/16698736280551669873627898.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/05.redis/06.%20redis%E4%B9%8B%E7%BC%93%E5%AD%98.html",relativePath:"03.ä¸­é´ä»¶/05.redis/06. redisä¹ç¼å­.md",key:"v-834e066a",path:"/pages/0d7b25/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:2,title:"2. ç¼å­ç±»å",slug:"_2-ç¼å­ç±»å",normalizedTitle:"2. ç¼å­ç±»å",charIndex:83},{level:3,title:"2.1 åªè¯»ç¼å­",slug:"_2-1-åªè¯»ç¼å­",normalizedTitle:"2.1 åªè¯»ç¼å­",charIndex:95},{level:3,title:"2.2 è¯»åç¼å­",slug:"_2-2-è¯»åç¼å­",normalizedTitle:"2.2 è¯»åç¼å­",charIndex:250},{level:2,title:"2. ç¼å­åæ°æ®åºçæ°æ®ä¸è´æ§",slug:"_2-ç¼å­åæ°æ®åºçæ°æ®ä¸è´æ§",normalizedTitle:"2. ç¼å­åæ°æ®åºçæ°æ®ä¸è´æ§",charIndex:468},{level:3,title:"2.1 åªäºæåµä¼å¯¼è´æ°æ®ä¸ä¸è´ ï¼",slug:"_2-1-åªäºæåµä¼å¯¼è´æ°æ®ä¸ä¸è´",normalizedTitle:"2.1 åªäºæåµä¼å¯¼è´æ°æ®ä¸ä¸è´ ï¼",charIndex:488},{level:3,title:"2.3 éå+éè¯æºå¶",slug:"_2-3-éå-éè¯æºå¶",normalizedTitle:"2.3 éå+éè¯æºå¶",charIndex:738},{level:2,title:"3. æ·æ±°ç­ç¥",slug:"_3-æ·æ±°ç­ç¥",normalizedTitle:"3. æ·æ±°ç­ç¥",charIndex:1364},{level:2,title:"4. ç¼å­éªå´©",slug:"_4-ç¼å­éªå´©",normalizedTitle:"4. ç¼å­éªå´©",charIndex:1896},{level:2,title:"5. ç¼å­å»ç©¿",slug:"_5-ç¼å­å»ç©¿",normalizedTitle:"5. ç¼å­å»ç©¿",charIndex:2234},{level:2,title:"6. ç¼å­ç©¿é",slug:"_6-ç¼å­ç©¿é",normalizedTitle:"6. ç¼å­ç©¿é",charIndex:2445},{level:2,title:"7. åèæç« ",slug:"_7-åèæç« ",normalizedTitle:"7. åèæç« ",charIndex:2741}],headersStr:"1. åè¨ 2. ç¼å­ç±»å 2.1 åªè¯»ç¼å­ 2.2 è¯»åç¼å­ 2. ç¼å­åæ°æ®åºçæ°æ®ä¸è´æ§ 2.1 åªäºæåµä¼å¯¼è´æ°æ®ä¸ä¸è´ ï¼ 2.3 éå+éè¯æºå¶ 3. æ·æ±°ç­ç¥ 4. ç¼å­éªå´© 5. ç¼å­å»ç©¿ 6. ç¼å­ç©¿é 7. åèæç« ",content:"# 1. åè¨\n\nreids æ¯åºäºåå­çæ°æ®åºï¼å®çç¹æ§ä¹ä¸å°±å¿«ï¼ç¼å­æ¯å¶æä¸»è¦çåºç¨åºæ¯ï¼æ¬æä¸»è¦ä»ç» redis çç¼å­ç¹æ§ï¼ä»¥åè¯¥å¦ä½æ­£ç¡®çä½¿ç¨å®ã\n\n\n# 2. ç¼å­ç±»å\n\n\n# 2.1 åªè¯»ç¼å­\n\nå½åå¥æ°æ®æ¶ï¼ç´æ¥æä½åç«¯æ°æ®åºï¼è¿è¡å¢å æ¹ãå åæ¹æä½ï¼å¦æ redis å·²ç»ç¼å­äºå¯¹åºçæ°æ®ï¼åéè¦è¿è¡å é¤ãå½åºç¨è¯»åæ°æ®æ¶ï¼åçç¼å­ç¼ºå¤±ï¼åä¼ä»åç«¯æ°æ®åºè¯»åå° redis ä¸­ä½¿ç¨ã\n\n\n\nå¥½å¤æ¯ææçæ°æ®é½å¨åç«¯æ°æ®åºä¸­ï¼èåç«¯æ°æ®æä¾å¯é æ§ä¿éï¼ä¸ä¼æä¸¢å¤±æ°æ®çé£é©ã\n\n\n# 2.2 è¯»åç¼å­\n\nææ°çæ°æ®å¨ redis ä¸­ãå¨åå¥æ°æ®æ¶ï¼ä¼ååå¥å° redisï¼å¹¶ä¸å ä¸ºç¼å­çé«æ§è½è®¿é®ï¼å¯ä»¥å¿«éè¿åç»ä¸å¡åºç¨ã\n\nä½æ¯ç±äº redis æ¯åå­æ°æ®åºå­å¨æ°æ®ä¸¢å¤±çé£é©ï¼æä»¥è¿æ¯éè¦åå¥å°åç«¯æ°æ®åºä¸­ä¿è¯å¯é æ§ãæä¸¤ç§åå¥ç­ç¥ï¼\n\n * åæ­¥ç´åï¼å¨å redis æ¶ï¼åæ­¥åå¥å°åç«¯æ°æ®åºï¼å®æååè¿åç»ä¸å¡ãä¼å¢å ååºå»¶è¿ã\n * å¼æ­¥ç´åï¼ç­å¾å¢æ¹çæ°æ®è¦è¢«ä»ç¼å­æ·æ±°æ¶ãååååç«¯æ°æ®åºã\n\n\n\n\n# 2. ç¼å­åæ°æ®åºçæ°æ®ä¸è´æ§\n\n\n# 2.1 åªäºæåµä¼å¯¼è´æ°æ®ä¸ä¸è´ ï¼\n\n * æä»¬åè®¾åºç¨åå é¤ç¼å­ï¼åæ´æ°æ°æ®åºï¼å¦æç¼å­å é¤æåï¼ä½æ¯æ°æ®åºæ´æ°å¤±è´¥ï¼é£ä¹ï¼åºç¨åè®¿é®æ°æ®æ¶ï¼ç¼å­ä¸­æ²¡ææ°æ®ï¼å°±ä¼åçç¼å­ç¼ºå¤±ãç¶åï¼åºç¨åè®¿é®æ°æ®åºï¼ä½æ¯æ°æ®åºä¸­çå¼ä¸ºæ§å¼ï¼åºç¨å°±è®¿é®å°æ§å¼äºã\n\n * å¦æåºç¨åå®æäºæ°æ®åºçæ´æ°ï¼ä½æ¯ï¼å¨å é¤ç¼å­æ¶å¤±è´¥äºï¼é£ä¹ï¼æ°æ®åºä¸­çå¼æ¯æ°å¼ï¼èç¼å­ä¸­çæ¯æ§å¼ï¼è¿è¯å®æ¯ä¸ä¸è´çãè¿ä¸ªæ¶åï¼å¦ææå¶ä»çå¹¶åè¯·æ±æ¥è®¿é®æ°æ®ï¼æç§æ­£å¸¸çç¼å­è®¿é®æµç¨ï¼å°±ä¼åå¨ç¼å­ä¸­æ¥è¯¢ï¼ä½æ­¤æ¶ï¼å°±ä¼è¯»å°æ§å¼äºã\n\n\n\n\n# 2.3 éå+éè¯æºå¶\n\nå¯ä»¥æè¦å é¤çç¼å­å¼æèæ¯è¦æ´æ°çæ°æ®åºå¼æå­å°æ¶æ¯éåä¸­ï¼ä¾å¦ä½¿ç¨ Kafka æ¶æ¯éåï¼ãå½åºç¨æ²¡æè½å¤æåå°å é¤ç¼å­å¼æèæ¯æ´æ°æ°æ®åºå¼æ¶ï¼å¯ä»¥ä»æ¶æ¯éåä¸­éæ°è¯»åè¿äºå¼ï¼ç¶ååæ¬¡è¿è¡å é¤ææ´æ°ã\n\nå¦æè½å¤æåå°å é¤ææ´æ°ï¼æä»¬å°±è¦æè¿äºå¼ä»æ¶æ¯éåä¸­å»é¤ï¼ä»¥åéå¤æä½\n\nä½æ¯å¨å¹¶åæåµä¸ï¼æ è®ºæ¯åå æ°æ®åºè¿æ¯åå ç¼å­æä½å¤±è´¥çæåµä¸ï¼è¿æ¯ä¼æè¯»åå°ä¸ä¸è´æ°æ®çæåµã\n\n * æåµä¸ï¼åå é¤ç¼å­ï¼åæ´æ°æ°æ®åºã\n\nå¨æ´æ°æ°æ®åºå¤±è´¥çæåµä¸ï¼å¦ä¸ä¸ªçº¿ç¨è¿æ¥è¯»åæ°æ®ï¼åç°ç¼å­ç¼ºå¤±ï¼æ¥è¯¢æ°æ®åºçæ°æ®ï¼å¹¶æ´æ°å°ç¼å­ä¸­ï¼æç»ç¼å­ä¸­å­å¨çæ¯æ§çæ°æ®ã\n\nå»¶è¿åå \n\nå¨çº¿ç¨ A æ´æ°å®æ°æ®åºçå¼ä»¥åï¼åè®©å® sleep ä¸ä¼å¿ï¼åå é¤ç¼å­ãç®çæ¯ä¸ºäºè®©çº¿ç¨ B å¯ä»¥å°æ°æ®åºçå¼åå¥å°ç¼å­ä¸­ï¼ç¶ååå é¤å®ã ä¼ªä»£ç å¦ä¸ï¼\n\nredis.delKey(X)\ndb.update(X)\nThread.sleep(N)\nredis.delKey(X)\n\n\n1\n2\n3\n4\n\n\nç½ä¸æä½¿ç¨è¿ç§æ¹æ¡æ¥è§£å³ï¼ä¸ªäººæ¯ä¸æ¨èè¿ç§æ¹æ¡ï¼å¨é«å¹¶åçæåµä¸ï¼è¿ä¸ª sleep æ¶é´ä¸å¥½ç¡®å®ï¼å¹¶ä¸ç¥éå¶ä»çº¿ç¨ä»ä¹æ¶åæ§è¡åç»æã\n\n * æåµäºï¼åæ´æ°æ°æ®åºå¼ï¼åå é¤ç¼å­å¼ã\n\nå¨å é¤ç¼å­å¼å¤±è´¥çæåµä¸ï¼å¹¶åæ¶ï¼ä¼æå¤ä¸ªçº¿ç¨æ¿å°æ§çæ°æ®æåµã\n\nè¿ä¸¤ç§å¹¶ååºæ¯ï¼ä¸ªäººæè§å¯ä¸çåæ³å°±æ¯ä½¿ç¨åæ­¥æ¥å®æè¿ä¸¤ä¸ªæä½ï¼å¯ä»¥ä½¿ç¨åå¸å¼éæèå¶ä»ã\n\n\n# 3. æ·æ±°ç­ç¥\n\nç¼å­çå®¹éæ¯æéçï¼é£ä¹å½ç¼å­æ»¡äºï¼å¯ä»¥æ¯ç¨æ·æ±°ç­ç¥æ¥å°é¨åæ°æ®æ·æ±°ã\n\nç¼å­è®¾ç½®æå¤å¤§æ¯è¾åéï¼ æç§äºå«åçï¼ä¸è¬ 20%æ°æ®ä¼å ç¨ 80%çè®¿é®ï¼æä»¥å»ºè®®å°ç¼å­çå®¹éè®¾ç½®ä¸ºæ»æ°æ®éç 15%æè 30%ä¼æ¯è¾åçã\n\næ·æ±°ç­ç¥æåªäº?\n\n * ä¸æ·æ±°\n   * noevictionï¼å¦æç¼å­å·²æ»¡åæåè¯·æ±ï¼åè¿åéè¯¯\n * å¯¹è®¾ç½®è¿ææ¶é´çæ°æ®è¿è¡æ·æ±°\n   * volatile-ttl å¨ç­éæ¶ï¼ä¼éå¯¹è®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ï¼æ ¹æ®è¿ææ¶é´çååè¿è¡å é¤ï¼è¶æ©è¿æçè¶åè¢«å é¤ã\n   * volatile-random å°±åå®çåç§°ä¸æ ·ï¼å¨è®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ä¸­ï¼è¿è¡éæºå é¤ã\n   * volatile-lru ä¼ä½¿ç¨ LRU ç®æ³ç­éè®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ã\n   * volatile-lfu ä¼ä½¿ç¨ LFU ç®æ³éæ©è®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ã\n * å¯¹æææ°æ®è¿è¡æ·æ±°\n   * allkeys-random ç­ç¥ï¼ä»ææé®å¼å¯¹ä¸­éæºéæ©å¹¶å é¤æ°æ®ï¼\n   * allkeys-lru ç­ç¥ï¼ä½¿ç¨ LRU ç®æ³å¨æææ°æ®ä¸­è¿è¡ç­éã\n   * allkeys-lfu ç­ç¥ï¼ä½¿ç¨ LFU ç®æ³å¨æææ°æ®ä¸­è¿è¡ç­éã\n\n\n# 4. ç¼å­éªå´©\n\nç¼å­éªå´©æ¯æå¤§éçåºç¨è¯·æ±æ æ³å¨ Redis ç¼å­ä¸­è¿è¡å¤çï¼ç´§æ¥çï¼åºç¨å°å¤§éè¯·æ±åéå°æ°æ®åºå±ï¼å¯¼è´æ°æ®åºå±çååæ¿å¢ã\n\näº§ççåå \n\n * ç¼å­ä¸­æå¤§éæ°æ®åæ¶è¿æï¼å¯¼è´å¤§éè¯·æ±æ æ³å¾å°å¤ç\n * redisæå¡å®æº\n\nåçåææè§£å³åæ³\n\n 1. æ¯å¨ä¸å¡ç³»ç»ä¸­å®ç°æå¡çæ­æè¯·æ±éæµæºå¶ã\n\n\n\n 2. æå¡éçº§ãéæ ¸å¿æ°æ®ï¼ç´æ¥è¿åé¢å®ä¹ä¿¡æ¯ï¼éè¯¯æç©ºå¼ãæ ¸å¿ä¸å¡ä»ç¶æ¥è¯¢ç¼å­ãåå°æ°æ®åºåå\n\næåé¢é²\n\nä¸é¢çé½æ¯åçåææçè§£å³æªæ½ï¼æä»¥æå¥½çåæ³æ¯æåé¢é²ï¼è®©å®ä¸è¦åçã\n\n 1. é¿åå¤§éæ°æ®è®¾ç½®ç¸åç¹é¢è¿ææ¶é´ï¼å¦ææï¼å¯ä»¥å ä¸ªéæºæ°ã\n 2. æ­å»ºé«å¯ç¨éç¾¤ï¼ä¸»èç¹æéå®æºï¼ä»èç¹å¯ä»¥åæ¢æä¸»èç¹ï¼ç»§ç»­æä¾ç¼å­æå¡ã\n\n\n# 5. ç¼å­å»ç©¿\n\nç¼å­å»ç©¿æ¯æï¼éå¯¹æä¸ªè®¿é®éå¸¸é¢ç¹çç­ç¹æ°æ®çè¯·æ±ï¼æ æ³å¨ç¼å­ä¸­è¿è¡å¤çï¼ç´§æ¥çï¼è®¿é®è¯¥æ°æ®çå¤§éè¯·æ±ï¼ä¸ä¸å­é½åéå°äºåç«¯æ°æ®åºï¼å¯¼è´äºæ°æ®åºååæ¿å¢ï¼ä¼å½±åæ°æ®åºå¤çå¶ä»è¯·æ±ãç¼å­å»ç©¿çæåµï¼ç»å¸¸åçå¨ç­ç¹æ°æ®è¿æå¤±ææ¶\n\n\n\näº§ççåå \n\n * ç­ç¹æ°æ®åçè¿æè¢«æ·æ±°å¯¼è´è®¿é®åç«¯æ°æ®åº\n\nåçåææçè§£å³åæ³\n\n * æ¥å£éæµä¸çæ­ï¼éçº§ã\n\næåé¢é²\n\n * è®¾ç½®ç­ç¹æ°æ®æ°¸è¿ä¸è¿æã\n\n\n# 6. ç¼å­ç©¿é\n\nç¼å­ç©¿éæ¯æè¦è®¿é®çæ°æ®æ¢ä¸å¨ Redis ç¼å­ä¸­ï¼ä¹ä¸å¨æ°æ®åºä¸­ï¼å¯¼è´è¯·æ±å¨è®¿é®ç¼å­æ¶ï¼åçç¼å­ç¼ºå¤±ï¼åå»è®¿é®æ°æ®åºæ¶ï¼åç°æ°æ®åºä¸­ä¹æ²¡æè¦è®¿é®çæ°æ®ã\n\näº§ççåå \n\n * ä¸å¡å±è¯¯æä½ï¼ç¼å­ä¸­çæ°æ®åæ°æ®åºä¸­çæ°æ®è¢«è¯¯å é¤äºï¼æä»¥ç¼å­åæ°æ®åºä¸­é½æ²¡ææ°æ®ï¼\n * æ¶ææ»å»ï¼ä¸é¨è®¿é®æ°æ®åºä¸­æ²¡æçæ°æ®ã\n\n\n\nåºå¯¹æ¹æ¡\n\n * å¨è¯·æ±å¥å£ååæ³æ§æ ¡éªï¼ææ¶æè¯·æ±è¿æ»¤æã\n * å¸éè¿æ»¤å¨ï¼å¿«éæ ¡éªæ°æ®æ¯å¦å­å¨ï¼é¿åä»æ°æ®åºä¸­æ¥è¯¢æ°æ®æ¯å¦å­å¨ï¼åè½»æ°æ®åºååã\n * ä¸æ¦åçæ°æ®ä¸å­å¨çæåµï¼å¯ä»¥ç¼å­ä¸ä¸ªç¼ºçå¼ï¼ä¸æ¬¡è¿ä½¿ç¨è¯¥ ID è®¿é®æ¶ï¼å¯ä»¥è¿åç¼ºçå¼ã\n\n\n# 7. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",normalizedContent:"# 1. åè¨\n\nreids æ¯åºäºåå­çæ°æ®åºï¼å®çç¹æ§ä¹ä¸å°±å¿«ï¼ç¼å­æ¯å¶æä¸»è¦çåºç¨åºæ¯ï¼æ¬æä¸»è¦ä»ç» redis çç¼å­ç¹æ§ï¼ä»¥åè¯¥å¦ä½æ­£ç¡®çä½¿ç¨å®ã\n\n\n# 2. ç¼å­ç±»å\n\n\n# 2.1 åªè¯»ç¼å­\n\nå½åå¥æ°æ®æ¶ï¼ç´æ¥æä½åç«¯æ°æ®åºï¼è¿è¡å¢å æ¹ãå åæ¹æä½ï¼å¦æ redis å·²ç»ç¼å­äºå¯¹åºçæ°æ®ï¼åéè¦è¿è¡å é¤ãå½åºç¨è¯»åæ°æ®æ¶ï¼åçç¼å­ç¼ºå¤±ï¼åä¼ä»åç«¯æ°æ®åºè¯»åå° redis ä¸­ä½¿ç¨ã\n\n\n\nå¥½å¤æ¯ææçæ°æ®é½å¨åç«¯æ°æ®åºä¸­ï¼èåç«¯æ°æ®æä¾å¯é æ§ä¿éï¼ä¸ä¼æä¸¢å¤±æ°æ®çé£é©ã\n\n\n# 2.2 è¯»åç¼å­\n\nææ°çæ°æ®å¨ redis ä¸­ãå¨åå¥æ°æ®æ¶ï¼ä¼ååå¥å° redisï¼å¹¶ä¸å ä¸ºç¼å­çé«æ§è½è®¿é®ï¼å¯ä»¥å¿«éè¿åç»ä¸å¡åºç¨ã\n\nä½æ¯ç±äº redis æ¯åå­æ°æ®åºå­å¨æ°æ®ä¸¢å¤±çé£é©ï¼æä»¥è¿æ¯éè¦åå¥å°åç«¯æ°æ®åºä¸­ä¿è¯å¯é æ§ãæä¸¤ç§åå¥ç­ç¥ï¼\n\n * åæ­¥ç´åï¼å¨å redis æ¶ï¼åæ­¥åå¥å°åç«¯æ°æ®åºï¼å®æååè¿åç»ä¸å¡ãä¼å¢å ååºå»¶è¿ã\n * å¼æ­¥ç´åï¼ç­å¾å¢æ¹çæ°æ®è¦è¢«ä»ç¼å­æ·æ±°æ¶ãååååç«¯æ°æ®åºã\n\n\n\n\n# 2. ç¼å­åæ°æ®åºçæ°æ®ä¸è´æ§\n\n\n# 2.1 åªäºæåµä¼å¯¼è´æ°æ®ä¸ä¸è´ ï¼\n\n * æä»¬åè®¾åºç¨åå é¤ç¼å­ï¼åæ´æ°æ°æ®åºï¼å¦æç¼å­å é¤æåï¼ä½æ¯æ°æ®åºæ´æ°å¤±è´¥ï¼é£ä¹ï¼åºç¨åè®¿é®æ°æ®æ¶ï¼ç¼å­ä¸­æ²¡ææ°æ®ï¼å°±ä¼åçç¼å­ç¼ºå¤±ãç¶åï¼åºç¨åè®¿é®æ°æ®åºï¼ä½æ¯æ°æ®åºä¸­çå¼ä¸ºæ§å¼ï¼åºç¨å°±è®¿é®å°æ§å¼äºã\n\n * å¦æåºç¨åå®æäºæ°æ®åºçæ´æ°ï¼ä½æ¯ï¼å¨å é¤ç¼å­æ¶å¤±è´¥äºï¼é£ä¹ï¼æ°æ®åºä¸­çå¼æ¯æ°å¼ï¼èç¼å­ä¸­çæ¯æ§å¼ï¼è¿è¯å®æ¯ä¸ä¸è´çãè¿ä¸ªæ¶åï¼å¦ææå¶ä»çå¹¶åè¯·æ±æ¥è®¿é®æ°æ®ï¼æç§æ­£å¸¸çç¼å­è®¿é®æµç¨ï¼å°±ä¼åå¨ç¼å­ä¸­æ¥è¯¢ï¼ä½æ­¤æ¶ï¼å°±ä¼è¯»å°æ§å¼äºã\n\n\n\n\n# 2.3 éå+éè¯æºå¶\n\nå¯ä»¥æè¦å é¤çç¼å­å¼æèæ¯è¦æ´æ°çæ°æ®åºå¼æå­å°æ¶æ¯éåä¸­ï¼ä¾å¦ä½¿ç¨ kafka æ¶æ¯éåï¼ãå½åºç¨æ²¡æè½å¤æåå°å é¤ç¼å­å¼æèæ¯æ´æ°æ°æ®åºå¼æ¶ï¼å¯ä»¥ä»æ¶æ¯éåä¸­éæ°è¯»åè¿äºå¼ï¼ç¶ååæ¬¡è¿è¡å é¤ææ´æ°ã\n\nå¦æè½å¤æåå°å é¤ææ´æ°ï¼æä»¬å°±è¦æè¿äºå¼ä»æ¶æ¯éåä¸­å»é¤ï¼ä»¥åéå¤æä½\n\nä½æ¯å¨å¹¶åæåµä¸ï¼æ è®ºæ¯åå æ°æ®åºè¿æ¯åå ç¼å­æä½å¤±è´¥çæåµä¸ï¼è¿æ¯ä¼æè¯»åå°ä¸ä¸è´æ°æ®çæåµã\n\n * æåµä¸ï¼åå é¤ç¼å­ï¼åæ´æ°æ°æ®åºã\n\nå¨æ´æ°æ°æ®åºå¤±è´¥çæåµä¸ï¼å¦ä¸ä¸ªçº¿ç¨è¿æ¥è¯»åæ°æ®ï¼åç°ç¼å­ç¼ºå¤±ï¼æ¥è¯¢æ°æ®åºçæ°æ®ï¼å¹¶æ´æ°å°ç¼å­ä¸­ï¼æç»ç¼å­ä¸­å­å¨çæ¯æ§çæ°æ®ã\n\nå»¶è¿åå \n\nå¨çº¿ç¨ a æ´æ°å®æ°æ®åºçå¼ä»¥åï¼åè®©å® sleep ä¸ä¼å¿ï¼åå é¤ç¼å­ãç®çæ¯ä¸ºäºè®©çº¿ç¨ b å¯ä»¥å°æ°æ®åºçå¼åå¥å°ç¼å­ä¸­ï¼ç¶ååå é¤å®ã ä¼ªä»£ç å¦ä¸ï¼\n\nredis.delkey(x)\ndb.update(x)\nthread.sleep(n)\nredis.delkey(x)\n\n\n1\n2\n3\n4\n\n\nç½ä¸æä½¿ç¨è¿ç§æ¹æ¡æ¥è§£å³ï¼ä¸ªäººæ¯ä¸æ¨èè¿ç§æ¹æ¡ï¼å¨é«å¹¶åçæåµä¸ï¼è¿ä¸ª sleep æ¶é´ä¸å¥½ç¡®å®ï¼å¹¶ä¸ç¥éå¶ä»çº¿ç¨ä»ä¹æ¶åæ§è¡åç»æã\n\n * æåµäºï¼åæ´æ°æ°æ®åºå¼ï¼åå é¤ç¼å­å¼ã\n\nå¨å é¤ç¼å­å¼å¤±è´¥çæåµä¸ï¼å¹¶åæ¶ï¼ä¼æå¤ä¸ªçº¿ç¨æ¿å°æ§çæ°æ®æåµã\n\nè¿ä¸¤ç§å¹¶ååºæ¯ï¼ä¸ªäººæè§å¯ä¸çåæ³å°±æ¯ä½¿ç¨åæ­¥æ¥å®æè¿ä¸¤ä¸ªæä½ï¼å¯ä»¥ä½¿ç¨åå¸å¼éæèå¶ä»ã\n\n\n# 3. æ·æ±°ç­ç¥\n\nç¼å­çå®¹éæ¯æéçï¼é£ä¹å½ç¼å­æ»¡äºï¼å¯ä»¥æ¯ç¨æ·æ±°ç­ç¥æ¥å°é¨åæ°æ®æ·æ±°ã\n\nç¼å­è®¾ç½®æå¤å¤§æ¯è¾åéï¼ æç§äºå«åçï¼ä¸è¬ 20%æ°æ®ä¼å ç¨ 80%çè®¿é®ï¼æä»¥å»ºè®®å°ç¼å­çå®¹éè®¾ç½®ä¸ºæ»æ°æ®éç 15%æè 30%ä¼æ¯è¾åçã\n\næ·æ±°ç­ç¥æåªäº?\n\n * ä¸æ·æ±°\n   * noevictionï¼å¦æç¼å­å·²æ»¡åæåè¯·æ±ï¼åè¿åéè¯¯\n * å¯¹è®¾ç½®è¿ææ¶é´çæ°æ®è¿è¡æ·æ±°\n   * volatile-ttl å¨ç­éæ¶ï¼ä¼éå¯¹è®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ï¼æ ¹æ®è¿ææ¶é´çååè¿è¡å é¤ï¼è¶æ©è¿æçè¶åè¢«å é¤ã\n   * volatile-random å°±åå®çåç§°ä¸æ ·ï¼å¨è®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ä¸­ï¼è¿è¡éæºå é¤ã\n   * volatile-lru ä¼ä½¿ç¨ lru ç®æ³ç­éè®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ã\n   * volatile-lfu ä¼ä½¿ç¨ lfu ç®æ³éæ©è®¾ç½®äºè¿ææ¶é´çé®å¼å¯¹ã\n * å¯¹æææ°æ®è¿è¡æ·æ±°\n   * allkeys-random ç­ç¥ï¼ä»ææé®å¼å¯¹ä¸­éæºéæ©å¹¶å é¤æ°æ®ï¼\n   * allkeys-lru ç­ç¥ï¼ä½¿ç¨ lru ç®æ³å¨æææ°æ®ä¸­è¿è¡ç­éã\n   * allkeys-lfu ç­ç¥ï¼ä½¿ç¨ lfu ç®æ³å¨æææ°æ®ä¸­è¿è¡ç­éã\n\n\n# 4. ç¼å­éªå´©\n\nç¼å­éªå´©æ¯æå¤§éçåºç¨è¯·æ±æ æ³å¨ redis ç¼å­ä¸­è¿è¡å¤çï¼ç´§æ¥çï¼åºç¨å°å¤§éè¯·æ±åéå°æ°æ®åºå±ï¼å¯¼è´æ°æ®åºå±çååæ¿å¢ã\n\näº§ççåå \n\n * ç¼å­ä¸­æå¤§éæ°æ®åæ¶è¿æï¼å¯¼è´å¤§éè¯·æ±æ æ³å¾å°å¤ç\n * redisæå¡å®æº\n\nåçåææè§£å³åæ³\n\n 1. æ¯å¨ä¸å¡ç³»ç»ä¸­å®ç°æå¡çæ­æè¯·æ±éæµæºå¶ã\n\n\n\n 2. æå¡éçº§ãéæ ¸å¿æ°æ®ï¼ç´æ¥è¿åé¢å®ä¹ä¿¡æ¯ï¼éè¯¯æç©ºå¼ãæ ¸å¿ä¸å¡ä»ç¶æ¥è¯¢ç¼å­ãåå°æ°æ®åºåå\n\næåé¢é²\n\nä¸é¢çé½æ¯åçåææçè§£å³æªæ½ï¼æä»¥æå¥½çåæ³æ¯æåé¢é²ï¼è®©å®ä¸è¦åçã\n\n 1. é¿åå¤§éæ°æ®è®¾ç½®ç¸åç¹é¢è¿ææ¶é´ï¼å¦ææï¼å¯ä»¥å ä¸ªéæºæ°ã\n 2. æ­å»ºé«å¯ç¨éç¾¤ï¼ä¸»èç¹æéå®æºï¼ä»èç¹å¯ä»¥åæ¢æä¸»èç¹ï¼ç»§ç»­æä¾ç¼å­æå¡ã\n\n\n# 5. ç¼å­å»ç©¿\n\nç¼å­å»ç©¿æ¯æï¼éå¯¹æä¸ªè®¿é®éå¸¸é¢ç¹çç­ç¹æ°æ®çè¯·æ±ï¼æ æ³å¨ç¼å­ä¸­è¿è¡å¤çï¼ç´§æ¥çï¼è®¿é®è¯¥æ°æ®çå¤§éè¯·æ±ï¼ä¸ä¸å­é½åéå°äºåç«¯æ°æ®åºï¼å¯¼è´äºæ°æ®åºååæ¿å¢ï¼ä¼å½±åæ°æ®åºå¤çå¶ä»è¯·æ±ãç¼å­å»ç©¿çæåµï¼ç»å¸¸åçå¨ç­ç¹æ°æ®è¿æå¤±ææ¶\n\n\n\näº§ççåå \n\n * ç­ç¹æ°æ®åçè¿æè¢«æ·æ±°å¯¼è´è®¿é®åç«¯æ°æ®åº\n\nåçåææçè§£å³åæ³\n\n * æ¥å£éæµä¸çæ­ï¼éçº§ã\n\næåé¢é²\n\n * è®¾ç½®ç­ç¹æ°æ®æ°¸è¿ä¸è¿æã\n\n\n# 6. ç¼å­ç©¿é\n\nç¼å­ç©¿éæ¯æè¦è®¿é®çæ°æ®æ¢ä¸å¨ redis ç¼å­ä¸­ï¼ä¹ä¸å¨æ°æ®åºä¸­ï¼å¯¼è´è¯·æ±å¨è®¿é®ç¼å­æ¶ï¼åçç¼å­ç¼ºå¤±ï¼åå»è®¿é®æ°æ®åºæ¶ï¼åç°æ°æ®åºä¸­ä¹æ²¡æè¦è®¿é®çæ°æ®ã\n\näº§ççåå \n\n * ä¸å¡å±è¯¯æä½ï¼ç¼å­ä¸­çæ°æ®åæ°æ®åºä¸­çæ°æ®è¢«è¯¯å é¤äºï¼æä»¥ç¼å­åæ°æ®åºä¸­é½æ²¡ææ°æ®ï¼\n * æ¶ææ»å»ï¼ä¸é¨è®¿é®æ°æ®åºä¸­æ²¡æçæ°æ®ã\n\n\n\nåºå¯¹æ¹æ¡\n\n * å¨è¯·æ±å¥å£ååæ³æ§æ ¡éªï¼ææ¶æè¯·æ±è¿æ»¤æã\n * å¸éè¿æ»¤å¨ï¼å¿«éæ ¡éªæ°æ®æ¯å¦å­å¨ï¼é¿åä»æ°æ®åºä¸­æ¥è¯¢æ°æ®æ¯å¦å­å¨ï¼åè½»æ°æ®åºååã\n * ä¸æ¦åçæ°æ®ä¸å­å¨çæåµï¼å¯ä»¥ç¼å­ä¸ä¸ªç¼ºçå¼ï¼ä¸æ¬¡è¿ä½¿ç¨è¯¥ id è®¿é®æ¶ï¼å¯ä»¥è¿åç¼ºçå¼ã\n\n\n# 7. åèæç« \n\n * æ¬æä¸»è¦æ¯å­¦ä¹ ãæå®¢æ¶é´-redis æ ¸å¿ææ¯ä¸å®æãä¸æ æ»ç»èæ¥",charsets:{cjk:!0},lastUpdated:"2023/11/01, 11:48:43",lastUpdatedTimestamp:1698810523e3},{title:"pythonè¿­ä»£å¨ä¸çæå¨",frontmatter:{title:"pythonè¿­ä»£å¨ä¸çæå¨",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/e31b06/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»äºpythonçè¿­ä»£å¨ä¸çæå¨çç¨æ³ä¸åç",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","åºç¡"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604801659428.png#crop=0&crop=0&crop=1&crop=1&id=Wm3Ir&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{name:"twitter:title",content:"pythonè¿­ä»£å¨ä¸çæå¨"},{name:"twitter:description",content:"æ¬æä»ç»äºpythonçè¿­ä»£å¨ä¸çæå¨çç¨æ³ä¸åç"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604801659428.png#crop=0&crop=0&crop=1&crop=1&id=Wm3Ir&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/01.python%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonè¿­ä»£å¨ä¸çæå¨"},{property:"og:description",content:"æ¬æä»ç»äºpythonçè¿­ä»£å¨ä¸çæå¨çç¨æ³ä¸åç"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604801659428.png#crop=0&crop=0&crop=1&crop=1&id=Wm3Ir&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/01.python%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonè¿­ä»£å¨ä¸çæå¨"},{itemprop:"description",content:"æ¬æä»ç»äºpythonçè¿­ä»£å¨ä¸çæå¨çç¨æ³ä¸åç"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604801659428.png#crop=0&crop=0&crop=1&crop=1&id=Wm3Ir&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/01.python%E8%BF%AD%E4%BB%A3%E5%99%A8%E4%B8%8E%E7%94%9F%E6%88%90%E5%99%A8.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/01.pythonè¿­ä»£å¨ä¸çæå¨.md",key:"v-b9336fc4",path:"/pages/e31b06/",headers:[{level:2,title:"è¿­ä»£å¨åå¯è¿­ä»£å¯¹è±¡",slug:"è¿­ä»£å¨åå¯è¿­ä»£å¯¹è±¡",normalizedTitle:"è¿­ä»£å¨åå¯è¿­ä»£å¯¹è±¡",charIndex:2},{level:2,title:"å¦ä½å®ç°è¿­ä»£å¨ï¼",slug:"å¦ä½å®ç°è¿­ä»£å¨",normalizedTitle:"å¦ä½å®ç°è¿­ä»£å¨ï¼",charIndex:146},{level:2,title:"çæå¨åçæå¨å½æ°",slug:"çæå¨åçæå¨å½æ°",normalizedTitle:"çæå¨åçæå¨å½æ°",charIndex:661},{level:3,title:"çæå¨å½æ°åå»ºçæå¨",slug:"çæå¨å½æ°åå»ºçæå¨",normalizedTitle:"çæå¨å½æ°åå»ºçæå¨",charIndex:698},{level:3,title:"çæå¨è¡¨è¾¾å¼åå»ºçæå¨",slug:"çæå¨è¡¨è¾¾å¼åå»ºçæå¨",normalizedTitle:"çæå¨è¡¨è¾¾å¼åå»ºçæå¨",charIndex:1146}],headersStr:"è¿­ä»£å¨åå¯è¿­ä»£å¯¹è±¡ å¦ä½å®ç°è¿­ä»£å¨ï¼ çæå¨åçæå¨å½æ° çæå¨å½æ°åå»ºçæå¨ çæå¨è¡¨è¾¾å¼åå»ºçæå¨",content:'# è¿­ä»£å¨åå¯è¿­ä»£å¯¹è±¡\n\nå®ç°äº__iter__çå¯¹è±¡æ¯å¯è¿­ä»£å¯¹è±¡.\n\nå®ç°äº__iter__å__next__çæ¯è¿­ä»£å¨.\n\nä¸¤èä¹é´çå³ç³»: Pythonä»å¯è¿­ä»£çå¯¹è±¡ä¸­è·åè¿­ä»£å¨\n\nå¯è¿­ä»£å¯¹è±¡çæ½è±¡åºç±»æ¯abc.Iterable è¿­ä»£å¨çæ½è±¡åºç±»æ¯abc.Iterator\n\n\n\n\n# å¦ä½å®ç°è¿­ä»£å¨ï¼\n\nå®ä¹__iter__æ¹æ³è¿åå¸¦æ__next__æ¹æ³çå¯¹è±¡ï¼__iter__å¯ä»¥ç®åçè¿åself.\n\nå½æ²¡ææ°æ®è¿åæ¶ï¼ä¼æåºStopIterationå¼å¸¸åæ­¢è¿åæ°æ®ã\n\n\nclass MyIter():\n    def __init__(self, data):\n        self.data = data\n        self.index = len(data)\n\n    def __iter__(self):\n        return self\n\n    def __next__(self):\n        if self.index == 0:\n            raise StopIteration\n        \n        self.index = self.index - 1\n        return self.data[self.index]\n\nmy_iter = MyIter()\niter(my_iter)   # è¿åä¸ä¸ªè¿­ä»£å¨\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\n\n# çæå¨åçæå¨å½æ°\n\nå½æ°ä¸­æyieldå³é®å­çï¼å°±æ¯çæå¨å½æ°\n\n\n# çæå¨å½æ°åå»ºçæå¨\n\nä¸é¢ç__iter__æ¯ä¸ä¸ªçæå¨å½æ°ï¼éè¿è¯¥çæå¨å½æ°åå»ºçæå¨å¯¹è±¡ï¼åè£çæå¨å½æ°çå®ä¹ãæçæå¨ä¼ ç»next(...)å½æ°æ¶ï¼çæå¨å½æ°ä¼ååï¼æ§è¡å½æ°å®ä¹ä½ä¸­çä¸ä¸ä¸ªyieldè¯­å¥ï¼è¿åäº§åºçå¼ï¼å¹¶å¨å½æ°å®ä¹ä½çå½åä½ç½®æåãå½æ æ°æ®è¿åæ¶ï¼çæå¨å¯¹è±¡ä¼æåºStopIterationå¼å¸¸ã\n\n\n\nä¾å­:\n\n\nimport re\nimport reprlib\n\nRE_WORD = re.compile("\\w+")\n\nclass Sentence:\n    def __init__(self, text):\n        self.text = text\n        \n    def __iter__(self):\n        for match in RE_WORD.finditer(self.text):\n            yield matc.group()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# çæå¨è¡¨è¾¾å¼åå»ºçæå¨\n\nçæå¨è¡¨è¾¾å¼å¯ä»¥çè§£ä¸ºåè¡¨æ¨å¯¼çæ°æ§çæ¬: ä¸ä¼è¿«åå°æå»ºåè¡¨ï¼èæ¯è¿åä¸ä¸ªçæå¨ï¼æéæ°æ§çæåç´ ã\n\nåè¡¨è¡¨è¾¾å¼ã ä¼é©¬ä¸å è½½ææçåç´ å°åå­ä¸­\n\n[i for i in range(10)]\n\n\n1\n\n\nçæå¨è¡¨è¾¾å¼: ä¼å¾å°ä¸ä¸ªçæå¨å¯¹è±¡ï¼å¯ä»¥éè¿nextæèå¾ªç¯çæ¹å¼æ°æ§æ±å¼ã\n\n(i for i in range(10))\n\n\n1\n\n\nè½ç¶ä¸é¢ç__iter__æ²¡æyieldå³é®å­ï¼ä½æ¯å´æå·æçæå¨è¡¨è¾¾å¼ï¼æä»¥__iter__å¾å°çä¹æ¯ä¸ä¸ªçæå¨å¯¹è±¡ã\n\nä¾å­:\n\nclass A:\n    def __iter__(self):\n        return (x*3 for x in range(10))\n\n\n1\n2\n3\n',normalizedContent:'# è¿­ä»£å¨åå¯è¿­ä»£å¯¹è±¡\n\nå®ç°äº__iter__çå¯¹è±¡æ¯å¯è¿­ä»£å¯¹è±¡.\n\nå®ç°äº__iter__å__next__çæ¯è¿­ä»£å¨.\n\nä¸¤èä¹é´çå³ç³»: pythonä»å¯è¿­ä»£çå¯¹è±¡ä¸­è·åè¿­ä»£å¨\n\nå¯è¿­ä»£å¯¹è±¡çæ½è±¡åºç±»æ¯abc.iterable è¿­ä»£å¨çæ½è±¡åºç±»æ¯abc.iterator\n\n\n\n\n# å¦ä½å®ç°è¿­ä»£å¨ï¼\n\nå®ä¹__iter__æ¹æ³è¿åå¸¦æ__next__æ¹æ³çå¯¹è±¡ï¼__iter__å¯ä»¥ç®åçè¿åself.\n\nå½æ²¡ææ°æ®è¿åæ¶ï¼ä¼æåºstopiterationå¼å¸¸åæ­¢è¿åæ°æ®ã\n\n\nclass myiter():\n    def __init__(self, data):\n        self.data = data\n        self.index = len(data)\n\n    def __iter__(self):\n        return self\n\n    def __next__(self):\n        if self.index == 0:\n            raise stopiteration\n        \n        self.index = self.index - 1\n        return self.data[self.index]\n\nmy_iter = myiter()\niter(my_iter)   # è¿åä¸ä¸ªè¿­ä»£å¨\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\n\n# çæå¨åçæå¨å½æ°\n\nå½æ°ä¸­æyieldå³é®å­çï¼å°±æ¯çæå¨å½æ°\n\n\n# çæå¨å½æ°åå»ºçæå¨\n\nä¸é¢ç__iter__æ¯ä¸ä¸ªçæå¨å½æ°ï¼éè¿è¯¥çæå¨å½æ°åå»ºçæå¨å¯¹è±¡ï¼åè£çæå¨å½æ°çå®ä¹ãæçæå¨ä¼ ç»next(...)å½æ°æ¶ï¼çæå¨å½æ°ä¼ååï¼æ§è¡å½æ°å®ä¹ä½ä¸­çä¸ä¸ä¸ªyieldè¯­å¥ï¼è¿åäº§åºçå¼ï¼å¹¶å¨å½æ°å®ä¹ä½çå½åä½ç½®æåãå½æ æ°æ®è¿åæ¶ï¼çæå¨å¯¹è±¡ä¼æåºstopiterationå¼å¸¸ã\n\n\n\nä¾å­:\n\n\nimport re\nimport reprlib\n\nre_word = re.compile("\\w+")\n\nclass sentence:\n    def __init__(self, text):\n        self.text = text\n        \n    def __iter__(self):\n        for match in re_word.finditer(self.text):\n            yield matc.group()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# çæå¨è¡¨è¾¾å¼åå»ºçæå¨\n\nçæå¨è¡¨è¾¾å¼å¯ä»¥çè§£ä¸ºåè¡¨æ¨å¯¼çæ°æ§çæ¬: ä¸ä¼è¿«åå°æå»ºåè¡¨ï¼èæ¯è¿åä¸ä¸ªçæå¨ï¼æéæ°æ§çæåç´ ã\n\nåè¡¨è¡¨è¾¾å¼ã ä¼é©¬ä¸å è½½ææçåç´ å°åå­ä¸­\n\n[i for i in range(10)]\n\n\n1\n\n\nçæå¨è¡¨è¾¾å¼: ä¼å¾å°ä¸ä¸ªçæå¨å¯¹è±¡ï¼å¯ä»¥éè¿nextæèå¾ªç¯çæ¹å¼æ°æ§æ±å¼ã\n\n(i for i in range(10))\n\n\n1\n\n\nè½ç¶ä¸é¢ç__iter__æ²¡æyieldå³é®å­ï¼ä½æ¯å´æå·æçæå¨è¡¨è¾¾å¼ï¼æä»¥__iter__å¾å°çä¹æ¯ä¸ä¸ªçæå¨å¯¹è±¡ã\n\nä¾å­:\n\nclass a:\n    def __iter__(self):\n        return (x*3 for x in range(10))\n\n\n1\n2\n3\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pythonåç¼ç¨",frontmatter:{title:"pythonåç¼ç¨",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/5fa368/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»pythonä¸­åç¼ç¨çå±æ§åä½¿ç¨æ¹æ³",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","åºç¡"],comment:!0,meta:[{name:"twitter:title",content:"pythonåç¼ç¨"},{name:"twitter:description",content:"æ¬æä»ç»pythonä¸­åç¼ç¨çå±æ§åä½¿ç¨æ¹æ³"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/02.python%E5%85%83%E7%BC%96%E7%A8%8B.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonåç¼ç¨"},{property:"og:description",content:"æ¬æä»ç»pythonä¸­åç¼ç¨çå±æ§åä½¿ç¨æ¹æ³"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/02.python%E5%85%83%E7%BC%96%E7%A8%8B.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonåç¼ç¨"},{itemprop:"description",content:"æ¬æä»ç»pythonä¸­åç¼ç¨çå±æ§åä½¿ç¨æ¹æ³"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/02.python%E5%85%83%E7%BC%96%E7%A8%8B.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/02.pythonåç¼ç¨.md",key:"v-300c8022",path:"/pages/5fa368/",headers:[{level:2,title:"propertyå¨æå±æ§",slug:"propertyå¨æå±æ§",normalizedTitle:"propertyå¨æå±æ§",charIndex:2},{level:2,title:"_getattribute å getattr_",slug:"getattribute-å-getattr",normalizedTitle:"<em>getattribute å getattr</em>",charIndex:null},{level:2,title:"å±æ§æè¿°ç¬¦",slug:"å±æ§æè¿°ç¬¦",normalizedTitle:"å±æ§æè¿°ç¬¦",charIndex:744},{level:3,title:"å±æ§æè¿°ç¬¦æ¥æ¾è¿ç¨",slug:"å±æ§æè¿°ç¬¦æ¥æ¾è¿ç¨",normalizedTitle:"å±æ§æè¿°ç¬¦æ¥æ¾è¿ç¨",charIndex:1032},{level:2,title:"åç±»",slug:"åç±»",normalizedTitle:"åç±»",charIndex:2152},{level:3,title:"éè¿typeåå»ºclass",slug:"éè¿typeåå»ºclass",normalizedTitle:"éè¿typeåå»ºclass",charIndex:2211},{level:3,title:"èªå®ä¹åç±»",slug:"èªå®ä¹åç±»",normalizedTitle:"èªå®ä¹åç±»",charIndex:2588}],headersStr:"propertyå¨æå±æ§ _getattribute å getattr_ å±æ§æè¿°ç¬¦ å±æ§æè¿°ç¬¦æ¥æ¾è¿ç¨ åç±» éè¿typeåå»ºclass èªå®ä¹åç±»",content:'# propertyå¨æå±æ§\n\néè¿ä½¿ç¨propertyå¯ä»¥å°æ¹æ³åå±æ§ä¸æ ·è·åå¼ãä½¿ç¨setterå¯¹æ¹æ³è¿è¡èµå¼æä½\n\n\nfrom datetime import datetime, date\nclass Student:\n\n    def __init__(self, name, birthday):\n        self.name = name\n        self.birthday = birthday\n        self._age = 0\n    \n    @property\n    def age(self):\n        return datetime.now().year - self.birthday.year\n    \n    @age.setter\n    def age(self, value):\n        self._age = value\n    \nstu = Student("zhangsan", date(year=1995, month=3, day=7))\nstu.age = 4\nprint(stu.age)\n\noutput: 24\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\n\n# getattribute å getattr\n\n__getattr__å¨ç±»ä¸­æ¾ä¸å°å±æ§æ¶ï¼è°ç¨è¯¥å½æ°ã __getattribute__é¦åè°ç¨è¯¥å½æ°ï¼ç¶åæ¾å±æ§.\n\nå¨__getattribute__ä¸­æåºAttributeErroræ¶ï¼ä¼è°ç¨__getattr__\n\nè°ç¨é¡ºåº __getattribute__ > __getattr__\n\n\n# å±æ§æè¿°ç¬¦\n\nå¨ç±»ä¸­åªè¦å®ç°äº__get__ã__set__ã__delete__æ¹æ³ä¸­çä¸ä¸ªå°±è®¤ä¸ºæ¯æè¿°ç¬¦. åªå®ç°äº__get__çå¯¹è±¡æ¯éæ°æ®æè¿°ç¬¦. åªè¯» å®ç°äº__get__å__set__çå¯¹è±¡æ¯æ°æ®æè¿°ç¬¦. å¯è¯»å¯å.\n\nclass IntField:\n    def __get__(self):\n        pass\n        \n    def __set__(self):\n        pass\n        \n    def __delete__(self):\n        pass\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å±æ§æè¿°ç¬¦æ¥æ¾è¿ç¨\n\nå±æ§æè¿°ç¬¦åççè¿ç¨å¨__getattribute__ä¸­.\n\nå¦æageæ¯å±æ§æè¿°ç¬¦ï¼åè°ç¨IntFieldä¸­ç__get__è·å¾å±æ§å¼ï¼å¦æè·åå¤±è´¥ï¼åè°ç¨__dict__è·åå¼ãå¦æageä¸æ¯å±æ§æè¿°ç¬¦ï¼åç´æ¥è·å__dict__å¯¹åºçå¼ã\n\n\nimport numbers\nclass IntField:\n    # æ°æ®æè¿°ç¬¦\n    def __get__(self, instance, owner):\n        return self.value\n        \n    def __set__(self, instance, value):\n        if not isinstance(value, numbers.Integral):\n            raise ValueError("int value need")\n        if value < 0:\n            raise ValueError("positive value need")\n        self.value = value\n        \n    def __delete__(self, instance):\n        pass\n    \nclass NonDataIntField:\n    # éæ°æ®å±æ§æè¿°ç¬¦\n    def __get__(self, instance, owner):\n        return "NonDataIntField = {}".format(self.value)\n\nclass User:\n    age = IntField()\n    #age = NonDataIntField()\n\nuser = User()\nuser.name = "zhangsan"    # nameä¸æ¯å±æ§æè¿°ç¬¦ï¼æä»¥ç´æ¥å å¥å°`__dict__`ä¸­\nprint(user.__dict__)\n\nuser.age = 12               # ageæ¯å±æ§æè¿°ç¬¦, è°ç¨`IntField`ä¸­ç`__set__`æ¹æ³ï¼ èä¸ä¼å å¥å°`__dict__`ä¸­\nprint(user.__dict__)\nprint(user.age)              # è°ç¨`IntField`ä¸­ç`__get__`æ¹æ³\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n\n\n\n# åç±»\n\nåç±»æ¯åå»ºç±»çç±». type -> class -> å¯¹è±¡\n\nææçç±»é½æ¯éè¿typeå®ä¾åå¾å°çã\n\n\n# éè¿typeåå»ºclass\n\nä½¿ç¨typeåå»ºUserç±»ï¼è¯¥ç±»ç»§æ¿Baseç±»ï¼å¹¶ä¸ætestæ¹æ³ånameå±æ§\n\n\nclass Base:\n    def __init__(self, *args, **kwargs):\n        print("Base __init__")\n        super().__init__(*args, **kwargs)\n\ndef test(self):\n    print("test = {}".format(self.name))\n \nUser = type("User", (Base,), {"test": test, "name": "zhangsan"})\nuser = User()\nuser.test()\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# èªå®ä¹åç±»\n\nèªå®ä¹åç±»éè¦éè¿ç»§æ¿typeå®ç°\n\nå¦æç¶ç±»æmetaclassï¼åå­ç±»åç¶ç±»çåå»ºé½éè¦éè¿è¯¥åç±»å®ä¾åå¾å°ã\n\n\n\nclass BaseMeta(type):\n\n    def __new__(cls, name, bases, args, **kwargs):\n        # print(name)\n        # print(bases)\n        # print(args)\n        print("BaseMeta __new__..")\n        \n        if name == "Base":\n            return super().__new__(cls, name, bases, args, **kwargs)\n            \n        meta = args[\'Meta\']\n        name = getattr(meta, "name")    # è·åå°Aä¸­metaçnameçå¼. djangoçormä¹æ¯è¿æ ·å®ç°ç\n        print(name)\n        \n        return super().__new__(cls, name, bases, args, **kwargs)\n\n\n\nclass Base(metaclass=BaseMeta):\n\n    def __new__(cls, *args, **kwargs):\n        print("Base __new__..")\n        return super().__new__(cls, *args, **kwargs)\n        \n    def __init__(self, *args, **kwargs):\n        print("Base init..")\n        super().__init__(*args, **kwargs)\n    \nclass A(Base):\n\n    def __new__(cls, *args, **kwargs):\n        print("A __new__..")\n        return super().__new__(cls, *args, **kwargs)\n        \n    def __init__(self, *args, **kwargs):\n        print("A init..")\n        super().__init__(*args, **kwargs)\n        \n    class Meta:\n        name = "zhangsan"\n\n\n# AåBaseé½ä¼éè¿BaseMetaåå»ºï¼æä»¥ä¼è°ç¨ä¸¤æ¬¡__new__åå»ºå®ä¾\noutput:\n\nBaseMeta __new__..\nBaseMeta __new__..\nzhangsan\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n\n\nåç±»çç»å¸ä¾å­æ¯django ORM',normalizedContent:'# propertyå¨æå±æ§\n\néè¿ä½¿ç¨propertyå¯ä»¥å°æ¹æ³åå±æ§ä¸æ ·è·åå¼ãä½¿ç¨setterå¯¹æ¹æ³è¿è¡èµå¼æä½\n\n\nfrom datetime import datetime, date\nclass student:\n\n    def __init__(self, name, birthday):\n        self.name = name\n        self.birthday = birthday\n        self._age = 0\n    \n    @property\n    def age(self):\n        return datetime.now().year - self.birthday.year\n    \n    @age.setter\n    def age(self, value):\n        self._age = value\n    \nstu = student("zhangsan", date(year=1995, month=3, day=7))\nstu.age = 4\nprint(stu.age)\n\noutput: 24\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\n\n# getattribute å getattr\n\n__getattr__å¨ç±»ä¸­æ¾ä¸å°å±æ§æ¶ï¼è°ç¨è¯¥å½æ°ã __getattribute__é¦åè°ç¨è¯¥å½æ°ï¼ç¶åæ¾å±æ§.\n\nå¨__getattribute__ä¸­æåºattributeerroræ¶ï¼ä¼è°ç¨__getattr__\n\nè°ç¨é¡ºåº __getattribute__ > __getattr__\n\n\n# å±æ§æè¿°ç¬¦\n\nå¨ç±»ä¸­åªè¦å®ç°äº__get__ã__set__ã__delete__æ¹æ³ä¸­çä¸ä¸ªå°±è®¤ä¸ºæ¯æè¿°ç¬¦. åªå®ç°äº__get__çå¯¹è±¡æ¯éæ°æ®æè¿°ç¬¦. åªè¯» å®ç°äº__get__å__set__çå¯¹è±¡æ¯æ°æ®æè¿°ç¬¦. å¯è¯»å¯å.\n\nclass intfield:\n    def __get__(self):\n        pass\n        \n    def __set__(self):\n        pass\n        \n    def __delete__(self):\n        pass\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å±æ§æè¿°ç¬¦æ¥æ¾è¿ç¨\n\nå±æ§æè¿°ç¬¦åççè¿ç¨å¨__getattribute__ä¸­.\n\nå¦æageæ¯å±æ§æè¿°ç¬¦ï¼åè°ç¨intfieldä¸­ç__get__è·å¾å±æ§å¼ï¼å¦æè·åå¤±è´¥ï¼åè°ç¨__dict__è·åå¼ãå¦æageä¸æ¯å±æ§æè¿°ç¬¦ï¼åç´æ¥è·å__dict__å¯¹åºçå¼ã\n\n\nimport numbers\nclass intfield:\n    # æ°æ®æè¿°ç¬¦\n    def __get__(self, instance, owner):\n        return self.value\n        \n    def __set__(self, instance, value):\n        if not isinstance(value, numbers.integral):\n            raise valueerror("int value need")\n        if value < 0:\n            raise valueerror("positive value need")\n        self.value = value\n        \n    def __delete__(self, instance):\n        pass\n    \nclass nondataintfield:\n    # éæ°æ®å±æ§æè¿°ç¬¦\n    def __get__(self, instance, owner):\n        return "nondataintfield = {}".format(self.value)\n\nclass user:\n    age = intfield()\n    #age = nondataintfield()\n\nuser = user()\nuser.name = "zhangsan"    # nameä¸æ¯å±æ§æè¿°ç¬¦ï¼æä»¥ç´æ¥å å¥å°`__dict__`ä¸­\nprint(user.__dict__)\n\nuser.age = 12               # ageæ¯å±æ§æè¿°ç¬¦, è°ç¨`intfield`ä¸­ç`__set__`æ¹æ³ï¼ èä¸ä¼å å¥å°`__dict__`ä¸­\nprint(user.__dict__)\nprint(user.age)              # è°ç¨`intfield`ä¸­ç`__get__`æ¹æ³\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n\n\n\n# åç±»\n\nåç±»æ¯åå»ºç±»çç±». type -> class -> å¯¹è±¡\n\nææçç±»é½æ¯éè¿typeå®ä¾åå¾å°çã\n\n\n# éè¿typeåå»ºclass\n\nä½¿ç¨typeåå»ºuserç±»ï¼è¯¥ç±»ç»§æ¿baseç±»ï¼å¹¶ä¸ætestæ¹æ³ånameå±æ§\n\n\nclass base:\n    def __init__(self, *args, **kwargs):\n        print("base __init__")\n        super().__init__(*args, **kwargs)\n\ndef test(self):\n    print("test = {}".format(self.name))\n \nuser = type("user", (base,), {"test": test, "name": "zhangsan"})\nuser = user()\nuser.test()\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# èªå®ä¹åç±»\n\nèªå®ä¹åç±»éè¦éè¿ç»§æ¿typeå®ç°\n\nå¦æç¶ç±»æmetaclassï¼åå­ç±»åç¶ç±»çåå»ºé½éè¦éè¿è¯¥åç±»å®ä¾åå¾å°ã\n\n\n\nclass basemeta(type):\n\n    def __new__(cls, name, bases, args, **kwargs):\n        # print(name)\n        # print(bases)\n        # print(args)\n        print("basemeta __new__..")\n        \n        if name == "base":\n            return super().__new__(cls, name, bases, args, **kwargs)\n            \n        meta = args[\'meta\']\n        name = getattr(meta, "name")    # è·åå°aä¸­metaçnameçå¼. djangoçormä¹æ¯è¿æ ·å®ç°ç\n        print(name)\n        \n        return super().__new__(cls, name, bases, args, **kwargs)\n\n\n\nclass base(metaclass=basemeta):\n\n    def __new__(cls, *args, **kwargs):\n        print("base __new__..")\n        return super().__new__(cls, *args, **kwargs)\n        \n    def __init__(self, *args, **kwargs):\n        print("base init..")\n        super().__init__(*args, **kwargs)\n    \nclass a(base):\n\n    def __new__(cls, *args, **kwargs):\n        print("a __new__..")\n        return super().__new__(cls, *args, **kwargs)\n        \n    def __init__(self, *args, **kwargs):\n        print("a init..")\n        super().__init__(*args, **kwargs)\n        \n    class meta:\n        name = "zhangsan"\n\n\n# aåbaseé½ä¼éè¿basemetaåå»ºï¼æä»¥ä¼è°ç¨ä¸¤æ¬¡__new__åå»ºå®ä¾\noutput:\n\nbasemeta __new__..\nbasemeta __new__..\nzhangsan\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n\n\nåç±»çç»å¸ä¾å­æ¯django orm',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿",frontmatter:{title:"pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿",date:"2024-10-30T10:34:05.000Z",permalink:"/pages/adedbd/",categories:["ä¸­é´ä»¶","logstash"],tags:["logstash","è®¡ç®æºç½ç»","pular"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨ä½¿ç¨tcpåudpæ¥å¥æ¹å¼æ¥å¥ä¸æ®µæ¶é´æ¥å¿ä¹åï¼æ¥å¿çªç¶æ æ³æ¥å¥äºï¼å¨pulsarä¸­çå¯¹åºtopicæ²¡ææ°çæ¥å¿çäº§è¿æ¥äºã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17302568788191730256878496.png"},{name:"twitter:title",content:"pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿"},{name:"twitter:description",content:"å¨ä½¿ç¨tcpåudpæ¥å¥æ¹å¼æ¥å¥ä¸æ®µæ¶é´æ¥å¿ä¹åï¼æ¥å¿çªç¶æ æ³æ¥å¥äºï¼å¨pulsarä¸­çå¯¹åºtopicæ²¡ææ°çæ¥å¿çäº§è¿æ¥äºã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17302568788191730256878496.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/06.logstash/01.pulsar%E9%98%BB%E5%A1%9E%E5%AF%BC%E8%87%B4logstash%E6%97%A0%E6%B3%95%E6%8E%A5%E5%85%A5%E6%97%A5%E5%BF%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿"},{property:"og:description",content:"å¨ä½¿ç¨tcpåudpæ¥å¥æ¹å¼æ¥å¥ä¸æ®µæ¶é´æ¥å¿ä¹åï¼æ¥å¿çªç¶æ æ³æ¥å¥äºï¼å¨pulsarä¸­çå¯¹åºtopicæ²¡ææ°çæ¥å¿çäº§è¿æ¥äºã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17302568788191730256878496.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/06.logstash/01.pulsar%E9%98%BB%E5%A1%9E%E5%AF%BC%E8%87%B4logstash%E6%97%A0%E6%B3%95%E6%8E%A5%E5%85%A5%E6%97%A5%E5%BF%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2024-10-30T10:34:05.000Z"},{property:"article:tag",content:"logstash"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"pular"},{itemprop:"name",content:"pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿"},{itemprop:"description",content:"å¨ä½¿ç¨tcpåudpæ¥å¥æ¹å¼æ¥å¥ä¸æ®µæ¶é´æ¥å¿ä¹åï¼æ¥å¿çªç¶æ æ³æ¥å¥äºï¼å¨pulsarä¸­çå¯¹åºtopicæ²¡ææ°çæ¥å¿çäº§è¿æ¥äºã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17302568788191730256878496.png"}],readingShow:"top"},regularPath:"/03.%E4%B8%AD%E9%97%B4%E4%BB%B6/06.logstash/01.pulsar%E9%98%BB%E5%A1%9E%E5%AF%BC%E8%87%B4logstash%E6%97%A0%E6%B3%95%E6%8E%A5%E5%85%A5%E6%97%A5%E5%BF%97.html",relativePath:"03.ä¸­é´ä»¶/06.logstash/01.pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿.md",key:"v-450eddde",path:"/pages/adedbd/",headers:[{level:2,title:"èæ¯",slug:"èæ¯",normalizedTitle:"èæ¯",charIndex:2},{level:2,title:"æ£æ¥ç½ç»æåµ",slug:"æ£æ¥ç½ç»æåµ",normalizedTitle:"æ£æ¥ç½ç»æåµ",charIndex:149},{level:2,title:"æ£æ¥logstashç®¡éä¿¡æ¯",slug:"æ£æ¥logstashç®¡éä¿¡æ¯",normalizedTitle:"æ£æ¥logstashç®¡éä¿¡æ¯",charIndex:809},{level:2,title:"ä»å æ ä¸­æ¾å°èä¸é©¬è¿¹",slug:"ä»å æ ä¸­æ¾å°èä¸é©¬è¿¹",normalizedTitle:"ä»å æ ä¸­æ¾å°èä¸é©¬è¿¹",charIndex:1604},{level:2,title:"å¤ç°",slug:"å¤ç°",normalizedTitle:"å¤ç°",charIndex:2266},{level:2,title:"ä¿®å¤",slug:"ä¿®å¤",normalizedTitle:"ä¿®å¤",charIndex:2404},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:2588}],headersStr:"èæ¯ æ£æ¥ç½ç»æåµ æ£æ¥logstashç®¡éä¿¡æ¯ ä»å æ ä¸­æ¾å°èä¸é©¬è¿¹ å¤ç° ä¿®å¤ æ»ç»",content:'# èæ¯\n\nå¨logstashä¸­ï¼inputç®¡éæ¥æ¶tcpåudpçæ¥å¿ï¼ç¶ååéè¿outputç®¡éå°æ¥å¿è¾åºå°pulsarä¸­ï¼å¦ä¸å¾æç¤ºï¼\n\n\n\nå½åçé®é¢æ¯ï¼å¨ä½¿ç¨tcpåudpæ¥å¥æ¹å¼æ¥å¥ä¸æ®µæ¶é´æ¥å¿ä¹åï¼æ¥å¿çªç¶æ æ³æ¥å¥äºï¼å¨pulsarä¸­çå¯¹åºtopicæ²¡ææ°çæ¥å¿çäº§è¿æ¥äºã\n\n\n# æ£æ¥ç½ç»æåµ\n\n 1. å¨å®¹å¨ä¸­æåï¼å¤æ­æ°æ®åæ¯å¦è¿å¥å°å®¹å¨ä¸­\n\nå ä¸ºæå¡é½æ¯å®¹å¨åé¨ç½²çï¼æä»¥å¯ä»¥ä½¿ç¨nsenter -t $Pid -næ¥è¿å¥å°å®¹å¨çnetwork namespaceä¸­ï¼ç¶ååä½¿ç¨tcpdump -i any port 514 -vvnnæ¥æå514ç«¯å£çæ°æ®åã\n\néè¿æåæ¯å¯ä»¥æå°æ°æ®åï¼å¹¶ä¸çä¸æ¬¡æ¡æåæ°æ®åé½æ¯æ­£å¸¸çï¼è¯´ææµéå·²ç»è¿å¥å°å®¹å¨ä¸­äºã\n\n 2. æ¥çtcpåudpç¼å­éå\n\nä½¿ç¨netstat -anpæ¥çtcpåupdç¼å­éåï¼åç°Recv-Qæ¯ä¸ç´æå ç§¯çï¼ä¹å°±æ¯è¯´ï¼æå¡ç«¯æ²¡æå¨ä»ç¼å­éåä¸­æ¶è´¹æ¥å¿ï¼æå¡ç«¯å¡ä½äºã\n\n# netstat -anp\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name  \ntcp   286138      0 14.2.19.144:514         10.65.132.32:46778      ESTABLISHED 538152/java   \nudp   152543      0 14.2.19.144:514         10.65.132.32:46774      ESTABLISHED 538152/java  \n\n\n1\n2\n3\n4\n5\n\n\n\n# æ£æ¥logstashç®¡éä¿¡æ¯\n\nè¿å¥å°å®¹å¨ä¸­æ§è¡ä»¥ä¸å½ä»¤æ¥è·ålogstashå¯¹åºç®¡éçä¿¡æ¯\n\ncurl -XGET \'localhost:9600/_node/stats/pipelines/syslog?pretty\'\n\n\n1\n\n\nå¯ä»¥çå°inputç®¡éä¸­tcpæä»¶çoutçæ°éä¸ç´ä¿æä¸åï¼è¯´æå·²ç»æ²¡ææ¥æ¶æ°çæ°æ®åäºã\n\n{\n    "id": "d1a2689850bcefed823d25f0ae0ee7b863f3843474c6eafd3d3fe5aa7babcded",\n    "name": "tcp",\n    "events": {\n        "queue_push_duration_in_millis": 3728,\n        "out": 6680\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nåçoutputç®¡éçpulsaræä»¶ä¿¡æ¯ï¼å¯ä»¥çå°inæ¯outå¤äº150ï¼è¿æ¯å ä¸ºpipeline.batch.size=50ï¼å¹¶ä¸pipeline.workers=3ï¼æä»¥ä¸å±æ150æ¡æ¥å¿é»å¡å¨éåä¸­ï¼pulsar-clientæ³åéåºå»ï¼é»å¡äºã\n\n{\n    "id": "4acf48fc134b333ecb24218723c8fd36d54dc3713cbe66bd199ce4ccb09f2cd1",\n    "name": "pulsar",\n    "events": {\n        "duration_in_millis": 9923,\n        "in": 6529,\n        "out": 6379\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\néè¿æ¥çpulsaræå¡çç¶æåæ¥å¿åç°å¶å¹¶æ²¡æä»»ä½å¼å¸¸ï¼æå¨å»çäº§æ¥å¿ä¹æ¯å¯ä»¥çï¼æä»¥ææ¶æé¤äºpulsaræ¬èº«çé®é¢ã\n\n\n# ä»å æ ä¸­æ¾å°èä¸é©¬è¿¹\n\néè¿ä»¥ä¸å½ä»¤æ¥æ¥çlogstashççº¿ç¨å æ ä¿¡æ¯\n\n# curl -XGET \'localhost:9600/_node/hot_threads?pretty\'\n\n"java.base@11.0.15/jdk.internal.misc.Unsafe.park(Native Method)", "java.base@11.0.15/java.util.concurrent.locks.LockSupport.park(LockSupport.java:194)", "java.base@11.0.15/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2081)", "org.apache.pulsar.client.impl.MemoryLimitController.reserveMemory(MemoryLimitController.java:88)", ...\n\n\n1\n2\n3\n\n\néè¿ä¸é¢çå æ ä¿¡æ¯å»googleä¸æç´¢ï¼æ¾å°äºä¸é¢è¿ä¸ªé¾æ¥ï¼åç°æ¯pulsarçå®æ¹bugï¼å¨å¼å¯åç¼©æ¶ï¼å¹¶ä¸åå­éå¶çè¶å°ï¼è¶å®¹æè§¦åè¯¥BUGï¼ä»èå¯¼è´pulsar-clientåçé»å¡ã\n\nhttps://lists.apache.org/thread/76jn7k01ldgkl54n0bpgw3sf2kxqq5q9\n\n\n# å¤ç°\n\nè¿éç¨çæ¯å¼æºçpulsaræä»¶ï¼logstash-output-pulsar\n\nå¶å¹¶æ²¡æåå­éå¶éç½®åæ°ï¼éè¿ä¿®æ¹æºç å°pulsar-clientçmemory_limitåæ°æ´é²åºæ¥ï¼å¹¶å°å¶è®¾ç½®æ1ï¼å¼å¯åç¼©ï¼æç»­æé æ¥å¿è¿æ¥ï¼ä¼åç°ç¨³å®å¿«éå¤ç°è¯¥é®é¢ã\n\n\n# ä¿®å¤\n\næ¥çlogstash-output-pulsaré¡¹ç®ä¸çbuild.gradleæä»¶ï¼å¶pulsarçæ¬ä¸º2.10.2ï¼èå¨https://github.com/apache/pulsar/pull/21790 æäº¤å¯ä»¥çå°å¨3.2.0çæ¬ä¿®å¤çã\n\nä¿®æ¹é¡¹ç®ä¸­pulsar-clientçæ¬å·ï¼æååºæ¥ï¼åæç§ä¸é¢çå¤ç°æ­¥éª¤ï¼åç°ä¸ä¼åè¿è¡é»å¡äºã\n\n\n# æ»ç»\n\nåäºå©ç¨ç»ä»¶æä¾çåç§å·¥å·å¾å°å¶ææ ï¼åæåå ï¼æ¾å°èä¸é©¬è¿¹ï¼åå©ç¨googleå»æç´¢ã',normalizedContent:'# èæ¯\n\nå¨logstashä¸­ï¼inputç®¡éæ¥æ¶tcpåudpçæ¥å¿ï¼ç¶ååéè¿outputç®¡éå°æ¥å¿è¾åºå°pulsarä¸­ï¼å¦ä¸å¾æç¤ºï¼\n\n\n\nå½åçé®é¢æ¯ï¼å¨ä½¿ç¨tcpåudpæ¥å¥æ¹å¼æ¥å¥ä¸æ®µæ¶é´æ¥å¿ä¹åï¼æ¥å¿çªç¶æ æ³æ¥å¥äºï¼å¨pulsarä¸­çå¯¹åºtopicæ²¡ææ°çæ¥å¿çäº§è¿æ¥äºã\n\n\n# æ£æ¥ç½ç»æåµ\n\n 1. å¨å®¹å¨ä¸­æåï¼å¤æ­æ°æ®åæ¯å¦è¿å¥å°å®¹å¨ä¸­\n\nå ä¸ºæå¡é½æ¯å®¹å¨åé¨ç½²çï¼æä»¥å¯ä»¥ä½¿ç¨nsenter -t $pid -næ¥è¿å¥å°å®¹å¨çnetwork namespaceä¸­ï¼ç¶ååä½¿ç¨tcpdump -i any port 514 -vvnnæ¥æå514ç«¯å£çæ°æ®åã\n\néè¿æåæ¯å¯ä»¥æå°æ°æ®åï¼å¹¶ä¸çä¸æ¬¡æ¡æåæ°æ®åé½æ¯æ­£å¸¸çï¼è¯´ææµéå·²ç»è¿å¥å°å®¹å¨ä¸­äºã\n\n 2. æ¥çtcpåudpç¼å­éå\n\nä½¿ç¨netstat -anpæ¥çtcpåupdç¼å­éåï¼åç°recv-qæ¯ä¸ç´æå ç§¯çï¼ä¹å°±æ¯è¯´ï¼æå¡ç«¯æ²¡æå¨ä»ç¼å­éåä¸­æ¶è´¹æ¥å¿ï¼æå¡ç«¯å¡ä½äºã\n\n# netstat -anp\nactive internet connections (servers and established)\nproto recv-q send-q local address           foreign address         state       pid/program name  \ntcp   286138      0 14.2.19.144:514         10.65.132.32:46778      established 538152/java   \nudp   152543      0 14.2.19.144:514         10.65.132.32:46774      established 538152/java  \n\n\n1\n2\n3\n4\n5\n\n\n\n# æ£æ¥logstashç®¡éä¿¡æ¯\n\nè¿å¥å°å®¹å¨ä¸­æ§è¡ä»¥ä¸å½ä»¤æ¥è·ålogstashå¯¹åºç®¡éçä¿¡æ¯\n\ncurl -xget \'localhost:9600/_node/stats/pipelines/syslog?pretty\'\n\n\n1\n\n\nå¯ä»¥çå°inputç®¡éä¸­tcpæä»¶çoutçæ°éä¸ç´ä¿æä¸åï¼è¯´æå·²ç»æ²¡ææ¥æ¶æ°çæ°æ®åäºã\n\n{\n    "id": "d1a2689850bcefed823d25f0ae0ee7b863f3843474c6eafd3d3fe5aa7babcded",\n    "name": "tcp",\n    "events": {\n        "queue_push_duration_in_millis": 3728,\n        "out": 6680\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nåçoutputç®¡éçpulsaræä»¶ä¿¡æ¯ï¼å¯ä»¥çå°inæ¯outå¤äº150ï¼è¿æ¯å ä¸ºpipeline.batch.size=50ï¼å¹¶ä¸pipeline.workers=3ï¼æä»¥ä¸å±æ150æ¡æ¥å¿é»å¡å¨éåä¸­ï¼pulsar-clientæ³åéåºå»ï¼é»å¡äºã\n\n{\n    "id": "4acf48fc134b333ecb24218723c8fd36d54dc3713cbe66bd199ce4ccb09f2cd1",\n    "name": "pulsar",\n    "events": {\n        "duration_in_millis": 9923,\n        "in": 6529,\n        "out": 6379\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\néè¿æ¥çpulsaræå¡çç¶æåæ¥å¿åç°å¶å¹¶æ²¡æä»»ä½å¼å¸¸ï¼æå¨å»çäº§æ¥å¿ä¹æ¯å¯ä»¥çï¼æä»¥ææ¶æé¤äºpulsaræ¬èº«çé®é¢ã\n\n\n# ä»å æ ä¸­æ¾å°èä¸é©¬è¿¹\n\néè¿ä»¥ä¸å½ä»¤æ¥æ¥çlogstashççº¿ç¨å æ ä¿¡æ¯\n\n# curl -xget \'localhost:9600/_node/hot_threads?pretty\'\n\n"java.base@11.0.15/jdk.internal.misc.unsafe.park(native method)", "java.base@11.0.15/java.util.concurrent.locks.locksupport.park(locksupport.java:194)", "java.base@11.0.15/java.util.concurrent.locks.abstractqueuedsynchronizer$conditionobject.await(abstractqueuedsynchronizer.java:2081)", "org.apache.pulsar.client.impl.memorylimitcontroller.reservememory(memorylimitcontroller.java:88)", ...\n\n\n1\n2\n3\n\n\néè¿ä¸é¢çå æ ä¿¡æ¯å»googleä¸æç´¢ï¼æ¾å°äºä¸é¢è¿ä¸ªé¾æ¥ï¼åç°æ¯pulsarçå®æ¹bugï¼å¨å¼å¯åç¼©æ¶ï¼å¹¶ä¸åå­éå¶çè¶å°ï¼è¶å®¹æè§¦åè¯¥bugï¼ä»èå¯¼è´pulsar-clientåçé»å¡ã\n\nhttps://lists.apache.org/thread/76jn7k01ldgkl54n0bpgw3sf2kxqq5q9\n\n\n# å¤ç°\n\nè¿éç¨çæ¯å¼æºçpulsaræä»¶ï¼logstash-output-pulsar\n\nå¶å¹¶æ²¡æåå­éå¶éç½®åæ°ï¼éè¿ä¿®æ¹æºç å°pulsar-clientçmemory_limitåæ°æ´é²åºæ¥ï¼å¹¶å°å¶è®¾ç½®æ1ï¼å¼å¯åç¼©ï¼æç»­æé æ¥å¿è¿æ¥ï¼ä¼åç°ç¨³å®å¿«éå¤ç°è¯¥é®é¢ã\n\n\n# ä¿®å¤\n\næ¥çlogstash-output-pulsaré¡¹ç®ä¸çbuild.gradleæä»¶ï¼å¶pulsarçæ¬ä¸º2.10.2ï¼èå¨https://github.com/apache/pulsar/pull/21790 æäº¤å¯ä»¥çå°å¨3.2.0çæ¬ä¿®å¤çã\n\nä¿®æ¹é¡¹ç®ä¸­pulsar-clientçæ¬å·ï¼æååºæ¥ï¼åæç§ä¸é¢çå¤ç°æ­¥éª¤ï¼åç°ä¸ä¼åè¿è¡é»å¡äºã\n\n\n# æ»ç»\n\nåäºå©ç¨ç»ä»¶æä¾çåç§å·¥å·å¾å°å¶ææ ï¼åæåå ï¼æ¾å°èä¸é©¬è¿¹ï¼åå©ç¨googleå»æç´¢ã',charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"pythonä¸ä¸æç®¡çå¨",frontmatter:{title:"pythonä¸ä¸æç®¡çå¨",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/a6b804/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"pythonçä¸ä¸æç®¡ççä½¿ç¨åå®ç°çå ç§æ¹å¼",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","åºç¡"],comment:!0,meta:[{name:"twitter:title",content:"pythonä¸ä¸æç®¡çå¨"},{name:"twitter:description",content:"pythonçä¸ä¸æç®¡ççä½¿ç¨åå®ç°çå ç§æ¹å¼"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/04.python%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonä¸ä¸æç®¡çå¨"},{property:"og:description",content:"pythonçä¸ä¸æç®¡ççä½¿ç¨åå®ç°çå ç§æ¹å¼"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/04.python%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonä¸ä¸æç®¡çå¨"},{itemprop:"description",content:"pythonçä¸ä¸æç®¡ççä½¿ç¨åå®ç°çå ç§æ¹å¼"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/04.python%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/04.pythonä¸ä¸æç®¡çå¨.md",key:"v-ed00c198",path:"/pages/a6b804/",headers:[{level:2,title:"ä»ä¹æ¯ä¸ä¸æç®¡çå¨",slug:"ä»ä¹æ¯ä¸ä¸æç®¡çå¨",normalizedTitle:"ä»ä¹æ¯ä¸ä¸æç®¡çå¨",charIndex:2},{level:2,title:"ç»å¸openæ¡ä¾",slug:"ç»å¸openæ¡ä¾",normalizedTitle:"ç»å¸openæ¡ä¾",charIndex:89},{level:2,title:"èªå®ä¹ä¸ä¸æç®¡çå¨",slug:"èªå®ä¹ä¸ä¸æç®¡çå¨",normalizedTitle:"èªå®ä¹ä¸ä¸æç®¡çå¨",charIndex:314},{level:3,title:"ç±»å®ç°",slug:"ç±»å®ç°",normalizedTitle:"ç±»å®ç°",charIndex:328},{level:3,title:"æ¹æ³å®ç°",slug:"æ¹æ³å®ç°",normalizedTitle:"æ¹æ³å®ç°",charIndex:631}],headersStr:"ä»ä¹æ¯ä¸ä¸æç®¡çå¨ ç»å¸openæ¡ä¾ èªå®ä¹ä¸ä¸æç®¡çå¨ ç±»å®ç° æ¹æ³å®ç°",content:'# ä»ä¹æ¯ä¸ä¸æç®¡çå¨\n\npythonä¸­ä½¿ç¨withæ¥ä½¿ç¨ä¸ä¸æç®¡çå¨.\n\nå¨ä½¿ç¨æä¸ªèµæºæ¶ï¼å¯ä»¥å¯¹è¯¥èµæºè¿è¡åå§ååèµæºçæ¸çä¸¤ä¸ªæä½ï¼å¨è¿ä¸¤ä¸ªæä½ä¹é´è¾¹æä¸ºä¸ä¸æã\n\n\n# ç»å¸openæ¡ä¾\n\nå¯¹æä»¶æä½æ¶ï¼éè¦æå¼æä»¶åå³é­æä»¶ãç¶åå¨è¿ä¹é´è¿è¡æä»¶çæä½ã\n\nf = open("a.txt")\nf.write("hello world")\nf.close()\n\n\n1\n2\n3\n\n\nä½¿ç¨ä¸ä¸æç®¡çå¨ æå¼æä»¶åï¼å¾å°æä»¶æè¿°ç¬¦ï¼å¨withä»£ç åä¸­å¯¹fè¿è¡æä½ï¼ç»ææ¶ï¼ä¼èªå¨çè¿è¡å³é­æä½.\n\nwith open("a.txt") as f:\n    f.write("hello world")\n\n\n1\n2\n\n\n\n# èªå®ä¹ä¸ä¸æç®¡çå¨\n\n\n# ç±»å®ç°\n\nè¿å¥ä¸ä¸ææ¶ï¼è°ç¨__enter__æ¹æ³è¿è¡åå§åï¼éåºæ¶ï¼è°ç¨__exit__éåºã\n\n\nclass A:\ndef __enter__(self):\n    print("è¿å¥")\n\ndef __exit__(self, exc_type, exc_val, exc_tb):\n    print("éæ¾èµæº")\n\nwith A() as f:\n    print("hello")\n    print("world")\n   \noutput: \nè¿å¥\nhello\nworld\néæ¾èµæº\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\n\n# æ¹æ³å®ç°\n\nä½¿ç¨contextlib.contextmanager å¯¹æ¹æ³å®ç°ä¸ä¸æç®¡çå¨. ä½¿ç¨çæå¨å®æã\n\n\nimport contextlib\n\n@contextlib.contextmanager\ndef test(a):\n    print("open..")\n    yield a\n    print("close")\n    \nwith test(2) as f:\n    print(f)\n\noutput:\nopen..\n2\nclose\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n',normalizedContent:'# ä»ä¹æ¯ä¸ä¸æç®¡çå¨\n\npythonä¸­ä½¿ç¨withæ¥ä½¿ç¨ä¸ä¸æç®¡çå¨.\n\nå¨ä½¿ç¨æä¸ªèµæºæ¶ï¼å¯ä»¥å¯¹è¯¥èµæºè¿è¡åå§ååèµæºçæ¸çä¸¤ä¸ªæä½ï¼å¨è¿ä¸¤ä¸ªæä½ä¹é´è¾¹æä¸ºä¸ä¸æã\n\n\n# ç»å¸openæ¡ä¾\n\nå¯¹æä»¶æä½æ¶ï¼éè¦æå¼æä»¶åå³é­æä»¶ãç¶åå¨è¿ä¹é´è¿è¡æä»¶çæä½ã\n\nf = open("a.txt")\nf.write("hello world")\nf.close()\n\n\n1\n2\n3\n\n\nä½¿ç¨ä¸ä¸æç®¡çå¨ æå¼æä»¶åï¼å¾å°æä»¶æè¿°ç¬¦ï¼å¨withä»£ç åä¸­å¯¹fè¿è¡æä½ï¼ç»ææ¶ï¼ä¼èªå¨çè¿è¡å³é­æä½.\n\nwith open("a.txt") as f:\n    f.write("hello world")\n\n\n1\n2\n\n\n\n# èªå®ä¹ä¸ä¸æç®¡çå¨\n\n\n# ç±»å®ç°\n\nè¿å¥ä¸ä¸ææ¶ï¼è°ç¨__enter__æ¹æ³è¿è¡åå§åï¼éåºæ¶ï¼è°ç¨__exit__éåºã\n\n\nclass a:\ndef __enter__(self):\n    print("è¿å¥")\n\ndef __exit__(self, exc_type, exc_val, exc_tb):\n    print("éæ¾èµæº")\n\nwith a() as f:\n    print("hello")\n    print("world")\n   \noutput: \nè¿å¥\nhello\nworld\néæ¾èµæº\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\n\n# æ¹æ³å®ç°\n\nä½¿ç¨contextlib.contextmanager å¯¹æ¹æ³å®ç°ä¸ä¸æç®¡çå¨. ä½¿ç¨çæå¨å®æã\n\n\nimport contextlib\n\n@contextlib.contextmanager\ndef test(a):\n    print("open..")\n    yield a\n    print("close")\n    \nwith test(2) as f:\n    print(f)\n\noutput:\nopen..\n2\nclose\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pythonåå¾åæ¶æºå¶",frontmatter:{title:"pythonåå¾åæ¶æºå¶",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/78c648/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"pythonçåå¾åæ¶æºå¶çå ç§æ¹å¼ï¼å¼ç¨è®¡æ°ãæ è®°æ¸æ¥ååä»£åæ¶ï¼ä»ç»ä»ä»¬çåçã",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","åºç¡"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215650.png"},{name:"twitter:title",content:"pythonåå¾åæ¶æºå¶"},{name:"twitter:description",content:"pythonçåå¾åæ¶æºå¶çå ç§æ¹å¼ï¼å¼ç¨è®¡æ°ãæ è®°æ¸æ¥ååä»£åæ¶ï¼ä»ç»ä»ä»¬çåçã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215650.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/03.python%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonåå¾åæ¶æºå¶"},{property:"og:description",content:"pythonçåå¾åæ¶æºå¶çå ç§æ¹å¼ï¼å¼ç¨è®¡æ°ãæ è®°æ¸æ¥ååä»£åæ¶ï¼ä»ç»ä»ä»¬çåçã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215650.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/03.python%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonåå¾åæ¶æºå¶"},{itemprop:"description",content:"pythonçåå¾åæ¶æºå¶çå ç§æ¹å¼ï¼å¼ç¨è®¡æ°ãæ è®°æ¸æ¥ååä»£åæ¶ï¼ä»ç»ä»ä»¬çåçã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215650.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/03.python%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/03.pythonåå¾åæ¶æºå¶.md",key:"v-06e111a1",path:"/pages/78c648/",headers:[{level:2,title:"å¼ç¨è®¡æ°",slug:"å¼ç¨è®¡æ°",normalizedTitle:"å¼ç¨è®¡æ°",charIndex:2},{level:2,title:"æ è®°-æ¸é¤",slug:"æ è®°-æ¸é¤",normalizedTitle:"æ è®°-æ¸é¤",charIndex:68},{level:2,title:"åä»£åæ¶",slug:"åä»£åæ¶",normalizedTitle:"åä»£åæ¶",charIndex:428},{level:2,title:"åå¾åæ¶è§¦åæåµ",slug:"åå¾åæ¶è§¦åæåµ",normalizedTitle:"åå¾åæ¶è§¦åæåµ",charIndex:684}],headersStr:"å¼ç¨è®¡æ° æ è®°-æ¸é¤ åä»£åæ¶ åå¾åæ¶è§¦åæåµ",content:"# å¼ç¨è®¡æ°\n\næ¯æ¬¡å¯¹è±¡è¢«å¼ç¨æ¶ï¼ä¼è¢«è®¡æ°å 1ï¼å½è®¡æ°ä¸º0æ¶ï¼ååæ¶è¯¥å¯¹è±¡ã\n\næ³¨æï¼ å¾ªç¯å¼ç¨çæåµï¼å¼ç¨è®¡æ°ä¸è½è§£å³.\n\n\n\n\n# æ è®°-æ¸é¤\n\nå¯¹æææ´»è·çå¯¹è±¡è¿è¡æ è®°ï¼å¯¹éæ´»è·å¯¹è±¡è¿è¡åæ¶ãå¯ä»¥ææçè§£å³å¾ªç¯å¼ç¨çé®é¢\n\nåç å¯¹è±¡ä¹é´éè¿å¼ç¨æå»ºæåå¾ï¼ä»root object(å¨å±åéï¼å¯å­å¨ç­ä¸å¯å é¤çå¯¹è±¡)åºåï¼æ²¿çæåè¾¹éåå¯¹è±¡ï¼å¯è¾¾çå¯¹è±¡æ è®°ä¸ºæ´»è·å¯¹è±¡ï¼ä¸å¯è¾¾çå¯¹è±¡å°±æ¯è¦è¢«æ¸é¤çéæ´»å¨å¯¹è±¡ã\n\nå¨ä¸å¾ä¸­ï¼ä»é»ç¹å¼å§åºåï¼1å¯¹è±¡å¯è¾¾ï¼2ã3é´æ¥å¯è¾¾ï¼1ã2ã3æ¯æ´»è·å¯¹è±¡ï¼4,5ä¸å¯è¾¾ï¼æä»¥æ¯éæ´»è·å¯¹è±¡ï¼è¿è¡åæ¶ã\n\nè¿ç¨ æ¾å°root objectéå, å¨åå­å»ºç«ä¸¤æ¡è¿è¡¨ï¼ä¸æ¡é¾è¡¨ç»´æ¤root objectéåï¼å¦ä¸æ¡é¾è¡¨å¦ç»´æ¤å©ä¸çå¯¹è±¡ï¼å¨æ è®°çè¿ç¨ä¸­ï¼å¦æå¨ä¸å¯è¾¾é¾è¡¨ä¸­å­å¨è¢«rooté¾è¡¨ä¸­çç¬äº«ï¼ç´æ¥æé´æ¥å¼ç¨ç¬äº«ï¼å°±å°å¶ä»ä¸å¯è¾¾é¾è¡¨ç§»å°rooté¾è¡¨ä¸­ãå½å®ææ è®°åï¼ä¸å¯è¾¾é¾è¡¨å©ä¸çå¯¹è±¡é½æ¯åå¾å¯¹è±¡ï¼è¿è¡åæ¶ã\n\n\n# åä»£åæ¶\n\nå¯¹è±¡åå¨ä¸åéåä¸­ï¼æ¯ä¸ªéåç§°ä¸ºä¸ä¸ªä»£, Pythonä¸­åä¸º3ä»£ï¼å¹´è½»ä»£(ç¬¬0ä»£)ãä¸­å¹´ä»£(ç¬¬1ä»£)ãèå¹´ä»£(ç¬¬äºä»£)ï¼å¯¹åº3åé¾è¡¨ï¼æ¯ä¸ä»£GCé¢çä¸åï¼ç¬¬0ä»£æé«ï¼ç¬¬1ä»£æ¬¡ä¹ï¼ç¬¬äºä»£æä½(è¶å¹´è½»çå¯¹è±¡è¶å®¹ææ­»æï¼èèçå¯¹è±¡éå¸¸ä¼å­éæ´ä¹)ï¼æ°ççå¯¹è±¡æ¾å¥ç¬¬0ä»£ï¼å¦æè¯¥å¯¹è±¡å¨ç¬¬0ä»£çä¸æ¬¡GCä¸­å­æ´»ï¼åç§»å¨å°ç¬¬1ä»£ï¼å¦æç¬¬ä¸ä»£å¯¹è±¡å¨ç¬¬1ä»£GCä¸­å­éï¼åç§»å¨å°ç¬¬2ä»£ã\n\nä»ä¹æåµè§¦åGCï¼ å¯ä»¥è®¾ç½®éå¼ï¼ä¹å¯ä»¥æå¨è°ç¨gc.collect()\n\næ¯æ¬¡æ«æå¨é¨å¯¹è±¡ï¼è´¹æ¶è´¹åï¼æé«GCçæçã\n\n\n# åå¾åæ¶è§¦åæåµ\n\nè°ç¨gc.collect(),éè¦åå¯¼å¥gcæ¨¡åã\n\nå½gcæ¨¡åçè®¡æ°å¨è¾¾å°éå¼çæ¶åãéå¼å¯ä»¥è®¾ç½®",normalizedContent:"# å¼ç¨è®¡æ°\n\næ¯æ¬¡å¯¹è±¡è¢«å¼ç¨æ¶ï¼ä¼è¢«è®¡æ°å 1ï¼å½è®¡æ°ä¸º0æ¶ï¼ååæ¶è¯¥å¯¹è±¡ã\n\næ³¨æï¼ å¾ªç¯å¼ç¨çæåµï¼å¼ç¨è®¡æ°ä¸è½è§£å³.\n\n\n\n\n# æ è®°-æ¸é¤\n\nå¯¹æææ´»è·çå¯¹è±¡è¿è¡æ è®°ï¼å¯¹éæ´»è·å¯¹è±¡è¿è¡åæ¶ãå¯ä»¥ææçè§£å³å¾ªç¯å¼ç¨çé®é¢\n\nåç å¯¹è±¡ä¹é´éè¿å¼ç¨æå»ºæåå¾ï¼ä»root object(å¨å±åéï¼å¯å­å¨ç­ä¸å¯å é¤çå¯¹è±¡)åºåï¼æ²¿çæåè¾¹éåå¯¹è±¡ï¼å¯è¾¾çå¯¹è±¡æ è®°ä¸ºæ´»è·å¯¹è±¡ï¼ä¸å¯è¾¾çå¯¹è±¡å°±æ¯è¦è¢«æ¸é¤çéæ´»å¨å¯¹è±¡ã\n\nå¨ä¸å¾ä¸­ï¼ä»é»ç¹å¼å§åºåï¼1å¯¹è±¡å¯è¾¾ï¼2ã3é´æ¥å¯è¾¾ï¼1ã2ã3æ¯æ´»è·å¯¹è±¡ï¼4,5ä¸å¯è¾¾ï¼æä»¥æ¯éæ´»è·å¯¹è±¡ï¼è¿è¡åæ¶ã\n\nè¿ç¨ æ¾å°root objectéå, å¨åå­å»ºç«ä¸¤æ¡è¿è¡¨ï¼ä¸æ¡é¾è¡¨ç»´æ¤root objectéåï¼å¦ä¸æ¡é¾è¡¨å¦ç»´æ¤å©ä¸çå¯¹è±¡ï¼å¨æ è®°çè¿ç¨ä¸­ï¼å¦æå¨ä¸å¯è¾¾é¾è¡¨ä¸­å­å¨è¢«rooté¾è¡¨ä¸­çç¬äº«ï¼ç´æ¥æé´æ¥å¼ç¨ç¬äº«ï¼å°±å°å¶ä»ä¸å¯è¾¾é¾è¡¨ç§»å°rooté¾è¡¨ä¸­ãå½å®ææ è®°åï¼ä¸å¯è¾¾é¾è¡¨å©ä¸çå¯¹è±¡é½æ¯åå¾å¯¹è±¡ï¼è¿è¡åæ¶ã\n\n\n# åä»£åæ¶\n\nå¯¹è±¡åå¨ä¸åéåä¸­ï¼æ¯ä¸ªéåç§°ä¸ºä¸ä¸ªä»£, pythonä¸­åä¸º3ä»£ï¼å¹´è½»ä»£(ç¬¬0ä»£)ãä¸­å¹´ä»£(ç¬¬1ä»£)ãèå¹´ä»£(ç¬¬äºä»£)ï¼å¯¹åº3åé¾è¡¨ï¼æ¯ä¸ä»£gcé¢çä¸åï¼ç¬¬0ä»£æé«ï¼ç¬¬1ä»£æ¬¡ä¹ï¼ç¬¬äºä»£æä½(è¶å¹´è½»çå¯¹è±¡è¶å®¹ææ­»æï¼èèçå¯¹è±¡éå¸¸ä¼å­éæ´ä¹)ï¼æ°ççå¯¹è±¡æ¾å¥ç¬¬0ä»£ï¼å¦æè¯¥å¯¹è±¡å¨ç¬¬0ä»£çä¸æ¬¡gcä¸­å­æ´»ï¼åç§»å¨å°ç¬¬1ä»£ï¼å¦æç¬¬ä¸ä»£å¯¹è±¡å¨ç¬¬1ä»£gcä¸­å­éï¼åç§»å¨å°ç¬¬2ä»£ã\n\nä»ä¹æåµè§¦ågcï¼ å¯ä»¥è®¾ç½®éå¼ï¼ä¹å¯ä»¥æå¨è°ç¨gc.collect()\n\næ¯æ¬¡æ«æå¨é¨å¯¹è±¡ï¼è´¹æ¶è´¹åï¼æé«gcçæçã\n\n\n# åå¾åæ¶è§¦åæåµ\n\nè°ç¨gc.collect(),éè¦åå¯¼å¥gcæ¨¡åã\n\nå½gcæ¨¡åçè®¡æ°å¨è¾¾å°éå¼çæ¶åãéå¼å¯ä»¥è®¾ç½®",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼",frontmatter:{title:"ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼",date:"2022-12-10T16:47:40.000Z",permalink:"/pages/33b8d0/",tags:["python"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦ä»ç»ä½¿ç¨pythonçä¸ç§å®ç°åä¾æ¨¡å¼çæ¹å¼ã",feed:{enable:!0},categories:["ç¼ç¨","python","åºç¡"],comment:!0,meta:[{name:"twitter:title",content:"ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼"},{name:"twitter:description",content:"æ¬æä¸»è¦ä»ç»ä½¿ç¨pythonçä¸ç§å®ç°åä¾æ¨¡å¼çæ¹å¼ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/06.%E4%BD%BF%E7%94%A8python%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼"},{property:"og:description",content:"æ¬æä¸»è¦ä»ç»ä½¿ç¨pythonçä¸ç§å®ç°åä¾æ¨¡å¼çæ¹å¼ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/06.%E4%BD%BF%E7%94%A8python%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-10T16:47:40.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼"},{itemprop:"description",content:"æ¬æä¸»è¦ä»ç»ä½¿ç¨pythonçä¸ç§å®ç°åä¾æ¨¡å¼çæ¹å¼ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/06.%E4%BD%BF%E7%94%A8python%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/06.ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼.md",key:"v-e35e3500",path:"/pages/33b8d0/",headers:[{level:2,title:"0 . åè¨",slug:"_0-åè¨",normalizedTitle:"0 . åè¨",charIndex:2},{level:2,title:"1. å¨ç±»ä¸­_new_æ¹æ³ä¸­å®ç°",slug:"_1-å¨ç±»ä¸­-new-æ¹æ³ä¸­å®ç°",normalizedTitle:"1. å¨ç±»ä¸­_new_æ¹æ³ä¸­å®ç°",charIndex:null},{level:2,title:"2. éè¿åç±»å®ç°",slug:"_2-éè¿åç±»å®ç°",normalizedTitle:"2. éè¿åç±»å®ç°",charIndex:627},{level:2,title:"3. éè¿è£é¥°å¨å®ç°åä¾",slug:"_3-éè¿è£é¥°å¨å®ç°åä¾",normalizedTitle:"3. éè¿è£é¥°å¨å®ç°åä¾",charIndex:2516}],headersStr:"0 . åè¨ 1. å¨ç±»ä¸­_new_æ¹æ³ä¸­å®ç° 2. éè¿åç±»å®ç° 3. éè¿è£é¥°å¨å®ç°åä¾",content:'# 0 . åè¨\n\nå¨æ´ä¸ªè¿ç¨ä¸­ï¼æä¸åªæä¸ä¸ªå¯¹è±¡å­å¨ï¼å¨ä»»ä½å°ç¹ä½¿ç¨é½æ¯åä¸ä¸ªå¯¹è±¡ï¼å¯ä»¥è§£å³å¤çº¿ç¨èµæºç«äºé®é¢ï¼ä¹å¸¸ç¨äºéç½®ä¿¡æ¯ã\n\næ¬æä¸»è¦ä»ç»ä½¿ç¨pythonçä¸ç§å®ç°åä¾æ¨¡å¼çæ¹å¼ã\n\n\n# 1. å¨ç±»ä¸­__new__æ¹æ³ä¸­å®ç°\n\nå¨éè¦å®ç°åä¾ç class ä¸­æ·»å __new__æ¹æ³ï¼å¨åå»ºè¯¥ class å¯¹è±¡æ¶ä¼è°ç¨è¯¥æ¹æ³ï¼ä½¿ç¨ç±»åé _instance æ¥ä¿å­å½åå¯¹è±¡ï¼æ¯æ¬¡åå»ºä¹åé½ä¼å¤æ­æ¯å¦æè¯¥å¯¹è±¡ï¼æ²¡æååå»ºï¼æåç´æ¥è¿åã\n\nfrom typing import Any\n\nclass A:\n    def __new__(cls, *args, **kwargs) -> Any:\n        if not hasattr(cls, "_instance"):\n            cls._instance = super().__new__(cls, *args, **kwargs)\n    return cls._instance\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næä»¬åå»ºä¸¤ä¸ª class A å¯¹è±¡ï¼ç¶ååå«æå°ä»ä»¬çåå­ IDï¼ä¼åç°ä¸¤è ID æ¯ä¸è´çï¼ä¹å°±æ¯æ¯åä¸ä¸ªå¯¹è±¡ã\n\na1 = A()  \na2 = A()  \nprint(id(a1))  \nprint(id(a2))\n\nOutput: \n2659742107728\n2659742107728\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2. éè¿åç±»å®ç°\n\nä¸é¢çæ¹å¼éè¦å¨æ¯ä¸ä¸ªåä¾ç±»ä¸­é½è¦æ·»å ä¸ä¸ª__new__æ¹æ³ï¼æå¤§éçéå¤ä»£ç ãæ¥ä¸æ¥æä»¬ä»ç»éè¿åç±»æ¥å®ç°åä¾ã\n\n * ç¬¬ä¸ç\n\né¦ååå»º class Singleton æ¥ç»§æ¿ typeï¼è¯¥ç±»ä¸ºæä»¬èªå®ä¹çåç±»ãç¶ååå»ºæä»¬éè¦åä¾ç class A å Bï¼å®ä»¬é½éè¦éè¿ metaclass=Singleton æ¥éæ© Singleton ä½ä¸ºå®ä»¬çåç±»ã\n\nå¨åç±»ä¸­ï¼åå»º __call__ æ¹æ³ï¼è¯¥æ¹æ³ä¼å¨ class A å B åå»ºå¯¹è±¡æ¶è°ç¨ï¼å¨è¯¥æ¹æ³ä¸­ä¼è°ç¨ __new__ å __init__ æ¹æ³ï¼åå»ºå®å¯¹è±¡åï¼åå°è¯¥å¯¹è±¡æ¾å¨ç±»åé _instance ä¸­ï¼å 1. å¨__new__ä¸­å®ç°åä¾ çæ¹æ³ä¸æ ·ã\n\nfrom typing import Any\n\nclass Singleton(type):\n    def __call__(self, *args: Any, **kwds: Any) -> Any:\n        if not hasattr(self, "_instance"):\n            self._instance = super(Singleton, self).__call__(*args, **kwds)\n\n        return self._instance\n\nclass A(metaclass=Singleton):\n    pass\n\nclass B(metaclass=Singleton):\n    pass\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næä»¬åéè¿æµè¯ï¼å¯ä»¥çå° class A å B é½å®ç°äºåä¾ã\n\na1 = A()\na2 = A()\nprint(id(a1))\nprint(id(a2))\n\nb1 = B()\nb2 = B()\nprint(id(b1))\nprint(id(b2))\n\nOutput:\n>>> 2802632572784\n>>> 2802632572784\n>>> 2802632572400\n>>> 2802632572400\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nä½è¿ä¸ªåä¾è®¾è®¡åªéç¨äºåçº¿ç¨ï¼å¨å¤çº¿ç¨ä¸­ï¼å¦æä¸¤ä¸ªçº¿ç¨é½åç hasattr ä¸é¢ï¼å¯è½è¿æ¯ä¼åå»ºä¸¤ä¸ªå¯¹è±¡ï¼è¾¾ä¸å°åä¾çææã\n\n * ç¬¬äºç\n\néè¿å éè§£å³ä¸é¢å¹¶åçé®é¢ã\n\nimport threading\n\nclass Singleton(type):\n    lock = threading.Lock()\n    \n    def __call__(self, *args: Any, **kwds: Any) -> Any:\n        with Singleton.lock:\n            if not hasattr(self, "_instance"):\n                self._instance = super(Singleton, self).__call__(*args, **kwds)\n\n        return self._instance\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä½æ¯å¶å®åªæç¬¬ä¸æ¬¡åå»ºå¯¹è±¡æ¶ï¼éè¦éè¿éåæ­¥è·ååä¾å¯¹è±¡ï¼å¨å·²æå¯¹è±¡æ¶ï¼ä¸éè¦åç¨éäºï¼å¨è¿ç§æåµä¸ï¼æ¯æ¬¡è·åå¯¹è±¡é½ç»è¿éï¼ä¼å½±åæ§è½ã\n\n * æç»ç\n\næä»¥åå ä¸ä¸éå¤æ­ï¼åå°æ¯æ¬¡éå¤æ­å¸¦æ¥çæ§è½æ¶èã\n\nimport threading\nclass Singleton(type):\n    lock = threading.Lock()\n    \n    def __call__(self, *args: Any, **kwds: Any) -> Any:\n        if not hasattr(self, "_instance"):\n            with Singleton.lock:\n                if not hasattr(self, "_instance"):\n                    self._instance = super(Singleton, self).__call__(*args, **kwds)\n\n        return self._instance\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 3. éè¿è£é¥°å¨å®ç°åä¾\n\nè¯¥æ¹æ³æ¯éè¿å®ç°ä¸ä¸ªè£é¥°å¨ï¼å¨éè¦å®ç°ç±»ä¸æ·»å è¯¥è£é¥°å¨å³å¯å®æï¼ä½¿ç¨ç®åã\n\néè¿å°ææçåä¾å¯¹è±¡ä¿å­å¨è£é¥°å¨ç _instance å­å¸ä¸­ï¼ä»¥ç±»ä¸º keyï¼å¯¹è±¡ä¸º value è¿è¡å­å¨ã\n\ndef Singleton(cls):\n    _instance = {}\n    def _singleton(*args, **kargs):\n        if cls not in _instance:\n            _instance[cls] = cls(*args, **kargs)\n        return _instance[cls]\n    return _singleton\n@Singleton\nclass A:\n    pass\n  \n@Singleton\nclass B:\n    pass\n  \n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n',normalizedContent:'# 0 . åè¨\n\nå¨æ´ä¸ªè¿ç¨ä¸­ï¼æä¸åªæä¸ä¸ªå¯¹è±¡å­å¨ï¼å¨ä»»ä½å°ç¹ä½¿ç¨é½æ¯åä¸ä¸ªå¯¹è±¡ï¼å¯ä»¥è§£å³å¤çº¿ç¨èµæºç«äºé®é¢ï¼ä¹å¸¸ç¨äºéç½®ä¿¡æ¯ã\n\næ¬æä¸»è¦ä»ç»ä½¿ç¨pythonçä¸ç§å®ç°åä¾æ¨¡å¼çæ¹å¼ã\n\n\n# 1. å¨ç±»ä¸­__new__æ¹æ³ä¸­å®ç°\n\nå¨éè¦å®ç°åä¾ç class ä¸­æ·»å __new__æ¹æ³ï¼å¨åå»ºè¯¥ class å¯¹è±¡æ¶ä¼è°ç¨è¯¥æ¹æ³ï¼ä½¿ç¨ç±»åé _instance æ¥ä¿å­å½åå¯¹è±¡ï¼æ¯æ¬¡åå»ºä¹åé½ä¼å¤æ­æ¯å¦æè¯¥å¯¹è±¡ï¼æ²¡æååå»ºï¼æåç´æ¥è¿åã\n\nfrom typing import any\n\nclass a:\n    def __new__(cls, *args, **kwargs) -> any:\n        if not hasattr(cls, "_instance"):\n            cls._instance = super().__new__(cls, *args, **kwargs)\n    return cls._instance\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næä»¬åå»ºä¸¤ä¸ª class a å¯¹è±¡ï¼ç¶ååå«æå°ä»ä»¬çåå­ idï¼ä¼åç°ä¸¤è id æ¯ä¸è´çï¼ä¹å°±æ¯æ¯åä¸ä¸ªå¯¹è±¡ã\n\na1 = a()  \na2 = a()  \nprint(id(a1))  \nprint(id(a2))\n\noutput: \n2659742107728\n2659742107728\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2. éè¿åç±»å®ç°\n\nä¸é¢çæ¹å¼éè¦å¨æ¯ä¸ä¸ªåä¾ç±»ä¸­é½è¦æ·»å ä¸ä¸ª__new__æ¹æ³ï¼æå¤§éçéå¤ä»£ç ãæ¥ä¸æ¥æä»¬ä»ç»éè¿åç±»æ¥å®ç°åä¾ã\n\n * ç¬¬ä¸ç\n\né¦ååå»º class singleton æ¥ç»§æ¿ typeï¼è¯¥ç±»ä¸ºæä»¬èªå®ä¹çåç±»ãç¶ååå»ºæä»¬éè¦åä¾ç class a å bï¼å®ä»¬é½éè¦éè¿ metaclass=singleton æ¥éæ© singleton ä½ä¸ºå®ä»¬çåç±»ã\n\nå¨åç±»ä¸­ï¼åå»º __call__ æ¹æ³ï¼è¯¥æ¹æ³ä¼å¨ class a å b åå»ºå¯¹è±¡æ¶è°ç¨ï¼å¨è¯¥æ¹æ³ä¸­ä¼è°ç¨ __new__ å __init__ æ¹æ³ï¼åå»ºå®å¯¹è±¡åï¼åå°è¯¥å¯¹è±¡æ¾å¨ç±»åé _instance ä¸­ï¼å 1. å¨__new__ä¸­å®ç°åä¾ çæ¹æ³ä¸æ ·ã\n\nfrom typing import any\n\nclass singleton(type):\n    def __call__(self, *args: any, **kwds: any) -> any:\n        if not hasattr(self, "_instance"):\n            self._instance = super(singleton, self).__call__(*args, **kwds)\n\n        return self._instance\n\nclass a(metaclass=singleton):\n    pass\n\nclass b(metaclass=singleton):\n    pass\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næä»¬åéè¿æµè¯ï¼å¯ä»¥çå° class a å b é½å®ç°äºåä¾ã\n\na1 = a()\na2 = a()\nprint(id(a1))\nprint(id(a2))\n\nb1 = b()\nb2 = b()\nprint(id(b1))\nprint(id(b2))\n\noutput:\n>>> 2802632572784\n>>> 2802632572784\n>>> 2802632572400\n>>> 2802632572400\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nä½è¿ä¸ªåä¾è®¾è®¡åªéç¨äºåçº¿ç¨ï¼å¨å¤çº¿ç¨ä¸­ï¼å¦æä¸¤ä¸ªçº¿ç¨é½åç hasattr ä¸é¢ï¼å¯è½è¿æ¯ä¼åå»ºä¸¤ä¸ªå¯¹è±¡ï¼è¾¾ä¸å°åä¾çææã\n\n * ç¬¬äºç\n\néè¿å éè§£å³ä¸é¢å¹¶åçé®é¢ã\n\nimport threading\n\nclass singleton(type):\n    lock = threading.lock()\n    \n    def __call__(self, *args: any, **kwds: any) -> any:\n        with singleton.lock:\n            if not hasattr(self, "_instance"):\n                self._instance = super(singleton, self).__call__(*args, **kwds)\n\n        return self._instance\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nä½æ¯å¶å®åªæç¬¬ä¸æ¬¡åå»ºå¯¹è±¡æ¶ï¼éè¦éè¿éåæ­¥è·ååä¾å¯¹è±¡ï¼å¨å·²æå¯¹è±¡æ¶ï¼ä¸éè¦åç¨éäºï¼å¨è¿ç§æåµä¸ï¼æ¯æ¬¡è·åå¯¹è±¡é½ç»è¿éï¼ä¼å½±åæ§è½ã\n\n * æç»ç\n\næä»¥åå ä¸ä¸éå¤æ­ï¼åå°æ¯æ¬¡éå¤æ­å¸¦æ¥çæ§è½æ¶èã\n\nimport threading\nclass singleton(type):\n    lock = threading.lock()\n    \n    def __call__(self, *args: any, **kwds: any) -> any:\n        if not hasattr(self, "_instance"):\n            with singleton.lock:\n                if not hasattr(self, "_instance"):\n                    self._instance = super(singleton, self).__call__(*args, **kwds)\n\n        return self._instance\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 3. éè¿è£é¥°å¨å®ç°åä¾\n\nè¯¥æ¹æ³æ¯éè¿å®ç°ä¸ä¸ªè£é¥°å¨ï¼å¨éè¦å®ç°ç±»ä¸æ·»å è¯¥è£é¥°å¨å³å¯å®æï¼ä½¿ç¨ç®åã\n\néè¿å°ææçåä¾å¯¹è±¡ä¿å­å¨è£é¥°å¨ç _instance å­å¸ä¸­ï¼ä»¥ç±»ä¸º keyï¼å¯¹è±¡ä¸º value è¿è¡å­å¨ã\n\ndef singleton(cls):\n    _instance = {}\n    def _singleton(*args, **kargs):\n        if cls not in _instance:\n            _instance[cls] = cls(*args, **kargs)\n        return _instance[cls]\n    return _singleton\n@singleton\nclass a:\n    pass\n  \n@singleton\nclass b:\n    pass\n  \n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pythonä¸­importåç",frontmatter:{title:"pythonä¸­importåç",date:"2023-02-07T09:34:33.000Z",permalink:"/pages/d8fd49/",categories:["ç¼ç¨","python","åºç¡"],tags:["python"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»pythonæ­£å¨import moduleæ¶åäºä»ä¹ï¼å®åæ¯å¦ä½å è½½moduleçã",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"pythonä¸­importåç"},{name:"twitter:description",content:"æ¬æä»ç»pythonæ­£å¨import moduleæ¶åäºä»ä¹ï¼å®åæ¯å¦ä½å è½½moduleçã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/07.python%E4%B8%ADimport%E5%8E%9F%E7%90%86.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonä¸­importåç"},{property:"og:description",content:"æ¬æä»ç»pythonæ­£å¨import moduleæ¶åäºä»ä¹ï¼å®åæ¯å¦ä½å è½½moduleçã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/07.python%E4%B8%ADimport%E5%8E%9F%E7%90%86.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-02-07T09:34:33.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonä¸­importåç"},{itemprop:"description",content:"æ¬æä»ç»pythonæ­£å¨import moduleæ¶åäºä»ä¹ï¼å®åæ¯å¦ä½å è½½moduleçã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/07.python%E4%B8%ADimport%E5%8E%9F%E7%90%86.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/07.pythonä¸­importåç.md",key:"v-a7079bc2",path:"/pages/d8fd49/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. ä»ä¹æ¯ moduleï¼",slug:"_1-ä»ä¹æ¯-module",normalizedTitle:"1. ä»ä¹æ¯ moduleï¼",charIndex:84},{level:2,title:"2. ä»ä¹æ¯ Package?",slug:"_2-ä»ä¹æ¯-package",normalizedTitle:"2. ä»ä¹æ¯ package?",charIndex:471},{level:2,title:"3. module ç¼å­",slug:"_3-module-ç¼å­",normalizedTitle:"3. module ç¼å­",charIndex:1510},{level:2,title:"4. æç´¢è·¯å¾",slug:"_4-æç´¢è·¯å¾",normalizedTitle:"4. æç´¢è·¯å¾",charIndex:4108},{level:2,title:"5. æ»ç»",slug:"_5-æ»ç»",normalizedTitle:"5. æ»ç»",charIndex:4366},{level:2,title:"6. å å¥è¾è®¯äºå¼åèç¤¾åº",slug:"_6-å å¥è¾è®¯äºå¼åèç¤¾åº",normalizedTitle:"6. å å¥è¾è®¯äºå¼åèç¤¾åº",charIndex:4527}],headersStr:"0. åè¨ 1. ä»ä¹æ¯ moduleï¼ 2. ä»ä¹æ¯ Package? 3. module ç¼å­ 4. æç´¢è·¯å¾ 5. æ»ç» 6. å å¥è¾è®¯äºå¼åèç¤¾åº",content:"# 0. åè¨\n\nå¨ python ä¸­å¼å¥ Module æ¯åå¸¸è§ä¸è¿äºï¼é£ä¹å½æä»¬ import æ¶å®åäºä»ä¹äºæå¢ï¼å®æ¯å¦ä½å è½½ Module ä½¿ç¨çå¢ï¼\n\n\n# 1. ä»ä¹æ¯ moduleï¼\n\nä¸è¬ï¼Module æ¯ä¸ä¸ªåç¼ä¸º .py çæä»¶ï¼å¶ module åç§°ä¸è¬æ¯æä»¶åç§°å»é¤ .pyï¼æä»¬å¯ä»¥éè¿ __name__ æ¥æ¥ç module åç§°ã\n\ndemo.py æ¯éè¦è¢«å¼å¥ç moduleï¼main.py æ¯å¥å£ç¨åºï¼å®ä»¬å¨åä¸çº§ç®å½ã\n\n# demo.py\nprint(__name__)\n\n# main.py\nimport demo\n\n>>> python main.py\ndemo\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¦æ module ä¸ºå¥å£æä»¶ï¼å__name__ä¸º __main__ï¼è¿ä¹æ¯å¸¸è§ if __name__ == __main__: çåæ³ç±æ¥ã\n\n# demo.py\nprint(__name__)\n\n>>> python demo.py\n__main__\n\n\n1\n2\n3\n4\n5\n\n\n\n# 2. ä»ä¹æ¯ Package?\n\nåå«äº __init__ æä»¶çç®å½ä¸º Packageï¼è¯¥ç®å½åå«å¤ä¸ª py æä»¶ï¼é½å±äº Moduleãæä»¬å¨ import package æ¶ï¼ä¼åå§åæ§è¡ package ç __init__.py æä»¶ï¼ç¶åå°å¶ä½ä¸ºä¸ä¸ª Module å¯¹è±¡ç»æ¾å¨å½åçå¨å±åéä¸­ã\n\nââââdemo\nâ   â   __init__.py\n|   main.py\n\n\n1\n2\n3\n\n\n# __init__.py\nprint(\"demo __init__\")\n\n# main.py\nimport demo\nprint(demo)\nprint(globals()[\"demo\"])\n\n>>> python main.py\noutput: \ndemo __init__.py\n<module 'demo' from 'D:\\\\code\\\\my_demo\\\\demo\\\\__init__.py'>\n<module 'demo' from 'D:\\\\code\\\\my_demo\\\\demo\\\\__init__.py'>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¯ä»¥çå° package çåç§° demo æ¯å¨ globals()ä¸­çï¼å¹¶ä¸å¶æ¯ä¸ä¸ª module å¯¹è±¡ï¼åå«äºè¯¥ __init__.py æä»¶æå¨çè·¯å¾ã\n\nå¦ææ³è¦å¯¼å¥ package ä¸ç moduleï¼å¯ä»¥éè¿ from package import module çæ¹å¼å°å¶å è½½å°å½åçå¨å±åéä¸­ã\n\nââââdemo\nâ   â   __init__.py\n|   |   a.py\n|   main.py\n\n\n1\n2\n3\n4\n\n\n# __init__.py\n\n# a.py\nclass Demo:\n\tpass\n\n# main.py\nfrom demo import a\nprint(a)\nprint(a.Demo)\nprint(globals()[\"a\"])\n\n>>> python main.py\n<module 'demo.a' from 'D:\\\\code\\\\my_demo\\\\demo\\\\a.py'>\n<class 'demo.a.Demo'>\n<module 'demo.a' from 'D:\\\\code\\\\my_demo\\\\demo\\\\a.py'>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# 3. module ç¼å­\n\n * module ç¼å­åå§å\n\nå¨ python ç¨åºåå§åæ¶ï¼ä¼å°å¤§æ¹çåç½® module æåå è½½å°åå­ä¸­ï¼ä¿å­å¨ sys.modules ä¸­ï¼è¿æ¯ä¸ä¸ªå­å¸ï¼æ¯ä»¥ module åç§°æè package åç§°ä¸º keyï¼module å¯¹è±¡ä¸º value å­å¨ã\n\n>>> import sys\n>>> sys.modules\n{... 'os': <module 'os' from '/usr/lib64/python3.6/os.py'> ...}\n>>> sys.modules[\"os\"].cpu_count()\n8\n>>> os.cpu_count()\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nNameError: name 'os' is not defined\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n * å° module æ·»å å°å½åå»å¨å±åéä¸­\n\næ¢ç¶æåå è½½äºï¼ä½æ¯è¿éä¸ºä»ä¹æ¾ä¸å° os å¢ï¼è¿æ¯å ä¸ºè½ç¶ sys.modules ä¸­å·²ç»å­å¨äºï¼ä½æ¯å¹¶æ²¡ææ os å å¥å°å½åçå¨å±åéä¸­ã\n\n>>> globals()[\"os\"]\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nKeyError: 'os'\n\n\n1\n2\n3\n4\n\n\næä»¥å½æä»¬éè¿ import os æ¶ï¼å®ä¼éè¿æ¨¡ååç§°å¨ sys.modules æ¾å°å¶ module å¯¹è±¡ï¼ç¶ååå°å¶å å¥å°å½åçå¨å±åéä¸­ï¼è¿æ ·å°±å¯ä»¥ä½¿ç¨å®äºã\n\n>>> import os\n>>> globals()[\"os\"]\n<module 'os' from '/usr/lib64/python3.6/os.py'>\n>>> os.cpu_count()\n8\n>>> id(sys.modules[\"os\"])\n140260375998856\n>>> id(os)\n140260375998856\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¯ä»¥çå°ä» sys.modules ä¸­æ¿å°ç os å¯¹è±¡çå°ååå½åå¯¼å¥ç os çå°åæ¯ä¸è´çï¼æ è®º import å¤å°æ¬¡ç¸åç moduleï¼é½æ¯ä»è¯¥å¨å± sys.modules ä¸­è·åï¼æ¿å°çé½æ¯åä¸ä¸ªå¯¹è±¡ï¼ä¹æ¯åä¾æ¨¡å¼å®ç°çä¸ç§ã\n\n * å¯¼å¥ module ä¸­çå±æ§\n\nå¦ææåªæ¯å¼å¥ module ä¸­çä¸ä¸ªå±æ§åéå¢ï¼é£ sys.modules ä¸­è¿æ¯ä¼å è½½è¯¥ moduleï¼å°å¶å±æ§åéä½ä¸ºå¨å±åéå¼å¥ã\n\n>>> import sys\n>>> sys.modules[\"json\"]\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nKeyError: 'json'\n>>> from json import load\n>>> sys.modules[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n * æ¨¡åä¸éè¦äºï¼del éæ¯\n\ndel éæ¯çåªæ¯éæ¯å½åå¨å±åéä¸­çåéï¼å¹¶ä¸ä¼å½±å sys.modules ä¸­çç¼å­ãä¸ºä»ä¹ä¸éæ¯ sys.modules ä¸­çå¢ï¼æ¯å ä¸ºè¯¥éæ¯ç module å¯è½è¿ä¼å¨å¶ä»çæä»¶ä¸­å¼ç¨ã\n\n>>> import json\n>>> import sys\n>>> sys.modules[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n>>> globals()[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n>>> del json\n>>> sys.modules[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n>>> globals()[\"json\"]\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nKeyError: 'json'\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n * module éæ°å è½½\n\nå ä¸ºæ¯æ¬¡ import é½æ¯ä» sys.modules çç¼å­ä¸­è·åï¼é£ä¹å¦æ module æä»¶åå¨ï¼åæ æ³æ¿å°ææ°ç moduleï¼è¿ä¸ªæ¶åéè¦éè¿æå¨è°ç¨ importlib.reload æ¥éæ°å è½½ï¼ä»æ¬å°æä»¶ä¸­éæ°å è½½ module å¯¹è±¡å° sys.modules ä¸­ã\n\nå¨å½åç®å½ä¸åå»º demo.py æä»¶ï¼åå®¹ä¸ºç©º\n\n# demo.py\n\n>>> import demo\n>>> demo.Demo\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nAttributeError: module 'demo' has no attribute 'Demo'\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nè¿ä¸ªæ¶åå¨ demo.py ä¸­æ·»å ï¼\n\nclass Demo:\n    pass\n\n\n1\n2\n\n\nreload demo åï¼å¯ä»¥çå°å è½½å° Demo äºã\n\n>>> reload(demo)\n<module 'demo' from '/root/work/mydemo/demo.py'>\n>>> demo.Demo\n<class 'demo.Demo'>\n\n\n1\n2\n3\n4\n\n\né£å¦æ import ç module æè package æ²¡æå¨ sys.modules ä¸­å¢ï¼è¿ä¸ªæ¶åå°±è¦å» sys.path ä¸­å»æ¬å°æç´¢äºã\n\n\n# 4. æç´¢è·¯å¾\n\nsys.path æ¯ä¸ä¸ªåè¡¨ï¼å¶ä¸­åå«äºè¦å»æç´¢ module çæ¬å°è·¯å¾ãå½ sys.modules ä¸­æ¥æ¾ä¸å° module æ¶ï¼å°ä¼ä»è¯¥è·¯å¾ä¸­æç´¢å° module æä»¶å¹¶å°å¶å è½½å° sys.modules ä¸­æ¥ã\n\nsys.path çè·¯å¾çæ¥æºæï¼\n\n * è¿è¡èæ¬æå¨çç®å½\n * PYTHONPATH ç¯å¢åé\n * python å®è£æ¶çé»è®¤è®¾ç½®\n\nå½å¨æç´¢è·¯å¾æ¾å°è¯¥ module çæ¬å°è·¯å¾åï¼ä¼å°å¶å è½½å° sys.modules ä¸­ï¼ç¶ååå°å¶æ·»å å°å½åçå¨å±åéä¸­ã\n\n\n# 5. æ»ç»\n\nimport çå è½½è¿ç¨ï¼\n\n 1. åä» sys.modules ä¸­æ¥çæ¯å¦æå¯¼å¥çæ¨¡åï¼æï¼åè·åè¯¥æ¨¡åï¼å¹¶å å¥å°å½åçå¨å±åéä¸­ã\n 2. å¦æ sys.modules ä¸­æ²¡æéè¦å¯¼å¥çæ¨¡åï¼åæç§ sys.path ä¸­çç®å½è·¯å¾è¿è¡æç´¢æ¾å°å¯¹åºçæ¨¡åæä»¶åå è½½å° module å¯¹è±¡ä¸­è¿åã\n\n\n# 6. å å¥è¾è®¯äºå¼åèç¤¾åº\n\næçåå®¢å³å°åæ­¥è³è¾è®¯äºå¼åèç¤¾åºï¼éè¯·å¤§å®¶ä¸åå¥é©»ï¼https://cloud.tencent.com/developer/support-plan?invite_code=3u3wcswfaeiok",normalizedContent:"# 0. åè¨\n\nå¨ python ä¸­å¼å¥ module æ¯åå¸¸è§ä¸è¿äºï¼é£ä¹å½æä»¬ import æ¶å®åäºä»ä¹äºæå¢ï¼å®æ¯å¦ä½å è½½ module ä½¿ç¨çå¢ï¼\n\n\n# 1. ä»ä¹æ¯ moduleï¼\n\nä¸è¬ï¼module æ¯ä¸ä¸ªåç¼ä¸º .py çæä»¶ï¼å¶ module åç§°ä¸è¬æ¯æä»¶åç§°å»é¤ .pyï¼æä»¬å¯ä»¥éè¿ __name__ æ¥æ¥ç module åç§°ã\n\ndemo.py æ¯éè¦è¢«å¼å¥ç moduleï¼main.py æ¯å¥å£ç¨åºï¼å®ä»¬å¨åä¸çº§ç®å½ã\n\n# demo.py\nprint(__name__)\n\n# main.py\nimport demo\n\n>>> python main.py\ndemo\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¦æ module ä¸ºå¥å£æä»¶ï¼å__name__ä¸º __main__ï¼è¿ä¹æ¯å¸¸è§ if __name__ == __main__: çåæ³ç±æ¥ã\n\n# demo.py\nprint(__name__)\n\n>>> python demo.py\n__main__\n\n\n1\n2\n3\n4\n5\n\n\n\n# 2. ä»ä¹æ¯ package?\n\nåå«äº __init__ æä»¶çç®å½ä¸º packageï¼è¯¥ç®å½åå«å¤ä¸ª py æä»¶ï¼é½å±äº moduleãæä»¬å¨ import package æ¶ï¼ä¼åå§åæ§è¡ package ç __init__.py æä»¶ï¼ç¶åå°å¶ä½ä¸ºä¸ä¸ª module å¯¹è±¡ç»æ¾å¨å½åçå¨å±åéä¸­ã\n\nââââdemo\nâ   â   __init__.py\n|   main.py\n\n\n1\n2\n3\n\n\n# __init__.py\nprint(\"demo __init__\")\n\n# main.py\nimport demo\nprint(demo)\nprint(globals()[\"demo\"])\n\n>>> python main.py\noutput: \ndemo __init__.py\n<module 'demo' from 'd:\\\\code\\\\my_demo\\\\demo\\\\__init__.py'>\n<module 'demo' from 'd:\\\\code\\\\my_demo\\\\demo\\\\__init__.py'>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nå¯ä»¥çå° package çåç§° demo æ¯å¨ globals()ä¸­çï¼å¹¶ä¸å¶æ¯ä¸ä¸ª module å¯¹è±¡ï¼åå«äºè¯¥ __init__.py æä»¶æå¨çè·¯å¾ã\n\nå¦ææ³è¦å¯¼å¥ package ä¸ç moduleï¼å¯ä»¥éè¿ from package import module çæ¹å¼å°å¶å è½½å°å½åçå¨å±åéä¸­ã\n\nââââdemo\nâ   â   __init__.py\n|   |   a.py\n|   main.py\n\n\n1\n2\n3\n4\n\n\n# __init__.py\n\n# a.py\nclass demo:\n\tpass\n\n# main.py\nfrom demo import a\nprint(a)\nprint(a.demo)\nprint(globals()[\"a\"])\n\n>>> python main.py\n<module 'demo.a' from 'd:\\\\code\\\\my_demo\\\\demo\\\\a.py'>\n<class 'demo.a.demo'>\n<module 'demo.a' from 'd:\\\\code\\\\my_demo\\\\demo\\\\a.py'>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# 3. module ç¼å­\n\n * module ç¼å­åå§å\n\nå¨ python ç¨åºåå§åæ¶ï¼ä¼å°å¤§æ¹çåç½® module æåå è½½å°åå­ä¸­ï¼ä¿å­å¨ sys.modules ä¸­ï¼è¿æ¯ä¸ä¸ªå­å¸ï¼æ¯ä»¥ module åç§°æè package åç§°ä¸º keyï¼module å¯¹è±¡ä¸º value å­å¨ã\n\n>>> import sys\n>>> sys.modules\n{... 'os': <module 'os' from '/usr/lib64/python3.6/os.py'> ...}\n>>> sys.modules[\"os\"].cpu_count()\n8\n>>> os.cpu_count()\ntraceback (most recent call last):\n  file \"<stdin>\", line 1, in <module>\nnameerror: name 'os' is not defined\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n * å° module æ·»å å°å½åå»å¨å±åéä¸­\n\næ¢ç¶æåå è½½äºï¼ä½æ¯è¿éä¸ºä»ä¹æ¾ä¸å° os å¢ï¼è¿æ¯å ä¸ºè½ç¶ sys.modules ä¸­å·²ç»å­å¨äºï¼ä½æ¯å¹¶æ²¡ææ os å å¥å°å½åçå¨å±åéä¸­ã\n\n>>> globals()[\"os\"]\ntraceback (most recent call last):\n  file \"<stdin>\", line 1, in <module>\nkeyerror: 'os'\n\n\n1\n2\n3\n4\n\n\næä»¥å½æä»¬éè¿ import os æ¶ï¼å®ä¼éè¿æ¨¡ååç§°å¨ sys.modules æ¾å°å¶ module å¯¹è±¡ï¼ç¶ååå°å¶å å¥å°å½åçå¨å±åéä¸­ï¼è¿æ ·å°±å¯ä»¥ä½¿ç¨å®äºã\n\n>>> import os\n>>> globals()[\"os\"]\n<module 'os' from '/usr/lib64/python3.6/os.py'>\n>>> os.cpu_count()\n8\n>>> id(sys.modules[\"os\"])\n140260375998856\n>>> id(os)\n140260375998856\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¯ä»¥çå°ä» sys.modules ä¸­æ¿å°ç os å¯¹è±¡çå°ååå½åå¯¼å¥ç os çå°åæ¯ä¸è´çï¼æ è®º import å¤å°æ¬¡ç¸åç moduleï¼é½æ¯ä»è¯¥å¨å± sys.modules ä¸­è·åï¼æ¿å°çé½æ¯åä¸ä¸ªå¯¹è±¡ï¼ä¹æ¯åä¾æ¨¡å¼å®ç°çä¸ç§ã\n\n * å¯¼å¥ module ä¸­çå±æ§\n\nå¦ææåªæ¯å¼å¥ module ä¸­çä¸ä¸ªå±æ§åéå¢ï¼é£ sys.modules ä¸­è¿æ¯ä¼å è½½è¯¥ moduleï¼å°å¶å±æ§åéä½ä¸ºå¨å±åéå¼å¥ã\n\n>>> import sys\n>>> sys.modules[\"json\"]\ntraceback (most recent call last):\n  file \"<stdin>\", line 1, in <module>\nkeyerror: 'json'\n>>> from json import load\n>>> sys.modules[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n * æ¨¡åä¸éè¦äºï¼del éæ¯\n\ndel éæ¯çåªæ¯éæ¯å½åå¨å±åéä¸­çåéï¼å¹¶ä¸ä¼å½±å sys.modules ä¸­çç¼å­ãä¸ºä»ä¹ä¸éæ¯ sys.modules ä¸­çå¢ï¼æ¯å ä¸ºè¯¥éæ¯ç module å¯è½è¿ä¼å¨å¶ä»çæä»¶ä¸­å¼ç¨ã\n\n>>> import json\n>>> import sys\n>>> sys.modules[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n>>> globals()[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n>>> del json\n>>> sys.modules[\"json\"]\n<module 'json' from '/usr/lib64/python3.6/json/__init__.py'>\n>>> globals()[\"json\"]\ntraceback (most recent call last):\n  file \"<stdin>\", line 1, in <module>\nkeyerror: 'json'\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n * module éæ°å è½½\n\nå ä¸ºæ¯æ¬¡ import é½æ¯ä» sys.modules çç¼å­ä¸­è·åï¼é£ä¹å¦æ module æä»¶åå¨ï¼åæ æ³æ¿å°ææ°ç moduleï¼è¿ä¸ªæ¶åéè¦éè¿æå¨è°ç¨ importlib.reload æ¥éæ°å è½½ï¼ä»æ¬å°æä»¶ä¸­éæ°å è½½ module å¯¹è±¡å° sys.modules ä¸­ã\n\nå¨å½åç®å½ä¸åå»º demo.py æä»¶ï¼åå®¹ä¸ºç©º\n\n# demo.py\n\n>>> import demo\n>>> demo.demo\ntraceback (most recent call last):\n  file \"<stdin>\", line 1, in <module>\nattributeerror: module 'demo' has no attribute 'demo'\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nè¿ä¸ªæ¶åå¨ demo.py ä¸­æ·»å ï¼\n\nclass demo:\n    pass\n\n\n1\n2\n\n\nreload demo åï¼å¯ä»¥çå°å è½½å° demo äºã\n\n>>> reload(demo)\n<module 'demo' from '/root/work/mydemo/demo.py'>\n>>> demo.demo\n<class 'demo.demo'>\n\n\n1\n2\n3\n4\n\n\né£å¦æ import ç module æè package æ²¡æå¨ sys.modules ä¸­å¢ï¼è¿ä¸ªæ¶åå°±è¦å» sys.path ä¸­å»æ¬å°æç´¢äºã\n\n\n# 4. æç´¢è·¯å¾\n\nsys.path æ¯ä¸ä¸ªåè¡¨ï¼å¶ä¸­åå«äºè¦å»æç´¢ module çæ¬å°è·¯å¾ãå½ sys.modules ä¸­æ¥æ¾ä¸å° module æ¶ï¼å°ä¼ä»è¯¥è·¯å¾ä¸­æç´¢å° module æä»¶å¹¶å°å¶å è½½å° sys.modules ä¸­æ¥ã\n\nsys.path çè·¯å¾çæ¥æºæï¼\n\n * è¿è¡èæ¬æå¨çç®å½\n * pythonpath ç¯å¢åé\n * python å®è£æ¶çé»è®¤è®¾ç½®\n\nå½å¨æç´¢è·¯å¾æ¾å°è¯¥ module çæ¬å°è·¯å¾åï¼ä¼å°å¶å è½½å° sys.modules ä¸­ï¼ç¶ååå°å¶æ·»å å°å½åçå¨å±åéä¸­ã\n\n\n# 5. æ»ç»\n\nimport çå è½½è¿ç¨ï¼\n\n 1. åä» sys.modules ä¸­æ¥çæ¯å¦æå¯¼å¥çæ¨¡åï¼æï¼åè·åè¯¥æ¨¡åï¼å¹¶å å¥å°å½åçå¨å±åéä¸­ã\n 2. å¦æ sys.modules ä¸­æ²¡æéè¦å¯¼å¥çæ¨¡åï¼åæç§ sys.path ä¸­çç®å½è·¯å¾è¿è¡æç´¢æ¾å°å¯¹åºçæ¨¡åæä»¶åå è½½å° module å¯¹è±¡ä¸­è¿åã\n\n\n# 6. å å¥è¾è®¯äºå¼åèç¤¾åº\n\næçåå®¢å³å°åæ­¥è³è¾è®¯äºå¼åèç¤¾åºï¼éè¯·å¤§å®¶ä¸åå¥é©»ï¼https://cloud.tencent.com/developer/support-plan?invite_code=3u3wcswfaeiok",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pythonè£é¥°å¨çä½¿ç¨æ¹æ³",frontmatter:{title:"pythonè£é¥°å¨çä½¿ç¨æ¹æ³",date:"2022-10-23T17:18:08.000Z",permalink:"/pages/7434f1/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»pythonä¸­çè£é¥°å¨çå ç§å¸¸è§çä½¿ç¨æ¹æ³å¹¶çè§£å®ä»¬çå®ç°åçã",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","åºç¡"],comment:!0,meta:[{name:"twitter:title",content:"pythonè£é¥°å¨çä½¿ç¨æ¹æ³"},{name:"twitter:description",content:"ä»ç»pythonä¸­çè£é¥°å¨çå ç§å¸¸è§çä½¿ç¨æ¹æ³å¹¶çè§£å®ä»¬çå®ç°åçã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/05.python%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonè£é¥°å¨çä½¿ç¨æ¹æ³"},{property:"og:description",content:"ä»ç»pythonä¸­çè£é¥°å¨çå ç§å¸¸è§çä½¿ç¨æ¹æ³å¹¶çè§£å®ä»¬çå®ç°åçã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/05.python%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-10-23T17:18:08.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonè£é¥°å¨çä½¿ç¨æ¹æ³"},{itemprop:"description",content:"ä»ç»pythonä¸­çè£é¥°å¨çå ç§å¸¸è§çä½¿ç¨æ¹æ³å¹¶çè§£å®ä»¬çå®ç°åçã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/01.%E5%9F%BA%E7%A1%80/05.python%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95.html",relativePath:"04.ç¼ç¨/01.python/01.åºç¡/05.pythonè£é¥°å¨çä½¿ç¨æ¹æ³.md",key:"v-da2a3b40",path:"/pages/7434f1/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. ä½¿ç¨",slug:"_1-ä½¿ç¨",normalizedTitle:"1. ä½¿ç¨",charIndex:87},{level:3,title:"1.1 å¨å½æ°ä¸æ·»å è£é¥°å¨",slug:"_1-1-å¨å½æ°ä¸æ·»å è£é¥°å¨",normalizedTitle:"1.1 å¨å½æ°ä¸æ·»å è£é¥°å¨",charIndex:97},{level:3,title:"1.2 è£é¥°å¨çè¿è¡è¿ç¨",slug:"_1-2-è£é¥°å¨çè¿è¡è¿ç¨",normalizedTitle:"1.2 è£é¥°å¨çè¿è¡è¿ç¨",charIndex:547},{level:3,title:"1.3 ä¿å­åå½æ°ä¿¡æ¯",slug:"_1-3-ä¿å­åå½æ°ä¿¡æ¯",normalizedTitle:"1.3 ä¿å­åå½æ°ä¿¡æ¯",charIndex:1077},{level:3,title:"1.4 è°ç¨åå½æ°",slug:"_1-4-è°ç¨åå½æ°",normalizedTitle:"1.4 è°ç¨åå½æ°",charIndex:2311},{level:3,title:"1.5 å¸¦åæ°çè£é¥°å¨",slug:"_1-5-å¸¦åæ°çè£é¥°å¨",normalizedTitle:"1.5 å¸¦åæ°çè£é¥°å¨",charIndex:2824},{level:3,title:"1.6 å¸¦å¯éåæ°çè£é¥°å¨",slug:"_1-6-å¸¦å¯éåæ°çè£é¥°å¨",normalizedTitle:"1.6 å¸¦å¯éåæ°çè£é¥°å¨",charIndex:3581},{level:3,title:"1.7 å¨ç±»ä¸æ·»å è£é¥°å¨",slug:"_1-7-å¨ç±»ä¸æ·»å è£é¥°å¨",normalizedTitle:"1.7 å¨ç±»ä¸æ·»å è£é¥°å¨",charIndex:4553},{level:3,title:"1.8 ç±»è£é¥°å¨",slug:"_1-8-ç±»è£é¥°å¨",normalizedTitle:"1.8 ç±»è£é¥°å¨",charIndex:5209},{level:3,title:"1.9 æ´é²è¢«è£é¥°çåä¿¡æ¯",slug:"_1-9-æ´é²è¢«è£é¥°çåä¿¡æ¯",normalizedTitle:"1.9 æ´é²è¢«è£é¥°çåä¿¡æ¯",charIndex:5869},{level:3,title:"1.10 å¸¦åæ°çç±»è£é¥°å¨",slug:"_1-10-å¸¦åæ°çç±»è£é¥°å¨",normalizedTitle:"1.10 å¸¦åæ°çç±»è£é¥°å¨",charIndex:6595},{level:2,title:"2. æ»ç»",slug:"_2-æ»ç»",normalizedTitle:"2. æ»ç»",charIndex:7334},{level:2,title:"3. åèèµæ",slug:"_3-åèèµæ",normalizedTitle:"3. åèèµæ",charIndex:7395}],headersStr:"0. åè¨ 1. ä½¿ç¨ 1.1 å¨å½æ°ä¸æ·»å è£é¥°å¨ 1.2 è£é¥°å¨çè¿è¡è¿ç¨ 1.3 ä¿å­åå½æ°ä¿¡æ¯ 1.4 è°ç¨åå½æ° 1.5 å¸¦åæ°çè£é¥°å¨ 1.6 å¸¦å¯éåæ°çè£é¥°å¨ 1.7 å¨ç±»ä¸æ·»å è£é¥°å¨ 1.8 ç±»è£é¥°å¨ 1.9 æ´é²è¢«è£é¥°çåä¿¡æ¯ 1.10 å¸¦åæ°çç±»è£é¥°å¨ 2. æ»ç» 3. åèèµæ",content:'# 0. åè¨\n\nè£é¥°å¨å¨ python ä¸­ä½¿ç¨çé¢çéå¸¸é«ï¼å®å¯ä»¥å¨ä¸æ¹å¨åæå½æ°çåºç¡ä¸å¯¹å¶è¿è¡å¢å¼ºåè½ã\n\nä¸é¢ä¸»è¦æ¯ä»ç»è£é¥°å¨çåç§ç¨æ³ï¼å¹¶çè§£å¶è¿è¡è¿ç¨ã\n\n\n# 1. ä½¿ç¨\n\n\n# 1.1 å¨å½æ°ä¸æ·»å è£é¥°å¨\n\ndecro æ¯ä¸ä¸ªè£é¥°å¨å½æ°ï¼å¶å®ç°æ¯å°åé¨çå½æ° wrapper ä½ä¸ºè¿åå¼è¿ååºå»ã\n\nå¨å½æ° test ä¸æ·»å  @decro è¿è¡ä½¿ç¨ï¼å¯ä»¥å°æ¬å½æ°ä½ä¸ºä¸ä¸ªåæ°ä¼ å¥å° decro å½æ°ä¸­ï¼ç¶åï¼ç¶åå¾å°çæ¯è£é¥°å¨å½æ°åé¨è¿åçå½æ° wrapper, æä»¬å¨è°ç¨ test æ¹æ³æ¶ï¼å¶å®è°ç¨çæ¯è£é¥°å¨è¿åç wrapper å½æ°ï¼è¯¥å½æ°ä¸­ä¼è°ç¨è¢«è£é¥°çå½æ° test\n\ndef decro(func):  \n    def wrapper(*args, **kwargs):  \n        print("wrapper")  \n        return func()  \n  \n    return wrapper\n\n\n@decro  \ndef test():  \n    print("test")  \n\n\ntest()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nè¾åºï¼\n\nwrapper\ntest\n\n\n1\n2\n\n\n\n# 1.2 è£é¥°å¨çè¿è¡è¿ç¨\n\nè£é¥°å¨æ¶å¨è¢«è£é¥°çå½æ°å®ä¹ä¹åç«å³è¿è¡çï¼å½æ§è¡å°@decro è£é¥° test å½æ°æ¶ï¼ä¼é©¬ä¸æ§è¡å½æ° decroï¼ç¶åå° wrapper ç»è¿ååºå»ã\n\ndef decro(func):  \n    print("decro")  \n  \n    def wrapper(*args, **kwargs):  \n        print("wrapper")  \n        return func()  \n  \n    return wrapper  \n  \nprint("start")  \n  \n@decro  \ndef test():  \n    print("test")  \n  \nprint("end")\n\ntest()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nè¾åºå¦ä¸ï¼å¯ä»¥çå°åæ§è¡äº startï¼ç¶åé©¬ä¸æ§è¡äºè£é¥°å¨ decroï¼ç¶ååæ§è¡ endï¼å½æä»¬è°ç¨ test å½æ°æ¶ï¼æ§è¡äºè£é¥°å¨åé¨å½æ° wrapperï¼ç¶ååè°ç¨è¢«è£é¥°çå½æ° test\n\nstart\ndecro\nend\nwrapper\ntest\n\n\n1\n2\n3\n4\n5\n\n\n\n# 1.3 ä¿å­åå½æ°ä¿¡æ¯\n\nå¨ä½¿ç¨è£é¥°å¨æ¶ï¼è°ç¨çåæ¹æ³å·²ç»è¢«æ¿æ¢ä¸ºè£é¥°å¨è¿åçæ°æ¹æ³äºï¼æä»¥æ¹æ³çåä¿¡æ¯å·²ç»è¢«æ¿æ¢äº, éè¿ nameãdoc å¾å°çåæ°æ®å·²ç»è¢«æ¿æ¢æäºæ°æ¹æ³çã\n\ndef decro(func):  \n    def wrapper(*args, **kwargs):  \n        """ wrapper doc """  \n        print("wrapper")  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@decro  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \nprint("test\'s __name__ = {}".format(test.__name__))  \nprint("test\'s __doc__ = {}".format(test.__doc__))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nè¾åºå¦ä¸ï¼ä¼åç°å½æ° test çå½æ°ä¿¡æ¯ __name__ å __doc__ åæ wrapper çä¿¡æ¯ã\n\ntest\'s __name__ = wrapper\ntest\'s __doc__ =  wrapper doc\n\n\n1\n2\n\n\nä½æ¯æä»¬ä¸æ³è¦æ¹ååæ¹æ³çåä¿¡æ¯ï¼è¿ä¸ªæ¶åéè¦ä½¿ç¨ functools.wraps è§£å³ã\n\nfrom functools import wraps  \n  \ndef decro(func):  \n  \n    @wraps(func)  \n    def wrapper(*args, **kwargs):  \n        """ wrapper doc """  \n        print("wrapper")  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@decro  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \nprint("test\'s __name__ = {}".format(test.__name__))  \nprint("test\'s __doc__ = {}".format(test.__doc__))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¾åºå¦ä¸ï¼ä¼åç°ï¼test å½æ°ä¿¡æ¯æ²¡æè¢«æ¿æ¢æï¼ä¿è¯äºå½æ°çåæ±åå³ã\n\ntest\'s __name__ = test\ntest\'s __doc__ =  test doc \n\n\n1\n2\n\n\n\n# 1.4 è°ç¨åå½æ°\n\nè£é¥°å¨å¯ä»¥å¢å¼ºå½æ°çåè½ï¼ä½æ¯å¨æäºåºæ¯æå°±æ³è¦ä½¿ç¨åå½æ°ï¼èä¸æ³ä½¿ç¨è£é¥°ä¹åçå½æ°ï¼å¯ä»¥éè¿è°ç¨__wrapped__æ¥è°ç¨åå½æ°ã\n\nfrom functools import wraps  \n  \n\ndef decro(func):  \n    @wraps(func)  \n    def wrapper(*args, **kwargs):  \n        """ wrapper doc """  \n        print("wrapper")  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@decro  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \ntest.__wrapped__()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nè¾åºå¦ä¸ï¼è¾åº textï¼èæ²¡æè¾åº wrapperï¼è¯´æè°ç¨çæ¯åå½æ°ã\n\ntest\n\n\n1\n\n\n\n# 1.5 å¸¦åæ°çè£é¥°å¨\n\nè¿æè¿ä¹ä¸ç§åºæ¯ï¼æä»¬æ³è¦å¨è£é¥°å¨ä¸­æ·»å åæ°ã\n\næ³è¦éè¿åæ°å³å®æ¥å¿çº§å«ï¼è¿éç logged æ¥æ¶ level åæ°å¹¶å°å®ä½ç¨å¨åé¨å½æ°ä¸­ï¼è¿åå¼æ¯å° decro å½æ°è¿åï¼ç¶ååå°å½æ° test ä½ä¸ºåæ°ä»ä¼ å¥å° decro å½æ°ä¸­ï¼åå° wrapper è¿åï¼æç» test è¿æ¯æ¿æ¢æäº wrapperï¼å¨è¯¥æ¹æ³ä¸­ä½¿ç¨äºä¼ å¥ç ERROR çæ¥å¿çº§å«ã\n\nfrom functools import wraps  \nimport logging  \n  \n  \ndef logged(level):  \n    def decro(func):  \n        @wraps(func)  \n        def wrapper(*args, **kwargs):  \n            """ wrapper doc """  \n            logging.log(level, func.__name__)  \n            return func(*args, **kwargs)  \n  \n        return wrapper  \n  \n    return decro  \n  \n  \n@logged(level=logging.ERROR)  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \ntest()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\nè¾åºäº ERROR æ¥å¿çº§å«çæ¥å¿ï¼\n\nERROR:root:test\ntest\n\n\n1\n2\n\n\n\n# 1.6 å¸¦å¯éåæ°çè£é¥°å¨\n\nä¸é¢å®ç°çè£é¥°å¨æ¯å¿é¡»è¦å¸¦ä¸åæ°çï¼ä½æ¯æçæ¶åï¼æä»¬ä¸éè¦å¸¦åæ°ï¼é£ä¹è¯¥å¦ä½å®ç°ï¼\n\nè£é¥°å¨ç func é»è®¤å¼ä¸º Noneï¼å½ä¼ å¥ level åæ°æ¶ï¼åè¿ååå½æ° partial ï¼è¯¥å½æ°ä¼åºäº logged åå»ºä¸ä¸ªä»åå« level çæ°çå½æ°ï¼è¿ä¸ªæ°çå½æ°ä½ä¸ºæ°çè£é¥°å¨æ¥è£é¥° add å½æ°ã\n\nå½æ²¡æä¼ å¥ level åæ°æ¶ï¼å°±åæ®éçè£é¥°å¨ä¸æ ·ä½¿ç¨ã\n\nfrom functools import wraps, partial  \nimport logging  \n  \n  \ndef logged(func=None, level=logging.INFO):  \n    if func is None:  \n        return partial(logged, level=level)  \n  \n    @wraps(func)  \n    def wrapper(*args, **kwargs):  \n        logging.log(level, func.__name__)  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@logged(level=logging.ERROR)  \ndef add(a, b):  \n    print("add")  \n    return a + b  \n  \n  \n@logged  \ndef add2(a, b):  \n    print("add2")  \n    return a + b  \n  \n  \nprint(add(1, 2))  \nprint("-" * 10)  \nprint(add2(1, 2))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n\n\nè¾åºå¦ä¸ï¼add å½æ°çè£é¥°å¨ä¼ å¥äºæ¥å¿çº§å«ä¸º ERROR çåæ°ï¼è¾åºäº ERROR çæ¥å¿ï¼èadd2 æ²¡æã\n\nERROR:root:add\nadd\n3\n----------\nadd2\n3\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# 1.7 å¨ç±»ä¸æ·»å è£é¥°å¨\n\nä¸é¢é½æ¯ä½¿ç¨è£é¥°å¨æ¥å¢å¼ºå½æ°çåè½ï¼ä½å®è¿å¯ä»¥å¢å¼ºç±»çåè½ï¼å¯¹ç±»è¿è¡è£é¥°ã\n\nä¸é¢çä¾å­ä¸­ï¼decro å°è¢«è£é¥°çç±» Demo ä¼ å¥è¿æ¥ï¼ä¸»è¦æ¯å°å¶ç±»ä¸­ __getattribute__ æ¹æ³æ¿æ¢æäº new_getattribute æ¹æ³ã\n\ndef decro(cls):  \n    orig_getattribute = cls.__getattribute__  \n  \n    def new_getattribute(self, name):  \n        print("get name = {}".format(name))  \n        return orig_getattribute(self, name)  \n  \n    cls.__getattribute__ = new_getattribute  \n    return cls  \n  \n  \n@decro  \nclass Demo:  \n  \n    def __init__(self, num):  \n        self.num = num  \n  \n  \nd = Demo(1)  \nprint(d.num)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nè¾åºå¦ä¸ï¼è·å num çå¼æ¶ï¼è°ç¨äºè£é¥°å¨æ¿æ¢ç new_getattribute æ¹æ³ã\n\nget name = num\n1\n\n\n1\n2\n\n\n\n# 1.8 ç±»è£é¥°å¨\n\nä¹åé½æ¯ä½¿ç¨å½æ°æ¹æ³æ¥å®ä¹è£é¥°å¨ï¼ä½å¶å®ä¹å¯ä»¥éè¿ç±»æ¥å®ä¹è£é¥°å¨ã\n\nå¨ç±»è£é¥°å¨ä¸­å®ä¹__init__æ¹æ³ï¼è¢«å®è£é¥°çå½æ°ä¼è¢«ä¼ å¥å° func åæ°ä¸­ï¼è¿ä¸ªæ¶åè¯¥ç±»è£é¥°å¨å·²ç»è¢«å®ä¾åäºï¼ä¹å°±æ¯å°è¯¥å®ä¾å¯¹è±¡æ¿æ¢äºè¢«è£é¥°çå½æ° sayã\n\nå½æä»¬è°ç¨ say å½æ°æ¶ï¼å¶å®è°ç¨çæ¯ç±»è£é¥°å¨çå¯¹è±¡ï¼è¿ä¸ªæ¶åä¼è°ç¨__call__æ¹æ³ï¼è¯¥æ¹æ³ä¸­å¯ä»¥å¯¹åå½æ°è¿è¡å¢å¼ºï¼å¹¶è¿è¡è°ç¨åæ¹æ³ã\n\nclass logger(object):  \n    def __init__(self, func):  \n        self.func = func  \n  \n    def __call__(self, *args, **kwargs):  \n        print("the function {func}() is running...".format(func=self.func.__name__))  \n        return self.func(*args, **kwargs)  \n  \n  \n@logger  \ndef say(something):  \n    print("say {}!".format(something))  \n  \n  \nsay("hello")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¾åºå¦ä¸ï¼\n\nthe function say() is running...\nsay hello!\n\n\n1\n2\n\n\n\n# 1.9 æ´é²è¢«è£é¥°çåä¿¡æ¯\n\nè¿ä¸ªæ¶åä¼åºç°åå½æ°è£é¥°å¨ä¸æ ·çé®é¢ï¼é£å°±æ¯è¢«è£é¥°çå½æ°çåä¿¡æ¯å·²ç»è¢«æ¿æ¢æäºï¼è¿ä¸ªæ¶åæä»¬è¿æ¯æ³ä¿çåæçåä¿¡æ¯ã\n\nè¿æ¯ä½¿ç¨ wraps å½æ°æ¥è§£å³è¯¥é®é¢ã\n\nfrom functools import wraps  \n  \n  \nclass logger(object):  \n    """ logger doc """  \n  \n    def __init__(self, func):  \n        wraps(func)(self)  \n  \n    def __call__(self, *args, **kwargs):  \n        print("the function {func}() is running...".format(func=self.__wrapped__.__name__))  \n        return self.__wrapped__(*args, **kwargs)  \n  \n  \n@logger  \ndef say(something):  \n    """ say doc """  \n    print("say {}!".format(something))  \n  \n  \nsay("hello2")  \nprint(say.__doc__)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¾åºçæ¯ say æ¹æ³ç docï¼\n\nthe function say() is running...\nsay hello2!\n say doc \n\n\n1\n2\n3\n\n\n\n# 1.10 å¸¦åæ°çç±»è£é¥°å¨\n\né£ä¹å¸¦åæ°çç±»è£é¥°å¨è¯¥å¦ä½å®ç°å¢ï¼\n\nå¨ __init__ æ¹æ³ä¸­æ¥æ¶è£é¥°å¨ä¼ å¥çåæ°ï¼ä¿å­èµ·æ¥ï¼ç¶ååéè¿ __call__ å½æ°å°åé¨å½æ° wrapper ç»è¿ååºå»ï¼è¿ä¸ªæ¶åè¢«è£é¥°çå½æ°å·²ç»è¢« wrapper ç»æ¿æ¢äºã\n\nclass logger(object):  \n  \n    def __init__(self, level="INFO"):  \n        self.level = level  \n  \n    def __call__(self, func):  \n        def wrapper(*args, **kwargs): \n\t        print("[{level}]: the function {func}() is running...".format(level=self.level, func=func.__name__)) \n            func(*args, **kwargs)  \n  \n        return wrapper  \n  \n  \n@logger(level="ERROR")  \ndef say(something):  \n    print("say {}!".format(something))  \n  \n  \nsay("hello2")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nè¾åºå¦ä¸ï¼è°ç¨ say å½æ°ä¹å°±æ¯è°ç¨ wrapper å½æ°ï¼\n\n[ERROR]: the function say() is running...\nsay hello2!\n\n\n1\n2\n\n\n\n# 2. æ»ç»\n\nè£é¥°å¨çç¨æ³å¾å¤ï¼å°è£æåºï¼ç»å¶ä»äººä½¿ç¨ä¹éå¸¸çæ¹ä¾¿ï¼æä»¬éè¦çè§£å®çè¿è¡è¿ç¨ï¼æè½æ´å¥½çä½¿ç¨å®ã\n\n\n# 3. åèèµæ\n\n * https://python3-cookbook.readthedocs.io/zh_CN/latest/c09/p01_put_wrapper_around_function.html',normalizedContent:'# 0. åè¨\n\nè£é¥°å¨å¨ python ä¸­ä½¿ç¨çé¢çéå¸¸é«ï¼å®å¯ä»¥å¨ä¸æ¹å¨åæå½æ°çåºç¡ä¸å¯¹å¶è¿è¡å¢å¼ºåè½ã\n\nä¸é¢ä¸»è¦æ¯ä»ç»è£é¥°å¨çåç§ç¨æ³ï¼å¹¶çè§£å¶è¿è¡è¿ç¨ã\n\n\n# 1. ä½¿ç¨\n\n\n# 1.1 å¨å½æ°ä¸æ·»å è£é¥°å¨\n\ndecro æ¯ä¸ä¸ªè£é¥°å¨å½æ°ï¼å¶å®ç°æ¯å°åé¨çå½æ° wrapper ä½ä¸ºè¿åå¼è¿ååºå»ã\n\nå¨å½æ° test ä¸æ·»å  @decro è¿è¡ä½¿ç¨ï¼å¯ä»¥å°æ¬å½æ°ä½ä¸ºä¸ä¸ªåæ°ä¼ å¥å° decro å½æ°ä¸­ï¼ç¶åï¼ç¶åå¾å°çæ¯è£é¥°å¨å½æ°åé¨è¿åçå½æ° wrapper, æä»¬å¨è°ç¨ test æ¹æ³æ¶ï¼å¶å®è°ç¨çæ¯è£é¥°å¨è¿åç wrapper å½æ°ï¼è¯¥å½æ°ä¸­ä¼è°ç¨è¢«è£é¥°çå½æ° test\n\ndef decro(func):  \n    def wrapper(*args, **kwargs):  \n        print("wrapper")  \n        return func()  \n  \n    return wrapper\n\n\n@decro  \ndef test():  \n    print("test")  \n\n\ntest()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nè¾åºï¼\n\nwrapper\ntest\n\n\n1\n2\n\n\n\n# 1.2 è£é¥°å¨çè¿è¡è¿ç¨\n\nè£é¥°å¨æ¶å¨è¢«è£é¥°çå½æ°å®ä¹ä¹åç«å³è¿è¡çï¼å½æ§è¡å°@decro è£é¥° test å½æ°æ¶ï¼ä¼é©¬ä¸æ§è¡å½æ° decroï¼ç¶åå° wrapper ç»è¿ååºå»ã\n\ndef decro(func):  \n    print("decro")  \n  \n    def wrapper(*args, **kwargs):  \n        print("wrapper")  \n        return func()  \n  \n    return wrapper  \n  \nprint("start")  \n  \n@decro  \ndef test():  \n    print("test")  \n  \nprint("end")\n\ntest()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nè¾åºå¦ä¸ï¼å¯ä»¥çå°åæ§è¡äº startï¼ç¶åé©¬ä¸æ§è¡äºè£é¥°å¨ decroï¼ç¶ååæ§è¡ endï¼å½æä»¬è°ç¨ test å½æ°æ¶ï¼æ§è¡äºè£é¥°å¨åé¨å½æ° wrapperï¼ç¶ååè°ç¨è¢«è£é¥°çå½æ° test\n\nstart\ndecro\nend\nwrapper\ntest\n\n\n1\n2\n3\n4\n5\n\n\n\n# 1.3 ä¿å­åå½æ°ä¿¡æ¯\n\nå¨ä½¿ç¨è£é¥°å¨æ¶ï¼è°ç¨çåæ¹æ³å·²ç»è¢«æ¿æ¢ä¸ºè£é¥°å¨è¿åçæ°æ¹æ³äºï¼æä»¥æ¹æ³çåä¿¡æ¯å·²ç»è¢«æ¿æ¢äº, éè¿ nameãdoc å¾å°çåæ°æ®å·²ç»è¢«æ¿æ¢æäºæ°æ¹æ³çã\n\ndef decro(func):  \n    def wrapper(*args, **kwargs):  \n        """ wrapper doc """  \n        print("wrapper")  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@decro  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \nprint("test\'s __name__ = {}".format(test.__name__))  \nprint("test\'s __doc__ = {}".format(test.__doc__))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nè¾åºå¦ä¸ï¼ä¼åç°å½æ° test çå½æ°ä¿¡æ¯ __name__ å __doc__ åæ wrapper çä¿¡æ¯ã\n\ntest\'s __name__ = wrapper\ntest\'s __doc__ =  wrapper doc\n\n\n1\n2\n\n\nä½æ¯æä»¬ä¸æ³è¦æ¹ååæ¹æ³çåä¿¡æ¯ï¼è¿ä¸ªæ¶åéè¦ä½¿ç¨ functools.wraps è§£å³ã\n\nfrom functools import wraps  \n  \ndef decro(func):  \n  \n    @wraps(func)  \n    def wrapper(*args, **kwargs):  \n        """ wrapper doc """  \n        print("wrapper")  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@decro  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \nprint("test\'s __name__ = {}".format(test.__name__))  \nprint("test\'s __doc__ = {}".format(test.__doc__))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¾åºå¦ä¸ï¼ä¼åç°ï¼test å½æ°ä¿¡æ¯æ²¡æè¢«æ¿æ¢æï¼ä¿è¯äºå½æ°çåæ±åå³ã\n\ntest\'s __name__ = test\ntest\'s __doc__ =  test doc \n\n\n1\n2\n\n\n\n# 1.4 è°ç¨åå½æ°\n\nè£é¥°å¨å¯ä»¥å¢å¼ºå½æ°çåè½ï¼ä½æ¯å¨æäºåºæ¯æå°±æ³è¦ä½¿ç¨åå½æ°ï¼èä¸æ³ä½¿ç¨è£é¥°ä¹åçå½æ°ï¼å¯ä»¥éè¿è°ç¨__wrapped__æ¥è°ç¨åå½æ°ã\n\nfrom functools import wraps  \n  \n\ndef decro(func):  \n    @wraps(func)  \n    def wrapper(*args, **kwargs):  \n        """ wrapper doc """  \n        print("wrapper")  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@decro  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \ntest.__wrapped__()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nè¾åºå¦ä¸ï¼è¾åº textï¼èæ²¡æè¾åº wrapperï¼è¯´æè°ç¨çæ¯åå½æ°ã\n\ntest\n\n\n1\n\n\n\n# 1.5 å¸¦åæ°çè£é¥°å¨\n\nè¿æè¿ä¹ä¸ç§åºæ¯ï¼æä»¬æ³è¦å¨è£é¥°å¨ä¸­æ·»å åæ°ã\n\næ³è¦éè¿åæ°å³å®æ¥å¿çº§å«ï¼è¿éç logged æ¥æ¶ level åæ°å¹¶å°å®ä½ç¨å¨åé¨å½æ°ä¸­ï¼è¿åå¼æ¯å° decro å½æ°è¿åï¼ç¶ååå°å½æ° test ä½ä¸ºåæ°ä»ä¼ å¥å° decro å½æ°ä¸­ï¼åå° wrapper è¿åï¼æç» test è¿æ¯æ¿æ¢æäº wrapperï¼å¨è¯¥æ¹æ³ä¸­ä½¿ç¨äºä¼ å¥ç error çæ¥å¿çº§å«ã\n\nfrom functools import wraps  \nimport logging  \n  \n  \ndef logged(level):  \n    def decro(func):  \n        @wraps(func)  \n        def wrapper(*args, **kwargs):  \n            """ wrapper doc """  \n            logging.log(level, func.__name__)  \n            return func(*args, **kwargs)  \n  \n        return wrapper  \n  \n    return decro  \n  \n  \n@logged(level=logging.error)  \ndef test():  \n    """ test doc """  \n    print("test")  \n  \n  \ntest()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\nè¾åºäº error æ¥å¿çº§å«çæ¥å¿ï¼\n\nerror:root:test\ntest\n\n\n1\n2\n\n\n\n# 1.6 å¸¦å¯éåæ°çè£é¥°å¨\n\nä¸é¢å®ç°çè£é¥°å¨æ¯å¿é¡»è¦å¸¦ä¸åæ°çï¼ä½æ¯æçæ¶åï¼æä»¬ä¸éè¦å¸¦åæ°ï¼é£ä¹è¯¥å¦ä½å®ç°ï¼\n\nè£é¥°å¨ç func é»è®¤å¼ä¸º noneï¼å½ä¼ å¥ level åæ°æ¶ï¼åè¿ååå½æ° partial ï¼è¯¥å½æ°ä¼åºäº logged åå»ºä¸ä¸ªä»åå« level çæ°çå½æ°ï¼è¿ä¸ªæ°çå½æ°ä½ä¸ºæ°çè£é¥°å¨æ¥è£é¥° add å½æ°ã\n\nå½æ²¡æä¼ å¥ level åæ°æ¶ï¼å°±åæ®éçè£é¥°å¨ä¸æ ·ä½¿ç¨ã\n\nfrom functools import wraps, partial  \nimport logging  \n  \n  \ndef logged(func=none, level=logging.info):  \n    if func is none:  \n        return partial(logged, level=level)  \n  \n    @wraps(func)  \n    def wrapper(*args, **kwargs):  \n        logging.log(level, func.__name__)  \n        return func(*args, **kwargs)  \n  \n    return wrapper  \n  \n  \n@logged(level=logging.error)  \ndef add(a, b):  \n    print("add")  \n    return a + b  \n  \n  \n@logged  \ndef add2(a, b):  \n    print("add2")  \n    return a + b  \n  \n  \nprint(add(1, 2))  \nprint("-" * 10)  \nprint(add2(1, 2))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n\n\nè¾åºå¦ä¸ï¼add å½æ°çè£é¥°å¨ä¼ å¥äºæ¥å¿çº§å«ä¸º error çåæ°ï¼è¾åºäº error çæ¥å¿ï¼èadd2 æ²¡æã\n\nerror:root:add\nadd\n3\n----------\nadd2\n3\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# 1.7 å¨ç±»ä¸æ·»å è£é¥°å¨\n\nä¸é¢é½æ¯ä½¿ç¨è£é¥°å¨æ¥å¢å¼ºå½æ°çåè½ï¼ä½å®è¿å¯ä»¥å¢å¼ºç±»çåè½ï¼å¯¹ç±»è¿è¡è£é¥°ã\n\nä¸é¢çä¾å­ä¸­ï¼decro å°è¢«è£é¥°çç±» demo ä¼ å¥è¿æ¥ï¼ä¸»è¦æ¯å°å¶ç±»ä¸­ __getattribute__ æ¹æ³æ¿æ¢æäº new_getattribute æ¹æ³ã\n\ndef decro(cls):  \n    orig_getattribute = cls.__getattribute__  \n  \n    def new_getattribute(self, name):  \n        print("get name = {}".format(name))  \n        return orig_getattribute(self, name)  \n  \n    cls.__getattribute__ = new_getattribute  \n    return cls  \n  \n  \n@decro  \nclass demo:  \n  \n    def __init__(self, num):  \n        self.num = num  \n  \n  \nd = demo(1)  \nprint(d.num)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nè¾åºå¦ä¸ï¼è·å num çå¼æ¶ï¼è°ç¨äºè£é¥°å¨æ¿æ¢ç new_getattribute æ¹æ³ã\n\nget name = num\n1\n\n\n1\n2\n\n\n\n# 1.8 ç±»è£é¥°å¨\n\nä¹åé½æ¯ä½¿ç¨å½æ°æ¹æ³æ¥å®ä¹è£é¥°å¨ï¼ä½å¶å®ä¹å¯ä»¥éè¿ç±»æ¥å®ä¹è£é¥°å¨ã\n\nå¨ç±»è£é¥°å¨ä¸­å®ä¹__init__æ¹æ³ï¼è¢«å®è£é¥°çå½æ°ä¼è¢«ä¼ å¥å° func åæ°ä¸­ï¼è¿ä¸ªæ¶åè¯¥ç±»è£é¥°å¨å·²ç»è¢«å®ä¾åäºï¼ä¹å°±æ¯å°è¯¥å®ä¾å¯¹è±¡æ¿æ¢äºè¢«è£é¥°çå½æ° sayã\n\nå½æä»¬è°ç¨ say å½æ°æ¶ï¼å¶å®è°ç¨çæ¯ç±»è£é¥°å¨çå¯¹è±¡ï¼è¿ä¸ªæ¶åä¼è°ç¨__call__æ¹æ³ï¼è¯¥æ¹æ³ä¸­å¯ä»¥å¯¹åå½æ°è¿è¡å¢å¼ºï¼å¹¶è¿è¡è°ç¨åæ¹æ³ã\n\nclass logger(object):  \n    def __init__(self, func):  \n        self.func = func  \n  \n    def __call__(self, *args, **kwargs):  \n        print("the function {func}() is running...".format(func=self.func.__name__))  \n        return self.func(*args, **kwargs)  \n  \n  \n@logger  \ndef say(something):  \n    print("say {}!".format(something))  \n  \n  \nsay("hello")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¾åºå¦ä¸ï¼\n\nthe function say() is running...\nsay hello!\n\n\n1\n2\n\n\n\n# 1.9 æ´é²è¢«è£é¥°çåä¿¡æ¯\n\nè¿ä¸ªæ¶åä¼åºç°åå½æ°è£é¥°å¨ä¸æ ·çé®é¢ï¼é£å°±æ¯è¢«è£é¥°çå½æ°çåä¿¡æ¯å·²ç»è¢«æ¿æ¢æäºï¼è¿ä¸ªæ¶åæä»¬è¿æ¯æ³ä¿çåæçåä¿¡æ¯ã\n\nè¿æ¯ä½¿ç¨ wraps å½æ°æ¥è§£å³è¯¥é®é¢ã\n\nfrom functools import wraps  \n  \n  \nclass logger(object):  \n    """ logger doc """  \n  \n    def __init__(self, func):  \n        wraps(func)(self)  \n  \n    def __call__(self, *args, **kwargs):  \n        print("the function {func}() is running...".format(func=self.__wrapped__.__name__))  \n        return self.__wrapped__(*args, **kwargs)  \n  \n  \n@logger  \ndef say(something):  \n    """ say doc """  \n    print("say {}!".format(something))  \n  \n  \nsay("hello2")  \nprint(say.__doc__)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¾åºçæ¯ say æ¹æ³ç docï¼\n\nthe function say() is running...\nsay hello2!\n say doc \n\n\n1\n2\n3\n\n\n\n# 1.10 å¸¦åæ°çç±»è£é¥°å¨\n\né£ä¹å¸¦åæ°çç±»è£é¥°å¨è¯¥å¦ä½å®ç°å¢ï¼\n\nå¨ __init__ æ¹æ³ä¸­æ¥æ¶è£é¥°å¨ä¼ å¥çåæ°ï¼ä¿å­èµ·æ¥ï¼ç¶ååéè¿ __call__ å½æ°å°åé¨å½æ° wrapper ç»è¿ååºå»ï¼è¿ä¸ªæ¶åè¢«è£é¥°çå½æ°å·²ç»è¢« wrapper ç»æ¿æ¢äºã\n\nclass logger(object):  \n  \n    def __init__(self, level="info"):  \n        self.level = level  \n  \n    def __call__(self, func):  \n        def wrapper(*args, **kwargs): \n\t        print("[{level}]: the function {func}() is running...".format(level=self.level, func=func.__name__)) \n            func(*args, **kwargs)  \n  \n        return wrapper  \n  \n  \n@logger(level="error")  \ndef say(something):  \n    print("say {}!".format(something))  \n  \n  \nsay("hello2")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nè¾åºå¦ä¸ï¼è°ç¨ say å½æ°ä¹å°±æ¯è°ç¨ wrapper å½æ°ï¼\n\n[error]: the function say() is running...\nsay hello2!\n\n\n1\n2\n\n\n\n# 2. æ»ç»\n\nè£é¥°å¨çç¨æ³å¾å¤ï¼å°è£æåºï¼ç»å¶ä»äººä½¿ç¨ä¹éå¸¸çæ¹ä¾¿ï¼æä»¬éè¦çè§£å®çè¿è¡è¿ç¨ï¼æè½æ´å¥½çä½¿ç¨å®ã\n\n\n# 3. åèèµæ\n\n * https://python3-cookbook.readthedocs.io/zh_cn/latest/c09/p01_put_wrapper_around_function.html',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯",frontmatter:{title:"ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯",date:"2022-10-12T14:48:10.000Z",permalink:"/pages/8d9ab9/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»å¦ä½ä½¿ç¨ddtåºæ¥å®æunitestçåæ°åè®¾ç½®ã",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","ç¬¬ä¸æ¹åº"],comment:!0,meta:[{name:"twitter:title",content:"ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯"},{name:"twitter:description",content:"æ¬æä»ç»å¦ä½ä½¿ç¨ddtåºæ¥å®æunitestçåæ°åè®¾ç½®ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/01.%E4%BD%BF%E7%94%A8ddt%E5%AE%9E%E7%8E%B0unittest%E7%9A%84%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯"},{property:"og:description",content:"æ¬æä»ç»å¦ä½ä½¿ç¨ddtåºæ¥å®æunitestçåæ°åè®¾ç½®ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/01.%E4%BD%BF%E7%94%A8ddt%E5%AE%9E%E7%8E%B0unittest%E7%9A%84%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-10-12T14:48:10.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯"},{itemprop:"description",content:"æ¬æä»ç»å¦ä½ä½¿ç¨ddtåºæ¥å®æunitestçåæ°åè®¾ç½®ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/01.%E4%BD%BF%E7%94%A8ddt%E5%AE%9E%E7%8E%B0unittest%E7%9A%84%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95.html",relativePath:"04.ç¼ç¨/01.python/02.ç¬¬ä¸æ¹åº/01.ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯.md",key:"v-3644af7a",path:"/pages/8d9ab9/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. ä¸ºä»ä¹éè¦åæ°å",slug:"_1-ä¸ºä»ä¹éè¦åæ°å",normalizedTitle:"1. ä¸ºä»ä¹éè¦åæ°å",charIndex:67},{level:2,title:"2. ä½¿ç¨ddtå®ç°åæ°å",slug:"_2-ä½¿ç¨ddtå®ç°åæ°å",normalizedTitle:"2. ä½¿ç¨ddtå®ç°åæ°å",charIndex:677},{level:3,title:"2.1 åºæ¬ä½¿ç¨",slug:"_2-1-åºæ¬ä½¿ç¨",normalizedTitle:"2.1 åºæ¬ä½¿ç¨",charIndex:733},{level:3,title:"2.2 å¤ä¸ªå¼ä½¿ç¨åæ°å",slug:"_2-2-å¤ä¸ªå¼ä½¿ç¨åæ°å",normalizedTitle:"2.2 å¤ä¸ªå¼ä½¿ç¨åæ°å",charIndex:1735},{level:3,title:"2.3 åæ°åæå¹³ä½¿ç¨",slug:"_2-3-åæ°åæå¹³ä½¿ç¨",normalizedTitle:"2.3 åæ°åæå¹³ä½¿ç¨",charIndex:2586},{level:3,title:"2.4 å½ååæ°",slug:"_2-4-å½ååæ°",normalizedTitle:"2.4 å½ååæ°",charIndex:3419},{level:3,title:"2.5 ä»jsonæä»¶ä¸­è¯»ååæ°è¿è¡åæµ",slug:"_2-5-ä»jsonæä»¶ä¸­è¯»ååæ°è¿è¡åæµ",normalizedTitle:"2.5 ä»jsonæä»¶ä¸­è¯»ååæ°è¿è¡åæµ",charIndex:4254},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:5266}],headersStr:"0. åè¨ 1. ä¸ºä»ä¹éè¦åæ°å 2. ä½¿ç¨ddtå®ç°åæ°å 2.1 åºæ¬ä½¿ç¨ 2.2 å¤ä¸ªå¼ä½¿ç¨åæ°å 2.3 åæ°åæå¹³ä½¿ç¨ 2.4 å½ååæ° 2.5 ä»jsonæä»¶ä¸­è¯»ååæ°è¿è¡åæµ 3. æ»ç»",content:'# 0. åè¨\n\næ¬æä»ç»å¦ä½ä½¿ç¨ddtåºæ¥å®æunitestçåæ°åè®¾ç½®ã\n\nddtçgithubå°å\n\nddtçå®æ¹ææ¡£\n\n\n# 1. ä¸ºä»ä¹éè¦åæ°å\n\næä»¬å¨ååæµä¸­ï¼éè¦èèå°åç§åºæ¯ï¼éè¿è¾å¥åç§åºæ¯çå¼æ§è¡ç®ççæ¹æ³ï¼æ¥å¤æ­è¾åºæ¯å¦æ¯æä»¬ææå¾çå¼ã\n\nå¦ä¸ä»£ç ä»£ç æç¤ºï¼éå¯¹large_than_twoæ¹æ³è¿è¡äºä¸ç§åºæ¯çæ ¡éªåäºä¸ä¸ªåæµï¼ä½å¶ä¸­é»è¾ä»£ç æ¯ä¸è´çï¼èåªéè¦ä½¿ç¨ä¸åçåæ°å¼è¿è¡è¾å¥ï¼å¯¼è´æè®¸å¤çéå¤ä»£ç è¿è¡å¤å¶ç²è´´ã\n\nfrom unittest.case import TestCase\n\n\ndef large_than_two(value) -> bool:\n    return value > 2\n\n\nclass TestDemoCase(TestCase):\n\n    def test_larger_than_two_with_three(self):\n        self.assertTrue(large_than_two(3))\n\n    def test_larger_than_two_with_eight(self):\n        self.assertTrue(large_than_two(8))\n\n    def test_larger_than_two_with_five(self):\n        self.assertFalse(large_than_two(5))\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\n\n# 2. ä½¿ç¨ddtå®ç°åæ°å\n\né¦åéè¦éè¿pipæ¥å®è£è¯¥åº\n\npip install ddt\n\n\n1\n\n\n\n# 2.1 åºæ¬ä½¿ç¨\n\næä»¬å¨TestCaseä¸æ·»å ddtè£é¥°å¨ï¼ç¶åå¨åæµæ¹æ³ä¸æ·»å dataè£é¥°å¨ï¼å¹¶æ·»å äº3ç§åºæ¯çè¾å¥åæ°ï¼å¦ä¸ä»£ç æç¤ºï¼\n\nfrom unittest.case import TestCase\n\nfrom ddt import ddt, data\n\n\ndef large_than_two(value) -> bool:\n    return value > 2\n\n\n@ddt\nclass TestDemoCase(TestCase):\n\n    @data(3, 8, 5)\n    def test_larger_than_two(self, value):\n        self.assertTrue(large_than_two(value))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\næ§è¡ä¸é¢çåæµï¼è¾å¥åºå¦ä¸ï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::TestDemoCase::test_larger_than_two_with_three_1_3 PASSED   [ 33%]\ntest_demo.py::TestDemoCase::test_larger_than_two_with_three_2_8 PASSED   [ 66%]\ntest_demo.py::TestDemoCase::test_larger_than_two_with_three_3_5 PASSED   [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nä¼åç°ï¼è½ç¶æä»¬åäºä¸ä¸ªåæµç¨ä¾ï¼ä½æ¯å´æ§è¡äº3ä¸ªç¨ä¾ï¼è¿æ¯å ä¸ºddtä¼å°dataç3ä¸ªåæ°åå«æ³¨å¥å°test_larger_than_twoæ¹æ³ä¸­valueä¸­å¹¶æ§è¡åæµã\n\nå¨è¾åºçåæµä¿¡æ¯ä¸­ï¼ä¼è¾åºåæµæ¹æ³+ç¬¬å¤å°ä¸ªåæµ+åæ°å¼æ¥è¡¨ç¤ºå½åç¨ä¾çæ§è¡ã\n\néè¿è¿ç§æ¹å¼å¯ä»¥åå°æä»¬çéå¤ä»£ç ã\n\n\n# 2.2 å¤ä¸ªå¼ä½¿ç¨åæ°å\n\nå½æä»¬éè¦å¨ä¸ä¸ªåæµç¨ä¾ä¸­æ³¨å¥å¤ä¸ªå¼æ¶ï¼å¯ä»¥å¨dataä¸­ä¼ å¥å¤ä¸ªåç»è¿è¡åæ°åï¼ä½æ§è¡åä¾æ¶ï¼ä¼å°åç»æ³¨å¥å°valueä¸­ï¼æä»¬å°å¶è§£å¼åè½æ¿å°å¤ä¸ªå¼ãä»£ç å¦ä¸å¾æç¤ºï¼\n\ndef greater(v1, v2) -> bool:\n    return v1 > v2\n\n\n@ddt\nclass TestDemoCase(TestCase):\n\n    @data(\n        (3, 2),\n        (4, 1),\n        (8, 6))\n    def test_greater(self, value):\n        v1, v2 = value\n        self.assertTrue(greater(v1, v2))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næ§è¡ä¹åè¾åºå¦ä¸æç¤ºï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::TestDemoCase::test_greater_1__3__2_ PASSED                 [ 33%]\ntest_demo.py::TestDemoCase::test_greater_2__4__1_ PASSED                 [ 66%]\ntest_demo.py::TestDemoCase::test_greater_3__8__6_ PASSED                 [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2.3 åæ°åæå¹³ä½¿ç¨\n\nåç»ä¸­çæ°æ®å¯ä»¥ç±ddtè§£å¼åæ³¨å¥å°åæµæ¹æ³ä¸­çåæ°ä¸­ãåªéè¦å¨åæµæ¹æ³é±æ·»å unpackè£é¥°å¨å³å¯ãä»£ç å¦ä¸æç¤ºï¼\n\nfrom unittest.case import TestCase\n\nfrom ddt import ddt, data, unpack\n\n@ddt\nclass TestDemoCase(TestCase):\n\n    @unpack\n    @data(\n        (3, 2),\n        (4, 1),\n        (8, 6))\n    def test_greater(self, v1, v2):\n        self.assertTrue(greater(v1, v2))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næ§è¡åç»æå¦ä¸ï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::TestDemoCase::test_greater_1__3__2_ PASSED                 [ 33%]\ntest_demo.py::TestDemoCase::test_greater_2__4__1_ PASSED                 [ 66%]\ntest_demo.py::TestDemoCase::test_greater_3__8__6_ PASSED                 [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2.4 å½ååæ°\n\næä»¬è¿å¯ä»¥ç»ä¼ å¥çåæ°è¿è¡å½åèä¸æ¯åç»çå½¢å¼ï¼ä¼ å¥çåæ°åç§°ä¸åæµæ¹æ³ä¸­åæ°çåéåå¯¹åºï¼åä¸éè¦å¯¹åºé¡ºåºä¼ å¥ï¼å¯è¯»æ§æ´å¼ºäºãä»£ç å¦ä¸ï¼\n\n@ddt\nclass TestDemoCase(TestCase):\n\n    @unpack\n    @data(\n        {"first": 3, "second": 2},\n        {"first": 4, "second": 1},\n        {"first": 8, "second": 6}\n    )\n    def test_greater(self, second, first):\n        self.assertTrue(greater(first, second))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\næ§è¡åè¾åºï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::TestDemoCase::test_greater_1 PASSED                        [ 33%]\ntest_demo.py::TestDemoCase::test_greater_2 PASSED                        [ 66%]\ntest_demo.py::TestDemoCase::test_greater_3 PASSED                        [100%]\n\n============================== 3 passed in 0.01s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2.5 ä»jsonæä»¶ä¸­è¯»ååæ°è¿è¡åæµ\n\nå¨æäºä¸å¡ä¸­ï¼è¾å¥çåæ°è¿äºå¤æï¼å¹¶ä¸åºæ¯ç¹å¤ï¼å¦æå°åæ°æ°æ®å¨é¨æ¾å¨åæµä»£ç ä¸­ï¼åä¼æ¾å¾ç¹éï¼èä¸ä»£ç ä¸æè¯»ï¼ddtæä¾äºä»jsonæä»¶ä¸­è¯»ååæ°æ¥ä½ä¸ºåæµçè¾å¥æ°æ®ã\n\nåå»ºdata.jsonæä»¶ï¼å¶ä¸­åå«äºåæ°æ°æ®ã\n\n[\n  {\n    "first": 3,\n    "second": 2\n  },\n  {\n    "first": 4,\n    "second": 1\n  },\n  {\n    "first": 8,\n    "second": 6\n  }\n]\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶åä½¿ç¨file_dataä½ä¸ºåæµæ¹æ³çè£é¥°å¨ï¼å¹¶ä¼ å¥ä¸é¢æ°æ®æä»¶çè·¯å¾ã\n\nfrom ddt import ddt, file_data\n\n@ddt\nclass TestDemoCase(TestCase):\n\n    @file_data("data.json")\n    def test_greater(self, second, first):\n        self.assertTrue(greater(first, second))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næ§è¡æåå¹¶è¾åºï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::TestDemoCase::test_greater_1 PASSED                        [ 33%]\ntest_demo.py::TestDemoCase::test_greater_2 PASSED                        [ 66%]\ntest_demo.py::TestDemoCase::test_greater_3 PASSED                        [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 3. æ»ç»\n\næ¬ææ¯ä»ç»ddtçåºæ¬å¹¶å¸¸ç¨çç¨æ³ï¼å¦ææ³è¦æ·±å¥ä½¿ç¨å¯ä»¥åèå®æ¹ææ¡£ã\n\nå¶å®ddtæä¸ªç¼ºç¹æ¯ä¸è½éå¯¹æä¸ä¸ªåæµæ¹æ³è¿è¡åç¬çæ§è¡ï¼å¿é¡»è¦è¿è¡æ´ä¸ªUnittest classæè¡ï¼è¿æ ·å¨è°è¯çè¿ç¨ä¸­éå¸¸ä¸æ¹ä¾¿ã\n\nå¦æä½ çå°æ¬æå¶å®ææ¯è¾æ¨èä½ ä½¿ç¨pytestæ¥æ¿ä»£unittestä½¿ç¨ï¼pytestä¸­ä¹æåæ°åçä½¿ç¨ï¼å¹¶ä¸å¯ä»¥åç¬çå»è¿è¡æ¯ä¸ä¸ªåæµã\n\nææ¯å ä¸ºå¨åä¸ä¸ªdjangoé¡¹ç®ï¼å¶ä¸­ä½¿ç¨çæ¯django testæ¥ååæµçï¼èdjango testæ¯åºäºUnittestæ¥å®ç°çï¼æä»¥åªè½ä½¿ç¨ddtæ¥å®ç°åæ°åã',normalizedContent:'# 0. åè¨\n\næ¬æä»ç»å¦ä½ä½¿ç¨ddtåºæ¥å®æunitestçåæ°åè®¾ç½®ã\n\nddtçgithubå°å\n\nddtçå®æ¹ææ¡£\n\n\n# 1. ä¸ºä»ä¹éè¦åæ°å\n\næä»¬å¨ååæµä¸­ï¼éè¦èèå°åç§åºæ¯ï¼éè¿è¾å¥åç§åºæ¯çå¼æ§è¡ç®ççæ¹æ³ï¼æ¥å¤æ­è¾åºæ¯å¦æ¯æä»¬ææå¾çå¼ã\n\nå¦ä¸ä»£ç ä»£ç æç¤ºï¼éå¯¹large_than_twoæ¹æ³è¿è¡äºä¸ç§åºæ¯çæ ¡éªåäºä¸ä¸ªåæµï¼ä½å¶ä¸­é»è¾ä»£ç æ¯ä¸è´çï¼èåªéè¦ä½¿ç¨ä¸åçåæ°å¼è¿è¡è¾å¥ï¼å¯¼è´æè®¸å¤çéå¤ä»£ç è¿è¡å¤å¶ç²è´´ã\n\nfrom unittest.case import testcase\n\n\ndef large_than_two(value) -> bool:\n    return value > 2\n\n\nclass testdemocase(testcase):\n\n    def test_larger_than_two_with_three(self):\n        self.asserttrue(large_than_two(3))\n\n    def test_larger_than_two_with_eight(self):\n        self.asserttrue(large_than_two(8))\n\n    def test_larger_than_two_with_five(self):\n        self.assertfalse(large_than_two(5))\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\n\n# 2. ä½¿ç¨ddtå®ç°åæ°å\n\né¦åéè¦éè¿pipæ¥å®è£è¯¥åº\n\npip install ddt\n\n\n1\n\n\n\n# 2.1 åºæ¬ä½¿ç¨\n\næä»¬å¨testcaseä¸æ·»å ddtè£é¥°å¨ï¼ç¶åå¨åæµæ¹æ³ä¸æ·»å dataè£é¥°å¨ï¼å¹¶æ·»å äº3ç§åºæ¯çè¾å¥åæ°ï¼å¦ä¸ä»£ç æç¤ºï¼\n\nfrom unittest.case import testcase\n\nfrom ddt import ddt, data\n\n\ndef large_than_two(value) -> bool:\n    return value > 2\n\n\n@ddt\nclass testdemocase(testcase):\n\n    @data(3, 8, 5)\n    def test_larger_than_two(self, value):\n        self.asserttrue(large_than_two(value))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\næ§è¡ä¸é¢çåæµï¼è¾å¥åºå¦ä¸ï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::testdemocase::test_larger_than_two_with_three_1_3 passed   [ 33%]\ntest_demo.py::testdemocase::test_larger_than_two_with_three_2_8 passed   [ 66%]\ntest_demo.py::testdemocase::test_larger_than_two_with_three_3_5 passed   [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nä¼åç°ï¼è½ç¶æä»¬åäºä¸ä¸ªåæµç¨ä¾ï¼ä½æ¯å´æ§è¡äº3ä¸ªç¨ä¾ï¼è¿æ¯å ä¸ºddtä¼å°dataç3ä¸ªåæ°åå«æ³¨å¥å°test_larger_than_twoæ¹æ³ä¸­valueä¸­å¹¶æ§è¡åæµã\n\nå¨è¾åºçåæµä¿¡æ¯ä¸­ï¼ä¼è¾åºåæµæ¹æ³+ç¬¬å¤å°ä¸ªåæµ+åæ°å¼æ¥è¡¨ç¤ºå½åç¨ä¾çæ§è¡ã\n\néè¿è¿ç§æ¹å¼å¯ä»¥åå°æä»¬çéå¤ä»£ç ã\n\n\n# 2.2 å¤ä¸ªå¼ä½¿ç¨åæ°å\n\nå½æä»¬éè¦å¨ä¸ä¸ªåæµç¨ä¾ä¸­æ³¨å¥å¤ä¸ªå¼æ¶ï¼å¯ä»¥å¨dataä¸­ä¼ å¥å¤ä¸ªåç»è¿è¡åæ°åï¼ä½æ§è¡åä¾æ¶ï¼ä¼å°åç»æ³¨å¥å°valueä¸­ï¼æä»¬å°å¶è§£å¼åè½æ¿å°å¤ä¸ªå¼ãä»£ç å¦ä¸å¾æç¤ºï¼\n\ndef greater(v1, v2) -> bool:\n    return v1 > v2\n\n\n@ddt\nclass testdemocase(testcase):\n\n    @data(\n        (3, 2),\n        (4, 1),\n        (8, 6))\n    def test_greater(self, value):\n        v1, v2 = value\n        self.asserttrue(greater(v1, v2))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næ§è¡ä¹åè¾åºå¦ä¸æç¤ºï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::testdemocase::test_greater_1__3__2_ passed                 [ 33%]\ntest_demo.py::testdemocase::test_greater_2__4__1_ passed                 [ 66%]\ntest_demo.py::testdemocase::test_greater_3__8__6_ passed                 [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2.3 åæ°åæå¹³ä½¿ç¨\n\nåç»ä¸­çæ°æ®å¯ä»¥ç±ddtè§£å¼åæ³¨å¥å°åæµæ¹æ³ä¸­çåæ°ä¸­ãåªéè¦å¨åæµæ¹æ³é±æ·»å unpackè£é¥°å¨å³å¯ãä»£ç å¦ä¸æç¤ºï¼\n\nfrom unittest.case import testcase\n\nfrom ddt import ddt, data, unpack\n\n@ddt\nclass testdemocase(testcase):\n\n    @unpack\n    @data(\n        (3, 2),\n        (4, 1),\n        (8, 6))\n    def test_greater(self, v1, v2):\n        self.asserttrue(greater(v1, v2))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næ§è¡åç»æå¦ä¸ï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::testdemocase::test_greater_1__3__2_ passed                 [ 33%]\ntest_demo.py::testdemocase::test_greater_2__4__1_ passed                 [ 66%]\ntest_demo.py::testdemocase::test_greater_3__8__6_ passed                 [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2.4 å½ååæ°\n\næä»¬è¿å¯ä»¥ç»ä¼ å¥çåæ°è¿è¡å½åèä¸æ¯åç»çå½¢å¼ï¼ä¼ å¥çåæ°åç§°ä¸åæµæ¹æ³ä¸­åæ°çåéåå¯¹åºï¼åä¸éè¦å¯¹åºé¡ºåºä¼ å¥ï¼å¯è¯»æ§æ´å¼ºäºãä»£ç å¦ä¸ï¼\n\n@ddt\nclass testdemocase(testcase):\n\n    @unpack\n    @data(\n        {"first": 3, "second": 2},\n        {"first": 4, "second": 1},\n        {"first": 8, "second": 6}\n    )\n    def test_greater(self, second, first):\n        self.asserttrue(greater(first, second))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\næ§è¡åè¾åºï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::testdemocase::test_greater_1 passed                        [ 33%]\ntest_demo.py::testdemocase::test_greater_2 passed                        [ 66%]\ntest_demo.py::testdemocase::test_greater_3 passed                        [100%]\n\n============================== 3 passed in 0.01s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 2.5 ä»jsonæä»¶ä¸­è¯»ååæ°è¿è¡åæµ\n\nå¨æäºä¸å¡ä¸­ï¼è¾å¥çåæ°è¿äºå¤æï¼å¹¶ä¸åºæ¯ç¹å¤ï¼å¦æå°åæ°æ°æ®å¨é¨æ¾å¨åæµä»£ç ä¸­ï¼åä¼æ¾å¾ç¹éï¼èä¸ä»£ç ä¸æè¯»ï¼ddtæä¾äºä»jsonæä»¶ä¸­è¯»ååæ°æ¥ä½ä¸ºåæµçè¾å¥æ°æ®ã\n\nåå»ºdata.jsonæä»¶ï¼å¶ä¸­åå«äºåæ°æ°æ®ã\n\n[\n  {\n    "first": 3,\n    "second": 2\n  },\n  {\n    "first": 4,\n    "second": 1\n  },\n  {\n    "first": 8,\n    "second": 6\n  }\n]\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶åä½¿ç¨file_dataä½ä¸ºåæµæ¹æ³çè£é¥°å¨ï¼å¹¶ä¼ å¥ä¸é¢æ°æ®æä»¶çè·¯å¾ã\n\nfrom ddt import ddt, file_data\n\n@ddt\nclass testdemocase(testcase):\n\n    @file_data("data.json")\n    def test_greater(self, second, first):\n        self.asserttrue(greater(first, second))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næ§è¡æåå¹¶è¾åºï¼\n\n============================= test session starts =============================\ncollecting ... collected 3 items\n\ntest_demo.py::testdemocase::test_greater_1 passed                        [ 33%]\ntest_demo.py::testdemocase::test_greater_2 passed                        [ 66%]\ntest_demo.py::testdemocase::test_greater_3 passed                        [100%]\n\n============================== 3 passed in 0.02s ==============================\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 3. æ»ç»\n\næ¬ææ¯ä»ç»ddtçåºæ¬å¹¶å¸¸ç¨çç¨æ³ï¼å¦ææ³è¦æ·±å¥ä½¿ç¨å¯ä»¥åèå®æ¹ææ¡£ã\n\nå¶å®ddtæä¸ªç¼ºç¹æ¯ä¸è½éå¯¹æä¸ä¸ªåæµæ¹æ³è¿è¡åç¬çæ§è¡ï¼å¿é¡»è¦è¿è¡æ´ä¸ªunittest classæè¡ï¼è¿æ ·å¨è°è¯çè¿ç¨ä¸­éå¸¸ä¸æ¹ä¾¿ã\n\nå¦æä½ çå°æ¬æå¶å®ææ¯è¾æ¨èä½ ä½¿ç¨pytestæ¥æ¿ä»£unittestä½¿ç¨ï¼pytestä¸­ä¹æåæ°åçä½¿ç¨ï¼å¹¶ä¸å¯ä»¥åç¬çå»è¿è¡æ¯ä¸ä¸ªåæµã\n\nææ¯å ä¸ºå¨åä¸ä¸ªdjangoé¡¹ç®ï¼å¶ä¸­ä½¿ç¨çæ¯django testæ¥ååæµçï¼èdjango testæ¯åºäºunittestæ¥å®ç°çï¼æä»¥åªè½ä½¿ç¨ddtæ¥å®ç°åæ°åã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢",frontmatter:{title:"django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢",date:"2023-10-30T16:53:28.000Z",permalink:"/pages/ec5110/",categories:["ç¼ç¨","python","ç¬¬ä¸æ¹åº"],tags:["python","django"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨djangoé¡¹ç®ä¸­ä½¿ç¨`django-apschedule`æ¥å®ç°å®æ¶ä»»å¡ï¼ä½¿ç¨çæ¯`BackgroundScheduler`è°åº¦ç±»ï¼è¯¥è°åº¦çå®ç°æ¯éè¿åå°çº¿ç¨çæ¹å¼æ§è¡å®æ¶ä»»å¡ãå¶ä¸­ä»»å¡é½æ¯æä¹åå°æ°æ®åºä¸­çãå¨é¡¹ç®çè¿è¡è¿ç¨ä¸­ï¼å ä¸ºæ°æ®åºçå¼å¸¸ï¼å¯¼è´å®æ¶ä»»å¡çº¿ç¨å¼å¸¸ç»æ­¢ï¼å³ä½¿æ°æ®åºåç»­æ¢å¤æ­£å¸¸ï¼ä½ä¹ä¸åç»§ç»­æ§è¡ãæå¤æ¬¡å°è¯å¤ç°æªæï¼å¨å¼å¯å®æ¶ä»»å¡æé´ï¼æå¨å°æ°æ®åºè¿æ¥æ­å¼ï¼å®æ¶ä»»å¡æ§è¡å¤±è´¥ï¼ç¶ååå°æ°æ®åºå»ºç«è¿æ¥ï¼å®æ¶ä»»å¡ç«ç¶éæ°æ¢å¤äºï¼è¿è®©æä¸æ¶æ¸ä¸çå¤´èã",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢"},{name:"twitter:description",content:"å¨djangoé¡¹ç®ä¸­ä½¿ç¨`django-apschedule`æ¥å®ç°å®æ¶ä»»å¡ï¼ä½¿ç¨çæ¯`BackgroundScheduler`è°åº¦ç±»ï¼è¯¥è°åº¦çå®ç°æ¯éè¿åå°çº¿ç¨çæ¹å¼æ§è¡å®æ¶ä»»å¡ãå¶ä¸­ä»»å¡é½æ¯æä¹åå°æ°æ®åºä¸­çãå¨é¡¹ç®çè¿è¡è¿ç¨ä¸­ï¼å ä¸ºæ°æ®åºçå¼å¸¸ï¼å¯¼è´å®æ¶ä»»å¡çº¿ç¨å¼å¸¸ç»æ­¢ï¼å³ä½¿æ°æ®åºåç»­æ¢å¤æ­£å¸¸ï¼ä½ä¹ä¸åç»§ç»­æ§è¡ãæå¤æ¬¡å°è¯å¤ç°æªæï¼å¨å¼å¯å®æ¶ä»»å¡æé´ï¼æå¨å°æ°æ®åºè¿æ¥æ­å¼ï¼å®æ¶ä»»å¡æ§è¡å¤±è´¥ï¼ç¶ååå°æ°æ®åºå»ºç«è¿æ¥ï¼å®æ¶ä»»å¡ç«ç¶éæ°æ¢å¤äºï¼è¿è®©æä¸æ¶æ¸ä¸çå¤´èã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/03.django-apschedule%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BC%82%E5%B8%B8%E5%81%9C%E6%AD%A2.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢"},{property:"og:description",content:"å¨djangoé¡¹ç®ä¸­ä½¿ç¨`django-apschedule`æ¥å®ç°å®æ¶ä»»å¡ï¼ä½¿ç¨çæ¯`BackgroundScheduler`è°åº¦ç±»ï¼è¯¥è°åº¦çå®ç°æ¯éè¿åå°çº¿ç¨çæ¹å¼æ§è¡å®æ¶ä»»å¡ãå¶ä¸­ä»»å¡é½æ¯æä¹åå°æ°æ®åºä¸­çãå¨é¡¹ç®çè¿è¡è¿ç¨ä¸­ï¼å ä¸ºæ°æ®åºçå¼å¸¸ï¼å¯¼è´å®æ¶ä»»å¡çº¿ç¨å¼å¸¸ç»æ­¢ï¼å³ä½¿æ°æ®åºåç»­æ¢å¤æ­£å¸¸ï¼ä½ä¹ä¸åç»§ç»­æ§è¡ãæå¤æ¬¡å°è¯å¤ç°æªæï¼å¨å¼å¯å®æ¶ä»»å¡æé´ï¼æå¨å°æ°æ®åºè¿æ¥æ­å¼ï¼å®æ¶ä»»å¡æ§è¡å¤±è´¥ï¼ç¶ååå°æ°æ®åºå»ºç«è¿æ¥ï¼å®æ¶ä»»å¡ç«ç¶éæ°æ¢å¤äºï¼è¿è®©æä¸æ¶æ¸ä¸çå¤´èã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/03.django-apschedule%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BC%82%E5%B8%B8%E5%81%9C%E6%AD%A2.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-10-30T16:53:28.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢"},{itemprop:"description",content:"å¨djangoé¡¹ç®ä¸­ä½¿ç¨`django-apschedule`æ¥å®ç°å®æ¶ä»»å¡ï¼ä½¿ç¨çæ¯`BackgroundScheduler`è°åº¦ç±»ï¼è¯¥è°åº¦çå®ç°æ¯éè¿åå°çº¿ç¨çæ¹å¼æ§è¡å®æ¶ä»»å¡ãå¶ä¸­ä»»å¡é½æ¯æä¹åå°æ°æ®åºä¸­çãå¨é¡¹ç®çè¿è¡è¿ç¨ä¸­ï¼å ä¸ºæ°æ®åºçå¼å¸¸ï¼å¯¼è´å®æ¶ä»»å¡çº¿ç¨å¼å¸¸ç»æ­¢ï¼å³ä½¿æ°æ®åºåç»­æ¢å¤æ­£å¸¸ï¼ä½ä¹ä¸åç»§ç»­æ§è¡ãæå¤æ¬¡å°è¯å¤ç°æªæï¼å¨å¼å¯å®æ¶ä»»å¡æé´ï¼æå¨å°æ°æ®åºè¿æ¥æ­å¼ï¼å®æ¶ä»»å¡æ§è¡å¤±è´¥ï¼ç¶ååå°æ°æ®åºå»ºç«è¿æ¥ï¼å®æ¶ä»»å¡ç«ç¶éæ°æ¢å¤äºï¼è¿è®©æä¸æ¶æ¸ä¸çå¤´èã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/03.django-apschedule%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%BC%82%E5%B8%B8%E5%81%9C%E6%AD%A2.html",relativePath:"04.ç¼ç¨/01.python/02.ç¬¬ä¸æ¹åº/03.django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢.md",key:"v-6fc4dda8",path:"/pages/ec5110/",headers:[{level:2,title:"èæ¯",slug:"èæ¯",normalizedTitle:"èæ¯",charIndex:2},{level:2,title:"æºç åæåå ",slug:"æºç åæåå ",normalizedTitle:"æºç åæåå ",charIndex:3211},{level:2,title:"æ­å»ºdemo",slug:"æ­å»ºdemo",normalizedTitle:"æ­å»ºdemo",charIndex:5215},{level:2,title:"çº¿ç¨éå¯",slug:"çº¿ç¨éå¯",normalizedTitle:"çº¿ç¨éå¯",charIndex:7380},{level:2,title:"listener",slug:"listener",normalizedTitle:"listener",charIndex:7666},{level:2,title:"æè·çº¿ç¨ä¸­å½æ°çå¼å¸¸",slug:"æè·çº¿ç¨ä¸­å½æ°çå¼å¸¸",normalizedTitle:"æè·çº¿ç¨ä¸­å½æ°çå¼å¸¸",charIndex:8659},{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:9435}],headersStr:"èæ¯ æºç åæåå  æ­å»ºdemo çº¿ç¨éå¯ listener æè·çº¿ç¨ä¸­å½æ°çå¼å¸¸ ç¸å³é¾æ¥",content:'# èæ¯\n\nå¨djangoé¡¹ç®ä¸­ä½¿ç¨django-apscheduleæ¥å®ç°å®æ¶ä»»å¡ï¼ä½¿ç¨çæ¯BackgroundSchedulerè°åº¦ç±»ï¼è¯¥è°åº¦çå®ç°æ¯éè¿åå°çº¿ç¨çæ¹å¼æ§è¡å®æ¶ä»»å¡ãå¶ä¸­ä»»å¡é½æ¯æä¹åå°æ°æ®åºä¸­çã\n\nå¨é¡¹ç®çè¿è¡è¿ç¨ä¸­ï¼å ä¸ºæ°æ®åºçå¼å¸¸ï¼å¯¼è´å®æ¶ä»»å¡çº¿ç¨å¼å¸¸ç»æ­¢ï¼å³ä½¿æ°æ®åºåç»­æ¢å¤æ­£å¸¸ï¼ä½ä¹ä¸åç»§ç»­æ§è¡ãæå¤æ¬¡å°è¯å¤ç°æªæï¼å¨å¼å¯å®æ¶ä»»å¡æé´ï¼æå¨å°æ°æ®åºè¿æ¥æ­å¼ï¼å®æ¶ä»»å¡æ§è¡å¤±è´¥ï¼ç¶ååå°æ°æ®åºå»ºç«è¿æ¥ï¼å®æ¶ä»»å¡ç«ç¶éæ°æ¢å¤äºï¼è¿è®©æä¸æ¶æ¸ä¸çå¤´èã\n\nå·ä½çéè¯¯æ¥å¿å¦ä¸ï¼éè¿åæï¼æ¯update_jobè¿æ¥æ°æ®åºå¼å¸¸ï¼æ²¡æä»»ä½æè·æºå¶ï¼ç¶åå±å±ç½ä¸æï¼æç»å¯¼è´çº¿ç¨åæ­¢ï¼å¯ä»¥å¾è¯å®çæ¯ï¼ç»å¯¹æ¯å ä¸ºæ°æ®åºè¿æ¥å¤±è´¥å¯¼è´çå®æ¶ä»»å¡å¤±è´¥ï¼é£ä¸ºä»ä¹æ æ³å¤ç°å¢ï¼\n\nTraceback (most recent call last):\n  File "/usr/local/python3/lib/python3.7/threading.py", line 926, in _bootstrap_inner\n    self.run()\n  File "/usr/local/python3/lib/python3.7/threading.py", line 870, in run\n    self._target(*self._args, **self._kwargs)\n  File "/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/blocking.py", line 32, in _main_loop\n    wait_seconds = self._process_jobs()\n  File "/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/base.py", line 1009, in _process_jobs\n    jobstore.update_job(job)\n  File "/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/util.py", line 105, in func_wrapper\n    result = func(*args, **kwargs)\n  File "/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/jobstores.py", line 249, in update_job\n    with transaction.atomic():\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/transaction.py", line 189, in __enter__\n    if not connection.get_autocommit():\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 389, in get_autocommit\n    self.ensure_connection()\n  File "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner\n     return func(*args, **kwargs)\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 219, in ensure_connection\n    self.connect()\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/utils.py", line 90, in __exit__\n    raise dj_exc_value.with_traceback(traceback) from exc_value\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 219, in ensure_connection\n    self.connect()\n  File "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner\n    return func(*args, **kwargs)\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 200, in connect\n    self.connection = self.get_new_connection(conn_params)\n  File "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner\n    return func(*args, **kwargs)\n  File "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/postgresql/base.py", line 187, in get_new_connection\n    connection = Database.connect(**conn_params)\n  File "/usr/local/python3/lib/python3.7/site-packages/psycopg2/__init__.py", line 122, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\ndjango.db.utils.OperationalError: connection to server at "xxxx.postgresql.svc.cluster.local" (xx.xx.xx.xx), port xxxx failed: server closed the connection unexpectedly\nThis probably means the server terminated abnormally\nbefore or while processing the request.\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\n\n# æºç åæåå \n\nå¯ä»¥åçä¸BackgroundSchedulerçå®ç°æ¹å¼ï¼å¨startæ¹æ³ä¸­åå»ºäºä¸ªå­çº¿ç¨ã\n\nclass BackgroundScheduler(BlockingScheduler):\n\n    _thread = None\n\n    def start(self, *args, **kwargs):\n        if self._event is None or self._event.is_set():\n            self._event = Event()\n\n        BaseScheduler.start(self, *args, **kwargs)\n        self._thread = Thread(target=self._main_loop, name=\'APScheduler\')\n        self._thread.daemon = self._daemon\n        self._thread.start()\n\n    def shutdown(self, *args, **kwargs):\n        super(BackgroundScheduler, self).shutdown(*args, **kwargs)\n        self._thread.join()\n        del self._thread\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nå¶ä¸­_main_loopå¨BlockingSchedulerä¸­å®ç°ï¼æ¯ä¸ä¸ªæ­»å¾ªç¯ï¼æ§è¡_process_jobsæ¹æ³\n\nclass BlockingScheduler(BaseScheduler):\n    \n    ...\n\n    def _main_loop(self):\n        wait_seconds = TIMEOUT_MAX\n        while self.state != STATE_STOPPED:\n            self._event.wait(wait_seconds)\n            self._event.clear()\n            wait_seconds = self._process_jobs()\n    \n    ...\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nåç_process_jobsä¸­çåå®¹ï¼å¨BaseSchedulerå®ç°çï¼ä¸»è¦æµç¨å¦ä¸ï¼åæ¾å°ææè¦æ§è¡çjobï¼ç¶åè¿è¡éåè¿è¡å¹¶æ´æ°Jobçç¶æãä¹åçéè¯¯æ¥å¿ï¼ä¹å°±æ¯è¿éçupdate_jobæåºå¼å¸¸ï¼èè¿éå¹¶æ²¡ææè·å¼å¸¸ï¼æç»å±å±å¾ä¸æï¼update_job -> _process_jobs -> _main_loopï¼æç»çº¿ç¨å¼å¸¸ç»æ­¢ã\n\ndef _process_jobs(self):\n    for jobstore_alias, jobstore in six.iteritems(self._jobstores):\n        try:\n            due_jobs = jobstore.get_due_jobs(now)\n        except Exception as e:\n            ...\n            continue\n\n        ...\n                \n        for job in due_jobs:\n      \n            ...\n            \n            try:\n                executor.submit_job(job, run_times)\n            except BaseException:\n                ...\n\n            ...\n            jobstore.update_job(job)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\né£ä¸ºä»ä¹å¤ç°ä¸äºå¢ï¼è¿ä¸ªæ¯å ä¸ºï¼å³é­æ°æ®åºè¿æ¥æ¶ï¼ç¨åºä¸ä¸å®å¯ä»¥æ­£å¥½è¿è¡å¨update_jobï¼å¯ä»¥çå°åé¢çget_due_jobsè¿è¡äºå¼å¸¸æè·ï¼å¦æè¿éæåºæ°æ®åºè¿æ¥å¼å¸¸æ¯å¯ä»¥æè·å°çï¼ç¶åè·³è¿åé¢çæä½ï¼ç­å¾ä¸ä¸æ¬¡å®æ¶ä»»å¡çæ§è¡ï¼å¦æè¿æ¯å¤±è´¥ï¼ååæ¬¡ç­å¾ï¼æä»¥è¿éçå¼å¸¸ä¸ä¼æå°æä¸å±å¯¼è´çº¿ç¨åæ­¢ã\n\nä½å¦ææä¸ªæ¶æºï¼ä¸é¢è¿æ¥æ°æ®åºé½æåäºï¼å°update_jobè¿éå¼å¸¸æåºï¼åä¼å¯¼è´æ´ä¸ªçº¿ç¨åæ­¢ï¼å®æ¶ä»»å¡ä¸åæ§è¡ã\n\né£å¦ä½è§£å³è¯¥é®é¢å¢ï¼\n\n\n# æ­å»ºdemo\n\né¦åæä»¬æ­å»ºä¸ä¸ªdemoåºæ¥ï¼æ¨¡æå¤ç°è¯¥é®é¢ã\n\n 1. åå»ºdjangoé¡¹ç®\n\n\ndjango-admin startproject apschedule_demo\n\npython manage.py startapp demo\n\npython manage.py makemigrations\n\npython manage.py migrate\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 2. å¨settings.pyä¸­éç½®å°å¥½æ°æ®åºä¿¡æ¯\n\nDATABASES = {\n    "default": {\n        "ENGINE": "django.db.backends.postgresql",\n        "NAME": "apschedule_demo",\n        "HOST": "xxxx",\n        "PORT": 5432,\n        "USER": "xxx",\n        "PASSWORD": "xxx"\n    }\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n 3. æ ¹æ®django-apscheduleå®æ¹æä¾çææ¡£æ­å»ºdemo\n\nå¨settings.pyä¸­æ·»å è¯¥APP\n\nINSTALLED_APPS = (\n    # ...\n    "django_apscheduler",\n)\n\n\n1\n2\n3\n4\n\n\nåå»ºç®å½demo/management/commandsï¼å¹¶å¨å¶ä¸é¢åå»ºrunapscheduler.pyæä»¶ï¼ä»£ç åå®¹å¦ä¸ï¼\n\nimport logging\n\nfrom django.conf import settings\n\nfrom apscheduler.schedulers.blocking import BlockingScheduler\nfrom apscheduler.triggers.cron import CronTrigger\nfrom django.core.management.base import BaseCommand\nfrom django_apscheduler.jobstores import DjangoJobStore\n\nlogger = logging.getLogger(__name__)\n\n\ndef my_job():\n  # Your job processing logic here...\n  print("job..")\n\n\nclass Command(BaseCommand):\n  help = "Runs APScheduler."\n\n  def handle(self, *args, **options):\n    scheduler = BlockingScheduler(timezone=settings.TIME_ZONE)\n    scheduler.add_jobstore(DjangoJobStore(), "default")\n\n    scheduler.add_job(\n      my_job,\n      trigger=CronTrigger(second="*/3"),  # Every 3 seconds\n      id="my_job",  # The `id` assigned to each job MUST be unique\n      max_instances=1,\n      replace_existing=True,\n    )\n    logger.info("Added job \'my_job\'.")\n\n    try:\n      logger.info("Starting scheduler...")\n      scheduler.start()\n\n    # å ä¸ºä¸é¢æ¯éé»å¡å¼å¯å®æ¶ä»»å¡ï¼æä»¥è¿ééè¦é»å¡ï¼ä¸è®©ä¸»çº¿ç¨ç»æã\n    while True:\n            time.sleep(10)\n    except KeyboardInterrupt:\n      logger.info("Stopping scheduler...")\n      scheduler.shutdown()\n      logger.info("Scheduler shut down successfully!")\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n\n\nå¯ä»¥éè¿python manage.py runapscheduleræ§è¡ä¸é¢çå½ä»¤è¿è¡å®æ¶ä»»å¡ï¼è¯¥èæ¬åå»ºäºä¸ä¸ªæ¯3ç§æ§è¡ä¸æ¬¡çä»»å¡ã\n\n 4. å¤ç°\n\næä»¬å°æ­ç¹æå¨jobstore.update_job(job)ä¸ï¼ç¶åä½¿ç¨debugæ¨¡å¼è¿è¡è°è¯ï¼å½ç¨åºè¿è¡å°æ­ç¹ä¸æ¶ï¼å°æ°æ®åºå³é­ï¼ç¶åç¨åºç»§ç»­è¿è¡ï¼åä¼æ¥éï¼å¹¶æåºå¼å¸¸ï¼çº¿ç¨åæ­¢äºè¿è¡ãè³æ­¤ï¼æä»¬å¤ç°äºè¯¥é®é¢ã\n\n\n# çº¿ç¨éå¯\n\næä¸å¼å§æ³ï¼æå¯ä»¥å¤æ­è¯¥çº¿ç¨æ¯å¦å¼å¸¸ï¼å¦æå¼å¸¸åå°çº¿ç¨éå¯å°±å¥½äº\n\n    while True:\n        if not scheduler._thread.is_alive():\n            scheduler._thread.start()\n\n        time.sleep(10)\n\n\n1\n2\n3\n4\n5\n\n\nä½äºä¸æ¿è¿ï¼æåºäºå¼å¸¸ï¼å¼å¸¸ä¿¡æ¯å¦ä¸ï¼\n\nRuntimeError: threads can only be started once\n\n\n1\n\n\néè¿æ¥çå®æ¹ææ¡£å¯ä»¥ç¥éï¼çº¿ç¨çstartæ¹æ³åªè½è°ç¨ä¸æ¬¡ã\n\n\n# listener\n\napscheduleä¸­æä¾äºçå¬å¨æºå¶ï¼ä¹å°±æ¯å¨å®æ¶ä»»å¡çæåãå¤±è´¥ç­ç¶æé½å¯ä»¥éè¿æåæ³¨åçlisteneræ¹æ³æ¥è¿è¡åè°ãä½éè¿åææºç ï¼å¶å¹¶ä¸è½æè·å°å®æ¶ä»»å¡çº¿ç¨çå¼å¸¸ã\n\nä¸é¢æ¯ç®åäºä»£ç çlistenersçåçæµç¨ï¼\n\n 1. å¤é¨éè¿add_listeneræ¹æ³æ³¨ååè°æ¹æ³\n 2. å¨å®æ¶ä»»å¡çº¿ç¨ä¸»æµç¨_process_jobsä¸­åççåä¸ªäºä»¶æ·»å å°eventsä¸­\n 3. éåeventsäºä»¶ï¼ç¶åéè¿ä¸æ³¨åçåè°æ¹æ³maskè¿è¡å¹éï¼å¹éä¸åè°ç¨åè°æ¹æ³\n\nclass BaseScheduler:\n    def __init__(...):\n        self._listeners = []\n\n    def add_listener(self, callback, mask=EVENT_ALL):\n        self._listeners.append((callback, mask))\n\n    def _process_jobs(self):\n\n        events = []\n        \n        ...\n\n        events.append(event)\n \n        ...\n\n\n        for event in events:\n            self._dispatch_event(event)\n\n\n    def _dispatch_event(self, event):\n        for cb, mask in listeners:\n            if event.code & mask:\n                try:\n                    cb(event)\n                except BaseException:\n                    self._logger.exception(\'Error notifying listener\')\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\nå¦æçº¿ç¨æ¬èº«æäºï¼åè°æ¹æ³æ¯ä¸å¯æ§è¡çã\n\n\n# æè·çº¿ç¨ä¸­å½æ°çå¼å¸¸\n\nå¦æupdate_jobæåºå¼å¸¸å¯¼è´çº¿ç¨åæ­¢ï¼é£ææè·å®çå¼å¸¸ï¼ç¶ååcontinueï¼ç­å¾ä¸æ¬¡å®æ¶ä»»å¡è¿è¡åéè¯ä¸å°±å¥½äºï¼ä½æ¯è¿å°±éè¦æ¹å¨æºç ï¼è½ä¸è½æ¹æºç å°±å°½éä¸æ¹ãæä»¥è¿è¾¹æéç¨äºç»§æ¿BackgroundSchedulerç±»ï¼ç¶ååéå_process_jobsæ¹æ³æ¥è§£å³ã\n\nå¨éåç_process_jobsæ¹æ³ä¸­ï¼å¯¹ç¶ç±»ç_process_jobs()è¿è¡å¼å¸¸çæè·ï¼ç¶ååä¸æ­çè¿è¡éè¯ï¼è¿æ ·å³ä½¿update_jobæåºå¼å¸¸äºï¼ä¹å¯ä»¥ä¸æ­çè¿è¡å°è¯æ¢å¤ï¼ç´è³æåã\n\nclass DemoBackgroundScheduler(BackgroundScheduler):\n    def _process_jobs(self):\n        while True:\n            try:\n                return super()._process_jobs()\n            except BaseException:\n                time.sleep(5)\n\nclass Command(BaseCommand):\n    help = "Runs APScheduler."\n\n    def handle(self, *args, **options):\n        scheduler = DemoBackgroundScheduler(timezone=settings.TIME_ZONE)\n        ...\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶ååæ¬¡å°è¯å¤ç°è¯¥é®é¢ï¼å¯ä»¥åç°å¨æ­å¼æ°æ®åºåï¼å®è½å¤ä¸ç´è¿è¡éè¯ï¼çº¿ç¨æ²¡æåæ­¢ï¼å½æ°æ®åºæ¢å¤è¿è¡åï¼jobæ§è¡æåï¼ä¸åæåºå¼å¸¸ã\n\n\n# ç¸å³é¾æ¥\n\n * APSchedulerå®æ¹ææ¡£',normalizedContent:'# èæ¯\n\nå¨djangoé¡¹ç®ä¸­ä½¿ç¨django-apscheduleæ¥å®ç°å®æ¶ä»»å¡ï¼ä½¿ç¨çæ¯backgroundschedulerè°åº¦ç±»ï¼è¯¥è°åº¦çå®ç°æ¯éè¿åå°çº¿ç¨çæ¹å¼æ§è¡å®æ¶ä»»å¡ãå¶ä¸­ä»»å¡é½æ¯æä¹åå°æ°æ®åºä¸­çã\n\nå¨é¡¹ç®çè¿è¡è¿ç¨ä¸­ï¼å ä¸ºæ°æ®åºçå¼å¸¸ï¼å¯¼è´å®æ¶ä»»å¡çº¿ç¨å¼å¸¸ç»æ­¢ï¼å³ä½¿æ°æ®åºåç»­æ¢å¤æ­£å¸¸ï¼ä½ä¹ä¸åç»§ç»­æ§è¡ãæå¤æ¬¡å°è¯å¤ç°æªæï¼å¨å¼å¯å®æ¶ä»»å¡æé´ï¼æå¨å°æ°æ®åºè¿æ¥æ­å¼ï¼å®æ¶ä»»å¡æ§è¡å¤±è´¥ï¼ç¶ååå°æ°æ®åºå»ºç«è¿æ¥ï¼å®æ¶ä»»å¡ç«ç¶éæ°æ¢å¤äºï¼è¿è®©æä¸æ¶æ¸ä¸çå¤´èã\n\nå·ä½çéè¯¯æ¥å¿å¦ä¸ï¼éè¿åæï¼æ¯update_jobè¿æ¥æ°æ®åºå¼å¸¸ï¼æ²¡æä»»ä½æè·æºå¶ï¼ç¶åå±å±ç½ä¸æï¼æç»å¯¼è´çº¿ç¨åæ­¢ï¼å¯ä»¥å¾è¯å®çæ¯ï¼ç»å¯¹æ¯å ä¸ºæ°æ®åºè¿æ¥å¤±è´¥å¯¼è´çå®æ¶ä»»å¡å¤±è´¥ï¼é£ä¸ºä»ä¹æ æ³å¤ç°å¢ï¼\n\ntraceback (most recent call last):\n  file "/usr/local/python3/lib/python3.7/threading.py", line 926, in _bootstrap_inner\n    self.run()\n  file "/usr/local/python3/lib/python3.7/threading.py", line 870, in run\n    self._target(*self._args, **self._kwargs)\n  file "/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/blocking.py", line 32, in _main_loop\n    wait_seconds = self._process_jobs()\n  file "/usr/local/python3/lib/python3.7/site-packages/apscheduler/schedulers/base.py", line 1009, in _process_jobs\n    jobstore.update_job(job)\n  file "/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/util.py", line 105, in func_wrapper\n    result = func(*args, **kwargs)\n  file "/usr/local/python3/lib/python3.7/site-packages/django_apscheduler/jobstores.py", line 249, in update_job\n    with transaction.atomic():\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/transaction.py", line 189, in __enter__\n    if not connection.get_autocommit():\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 389, in get_autocommit\n    self.ensure_connection()\n  file "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner\n     return func(*args, **kwargs)\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 219, in ensure_connection\n    self.connect()\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/utils.py", line 90, in __exit__\n    raise dj_exc_value.with_traceback(traceback) from exc_value\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 219, in ensure_connection\n    self.connect()\n  file "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner\n    return func(*args, **kwargs)\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/base/base.py", line 200, in connect\n    self.connection = self.get_new_connection(conn_params)\n  file "/usr/local/python3/lib/python3.7/site-packages/django/utils/asyncio.py", line 33, in inner\n    return func(*args, **kwargs)\n  file "/usr/local/python3/lib/python3.7/site-packages/django/db/backends/postgresql/base.py", line 187, in get_new_connection\n    connection = database.connect(**conn_params)\n  file "/usr/local/python3/lib/python3.7/site-packages/psycopg2/__init__.py", line 122, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\ndjango.db.utils.operationalerror: connection to server at "xxxx.postgresql.svc.cluster.local" (xx.xx.xx.xx), port xxxx failed: server closed the connection unexpectedly\nthis probably means the server terminated abnormally\nbefore or while processing the request.\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\n\n# æºç åæåå \n\nå¯ä»¥åçä¸backgroundschedulerçå®ç°æ¹å¼ï¼å¨startæ¹æ³ä¸­åå»ºäºä¸ªå­çº¿ç¨ã\n\nclass backgroundscheduler(blockingscheduler):\n\n    _thread = none\n\n    def start(self, *args, **kwargs):\n        if self._event is none or self._event.is_set():\n            self._event = event()\n\n        basescheduler.start(self, *args, **kwargs)\n        self._thread = thread(target=self._main_loop, name=\'apscheduler\')\n        self._thread.daemon = self._daemon\n        self._thread.start()\n\n    def shutdown(self, *args, **kwargs):\n        super(backgroundscheduler, self).shutdown(*args, **kwargs)\n        self._thread.join()\n        del self._thread\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nå¶ä¸­_main_loopå¨blockingschedulerä¸­å®ç°ï¼æ¯ä¸ä¸ªæ­»å¾ªç¯ï¼æ§è¡_process_jobsæ¹æ³\n\nclass blockingscheduler(basescheduler):\n    \n    ...\n\n    def _main_loop(self):\n        wait_seconds = timeout_max\n        while self.state != state_stopped:\n            self._event.wait(wait_seconds)\n            self._event.clear()\n            wait_seconds = self._process_jobs()\n    \n    ...\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nåç_process_jobsä¸­çåå®¹ï¼å¨baseschedulerå®ç°çï¼ä¸»è¦æµç¨å¦ä¸ï¼åæ¾å°ææè¦æ§è¡çjobï¼ç¶åè¿è¡éåè¿è¡å¹¶æ´æ°jobçç¶æãä¹åçéè¯¯æ¥å¿ï¼ä¹å°±æ¯è¿éçupdate_jobæåºå¼å¸¸ï¼èè¿éå¹¶æ²¡ææè·å¼å¸¸ï¼æç»å±å±å¾ä¸æï¼update_job -> _process_jobs -> _main_loopï¼æç»çº¿ç¨å¼å¸¸ç»æ­¢ã\n\ndef _process_jobs(self):\n    for jobstore_alias, jobstore in six.iteritems(self._jobstores):\n        try:\n            due_jobs = jobstore.get_due_jobs(now)\n        except exception as e:\n            ...\n            continue\n\n        ...\n                \n        for job in due_jobs:\n      \n            ...\n            \n            try:\n                executor.submit_job(job, run_times)\n            except baseexception:\n                ...\n\n            ...\n            jobstore.update_job(job)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\né£ä¸ºä»ä¹å¤ç°ä¸äºå¢ï¼è¿ä¸ªæ¯å ä¸ºï¼å³é­æ°æ®åºè¿æ¥æ¶ï¼ç¨åºä¸ä¸å®å¯ä»¥æ­£å¥½è¿è¡å¨update_jobï¼å¯ä»¥çå°åé¢çget_due_jobsè¿è¡äºå¼å¸¸æè·ï¼å¦æè¿éæåºæ°æ®åºè¿æ¥å¼å¸¸æ¯å¯ä»¥æè·å°çï¼ç¶åè·³è¿åé¢çæä½ï¼ç­å¾ä¸ä¸æ¬¡å®æ¶ä»»å¡çæ§è¡ï¼å¦æè¿æ¯å¤±è´¥ï¼ååæ¬¡ç­å¾ï¼æä»¥è¿éçå¼å¸¸ä¸ä¼æå°æä¸å±å¯¼è´çº¿ç¨åæ­¢ã\n\nä½å¦ææä¸ªæ¶æºï¼ä¸é¢è¿æ¥æ°æ®åºé½æåäºï¼å°update_jobè¿éå¼å¸¸æåºï¼åä¼å¯¼è´æ´ä¸ªçº¿ç¨åæ­¢ï¼å®æ¶ä»»å¡ä¸åæ§è¡ã\n\né£å¦ä½è§£å³è¯¥é®é¢å¢ï¼\n\n\n# æ­å»ºdemo\n\né¦åæä»¬æ­å»ºä¸ä¸ªdemoåºæ¥ï¼æ¨¡æå¤ç°è¯¥é®é¢ã\n\n 1. åå»ºdjangoé¡¹ç®\n\n\ndjango-admin startproject apschedule_demo\n\npython manage.py startapp demo\n\npython manage.py makemigrations\n\npython manage.py migrate\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 2. å¨settings.pyä¸­éç½®å°å¥½æ°æ®åºä¿¡æ¯\n\ndatabases = {\n    "default": {\n        "engine": "django.db.backends.postgresql",\n        "name": "apschedule_demo",\n        "host": "xxxx",\n        "port": 5432,\n        "user": "xxx",\n        "password": "xxx"\n    }\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n 3. æ ¹æ®django-apscheduleå®æ¹æä¾çææ¡£æ­å»ºdemo\n\nå¨settings.pyä¸­æ·»å è¯¥app\n\ninstalled_apps = (\n    # ...\n    "django_apscheduler",\n)\n\n\n1\n2\n3\n4\n\n\nåå»ºç®å½demo/management/commandsï¼å¹¶å¨å¶ä¸é¢åå»ºrunapscheduler.pyæä»¶ï¼ä»£ç åå®¹å¦ä¸ï¼\n\nimport logging\n\nfrom django.conf import settings\n\nfrom apscheduler.schedulers.blocking import blockingscheduler\nfrom apscheduler.triggers.cron import crontrigger\nfrom django.core.management.base import basecommand\nfrom django_apscheduler.jobstores import djangojobstore\n\nlogger = logging.getlogger(__name__)\n\n\ndef my_job():\n  # your job processing logic here...\n  print("job..")\n\n\nclass command(basecommand):\n  help = "runs apscheduler."\n\n  def handle(self, *args, **options):\n    scheduler = blockingscheduler(timezone=settings.time_zone)\n    scheduler.add_jobstore(djangojobstore(), "default")\n\n    scheduler.add_job(\n      my_job,\n      trigger=crontrigger(second="*/3"),  # every 3 seconds\n      id="my_job",  # the `id` assigned to each job must be unique\n      max_instances=1,\n      replace_existing=true,\n    )\n    logger.info("added job \'my_job\'.")\n\n    try:\n      logger.info("starting scheduler...")\n      scheduler.start()\n\n    # å ä¸ºä¸é¢æ¯éé»å¡å¼å¯å®æ¶ä»»å¡ï¼æä»¥è¿ééè¦é»å¡ï¼ä¸è®©ä¸»çº¿ç¨ç»æã\n    while true:\n            time.sleep(10)\n    except keyboardinterrupt:\n      logger.info("stopping scheduler...")\n      scheduler.shutdown()\n      logger.info("scheduler shut down successfully!")\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n\n\nå¯ä»¥éè¿python manage.py runapscheduleræ§è¡ä¸é¢çå½ä»¤è¿è¡å®æ¶ä»»å¡ï¼è¯¥èæ¬åå»ºäºä¸ä¸ªæ¯3ç§æ§è¡ä¸æ¬¡çä»»å¡ã\n\n 4. å¤ç°\n\næä»¬å°æ­ç¹æå¨jobstore.update_job(job)ä¸ï¼ç¶åä½¿ç¨debugæ¨¡å¼è¿è¡è°è¯ï¼å½ç¨åºè¿è¡å°æ­ç¹ä¸æ¶ï¼å°æ°æ®åºå³é­ï¼ç¶åç¨åºç»§ç»­è¿è¡ï¼åä¼æ¥éï¼å¹¶æåºå¼å¸¸ï¼çº¿ç¨åæ­¢äºè¿è¡ãè³æ­¤ï¼æä»¬å¤ç°äºè¯¥é®é¢ã\n\n\n# çº¿ç¨éå¯\n\næä¸å¼å§æ³ï¼æå¯ä»¥å¤æ­è¯¥çº¿ç¨æ¯å¦å¼å¸¸ï¼å¦æå¼å¸¸åå°çº¿ç¨éå¯å°±å¥½äº\n\n    while true:\n        if not scheduler._thread.is_alive():\n            scheduler._thread.start()\n\n        time.sleep(10)\n\n\n1\n2\n3\n4\n5\n\n\nä½äºä¸æ¿è¿ï¼æåºäºå¼å¸¸ï¼å¼å¸¸ä¿¡æ¯å¦ä¸ï¼\n\nruntimeerror: threads can only be started once\n\n\n1\n\n\néè¿æ¥çå®æ¹ææ¡£å¯ä»¥ç¥éï¼çº¿ç¨çstartæ¹æ³åªè½è°ç¨ä¸æ¬¡ã\n\n\n# listener\n\napscheduleä¸­æä¾äºçå¬å¨æºå¶ï¼ä¹å°±æ¯å¨å®æ¶ä»»å¡çæåãå¤±è´¥ç­ç¶æé½å¯ä»¥éè¿æåæ³¨åçlisteneræ¹æ³æ¥è¿è¡åè°ãä½éè¿åææºç ï¼å¶å¹¶ä¸è½æè·å°å®æ¶ä»»å¡çº¿ç¨çå¼å¸¸ã\n\nä¸é¢æ¯ç®åäºä»£ç çlistenersçåçæµç¨ï¼\n\n 1. å¤é¨éè¿add_listeneræ¹æ³æ³¨ååè°æ¹æ³\n 2. å¨å®æ¶ä»»å¡çº¿ç¨ä¸»æµç¨_process_jobsä¸­åççåä¸ªäºä»¶æ·»å å°eventsä¸­\n 3. éåeventsäºä»¶ï¼ç¶åéè¿ä¸æ³¨åçåè°æ¹æ³maskè¿è¡å¹éï¼å¹éä¸åè°ç¨åè°æ¹æ³\n\nclass basescheduler:\n    def __init__(...):\n        self._listeners = []\n\n    def add_listener(self, callback, mask=event_all):\n        self._listeners.append((callback, mask))\n\n    def _process_jobs(self):\n\n        events = []\n        \n        ...\n\n        events.append(event)\n \n        ...\n\n\n        for event in events:\n            self._dispatch_event(event)\n\n\n    def _dispatch_event(self, event):\n        for cb, mask in listeners:\n            if event.code & mask:\n                try:\n                    cb(event)\n                except baseexception:\n                    self._logger.exception(\'error notifying listener\')\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\nå¦æçº¿ç¨æ¬èº«æäºï¼åè°æ¹æ³æ¯ä¸å¯æ§è¡çã\n\n\n# æè·çº¿ç¨ä¸­å½æ°çå¼å¸¸\n\nå¦æupdate_jobæåºå¼å¸¸å¯¼è´çº¿ç¨åæ­¢ï¼é£ææè·å®çå¼å¸¸ï¼ç¶ååcontinueï¼ç­å¾ä¸æ¬¡å®æ¶ä»»å¡è¿è¡åéè¯ä¸å°±å¥½äºï¼ä½æ¯è¿å°±éè¦æ¹å¨æºç ï¼è½ä¸è½æ¹æºç å°±å°½éä¸æ¹ãæä»¥è¿è¾¹æéç¨äºç»§æ¿backgroundschedulerç±»ï¼ç¶ååéå_process_jobsæ¹æ³æ¥è§£å³ã\n\nå¨éåç_process_jobsæ¹æ³ä¸­ï¼å¯¹ç¶ç±»ç_process_jobs()è¿è¡å¼å¸¸çæè·ï¼ç¶ååä¸æ­çè¿è¡éè¯ï¼è¿æ ·å³ä½¿update_jobæåºå¼å¸¸äºï¼ä¹å¯ä»¥ä¸æ­çè¿è¡å°è¯æ¢å¤ï¼ç´è³æåã\n\nclass demobackgroundscheduler(backgroundscheduler):\n    def _process_jobs(self):\n        while true:\n            try:\n                return super()._process_jobs()\n            except baseexception:\n                time.sleep(5)\n\nclass command(basecommand):\n    help = "runs apscheduler."\n\n    def handle(self, *args, **options):\n        scheduler = demobackgroundscheduler(timezone=settings.time_zone)\n        ...\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶ååæ¬¡å°è¯å¤ç°è¯¥é®é¢ï¼å¯ä»¥åç°å¨æ­å¼æ°æ®åºåï¼å®è½å¤ä¸ç´è¿è¡éè¯ï¼çº¿ç¨æ²¡æåæ­¢ï¼å½æ°æ®åºæ¢å¤è¿è¡åï¼jobæ§è¡æåï¼ä¸åæåºå¼å¸¸ã\n\n\n# ç¸å³é¾æ¥\n\n * apschedulerå®æ¹ææ¡£',charsets:{cjk:!0},lastUpdated:"2023/11/17, 16:03:58",lastUpdatedTimestamp:1700208238e3},{title:"ddtæºç åæ",frontmatter:{title:"ddtæºç åæ",date:"2022-10-23T20:04:51.000Z",permalink:"/pages/069c65/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ddt æ¯ python çç¬¬ä¸æ¹åºï¼ä¸»è¦æ¯è§£å³ä½¿ç¨ unittest æ¥ååæµæ¶å¯ä»¥æ¯æåæ°åçéç½®ï¼æ¬æä»ç»æºç è§£æè¯¥åºï¼çè§£å®çå®ç°è¿ç¨ã",feed:{enable:!0},tags:["python"],categories:["ç¼ç¨","python","ç¬¬ä¸æ¹åº"],comment:!0,meta:[{name:"twitter:title",content:"ddtæºç åæ"},{name:"twitter:description",content:"ddt æ¯ python çç¬¬ä¸æ¹åºï¼ä¸»è¦æ¯è§£å³ä½¿ç¨ unittest æ¥ååæµæ¶å¯ä»¥æ¯æåæ°åçéç½®ï¼æ¬æä»ç»æºç è§£æè¯¥åºï¼çè§£å®çå®ç°è¿ç¨ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/02.ddt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ddtæºç åæ"},{property:"og:description",content:"ddt æ¯ python çç¬¬ä¸æ¹åºï¼ä¸»è¦æ¯è§£å³ä½¿ç¨ unittest æ¥ååæµæ¶å¯ä»¥æ¯æåæ°åçéç½®ï¼æ¬æä»ç»æºç è§£æè¯¥åºï¼çè§£å®çå®ç°è¿ç¨ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/02.ddt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-10-23T20:04:51.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"ddtæºç åæ"},{itemprop:"description",content:"ddt æ¯ python çç¬¬ä¸æ¹åºï¼ä¸»è¦æ¯è§£å³ä½¿ç¨ unittest æ¥ååæµæ¶å¯ä»¥æ¯æåæ°åçéç½®ï¼æ¬æä»ç»æºç è§£æè¯¥åºï¼çè§£å®çå®ç°è¿ç¨ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/02.%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/02.ddt%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html",relativePath:"04.ç¼ç¨/01.python/02.ç¬¬ä¸æ¹åº/02.ddtæºç åæ.md",key:"v-dea92c98",path:"/pages/069c65/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. æºç åæ",slug:"_1-æºç åæ",normalizedTitle:"1. æºç åæ",charIndex:177},{level:3,title:"1.1 example",slug:"_1-1-example",normalizedTitle:"1.1 example",charIndex:189},{level:3,title:"1.2 æºç åææµç¨",slug:"_1-2-æºç åææµç¨",normalizedTitle:"1.2 æºç åææµç¨",charIndex:2004},{level:2,title:"2. æ»ç»",slug:"_2-æ»ç»",normalizedTitle:"2. æ»ç»",charIndex:5859}],headersStr:"0. åè¨ 1. æºç åæ 1.1 example 1.2 æºç åææµç¨ 2. æ»ç»",content:'# 0. åè¨\n\nddt æ¯ python çç¬¬ä¸æ¹åºï¼ä¸»è¦æ¯è§£å³ä½¿ç¨ unittest æ¥ååæµæ¶å¯ä»¥æ¯æåæ°åçéç½®ï¼è¿ä¸ªåºçä½¿ç¨æ¹æ³å¯ä»¥åèæä¹ååçä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯ãæ¬æä¸»è¦æ¯è®²èªå·±å¨å­¦ä¹  ddt åºæ¶æè·ã\n\nddt åºçä½¿ç¨æ¹æ³æ¯ç¨è£é¥°å¨æ¥å®ç°çï¼å¯ä»¥åèè¿è¾¹æç« pythonè£é¥°å¨çä½¿ç¨æ¹æ³æ¥å­¦ä¹ è£é¥°å¨.\n\n\n# 1. æºç åæ\n\n\n# 1.1 example\n\nåçä¸ä¸ªæç®åçä½¿ç¨ä¾å­ï¼æä»¬åå»º larger_than_two å½æ°ï¼å¹¶ä½¿ç¨ unittest å¯¹å¶ç¼ååæµã\n\nè¿éä½¿ç¨äº @ddt æ¥è£é¥° DemoTestCaseï¼å¹¶ä½¿ç¨ @data å¡«åå¤ä¸ªæµè¯çåæ°ï¼è¿æ ·æ§è¡å°±å®æäºåæ°åçåæµäºã\n\nimport unittest  \nfrom ddt import ddt, data  \n  \n  \ndef larger_than_two(value):  \n    return value > 2  \n  \n  \n@ddt  \nclass DemoTestCase(unittest.TestCase):  \n  \n    @data(1, 2, 3)  \n    def test_larger_than_two(self, value):  \n        self.assertTrue(larger_than_two(value))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næä»¬æ§è¡ä¸é¢çåæµä¼åç°ï¼è½ç¶æä»¬ä»£ç åªåäºä¸ä¸ªç¨ä¾ï¼ä½æ¯æ§è¡å´æ¯ 3 ä¸ªç¨ä¾ï¼æåäº 1 ä¸ªï¼å¤±è´¥äº 2 ä¸ªï¼å¹¶ä¸è¾åºäºå¤±è´¥çç¨ä¾çåç§°ï¼test_larger_than_two_1_1 å test_larger_than_two_2_2ï¼åç§°çè§åæ¯ï¼åæµçåç§°_ç´¢å¼_åæ°ã\n\nFF.\n======================================================================\nFAIL: test_larger_than_two_1_1 (__main__.DemoTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File "c:\\crazyboy\\code\\ddt\\ddt.py", line 220, in wrapper\n    return func(self, *args, **kwargs)\n  File "C:\\CrazyBoy\\workspace\\demo\\demo.py", line 24, in test_larger_than_two\n    self.assertTrue(larger_than_two(value))\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_larger_than_two_2_2 (__main__.DemoTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File "c:\\crazyboy\\code\\ddt\\ddt.py", line 220, in wrapper\n    return func(self, *args, **kwargs)\n  File "C:\\CrazyBoy\\workspace\\demo\\demo.py", line 24, in test_larger_than_two\n    self.assertTrue(larger_than_two(value))\nAssertionError: False is not true\n\n----------------------------------------------------------------------\nRan 3 tests in 0.004s\n\nFAILED (failures=2)\n\nProcess finished with exit code 1\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n\n\nè¿æ¯å¦ä½å®ç°çå¢ï¼\n\n\n# 1.2 æºç åææµç¨\n\næä»¬é¦åæ¥çç @data è£é¥°å¨éé¢åäºä»ä¹ï¼\n\ndef data(*values):  \n    return idata(values)\n\n\n1\n2\n\n\ndata è°ç¨äºå½æ° idataï¼æä»¬åæ¥çç idata çå®ç°ï¼éè¿ setattr æ¹æ³ï¼ç»è¢«è£é¥°çåæµç¨ä¾æ·»å ä¸¤ä¸ªå±æ§\n\n * DATA_ATTR æ¯ç¨æ¥ä¿å­ data çåæ°åçåæ°ã\n * INDEX_LEN ç¨æ¥ä¿å­åæ°åçé¿åº¦ã\n\nDATA_ATTR = \'%values\'\nINDEX_LEN = \'%index_len\'\n\ndef idata(iterable, index_len=None):  \n    if index_len is None:  \n        iterable = tuple(iterable)  \n        index_len = len(str(len(iterable)))  \n  \n    def wrapper(func):  \n        setattr(func, DATA_ATTR, iterable)  \n        setattr(func, INDEX_LEN, index_len)  \n        return func  \n  \n    return wrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶åæä»¬åæ¥çè£é¥°å¨@ddt ä¸­ï¼ä¼ å¥ç cls æ¯è¢«è£é¥°çåæµç±»ï¼éè¿è¯¥ç±»ï¼æ¾å°ä¸é¢ä½¿ç¨@data è£é¥°å¨ä¸­æ·»å çå±æ§ DATA_ATTR åå¯¹åºçåæµæ¹æ³ï¼å¶ä¸­çæ¯æ¡æ°æ®é½æ¯ä¸ä¸ªç¨ä¾ï¼éè¿éåè¯¥å±æ§ä¸­çåæ°å¼è°ç¨å½æ° mk_test_name å»æé æ¯ä¸æ¡åæ°çç¨ä¾åç§°ã\n\nç¶ååè°ç¨ add_test å½æ°å»çæå¯¹åºçåæµç¨ä¾ã\n\ndef ddt(arg=None, **kwargs):\n\tfmt_test_name = kwargs.get("testNameFormat", TestNameFormat.DEFAULT)  \n\t  \n\tdef wrapper(cls):  \n\t    for name, func in list(cls.__dict__.items()):  \n\t        if hasattr(func, DATA_ATTR):  \n\t            index_len = getattr(func, INDEX_LEN)  \n\t            for i, v in enumerate(getattr(func, DATA_ATTR)):  \n\t                test_name = mk_test_name(  \n\t                    name,  \n\t                    getattr(v, "__name__", v),  \n\t                    i,  \n\t                    index_len,  \n\t                    fmt_test_name  \n\t                )  \n\t                test_data_docstring = _get_test_data_docstring(func, v)  \n\t                if hasattr(func, UNPACK_ATTR):  \n\t                    if isinstance(v, tuple) or isinstance(v, list):  \n\t                        add_test(  \n\t                            cls,  \n\t                            test_name,  \n\t                            test_data_docstring,  \n\t                            func,  \n\t                            *v  \n\t                        )  \n\t                    else:  \n\t                        # unpack dictionary  \n\t                        add_test(  \n\t                            cls,  \n\t                            test_name,  \n\t                            test_data_docstring,  \n\t                            func,  \n\t                            **v  \n\t                        )  \n\t                else:  \n\t                    add_test(cls, test_name, test_data_docstring, func, v)  \n\t            delattr(cls, name)  \n\t        elif hasattr(func, FILE_ATTR):  \n\t            file_attr = getattr(func, FILE_ATTR)  \n\t            process_file_data(cls, name, func, file_attr)  \n\t            delattr(cls, name)  \n\t    return cls  \n\t  \n\t# ``arg`` is the unittest\'s test class when decorating with ``@ddt`` while  \n\t# it is ``None`` when decorating a test class with ``@ddt(k=v)``.  \n\treturn wrapper(arg) if inspect.isclass(arg) else wrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n\n\næä»¬çç add_test åäºä»ä¹ï¼å¾ç®åï¼å°±æ¯ç»åæµç TestCase æ·»å å±æ§ï¼ä»¥åæµç¨ä¾åç§°ä¸ºåï¼feed_data çè¿åå¼ä¸ºå¼ã\n\nfeed_data ä¸­ï¼æ ¹æ®åä¸ªåæ°å¼åè¢«@data è£é¥°çå½æ°ç»æä¸ä¸ªæ°çåæµç¨ä¾ï¼å¹¶è¿ååºå»ã\n\ndef add_test(cls, test_name, test_docstring, func, *args, **kwargs):  \n\tsetattr(cls, test_name, feed_data(func, test_name, test_docstring, *args, **kwargs))\n\ndef feed_data(func, new_name, test_data_docstring, *args, **kwargs):      \n    @wraps(func)  \n    def wrapper(self):  \n        return func(self, *args, **kwargs)  \n    wrapper.__name__ = new_name  \n    wrapper.__wrapped__ = func  \n    # set docstring if exists  \n    if test_data_docstring is not None:  \n        wrapper.__doc__ = test_data_docstring  \n    else:  \n        # Try to call format on the docstring  \n        if func.__doc__:  \n            try:  \n                wrapper.__doc__ = func.__doc__.format(*args, **kwargs)  \n            except (IndexError, KeyError):  \n\t\t\t\tpass  \n    return wrapper\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nä¹å°±æ¯è¯´ï¼åæ°åçæ¯ä¸ªå¼é½ä¼çæä¸ä¸ªç¨ä¾æ¹æ³å¹¶æ³¨åå°è¢«@ddt è£é¥°ç TestCase ç±»ä¸­ã\n\n\n# 2. æ»ç»\n\nä¸»è¦æµç¨æ¯ï¼éè¿ @data è£é¥°å¨å°åæ°åæ³¨åå°è¯¥åæµç¨ä¾æ¹æ³ç DATA_ATTR å±æ§ä¸­ï¼ç¶å@ddt è£é¥°å¨éåå½å TestCase çææåå« DATA_ATTR å±æ§çç¨ä¾æ¹æ³ï¼åéåå¶ DATA_ATTR çåæ°å¼ï¼ææ¯æ¡åæ°å¼é½çæä¸æ¡ç¨ä¾æ¹æ³ï¼å¹¶æ³¨åå° TestCase ä¸­ãè¿æ ·æ§è¡è¯¥ TestCase æ¶ï¼è½ç¶åªç¼ç äºä¸æ¡åæµï¼ä½æ¯å´æå¤æ¡ç¨ä¾è¢«æ§è¡ã\n\næ´ä¸ªè¿ç¨é½æ¯å¯¹ç±»ååæµæ¹æ³çåæ°æ®å±æ§è¿è¡åç§æä½æ¥å®ç°çã',normalizedContent:'# 0. åè¨\n\nddt æ¯ python çç¬¬ä¸æ¹åºï¼ä¸»è¦æ¯è§£å³ä½¿ç¨ unittest æ¥ååæµæ¶å¯ä»¥æ¯æåæ°åçéç½®ï¼è¿ä¸ªåºçä½¿ç¨æ¹æ³å¯ä»¥åèæä¹ååçä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯ãæ¬æä¸»è¦æ¯è®²èªå·±å¨å­¦ä¹  ddt åºæ¶æè·ã\n\nddt åºçä½¿ç¨æ¹æ³æ¯ç¨è£é¥°å¨æ¥å®ç°çï¼å¯ä»¥åèè¿è¾¹æç« pythonè£é¥°å¨çä½¿ç¨æ¹æ³æ¥å­¦ä¹ è£é¥°å¨.\n\n\n# 1. æºç åæ\n\n\n# 1.1 example\n\nåçä¸ä¸ªæç®åçä½¿ç¨ä¾å­ï¼æä»¬åå»º larger_than_two å½æ°ï¼å¹¶ä½¿ç¨ unittest å¯¹å¶ç¼ååæµã\n\nè¿éä½¿ç¨äº @ddt æ¥è£é¥° demotestcaseï¼å¹¶ä½¿ç¨ @data å¡«åå¤ä¸ªæµè¯çåæ°ï¼è¿æ ·æ§è¡å°±å®æäºåæ°åçåæµäºã\n\nimport unittest  \nfrom ddt import ddt, data  \n  \n  \ndef larger_than_two(value):  \n    return value > 2  \n  \n  \n@ddt  \nclass demotestcase(unittest.testcase):  \n  \n    @data(1, 2, 3)  \n    def test_larger_than_two(self, value):  \n        self.asserttrue(larger_than_two(value))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næä»¬æ§è¡ä¸é¢çåæµä¼åç°ï¼è½ç¶æä»¬ä»£ç åªåäºä¸ä¸ªç¨ä¾ï¼ä½æ¯æ§è¡å´æ¯ 3 ä¸ªç¨ä¾ï¼æåäº 1 ä¸ªï¼å¤±è´¥äº 2 ä¸ªï¼å¹¶ä¸è¾åºäºå¤±è´¥çç¨ä¾çåç§°ï¼test_larger_than_two_1_1 å test_larger_than_two_2_2ï¼åç§°çè§åæ¯ï¼åæµçåç§°_ç´¢å¼_åæ°ã\n\nff.\n======================================================================\nfail: test_larger_than_two_1_1 (__main__.demotestcase)\n----------------------------------------------------------------------\ntraceback (most recent call last):\n  file "c:\\crazyboy\\code\\ddt\\ddt.py", line 220, in wrapper\n    return func(self, *args, **kwargs)\n  file "c:\\crazyboy\\workspace\\demo\\demo.py", line 24, in test_larger_than_two\n    self.asserttrue(larger_than_two(value))\nassertionerror: false is not true\n\n======================================================================\nfail: test_larger_than_two_2_2 (__main__.demotestcase)\n----------------------------------------------------------------------\ntraceback (most recent call last):\n  file "c:\\crazyboy\\code\\ddt\\ddt.py", line 220, in wrapper\n    return func(self, *args, **kwargs)\n  file "c:\\crazyboy\\workspace\\demo\\demo.py", line 24, in test_larger_than_two\n    self.asserttrue(larger_than_two(value))\nassertionerror: false is not true\n\n----------------------------------------------------------------------\nran 3 tests in 0.004s\n\nfailed (failures=2)\n\nprocess finished with exit code 1\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n\n\nè¿æ¯å¦ä½å®ç°çå¢ï¼\n\n\n# 1.2 æºç åææµç¨\n\næä»¬é¦åæ¥çç @data è£é¥°å¨éé¢åäºä»ä¹ï¼\n\ndef data(*values):  \n    return idata(values)\n\n\n1\n2\n\n\ndata è°ç¨äºå½æ° idataï¼æä»¬åæ¥çç idata çå®ç°ï¼éè¿ setattr æ¹æ³ï¼ç»è¢«è£é¥°çåæµç¨ä¾æ·»å ä¸¤ä¸ªå±æ§\n\n * data_attr æ¯ç¨æ¥ä¿å­ data çåæ°åçåæ°ã\n * index_len ç¨æ¥ä¿å­åæ°åçé¿åº¦ã\n\ndata_attr = \'%values\'\nindex_len = \'%index_len\'\n\ndef idata(iterable, index_len=none):  \n    if index_len is none:  \n        iterable = tuple(iterable)  \n        index_len = len(str(len(iterable)))  \n  \n    def wrapper(func):  \n        setattr(func, data_attr, iterable)  \n        setattr(func, index_len, index_len)  \n        return func  \n  \n    return wrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶åæä»¬åæ¥çè£é¥°å¨@ddt ä¸­ï¼ä¼ å¥ç cls æ¯è¢«è£é¥°çåæµç±»ï¼éè¿è¯¥ç±»ï¼æ¾å°ä¸é¢ä½¿ç¨@data è£é¥°å¨ä¸­æ·»å çå±æ§ data_attr åå¯¹åºçåæµæ¹æ³ï¼å¶ä¸­çæ¯æ¡æ°æ®é½æ¯ä¸ä¸ªç¨ä¾ï¼éè¿éåè¯¥å±æ§ä¸­çåæ°å¼è°ç¨å½æ° mk_test_name å»æé æ¯ä¸æ¡åæ°çç¨ä¾åç§°ã\n\nç¶ååè°ç¨ add_test å½æ°å»çæå¯¹åºçåæµç¨ä¾ã\n\ndef ddt(arg=none, **kwargs):\n\tfmt_test_name = kwargs.get("testnameformat", testnameformat.default)  \n\t  \n\tdef wrapper(cls):  \n\t    for name, func in list(cls.__dict__.items()):  \n\t        if hasattr(func, data_attr):  \n\t            index_len = getattr(func, index_len)  \n\t            for i, v in enumerate(getattr(func, data_attr)):  \n\t                test_name = mk_test_name(  \n\t                    name,  \n\t                    getattr(v, "__name__", v),  \n\t                    i,  \n\t                    index_len,  \n\t                    fmt_test_name  \n\t                )  \n\t                test_data_docstring = _get_test_data_docstring(func, v)  \n\t                if hasattr(func, unpack_attr):  \n\t                    if isinstance(v, tuple) or isinstance(v, list):  \n\t                        add_test(  \n\t                            cls,  \n\t                            test_name,  \n\t                            test_data_docstring,  \n\t                            func,  \n\t                            *v  \n\t                        )  \n\t                    else:  \n\t                        # unpack dictionary  \n\t                        add_test(  \n\t                            cls,  \n\t                            test_name,  \n\t                            test_data_docstring,  \n\t                            func,  \n\t                            **v  \n\t                        )  \n\t                else:  \n\t                    add_test(cls, test_name, test_data_docstring, func, v)  \n\t            delattr(cls, name)  \n\t        elif hasattr(func, file_attr):  \n\t            file_attr = getattr(func, file_attr)  \n\t            process_file_data(cls, name, func, file_attr)  \n\t            delattr(cls, name)  \n\t    return cls  \n\t  \n\t# ``arg`` is the unittest\'s test class when decorating with ``@ddt`` while  \n\t# it is ``none`` when decorating a test class with ``@ddt(k=v)``.  \n\treturn wrapper(arg) if inspect.isclass(arg) else wrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n\n\næä»¬çç add_test åäºä»ä¹ï¼å¾ç®åï¼å°±æ¯ç»åæµç testcase æ·»å å±æ§ï¼ä»¥åæµç¨ä¾åç§°ä¸ºåï¼feed_data çè¿åå¼ä¸ºå¼ã\n\nfeed_data ä¸­ï¼æ ¹æ®åä¸ªåæ°å¼åè¢«@data è£é¥°çå½æ°ç»æä¸ä¸ªæ°çåæµç¨ä¾ï¼å¹¶è¿ååºå»ã\n\ndef add_test(cls, test_name, test_docstring, func, *args, **kwargs):  \n\tsetattr(cls, test_name, feed_data(func, test_name, test_docstring, *args, **kwargs))\n\ndef feed_data(func, new_name, test_data_docstring, *args, **kwargs):      \n    @wraps(func)  \n    def wrapper(self):  \n        return func(self, *args, **kwargs)  \n    wrapper.__name__ = new_name  \n    wrapper.__wrapped__ = func  \n    # set docstring if exists  \n    if test_data_docstring is not none:  \n        wrapper.__doc__ = test_data_docstring  \n    else:  \n        # try to call format on the docstring  \n        if func.__doc__:  \n            try:  \n                wrapper.__doc__ = func.__doc__.format(*args, **kwargs)  \n            except (indexerror, keyerror):  \n\t\t\t\tpass  \n    return wrapper\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nä¹å°±æ¯è¯´ï¼åæ°åçæ¯ä¸ªå¼é½ä¼çæä¸ä¸ªç¨ä¾æ¹æ³å¹¶æ³¨åå°è¢«@ddt è£é¥°ç testcase ç±»ä¸­ã\n\n\n# 2. æ»ç»\n\nä¸»è¦æµç¨æ¯ï¼éè¿ @data è£é¥°å¨å°åæ°åæ³¨åå°è¯¥åæµç¨ä¾æ¹æ³ç data_attr å±æ§ä¸­ï¼ç¶å@ddt è£é¥°å¨éåå½å testcase çææåå« data_attr å±æ§çç¨ä¾æ¹æ³ï¼åéåå¶ data_attr çåæ°å¼ï¼ææ¯æ¡åæ°å¼é½çæä¸æ¡ç¨ä¾æ¹æ³ï¼å¹¶æ³¨åå° testcase ä¸­ãè¿æ ·æ§è¡è¯¥ testcase æ¶ï¼è½ç¶åªç¼ç äºä¸æ¡åæµï¼ä½æ¯å´æå¤æ¡ç¨ä¾è¢«æ§è¡ã\n\næ´ä¸ªè¿ç¨é½æ¯å¯¹ç±»ååæµæ¹æ³çåæ°æ®å±æ§è¿è¡åç§æä½æ¥å®ç°çã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django rest_frameworkä½¿ç¨jwt",frontmatter:{tags:["python","django"],title:"django rest_frameworkä½¿ç¨jwt",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/25eafd/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»å¨ django rest_framework ä½¿ç¨jwtè®¤è¯.",feed:{enable:!0},categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218012751.jpg#alt="},{name:"twitter:title",content:"django rest_frameworkä½¿ç¨jwt"},{name:"twitter:description",content:"æ¬æä»ç»å¨ django rest_framework ä½¿ç¨jwtè®¤è¯."},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218012751.jpg#alt="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/02.django%20rest_framework%E4%BD%BF%E7%94%A8jwt.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django rest_frameworkä½¿ç¨jwt"},{property:"og:description",content:"æ¬æä»ç»å¨ django rest_framework ä½¿ç¨jwtè®¤è¯."},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218012751.jpg#alt="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/02.django%20rest_framework%E4%BD%BF%E7%94%A8jwt.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django rest_frameworkä½¿ç¨jwt"},{itemprop:"description",content:"æ¬æä»ç»å¨ django rest_framework ä½¿ç¨jwtè®¤è¯."},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218012751.jpg#alt="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/02.django%20rest_framework%E4%BD%BF%E7%94%A8jwt.html",relativePath:"04.ç¼ç¨/01.python/06.django/02.django rest_frameworkä½¿ç¨jwt.md",key:"v-a6f8fe8c",path:"/pages/25eafd/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:113},{level:2,title:"jwt è®¤è¯æµç¨",slug:"jwt-è®¤è¯æµç¨",normalizedTitle:"jwt è®¤è¯æµç¨",charIndex:126},{level:2,title:"ä½¿ç¨",slug:"ä½¿ç¨",normalizedTitle:"ä½¿ç¨",charIndex:34}],headersStr:"ç®ä» ç¸å³é¾æ¥ jwt è®¤è¯æµç¨ ä½¿ç¨",content:"# ç®ä»\n\næ¬æä»ç»å¨ django rest_framework ä½¿ç¨jwtè®¤è¯.\n\njwt ä¸æ¯ rest_frameworkèªå¸¦çè®¤è¯æ¹å¼ï¼éè¦éè¿ç¬¬ä¸æ¹åºdjangorestframework-jwtç»åä½¿ç¨\n\n\n# ç¸å³é¾æ¥\n\nå®ç½\n\n\n# jwt è®¤è¯æµç¨\n\n\n\n\n# ä½¿ç¨\n\n 0. å®è£djangorestframework-jwt\n\n> pip install djangorestframework-jwt\n\n 1. æ·»å è·åtokençè·¯ç±\n\nfrom rest_framework_jwt.views import obtain_jwt_token\n\nurlpatterns = [\n    re_path(r'^api-token-auth/', obtain_jwt_token),\n]\n\n\n1\n2\n3\n4\n5\n\n 2. å¨å±æ·»å è®¤è¯ãå°jwt authenticationç±»æ³¨å¥å°æ¡æ¶ä¸­\n\nè®¿é®ä»»ä½çè·¯ç±é½ä¼ä½¿ç¨JSONWebTokenAuthentication.authenticateè¿è¡è®¤è¯.\n\nsettings.py\n\nREST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': [\n        'rest_framework_jwt.authentication.JSONWebTokenAuthentication',\n    ]\n\n\n1\n2\n3\n4\n\n 3. å±é¨æ·»å è®¤è¯ï¼å¨APIViewä¸­æ·»å è®¤è¯ç±».\n\næ¯æ¬¡è®¿é®è¯¥è§å¾æ¶ï¼é½ä¼è°ç¨JSONWebTokenAuthentication.authenticate è¿è¡è®¤è¯.\n\nclass TestView(APIView):\n    authentication_classes = (JSONWebTokenAuthentication,)\n\n    def get(self, *args, **kwargs):\n        return HttpResponse(self.request.user)\n\n\n1\n2\n3\n4\n5\n\n 4. è®¾ç½®\n\nsettings.py\n\n\nJWT_AUTH = {\n    'JWT_EXPIRATION_DELTA': datetime.timedelta(minutes=30),   # è¿ææ¶é´\n    'JWT_RESPONSE_PAYLOAD_HANDLER': 'user.utils.jwt_response_payload_handler'    # é»è®¤è¿åçä»æ`token`å­æ®µï¼å¯ä»¥ç±èªå·±ä¿®æ¹è¿åçæ°æ®ï¼å¯ä»¥åå«user.idåuser.username   \n}\n\n\n1\n2\n3\n4\n5\n",normalizedContent:"# ç®ä»\n\næ¬æä»ç»å¨ django rest_framework ä½¿ç¨jwtè®¤è¯.\n\njwt ä¸æ¯ rest_frameworkèªå¸¦çè®¤è¯æ¹å¼ï¼éè¦éè¿ç¬¬ä¸æ¹åºdjangorestframework-jwtç»åä½¿ç¨\n\n\n# ç¸å³é¾æ¥\n\nå®ç½\n\n\n# jwt è®¤è¯æµç¨\n\n\n\n\n# ä½¿ç¨\n\n 0. å®è£djangorestframework-jwt\n\n> pip install djangorestframework-jwt\n\n 1. æ·»å è·åtokençè·¯ç±\n\nfrom rest_framework_jwt.views import obtain_jwt_token\n\nurlpatterns = [\n    re_path(r'^api-token-auth/', obtain_jwt_token),\n]\n\n\n1\n2\n3\n4\n5\n\n 2. å¨å±æ·»å è®¤è¯ãå°jwt authenticationç±»æ³¨å¥å°æ¡æ¶ä¸­\n\nè®¿é®ä»»ä½çè·¯ç±é½ä¼ä½¿ç¨jsonwebtokenauthentication.authenticateè¿è¡è®¤è¯.\n\nsettings.py\n\nrest_framework = {\n    'default_authentication_classes': [\n        'rest_framework_jwt.authentication.jsonwebtokenauthentication',\n    ]\n\n\n1\n2\n3\n4\n\n 3. å±é¨æ·»å è®¤è¯ï¼å¨apiviewä¸­æ·»å è®¤è¯ç±».\n\næ¯æ¬¡è®¿é®è¯¥è§å¾æ¶ï¼é½ä¼è°ç¨jsonwebtokenauthentication.authenticate è¿è¡è®¤è¯.\n\nclass testview(apiview):\n    authentication_classes = (jsonwebtokenauthentication,)\n\n    def get(self, *args, **kwargs):\n        return httpresponse(self.request.user)\n\n\n1\n2\n3\n4\n5\n\n 4. è®¾ç½®\n\nsettings.py\n\n\njwt_auth = {\n    'jwt_expiration_delta': datetime.timedelta(minutes=30),   # è¿ææ¶é´\n    'jwt_response_payload_handler': 'user.utils.jwt_response_payload_handler'    # é»è®¤è¿åçä»æ`token`å­æ®µï¼å¯ä»¥ç±èªå·±ä¿®æ¹è¿åçæ°æ®ï¼å¯ä»¥åå«user.idåuser.username   \n}\n\n\n1\n2\n3\n4\n5\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django rest_framework Authentication",frontmatter:{tags:["python","django"],title:"django rest_framework Authentication",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/626675/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»çæ¯ django rest_frameworkçè®¤è¯æ¹å¼.",feed:{enable:!0},categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217645776.png#alt="},{name:"twitter:title",content:"django rest_framework Authentication"},{name:"twitter:description",content:"æ¬æä»ç»çæ¯ django rest_frameworkçè®¤è¯æ¹å¼."},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217645776.png#alt="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/03.django%20rest_framework%20Authentication.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django rest_framework Authentication"},{property:"og:description",content:"æ¬æä»ç»çæ¯ django rest_frameworkçè®¤è¯æ¹å¼."},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217645776.png#alt="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/03.django%20rest_framework%20Authentication.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django rest_framework Authentication"},{itemprop:"description",content:"æ¬æä»ç»çæ¯ django rest_frameworkçè®¤è¯æ¹å¼."},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217645776.png#alt="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/03.django%20rest_framework%20Authentication.html",relativePath:"04.ç¼ç¨/01.python/06.django/03.django rest_framework Authentication.md",key:"v-cf78fd3a",path:"/pages/626675/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"æºç è§£æ",slug:"æºç è§£æ",normalizedTitle:"æºç è§£æ",charIndex:132},{level:2,title:"è®¤è¯æ¹å¼",slug:"è®¤è¯æ¹å¼",normalizedTitle:"è®¤è¯æ¹å¼",charIndex:35},{level:3,title:"Token",slug:"token",normalizedTitle:"token",charIndex:42},{level:4,title:"ä½¿ç¨",slug:"ä½¿ç¨",normalizedTitle:"ä½¿ç¨",charIndex:124},{level:4,title:"ç¼ºé·",slug:"ç¼ºé·",normalizedTitle:"ç¼ºé·",charIndex:1493},{level:3,title:"session",slug:"session",normalizedTitle:"session",charIndex:1683}],headersStr:"ç®ä» æºç è§£æ è®¤è¯æ¹å¼ Token ä½¿ç¨ ç¼ºé· session",content:"# ç®ä»\n\næ¬æä»ç»çæ¯ django rest_frameworkçè®¤è¯æ¹å¼.\n\nTokenãSessionãRemoteUserãjwtç­è®¤è¯æ¹å¼ãåä¸ç§æ¯æ¡æ¶èªå¸¦çï¼èjwtéè¦å®è£ç¬¬ä¸æ¹åºdjangorestframework-jwtï¼ç¶åä½¿ç¨ã\n\n\n# æºç è§£æ\n\nä»¥ä¸æ¯è®¤è¯æºç è®¤è¯æµç¨.\n\n 1. éè¿è·¯ç±å¹éåé¦åè¿å¥å°ApiView.as_viewä¸­.\n\n 2. ApiViewç»§æ¿DjangoçViewï¼ç¶åè°ç¨View.as_view\n\n 3. å¨Viewä¸­è°ç¨dispatchæ¹æ³ï¼å ä¸ºApiViewå®ç°dispatchæ¹æ³ï¼æä»¥è°ç¨çæ¯ApiView.dispatchèä¸æ¯View.dispatch.\n\n 4. å¨ApiView.dispatchä¸­å°django.requeståæ¬¡å°è£ææ¡æ¶çrest_framework.request\n\n 5. å°è£çè¿ç¨ä¸­å°éç½®çAuthenticationç±»æ³¨å¥å°requestä¸­.\n\n 6. å°è£å®requeståï¼è°ç¨ApiView.perform_authenticationå¼å§è®¤è¯\n\n 7. è®¤è¯çè¿ç¨æ¯éè¿request.userï¼ç¶ååè°ç¨request._authenticationè¿è¡å¾ªç¯éåæææ³¨å¥çAuthentiationç±»ä¸­authenticateæ¹æ³è¿è¡è®¤è¯ï¼è®¤è¯æååè¿åuseråauthä¸¤ä¸ªç»æ.\n\n\n\n\n# è®¤è¯æ¹å¼\n\nå¯ä»¥èªå®ä¹è®¤è¯ç±»ï¼åªéè¦ç»§æ¿BaseAuthenticationç±»ï¼ç¶åå®ç°authenticateæ¹æ³å³å¯ï¼ç¶åå°è¯¥ç±»æ³¨å¥å°requestå³å¯.\n\næèä½¿ç¨æ¡æ¶èªå¸¦çè®¤è¯ç±»ä¹å¯ã\n\n\n# Token\n\næ¯æ¡æ¶èªå¸¦çè®¤è¯æ¹å¼ä¹ä¸.\n\n# ä½¿ç¨\n\n 1. éç½®authtoken app settings\n\nINSTALLED_APPS = [\n    ...\n    'rest_framework.authtoken']\n\n\n1\n2\n3\n\n\nç¶åä½¿ç¨python manage.py migrateï¼ä¼åå»ºauthtokenè¡¨ï¼è¯¥è¡¨è¿æ¥auth_user.è¡¨ï¼æ¯ä¸ªç¨æ·é½æå¯¹åºä¸ä¸ªtokenï¼ç¨æ·æ¯æ¬¡è®¿é®å¸¦æè¯¥tokenï¼ç³»ç»å°±è½éè¿tokenå¾å°å½åuser.\n\n 2. å±é¨æ·»å è®¤è¯æ¹å¼.\n\nå¨TestViewæ·»å TokenAuthenticationè®¤è¯, è·¯ç±å°TestViewæ¶ï¼ä¼è°ç¨è¯¥ç±»ä¸­çauthenticateæ¹æ³ï¼éè¿tokenè·åå°user.\n\nview.py\n\n\nfrom rest_framework.authentication import TokenAuthentication\n\nclass TestView(APIView):\n    authentication_classes = (TokenAuthentication,)\n\n    def get(self, *args, **kwargs):\n        return HttpResponse(self.request.user)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 3. å¨å±æ·»å è®¤è¯æ¹å¼\n\nä»»ä½è·¯ç±è¯·æ±éè¦éè¿Tokenè®¤è¯.\n\nsettings.py\n\nREST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': [\n        'rest_framework.authentication.TokenAuthentication',\n    ]\n}\n\n\n1\n2\n3\n4\n5\n\n\n# ç¼ºé·\n\n * Tokenéªè¯æ¯æ¾å¨ä¸å¼ è¡¨ä¸­ï¼å³authtoken_tokenä¸­ï¼keyæ²¡æå¤±ææ¶é´ï¼æ°¸ä¹ææï¼ä¸æ¦æ³é²ï¼åæä¸å¯æ³è±¡ï¼å®å¨æ§æå·®ã\n * ä¸å©äºåå¸å¼é¨ç½²æå¤ä¸ªç³»ç»ä½¿ç¨ä¸å¥éªè¯ï¼authtoken_tokenæ¯æ¾å¨æå°æå¡å¨ä¸çï¼å¦æåå¸å¼é¨ç½²ï¼å°å¤±æï¼æå¤ä¸ªç³»ç»ç¨ä¸å¥éªè¯ï¼å°å¿é¡»å¤å¶è¯¥è¡¨å°ç¸åºæå¡å¨ä¸ï¼éº»ç¦è´¹åã\n\né´äºä»¥ä¸ç¼ºé·ï¼ä½¿ç¨jwtæ´å ä¼ç§.\n\n\n# session\n\ndrfä¸­sessionè®¤è¯ï¼æ¯éè¿django SessionMiddlewareåAuthenticationMiddlewareä¸­å°userå­å¨å°requestä¸­ï¼ç¶åè·åå°ç.\n\n",normalizedContent:"# ç®ä»\n\næ¬æä»ç»çæ¯ django rest_frameworkçè®¤è¯æ¹å¼.\n\ntokenãsessionãremoteuserãjwtç­è®¤è¯æ¹å¼ãåä¸ç§æ¯æ¡æ¶èªå¸¦çï¼èjwtéè¦å®è£ç¬¬ä¸æ¹åºdjangorestframework-jwtï¼ç¶åä½¿ç¨ã\n\n\n# æºç è§£æ\n\nä»¥ä¸æ¯è®¤è¯æºç è®¤è¯æµç¨.\n\n 1. éè¿è·¯ç±å¹éåé¦åè¿å¥å°apiview.as_viewä¸­.\n\n 2. apiviewç»§æ¿djangoçviewï¼ç¶åè°ç¨view.as_view\n\n 3. å¨viewä¸­è°ç¨dispatchæ¹æ³ï¼å ä¸ºapiviewå®ç°dispatchæ¹æ³ï¼æä»¥è°ç¨çæ¯apiview.dispatchèä¸æ¯view.dispatch.\n\n 4. å¨apiview.dispatchä¸­å°django.requeståæ¬¡å°è£ææ¡æ¶çrest_framework.request\n\n 5. å°è£çè¿ç¨ä¸­å°éç½®çauthenticationç±»æ³¨å¥å°requestä¸­.\n\n 6. å°è£å®requeståï¼è°ç¨apiview.perform_authenticationå¼å§è®¤è¯\n\n 7. è®¤è¯çè¿ç¨æ¯éè¿request.userï¼ç¶ååè°ç¨request._authenticationè¿è¡å¾ªç¯éåæææ³¨å¥çauthentiationç±»ä¸­authenticateæ¹æ³è¿è¡è®¤è¯ï¼è®¤è¯æååè¿åuseråauthä¸¤ä¸ªç»æ.\n\n\n\n\n# è®¤è¯æ¹å¼\n\nå¯ä»¥èªå®ä¹è®¤è¯ç±»ï¼åªéè¦ç»§æ¿baseauthenticationç±»ï¼ç¶åå®ç°authenticateæ¹æ³å³å¯ï¼ç¶åå°è¯¥ç±»æ³¨å¥å°requestå³å¯.\n\næèä½¿ç¨æ¡æ¶èªå¸¦çè®¤è¯ç±»ä¹å¯ã\n\n\n# token\n\næ¯æ¡æ¶èªå¸¦çè®¤è¯æ¹å¼ä¹ä¸.\n\n# ä½¿ç¨\n\n 1. éç½®authtoken app settings\n\ninstalled_apps = [\n    ...\n    'rest_framework.authtoken']\n\n\n1\n2\n3\n\n\nç¶åä½¿ç¨python manage.py migrateï¼ä¼åå»ºauthtokenè¡¨ï¼è¯¥è¡¨è¿æ¥auth_user.è¡¨ï¼æ¯ä¸ªç¨æ·é½æå¯¹åºä¸ä¸ªtokenï¼ç¨æ·æ¯æ¬¡è®¿é®å¸¦æè¯¥tokenï¼ç³»ç»å°±è½éè¿tokenå¾å°å½åuser.\n\n 2. å±é¨æ·»å è®¤è¯æ¹å¼.\n\nå¨testviewæ·»å tokenauthenticationè®¤è¯, è·¯ç±å°testviewæ¶ï¼ä¼è°ç¨è¯¥ç±»ä¸­çauthenticateæ¹æ³ï¼éè¿tokenè·åå°user.\n\nview.py\n\n\nfrom rest_framework.authentication import tokenauthentication\n\nclass testview(apiview):\n    authentication_classes = (tokenauthentication,)\n\n    def get(self, *args, **kwargs):\n        return httpresponse(self.request.user)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 3. å¨å±æ·»å è®¤è¯æ¹å¼\n\nä»»ä½è·¯ç±è¯·æ±éè¦éè¿tokenè®¤è¯.\n\nsettings.py\n\nrest_framework = {\n    'default_authentication_classes': [\n        'rest_framework.authentication.tokenauthentication',\n    ]\n}\n\n\n1\n2\n3\n4\n5\n\n\n# ç¼ºé·\n\n * tokenéªè¯æ¯æ¾å¨ä¸å¼ è¡¨ä¸­ï¼å³authtoken_tokenä¸­ï¼keyæ²¡æå¤±ææ¶é´ï¼æ°¸ä¹ææï¼ä¸æ¦æ³é²ï¼åæä¸å¯æ³è±¡ï¼å®å¨æ§æå·®ã\n * ä¸å©äºåå¸å¼é¨ç½²æå¤ä¸ªç³»ç»ä½¿ç¨ä¸å¥éªè¯ï¼authtoken_tokenæ¯æ¾å¨æå°æå¡å¨ä¸çï¼å¦æåå¸å¼é¨ç½²ï¼å°å¤±æï¼æå¤ä¸ªç³»ç»ç¨ä¸å¥éªè¯ï¼å°å¿é¡»å¤å¶è¯¥è¡¨å°ç¸åºæå¡å¨ä¸ï¼éº»ç¦è´¹åã\n\né´äºä»¥ä¸ç¼ºé·ï¼ä½¿ç¨jwtæ´å ä¼ç§.\n\n\n# session\n\ndrfä¸­sessionè®¤è¯ï¼æ¯éè¿django sessionmiddlewareåauthenticationmiddlewareä¸­å°userå­å¨å°requestä¸­ï¼ç¶åè·åå°ç.\n\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django rest_frameworkå¼å¸¸å¤ç",frontmatter:{tags:["python","django"],title:"django rest_frameworkå¼å¸¸å¤ç",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/070fec/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å½ç¨åºä¸­åºç°å¼å¸¸æ¶ï¼æä»¬æ³è¦è¿åçæ¯åå«å¼å¸¸ä¿¡æ¯çjsonæ°æ®ãè¿åæ­£å¸¸çä¿¡æ¯åå¼å¸¸ä¿¡æ¯çæ ¼å¼ä¸è´åã",feed:{enable:!0},categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django rest_frameworkå¼å¸¸å¤ç"},{name:"twitter:description",content:"å½ç¨åºä¸­åºç°å¼å¸¸æ¶ï¼æä»¬æ³è¦è¿åçæ¯åå«å¼å¸¸ä¿¡æ¯çjsonæ°æ®ãè¿åæ­£å¸¸çä¿¡æ¯åå¼å¸¸ä¿¡æ¯çæ ¼å¼ä¸è´åã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/04.django%20rest_framework%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django rest_frameworkå¼å¸¸å¤ç"},{property:"og:description",content:"å½ç¨åºä¸­åºç°å¼å¸¸æ¶ï¼æä»¬æ³è¦è¿åçæ¯åå«å¼å¸¸ä¿¡æ¯çjsonæ°æ®ãè¿åæ­£å¸¸çä¿¡æ¯åå¼å¸¸ä¿¡æ¯çæ ¼å¼ä¸è´åã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/04.django%20rest_framework%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django rest_frameworkå¼å¸¸å¤ç"},{itemprop:"description",content:"å½ç¨åºä¸­åºç°å¼å¸¸æ¶ï¼æä»¬æ³è¦è¿åçæ¯åå«å¼å¸¸ä¿¡æ¯çjsonæ°æ®ãè¿åæ­£å¸¸çä¿¡æ¯åå¼å¸¸ä¿¡æ¯çæ ¼å¼ä¸è´åã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/04.django%20rest_framework%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html",relativePath:"04.ç¼ç¨/01.python/06.django/04.django rest_frameworkå¼å¸¸å¤ç.md",key:"v-3599af91",path:"/pages/070fec/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"æä½",slug:"æä½",normalizedTitle:"æä½",charIndex:62}],headersStr:"ç®ä» æä½",content:'# ç®ä»\n\nå½ç¨åºä¸­åºç°å¼å¸¸æ¶ï¼æä»¬æ³è¦è¿åçæ¯åå«å¼å¸¸ä¿¡æ¯çjsonæ°æ®ãè¿åæ­£å¸¸çä¿¡æ¯åå¼å¸¸ä¿¡æ¯çæ ¼å¼ä¸è´åã\n\n\n# æä½\n\n 1. èªå®ä¹jsonè¿åçæ ¼å¼\n\nlibs/response.py\n\nfrom rest_framework.response import Response\n\n\nclass JsonResponse(Response):\n    def __init__(self, data=None, code=None, msg=None, status=None,\n                 template_name=None, headers=None,\n                 exception=False, content_type=None):\n        rsp_data = {"code": code, "message": msg, "data": data}\n        super(JsonResponse, self).__init__(data=rsp_data, status=status, template_name=template_name,\n                                                 headers=headers,\n                                                 exception=exception, content_type=content_type)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n 2. èªå®ä¹å¨å±çå¼å¸¸å¤çæ¹æ³ libs/exceptions.py\n\n\nfrom rest_framework import status\nfrom rest_framework.views import exception_handler\nfrom libs.response import JsonResponse\n\n\nclass DataException(Exception):\n\n    def __init__(self, message="", code=0, status=status.HTTP_400_BAD_REQUEST, data=None):\n        self.code = code\n        self.status = status\n        self.detail = message\n        self.data = data if data else {}\n\n        def __str__(self):\n            return self.message\n\n\ndef custom_exception_handler(exc, context):\n    data = exc.data if hasattr(exc, "data") else {}\n    return JsonResponse(msg=exc.detail, status=exc.status_code, data=data, code=exc.status_code)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n 3. å°è¯¥å¼å¸¸æ¹æ³æ³¨åå°rest_frameworkæ¡æ¶ä¸­ settings.py\n\nREST_FRAMEWORK = {\n    \'EXCEPTION_HANDLER\': \'libs.exceptions.custom_exception_handler\',\n}\n\n\n1\n2\n3\n',normalizedContent:'# ç®ä»\n\nå½ç¨åºä¸­åºç°å¼å¸¸æ¶ï¼æä»¬æ³è¦è¿åçæ¯åå«å¼å¸¸ä¿¡æ¯çjsonæ°æ®ãè¿åæ­£å¸¸çä¿¡æ¯åå¼å¸¸ä¿¡æ¯çæ ¼å¼ä¸è´åã\n\n\n# æä½\n\n 1. èªå®ä¹jsonè¿åçæ ¼å¼\n\nlibs/response.py\n\nfrom rest_framework.response import response\n\n\nclass jsonresponse(response):\n    def __init__(self, data=none, code=none, msg=none, status=none,\n                 template_name=none, headers=none,\n                 exception=false, content_type=none):\n        rsp_data = {"code": code, "message": msg, "data": data}\n        super(jsonresponse, self).__init__(data=rsp_data, status=status, template_name=template_name,\n                                                 headers=headers,\n                                                 exception=exception, content_type=content_type)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n 2. èªå®ä¹å¨å±çå¼å¸¸å¤çæ¹æ³ libs/exceptions.py\n\n\nfrom rest_framework import status\nfrom rest_framework.views import exception_handler\nfrom libs.response import jsonresponse\n\n\nclass dataexception(exception):\n\n    def __init__(self, message="", code=0, status=status.http_400_bad_request, data=none):\n        self.code = code\n        self.status = status\n        self.detail = message\n        self.data = data if data else {}\n\n        def __str__(self):\n            return self.message\n\n\ndef custom_exception_handler(exc, context):\n    data = exc.data if hasattr(exc, "data") else {}\n    return jsonresponse(msg=exc.detail, status=exc.status_code, data=data, code=exc.status_code)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n 3. å°è¯¥å¼å¸¸æ¹æ³æ³¨åå°rest_frameworkæ¡æ¶ä¸­ settings.py\n\nrest_framework = {\n    \'exception_handler\': \'libs.exceptions.custom_exception_handler\',\n}\n\n\n1\n2\n3\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django celery ç»åä½¿ç¨",frontmatter:{title:"django celery ç»åä½¿ç¨",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/853501/",tags:["python","django"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦ä»ç»djangoåceleryç»åä½¿ç¨çæ¡ä¾ã",feed:{enable:!0},categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217044049.png#alt=#crop=0&crop=0&crop=1&crop=1&id=kAMz1&originHeight=475&originWidth=564&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{name:"twitter:title",content:"django celery ç»åä½¿ç¨"},{name:"twitter:description",content:"æ¬æä¸»è¦ä»ç»djangoåceleryç»åä½¿ç¨çæ¡ä¾ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217044049.png#alt=#crop=0&crop=0&crop=1&crop=1&id=kAMz1&originHeight=475&originWidth=564&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/01.django%20celery%20%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django celery ç»åä½¿ç¨"},{property:"og:description",content:"æ¬æä¸»è¦ä»ç»djangoåceleryç»åä½¿ç¨çæ¡ä¾ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217044049.png#alt=#crop=0&crop=0&crop=1&crop=1&id=kAMz1&originHeight=475&originWidth=564&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/01.django%20celery%20%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django celery ç»åä½¿ç¨"},{itemprop:"description",content:"æ¬æä¸»è¦ä»ç»djangoåceleryç»åä½¿ç¨çæ¡ä¾ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217044049.png#alt=#crop=0&crop=0&crop=1&crop=1&id=kAMz1&originHeight=475&originWidth=564&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/01.django%20celery%20%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8.html",relativePath:"04.ç¼ç¨/01.python/06.django/01.django celery ç»åä½¿ç¨.md",key:"v-3e233877",path:"/pages/853501/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"æµç¨",slug:"æµç¨",normalizedTitle:"æµç¨",charIndex:143},{level:2,title:"æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶",slug:"æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶",normalizedTitle:"æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶",charIndex:233},{level:2,title:"celery-beat",slug:"celery-beat",normalizedTitle:"celery-beat",charIndex:254},{level:2,title:"æ¡ä¾1",slug:"æ¡ä¾1",normalizedTitle:"æ¡ä¾1",charIndex:399},{level:3,title:"éç½®celery",slug:"éç½®celery",normalizedTitle:"éç½®celery",charIndex:425},{level:3,title:"å¨viewä¸­å¼æ­¥æ§è¡task",slug:"å¨viewä¸­å¼æ­¥æ§è¡task",normalizedTitle:"å¨viewä¸­å¼æ­¥æ§è¡task",charIndex:1933},{level:2,title:"æ¡ä¾2",slug:"æ¡ä¾2",normalizedTitle:"æ¡ä¾2",charIndex:2660},{level:3,title:"å®æ¶ä»»å¡ç®ä»",slug:"å®æ¶ä»»å¡ç®ä»",normalizedTitle:"å®æ¶ä»»å¡ç®ä»",charIndex:2678},{level:3,title:"éç½®",slug:"éç½®",normalizedTitle:"éç½®",charIndex:425},{level:3,title:"å®æ¶ä»»å¡",slug:"å®æ¶ä»»å¡",normalizedTitle:"å®æ¶ä»»å¡",charIndex:66},{level:2,title:"æ¡ä¾ä¸-è·¯ç±",slug:"æ¡ä¾ä¸-è·¯ç±",normalizedTitle:"æ¡ä¾ä¸-è·¯ç±",charIndex:3083},{level:3,title:"ç®¡çworker è¿ç¨",slug:"ç®¡çworker-è¿ç¨",normalizedTitle:"ç®¡çworker è¿ç¨",charIndex:3819},{level:3,title:"åºæ¬æä½",slug:"åºæ¬æä½",normalizedTitle:"åºæ¬æä½",charIndex:3861},{level:3,title:"å½ä»¤",slug:"å½ä»¤",normalizedTitle:"å½ä»¤",charIndex:3970},{level:3,title:"éåceleryä½¿ç¨",slug:"éåceleryä½¿ç¨",normalizedTitle:"éåceleryä½¿ç¨",charIndex:4105},{level:3,title:"é®é¢",slug:"é®é¢",normalizedTitle:"é®é¢",charIndex:5604},{level:2,title:"ä½¿ç¨flowerçæ§celery",slug:"ä½¿ç¨flowerçæ§celery",normalizedTitle:"ä½¿ç¨flowerçæ§celery",charIndex:5786},{level:3,title:"æä¹å",slug:"æä¹å",normalizedTitle:"æä¹å",charIndex:5930},{level:3,title:"æ¶åºé®é¢",slug:"æ¶åºé®é¢",normalizedTitle:"æ¶åºé®é¢",charIndex:6018}],headersStr:"ç®ä» æµç¨ æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶ celery-beat æ¡ä¾1 éç½®celery å¨viewä¸­å¼æ­¥æ§è¡task æ¡ä¾2 å®æ¶ä»»å¡ç®ä» éç½® å®æ¶ä»»å¡ æ¡ä¾ä¸-è·¯ç± ç®¡çworker è¿ç¨ åºæ¬æä½ å½ä»¤ éåceleryä½¿ç¨ é®é¢ ä½¿ç¨flowerçæ§celery æä¹å æ¶åºé®é¢",content:"# ç®ä»\n\næ¬æä¸»è¦ä»ç»djangoåceleryç»åä½¿ç¨çæ¡ä¾ã\n\ncelery æ¯ä¸ä¸ªå¼æ­¥ä»»å¡çè°åº¦å·¥å·ï¼å¯ä»¥å®æä¸äºå¼æ­¥ä»»å¡åå®æ¶ä»»å¡ã\n\næ¬æä½¿ç¨djceleryæ¥å®ædjangoåceleryçç»åä½¿ç¨ã\n\nè¯¥æ¡ä¾å¨githubä¸­django_celery_demo\n\n\n# æµç¨\n\nä»»å¡åå¸è(Producer)å°ä»»å¡ä¸¢å°æ¶æ¯éå(Broker)ä¸­ï¼ä»»å¡æ¶è´¹è(worker)ä»æ¶æ¯ä»£çä¸­è·åä»»å¡æ§è¡ï¼ç¶åå°ä¿å­å­å¨ç»æ(backend)ã\n\n\n\n\n# æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶\n\n\n\n\n# celery-beat\n\ncelery æä¸ªå®æ¶åè½ï¼éè¿å®æ¶å»å°taskä¸¢å°brokerä¸­ï¼ç¶åworkerå»æ§è¡ä»»å¡ãä½æ¯æä¸ªç¡®å®æ¯ï¼è¯¥å®æ¶ä»»å¡å¿é¡»ç¡¬ç¼åå°ä»£ç ä¸­ï¼ä¸å¯å¨ç¨åºè¿è¡ä¸­å¨æå¢å ä»»å¡ãä½¿ç¨djceleryå¯ä»¥å°å®æ¶ä»»å¡åå¥å°æ°æ®åºä¸­ï¼ç¶åéè¿æä½æ°æ®åºæä½å®æ¶ä»»å¡ã\n\n\n# æ¡ä¾1\n\nè®¿é®æ¥å£ï¼å¼æ­¥è°ç¨ç¨åºä¸­task\n\n\n# éç½®celery\n\nå®è£**djcelery**\n\n> pip install django_celery\n\nå¨settingsä¸­è®¾ç½®celeryéç½®\n\nä»£ç : django_celery_demo/settings.py\n\nimport djcelery\ndjcelery.setup_loader() # å è½½djcelery\n\n\n# åè®¸çæ ¼å¼\nCELERY_ACCEPT_CONTENT = ['pickle', 'json', 'yaml']\n\nBROKER_URL = 'redis://localhost:6379/1' # redisä½ä¸ºä¸­é´ä»¶\nBROKER_TRANSPORT = 'redis'\n\nCELERYBEAT_SCHEDULER = 'djcelery.schedulers.DatabaseScheduler' # å®æ¶ä»»å¡ä½¿ç¨æ°æ®åºæ¥æä½\nCELERY_RESULT_BACKEND = 'djcelery.backends.database:DatabaseBackend'  # ç»æå­å¨å°æ°æ®åºä¸­\n\n# worker å¹¶åæ°\nCELERY_CONCURRENCY = 2\n\n# æå®å¯¼å¥taskä»»å¡\nCELERY_IMPORTS = {\n'tasks.tasks'\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\ncelery app éç½®\n\nä»£ç : django_celery_demo/celery.py\n\nimport os\n\nimport django\nfrom celery import Celery, shared_task\nfrom celery.schedules import crontab\nfrom celery.signals import task_success\nfrom django.conf import settings\nfrom django.utils import timezone\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'django_celery_demo.settings')\ndjango.setup()\n\napp = Celery('django_celery_demo')\napp.config_from_object('django.conf:settings') # celery app å è½½ settingsä¸­çéç½®\n\napp.now = timezone.now # è®¾ç½®æ¶é´æ¶åºådjangoä¸æ ·\n\n# å è½½æ¯ä¸ªdjango appä¸çtasks.pyä¸­çtaskä»»å¡\napp.autodiscover_tasks(lambda: settings.INSTALLED_APPS)\n\n# è¿ä¸ªä¸ä¸ªtask\n@app.task(bind=True)\ndef debug_task(self):\n    print('Request: {0!r}'.format(self.request))\n    \n# å¼æ­¥æ§è¡è¿ä¸ªtask\ndebug_task.delay()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\nåå»ºdjceleryä¸­çè¡¨\n\nä¼èªå¨åå»ºdjceleryä¸­çè¡¨ãéé¢æä¿å­å®æ¶è®°å½ãç»æè®°å½ç­ç­è¡¨ã\n\n> python manage.py migrate\n\n\n# å¨viewä¸­å¼æ­¥æ§è¡task\n\nå¨appä¸­åå»º**add**task\n\nä»£ç : demo/tasks.py\n\nfrom celery import shared_task\n\n@shared_task(name=\"add\")\ndef add(a, b):\n    return int(a) + int(b)\n\n\n1\n2\n3\n4\n5\n\n\nåå»ºviewå»å¼æ­¥æ§è¡è¯¥task\n\nä»£ç : demo/views.py\n\nfrom django.http import HttpResponse\nfrom demo.tasks import add as add_task\n\ndef add(request):\n    a = request.GET[\"a\"]\n    b = request.GET[\"b\"]\n    add_task.delay(a, b)\n    \n    return HttpResponse(\"success\")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nurlä¸­éç½®view\n\nfrom demo.views import add\n\nurlpatterns = [\n    path('add', add),\n]\n\n\n1\n2\n3\n4\n5\n\n\nè¿è¡celery worker\n\n> celery -A django_celery_demo worker -l info\n\nè¿è¡é¡¹ç®\n\n> python manage.py runserver 0:8888\n\nè®¿é®æ¥å£\n\nhttp://127.0.0.1:8888/add?a=1&b=2\n\nç»æ: è¿åsuccessï¼å¨workerä¸­å¯ä»¥çå°addä»»å¡è¢«è°ç¨ï¼å¹¶ä¸ç»ææ¯3\n\n\n\n\n# æ¡ä¾2\n\nå®æ¶è°ç¨å¼æ­¥ä»»å¡\n\n\n# å®æ¶ä»»å¡ç®ä»\n\næä¸¤ç§å®æ¶ä»»å¡æ¹å¼ï¼è¿éä½¿ç¨çæ¯å¸¸è§çcrontabï¼ä¸linuxä¸æ¯ä¸æ ·ï¼æ¹ä¾¿å¾å¤ã\n\n\n# éç½®\n\néç½®åæ¡ä¾1ä¸­ä¸æ ·ã\n\n\n# å®æ¶ä»»å¡\n\nç¡¬ç¼ç ä¸­åå»ºå®æ¶ä»»å¡\n\næ¯åéè°ç¨ä¸æ¬¡add task\n\nä»£ç : django_celery_demo/celery.py\n\n# è¿ä¸ªæ¯ç¡¬ç¼ç çå®æ¶ä»»å¡\napp.conf.beat_schedule = {\n    'aa': {\n        'task': 'add',\n        'schedule': crontab(minute=\"*/1\"),\n        'args': (2, 4)\n    },\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¼å¯celery beat\n\n> celery beat -A django_celery_demo -l info\n\nè¿ä¸ªæå¡ä¼å°æ°æ®åºä¸­çå®æ¶ä»»å¡ä¸¢å°broker ä¸­\n\n\n# æ¡ä¾ä¸-è·¯ç±\n\nå°ä¸åçä»»å¡æ¾å°ä¸åçéåä¸­ï¼æ¾å°ä¸åçworkerä¸­ã\n\nå¾: æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶\n\ndefault = Exchange('default', type=\"direct\")\nfrequent = Exchange('frequent', type=\"direct\")\n\nCELERY_QUEUES = {\n    Queue('default', default, routing_key=\"default\"),\n    Queue('frequent', frequent, routing_key=\"frequent\")\n}\n\napp.conf.task_default_queue = 'default'\n\ntask_routes = {\n    'apps.periodic.tasks.oozie_workflow_task': {'queue': 'default'},\n    'apps.periodic.tasks.oozie_workflow_status': {'queue': 'custom'}\n}\n\napp.conf.beat_schedule = {\n\n    # æ¯åéæ£æ¥oozieè¿è¡ä¸­çä»»å¡ç¶æ\n    'oozie_workflow_status': {\n        'task': 'oozie_workflow_status',\n        'schedule': crontab(),\n        'args': (2, 1)\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\n\n# ç®¡çworker è¿ç¨\n\nä½¿ç¨supervisoræ¥ç®¡çworkerè¿ç¨ã\n\n\n# åºæ¬æä½\n\nå®è£\n\n> pip install supervisor\n\nçæé»è®¤éç½®æä»¶\n\n> echo_supervisord_conf > /etc/supervisor/supervisord.conf\n\n\n# å½ä»¤\n\nsupervisorctl\n\nå½ä»¤          æè¿°\nstatus      \nreread      è¯»åéç½®æä»¶\nupdate      å è½½ææ°çè¿ç¨\nstop è¿ç¨å    \nstart è¿ç¨å   \nreload      éæ°å è½½éç½®\n\n\n# éåceleryä½¿ç¨\n\nå¨supervisord.confä¸­æ·»å ä¸é¢çéç½®ã\n\n[include]\n; files = relative/directory/*.ini\nfiles = /home/jim/conf/supervisor/supervisord.conf.d/*.conf\n\n\n1\n2\n3\n\n\nåå»ºéç½®æä»¶/home/jim/conf/supervisor/supervisord.conf.d/celeryd_worker.confï¼æ·»å ä¸é¢éç½®\n\n[program:celeryworker]\ncommand=celery -A datahub_poster worker -l info\ndirectory=/home/hadoop/jim/projs/datahub_poster\nstdout_logfile=/yun/jim/log/supervisor/celeryworker.log\n;stderr_logfile=/yun/jim/log/supervisor/celeryworker_err.log\nredirect_stderr=true\nautorestart=true\nautostart=true\nnumprocs=1\nstartsecs=10\nstopwaitsecs = 600\npriority=15\n\n[program:celerybeat]\ncommand=celery -A datahub_poster beat -l info\ndirectory=/home/hadoop/jim/projs/datahub_poster\nstdout_logfile=/yun/jim/log/supervisor/celerybeat.log\n;stderr_logfile=/yun/jim/log/supervisor/celerybeat_err.log\nredirect_stderr=true\nautorestart=true\nautostart=true\nnumprocs=1\nstartsecs=10\nstopwaitsecs = 600\npriority=15\n\n[program:celery_flower]\ncommand=celery -A datahub_poster flower --port=5555\ndirectory=/home/hadoop/jim/projs/datahub_poster\nstdout_logfile=/yun/jim/log/supervisor/celery_flower.log\n;stderr_logfile=/yun/jim/log/supervisor/celery_flower_err.log\nredirect_stderr=true\nautorestart=true\nautostart=true\nnumprocs=1\nstartsecs=10\nstopwaitsecs = 600\npriority=15\n\n[inet_http_server]\nport=127.0.0.1:9001\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n\n\nä½¿ç¨éç½®æä»¶å¯å¨supervisor\n\n> supervisord -c /etc/supervisor/supervisord.conf\n\n\n# é®é¢\n\n 1. å¨supervisorctl statusæ¶ï¼åºç°http://localhost:9001 refused connectionéè¯¯ã\n\nè§£å³åæ³ï¼\n\nå¨éç½®æä»¶supervisord.confä¸­æ·»å \n\n[inet_http_server]\nport=127.0.0.1:9001\n\n\n1\n2\n\n\nç¶ååupdateæreloadä»¥ä¸ã\n\n\n# ä½¿ç¨flowerçæ§celery\n\nå¯ä»¥éè¿flowerçæ§celeryä¸­çworkerãtaskç­ç­ã\n\nå®è£flower\n\n> pip install flower\n\nè¿è¡\n\n> celery flower --broker=redis://localhost:6379/0\n\n\n# æä¹å\n\né®é¢: æ¯æ¬¡éå¯flowerä¹ååç°ï¼ä»¥åçtaskè¿è¡è®°å½æ¸ç©ºã\n\nè§£å³: å¯å¨floweræ¶æ·»å  --persistent=Trueï¼å¯ä»¥æä¹åtask\n\n\n# æ¶åºé®é¢\n\nflowerä¼è¯»åceleryçæ¶åºéç½®ï¼å¨é¡¹ç®ä¸­éç½®ä¸é¢åæ°å³å¯ã\n\nTIME_ZONE = 'Asia/Shanghai'\nCELERY_TIMEZONE = TIME_ZONE\n\n\n1\n2\n",normalizedContent:"# ç®ä»\n\næ¬æä¸»è¦ä»ç»djangoåceleryç»åä½¿ç¨çæ¡ä¾ã\n\ncelery æ¯ä¸ä¸ªå¼æ­¥ä»»å¡çè°åº¦å·¥å·ï¼å¯ä»¥å®æä¸äºå¼æ­¥ä»»å¡åå®æ¶ä»»å¡ã\n\næ¬æä½¿ç¨djceleryæ¥å®ædjangoåceleryçç»åä½¿ç¨ã\n\nè¯¥æ¡ä¾å¨githubä¸­django_celery_demo\n\n\n# æµç¨\n\nä»»å¡åå¸è(producer)å°ä»»å¡ä¸¢å°æ¶æ¯éå(broker)ä¸­ï¼ä»»å¡æ¶è´¹è(worker)ä»æ¶æ¯ä»£çä¸­è·åä»»å¡æ§è¡ï¼ç¶åå°ä¿å­å­å¨ç»æ(backend)ã\n\n\n\n\n# æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶\n\n\n\n\n# celery-beat\n\ncelery æä¸ªå®æ¶åè½ï¼éè¿å®æ¶å»å°taskä¸¢å°brokerä¸­ï¼ç¶åworkerå»æ§è¡ä»»å¡ãä½æ¯æä¸ªç¡®å®æ¯ï¼è¯¥å®æ¶ä»»å¡å¿é¡»ç¡¬ç¼åå°ä»£ç ä¸­ï¼ä¸å¯å¨ç¨åºè¿è¡ä¸­å¨æå¢å ä»»å¡ãä½¿ç¨djceleryå¯ä»¥å°å®æ¶ä»»å¡åå¥å°æ°æ®åºä¸­ï¼ç¶åéè¿æä½æ°æ®åºæä½å®æ¶ä»»å¡ã\n\n\n# æ¡ä¾1\n\nè®¿é®æ¥å£ï¼å¼æ­¥è°ç¨ç¨åºä¸­task\n\n\n# éç½®celery\n\nå®è£**djcelery**\n\n> pip install django_celery\n\nå¨settingsä¸­è®¾ç½®celeryéç½®\n\nä»£ç : django_celery_demo/settings.py\n\nimport djcelery\ndjcelery.setup_loader() # å è½½djcelery\n\n\n# åè®¸çæ ¼å¼\ncelery_accept_content = ['pickle', 'json', 'yaml']\n\nbroker_url = 'redis://localhost:6379/1' # redisä½ä¸ºä¸­é´ä»¶\nbroker_transport = 'redis'\n\ncelerybeat_scheduler = 'djcelery.schedulers.databasescheduler' # å®æ¶ä»»å¡ä½¿ç¨æ°æ®åºæ¥æä½\ncelery_result_backend = 'djcelery.backends.database:databasebackend'  # ç»æå­å¨å°æ°æ®åºä¸­\n\n# worker å¹¶åæ°\ncelery_concurrency = 2\n\n# æå®å¯¼å¥taskä»»å¡\ncelery_imports = {\n'tasks.tasks'\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\ncelery app éç½®\n\nä»£ç : django_celery_demo/celery.py\n\nimport os\n\nimport django\nfrom celery import celery, shared_task\nfrom celery.schedules import crontab\nfrom celery.signals import task_success\nfrom django.conf import settings\nfrom django.utils import timezone\n\nos.environ.setdefault('django_settings_module', 'django_celery_demo.settings')\ndjango.setup()\n\napp = celery('django_celery_demo')\napp.config_from_object('django.conf:settings') # celery app å è½½ settingsä¸­çéç½®\n\napp.now = timezone.now # è®¾ç½®æ¶é´æ¶åºådjangoä¸æ ·\n\n# å è½½æ¯ä¸ªdjango appä¸çtasks.pyä¸­çtaskä»»å¡\napp.autodiscover_tasks(lambda: settings.installed_apps)\n\n# è¿ä¸ªä¸ä¸ªtask\n@app.task(bind=true)\ndef debug_task(self):\n    print('request: {0!r}'.format(self.request))\n    \n# å¼æ­¥æ§è¡è¿ä¸ªtask\ndebug_task.delay()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\nåå»ºdjceleryä¸­çè¡¨\n\nä¼èªå¨åå»ºdjceleryä¸­çè¡¨ãéé¢æä¿å­å®æ¶è®°å½ãç»æè®°å½ç­ç­è¡¨ã\n\n> python manage.py migrate\n\n\n# å¨viewä¸­å¼æ­¥æ§è¡task\n\nå¨appä¸­åå»º**add**task\n\nä»£ç : demo/tasks.py\n\nfrom celery import shared_task\n\n@shared_task(name=\"add\")\ndef add(a, b):\n    return int(a) + int(b)\n\n\n1\n2\n3\n4\n5\n\n\nåå»ºviewå»å¼æ­¥æ§è¡è¯¥task\n\nä»£ç : demo/views.py\n\nfrom django.http import httpresponse\nfrom demo.tasks import add as add_task\n\ndef add(request):\n    a = request.get[\"a\"]\n    b = request.get[\"b\"]\n    add_task.delay(a, b)\n    \n    return httpresponse(\"success\")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nurlä¸­éç½®view\n\nfrom demo.views import add\n\nurlpatterns = [\n    path('add', add),\n]\n\n\n1\n2\n3\n4\n5\n\n\nè¿è¡celery worker\n\n> celery -a django_celery_demo worker -l info\n\nè¿è¡é¡¹ç®\n\n> python manage.py runserver 0:8888\n\nè®¿é®æ¥å£\n\nhttp://127.0.0.1:8888/add?a=1&b=2\n\nç»æ: è¿åsuccessï¼å¨workerä¸­å¯ä»¥çå°addä»»å¡è¢«è°ç¨ï¼å¹¶ä¸ç»ææ¯3\n\n\n\n\n# æ¡ä¾2\n\nå®æ¶è°ç¨å¼æ­¥ä»»å¡\n\n\n# å®æ¶ä»»å¡ç®ä»\n\næä¸¤ç§å®æ¶ä»»å¡æ¹å¼ï¼è¿éä½¿ç¨çæ¯å¸¸è§çcrontabï¼ä¸linuxä¸æ¯ä¸æ ·ï¼æ¹ä¾¿å¾å¤ã\n\n\n# éç½®\n\néç½®åæ¡ä¾1ä¸­ä¸æ ·ã\n\n\n# å®æ¶ä»»å¡\n\nç¡¬ç¼ç ä¸­åå»ºå®æ¶ä»»å¡\n\næ¯åéè°ç¨ä¸æ¬¡add task\n\nä»£ç : django_celery_demo/celery.py\n\n# è¿ä¸ªæ¯ç¡¬ç¼ç çå®æ¶ä»»å¡\napp.conf.beat_schedule = {\n    'aa': {\n        'task': 'add',\n        'schedule': crontab(minute=\"*/1\"),\n        'args': (2, 4)\n    },\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nå¼å¯celery beat\n\n> celery beat -a django_celery_demo -l info\n\nè¿ä¸ªæå¡ä¼å°æ°æ®åºä¸­çå®æ¶ä»»å¡ä¸¢å°broker ä¸­\n\n\n# æ¡ä¾ä¸-è·¯ç±\n\nå°ä¸åçä»»å¡æ¾å°ä¸åçéåä¸­ï¼æ¾å°ä¸åçworkerä¸­ã\n\nå¾: æ¶æ¯ååä¸ä»»å¡è°åº¦çå®ç°æºå¶\n\ndefault = exchange('default', type=\"direct\")\nfrequent = exchange('frequent', type=\"direct\")\n\ncelery_queues = {\n    queue('default', default, routing_key=\"default\"),\n    queue('frequent', frequent, routing_key=\"frequent\")\n}\n\napp.conf.task_default_queue = 'default'\n\ntask_routes = {\n    'apps.periodic.tasks.oozie_workflow_task': {'queue': 'default'},\n    'apps.periodic.tasks.oozie_workflow_status': {'queue': 'custom'}\n}\n\napp.conf.beat_schedule = {\n\n    # æ¯åéæ£æ¥oozieè¿è¡ä¸­çä»»å¡ç¶æ\n    'oozie_workflow_status': {\n        'task': 'oozie_workflow_status',\n        'schedule': crontab(),\n        'args': (2, 1)\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\n\n# ç®¡çworker è¿ç¨\n\nä½¿ç¨supervisoræ¥ç®¡çworkerè¿ç¨ã\n\n\n# åºæ¬æä½\n\nå®è£\n\n> pip install supervisor\n\nçæé»è®¤éç½®æä»¶\n\n> echo_supervisord_conf > /etc/supervisor/supervisord.conf\n\n\n# å½ä»¤\n\nsupervisorctl\n\nå½ä»¤          æè¿°\nstatus      \nreread      è¯»åéç½®æä»¶\nupdate      å è½½ææ°çè¿ç¨\nstop è¿ç¨å    \nstart è¿ç¨å   \nreload      éæ°å è½½éç½®\n\n\n# éåceleryä½¿ç¨\n\nå¨supervisord.confä¸­æ·»å ä¸é¢çéç½®ã\n\n[include]\n; files = relative/directory/*.ini\nfiles = /home/jim/conf/supervisor/supervisord.conf.d/*.conf\n\n\n1\n2\n3\n\n\nåå»ºéç½®æä»¶/home/jim/conf/supervisor/supervisord.conf.d/celeryd_worker.confï¼æ·»å ä¸é¢éç½®\n\n[program:celeryworker]\ncommand=celery -a datahub_poster worker -l info\ndirectory=/home/hadoop/jim/projs/datahub_poster\nstdout_logfile=/yun/jim/log/supervisor/celeryworker.log\n;stderr_logfile=/yun/jim/log/supervisor/celeryworker_err.log\nredirect_stderr=true\nautorestart=true\nautostart=true\nnumprocs=1\nstartsecs=10\nstopwaitsecs = 600\npriority=15\n\n[program:celerybeat]\ncommand=celery -a datahub_poster beat -l info\ndirectory=/home/hadoop/jim/projs/datahub_poster\nstdout_logfile=/yun/jim/log/supervisor/celerybeat.log\n;stderr_logfile=/yun/jim/log/supervisor/celerybeat_err.log\nredirect_stderr=true\nautorestart=true\nautostart=true\nnumprocs=1\nstartsecs=10\nstopwaitsecs = 600\npriority=15\n\n[program:celery_flower]\ncommand=celery -a datahub_poster flower --port=5555\ndirectory=/home/hadoop/jim/projs/datahub_poster\nstdout_logfile=/yun/jim/log/supervisor/celery_flower.log\n;stderr_logfile=/yun/jim/log/supervisor/celery_flower_err.log\nredirect_stderr=true\nautorestart=true\nautostart=true\nnumprocs=1\nstartsecs=10\nstopwaitsecs = 600\npriority=15\n\n[inet_http_server]\nport=127.0.0.1:9001\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n\n\nä½¿ç¨éç½®æä»¶å¯å¨supervisor\n\n> supervisord -c /etc/supervisor/supervisord.conf\n\n\n# é®é¢\n\n 1. å¨supervisorctl statusæ¶ï¼åºç°http://localhost:9001 refused connectionéè¯¯ã\n\nè§£å³åæ³ï¼\n\nå¨éç½®æä»¶supervisord.confä¸­æ·»å \n\n[inet_http_server]\nport=127.0.0.1:9001\n\n\n1\n2\n\n\nç¶ååupdateæreloadä»¥ä¸ã\n\n\n# ä½¿ç¨flowerçæ§celery\n\nå¯ä»¥éè¿flowerçæ§celeryä¸­çworkerãtaskç­ç­ã\n\nå®è£flower\n\n> pip install flower\n\nè¿è¡\n\n> celery flower --broker=redis://localhost:6379/0\n\n\n# æä¹å\n\né®é¢: æ¯æ¬¡éå¯flowerä¹ååç°ï¼ä»¥åçtaskè¿è¡è®°å½æ¸ç©ºã\n\nè§£å³: å¯å¨floweræ¶æ·»å  --persistent=trueï¼å¯ä»¥æä¹åtask\n\n\n# æ¶åºé®é¢\n\nflowerä¼è¯»åceleryçæ¶åºéç½®ï¼å¨é¡¹ç®ä¸­éç½®ä¸é¢åæ°å³å¯ã\n\ntime_zone = 'asia/shanghai'\ncelery_timezone = time_zone\n\n\n1\n2\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"djangoåç¼©æä»¶ä¸è½½",frontmatter:{title:"djangoåç¼©æä»¶ä¸è½½",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/f2738b/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»å¨djangoä¸­ï¼å¦ä½å°æ°æ®çæzipæä»¶æä¾ç»ç¨æ·è¿è¡ä¸è½½",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"djangoåç¼©æä»¶ä¸è½½"},{name:"twitter:description",content:"ä»ç»å¨djangoä¸­ï¼å¦ä½å°æ°æ®çæzipæä»¶æä¾ç»ç¨æ·è¿è¡ä¸è½½"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/06.django%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD.html"},{property:"og:type",content:"article"},{property:"og:title",content:"djangoåç¼©æä»¶ä¸è½½"},{property:"og:description",content:"ä»ç»å¨djangoä¸­ï¼å¦ä½å°æ°æ®çæzipæä»¶æä¾ç»ç¨æ·è¿è¡ä¸è½½"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/06.django%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"djangoåç¼©æä»¶ä¸è½½"},{itemprop:"description",content:"ä»ç»å¨djangoä¸­ï¼å¦ä½å°æ°æ®çæzipæä»¶æä¾ç»ç¨æ·è¿è¡ä¸è½½"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/06.django%E5%8E%8B%E7%BC%A9%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD.html",relativePath:"04.ç¼ç¨/01.python/06.django/06.djangoåç¼©æä»¶ä¸è½½.md",key:"v-628321a6",path:"/pages/f2738b/",headersStr:null,content:'# ç®ä»\n\néæ±: éè¦å¨è¯·æ±æ¶ï¼å°æ°æ®çæzipæä»¶æä¾ç»ç¨æ·ä¸è½½ã\n\nä¸æ³è¦å¨çæååæä¾ç»ç¨æ·ä¸è½½\n\nè§£å³: ä½¿ç¨BytesIOå¨åå­ä¸­åå¥æ°æ®ï¼èä¸æ¯è½å°å°æ¬å°ä¸­ã\n\n\n# æ å­\n\n\nfrom io import BytesIO\nimport zipfile\nfrom django.http import FileResponse\n\ndef view():\n\n    download_io = BytesIO()\n\n    with zipfile.ZipFile(pb_zip_io, "w", zipfile.ZIP_DEFLATED) as zip_fp:\n        zip_fp.open("a.txt", "w") as f:\n            f.write("hello world")\n\n\n    # æ³¨æï¼éè¦è¦å°æéæååå­çå¼å§ä½ç½®\n    download_io.seek(0)\n\n    return FileResponse(download_io, as_attachment=True, filename="a.zip")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n',normalizedContent:'# ç®ä»\n\néæ±: éè¦å¨è¯·æ±æ¶ï¼å°æ°æ®çæzipæä»¶æä¾ç»ç¨æ·ä¸è½½ã\n\nä¸æ³è¦å¨çæååæä¾ç»ç¨æ·ä¸è½½\n\nè§£å³: ä½¿ç¨bytesioå¨åå­ä¸­åå¥æ°æ®ï¼èä¸æ¯è½å°å°æ¬å°ä¸­ã\n\n\n# æ å­\n\n\nfrom io import bytesio\nimport zipfile\nfrom django.http import fileresponse\n\ndef view():\n\n    download_io = bytesio()\n\n    with zipfile.zipfile(pb_zip_io, "w", zipfile.zip_deflated) as zip_fp:\n        zip_fp.open("a.txt", "w") as f:\n            f.write("hello world")\n\n\n    # æ³¨æï¼éè¦è¦å°æéæååå­çå¼å§ä½ç½®\n    download_io.seek(0)\n\n    return fileresponse(download_io, as_attachment=true, filename="a.zip")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django rest_frameworkä½¿ç¨pytestååæµè¯",frontmatter:{title:"django rest_frameworkä½¿ç¨pytestååæµè¯",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/c28126/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»å¨djangoçrest_frameworkä¸­å¦ä½ä½¿ç¨pytestè¿è¡ååæµè¯èä¸æ¯èªå¸¦çæµè¯æ¡æ¶ã",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django rest_frameworkä½¿ç¨pytestååæµè¯"},{name:"twitter:description",content:"ä»ç»å¨djangoçrest_frameworkä¸­å¦ä½ä½¿ç¨pytestè¿è¡ååæµè¯èä¸æ¯èªå¸¦çæµè¯æ¡æ¶ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/07.django%20rest_framework%E4%BD%BF%E7%94%A8pytest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django rest_frameworkä½¿ç¨pytestååæµè¯"},{property:"og:description",content:"ä»ç»å¨djangoçrest_frameworkä¸­å¦ä½ä½¿ç¨pytestè¿è¡ååæµè¯èä¸æ¯èªå¸¦çæµè¯æ¡æ¶ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/07.django%20rest_framework%E4%BD%BF%E7%94%A8pytest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django rest_frameworkä½¿ç¨pytestååæµè¯"},{itemprop:"description",content:"ä»ç»å¨djangoçrest_frameworkä¸­å¦ä½ä½¿ç¨pytestè¿è¡ååæµè¯èä¸æ¯èªå¸¦çæµè¯æ¡æ¶ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/07.django%20rest_framework%E4%BD%BF%E7%94%A8pytest%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95.html",relativePath:"04.ç¼ç¨/01.python/06.django/07.django rest_frameworkä½¿ç¨pytestååæµè¯.md",key:"v-77d8c9f4",path:"/pages/c28126/",headers:[{level:2,title:"djangèªå¸¦æµè¯",slug:"djangèªå¸¦æµè¯",normalizedTitle:"djangèªå¸¦æµè¯",charIndex:2},{level:2,title:"rest framework",slug:"rest-framework",normalizedTitle:"rest framework",charIndex:665}],headersStr:"djangèªå¸¦æµè¯ rest framework",content:'# djangèªå¸¦æµè¯\n\n> djangoæ¬èº«èªå¸¦äºæµè¯æ¡æ¶åºï¼æ¯åºäºunittestçã\n\næ§è¡ python manager.py test ä¼å¯¹è·¯å¾æætest*.py è¿è¡æµè¯\n\nfrom django.test import TestCase\nfrom event_track.models.app import Appclass \n\nAppTestCase(TestCase):    \n    def setUp(self):        \n        App.objects.create(name="app1", package_name="package1")        \n        App.objects.create(name="app2", package_name="package2")    \n    def test_app(self):        \n        app1 = App.objects.get(name="app1")        \n        self.assertEqual(app1.package_name, "package1")        \n        app1 = App.objects.get(name="app2")        \n        self.assertEqual(app1.package_name, "package3")\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# rest framework\n\n> ä¸é¢æ¯ä¸ä¸ªç®åçæµè¯æ¡ä¾ãä½¿ç¨pytestå¯¹rest frameworkè¿è¡æµè¯\n\n1. æ·»å ä¸ä¸ªéç½®æä»¶ å·ä½çpytest-djangoå®ç½\n\n[pytest]\nDJANGO_SETTINGS_MODULE=event_track_root.settings\npython_files = tests.py test_*.py *_tests.py\n\n\n1\n2\n3\n\n\n2. åå»ºä¸ä¸ªmodel app.py\n\nfrom django.db import models\nclass App(models.Model):    \n    name = models.CharField(max_length=24)    \n    package_name = models.CharField(max_length=50, unique=True)\n\n\n1\n2\n3\n4\n\n\n> å¯¹appçmodelç±»è¿è¡å¢å æ¹æ¥çæµè¯ modelæµè¯å¿é¡»æ·»å @pytest.mark.django_dbæå¯ä»¥å¯ç¨æ°æ®åºã ä½¿ç¨APITestCaseå¯¹æ¥å£è¿è¡æµè¯\n\n3. ç¼åæµè¯ç¨ä¾ test_app.py\n\n\n@pytest.mark.django_db\n@pytest.fixture(scope="module")\ndef init_app_data():\n    App.objects.create(name="app1", package_name="package1")\n    App.objects.create(name="app2", package_name="package2")\n    App.objects.create(name="app3", package_name="package3")\n    App.objects.create(name="app4", package_name="package4")\n\nclass AppTests(APITestCase):\n\n    def test_create_app(self):\n        url = reverse(\'event_track:App-list\')\n        data_list = [{"name": "app1", "package_name": "package1"},\n                     {"name": "app2", "package_name": "package2"},\n                     {"name": "app3", "package_name": "package3"},\n                     {"name": "app4", "package_name": "package4"}\n                     ]\n\n        for data in data_list:\n            response = self.client.post(url, data)\n            self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n\n        self.assertEqual(App.objects.count(), 4)\n        self.assertEqual(App.objects.get(name="app1").package_name, "package1")\n\n    @pytest.mark.usefixtures(\'init_app_data\')\n    def test_delete_app(self):\n        app = App.objects.get(package_name="package3")\n        url = reverse(\'event_track:App-detail\', [app.id])\n        response = self.client.delete(url)\n\n        self.assertEqual(App.objects.count(), 3)\n        with pytest.raises(App.DoesNotExist):\n            App.objects.get(package_name="package3")\n        self.assertEqual(response.status_code, 204)\n\n    @pytest.mark.usefixtures(\'init_app_data\')\n    def test_update_app(self):\n        app = App.objects.get(name="app4")\n        url = reverse(\'event_track:App-detail\', [app.id])\n\n        app.package_name = "package_update"\n        response = self.client.put(url, AppSerializer(app).data)\n\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(response.data[\'package_name\'], \'package_update\')\n        self.assertEqual(App.objects.get(name="app4").package_name, \'package_update\')\n\n    @pytest.mark.usefixtures(\'init_app_data\')\n    def test_list_app(self):\n        url = reverse(\'event_track:App-list\')\n        response = self.client.get(url, {\'limit\': 2, \'offset\': 2})\n\n        self.assertEqual(response.status_code, 200)\n        self.assertEqual(len(response.data[\'results\']), 2)\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n',normalizedContent:'# djangèªå¸¦æµè¯\n\n> djangoæ¬èº«èªå¸¦äºæµè¯æ¡æ¶åºï¼æ¯åºäºunittestçã\n\næ§è¡ python manager.py test ä¼å¯¹è·¯å¾æætest*.py è¿è¡æµè¯\n\nfrom django.test import testcase\nfrom event_track.models.app import appclass \n\napptestcase(testcase):    \n    def setup(self):        \n        app.objects.create(name="app1", package_name="package1")        \n        app.objects.create(name="app2", package_name="package2")    \n    def test_app(self):        \n        app1 = app.objects.get(name="app1")        \n        self.assertequal(app1.package_name, "package1")        \n        app1 = app.objects.get(name="app2")        \n        self.assertequal(app1.package_name, "package3")\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# rest framework\n\n> ä¸é¢æ¯ä¸ä¸ªç®åçæµè¯æ¡ä¾ãä½¿ç¨pytestå¯¹rest frameworkè¿è¡æµè¯\n\n1. æ·»å ä¸ä¸ªéç½®æä»¶ å·ä½çpytest-djangoå®ç½\n\n[pytest]\ndjango_settings_module=event_track_root.settings\npython_files = tests.py test_*.py *_tests.py\n\n\n1\n2\n3\n\n\n2. åå»ºä¸ä¸ªmodel app.py\n\nfrom django.db import models\nclass app(models.model):    \n    name = models.charfield(max_length=24)    \n    package_name = models.charfield(max_length=50, unique=true)\n\n\n1\n2\n3\n4\n\n\n> å¯¹appçmodelç±»è¿è¡å¢å æ¹æ¥çæµè¯ modelæµè¯å¿é¡»æ·»å @pytest.mark.django_dbæå¯ä»¥å¯ç¨æ°æ®åºã ä½¿ç¨apitestcaseå¯¹æ¥å£è¿è¡æµè¯\n\n3. ç¼åæµè¯ç¨ä¾ test_app.py\n\n\n@pytest.mark.django_db\n@pytest.fixture(scope="module")\ndef init_app_data():\n    app.objects.create(name="app1", package_name="package1")\n    app.objects.create(name="app2", package_name="package2")\n    app.objects.create(name="app3", package_name="package3")\n    app.objects.create(name="app4", package_name="package4")\n\nclass apptests(apitestcase):\n\n    def test_create_app(self):\n        url = reverse(\'event_track:app-list\')\n        data_list = [{"name": "app1", "package_name": "package1"},\n                     {"name": "app2", "package_name": "package2"},\n                     {"name": "app3", "package_name": "package3"},\n                     {"name": "app4", "package_name": "package4"}\n                     ]\n\n        for data in data_list:\n            response = self.client.post(url, data)\n            self.assertequal(response.status_code, status.http_201_created)\n\n        self.assertequal(app.objects.count(), 4)\n        self.assertequal(app.objects.get(name="app1").package_name, "package1")\n\n    @pytest.mark.usefixtures(\'init_app_data\')\n    def test_delete_app(self):\n        app = app.objects.get(package_name="package3")\n        url = reverse(\'event_track:app-detail\', [app.id])\n        response = self.client.delete(url)\n\n        self.assertequal(app.objects.count(), 3)\n        with pytest.raises(app.doesnotexist):\n            app.objects.get(package_name="package3")\n        self.assertequal(response.status_code, 204)\n\n    @pytest.mark.usefixtures(\'init_app_data\')\n    def test_update_app(self):\n        app = app.objects.get(name="app4")\n        url = reverse(\'event_track:app-detail\', [app.id])\n\n        app.package_name = "package_update"\n        response = self.client.put(url, appserializer(app).data)\n\n        self.assertequal(response.status_code, 200)\n        self.assertequal(response.data[\'package_name\'], \'package_update\')\n        self.assertequal(app.objects.get(name="app4").package_name, \'package_update\')\n\n    @pytest.mark.usefixtures(\'init_app_data\')\n    def test_list_app(self):\n        url = reverse(\'event_track:app-list\')\n        response = self.client.get(url, {\'limit\': 2, \'offset\': 2})\n\n        self.assertequal(response.status_code, 200)\n        self.assertequal(len(response.data[\'results\']), 2)\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django rest_framework èªå®ä¹ææ¡£",frontmatter:{title:"django rest_framework èªå®ä¹ææ¡£",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/c3af6a/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"django rest_framework èªå¨çæææ¡£çåè½ï¼è½å¤å¾å¥½çç»åç«¯æä¾å¸®å©ï¼å¨ææ¡£ä¸­å¯ä»¥çå°apiçåæ°åå¶æä¾çåè½ä¿¡æ¯ï¼å¹¶ä¸è¿è½å¤å¨ä¸é¢ç´æ¥æµè¯apiæ¥å£ã",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django rest_framework èªå®ä¹ææ¡£"},{name:"twitter:description",content:"django rest_framework èªå¨çæææ¡£çåè½ï¼è½å¤å¾å¥½çç»åç«¯æä¾å¸®å©ï¼å¨ææ¡£ä¸­å¯ä»¥çå°apiçåæ°åå¶æä¾çåè½ä¿¡æ¯ï¼å¹¶ä¸è¿è½å¤å¨ä¸é¢ç´æ¥æµè¯apiæ¥å£ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/05.django%20rest_framework%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%A1%A3.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django rest_framework èªå®ä¹ææ¡£"},{property:"og:description",content:"django rest_framework èªå¨çæææ¡£çåè½ï¼è½å¤å¾å¥½çç»åç«¯æä¾å¸®å©ï¼å¨ææ¡£ä¸­å¯ä»¥çå°apiçåæ°åå¶æä¾çåè½ä¿¡æ¯ï¼å¹¶ä¸è¿è½å¤å¨ä¸é¢ç´æ¥æµè¯apiæ¥å£ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/05.django%20rest_framework%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%A1%A3.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django rest_framework èªå®ä¹ææ¡£"},{itemprop:"description",content:"django rest_framework èªå¨çæææ¡£çåè½ï¼è½å¤å¾å¥½çç»åç«¯æä¾å¸®å©ï¼å¨ææ¡£ä¸­å¯ä»¥çå°apiçåæ°åå¶æä¾çåè½ä¿¡æ¯ï¼å¹¶ä¸è¿è½å¤å¨ä¸é¢ç´æ¥æµè¯apiæ¥å£ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/05.django%20rest_framework%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%A1%A3.html",relativePath:"04.ç¼ç¨/01.python/06.django/05.django rest_framework èªå®ä¹ææ¡£.md",key:"v-226be104",path:"/pages/c3af6a/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"éç½®",slug:"éç½®",normalizedTitle:"éç½®",charIndex:102},{level:2,title:"èªå®ä¹ææ¡£",slug:"èªå®ä¹ææ¡£",normalizedTitle:"èªå®ä¹ææ¡£",charIndex:293},{level:2,title:"schema",slug:"schema",normalizedTitle:"schema",charIndex:335},{level:3,title:"æ¹æ³ä¸",slug:"æ¹æ³ä¸",normalizedTitle:"æ¹æ³ä¸",charIndex:371},{level:3,title:"æ¹æ³äº",slug:"æ¹æ³äº",normalizedTitle:"æ¹æ³äº",charIndex:3082},{level:2,title:"location",slug:"location",normalizedTitle:"location",charIndex:3219}],headersStr:"ç®ä» éç½® èªå®ä¹ææ¡£ schema æ¹æ³ä¸ æ¹æ³äº location",content:'# ç®ä»\n\ndjango rest_framework èªå¨çæææ¡£çåè½ï¼è½å¤å¾å¥½çç»åç«¯æä¾å¸®å©ï¼å¨ææ¡£ä¸­å¯ä»¥çå°apiçåæ°åå¶æä¾çåè½ä¿¡æ¯ï¼å¹¶ä¸è¿è½å¤å¨ä¸é¢ç´æ¥æµè¯apiæ¥å£ã\n\nå®ç½\n\n\n# éç½®\n\nurls.py\n\nfrom rest_framework.documentation import include_docs_urls\n\nurlpatterns = [\n    ...\n    url(r\'^docs/\', include_docs_urls(title=\'My API title\'))]\n\n\n1\n2\n3\n4\n5\n\n\nå³å¯ä½¿ç¨è¯¥urlå¯¹ææ¡£çè®¿é®\n\n\n# èªå®ä¹ææ¡£\n\nè½ç¶å¯ä»¥èªå¨çæææ¡£ï¼ä½æ¯ä¸æ¯å¾å®åï¼æä»¥éè¦èªå®ä¹åææ¡£ã\n\n\n# schema\n\néè¿æ¹åAutoSchemaæ¥å®æèªå®ä¹ææ¡£ã\n\n\n# æ¹æ³ä¸\n\nget_linkæ¯AutoSchemaä¸­çå½æ°. éåget_linkå½æ°ï¼å¯¹ææ¡£ä¸­çæ¯ä¸ªå­æ®µçè¯´æè¿è¡æ¹åã\n\néæAutoSchemaï¼å¨__init__åå§åparams_desc_dictåæ°ï¼è¯¥åæ°åå«ææ¡£ä¸­å­æ®µå¯¹åºçæ³¨éï¼ç¶åå¨get_linkå¯¹è¯¥åæ°è¿è¡è§£æï¼å¹¶æ¿æ¢å­æ®µæ³¨é.\n\nclass BaseSchema(AutoSchema):\n    """\n    èªå¨çæçææ¡£ä¼æç¼ºå¤±ï¼æèæ¯å ä¸ºå¯è¯»æ§æ¯è¾å·®ãæä»¥éè¦å¯¹ææ¡£ä¸­çå­æ®µè¿è¡èªå®ä¹æ³¨è§£ã\n    è¯¥ç±»æ¯éç¨çå¯¹ææ¡£ä¸­çgetãpostãputãdeleteãpatchè¿è¡æ³¨éã\n    æ¯å¨å·²æå­æ®µçåºç¡ä¸ä¿®æ¹æ³¨é.\n    \n    `get`æ¯å¯¹getä¸­çå­æ®µè¿è¡æ³¨è§£è¯´æã\n    `other`æ¯`post`ã`put`ã`delete`ã`patch`\n    \n    ä¾å­:\n        {\n            "get": {\n                "å­æ®µå": "å¯¹è¯¥å­æ®µè¿è¡æ³¨é"\n            },\n            "post": {\n                "å­æ®µå": "å¯¹è¯¥å­æ®µè¿è¡æ³¨é"\n            }\n        }\n\n    """\n    def __init__(self, manual_fields=None, params_desc_dict=None):\n        self.params_desc_dict = {\n            "get": {\n                "page": "å½åé¡µç ",\n                "page_size": "æ¯ä¸é¡µæ¾ç¤ºçè¡æ°. é»è®¤ä¼  10æ¡"\n            },\n            "other": {\n\n            }\n        }\n\n        if params_desc_dict:\n            if \'get\' in params_desc_dict:\n                self.params_desc_dict[\'get\'].update(params_desc_dict[\'get\'])\n\n            if \'other\' in params_desc_dict:\n                self.params_desc_dict[\'other\'].update(params_desc_dict[\'other\'])\n\n        super(BaseSchema, self).__init__(manual_fields)\n\n    def get_link(self, path, method, base_url):\n        link = super(BaseSchema, self).get_link(path, method, base_url)\n\n        fields = []\n\n        params_method = \'get\' if method.lower() == \'get\' else \'other\'\n\n        for field in link.fields:\n            if field.name in self.params_desc_dict[params_method].keys():\n                field = field._replace(\n                    schema=coreschema.String(description=self.params_desc_dict[params_method][field.name]))\n\n            fields.append(field)\n\n        return coreapi.Link(\n            url=link.url,\n            action=link.action,\n            encoding=link.encoding,\n            fields=fields,\n            description=link.description\n        )\n\nperiodictaskSchema = BaseSchema(params_desc_dict={\n    \'other\': {\n        "crontab": "å®æ¶crontab. jsonã åå«çå­æ®µæ: minute, hour, day_of_week, day_of_month, month_of_year",\n        "name": "è¯¥å®æ¶ä»»å¡åç§°",\n        "task": "æ¨¡æ¿ä»»å¡å",\n        "args": "ä¼ éç»ä»»å¡æ¨¡æ¿åæ°. æ°ç»",\n        "kwargs": "ä¼ éç»ä»»å¡æ¨¡æ¿åæ°. jsonå­ç¬¦ä¸²",\n        "queue": "å°ä»»å¡æ¾å¨åªä¸ªéåä¸­.",\n        "enabled": "æ¯å¦å¼å¯è¯¥ä»»å¡. True or False. é»è®¤ä¸ºTrue",\n        "description": "å®æ¶ä»»å¡è¯´æ"\n    }\n})\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n\n\nå¨viewä¸­ç»å®èªå®ä¹çschema\n\nclass PeriodictasksViewSet(viewsets.ModelViewSet):\n    queryset = PeriodicTask.objects.all()\n    serializer_class = PeriodictaskSerializer\n    schema = periodictaskSchema\n\n\n1\n2\n3\n4\n\n\n\n# æ¹æ³äº\n\nå¦æåªæ¯æ®éçAPIViewçè¯ï¼ç´æ¥å¨AutoSchemaä¸­æ·»å å­æ®µå³å¯ã\n\ndatabaseInfoSchema = AutoSchema(manual_fields=[\n    coreapi.Field(name="db", required=True, location="query",\n                  schema=coreschema.String(description="æ°æ®åºhost, normalæèsub")),\n    coreapi.Field(name="database", location="query", schema=coreschema.String(description="æ°æ®åº")),\n    coreapi.Field(name="table", required=True, location="query", schema=coreschema.String(description="æ°æ®åºè¡¨"))\n])\n\n\n1\n2\n3\n4\n5\n6\n\n\nç»å®èªå®ä¹schema\n\nclass DataBaseInfo(APIView):\n    schema = databaseInfoSchema\n\n    def get(self, request):\n        pass\n\n\n1\n2\n3\n4\n5\n\n\n\n# location\n\nLOCATION   æè¿°\nquery      æ¥è¯¢. list\nform       è¡¨åæäº¤. post\npath       å¨urlä¸­çï¼/oozieJob/{id}/. read',normalizedContent:'# ç®ä»\n\ndjango rest_framework èªå¨çæææ¡£çåè½ï¼è½å¤å¾å¥½çç»åç«¯æä¾å¸®å©ï¼å¨ææ¡£ä¸­å¯ä»¥çå°apiçåæ°åå¶æä¾çåè½ä¿¡æ¯ï¼å¹¶ä¸è¿è½å¤å¨ä¸é¢ç´æ¥æµè¯apiæ¥å£ã\n\nå®ç½\n\n\n# éç½®\n\nurls.py\n\nfrom rest_framework.documentation import include_docs_urls\n\nurlpatterns = [\n    ...\n    url(r\'^docs/\', include_docs_urls(title=\'my api title\'))]\n\n\n1\n2\n3\n4\n5\n\n\nå³å¯ä½¿ç¨è¯¥urlå¯¹ææ¡£çè®¿é®\n\n\n# èªå®ä¹ææ¡£\n\nè½ç¶å¯ä»¥èªå¨çæææ¡£ï¼ä½æ¯ä¸æ¯å¾å®åï¼æä»¥éè¦èªå®ä¹åææ¡£ã\n\n\n# schema\n\néè¿æ¹åautoschemaæ¥å®æèªå®ä¹ææ¡£ã\n\n\n# æ¹æ³ä¸\n\nget_linkæ¯autoschemaä¸­çå½æ°. éåget_linkå½æ°ï¼å¯¹ææ¡£ä¸­çæ¯ä¸ªå­æ®µçè¯´æè¿è¡æ¹åã\n\néæautoschemaï¼å¨__init__åå§åparams_desc_dictåæ°ï¼è¯¥åæ°åå«ææ¡£ä¸­å­æ®µå¯¹åºçæ³¨éï¼ç¶åå¨get_linkå¯¹è¯¥åæ°è¿è¡è§£æï¼å¹¶æ¿æ¢å­æ®µæ³¨é.\n\nclass baseschema(autoschema):\n    """\n    èªå¨çæçææ¡£ä¼æç¼ºå¤±ï¼æèæ¯å ä¸ºå¯è¯»æ§æ¯è¾å·®ãæä»¥éè¦å¯¹ææ¡£ä¸­çå­æ®µè¿è¡èªå®ä¹æ³¨è§£ã\n    è¯¥ç±»æ¯éç¨çå¯¹ææ¡£ä¸­çgetãpostãputãdeleteãpatchè¿è¡æ³¨éã\n    æ¯å¨å·²æå­æ®µçåºç¡ä¸ä¿®æ¹æ³¨é.\n    \n    `get`æ¯å¯¹getä¸­çå­æ®µè¿è¡æ³¨è§£è¯´æã\n    `other`æ¯`post`ã`put`ã`delete`ã`patch`\n    \n    ä¾å­:\n        {\n            "get": {\n                "å­æ®µå": "å¯¹è¯¥å­æ®µè¿è¡æ³¨é"\n            },\n            "post": {\n                "å­æ®µå": "å¯¹è¯¥å­æ®µè¿è¡æ³¨é"\n            }\n        }\n\n    """\n    def __init__(self, manual_fields=none, params_desc_dict=none):\n        self.params_desc_dict = {\n            "get": {\n                "page": "å½åé¡µç ",\n                "page_size": "æ¯ä¸é¡µæ¾ç¤ºçè¡æ°. é»è®¤ä¼  10æ¡"\n            },\n            "other": {\n\n            }\n        }\n\n        if params_desc_dict:\n            if \'get\' in params_desc_dict:\n                self.params_desc_dict[\'get\'].update(params_desc_dict[\'get\'])\n\n            if \'other\' in params_desc_dict:\n                self.params_desc_dict[\'other\'].update(params_desc_dict[\'other\'])\n\n        super(baseschema, self).__init__(manual_fields)\n\n    def get_link(self, path, method, base_url):\n        link = super(baseschema, self).get_link(path, method, base_url)\n\n        fields = []\n\n        params_method = \'get\' if method.lower() == \'get\' else \'other\'\n\n        for field in link.fields:\n            if field.name in self.params_desc_dict[params_method].keys():\n                field = field._replace(\n                    schema=coreschema.string(description=self.params_desc_dict[params_method][field.name]))\n\n            fields.append(field)\n\n        return coreapi.link(\n            url=link.url,\n            action=link.action,\n            encoding=link.encoding,\n            fields=fields,\n            description=link.description\n        )\n\nperiodictaskschema = baseschema(params_desc_dict={\n    \'other\': {\n        "crontab": "å®æ¶crontab. jsonã åå«çå­æ®µæ: minute, hour, day_of_week, day_of_month, month_of_year",\n        "name": "è¯¥å®æ¶ä»»å¡åç§°",\n        "task": "æ¨¡æ¿ä»»å¡å",\n        "args": "ä¼ éç»ä»»å¡æ¨¡æ¿åæ°. æ°ç»",\n        "kwargs": "ä¼ éç»ä»»å¡æ¨¡æ¿åæ°. jsonå­ç¬¦ä¸²",\n        "queue": "å°ä»»å¡æ¾å¨åªä¸ªéåä¸­.",\n        "enabled": "æ¯å¦å¼å¯è¯¥ä»»å¡. true or false. é»è®¤ä¸ºtrue",\n        "description": "å®æ¶ä»»å¡è¯´æ"\n    }\n})\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n74\n75\n\n\nå¨viewä¸­ç»å®èªå®ä¹çschema\n\nclass periodictasksviewset(viewsets.modelviewset):\n    queryset = periodictask.objects.all()\n    serializer_class = periodictaskserializer\n    schema = periodictaskschema\n\n\n1\n2\n3\n4\n\n\n\n# æ¹æ³äº\n\nå¦æåªæ¯æ®éçapiviewçè¯ï¼ç´æ¥å¨autoschemaä¸­æ·»å å­æ®µå³å¯ã\n\ndatabaseinfoschema = autoschema(manual_fields=[\n    coreapi.field(name="db", required=true, location="query",\n                  schema=coreschema.string(description="æ°æ®åºhost, normalæèsub")),\n    coreapi.field(name="database", location="query", schema=coreschema.string(description="æ°æ®åº")),\n    coreapi.field(name="table", required=true, location="query", schema=coreschema.string(description="æ°æ®åºè¡¨"))\n])\n\n\n1\n2\n3\n4\n5\n6\n\n\nç»å®èªå®ä¹schema\n\nclass databaseinfo(apiview):\n    schema = databaseinfoschema\n\n    def get(self, request):\n        pass\n\n\n1\n2\n3\n4\n5\n\n\n\n# location\n\nlocation   æè¿°\nquery      æ¥è¯¢. list\nform       è¡¨åæäº¤. post\npath       å¨urlä¸­çï¼/ooziejob/{id}/. read',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django restframework choice èªå®ä¹è¾åºæ°æ®",frontmatter:{title:"django restframework choice èªå®ä¹è¾åºæ°æ®",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/b90015/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»å¦ä½å¨django restframeworkä¸­ä½¿ç¨choiceæ¥èªå®ä¹è¾åºæ°æ®ã",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django restframework choice èªå®ä¹è¾åºæ°æ®"},{name:"twitter:description",content:"ä»ç»å¦ä½å¨django restframeworkä¸­ä½¿ç¨choiceæ¥èªå®ä¹è¾åºæ°æ®ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/08.django%20restframework%20choice%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BE%93%E5%87%BA%E6%95%B0%E6%8D%AE.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django restframework choice èªå®ä¹è¾åºæ°æ®"},{property:"og:description",content:"ä»ç»å¦ä½å¨django restframeworkä¸­ä½¿ç¨choiceæ¥èªå®ä¹è¾åºæ°æ®ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/08.django%20restframework%20choice%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BE%93%E5%87%BA%E6%95%B0%E6%8D%AE.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django restframework choice èªå®ä¹è¾åºæ°æ®"},{itemprop:"description",content:"ä»ç»å¦ä½å¨django restframeworkä¸­ä½¿ç¨choiceæ¥èªå®ä¹è¾åºæ°æ®ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/08.django%20restframework%20choice%20%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BE%93%E5%87%BA%E6%95%B0%E6%8D%AE.html",relativePath:"04.ç¼ç¨/01.python/06.django/08.django restframework choice èªå®ä¹è¾åºæ°æ®.md",key:"v-22b0df18",path:"/pages/b90015/",headers:[{level:2,title:"é®é¢",slug:"é®é¢",normalizedTitle:"é®é¢",charIndex:2},{level:2,title:"è§£å³æ¹æ¡",slug:"è§£å³æ¹æ¡",normalizedTitle:"è§£å³æ¹æ¡",charIndex:502}],headersStr:"é®é¢ è§£å³æ¹æ¡",content:"# é®é¢\n\nææä¸ä¸ªè¿æ ·çéæ±ï¼è¿åçæ°æ®jsonä¸­è¿åçæ¯idï¼ä½æ¯ææ³è¦å¾å°è¯¥idå¯¹åºçnameã\n\nidå¯¹åºçname\n\nPlatformType = (   \n    (0, 'éç¨'),   \n    (1, 'åè£'),   \n    (2, 'åè£'),   \n    (3, 'æµ·å¤åè£'),   \n    (4, 'æµ·å¤åè£'),   \n    (5, 'å°ç³»ç»')\n)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nclass TrackSerializer(serializers.ModelSerializer):\n    \n    platform = serializers.ChoiceField(choices=PlatformType)\n    \n    class Meta:    \n        model = Track    \n        fields = \"__all__\"\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nè¿åçç»ææ¯:\n\n{\n    platform: 1\n}\n\n\n1\n2\n3\n\n\nä½æ¯ææ³è¦çæ¯1å¯¹åºçåè£ï¼è¿ä¸ªæ¶åéè¦èªå®ä¹è¿åçæ°æ®ã\n\n\n# è§£å³æ¹æ¡\n\n 1. èªå®ä¹å­æ®µç±»åï¼éåChoiceFieldå­æ®µç±»ï¼å¹¶éåto_representationæ¹æ³ï¼å¨åºååplatformå­æ®µæ¶ï¼ä¼è°ç¨to_representationæ¹æ³è½¬æ¢ææä»¬æ³è¦çæ ¼å¼ã\n\nclass PlatFormField(serializers.ChoiceField):    \n    def to_representation(self, value: Any):        \n        return self.choices[value]\n\nclass TrackSerializer(serializers.ModelSerializer):\n    \n    platform = PlatFormField(choices=PlatformType)\n    \n    class Meta:    \n        model = Track    \n        fields = \"__all__\"\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n 2. éåæ¾ç¤ºçå­æ®µã\n\nå°platformå­æ®µéæ°è¿è¡æ¹åï¼è·åå¶æ¾ç¤ºçåå­ã\n\nclass TrackSerializer(serializers.ModelSerializer):\n    platform = serializers.SerializerMethodField()\n    class Meta:\n        model = Track\n        fields = \"__all__\"\n\ndef get_platform(self, obj):\n    return obj.get_platform_display()\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n",normalizedContent:"# é®é¢\n\nææä¸ä¸ªè¿æ ·çéæ±ï¼è¿åçæ°æ®jsonä¸­è¿åçæ¯idï¼ä½æ¯ææ³è¦å¾å°è¯¥idå¯¹åºçnameã\n\nidå¯¹åºçname\n\nplatformtype = (   \n    (0, 'éç¨'),   \n    (1, 'åè£'),   \n    (2, 'åè£'),   \n    (3, 'æµ·å¤åè£'),   \n    (4, 'æµ·å¤åè£'),   \n    (5, 'å°ç³»ç»')\n)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nclass trackserializer(serializers.modelserializer):\n    \n    platform = serializers.choicefield(choices=platformtype)\n    \n    class meta:    \n        model = track    \n        fields = \"__all__\"\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nè¿åçç»ææ¯:\n\n{\n    platform: 1\n}\n\n\n1\n2\n3\n\n\nä½æ¯ææ³è¦çæ¯1å¯¹åºçåè£ï¼è¿ä¸ªæ¶åéè¦èªå®ä¹è¿åçæ°æ®ã\n\n\n# è§£å³æ¹æ¡\n\n 1. èªå®ä¹å­æ®µç±»åï¼éåchoicefieldå­æ®µç±»ï¼å¹¶éåto_representationæ¹æ³ï¼å¨åºååplatformå­æ®µæ¶ï¼ä¼è°ç¨to_representationæ¹æ³è½¬æ¢ææä»¬æ³è¦çæ ¼å¼ã\n\nclass platformfield(serializers.choicefield):    \n    def to_representation(self, value: any):        \n        return self.choices[value]\n\nclass trackserializer(serializers.modelserializer):\n    \n    platform = platformfield(choices=platformtype)\n    \n    class meta:    \n        model = track    \n        fields = \"__all__\"\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n 2. éåæ¾ç¤ºçå­æ®µã\n\nå°platformå­æ®µéæ°è¿è¡æ¹åï¼è·åå¶æ¾ç¤ºçåå­ã\n\nclass trackserializer(serializers.modelserializer):\n    platform = serializers.serializermethodfield()\n    class meta:\n        model = track\n        fields = \"__all__\"\n\ndef get_platform(self, obj):\n    return obj.get_platform_display()\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django Filtering ä½¿ç¨",frontmatter:{title:"django Filtering ä½¿ç¨",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/cfdb5f/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»django-filteræ¯å¦ä½ä½¿ç¨çã",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217188654.png#alt="},{name:"twitter:title",content:"django Filtering ä½¿ç¨"},{name:"twitter:description",content:"ä»ç»django-filteræ¯å¦ä½ä½¿ç¨çã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217188654.png#alt="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/09.django%20Filtering%20%E4%BD%BF%E7%94%A8.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django Filtering ä½¿ç¨"},{property:"og:description",content:"ä»ç»django-filteræ¯å¦ä½ä½¿ç¨çã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217188654.png#alt="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/09.django%20Filtering%20%E4%BD%BF%E7%94%A8.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django Filtering ä½¿ç¨"},{itemprop:"description",content:"ä»ç»django-filteræ¯å¦ä½ä½¿ç¨çã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217188654.png#alt="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/09.django%20Filtering%20%E4%BD%BF%E7%94%A8.html",relativePath:"04.ç¼ç¨/01.python/06.django/09.django Filtering ä½¿ç¨.md",key:"v-fab79492",path:"/pages/cfdb5f/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"åå¤å·¥ä½",slug:"åå¤å·¥ä½",normalizedTitle:"åå¤å·¥ä½",charIndex:157},{level:2,title:"DjangoFilterBackend",slug:"djangofilterbackend",normalizedTitle:"djangofilterbackend",charIndex:97},{level:2,title:"ä½¿ç¨é»è®¤çè¿æ»¤",slug:"ä½¿ç¨é»è®¤çè¿æ»¤",normalizedTitle:"ä½¿ç¨é»è®¤çè¿æ»¤",charIndex:334},{level:2,title:"èªå®ä¹è¿æ»¤",slug:"èªå®ä¹è¿æ»¤",normalizedTitle:"èªå®ä¹è¿æ»¤",charIndex:801},{level:2,title:"SearchFilter",slug:"searchfilter",normalizedTitle:"searchfilter",charIndex:121},{level:2,title:"OrderingFilter",slug:"orderingfilter",normalizedTitle:"orderingfilter",charIndex:138},{level:2,title:"èªå®ä¹è¿æ»¤æ¡ä»¶",slug:"èªå®ä¹è¿æ»¤æ¡ä»¶",normalizedTitle:"èªå®ä¹è¿æ»¤æ¡ä»¶",charIndex:2994}],headersStr:"ç®ä» åå¤å·¥ä½ DjangoFilterBackend ä½¿ç¨é»è®¤çè¿æ»¤ èªå®ä¹è¿æ»¤ SearchFilter OrderingFilter èªå®ä¹è¿æ»¤æ¡ä»¶",content:"# ç®ä»\n\ndjango-filteræ¯åç¬çä¸ä¸ªåºï¼ä¸å±äºdjangorestframeworkä¸­çï¼å±äºå¤é¨åºå¼ç¨è¿æ¥ä½¿ç¨ãä¸é¢å°±æ¥ä»ç»ä¸filter\n\næä¸ç§filteræ¹å¼:\n\n 1. DjangoFilterBackend\n 2. SearchFilter\n 3. OrderingFilter\n\n\n# åå¤å·¥ä½\n\né¦åéè¦å®è£django-filter\n\n> pip install django-filter\n\nç¶åéè¦å°django_filters æ·»å å° INSTALLED_APPSä¸­\n\nINSTALLED_APPS = [\n    'django_filters',\n]\n\n\n1\n2\n3\n\n\n\n# DjangoFilterBackend\n\n\n# ä½¿ç¨é»è®¤çè¿æ»¤\n\nå¨Viewä¸­æ·»å filter_backendså±æ§,è®¾ç½®è¿æ»¤æ¹å¼DjangoFilterBackendï¼å¹¶ä¸è®¾ç½®è¿æ»¤çå±æ§ã\n\n\nfrom django_filters.rest_framework import DjangoFilterBackend\n\nclass GoodsListViewSet(ModelViewSet):    \n    queryset = Goods.objects.all()    \n    serializer_class = GoodsSerializer    \n    pagination_class = MyPagination    \n    filter_backends = (DjangoFilterBackend,)    \n    filterset_fields = ('name', 'shop_price')\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨è°è¯çé¢ä¸­ä¼åºç°è¿æ»¤å¨éé¡¹, å¯ä»¥å¨å¶ä¸­è¿æ»¤nameåshop_priceä¸¤ä¸ªå±æ§çå¼\n\n\n# èªå®ä¹è¿æ»¤\n\nåå»ºfilters.pyï¼å¨éé¢å®ä¹èªå·±çè¿æ»¤å¨ã å¯ä»¥éè¿æå°çä»·æ ¼ãæå¤§çä»·æ ¼ï¼åæ¨¡ç³æ¥è¯¢åå­å»è¿æ»¤æ³è¦çæ°æ®ã\n\nfrom django_filters import FilterSet, NumberFilter, CharFilter\nfrom .models import Goods\n\nclass GoodsFilter(FilterSet):   \n    \"\"\"    ååçè¿æ»¤ç±»    \"\"\"    \n    price_min = NumberFilter(field_name='shop_price', help_text=\"æä½ä»·æ ¼\", lookup_expr='gte')    \n    price_max = NumberFilter(field_name='shop_price', lookup_expr='lte')    \n    name = CharFilter(field_name='name', lookup_expr=\"icontains\")    \n    class Meta:        \n        model = Goods        \n        fields = ['price_min', 'price_max', 'name']\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå°è¯¥è¿æ»¤å¨æ·»å å°viewä¸­ view.py\n\nclass GoodsListViewSet(ModelViewSet):    \n    queryset = Goods.objects.all()    \n    serializer_class = GoodsSerializer   \n    pagination_class = MyPagination    \n    filter_backends = (DjangoFilterBackend,)    \n    filter_class = GoodsFilter\n\n\n1\n2\n3\n4\n5\n6\n\n\næåå¯ä»¥éè¿ http://127.0.0.1:8000/goods/?price_min=150&price_max=160&name=æ°´æ å»è¿æ»¤å¾å°æ³è¦çæ°æ®ã\n\n\n# SearchFilter\n\nè¿ä¸ªFilteræ¯åºäºDjangoçæç´¢ãç°å¨æä»¬å°SearchFilteréæå°è¿æ»¤éé¢æ¥ãå¨filter_backendsä¸­æ·»å SearchFilerï¼ç¶ååå¨search_fieldsä¸­æ·»å éè¦æç´¢çå­æ®µå³å¯ï¼å¨æç´¢çå­æ®µåé¢å­ç¬¦åéæ¥æé«æç´¢æçã\n\n * '^' Starts-with search.\n * '=' Exact matches.\n * '@' Full-text search. (Currently only supported Django's MySQL backend.)\n * '$' Regex search.\n\nview.py\n\nfrom rest_framework.filters import SearchFilter\n\nclass GoodsListViewSet(ModelViewSet):    \n    queryset = Goods.objects.all()    \n    serializer_class = GoodsSerializer    \n    pagination_class = MyPagination    \n    filter_backends = (DjangoFilterBackend, SearchFilter)    \n    filter_class = GoodsFilter    \n    search_fields = (\"=name\", 'goods_brief', 'goods_desc')\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# OrderingFilter\n\nå¯ä»¥å¯¹æ°æ®è¿è¡æåºç­éæ°æ®ãæä»¬å°å¶å å¥è¿å»\n\nview.py\n\nfrom rest_framework.filters import SearchFilter, OrderingFilter\n\n\n\nclass GoodsListViewSet(ModelViewSet):    \n    queryset = Goods.objects.all()    \n    serializer_class = GoodsSerializer    \n    pagination_class = MyPagination    \n    filter_backends = (DjangoFilterBackend, SearchFilter, OrderingFilter) \n    filter_class = GoodsFilter    \n    search_fields = (\"=name\", 'goods_brief', 'goods_desc')\n    ordering_fields = (\"sold_num\", \"add_time\")\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# èªå®ä¹è¿æ»¤æ¡ä»¶\n\nä¿®æ¹filters.pyæä»¶ï¼ç¼åè¿æ»¤æ¹æ³top_category_filterç»å®å°top_categoryå­æ®µä¸­ï¼å³å¯éè¿è¯¥å±æ§åè¿è¡ç¸åºçç­éã\n\nclass GoodsFilter(FilterSet):    \n    \"\"\"    ååçè¿æ»¤ç±»    \"\"\"    \n    pricemin = NumberFilter(field_name='shop_price', help_text=\"æä½ä»·æ ¼\", lookup_expr='gte')    \n    pricemax = NumberFilter(field_name='shop_price', lookup_expr='lte')    \n    name = CharFilter(field_name='name', lookup_expr=\"icontains\")   \n    top_category = NumberFilter(method='top_category_filter')    \n    \n    def top_category_filter(self, queryset, name, value):        \n        return queryset.filter(Q(category_id=value) | Q(category__parent_category_id=value) | (category__parent_category__parent_category_id=value))\n    \n    class Meta:        \n        model = Goods\n        fields = ['pricemin', 'pricemax', 'name']\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n",normalizedContent:"# ç®ä»\n\ndjango-filteræ¯åç¬çä¸ä¸ªåºï¼ä¸å±äºdjangorestframeworkä¸­çï¼å±äºå¤é¨åºå¼ç¨è¿æ¥ä½¿ç¨ãä¸é¢å°±æ¥ä»ç»ä¸filter\n\næä¸ç§filteræ¹å¼:\n\n 1. djangofilterbackend\n 2. searchfilter\n 3. orderingfilter\n\n\n# åå¤å·¥ä½\n\né¦åéè¦å®è£django-filter\n\n> pip install django-filter\n\nç¶åéè¦å°django_filters æ·»å å° installed_appsä¸­\n\ninstalled_apps = [\n    'django_filters',\n]\n\n\n1\n2\n3\n\n\n\n# djangofilterbackend\n\n\n# ä½¿ç¨é»è®¤çè¿æ»¤\n\nå¨viewä¸­æ·»å filter_backendså±æ§,è®¾ç½®è¿æ»¤æ¹å¼djangofilterbackendï¼å¹¶ä¸è®¾ç½®è¿æ»¤çå±æ§ã\n\n\nfrom django_filters.rest_framework import djangofilterbackend\n\nclass goodslistviewset(modelviewset):    \n    queryset = goods.objects.all()    \n    serializer_class = goodsserializer    \n    pagination_class = mypagination    \n    filter_backends = (djangofilterbackend,)    \n    filterset_fields = ('name', 'shop_price')\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨è°è¯çé¢ä¸­ä¼åºç°è¿æ»¤å¨éé¡¹, å¯ä»¥å¨å¶ä¸­è¿æ»¤nameåshop_priceä¸¤ä¸ªå±æ§çå¼\n\n\n# èªå®ä¹è¿æ»¤\n\nåå»ºfilters.pyï¼å¨éé¢å®ä¹èªå·±çè¿æ»¤å¨ã å¯ä»¥éè¿æå°çä»·æ ¼ãæå¤§çä»·æ ¼ï¼åæ¨¡ç³æ¥è¯¢åå­å»è¿æ»¤æ³è¦çæ°æ®ã\n\nfrom django_filters import filterset, numberfilter, charfilter\nfrom .models import goods\n\nclass goodsfilter(filterset):   \n    \"\"\"    ååçè¿æ»¤ç±»    \"\"\"    \n    price_min = numberfilter(field_name='shop_price', help_text=\"æä½ä»·æ ¼\", lookup_expr='gte')    \n    price_max = numberfilter(field_name='shop_price', lookup_expr='lte')    \n    name = charfilter(field_name='name', lookup_expr=\"icontains\")    \n    class meta:        \n        model = goods        \n        fields = ['price_min', 'price_max', 'name']\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå°è¯¥è¿æ»¤å¨æ·»å å°viewä¸­ view.py\n\nclass goodslistviewset(modelviewset):    \n    queryset = goods.objects.all()    \n    serializer_class = goodsserializer   \n    pagination_class = mypagination    \n    filter_backends = (djangofilterbackend,)    \n    filter_class = goodsfilter\n\n\n1\n2\n3\n4\n5\n6\n\n\næåå¯ä»¥éè¿ http://127.0.0.1:8000/goods/?price_min=150&price_max=160&name=æ°´æ å»è¿æ»¤å¾å°æ³è¦çæ°æ®ã\n\n\n# searchfilter\n\nè¿ä¸ªfilteræ¯åºäºdjangoçæç´¢ãç°å¨æä»¬å°searchfilteréæå°è¿æ»¤éé¢æ¥ãå¨filter_backendsä¸­æ·»å searchfilerï¼ç¶ååå¨search_fieldsä¸­æ·»å éè¦æç´¢çå­æ®µå³å¯ï¼å¨æç´¢çå­æ®µåé¢å­ç¬¦åéæ¥æé«æç´¢æçã\n\n * '^' starts-with search.\n * '=' exact matches.\n * '@' full-text search. (currently only supported django's mysql backend.)\n * '$' regex search.\n\nview.py\n\nfrom rest_framework.filters import searchfilter\n\nclass goodslistviewset(modelviewset):    \n    queryset = goods.objects.all()    \n    serializer_class = goodsserializer    \n    pagination_class = mypagination    \n    filter_backends = (djangofilterbackend, searchfilter)    \n    filter_class = goodsfilter    \n    search_fields = (\"=name\", 'goods_brief', 'goods_desc')\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# orderingfilter\n\nå¯ä»¥å¯¹æ°æ®è¿è¡æåºç­éæ°æ®ãæä»¬å°å¶å å¥è¿å»\n\nview.py\n\nfrom rest_framework.filters import searchfilter, orderingfilter\n\n\n\nclass goodslistviewset(modelviewset):    \n    queryset = goods.objects.all()    \n    serializer_class = goodsserializer    \n    pagination_class = mypagination    \n    filter_backends = (djangofilterbackend, searchfilter, orderingfilter) \n    filter_class = goodsfilter    \n    search_fields = (\"=name\", 'goods_brief', 'goods_desc')\n    ordering_fields = (\"sold_num\", \"add_time\")\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# èªå®ä¹è¿æ»¤æ¡ä»¶\n\nä¿®æ¹filters.pyæä»¶ï¼ç¼åè¿æ»¤æ¹æ³top_category_filterç»å®å°top_categoryå­æ®µä¸­ï¼å³å¯éè¿è¯¥å±æ§åè¿è¡ç¸åºçç­éã\n\nclass goodsfilter(filterset):    \n    \"\"\"    ååçè¿æ»¤ç±»    \"\"\"    \n    pricemin = numberfilter(field_name='shop_price', help_text=\"æä½ä»·æ ¼\", lookup_expr='gte')    \n    pricemax = numberfilter(field_name='shop_price', lookup_expr='lte')    \n    name = charfilter(field_name='name', lookup_expr=\"icontains\")   \n    top_category = numberfilter(method='top_category_filter')    \n    \n    def top_category_filter(self, queryset, name, value):        \n        return queryset.filter(q(category_id=value) | q(category__parent_category_id=value) | (category__parent_category__parent_category_id=value))\n    \n    class meta:        \n        model = goods\n        fields = ['pricemin', 'pricemax', 'name']\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django viewset å Router éåä½¿ç¨æ¶æ¥çé",frontmatter:{title:"django viewset å Router éåä½¿ç¨æ¶æ¥çé",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/e75ceb/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"è§£å³django viewsetårouteréåä½¿ç¨æ¶æ¥çéè¯¯",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django viewset å Router éåä½¿ç¨æ¶æ¥çé"},{name:"twitter:description",content:"è§£å³django viewsetårouteréåä½¿ç¨æ¶æ¥çéè¯¯"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/10.django%20viewset%20%E5%92%8C%20Router%20%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%97%B6%E6%8A%A5%E7%9A%84%E9%94%99.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django viewset å Router éåä½¿ç¨æ¶æ¥çé"},{property:"og:description",content:"è§£å³django viewsetårouteréåä½¿ç¨æ¶æ¥çéè¯¯"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/10.django%20viewset%20%E5%92%8C%20Router%20%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%97%B6%E6%8A%A5%E7%9A%84%E9%94%99.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django viewset å Router éåä½¿ç¨æ¶æ¥çé"},{itemprop:"description",content:"è§£å³django viewsetårouteréåä½¿ç¨æ¶æ¥çéè¯¯"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/10.django%20viewset%20%E5%92%8C%20Router%20%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%97%B6%E6%8A%A5%E7%9A%84%E9%94%99.html",relativePath:"04.ç¼ç¨/01.python/06.django/10.django viewset å Router éåä½¿ç¨æ¶æ¥çé.md",key:"v-fab7554a",path:"/pages/e75ceb/",headersStr:null,content:"æ¥éåå®¹:\n\n> 'basename' argument not specified, and could not automatically determine the name from the viewset, as it does not have a '.queryset' attribute.\n\nbasenameæ¯Router.register()ä¸­çä¸ä¸ªå±æ§ã\n\nå¦ææ²¡æè®¾ç½®basenameå°ä¼èªå¨çåºäºviewsetä¸­çquerysetå±æ§ãå¦æä¸ä½¿ç¨querysetå±æ§ï¼èªå®ä¹get_quertsetæ¹æ³ï¼é£ä¹éè¦è®¾ç½®basenameåæ°ã\n\nç¤ºä¾ä»£ç å¦ä¸. è¿éä½¿ç¨äºèªå®ä¹çget_quertsetæ¹æ³ï¼æä»¥router.register()ä¸­å¿é¡»å ä¸basenameï¼ä¸ç¶ä¼åºç°ä»¥ä¸éè¯¯ view.py\n\nclass GoodsListViewSet(ModelViewSet):    \n    # queryset = Goods.objects.all()    \n    serializer_class = GoodsSerializer    \n    pagination_class = MyPagination    \n    \n    def get_queryset(self):        \n        queryset = Goods.objects.all()        \n        price_min = self.request.query_params.get(\"price_min\", 0)        \n        if price_min:            \n            queryset = queryset.filter(shop_price__gt=int(price_min))        \n    \n    return queryset\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nurl.py\n\nfrom rest_framework.routers import DefaultRouter\nrouter = DefaultRouter()\nrouter.register(r'goods', GoodsListViewSet, base_name=\"goods\")\n\n\n1\n2\n3\n",normalizedContent:"æ¥éåå®¹:\n\n> 'basename' argument not specified, and could not automatically determine the name from the viewset, as it does not have a '.queryset' attribute.\n\nbasenameæ¯router.register()ä¸­çä¸ä¸ªå±æ§ã\n\nå¦ææ²¡æè®¾ç½®basenameå°ä¼èªå¨çåºäºviewsetä¸­çquerysetå±æ§ãå¦æä¸ä½¿ç¨querysetå±æ§ï¼èªå®ä¹get_quertsetæ¹æ³ï¼é£ä¹éè¦è®¾ç½®basenameåæ°ã\n\nç¤ºä¾ä»£ç å¦ä¸. è¿éä½¿ç¨äºèªå®ä¹çget_quertsetæ¹æ³ï¼æä»¥router.register()ä¸­å¿é¡»å ä¸basenameï¼ä¸ç¶ä¼åºç°ä»¥ä¸éè¯¯ view.py\n\nclass goodslistviewset(modelviewset):    \n    # queryset = goods.objects.all()    \n    serializer_class = goodsserializer    \n    pagination_class = mypagination    \n    \n    def get_queryset(self):        \n        queryset = goods.objects.all()        \n        price_min = self.request.query_params.get(\"price_min\", 0)        \n        if price_min:            \n            queryset = queryset.filter(shop_price__gt=int(price_min))        \n    \n    return queryset\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nurl.py\n\nfrom rest_framework.routers import defaultrouter\nrouter = defaultrouter()\nrouter.register(r'goods', goodslistviewset, base_name=\"goods\")\n\n\n1\n2\n3\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django modelçåºåå",frontmatter:{title:"django modelçåºåå",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/acdd50/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"django modelå¦ä½å®ç°åºååã",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217291865.png#alt="},{name:"twitter:title",content:"django modelçåºåå"},{name:"twitter:description",content:"django modelå¦ä½å®ç°åºååã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217291865.png#alt="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/11.django%20model%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django modelçåºåå"},{property:"og:description",content:"django modelå¦ä½å®ç°åºååã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217291865.png#alt="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/11.django%20model%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django modelçåºåå"},{itemprop:"description",content:"django modelå¦ä½å®ç°åºååã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604217291865.png#alt="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/11.django%20model%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96.html",relativePath:"04.ç¼ç¨/01.python/06.django/11.django modelçåºåå.md",key:"v-15cbdfc3",path:"/pages/acdd50/",headersStr:null,content:'ç½ç»ä¼ è¾æ°æ®ç°å¨æµè¡çæ¯jsonæ°æ®æ ¼å¼ï¼æä»¥éå¸¸éè¦å°æ°æ®åºæ¥è¯¢çå°å¯¹è±¡æ°æ®åºååæjsonæ ¼å¼ï¼ç¶åè¿åç»åç«¯è¿è¡æ°æ®å±ç¤ºã\n\nä¸é¢è®¨è®ºå¨djangoä¸­å¦ä½æ´æ¹ä¾¿çå°model åºååã\n\nä¸ä¸ªgoodsçmodleå¦ä¸ã\n\n class Goods(models.Model):\n    name = models.CharField(max_length=100, verbose_name="ååå")\n    market_price = models.FloatField(default=0, verbose_name="å¸åºä»·æ ¼")\n    goods_front_image = models.ImageField(upload_to="goods/images/", null=True, blank=True, verbose_name="å°é¢å¾")    \n    .....\n\n\n\n1\n2\n3\n4\n5\n6\n\n\nåºååä¸. æåå§çmodelåºååï¼æ¯è¾ç¹ç..å¤ªä¸æºè½äº.\n\ngoodList = Goods.objects.all()[:10]\nfor good in goodList:\n    json_dict = {}\n    json_dict["name"] = good.name                    \n    json_dict["market_price"] = good.market_price\n    json_dict["add_time"] = good.add_time\n    json_list.append(json_dict)\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåºååäº.\n\nfrom django.forms.models import model_to_dict\n\ngoodsList = Goods.objects.all()[:10]\nfor goods in goodsList:    json_list.append(model_to_dict(good))\n\n\n1\n2\n3\n4\n\n\néè¿ä½¿ç¨model_to_dict æ´æ¹ä¾¿çå»åºåågoodså¯¹è±¡ãå¯ä¸ä¸è¶³çæ¯æ æ³åºååImageFieldå­æ®µã\n\n\n\nåºååä¸.\n\ngoodsList = Goods.objects.all()[:10]\ngoods_json = serialize(\'json\', goodList)\n\n\n1\n2\n\n\nç´æ¥å°æ´ä¸ªgoods list è¿è¡åºååï¼æ´å æ¹ä¾¿çä½¿ç¨ãä½æ¯è½ç¶è½å¤å°ImageFieldåºååï¼ä½æ¯å¾å°çå¾çè·¯å¾æ¯ä»æ°æ®åºä¸­æ¿å°çï¼å¹¶ä¸æ¯å¾ççå®çè·¯å¾ï¼åç«¯æ¿å°åéè¦åå¤çæè½ä½¿ç¨ã\n\n\n\næåï¼è¿ææ²¡ææ´æ¹ä¾¿çåºååæ¹å¼å¢ï¼å½ç¶æï¼å»äºè§£ä¸djangorestframeworkå§ï¼åææä¹ä¼æåå³äºè¯¥æ¡æ¶çåå®¢ã',normalizedContent:'ç½ç»ä¼ è¾æ°æ®ç°å¨æµè¡çæ¯jsonæ°æ®æ ¼å¼ï¼æä»¥éå¸¸éè¦å°æ°æ®åºæ¥è¯¢çå°å¯¹è±¡æ°æ®åºååæjsonæ ¼å¼ï¼ç¶åè¿åç»åç«¯è¿è¡æ°æ®å±ç¤ºã\n\nä¸é¢è®¨è®ºå¨djangoä¸­å¦ä½æ´æ¹ä¾¿çå°model åºååã\n\nä¸ä¸ªgoodsçmodleå¦ä¸ã\n\n class goods(models.model):\n    name = models.charfield(max_length=100, verbose_name="ååå")\n    market_price = models.floatfield(default=0, verbose_name="å¸åºä»·æ ¼")\n    goods_front_image = models.imagefield(upload_to="goods/images/", null=true, blank=true, verbose_name="å°é¢å¾")    \n    .....\n\n\n\n1\n2\n3\n4\n5\n6\n\n\nåºååä¸. æåå§çmodelåºååï¼æ¯è¾ç¹ç..å¤ªä¸æºè½äº.\n\ngoodlist = goods.objects.all()[:10]\nfor good in goodlist:\n    json_dict = {}\n    json_dict["name"] = good.name                    \n    json_dict["market_price"] = good.market_price\n    json_dict["add_time"] = good.add_time\n    json_list.append(json_dict)\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåºååäº.\n\nfrom django.forms.models import model_to_dict\n\ngoodslist = goods.objects.all()[:10]\nfor goods in goodslist:    json_list.append(model_to_dict(good))\n\n\n1\n2\n3\n4\n\n\néè¿ä½¿ç¨model_to_dict æ´æ¹ä¾¿çå»åºåågoodså¯¹è±¡ãå¯ä¸ä¸è¶³çæ¯æ æ³åºååimagefieldå­æ®µã\n\n\n\nåºååä¸.\n\ngoodslist = goods.objects.all()[:10]\ngoods_json = serialize(\'json\', goodlist)\n\n\n1\n2\n\n\nç´æ¥å°æ´ä¸ªgoods list è¿è¡åºååï¼æ´å æ¹ä¾¿çä½¿ç¨ãä½æ¯è½ç¶è½å¤å°imagefieldåºååï¼ä½æ¯å¾å°çå¾çè·¯å¾æ¯ä»æ°æ®åºä¸­æ¿å°çï¼å¹¶ä¸æ¯å¾ççå®çè·¯å¾ï¼åç«¯æ¿å°åéè¦åå¤çæè½ä½¿ç¨ã\n\n\n\næåï¼è¿ææ²¡ææ´æ¹ä¾¿çåºååæ¹å¼å¢ï¼å½ç¶æï¼å»äºè§£ä¸djangorestframeworkå§ï¼åææä¹ä¼æåå³äºè¯¥æ¡æ¶çåå®¢ã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"djangoä¸­ä½¿ç¨AbStractUser",frontmatter:{title:"djangoä¸­ä½¿ç¨AbStractUser",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/382755/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨AbStractUser",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"djangoä¸­ä½¿ç¨AbStractUser"},{name:"twitter:description",content:"ä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨AbStractUser"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/12.django%E4%B8%AD%E4%BD%BF%E7%94%A8AbStractUser.html"},{property:"og:type",content:"article"},{property:"og:title",content:"djangoä¸­ä½¿ç¨AbStractUser"},{property:"og:description",content:"ä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨AbStractUser"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/12.django%E4%B8%AD%E4%BD%BF%E7%94%A8AbStractUser.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"djangoä¸­ä½¿ç¨AbStractUser"},{itemprop:"description",content:"ä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨AbStractUser"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/12.django%E4%B8%AD%E4%BD%BF%E7%94%A8AbStractUser.html",relativePath:"04.ç¼ç¨/01.python/06.django/12.djangoä¸­ä½¿ç¨AbStractUser.md",key:"v-74cd7d9e",path:"/pages/382755/",headersStr:null,content:"> Djangoåç½®çUserå¯¹è±¡ï¼å·²ç»åå«äºä¸äºä¸»è¦çå±æ§ï¼å¦usernameãpasswordãemailç­ï¼ä½å®éæåµå¯è½è¿éè¦æµç§°ãå¤´åç­å¶ä»å±æ§ï¼ä»ä»ä½¿ç¨åç½®çUserå±æ§æ¯ä¸å¤çã\n> \n> éè¿ä½¿ç¨AbstractUserå¯ä»¥å¯¹Userè¿è¡æ©å±ä½¿ç¨ï¼æ·»å ç¨æ·èªå®ä¹çå±æ§ã\n\nUseræ¨¡åæºç å¦ä¸ã\n\nclass User(AbstractUser):\n    class Meta(AbstractUser.Meta):\n        swappable = 'AUTH_USER_MODEL'\n\n\n1\n2\n3\n\n\nç±æ­¤å¯è§ï¼Userå¯¹AbstractUserä»ä»æ¯ç»§æ¿ï¼æ²¡æè¿è¡ä»»ä½çæ©å±ãæä»¥æä»¬ç»§æ¿AbstractUserå¯ä»¥è·å¾Userçææç¹æ§ã\n\n * modelä¸­ä½¿ç¨\n\nç»§æ¿AbstractUser\n\nfrom django.contrib.auth.models import AbstractUser\n\nclass MyUser(AbstractUser):\n    pass\n\n\n1\n2\n3\n4\n\n * å¨å±settings.pyä¸­è®¾ç½®\n\nè¦çé»è®¤çuser model\n\nAUTH_USER_MODEL = 'app.MyUser'\n\n\n1\n\n * å¨admin.pyä¸­æ³¨åMyUser\n\nfrom django.contrib import admin\nfrom .models import UserProfile\nadmin.site.register(UserProfile,UserAdmin)  \n#ç¨UserAdminå»æ³¨åUserProfile\n\n\n1\n2\n3\n4\n",normalizedContent:"> djangoåç½®çuserå¯¹è±¡ï¼å·²ç»åå«äºä¸äºä¸»è¦çå±æ§ï¼å¦usernameãpasswordãemailç­ï¼ä½å®éæåµå¯è½è¿éè¦æµç§°ãå¤´åç­å¶ä»å±æ§ï¼ä»ä»ä½¿ç¨åç½®çuserå±æ§æ¯ä¸å¤çã\n> \n> éè¿ä½¿ç¨abstractuserå¯ä»¥å¯¹userè¿è¡æ©å±ä½¿ç¨ï¼æ·»å ç¨æ·èªå®ä¹çå±æ§ã\n\nuseræ¨¡åæºç å¦ä¸ã\n\nclass user(abstractuser):\n    class meta(abstractuser.meta):\n        swappable = 'auth_user_model'\n\n\n1\n2\n3\n\n\nç±æ­¤å¯è§ï¼userå¯¹abstractuserä»ä»æ¯ç»§æ¿ï¼æ²¡æè¿è¡ä»»ä½çæ©å±ãæä»¥æä»¬ç»§æ¿abstractuserå¯ä»¥è·å¾userçææç¹æ§ã\n\n * modelä¸­ä½¿ç¨\n\nç»§æ¿abstractuser\n\nfrom django.contrib.auth.models import abstractuser\n\nclass myuser(abstractuser):\n    pass\n\n\n1\n2\n3\n4\n\n * å¨å±settings.pyä¸­è®¾ç½®\n\nè¦çé»è®¤çuser model\n\nauth_user_model = 'app.myuser'\n\n\n1\n\n * å¨admin.pyä¸­æ³¨åmyuser\n\nfrom django.contrib import admin\nfrom .models import userprofile\nadmin.site.register(userprofile,useradmin)  \n#ç¨useradminå»æ³¨åuserprofile\n\n\n1\n2\n3\n4\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users",frontmatter:{title:"django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/060c51/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä½¿ç¨pycharm professional å¼ådjangoæ¶åºç°ä»¥ä¸å¼å¸¸ã",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218742346.png#alt="},{name:"twitter:title",content:"django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users"},{name:"twitter:description",content:"ä½¿ç¨pycharm professional å¼ådjangoæ¶åºç°ä»¥ä¸å¼å¸¸ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218742346.png#alt="},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/13.django.core.exceptions.ImproperlyConfigured%20Application%20labels%20aren't%20unique,%20duplicates%20users.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users"},{property:"og:description",content:"ä½¿ç¨pycharm professional å¼ådjangoæ¶åºç°ä»¥ä¸å¼å¸¸ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218742346.png#alt="},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/13.django.core.exceptions.ImproperlyConfigured%20Application%20labels%20aren't%20unique,%20duplicates%20users.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users"},{itemprop:"description",content:"ä½¿ç¨pycharm professional å¼ådjangoæ¶åºç°ä»¥ä¸å¼å¸¸ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1604218742346.png#alt="}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/13.django.core.exceptions.ImproperlyConfigured%20Application%20labels%20aren't%20unique,%20duplicates%20users.html",relativePath:"04.ç¼ç¨/01.python/06.django/13.django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users.md",key:"v-37cf929d",path:"/pages/060c51/",headersStr:null,content:"ä½¿ç¨pycharm professional å¼ådjangoæ¶åºç°ä»¥ä¸å¼å¸¸ã\n\n> django.core.exceptions.ImproperlyConfigured: Application labels aren't unique, duplicates: users\n\næ¥æ¾èµæååç°ï¼å ä¸ºusersåºç¨éå¤äºï¼æä»¥æ¥éã\n\n> å¨ä½¿ç¨pycharm professional åå»ºdjangoé¡¹ç®æ¶ï¼å·²ç»åå»ºäºusers åºç¨ï¼å¹¶èªå¨æ·»å å°é¡¹ç®ä¸­ã\n\n\n\n> åé¢åå¨INSTALLED_APPSä¸­æ·»å usersåä¼éå¤æ·»å usersåºç¨ã\n\n",normalizedContent:"ä½¿ç¨pycharm professional å¼ådjangoæ¶åºç°ä»¥ä¸å¼å¸¸ã\n\n> django.core.exceptions.improperlyconfigured: application labels aren't unique, duplicates: users\n\næ¥æ¾èµæååç°ï¼å ä¸ºusersåºç¨éå¤äºï¼æä»¥æ¥éã\n\n> å¨ä½¿ç¨pycharm professional åå»ºdjangoé¡¹ç®æ¶ï¼å·²ç»åå»ºäºusers åºç¨ï¼å¹¶èªå¨æ·»å å°é¡¹ç®ä¸­ã\n\n\n\n> åé¢åå¨installed_appsä¸­æ·»å usersåä¼éå¤æ·»å usersåºç¨ã\n\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django ä¸­ mediaéç½®",frontmatter:{title:"django ä¸­ mediaéç½®",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/de01e2/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"mediaæä»¶å¤¹ä¸è¬ç¨äºä¸ä¼ åªä½æä»¶å°æå¡ä¸­å­æ¾çå°æ¹ãä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨mediaçéç½®",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django ä¸­ mediaéç½®"},{name:"twitter:description",content:"mediaæä»¶å¤¹ä¸è¬ç¨äºä¸ä¼ åªä½æä»¶å°æå¡ä¸­å­æ¾çå°æ¹ãä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨mediaçéç½®"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/14.django%20%E4%B8%AD%20media%E9%85%8D%E7%BD%AE.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django ä¸­ mediaéç½®"},{property:"og:description",content:"mediaæä»¶å¤¹ä¸è¬ç¨äºä¸ä¼ åªä½æä»¶å°æå¡ä¸­å­æ¾çå°æ¹ãä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨mediaçéç½®"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/14.django%20%E4%B8%AD%20media%E9%85%8D%E7%BD%AE.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django ä¸­ mediaéç½®"},{itemprop:"description",content:"mediaæä»¶å¤¹ä¸è¬ç¨äºä¸ä¼ åªä½æä»¶å°æå¡ä¸­å­æ¾çå°æ¹ãä»ç»å¨djangoä¸­å¦ä½ä½¿ç¨mediaçéç½®"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/14.django%20%E4%B8%AD%20media%E9%85%8D%E7%BD%AE.html",relativePath:"04.ç¼ç¨/01.python/06.django/14.django ä¸­ mediaéç½®.md",key:"v-40dce165",path:"/pages/de01e2/",headersStr:null,content:'mediaæä»¶å¤¹ä¸è¬ç¨äºä¸ä¼ åªä½æä»¶å°æå¡ä¸­å­æ¾çå°æ¹ã\n\néç½®\n\n 1. å¨é¡¹ç®ä¸­åå»ºmediaæä»¶å¤¹\n\n 2. models éç½®\n\nclass UserModel(models.Model):\n    \n    # æä»¶ä¼ä¸ä¼ å° /media/usersç®å½ä¸\n    image = models.ImageField(max_length=200, upload_to="users/")\n\n\n1\n2\n3\n4\n\n 3. settings éç½®\n\nMEDIA_URL = "/media/"\nMEDIA_ROOT = os.path.join(BASE_DIR, "media")\n\n\n1\n2\n\n 4. urls.py éç½®\n\nfrom django.urls import re_path\nfrom settings import MEDIA_ROOT\n\nurlpatterns = [    \n    re_path(r\'^media/(?P<path>.*)$\', serve, {"document_root": MEDIA_ROOT})\n]\n\n\n1\n2\n3\n4\n5\n6\n\n 5. æµè¯\n\n> éè¿localhost:8000/media/user/a.jpg å¯ä»¥è®¿é®å¾ç',normalizedContent:'mediaæä»¶å¤¹ä¸è¬ç¨äºä¸ä¼ åªä½æä»¶å°æå¡ä¸­å­æ¾çå°æ¹ã\n\néç½®\n\n 1. å¨é¡¹ç®ä¸­åå»ºmediaæä»¶å¤¹\n\n 2. models éç½®\n\nclass usermodel(models.model):\n    \n    # æä»¶ä¼ä¸ä¼ å° /media/usersç®å½ä¸\n    image = models.imagefield(max_length=200, upload_to="users/")\n\n\n1\n2\n3\n4\n\n 3. settings éç½®\n\nmedia_url = "/media/"\nmedia_root = os.path.join(base_dir, "media")\n\n\n1\n2\n\n 4. urls.py éç½®\n\nfrom django.urls import re_path\nfrom settings import media_root\n\nurlpatterns = [    \n    re_path(r\'^media/(?p<path>.*)$\', serve, {"document_root": media_root})\n]\n\n\n1\n2\n3\n4\n5\n6\n\n 5. æµè¯\n\n> éè¿localhost:8000/media/user/a.jpg å¯ä»¥è®¿é®å¾ç',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django å¤é®å¼ç¨èªèº«åon_deleteåæ°",frontmatter:{title:"django å¤é®å¼ç¨èªèº«åon_deleteåæ°",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/b422bd/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"djangoä¸­ä½¿ç¨å¤é®å¼ç¨èªèº«çæ¹æ³åon_deleteåæ°çéç½®",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django å¤é®å¼ç¨èªèº«åon_deleteåæ°"},{name:"twitter:description",content:"djangoä¸­ä½¿ç¨å¤é®å¼ç¨èªèº«çæ¹æ³åon_deleteåæ°çéç½®"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/15.django%20%E5%A4%96%E9%94%AE%E5%BC%95%E7%94%A8%E8%87%AA%E8%BA%AB%E5%92%8Con_delete%E5%8F%82%E6%95%B0.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django å¤é®å¼ç¨èªèº«åon_deleteåæ°"},{property:"og:description",content:"djangoä¸­ä½¿ç¨å¤é®å¼ç¨èªèº«çæ¹æ³åon_deleteåæ°çéç½®"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/15.django%20%E5%A4%96%E9%94%AE%E5%BC%95%E7%94%A8%E8%87%AA%E8%BA%AB%E5%92%8Con_delete%E5%8F%82%E6%95%B0.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django å¤é®å¼ç¨èªèº«åon_deleteåæ°"},{itemprop:"description",content:"djangoä¸­ä½¿ç¨å¤é®å¼ç¨èªèº«çæ¹æ³åon_deleteåæ°çéç½®"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/15.django%20%E5%A4%96%E9%94%AE%E5%BC%95%E7%94%A8%E8%87%AA%E8%BA%AB%E5%92%8Con_delete%E5%8F%82%E6%95%B0.html",relativePath:"04.ç¼ç¨/01.python/06.django/15.django å¤é®å¼ç¨èªèº«åon_deleteåæ°.md",key:"v-722217eb",path:"/pages/b422bd/",headersStr:null,content:"æ¡ä¾. è¯¥æ¨¡åä½¿ç¨å¤é®å¼ç¨èªå·±æ¬èº«ã\n\nfrom django.db import models\n\nclass Category(models.Model):\n    name = models.TextField()\n    parent_cat = models.ForeignKey('self',on_delete=models.CASCADE)\n\n\n1\n2\n3\n4\n5\n\n\non_deleteåæ°å¦ä¸:\n\n 1. CASCADEï¼çº§èæä½ãå¦æå¤é®å¯¹åºçé£æ¡æ°æ®è¢«å é¤äºï¼é£ä¹è¿æ¡æ°æ®ä¹ä¼è¢«å é¤ã\n\n 2. PROTECTï¼åä¿æ¤ãå³åªè¦è¿æ¡æ°æ®å¼ç¨äºå¤é®çé£æ¡æ°æ®ï¼é£ä¹å°±ä¸è½å é¤å¤é®çé£æ¡æ°æ®ãå¦ææä»¬å¼ºè¡å é¤ï¼Djangoå°±ä¼æ¥éã\n\n 3. SET_NULLï¼è®¾ç½®ä¸ºç©ºãå¦æå¤é®çé£æ¡æ°æ®è¢«å é¤äºï¼é£ä¹å¨æ¬æ¡æ°æ®ä¸å°±å°è¿ä¸ªå­æ®µè®¾ç½®ä¸ºç©ºãå¦æè®¾ç½®è¿ä¸ªéé¡¹ï¼åææ¯è¦æå®è¿ä¸ªå­æ®µå¯ä»¥ä¸ºç©ºã\n\n 4. SET_DEFAULTï¼è®¾ç½®é»è®¤å¼ãå¦æå¤é®çé£æ¡æ°æ®è¢«å é¤äºï¼é£ä¹æ¬æ¡æ°æ®ä¸å°±å°è¿ä¸ªå­æ®µè®¾ç½®ä¸ºé»è®¤å¼ãå¦æè®¾ç½®è¿ä¸ªéé¡¹ï¼== åææ¯è¦æå®è¿ä¸ªå­æ®µä¸ä¸ªé»è®¤å¼ ==ã\n\n 5. SET()ï¼å¦æå¤é®çé£æ¡æ°æ®è¢«å é¤äºãé£ä¹å°ä¼è·åSETå½æ°ä¸­çå¼æ¥ä½ä¸ºè¿ä¸ªå¤é®çå¼ãSETå½æ°å¯ä»¥æ¥æ¶ä¸ä¸ªå¯ä»¥è°ç¨çå¯¹è±¡ï¼æ¯å¦å½æ°æèæ¹æ³ï¼ï¼å¦ææ¯å¯ä»¥è°ç¨çå¯¹è±¡ï¼é£ä¹ä¼å°è¿ä¸ªå¯¹è±¡è°ç¨åçç»æä½ä¸ºå¼è¿ååå»ã== å¯ä»¥ä¸ç¨æå®é»è®¤å¼ ==\n\n 6. DO_NOTHINGï¼ä¸éåä»»ä½è¡ä¸ºãä¸åå¨çæ°æ®åºçº§å«ççº¦æã\n\næ³¨æ:ä»¥ä¸çéç½®é½æ¯djangoçº§å«çï¼å¨æ°æ®åºä¸­ççº§å«ä¾æ§æ¯RESTRICT\n\næ°æ®åºå±é¢ççº¦ææ:\n\n 1. RESTRICTï¼é»è®¤çéé¡¹ï¼å¦ææ³è¦å é¤ç¶è¡¨çè®°å½æ¶ï¼èå¨å­è¡¨ä¸­æå³èè¯¥ç¶è¡¨çè®°å½ï¼åä¸åè®¸å é¤ç¶è¡¨ä¸­çè®°å½ï¼\n\n 2. NOACTIONï¼å RESTRICTææä¸æ ·ï¼ä¹æ¯é¦ååæ£æ¥å¤é®;\n\n 3. CASCADEï¼ç¶è¡¨deleteãupdateçæ¶åï¼å­è¡¨ä¼deleteãupdateæå³èè®°å½ï¼\n\n 4. SET NULL:ç¶è¡¨deleteãupdateçæ¶åï¼å­è¡¨ä¼å°å³èè®°å½çå¤é®å­æ®µæå¨åè®¾ä¸ºnullï¼æä»¥æ³¨æå¨è®¾è®¡å­è¡¨æ¶å¤é®ä¸è½è®¾ä¸ºnot nullï¼\n\nä¸ºä»ä¹å¨djangoä¸­å¯ä»¥æ¯ç¨ä¸åççº¦æå»æä½æ°æ®åºå¢ã\n\n> æ¯å¦ django ä¸­ on_delete=CASCADE, ä½æ¯æ°æ®åºçå¤é®çº¦ææ¯RESTRICT. å¨è¿è¡å é¤Aè¡¨æ°æ®æ¶ï¼åç°è¢«å¤é®çº¦æçï¼ä½¿æ°æ®ä¸è½è¢«å é¤ï¼ådjangoä¼åå»å é¤çº¦æçBè¡¨æ°æ®ï¼ç¶ååæ¥å é¤Aè¡¨æ°æ®ã",normalizedContent:"æ¡ä¾. è¯¥æ¨¡åä½¿ç¨å¤é®å¼ç¨èªå·±æ¬èº«ã\n\nfrom django.db import models\n\nclass category(models.model):\n    name = models.textfield()\n    parent_cat = models.foreignkey('self',on_delete=models.cascade)\n\n\n1\n2\n3\n4\n5\n\n\non_deleteåæ°å¦ä¸:\n\n 1. cascadeï¼çº§èæä½ãå¦æå¤é®å¯¹åºçé£æ¡æ°æ®è¢«å é¤äºï¼é£ä¹è¿æ¡æ°æ®ä¹ä¼è¢«å é¤ã\n\n 2. protectï¼åä¿æ¤ãå³åªè¦è¿æ¡æ°æ®å¼ç¨äºå¤é®çé£æ¡æ°æ®ï¼é£ä¹å°±ä¸è½å é¤å¤é®çé£æ¡æ°æ®ãå¦ææä»¬å¼ºè¡å é¤ï¼djangoå°±ä¼æ¥éã\n\n 3. set_nullï¼è®¾ç½®ä¸ºç©ºãå¦æå¤é®çé£æ¡æ°æ®è¢«å é¤äºï¼é£ä¹å¨æ¬æ¡æ°æ®ä¸å°±å°è¿ä¸ªå­æ®µè®¾ç½®ä¸ºç©ºãå¦æè®¾ç½®è¿ä¸ªéé¡¹ï¼åææ¯è¦æå®è¿ä¸ªå­æ®µå¯ä»¥ä¸ºç©ºã\n\n 4. set_defaultï¼è®¾ç½®é»è®¤å¼ãå¦æå¤é®çé£æ¡æ°æ®è¢«å é¤äºï¼é£ä¹æ¬æ¡æ°æ®ä¸å°±å°è¿ä¸ªå­æ®µè®¾ç½®ä¸ºé»è®¤å¼ãå¦æè®¾ç½®è¿ä¸ªéé¡¹ï¼== åææ¯è¦æå®è¿ä¸ªå­æ®µä¸ä¸ªé»è®¤å¼ ==ã\n\n 5. set()ï¼å¦æå¤é®çé£æ¡æ°æ®è¢«å é¤äºãé£ä¹å°ä¼è·åsetå½æ°ä¸­çå¼æ¥ä½ä¸ºè¿ä¸ªå¤é®çå¼ãsetå½æ°å¯ä»¥æ¥æ¶ä¸ä¸ªå¯ä»¥è°ç¨çå¯¹è±¡ï¼æ¯å¦å½æ°æèæ¹æ³ï¼ï¼å¦ææ¯å¯ä»¥è°ç¨çå¯¹è±¡ï¼é£ä¹ä¼å°è¿ä¸ªå¯¹è±¡è°ç¨åçç»æä½ä¸ºå¼è¿ååå»ã== å¯ä»¥ä¸ç¨æå®é»è®¤å¼ ==\n\n 6. do_nothingï¼ä¸éåä»»ä½è¡ä¸ºãä¸åå¨çæ°æ®åºçº§å«ççº¦æã\n\næ³¨æ:ä»¥ä¸çéç½®é½æ¯djangoçº§å«çï¼å¨æ°æ®åºä¸­ççº§å«ä¾æ§æ¯restrict\n\næ°æ®åºå±é¢ççº¦ææ:\n\n 1. restrictï¼é»è®¤çéé¡¹ï¼å¦ææ³è¦å é¤ç¶è¡¨çè®°å½æ¶ï¼èå¨å­è¡¨ä¸­æå³èè¯¥ç¶è¡¨çè®°å½ï¼åä¸åè®¸å é¤ç¶è¡¨ä¸­çè®°å½ï¼\n\n 2. noactionï¼å restrictææä¸æ ·ï¼ä¹æ¯é¦ååæ£æ¥å¤é®;\n\n 3. cascadeï¼ç¶è¡¨deleteãupdateçæ¶åï¼å­è¡¨ä¼deleteãupdateæå³èè®°å½ï¼\n\n 4. set null:ç¶è¡¨deleteãupdateçæ¶åï¼å­è¡¨ä¼å°å³èè®°å½çå¤é®å­æ®µæå¨åè®¾ä¸ºnullï¼æä»¥æ³¨æå¨è®¾è®¡å­è¡¨æ¶å¤é®ä¸è½è®¾ä¸ºnot nullï¼\n\nä¸ºä»ä¹å¨djangoä¸­å¯ä»¥æ¯ç¨ä¸åççº¦æå»æä½æ°æ®åºå¢ã\n\n> æ¯å¦ django ä¸­ on_delete=cascade, ä½æ¯æ°æ®åºçå¤é®çº¦ææ¯restrict. å¨è¿è¡å é¤aè¡¨æ°æ®æ¶ï¼åç°è¢«å¤é®çº¦æçï¼ä½¿æ°æ®ä¸è½è¢«å é¤ï¼ådjangoä¼åå»å é¤çº¦æçbè¡¨æ°æ®ï¼ç¶ååæ¥å é¤aè¡¨æ°æ®ã",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django è­¦å while time zone support is active",frontmatter:{title:"django è­¦å while time zone support is active",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/f0d816/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"djangoä¸­çæ¶åºé®é¢",feed:{enable:!0},tags:["python","django"],categories:["ç¼ç¨","python","django"],comment:!0,meta:[{name:"twitter:title",content:"django è­¦å while time zone support is active"},{name:"twitter:description",content:"djangoä¸­çæ¶åºé®é¢"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/16.django%20%E8%AD%A6%E5%91%8A%20while%20time%20zone%20support%20is%20active.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django è­¦å while time zone support is active"},{property:"og:description",content:"djangoä¸­çæ¶åºé®é¢"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/16.django%20%E8%AD%A6%E5%91%8A%20while%20time%20zone%20support%20is%20active.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django è­¦å while time zone support is active"},{itemprop:"description",content:"djangoä¸­çæ¶åºé®é¢"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/16.django%20%E8%AD%A6%E5%91%8A%20while%20time%20zone%20support%20is%20active.html",relativePath:"04.ç¼ç¨/01.python/06.django/16.django è­¦å while time zone support is active.md",key:"v-224b6ec4",path:"/pages/f0d816/",headersStr:null,content:"åè­¦éè¯¯å¦ä¸ã\n\n> DateTimeField Customer.updated received a naive datetime (2016-06-19 07:18:21.118000) while time zone support is active\n\nå¨ settings.py ä¸­è®¾ç½®ç USE_TZ=Trueï¼æä»¥éè¦ä½¿ç¨ active datetime, ä½æ¯å´å¾å°äº naive datetime.\n\n> naive datetime æ¯éè¿ datetime è¾åºä¸å¸¦æ¶åºçæ¶é´. active time æ¯ä½¿ç¨django.utils.timezone.now() è¾åºçæ¯å¸¦æ¶åºutcæ¶é´ã\n\nè§£å³åæ³\n\n 1. ä½¿ç¨å¸¦æ¶åºçæ¶é´, djangoä¸­ä½¿ç¨ django.utils.timezone.now() , settings.py ä¸­ USE_TZ=True\n\n 2. ä½¿ç¨ä¸å¸¦æ¶åºçæ¶é´, djangoä¸­ä½¿ç¨ datetime.now(), settings.py ä¸­ USE_TZ=False",normalizedContent:"åè­¦éè¯¯å¦ä¸ã\n\n> datetimefield customer.updated received a naive datetime (2016-06-19 07:18:21.118000) while time zone support is active\n\nå¨ settings.py ä¸­è®¾ç½®ç use_tz=trueï¼æä»¥éè¦ä½¿ç¨ active datetime, ä½æ¯å´å¾å°äº naive datetime.\n\n> naive datetime æ¯éè¿ datetime è¾åºä¸å¸¦æ¶åºçæ¶é´. active time æ¯ä½¿ç¨django.utils.timezone.now() è¾åºçæ¯å¸¦æ¶åºutcæ¶é´ã\n\nè§£å³åæ³\n\n 1. ä½¿ç¨å¸¦æ¶åºçæ¶é´, djangoä¸­ä½¿ç¨ django.utils.timezone.now() , settings.py ä¸­ use_tz=true\n\n 2. ä½¿ç¨ä¸å¸¦æ¶åºçæ¶é´, djangoä¸­ä½¿ç¨ datetime.now(), settings.py ä¸­ use_tz=false",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"Flaskä½¿ç¨flask_socketioå®ç°websocket",frontmatter:{author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},title:"Flaskä½¿ç¨flask_socketioå®ç°websocket",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/b71dc2/",description:"å¨flaskä¸­ä½¿ç¨flask_socketioæ¥å®ç°websocketçåè½ã",feed:{enable:!0},tags:["python","flask"],categories:["ç¼ç¨","python","flask"],comment:!0,meta:[{name:"twitter:title",content:"Flaskä½¿ç¨flask_socketioå®ç°websocket"},{name:"twitter:description",content:"å¨flaskä¸­ä½¿ç¨flask_socketioæ¥å®ç°websocketçåè½ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/07.flask/01.Flask%E4%BD%BF%E7%94%A8flask_socketio%E5%AE%9E%E7%8E%B0websocket.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Flaskä½¿ç¨flask_socketioå®ç°websocket"},{property:"og:description",content:"å¨flaskä¸­ä½¿ç¨flask_socketioæ¥å®ç°websocketçåè½ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/07.flask/01.Flask%E4%BD%BF%E7%94%A8flask_socketio%E5%AE%9E%E7%8E%B0websocket.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"flask"},{itemprop:"name",content:"Flaskä½¿ç¨flask_socketioå®ç°websocket"},{itemprop:"description",content:"å¨flaskä¸­ä½¿ç¨flask_socketioæ¥å®ç°websocketçåè½ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/07.flask/01.Flask%E4%BD%BF%E7%94%A8flask_socketio%E5%AE%9E%E7%8E%B0websocket.html",relativePath:"04.ç¼ç¨/01.python/07.flask/01.Flaskä½¿ç¨flask_socketioå®ç°websocket.md",key:"v-73bfa208",path:"/pages/b71dc2/",headers:[{level:2,title:"åç«¯å®ç°",slug:"åç«¯å®ç°",normalizedTitle:"åç«¯å®ç°",charIndex:105},{level:2,title:"åç«¯å®ç°",slug:"åç«¯å®ç°",normalizedTitle:"åç«¯å®ç°",charIndex:1556},{level:3,title:"å®è£",slug:"å®è£",normalizedTitle:"å®è£",charIndex:1615},{level:3,title:"send å emitåºå«",slug:"send-å-emitåºå«",normalizedTitle:"send å emitåºå«",charIndex:1652},{level:3,title:"ç®åä½¿ç¨",slug:"ç®åä½¿ç¨",normalizedTitle:"ç®åä½¿ç¨",charIndex:1711},{level:3,title:"åºäºç±»çä½¿ç¨",slug:"åºäºç±»çä½¿ç¨",normalizedTitle:"åºäºç±»çä½¿ç¨",charIndex:2613}],excerpt:'<h1 id="flaskä½¿ç¨flask-socketioå®ç°websocket"><a class="header-anchor" href="#flaskä½¿ç¨flask-socketioå®ç°websocket">#</a> Flaskä½¿ç¨flask_socketioå®ç°websocket</h1>\n<p>ä¸é¢æ¯æ¡ä¾ï¼æ¯æèªå·±ç¨æ¥æµè¯ä½¿ç¨çï¼å¯ä»¥ç´æ¥è¿è¡çãè¯¦ç»çä½¿ç¨è¯·ç<a href="https://flask-socketio.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">å®ç½<OutboundLink/></a></p>\n<p>websocketä¸»è¦åºç¨äºå®¢æ·ç«¯åæå¡ç«¯ååéä¿¡çã</p>\n',headersStr:"åç«¯å®ç° åç«¯å®ç° å®è£ send å emitåºå« ç®åä½¿ç¨ åºäºç±»çä½¿ç¨",content:"# Flaskä½¿ç¨flask_socketioå®ç°websocket\n\nä¸é¢æ¯æ¡ä¾ï¼æ¯æèªå·±ç¨æ¥æµè¯ä½¿ç¨çï¼å¯ä»¥ç´æ¥è¿è¡çãè¯¦ç»çä½¿ç¨è¯·çå®ç½\n\nwebsocketä¸»è¦åºç¨äºå®¢æ·ç«¯åæå¡ç«¯ååéä¿¡çã\n\n\n# åç«¯å®ç°\n\nä½¿ç¨socket.io.min.jsæ¯node.jsçä¸ä¸ªwebsocketåºï¼é¦ååå»ºsocket. emitæ¯ååç«¯åéæ¶æ¯, messageæ¯è¯¥æ¡æ¶æ¯çåç§°ï¼åé¢æ¯åéæ¶æ¯çæ°æ®ãonæ¯æ³¨åæ¥åæ¶æ¯çäºä»¶,è·ååç«¯ä¼ è¿æ¥çæ°æ®. namespaceæ¯æä¸ç±»çæ¶æ¯ãå½è¿æ¥æåæ¶ï¼ä¼è§¦åconnectäºä»¶ï¼è¿æ¥å³é­æ¶ï¼è§¦ådisconnectäºä»¶ã\n\n\n<html>\n    <head>\n        <script type=\"text/javascript\"\n        src=\"https://code.jquery.com/jquery-3.4.0.min.js\"><\/script>\n        <script type=\"text/javascript\"\n        src=\"//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js\"><\/script>\n        \n        <script type=\"text/javascript\" charset=\"utf-8\">\n            $(document).ready(function () {\n                namespace = \"/wechat\"\n                var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);\n                \n                socket.emit(\"message\", { \"data\": \"zhangsan\" })\n                \n                socket.on('connect', function (data) {\n                    socket.emit('message', { 'data': 'I\\'m connected!' });\n                });\n                \n                socket.on('disconnect', function(data){\n                    socket.emit('message', { 'data': 'I\\'m disconnected!' });\n                });\n                    \n                socket.on('response', function (data) {\n                    console.log(data.age)\n                });\n            });\n        <\/script>\n    </head>\n    \n    <body>\n        <h1>å¾·çè¥¿äº</h1>\n    </body>\n</html>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n\n\n\n# åç«¯å®ç°\n\n> Flask-SocketIOä½¿Flaskåºç¨ç¨åºå¯ä»¥è®¿é®å®¢æ·ç«¯åæå¡å¨ä¹é´çä½å»¶è¿ååéä¿¡ã\n\n\n# å®è£\n\n> pip install flask-socketio\n\n\n# send å emitåºå«\n\nsendåéçæ¯æ å½åçæ°æ®ï¼èemitæ¯åéæå½åçæ°æ®ï¼ä¸ªäººå»ºè®®æ¯emit\n\n\n# ç®åä½¿ç¨\n\nonæ¯æ³¨åæ¥æ¶åç«¯æ¶æ¯çæ¹æ³ï¼messageæ¯ææ¥æ¶çä¿¡æ¯çåç§°ï¼ååç«¯å¯¹åºãnamespaceæ¯æä¸ç±»çæ¶æ¯ï¼ååç«¯å¯¹åºãemitæ¯æååç«¯åéæ¶æ¯ï¼å¯¹åºçæ¶æ¯çåç§°ãæ°æ®ånamespaceã\n\né»è®¤çä¸¤ä¸ªäºä»¶ï¼connectådisconnectï¼å½websocketè¿æ¥æååå¤±è´¥æ¶ï¼èªå¨è§¦åè¿ä¸¤ä¸ªäºä»¶ã\n\n\nfrom flask import Flask, render_template\nfrom flask_socketio import SocketIO\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = 'secret!'\nsocketio = SocketIO(app)\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@socketio.on('message', namespace=\"/wechat\")\ndef handle_message(message):\n    print('received message: ' + message['data'])\n    socketio.emit(\"response\", {'age': 18}, namespace=\"/wechat\")\n\n@socketio.on('connect', namespace=\"/wechat\")\ndef connect():\n    print(\"connect..\")\n\n@socketio.on('disconnect', namespace=\"/wechat\")\ndef connect():\n    print(\"disconnect...\")\n\nif __name__ == '__main__':\n    socketio.run(app, port=8080)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\n\n# åºäºç±»çä½¿ç¨\n\nä¸é¢é½æ¯åºäºæ¹æ³ä½¿ç¨ï¼ä¸ªäººæè§å¦ææä½è¾å¤çæåµï¼æ¯è¾åä¹±ï¼ä½¿ç¨ç±»å»ç®¡çä¼æ´é½åæ¹ä¾¿å¾å¤ã\n\næå¡å¨æ¶å°çä»»ä½äºä»¶é½ä¼è¢«åéå°ä¸ä¸ªåä¸ºå¸¦æon_åç¼çäºä»¶åç§°çæ¹æ³ã\n\nè¿ä¸ªæ¡ä¾åä¸é¢åºäºæ¹æ³æ¯ä¸æ ·çï¼ä½æ¯æ´å æ¹ä¾¿ç®¡çäºï¼æ¯ä¸ªclassç®¡çä¸ä¸ªnamespaceã\n\n\nclass MyCustomNamespace(Namespace):\n\n    def on_connect(self):\n        print(\"è¿æ¥..\")\n        \n    def on_disconnect(self):\n        print(\"å³é­è¿æ¥\")\n        \n    def on_message(self, data):\n        print('received message: ' + data['data'])\n        self.emit(\"response\", {'age': 18})\n    \nsocketio.on_namespace(MyCustomNamespace(\"/wechat\"))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n",normalizedContent:"# flaskä½¿ç¨flask_socketioå®ç°websocket\n\nä¸é¢æ¯æ¡ä¾ï¼æ¯æèªå·±ç¨æ¥æµè¯ä½¿ç¨çï¼å¯ä»¥ç´æ¥è¿è¡çãè¯¦ç»çä½¿ç¨è¯·çå®ç½\n\nwebsocketä¸»è¦åºç¨äºå®¢æ·ç«¯åæå¡ç«¯ååéä¿¡çã\n\n\n# åç«¯å®ç°\n\nä½¿ç¨socket.io.min.jsæ¯node.jsçä¸ä¸ªwebsocketåºï¼é¦ååå»ºsocket. emitæ¯ååç«¯åéæ¶æ¯, messageæ¯è¯¥æ¡æ¶æ¯çåç§°ï¼åé¢æ¯åéæ¶æ¯çæ°æ®ãonæ¯æ³¨åæ¥åæ¶æ¯çäºä»¶,è·ååç«¯ä¼ è¿æ¥çæ°æ®. namespaceæ¯æä¸ç±»çæ¶æ¯ãå½è¿æ¥æåæ¶ï¼ä¼è§¦åconnectäºä»¶ï¼è¿æ¥å³é­æ¶ï¼è§¦ådisconnectäºä»¶ã\n\n\n<html>\n    <head>\n        <script type=\"text/javascript\"\n        src=\"https://code.jquery.com/jquery-3.4.0.min.js\"><\/script>\n        <script type=\"text/javascript\"\n        src=\"//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js\"><\/script>\n        \n        <script type=\"text/javascript\" charset=\"utf-8\">\n            $(document).ready(function () {\n                namespace = \"/wechat\"\n                var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);\n                \n                socket.emit(\"message\", { \"data\": \"zhangsan\" })\n                \n                socket.on('connect', function (data) {\n                    socket.emit('message', { 'data': 'i\\'m connected!' });\n                });\n                \n                socket.on('disconnect', function(data){\n                    socket.emit('message', { 'data': 'i\\'m disconnected!' });\n                });\n                    \n                socket.on('response', function (data) {\n                    console.log(data.age)\n                });\n            });\n        <\/script>\n    </head>\n    \n    <body>\n        <h1>å¾·çè¥¿äº</h1>\n    </body>\n</html>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n\n\n\n# åç«¯å®ç°\n\n> flask-socketioä½¿flaskåºç¨ç¨åºå¯ä»¥è®¿é®å®¢æ·ç«¯åæå¡å¨ä¹é´çä½å»¶è¿ååéä¿¡ã\n\n\n# å®è£\n\n> pip install flask-socketio\n\n\n# send å emitåºå«\n\nsendåéçæ¯æ å½åçæ°æ®ï¼èemitæ¯åéæå½åçæ°æ®ï¼ä¸ªäººå»ºè®®æ¯emit\n\n\n# ç®åä½¿ç¨\n\nonæ¯æ³¨åæ¥æ¶åç«¯æ¶æ¯çæ¹æ³ï¼messageæ¯ææ¥æ¶çä¿¡æ¯çåç§°ï¼ååç«¯å¯¹åºãnamespaceæ¯æä¸ç±»çæ¶æ¯ï¼ååç«¯å¯¹åºãemitæ¯æååç«¯åéæ¶æ¯ï¼å¯¹åºçæ¶æ¯çåç§°ãæ°æ®ånamespaceã\n\né»è®¤çä¸¤ä¸ªäºä»¶ï¼connectådisconnectï¼å½websocketè¿æ¥æååå¤±è´¥æ¶ï¼èªå¨è§¦åè¿ä¸¤ä¸ªäºä»¶ã\n\n\nfrom flask import flask, render_template\nfrom flask_socketio import socketio\n\napp = flask(__name__)\napp.config['secret_key'] = 'secret!'\nsocketio = socketio(app)\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@socketio.on('message', namespace=\"/wechat\")\ndef handle_message(message):\n    print('received message: ' + message['data'])\n    socketio.emit(\"response\", {'age': 18}, namespace=\"/wechat\")\n\n@socketio.on('connect', namespace=\"/wechat\")\ndef connect():\n    print(\"connect..\")\n\n@socketio.on('disconnect', namespace=\"/wechat\")\ndef connect():\n    print(\"disconnect...\")\n\nif __name__ == '__main__':\n    socketio.run(app, port=8080)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\n\n# åºäºç±»çä½¿ç¨\n\nä¸é¢é½æ¯åºäºæ¹æ³ä½¿ç¨ï¼ä¸ªäººæè§å¦ææä½è¾å¤çæåµï¼æ¯è¾åä¹±ï¼ä½¿ç¨ç±»å»ç®¡çä¼æ´é½åæ¹ä¾¿å¾å¤ã\n\næå¡å¨æ¶å°çä»»ä½äºä»¶é½ä¼è¢«åéå°ä¸ä¸ªåä¸ºå¸¦æon_åç¼çäºä»¶åç§°çæ¹æ³ã\n\nè¿ä¸ªæ¡ä¾åä¸é¢åºäºæ¹æ³æ¯ä¸æ ·çï¼ä½æ¯æ´å æ¹ä¾¿ç®¡çäºï¼æ¯ä¸ªclassç®¡çä¸ä¸ªnamespaceã\n\n\nclass mycustomnamespace(namespace):\n\n    def on_connect(self):\n        print(\"è¿æ¥..\")\n        \n    def on_disconnect(self):\n        print(\"å³é­è¿æ¥\")\n        \n    def on_message(self, data):\n        print('received message: ' + data['data'])\n        self.emit(\"response\", {'age': 18})\n    \nsocketio.on_namespace(mycustomnamespace(\"/wechat\"))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"django-prometheusä½¿ç¨åæºç åæ",frontmatter:{title:"django-prometheusä½¿ç¨åæºç åæ",date:"2024-09-17T15:18:44.000Z",permalink:"/pages/4b0adb/",categories:["ç¼ç¨","python","django"],tags:["python","django"],author:{name:"zhengwenfeng",link:"https://www.zhengwenfeng.com"},description:"èæ¬æä¸»è¦æ¯ä»ç»ä½¿ç¨[django-prometheus](https://github.com/korfuri/django-prometheus)æ¥å¯¹djangoæå¡æ·»å å¯¹prometheusææ çæ¯æï¼å®å·²ç»åç½®äºé¨åçææ ééï¼åæ¬è¯·æ±ãæ°æ®åºåç¼å­ç­æ¹é¢çææ ãé¤äºä½¿ç¨æ¹æ³å¤ï¼ä¹ä¼å¯¹å¶æºç è¿è¡åæï¼çå®æ¯å¦ä½å®ç°çã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1726558982722image-20240917134902-uu4hpp3.png"},{name:"twitter:title",content:"django-prometheusä½¿ç¨åæºç åæ"},{name:"twitter:description",content:"èæ¬æä¸»è¦æ¯ä»ç»ä½¿ç¨[django-prometheus](https://github.com/korfuri/django-prometheus)æ¥å¯¹djangoæå¡æ·»å å¯¹prometheusææ çæ¯æï¼å®å·²ç»åç½®äºé¨åçææ ééï¼åæ¬è¯·æ±ãæ°æ®åºåç¼å­ç­æ¹é¢çææ ãé¤äºä½¿ç¨æ¹æ³å¤ï¼ä¹ä¼å¯¹å¶æºç è¿è¡åæï¼çå®æ¯å¦ä½å®ç°çã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1726558982722image-20240917134902-uu4hpp3.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/18.django-prometheus%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django-prometheusä½¿ç¨åæºç åæ"},{property:"og:description",content:"èæ¬æä¸»è¦æ¯ä»ç»ä½¿ç¨[django-prometheus](https://github.com/korfuri/django-prometheus)æ¥å¯¹djangoæå¡æ·»å å¯¹prometheusææ çæ¯æï¼å®å·²ç»åç½®äºé¨åçææ ééï¼åæ¬è¯·æ±ãæ°æ®åºåç¼å­ç­æ¹é¢çææ ãé¤äºä½¿ç¨æ¹æ³å¤ï¼ä¹ä¼å¯¹å¶æºç è¿è¡åæï¼çå®æ¯å¦ä½å®ç°çã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1726558982722image-20240917134902-uu4hpp3.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/18.django-prometheus%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2024-09-17T15:18:44.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"django"},{itemprop:"name",content:"django-prometheusä½¿ç¨åæºç åæ"},{itemprop:"description",content:"èæ¬æä¸»è¦æ¯ä»ç»ä½¿ç¨[django-prometheus](https://github.com/korfuri/django-prometheus)æ¥å¯¹djangoæå¡æ·»å å¯¹prometheusææ çæ¯æï¼å®å·²ç»åç½®äºé¨åçææ ééï¼åæ¬è¯·æ±ãæ°æ®åºåç¼å­ç­æ¹é¢çææ ãé¤äºä½¿ç¨æ¹æ³å¤ï¼ä¹ä¼å¯¹å¶æºç è¿è¡åæï¼çå®æ¯å¦ä½å®ç°çã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/1726558982722image-20240917134902-uu4hpp3.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/18.django-prometheus%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html",relativePath:"04.ç¼ç¨/01.python/06.django/18.django-prometheusä½¿ç¨åæºç åæ.md",key:"v-9c48962a",path:"/pages/4b0adb/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"è·åprometheusææ ",slug:"è·åprometheusææ ",normalizedTitle:"è·åprometheusææ ",charIndex:328},{level:3,title:"æ°å¢æ¥å£è·åææ ",slug:"æ°å¢æ¥å£è·åææ ",normalizedTitle:"æ°å¢æ¥å£è·åææ ",charIndex:347},{level:3,title:"å¨ä¸ç¨çº¿ç¨ä¸­è·åææ ",slug:"å¨ä¸ç¨çº¿ç¨ä¸­è·åææ ",normalizedTitle:"å¨ä¸ç¨çº¿ç¨ä¸­è·åææ ",charIndex:1520},{level:2,title:"è¯·æ±ææ ",slug:"è¯·æ±ææ ",normalizedTitle:"è¯·æ±ææ ",charIndex:2690},{level:2,title:"postgresææ ",slug:"postgresææ ",normalizedTitle:"postgresææ ",charIndex:7636},{level:3,title:"å¯¹insertãupdateãdeleteæä½è®¡æ°",slug:"å¯¹insertãupdateãdeleteæä½è®¡æ°",normalizedTitle:"å¯¹insertãupdateãdeleteæä½è®¡æ°",charIndex:7731},{level:3,title:"æ§è¡èæ¶",slug:"æ§è¡èæ¶",normalizedTitle:"æ§è¡èæ¶",charIndex:9516},{level:2,title:"redisææ ",slug:"redisææ ",normalizedTitle:"redisææ ",charIndex:13572},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:15321}],headersStr:"ç®ä» è·åprometheusææ  æ°å¢æ¥å£è·åææ  å¨ä¸ç¨çº¿ç¨ä¸­è·åææ  è¯·æ±ææ  postgresææ  å¯¹insertãupdateãdeleteæä½è®¡æ° æ§è¡èæ¶ redisææ  æ»ç»",content:'# ç®ä»\n\nå¨djangoæå¡è¿è¡è¿ç¨ä¸­ï¼å¸æå¯ä»¥å¯¹å¶è·åpromethuesææ è¿è¡çæ§ï¼è¿æ ·å¯ä»¥å®æ¶ç¥éå¶è¿è¡ç¶æï¼å½å®è¿è¡å¼å¸¸æ¶å¯ä»¥åæ¶è¿è¡åè­¦ï¼å¹¶ä¸å¸®å©æä»¬å¯ä»¥å¯¹å¶éå¯¹æ§è¿è¡ä¼åãæ¯å¦è¯·æ±éè¿å¤§æ¯å¦è¦è¿è¡éæµæèæ©å®¹ï¼åæèåç°æ¥å£è¿æ¢ï¼å¯è½æ¯æ°æ®åºè®¿é®å¤ªæ¢ï¼åºç°äºæ¢sqlï¼éè¦åæ¶è¿è¡ä¼åç­ç­ã\n\nèæ¬æä¸»è¦æ¯ä»ç»ä½¿ç¨django-prometheusæ¥å¯¹djangoæå¡æ·»å å¯¹prometheusææ çæ¯æï¼å®å·²ç»åç½®äºé¨åçææ ééï¼åæ¬è¯·æ±ãæ°æ®åºåç¼å­ç­æ¹é¢çææ ãé¤äºä½¿ç¨æ¹æ³å¤ï¼ä¹ä¼å¯¹å¶æºç è¿è¡åæï¼çå®æ¯å¦ä½å®ç°çã\n\næ¬æä¸­ä½¿ç¨çä¾å­å·²ç»ä¸ä¼ å°githubä¸­ï¼å¯ä»¥å¨django_demoä¸æ¥çï¼æ­éæ¬æç« å­¦ä¹ ã\n\nâ\n\n\n# è·åprometheusææ \n\n\n# æ°å¢æ¥å£è·åææ \n\nå¨url.pyä¸­æ°å¢ä¸é¢çè·¯ç±\n\npath(\'\', include(\'django_prometheus.urls\')),\n\n\n1\n\n\nç¶åè¿è¡æå¡ï¼è°ç¨/metricsæ¥å£ï¼å³å¯è·åå°é»è®¤çprometheusææ ä¿¡æ¯ã\n\n...\npython_gc_objects_collected_total{generation="0"} 667.0\npython_gc_objects_collected_total{generation="1"} 405.0\npython_gc_objects_collected_total{generation="2"} 19.0\n...\n\n\n1\n2\n3\n4\n5\n\n\næä»¬å¯ä»¥çä¸å¼ç¨ç django_prometheus.urlsæºç ï¼å®åå«äºä¸ä¸ªmetricsçè·¯ç±ï¼è°ç¨çæ¯ exports.ExportToDjangoViewæ¹æ³\n\nurlpatterns = [path("metrics", exports.ExportToDjangoView, name="prometheus-django-metrics")]\n\n\n1\n\n\nåççä¸ ExportToDjangoViewæ¹æ³ï¼è¿éæä¸ä¸ªåæ¯ï¼å¦æéç½®äºç¯å¢åéPROMETHEUS_MULTIPROC_DIRæè prometheus_multiproc_diråä¼èµ°å¤è¿ç¨æ¶éææ é»è¾ï¼å¦ååè¿ç¨ä¼åä»å¨å±åéREGISTRY ä¸­è·åææçææ ï¼æåè¿åååºã\n\ndef ExportToDjangoView(request):\n    if "PROMETHEUS_MULTIPROC_DIR" in os.environ or "prometheus_multiproc_dir" in os.environ:\n        registry = prometheus_client.CollectorRegistry()\n        multiprocess.MultiProcessCollector(registry)\n    else:\n        registry = prometheus_client.REGISTRY\n    metrics_page = prometheus_client.generate_latest(registry)\n    return HttpResponse(metrics_page, content_type=prometheus_client.CONTENT_TYPE_LATEST)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n> è¿éæ³¨æå¤è¿ç¨ä¸åè¿ç¨æ¶éææ çæ¹å¼æ¯ä¸ä¸æ ·çï¼å¤è¿ç¨æ¯ä»åä¸ªè¿ç¨çæä»¶è¯»åï¼èåè¿ç¨æ¯ä»å¨å±åéä¸­è¯»åã\n\nâ\n\n\n# å¨ä¸ç¨çº¿ç¨ä¸­è·åææ \n\nä¸é¢çæ¹æ³æ¯å¨djangoæå¡ä¸­è·åææ ï¼ä½å¦æä¸å¡bugå¯è½ä¼å¯¼è´çæ§åå°å½±åï¼åºç°æ æ³è·åå°ææ çæåµï¼è¿æ ·å°±æ æ³æä¾å®ä½é®é¢çå¸®å©ã\n\næä»¥æä¾äºä¸ç§æ¹å¼å¨åç¬ççº¿ç¨ä¸­æ¥è·åææ ï¼è¾¾å°è§£è¦çç®çï¼ä¿è¯å³ä½¿ä¸å¡å¼å¸¸ä¹ä¸ä¼å½±åææ çè·åã\n\nè¿ç§æ¹å¼é»è®¤æ¯å³é­çï¼éè¦å¨setting.pyä¸­æ·»å ä»¥ä¸åéå¯ç¨ï¼\n\nPROMETHEUS_METRICS_EXPORT_PORT = 8001\nPROMETHEUS_METRICS_EXPORT_ADDRESS = \'0.0.0.0\'  # all addresses\n\n\n1\n2\n\n\nç¶åéè¦å¨ INSTALLED_APPS ä¸­æ·»å  django_prometheus ï¼è¿æ¶å ä¸ºè¯¥çº¿ç¨æ¯å¨ DjangoPrometheusConfig.ready -> SetupPrometheusExportsFromConfig -> SetupPrometheusEndpointOnPort ä¸­è¢«è°ç¨çï¼éè¦å¼ç¨è¯¥appæä¼è¢«æ§è¡ã\n\nINSTALLED_APPS = [\n    ...\n    \'django_prometheus\',\n    \'demo\',\n]\n\n\n1\n2\n3\n4\n5\n\n\nåæ¥ç SetupPrometheusEndpointOnPort æ¹æ³å¯ä»¥çå°æ¯è°ç¨ prometheus_client.start_http_server æ¹æ³æ¥å¼å¯çº¿ç¨ï¼å¹¶æ´é²æå®ç PROMETHEUS_METRICS_EXPORT_PORT ç«¯å£ååè®¸è®¿é®ç PROMETHEUS_METRICS_EXPORT_ADDRESS å°åã\n\ndef SetupPrometheusEndpointOnPort(port, addr=""):\n    assert os.environ.get("RUN_MAIN") != "true", (\n        "The thread-based exporter can\'t be safely used when django\'s "\n        "autoreloader is active. Use the URL exporter, or start django "\n        "with --noreload. See documentation/exports.md."\n    )\n    prometheus_client.start_http_server(port, addr=addr)\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n> æ³¨æè¿éæä¸ä¸ªæ­è¨ï¼è¯¥ç§æ¹å¼ä¸æ¯æç­å è½½å¯å¨ã\n\næåè¿è¡æå¡ï¼éè¿è®¿é®ä¸é¢çéç½®ç8001ç«¯å£å³å¯è·åè¯¥æå¡çé»è®¤promethuesææ äºã\n\n\n# è¯·æ±ææ \n\néè¿ä¸é¢çæ­¥éª¤ï¼å·²ç»ç¥éäºå¦ä½éç½®è·åææ ä¿¡æ¯ï¼ç°å¨éè¦ç¥éå¦ä½è·åè¯·æ±è´¨éçææ ä¿¡æ¯ã\n\nè django_prometheus å·²ç»ç»æä»¬é»è®¤æä¾äºè¯·æ±ç¸å³çææ ä¿¡æ¯ï¼é¨åå¦ä¸ï¼\n\nææ                                                            è¯´æ                     é¶æ®µ\ndjango_http_requests_latency_including_middlewares_seconds   åå«middlewareçè¯·æ±æ¶é´ç´æ¹å¾   å¨å¼å§çmiddleware process_request\ndjango_http_requests_before_middlewares_total                è¯·æ±æ°                    å¨å¼å§çmiddleware process_request\ndjango_http_responses_before_middlewares_total               ååºæ°                    å¨å¼å§çmiddleware process_response\ndjango_http_requests_latency_seconds_by_view_method          viewå±è¯·æ±æ¶é´çç´æ¹å¾          å¨æåçmiddlewar process_request\ndjango_http_requests_total_by_method                         viewå±å¸¦æè¯·æ±æ¹æ³çè¯·æ±æ°        å¨æåçmiddlewar process_request\ndjango_http_requests_total_by_view_transport_method          viewå±çè¯·æ±æ°              å¨æåçmiddlewar process_view\nresponses_by_status_view_method                              viewå±çååºæ°              å¨æåçmiddlewar process_response\n\nä½¿ç¨æ¹æ³\n\nå¨ settings.py ä¸­ç MIDDLEWARE ä¸­æ·»å ä¸¤ä¸ªä¸­é´ä»¶ï¼éç½®å¦ä¸ï¼\n\nMIDDLEWARE = [\n    \'django_prometheus.middleware.PrometheusBeforeMiddleware\',\n  ...\n    \'django_prometheus.middleware.PrometheusAfterMiddleware\',\n]\n\n\n1\n2\n3\n4\n5\n\n\n> æ³¨æè¿éçé¡ºåºå¾éè¦ï¼ä¸å®è¦æ¯æ¾å¨MIDDLEWAREçç¬¬ä¸ä¸ªåæåä¸ä¸ªã\n\nå¨ view.py ä¸­æ°å¢ä¸ä¸ªæ¥å£ myview\n\ndef my_view(request):\n    return HttpResponse("hello")\n\n\n1\n2\n\n\nå¨ urls.py ä¸­æ°å¢ä¸æ¡è·¯ç±\n\npath(\'myview/\', my_view)\n\n\n1\n\n\næåä½ è¯·æ±æ¥å£ä¸æ¬¡è¯¥æ¥å£ï¼åè·åææ ï¼ä½ å¯ä»¥å¾å°é¨åè¯·æ±ææ çååã\n\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.01",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.025",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.05",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.075",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.1",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.25",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.5",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.75",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="1.0",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="2.5",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="5.0",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="7.5",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="10.0",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="25.0",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="50.0",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="75.0",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="+Inf",method="GET",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_count{method="GET",view="demo.views.my_view"} 1.0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå®ç°åç\n\nè¯·æ±è¿å¥ view å±ä¹åä¼åæç§é¡ºåºç»è¿ middlewareï¼ç¶ååå°viewè¿è¡æ§è¡ï¼æåååºçæ¶ååæç§éåºç»è¿ middlewareï¼å¦ä¸å¾æç¤ºï¼\n\n\n\nè middleware ä¸­ä¼æä¸ç³»åçé©å­å½æ°å¯ä»¥å¯¹è¯·æ±åä¸äºé¢å¤çå·¥ä½ï¼æ¯å¦è®¤è¯ç­ï¼èæä»¬çè¯·æ±ææ å°±æ¯å¨ middleware å±ä¸­å®ç°çã\n\nåç PrometheusBeforeMiddlewareï¼å®ç°äº process_request å process_response æ¹æ³ï¼è¿ä¸¤ä¸ªæ¹æ³å°±æ¯å¨ request è¿æ¥æ¶å response è¿åæ¶åå«ä¼è°ç¨çæ¹æ³ã\n\nclass PrometheusBeforeMiddleware(MiddlewareMixin):\n    metrics_cls = Metrics\n\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self.metrics = self.metrics_cls.get_instance()\n\n    def process_request(self, request):\n        self.metrics.requests_total.inc()\n        request.prometheus_before_middleware_event = Time()\n\n    def process_response(self, request, response):\n        self.metrics.responses_total.inc()\n        if hasattr(request, "prometheus_before_middleware_event"):\n            self.metrics.requests_latency_before.observe(TimeSince(request.prometheus_before_middleware_event))\n        else:\n            self.metrics.requests_unknown_latency_before.inc()\n        return response\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå¦ä¸å¾æç¤ºï¼\n\n\n\nå¨ process_request ä¸­å¯¹ requests_total è¿è¡éå¢ï¼å¨ process_response ä¸­å¯¹ responses_total ä¹è¿è¡éå¢ï¼è¿ä¸¤ä¸ªå°±æ¯è¿å¥æå¡çè¯·æ±æ»æ°åååºæ»æ°çææ ã\n\nåç process_request ä¸­è®°å½äºå½åçæ¶é´ prometheus_before_middleware_eventï¼ç¶åå¨ process_response ä¸­å°å½åæ¶é´ä¸ä¸ä¸ä¸ªæ¶é´è¿è¡ç¸åï¼ä¹å°±å¾å°äºä»è¯·æ±è¿æ¥å°ååºçæ´ä¸ªæ¶é´ï¼èµå¼ç»äº requests_latency_before ææ ä¸­ã\n\nèé¤äºéç½® PrometheusBeforeMiddleware å¤ï¼è¿éç½®äº PrometheusAfterMiddlewareï¼ä½åºæ¬åçé½æ¯ä¸æ ·çï¼é½æ¯éè¿ä¸­é´ä»¶å¨ä¸åé¶æ®µçé©å­æ¹æ³æ¥è¿è¡ææ çç»è®¡ï¼åªæ¯ç»è®¡çææ ä¸ä¸æ ·èå·²ã\n\nâ\n\n\n# postgresææ \n\næ¥ä¸æ¥å°±æ¯è®²å³äºæ°æ®åºçææ ï¼è¯¥åºæ¯æmysqlãsqliteåpostgresç­æ°æ®åºçæ¯æï¼ä½è¿éä¸»è¦æ¯å¯¹postgresä»ç»ï¼å¶ä»çä½¿ç¨æ¹æ³ä¹æ¯ç±»ä¼¼ã\n\n\n# å¯¹insertãupdateãdeleteæä½è®¡æ°\n\nä½¿ç¨æ¹æ³\n\nå¨ models.py ä¸­åå»º class Userï¼å¹¶ç»§æ¿ ExportModelOperationsMixinï¼è¿æ¯ä¸ä¸ªå¸¸è§çpythonè®¾è®¡æ¨¡å¼ï¼å¯ä»¥ç»å·²æçç±»é¢å¤çæ·»å åè½ã\n\nfrom django_prometheus.models import ExportModelOperationsMixin\n\nclass User(ExportModelOperationsMixin(\'User\'), models.Model):\n    class Meta:\n        db_table = \'t_user\'\n\n    id = models.AutoField(primary_key=True)\n    name = models.CharField()\n    age = models.IntegerField()\n    sex = models.CharField()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nç¶åå»ºè¡¨\n\npython manager.py makemigrations\npython manager.py migrate\n\n\n1\n2\n\n\nå¨view.pyæ°å¢æ¥å£my_view2\n\ndef my_view2(request):\n    User(name="zhangsan", age=12, sex="male").save()\n    return HttpResponse("hello")\n\n\n\n1\n2\n3\n4\n\n\nå¨url.pyæ°å¢è·¯ç±\n\npath(\'myview2/\', my_view2)\n\n\n1\n\n\nç¶åè¿è¡æå¡ï¼åè°ç¨/myview2æ¥å£ï¼åè·åææ å°±å¯ä»¥çå°å¯¹Userçæ°å¢è®¡æ°\n\ndjango_model_inserts_total{model="User"} 1.0\n\n\n1\n\n\nå®ç°åç\n\næä»¬çç ExportModelOperationsMixin ç±»ï¼å¯ä»¥çå°éé¢åå»ºäºä¸ä¸ª class Mixin å®éåäº _do_insertã _do_update ã delete ä¸ä¸ªæ¹æ³ï¼èè¿ä¸ä¸ªæ¹æ³æ¯ models.Model çæ¹æ³ï¼æ¯å¨å¯¹ model è¿è¡æå¥ãæ´æ°åå é¤æ¶æ§è¡çä¸ä¸ªæ¹æ³ï¼èè¿ééåæ¯å¨æ§è¡è¿äºæä½åï¼ä½¿ç¨ææ åéè¿è¡éå¢ï¼è¿æ ·å°±è®°å½äºæ¬¡æ°ã\n\ndef ExportModelOperationsMixin(model_name):\n    model_inserts.labels(model_name)\n    model_updates.labels(model_name)\n    model_deletes.labels(model_name)\n\n    class Mixin:\n        def _do_insert(self, *args, **kwargs):\n            model_inserts.labels(model_name).inc()\n            return super()._do_insert(*args, **kwargs)\n\n        def _do_update(self, *args, **kwargs):\n            model_updates.labels(model_name).inc()\n            return super()._do_update(*args, **kwargs)\n\n        def delete(self, *args, **kwargs):\n            model_deletes.labels(model_name).inc()\n            return super().delete(*args, **kwargs)\n\n    Mixin.__qualname__ = f"ExportModelOperationsMixin(\'{model_name}\')"\n    return Mixin\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\n\n# æ§è¡èæ¶\n\né¤äºæ§è¡æ¬¡æ°å¤ï¼æä»¬è¿æ³ç¥éæ°æ®åºæ§è¡çèæ¶ã\n\nä½¿ç¨æ¹æ³\n\nå¨ settings.py ä¸­ï¼å° DATABSE ä¸­ç engine æ¢æ django_prometheus.db.backends.postgresql\n\nDATABASES = {\n    \'default\': {\n        \'ENGINE\': \'django_prometheus.db.backends.postgresql\',\n    ...\n    }\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nç¶åå°±å¯ä»¥åæ¬¡è°ç¨æ¥å£ myview2 å¯¹ User è¿è¡æä½ï¼åè·åææ å¯ä»¥çå°å¯¹ postgres çèæ¶çä¸ä¸ªç´æ¹å¾ææ ã\n\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.01",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.025",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.05",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.075",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.1",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.25",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.5",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.75",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="1.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="2.5",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="5.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="7.5",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="10.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="25.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="50.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="75.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="+Inf",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_count{alias="default",vendor="postgresql"} 3.0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå®ç°åç\n\næä»¬çå django_prometheus/db/backends/postgresql/base.py æä»¶ï¼å¯ä»¥çå° DatabaseWrapper ç±»ï¼èè¯¥ç±»éåäº get_new_connection æ¹æ³ï¼å®ç®çæ¯å¨åå»ºæ°æ®åºè¿æ¥æ¶ï¼å°åç½®ä½¿ç¨çcursoræ¿æ¢æèªå·±å®ä¹ç ExportingCursorWrapper\n\nclass DatabaseWrapper(DatabaseWrapperMixin, base.DatabaseWrapper):\n    def get_new_connection(self, *args, **kwargs):\n        conn = super().get_new_connection(*args, **kwargs)\n        conn.cursor_factory = ExportingCursorWrapper(\n            conn.cursor_factory or get_postgres_cursor_class(), self.alias, self.vendor\n        )\n        return conn\n\n    def create_cursor(self, name=None):\n        # cursor_factory is a kwarg to connect() so restore create_cursor()\'s\n        # default behavior\n        return base.DatabaseWrapper.create_cursor(self, name=name)\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåçå class ExportingCursorWrapperï¼éé¢å®ä¹äº class CursorWrapperï¼éåäº execute å executemany ä¸¤ä¸ªæ¹æ³ï¼æ¯å¨æ§è¡sqlæ¶ä¼è°ç¨çæ¹æ³ï¼èå¨è°ç¨ç¶ç±»æ§è¡sqlååè¿è¡ç»è®¡è®¡æ°åèæ¶ã\n\ndef ExportingCursorWrapper(cursor_class, alias, vendor):\n    labels = {"alias": alias, "vendor": vendor}\n\n    class CursorWrapper(cursor_class):\n        def execute(self, *args, **kwargs):\n            execute_total.labels(alias, vendor).inc()\n            with query_duration_seconds.labels(**labels).time(), ExceptionCounterByType(\n                errors_total, extra_labels=labels\n            ):\n                return super().execute(*args, **kwargs)\n\n        def executemany(self, query, param_list, *args, **kwargs):\n            execute_total.labels(alias, vendor).inc(len(param_list))\n            execute_many_total.labels(alias, vendor).inc(len(param_list))\n            with query_duration_seconds.labels(**labels).time(), ExceptionCounterByType(\n                errors_total, extra_labels=labels\n            ):\n                return super().executemany(query, param_list, *args, **kwargs)\n\n    return CursorWrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nææ åè¡¨\n\nææ                                  è¯´æ\ndjango_db_query_duration_seconds   æ°æ®åºææçæä½èæ¶ï¼åå«äºå¢å æ¹æ¥\ndjango_db_new_connections_total    æ°æ®åºåå»ºçè¿æ¥æ°\nexecute_total                      æ°æ®åºæ§è¡æ»æ°\n\nâ\n\n\n# redisææ \n\nä½¿ç¨æ¹æ³\n\nå¨ settings.py ä¸­éç½®redis\n\nCACHES = {\n    \'default\': {\n        \'BACKEND\': \'django_prometheus.cache.backends.redis.RedisCache\',\n        \'LOCATION\': \'redis://127.0.0.1:6379\'\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨ view.py ä¸­æ°å¢ my_view3 æ¥å£ï¼å¯¹redisè¿è¡æä½\n\ndef my_view3(request):\n    cache.set("name", "zhangsan")\n    return HttpResponse(cache.get("name"))\n\n\n1\n2\n3\n\n\nå¨url.pyä¸­æ°å¢å¯¹åºè·¯ç±\n\npath(\'myview3/\', my_view3)\n\n\n1\n\n\nè°ç¨æ¥å£ /myview3 æ¥å£ï¼ç¶åè·åææ ï¼å°±å¯ä»¥çå°redisç¸å³çææ åæ°\n\ndjango_cache_get_total{backend="redis"} 1.0\ndjango_cache_get_created{backend="redis"} 1.7265568108417125e+09\ndjango_cache_get_hits_total{backend="redis"} 1.0\ndjango_cache_get_hits_created{backend="redis"} 1.726556810842234e+09\n\n\n1\n2\n3\n4\n\n\nå®ç°åç\n\næä»¬çå° django_prometheus/cache/backends/redis.py ä¸­çclass RedisCacheï¼è¯¥ç±»ç»§æ¿äºå·²æçç¼å­ç±» cache.RedisCacheï¼éåäºæ¹æ³getï¼å¨è°ç¨ç¶ç±»æä½æ¹æ³çååæ·»å ææ ã\n\nclass RedisCache(cache.RedisCache):\n    @cache.omit_exception\n    def get(self, key, default=None, version=None, client=None):\n        try:\n            django_cache_get_total.labels(backend="redis").inc()\n            cached = self.client.get(key, default=None, version=version, client=client)\n        except exceptions.ConnectionInterrupted as e:\n            django_cache_get_fail_total.labels(backend="redis").inc()\n            if self._ignore_exceptions:\n                if self._log_ignored_exceptions:\n                    cache.logger.error(str(e))\n                return default\n            raise\n        else:\n            if cached is not None:\n                django_cache_hits_total.labels(backend="redis").inc()\n                return cached\n            else:\n                django_cache_misses_total.labels(backend="redis").inc()\n                return default\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nâ\n\n\n# æ»ç»\n\ndjango-prometheus æ¯å¨ååççè§£äºdjangoæ¬èº«çæºå¶ä¸ï¼éè¿å·²æä¾çé©å­ï¼æèéåé¨åçæ¹æ³ï¼æ¿æ¢æåç½®çç»ä»¶çæ¹å¼ï¼æ¥è¾¾å°èªå·±çç®çï¼è¿ç§æ¹æ³å¼å¾åèä¸å­¦ä¹ ã\n\nâ',normalizedContent:'# ç®ä»\n\nå¨djangoæå¡è¿è¡è¿ç¨ä¸­ï¼å¸æå¯ä»¥å¯¹å¶è·åpromethuesææ è¿è¡çæ§ï¼è¿æ ·å¯ä»¥å®æ¶ç¥éå¶è¿è¡ç¶æï¼å½å®è¿è¡å¼å¸¸æ¶å¯ä»¥åæ¶è¿è¡åè­¦ï¼å¹¶ä¸å¸®å©æä»¬å¯ä»¥å¯¹å¶éå¯¹æ§è¿è¡ä¼åãæ¯å¦è¯·æ±éè¿å¤§æ¯å¦è¦è¿è¡éæµæèæ©å®¹ï¼åæèåç°æ¥å£è¿æ¢ï¼å¯è½æ¯æ°æ®åºè®¿é®å¤ªæ¢ï¼åºç°äºæ¢sqlï¼éè¦åæ¶è¿è¡ä¼åç­ç­ã\n\nèæ¬æä¸»è¦æ¯ä»ç»ä½¿ç¨django-prometheusæ¥å¯¹djangoæå¡æ·»å å¯¹prometheusææ çæ¯æï¼å®å·²ç»åç½®äºé¨åçææ ééï¼åæ¬è¯·æ±ãæ°æ®åºåç¼å­ç­æ¹é¢çææ ãé¤äºä½¿ç¨æ¹æ³å¤ï¼ä¹ä¼å¯¹å¶æºç è¿è¡åæï¼çå®æ¯å¦ä½å®ç°çã\n\næ¬æä¸­ä½¿ç¨çä¾å­å·²ç»ä¸ä¼ å°githubä¸­ï¼å¯ä»¥å¨django_demoä¸æ¥çï¼æ­éæ¬æç« å­¦ä¹ ã\n\nâ\n\n\n# è·åprometheusææ \n\n\n# æ°å¢æ¥å£è·åææ \n\nå¨url.pyä¸­æ°å¢ä¸é¢çè·¯ç±\n\npath(\'\', include(\'django_prometheus.urls\')),\n\n\n1\n\n\nç¶åè¿è¡æå¡ï¼è°ç¨/metricsæ¥å£ï¼å³å¯è·åå°é»è®¤çprometheusææ ä¿¡æ¯ã\n\n...\npython_gc_objects_collected_total{generation="0"} 667.0\npython_gc_objects_collected_total{generation="1"} 405.0\npython_gc_objects_collected_total{generation="2"} 19.0\n...\n\n\n1\n2\n3\n4\n5\n\n\næä»¬å¯ä»¥çä¸å¼ç¨ç django_prometheus.urlsæºç ï¼å®åå«äºä¸ä¸ªmetricsçè·¯ç±ï¼è°ç¨çæ¯ exports.exporttodjangoviewæ¹æ³\n\nurlpatterns = [path("metrics", exports.exporttodjangoview, name="prometheus-django-metrics")]\n\n\n1\n\n\nåççä¸ exporttodjangoviewæ¹æ³ï¼è¿éæä¸ä¸ªåæ¯ï¼å¦æéç½®äºç¯å¢åéprometheus_multiproc_diræè prometheus_multiproc_diråä¼èµ°å¤è¿ç¨æ¶éææ é»è¾ï¼å¦ååè¿ç¨ä¼åä»å¨å±åéregistry ä¸­è·åææçææ ï¼æåè¿åååºã\n\ndef exporttodjangoview(request):\n    if "prometheus_multiproc_dir" in os.environ or "prometheus_multiproc_dir" in os.environ:\n        registry = prometheus_client.collectorregistry()\n        multiprocess.multiprocesscollector(registry)\n    else:\n        registry = prometheus_client.registry\n    metrics_page = prometheus_client.generate_latest(registry)\n    return httpresponse(metrics_page, content_type=prometheus_client.content_type_latest)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n> è¿éæ³¨æå¤è¿ç¨ä¸åè¿ç¨æ¶éææ çæ¹å¼æ¯ä¸ä¸æ ·çï¼å¤è¿ç¨æ¯ä»åä¸ªè¿ç¨çæä»¶è¯»åï¼èåè¿ç¨æ¯ä»å¨å±åéä¸­è¯»åã\n\nâ\n\n\n# å¨ä¸ç¨çº¿ç¨ä¸­è·åææ \n\nä¸é¢çæ¹æ³æ¯å¨djangoæå¡ä¸­è·åææ ï¼ä½å¦æä¸å¡bugå¯è½ä¼å¯¼è´çæ§åå°å½±åï¼åºç°æ æ³è·åå°ææ çæåµï¼è¿æ ·å°±æ æ³æä¾å®ä½é®é¢çå¸®å©ã\n\næä»¥æä¾äºä¸ç§æ¹å¼å¨åç¬ççº¿ç¨ä¸­æ¥è·åææ ï¼è¾¾å°è§£è¦çç®çï¼ä¿è¯å³ä½¿ä¸å¡å¼å¸¸ä¹ä¸ä¼å½±åææ çè·åã\n\nè¿ç§æ¹å¼é»è®¤æ¯å³é­çï¼éè¦å¨setting.pyä¸­æ·»å ä»¥ä¸åéå¯ç¨ï¼\n\nprometheus_metrics_export_port = 8001\nprometheus_metrics_export_address = \'0.0.0.0\'  # all addresses\n\n\n1\n2\n\n\nç¶åéè¦å¨ installed_apps ä¸­æ·»å  django_prometheus ï¼è¿æ¶å ä¸ºè¯¥çº¿ç¨æ¯å¨ djangoprometheusconfig.ready -> setupprometheusexportsfromconfig -> setupprometheusendpointonport ä¸­è¢«è°ç¨çï¼éè¦å¼ç¨è¯¥appæä¼è¢«æ§è¡ã\n\ninstalled_apps = [\n    ...\n    \'django_prometheus\',\n    \'demo\',\n]\n\n\n1\n2\n3\n4\n5\n\n\nåæ¥ç setupprometheusendpointonport æ¹æ³å¯ä»¥çå°æ¯è°ç¨ prometheus_client.start_http_server æ¹æ³æ¥å¼å¯çº¿ç¨ï¼å¹¶æ´é²æå®ç prometheus_metrics_export_port ç«¯å£ååè®¸è®¿é®ç prometheus_metrics_export_address å°åã\n\ndef setupprometheusendpointonport(port, addr=""):\n    assert os.environ.get("run_main") != "true", (\n        "the thread-based exporter can\'t be safely used when django\'s "\n        "autoreloader is active. use the url exporter, or start django "\n        "with --noreload. see documentation/exports.md."\n    )\n    prometheus_client.start_http_server(port, addr=addr)\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n> æ³¨æè¿éæä¸ä¸ªæ­è¨ï¼è¯¥ç§æ¹å¼ä¸æ¯æç­å è½½å¯å¨ã\n\næåè¿è¡æå¡ï¼éè¿è®¿é®ä¸é¢çéç½®ç8001ç«¯å£å³å¯è·åè¯¥æå¡çé»è®¤promethuesææ äºã\n\n\n# è¯·æ±ææ \n\néè¿ä¸é¢çæ­¥éª¤ï¼å·²ç»ç¥éäºå¦ä½éç½®è·åææ ä¿¡æ¯ï¼ç°å¨éè¦ç¥éå¦ä½è·åè¯·æ±è´¨éçææ ä¿¡æ¯ã\n\nè django_prometheus å·²ç»ç»æä»¬é»è®¤æä¾äºè¯·æ±ç¸å³çææ ä¿¡æ¯ï¼é¨åå¦ä¸ï¼\n\nææ                                                            è¯´æ                     é¶æ®µ\ndjango_http_requests_latency_including_middlewares_seconds   åå«middlewareçè¯·æ±æ¶é´ç´æ¹å¾   å¨å¼å§çmiddleware process_request\ndjango_http_requests_before_middlewares_total                è¯·æ±æ°                    å¨å¼å§çmiddleware process_request\ndjango_http_responses_before_middlewares_total               ååºæ°                    å¨å¼å§çmiddleware process_response\ndjango_http_requests_latency_seconds_by_view_method          viewå±è¯·æ±æ¶é´çç´æ¹å¾          å¨æåçmiddlewar process_request\ndjango_http_requests_total_by_method                         viewå±å¸¦æè¯·æ±æ¹æ³çè¯·æ±æ°        å¨æåçmiddlewar process_request\ndjango_http_requests_total_by_view_transport_method          viewå±çè¯·æ±æ°              å¨æåçmiddlewar process_view\nresponses_by_status_view_method                              viewå±çååºæ°              å¨æåçmiddlewar process_response\n\nä½¿ç¨æ¹æ³\n\nå¨ settings.py ä¸­ç middleware ä¸­æ·»å ä¸¤ä¸ªä¸­é´ä»¶ï¼éç½®å¦ä¸ï¼\n\nmiddleware = [\n    \'django_prometheus.middleware.prometheusbeforemiddleware\',\n  ...\n    \'django_prometheus.middleware.prometheusaftermiddleware\',\n]\n\n\n1\n2\n3\n4\n5\n\n\n> æ³¨æè¿éçé¡ºåºå¾éè¦ï¼ä¸å®è¦æ¯æ¾å¨middlewareçç¬¬ä¸ä¸ªåæåä¸ä¸ªã\n\nå¨ view.py ä¸­æ°å¢ä¸ä¸ªæ¥å£ myview\n\ndef my_view(request):\n    return httpresponse("hello")\n\n\n1\n2\n\n\nå¨ urls.py ä¸­æ°å¢ä¸æ¡è·¯ç±\n\npath(\'myview/\', my_view)\n\n\n1\n\n\næåä½ è¯·æ±æ¥å£ä¸æ¬¡è¯¥æ¥å£ï¼åè·åææ ï¼ä½ å¯ä»¥å¾å°é¨åè¯·æ±ææ çååã\n\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.01",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.025",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.05",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.075",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.1",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.25",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.5",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="0.75",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="1.0",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="2.5",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="5.0",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="7.5",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="10.0",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="25.0",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="50.0",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="75.0",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_bucket{le="+inf",method="get",view="demo.views.my_view"} 1.0\ndjango_http_requests_latency_seconds_by_view_method_count{method="get",view="demo.views.my_view"} 1.0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå®ç°åç\n\nè¯·æ±è¿å¥ view å±ä¹åä¼åæç§é¡ºåºç»è¿ middlewareï¼ç¶ååå°viewè¿è¡æ§è¡ï¼æåååºçæ¶ååæç§éåºç»è¿ middlewareï¼å¦ä¸å¾æç¤ºï¼\n\n\n\nè middleware ä¸­ä¼æä¸ç³»åçé©å­å½æ°å¯ä»¥å¯¹è¯·æ±åä¸äºé¢å¤çå·¥ä½ï¼æ¯å¦è®¤è¯ç­ï¼èæä»¬çè¯·æ±ææ å°±æ¯å¨ middleware å±ä¸­å®ç°çã\n\nåç prometheusbeforemiddlewareï¼å®ç°äº process_request å process_response æ¹æ³ï¼è¿ä¸¤ä¸ªæ¹æ³å°±æ¯å¨ request è¿æ¥æ¶å response è¿åæ¶åå«ä¼è°ç¨çæ¹æ³ã\n\nclass prometheusbeforemiddleware(middlewaremixin):\n    metrics_cls = metrics\n\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self.metrics = self.metrics_cls.get_instance()\n\n    def process_request(self, request):\n        self.metrics.requests_total.inc()\n        request.prometheus_before_middleware_event = time()\n\n    def process_response(self, request, response):\n        self.metrics.responses_total.inc()\n        if hasattr(request, "prometheus_before_middleware_event"):\n            self.metrics.requests_latency_before.observe(timesince(request.prometheus_before_middleware_event))\n        else:\n            self.metrics.requests_unknown_latency_before.inc()\n        return response\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå¦ä¸å¾æç¤ºï¼\n\n\n\nå¨ process_request ä¸­å¯¹ requests_total è¿è¡éå¢ï¼å¨ process_response ä¸­å¯¹ responses_total ä¹è¿è¡éå¢ï¼è¿ä¸¤ä¸ªå°±æ¯è¿å¥æå¡çè¯·æ±æ»æ°åååºæ»æ°çææ ã\n\nåç process_request ä¸­è®°å½äºå½åçæ¶é´ prometheus_before_middleware_eventï¼ç¶åå¨ process_response ä¸­å°å½åæ¶é´ä¸ä¸ä¸ä¸ªæ¶é´è¿è¡ç¸åï¼ä¹å°±å¾å°äºä»è¯·æ±è¿æ¥å°ååºçæ´ä¸ªæ¶é´ï¼èµå¼ç»äº requests_latency_before ææ ä¸­ã\n\nèé¤äºéç½® prometheusbeforemiddleware å¤ï¼è¿éç½®äº prometheusaftermiddlewareï¼ä½åºæ¬åçé½æ¯ä¸æ ·çï¼é½æ¯éè¿ä¸­é´ä»¶å¨ä¸åé¶æ®µçé©å­æ¹æ³æ¥è¿è¡ææ çç»è®¡ï¼åªæ¯ç»è®¡çææ ä¸ä¸æ ·èå·²ã\n\nâ\n\n\n# postgresææ \n\næ¥ä¸æ¥å°±æ¯è®²å³äºæ°æ®åºçææ ï¼è¯¥åºæ¯æmysqlãsqliteåpostgresç­æ°æ®åºçæ¯æï¼ä½è¿éä¸»è¦æ¯å¯¹postgresä»ç»ï¼å¶ä»çä½¿ç¨æ¹æ³ä¹æ¯ç±»ä¼¼ã\n\n\n# å¯¹insertãupdateãdeleteæä½è®¡æ°\n\nä½¿ç¨æ¹æ³\n\nå¨ models.py ä¸­åå»º class userï¼å¹¶ç»§æ¿ exportmodeloperationsmixinï¼è¿æ¯ä¸ä¸ªå¸¸è§çpythonè®¾è®¡æ¨¡å¼ï¼å¯ä»¥ç»å·²æçç±»é¢å¤çæ·»å åè½ã\n\nfrom django_prometheus.models import exportmodeloperationsmixin\n\nclass user(exportmodeloperationsmixin(\'user\'), models.model):\n    class meta:\n        db_table = \'t_user\'\n\n    id = models.autofield(primary_key=true)\n    name = models.charfield()\n    age = models.integerfield()\n    sex = models.charfield()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nç¶åå»ºè¡¨\n\npython manager.py makemigrations\npython manager.py migrate\n\n\n1\n2\n\n\nå¨view.pyæ°å¢æ¥å£my_view2\n\ndef my_view2(request):\n    user(name="zhangsan", age=12, sex="male").save()\n    return httpresponse("hello")\n\n\n\n1\n2\n3\n4\n\n\nå¨url.pyæ°å¢è·¯ç±\n\npath(\'myview2/\', my_view2)\n\n\n1\n\n\nç¶åè¿è¡æå¡ï¼åè°ç¨/myview2æ¥å£ï¼åè·åææ å°±å¯ä»¥çå°å¯¹userçæ°å¢è®¡æ°\n\ndjango_model_inserts_total{model="user"} 1.0\n\n\n1\n\n\nå®ç°åç\n\næä»¬çç exportmodeloperationsmixin ç±»ï¼å¯ä»¥çå°éé¢åå»ºäºä¸ä¸ª class mixin å®éåäº _do_insertã _do_update ã delete ä¸ä¸ªæ¹æ³ï¼èè¿ä¸ä¸ªæ¹æ³æ¯ models.model çæ¹æ³ï¼æ¯å¨å¯¹ model è¿è¡æå¥ãæ´æ°åå é¤æ¶æ§è¡çä¸ä¸ªæ¹æ³ï¼èè¿ééåæ¯å¨æ§è¡è¿äºæä½åï¼ä½¿ç¨ææ åéè¿è¡éå¢ï¼è¿æ ·å°±è®°å½äºæ¬¡æ°ã\n\ndef exportmodeloperationsmixin(model_name):\n    model_inserts.labels(model_name)\n    model_updates.labels(model_name)\n    model_deletes.labels(model_name)\n\n    class mixin:\n        def _do_insert(self, *args, **kwargs):\n            model_inserts.labels(model_name).inc()\n            return super()._do_insert(*args, **kwargs)\n\n        def _do_update(self, *args, **kwargs):\n            model_updates.labels(model_name).inc()\n            return super()._do_update(*args, **kwargs)\n\n        def delete(self, *args, **kwargs):\n            model_deletes.labels(model_name).inc()\n            return super().delete(*args, **kwargs)\n\n    mixin.__qualname__ = f"exportmodeloperationsmixin(\'{model_name}\')"\n    return mixin\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\n\n# æ§è¡èæ¶\n\né¤äºæ§è¡æ¬¡æ°å¤ï¼æä»¬è¿æ³ç¥éæ°æ®åºæ§è¡çèæ¶ã\n\nä½¿ç¨æ¹æ³\n\nå¨ settings.py ä¸­ï¼å° databse ä¸­ç engine æ¢æ django_prometheus.db.backends.postgresql\n\ndatabases = {\n    \'default\': {\n        \'engine\': \'django_prometheus.db.backends.postgresql\',\n    ...\n    }\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nç¶åå°±å¯ä»¥åæ¬¡è°ç¨æ¥å£ myview2 å¯¹ user è¿è¡æä½ï¼åè·åææ å¯ä»¥çå°å¯¹ postgres çèæ¶çä¸ä¸ªç´æ¹å¾ææ ã\n\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.01",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.025",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.05",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.075",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.1",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.25",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.5",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="0.75",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="1.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="2.5",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="5.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="7.5",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="10.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="25.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="50.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="75.0",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_bucket{alias="default",le="+inf",vendor="postgresql"} 3.0\ndjango_db_query_duration_seconds_count{alias="default",vendor="postgresql"} 3.0\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nå®ç°åç\n\næä»¬çå django_prometheus/db/backends/postgresql/base.py æä»¶ï¼å¯ä»¥çå° databasewrapper ç±»ï¼èè¯¥ç±»éåäº get_new_connection æ¹æ³ï¼å®ç®çæ¯å¨åå»ºæ°æ®åºè¿æ¥æ¶ï¼å°åç½®ä½¿ç¨çcursoræ¿æ¢æèªå·±å®ä¹ç exportingcursorwrapper\n\nclass databasewrapper(databasewrappermixin, base.databasewrapper):\n    def get_new_connection(self, *args, **kwargs):\n        conn = super().get_new_connection(*args, **kwargs)\n        conn.cursor_factory = exportingcursorwrapper(\n            conn.cursor_factory or get_postgres_cursor_class(), self.alias, self.vendor\n        )\n        return conn\n\n    def create_cursor(self, name=none):\n        # cursor_factory is a kwarg to connect() so restore create_cursor()\'s\n        # default behavior\n        return base.databasewrapper.create_cursor(self, name=name)\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåçå class exportingcursorwrapperï¼éé¢å®ä¹äº class cursorwrapperï¼éåäº execute å executemany ä¸¤ä¸ªæ¹æ³ï¼æ¯å¨æ§è¡sqlæ¶ä¼è°ç¨çæ¹æ³ï¼èå¨è°ç¨ç¶ç±»æ§è¡sqlååè¿è¡ç»è®¡è®¡æ°åèæ¶ã\n\ndef exportingcursorwrapper(cursor_class, alias, vendor):\n    labels = {"alias": alias, "vendor": vendor}\n\n    class cursorwrapper(cursor_class):\n        def execute(self, *args, **kwargs):\n            execute_total.labels(alias, vendor).inc()\n            with query_duration_seconds.labels(**labels).time(), exceptioncounterbytype(\n                errors_total, extra_labels=labels\n            ):\n                return super().execute(*args, **kwargs)\n\n        def executemany(self, query, param_list, *args, **kwargs):\n            execute_total.labels(alias, vendor).inc(len(param_list))\n            execute_many_total.labels(alias, vendor).inc(len(param_list))\n            with query_duration_seconds.labels(**labels).time(), exceptioncounterbytype(\n                errors_total, extra_labels=labels\n            ):\n                return super().executemany(query, param_list, *args, **kwargs)\n\n    return cursorwrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nææ åè¡¨\n\nææ                                  è¯´æ\ndjango_db_query_duration_seconds   æ°æ®åºææçæä½èæ¶ï¼åå«äºå¢å æ¹æ¥\ndjango_db_new_connections_total    æ°æ®åºåå»ºçè¿æ¥æ°\nexecute_total                      æ°æ®åºæ§è¡æ»æ°\n\nâ\n\n\n# redisææ \n\nä½¿ç¨æ¹æ³\n\nå¨ settings.py ä¸­éç½®redis\n\ncaches = {\n    \'default\': {\n        \'backend\': \'django_prometheus.cache.backends.redis.rediscache\',\n        \'location\': \'redis://127.0.0.1:6379\'\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨ view.py ä¸­æ°å¢ my_view3 æ¥å£ï¼å¯¹redisè¿è¡æä½\n\ndef my_view3(request):\n    cache.set("name", "zhangsan")\n    return httpresponse(cache.get("name"))\n\n\n1\n2\n3\n\n\nå¨url.pyä¸­æ°å¢å¯¹åºè·¯ç±\n\npath(\'myview3/\', my_view3)\n\n\n1\n\n\nè°ç¨æ¥å£ /myview3 æ¥å£ï¼ç¶åè·åææ ï¼å°±å¯ä»¥çå°redisç¸å³çææ åæ°\n\ndjango_cache_get_total{backend="redis"} 1.0\ndjango_cache_get_created{backend="redis"} 1.7265568108417125e+09\ndjango_cache_get_hits_total{backend="redis"} 1.0\ndjango_cache_get_hits_created{backend="redis"} 1.726556810842234e+09\n\n\n1\n2\n3\n4\n\n\nå®ç°åç\n\næä»¬çå° django_prometheus/cache/backends/redis.py ä¸­çclass rediscacheï¼è¯¥ç±»ç»§æ¿äºå·²æçç¼å­ç±» cache.rediscacheï¼éåäºæ¹æ³getï¼å¨è°ç¨ç¶ç±»æä½æ¹æ³çååæ·»å ææ ã\n\nclass rediscache(cache.rediscache):\n    @cache.omit_exception\n    def get(self, key, default=none, version=none, client=none):\n        try:\n            django_cache_get_total.labels(backend="redis").inc()\n            cached = self.client.get(key, default=none, version=version, client=client)\n        except exceptions.connectioninterrupted as e:\n            django_cache_get_fail_total.labels(backend="redis").inc()\n            if self._ignore_exceptions:\n                if self._log_ignored_exceptions:\n                    cache.logger.error(str(e))\n                return default\n            raise\n        else:\n            if cached is not none:\n                django_cache_hits_total.labels(backend="redis").inc()\n                return cached\n            else:\n                django_cache_misses_total.labels(backend="redis").inc()\n                return default\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nâ\n\n\n# æ»ç»\n\ndjango-prometheus æ¯å¨ååççè§£äºdjangoæ¬èº«çæºå¶ä¸ï¼éè¿å·²æä¾çé©å­ï¼æèéåé¨åçæ¹æ³ï¼æ¿æ¢æåç½®çç»ä»¶çæ¹å¼ï¼æ¥è¾¾å°èªå·±çç®çï¼è¿ç§æ¹æ³å¼å¾åèä¸å­¦ä¹ ã\n\nâ',charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"django rest_framework åé¡µ",frontmatter:{title:"django rest_framework åé¡µ",date:"2023-03-20T11:32:52.000Z",permalink:"/pages/cb262f/",categories:["ç¼ç¨","python","django"],tags:[null],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä¸»è¦ä»ç»å¨drfæ¡æ¶ä¸­å¦ä½å¯¹æ¥è¯¢çæ°æ®è¿è¡åé¡µï¼å¨drfæ¡æ¶ä¸­ææä¾è¯¥åºç¡åè½çä½¿ç¨æ¡ä¾åææ¡£ï¼è¯¦æåèdrf-pagination-å®ç½ææ¡£",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"django rest_framework åé¡µ"},{name:"twitter:description",content:"æ¬æä¸»è¦ä»ç»å¨drfæ¡æ¶ä¸­å¦ä½å¯¹æ¥è¯¢çæ°æ®è¿è¡åé¡µï¼å¨drfæ¡æ¶ä¸­ææä¾è¯¥åºç¡åè½çä½¿ç¨æ¡ä¾åææ¡£ï¼è¯¦æåèdrf-pagination-å®ç½ææ¡£"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/17.django%20rest_framework%20%E5%88%86%E9%A1%B5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"django rest_framework åé¡µ"},{property:"og:description",content:"æ¬æä¸»è¦ä»ç»å¨drfæ¡æ¶ä¸­å¦ä½å¯¹æ¥è¯¢çæ°æ®è¿è¡åé¡µï¼å¨drfæ¡æ¶ä¸­ææä¾è¯¥åºç¡åè½çä½¿ç¨æ¡ä¾åææ¡£ï¼è¯¦æåèdrf-pagination-å®ç½ææ¡£"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/06.django/17.django%20rest_framework%20%E5%88%86%E9%A1%B5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-03-20T11:32:52.000Z"},{property:"article:tag",content:null},{itemprop:"name",content:"django rest_framework åé¡µ"},{itemprop:"description",content:"æ¬æä¸»è¦ä»ç»å¨drfæ¡æ¶ä¸­å¦ä½å¯¹æ¥è¯¢çæ°æ®è¿è¡åé¡µï¼å¨drfæ¡æ¶ä¸­ææä¾è¯¥åºç¡åè½çä½¿ç¨æ¡ä¾åææ¡£ï¼è¯¦æåèdrf-pagination-å®ç½ææ¡£"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/06.django/17.django%20rest_framework%20%E5%88%86%E9%A1%B5.html",relativePath:"04.ç¼ç¨/01.python/06.django/17.django rest_framework åé¡µ.md",key:"v-ff2c286e",path:"/pages/cb262f/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"åç½®åé¡µæ¹å¼",slug:"åç½®åé¡µæ¹å¼",normalizedTitle:"åç½®åé¡µæ¹å¼",charIndex:84},{level:2,title:"èªå®ä¹åé¡µ",slug:"èªå®ä¹åé¡µ",normalizedTitle:"èªå®ä¹åé¡µ",charIndex:375},{level:2,title:"èªå®ä¹åé¡µååºæ°æ®",slug:"èªå®ä¹åé¡µååºæ°æ®",normalizedTitle:"èªå®ä¹åé¡µååºæ°æ®",charIndex:906},{level:2,title:"éç½®",slug:"éç½®",normalizedTitle:"éç½®",charIndex:1513},{level:3,title:"å¨å±",slug:"å¨å±",normalizedTitle:"å¨å±",charIndex:1520},{level:3,title:"å±é¨",slug:"å±é¨",normalizedTitle:"å±é¨",charIndex:1862}],headersStr:"ç®ä» åç½®åé¡µæ¹å¼ èªå®ä¹åé¡µ èªå®ä¹åé¡µååºæ°æ® éç½® å¨å± å±é¨",content:"# ç®ä»\n\næ¬æä¸»è¦ä»ç»å¨drfæ¡æ¶ä¸­å¦ä½å¯¹æ¥è¯¢çæ°æ®è¿è¡åé¡µï¼å¨drfæ¡æ¶ä¸­ææä¾è¯¥åºç¡åè½çä½¿ç¨æ¡ä¾åææ¡£ï¼è¯¦æåèdrf-pagination-å®ç½ææ¡£\n\n\n# åç½®åé¡µæ¹å¼\n\ndrfæ¡æ¶ä¸­é»è®¤æä¾å ç§åé¡µæ¹å¼ï¼å¹¶å°è£æäºæ¨¡åæä¾ç»å¼åèè°ç¨ï¼ä¸»è¦æ¯ä»¥ä¸å ç§ï¼\n\n * PageNumberPaginationï¼ä¸»è¦æ¯æä¾page åpage_size è¿è¡åé¡µã\n   * pageï¼å½åé¡µæ°\n   * page_sizeï¼æ¯é¡µå±ç¤ºçæ°é\n * LimitOffsetPaginationï¼æä¾limit åoffset è¿è¡åé¡µ\n   * limitï¼å½ååé¡µå±ç¤ºçæ°é\n   * offsetï¼å½åæ°æ®æ¯ä»ç¬¬å è¡å¼å§ã\n * CursorPaginationï¼å¯¹ç»æéä¸­æä¾åè¿ä¸åéçé¾æ¥æ¥è¿è¡æä½ï¼ä¸åè®¸éæè·³å¨å°ä»»æä½ç½®ã\n\n\n# èªå®ä¹åé¡µ\n\næ¡æ¶æ¬èº«æä¾äºåç±»çæ¨¡åï¼ä½å¨å®éå·¥ä½ä¸­å¹¶ä¸éç¨ï¼æä»¥æä»¬å¯ä»¥éè¿ç»§æ¿çæ¹å¼å¯¹åç½®çåé¡µæ¨¡åä¸­çé¨åå±æ§è¿è¡è¦çï¼ä»¥ç¬¦åèªèº«ä¸å¡ã\n\nclass LargeResultsSetPagination(PageNumberPagination):\n    page_size = 1000\n    page_size_query_param = 'page_size'\n    max_page_size = 10000\n\nclass StandardResultsSetPagination(PageNumberPagination):\n    page_size = 100   \n    page_size_query_param = 'page_size'\n    max_page_size = 1000\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nåæ°ï¼\n\n * page_sizeï¼è¯·æ±æ¥å£æªæææ¶ï¼é»è®¤ä½¿ç¨è¯¥å¼æ¥æ¥è¯¢æ°æ®é\n * max_page_sizeï¼è¿ä¸ªæ¯éå¶ä¸é¡µæå¤§è½å±ç¤ºçæ°éã\n * page_size_query_paramï¼åç«¯è¯·æ±åé¡µæ°éçå­æ®µ\n\nä¸é¢æ¯é¨åå¸¸ç¨çå­æ®µï¼å¦ææç¹æ®ä¸å¡å¯ä»¥çæºç åè¿è¡ä¿®æ¹ã\n\n\n# èªå®ä¹åé¡µååºæ°æ®\n\nå¨åç½®çåé¡µç±»PageNumberPagination ä¸­ååºçæ°æ®æ ¼å¼å¦ä¸ï¼\n\n{\n    \"count\": æ»æ°,\n    \"next\": ä¸ä¸é¡µçé¾æ¥,\n    \"previous\": ä¸ä¸é¡µçé¾æ¥,\n    \"results\": åé¡µåçæ°æ®\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nä½å®æä»¬å¨ä¸å¡ä¸­å¯è½å¹¶ä¸éè¦next åprevious ï¼åªéè¦ä¿çcount åresults ä¸¤ä¸ªå­æ®µï¼è¿ä¸ªæ¶åæä»¬å¯ä»¥éè¿éåget_paginated_response æ¹æ³éè¦å¯¹ååºçæ°æ®è¿è¡è£åªã\n\nclass LargeResultsSetPagination(PageNumberPagination):\n    page_size = 1000\n    page_size_query_param = 'page_size'\n    max_page_size = 10000\n\n    def get_paginated_response(self, data):\n        return Response(OrderedDict([\n            ('count', self.page.paginator.count),\n            ('results', data)\n        ]))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# éç½®\n\n\n# å¨å±\n\nå¨settings.py ä¸­å¯ä»¥è®¾ç½®å¨å±çåé¡µæ¨¡å¼ï¼å¨REST_FRAMEWORK ä¸­è®¾ç½®DEFAULT_PAGINATION_CLASS ï¼è¯¥keyæ¯æå®åé¡µæ¨¡å¼ä½¿ç¨åªä¸ªåé¡µç±»ï¼èè¿éä½¿ç¨çæ¯drfæ¡æ¶ä¸­åç½®çåé¡µç±»LimitOffsetPaginationï¼å¹¶è®¾ç½®åæ°PAGE_SIZEæå®æ¯é¡µé»è®¤å±ç¤ºçæ°éã\n\nREST_FRAMEWORK = {\n    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.LimitOffsetPagination',\n    'PAGE_SIZE': 100\n}\n\n\n1\n2\n3\n4\n\n\nè¯¥é¡¹éç½®ä¼å¯¹å¨å±çæï¼ä¹å°±æ¯æ¯ä¸ä¸ªviewçListæ¥è¯¢é½ä¼èµ°è¯¥åé¡µæ¨¡å¼ã\n\n\n# å±é¨\n\nå¨æäºä¸å¡åºæ¯æ¯ä¸éè¦åé¡µçï¼æèä¸åçæ¥å£éè¦ä½¿ç¨çåé¡µæ¨¡å¼ä¸åï¼é£ä¹ä¸é¢çå¨å±éç½®æ¹æ³å°±ä¸éç¨çäºï¼è¿ä¸ªæ¶åå°±éè¦ä½¿ç¨å±é¨éç½®çæ¹å¼ã\n\né¦åä¸è¿è¡å¨å±æ¨¡å¼ï¼å¨éè¦åé¡µçViewä¸­æ·»å pagination_class å¹¶è®¾ç½®å¯¹åºçåé¡µæ¨¡å¼ç±»ï¼è¿éä½¿ç¨çæ¯èªå®ä¹çåé¡µç±»ï¼è¯¥éç½®åªä¼å¨æ¬Viewä¸­çæã\n\nclass BillingRecordsView(generics.ListAPIView):\n    queryset = Billing.objects.all()\n    serializer_class = BillingRecordsSerializer\n    pagination_class = LargeResultsSetPagination\n\n\n1\n2\n3\n4\n",normalizedContent:"# ç®ä»\n\næ¬æä¸»è¦ä»ç»å¨drfæ¡æ¶ä¸­å¦ä½å¯¹æ¥è¯¢çæ°æ®è¿è¡åé¡µï¼å¨drfæ¡æ¶ä¸­ææä¾è¯¥åºç¡åè½çä½¿ç¨æ¡ä¾åææ¡£ï¼è¯¦æåèdrf-pagination-å®ç½ææ¡£\n\n\n# åç½®åé¡µæ¹å¼\n\ndrfæ¡æ¶ä¸­é»è®¤æä¾å ç§åé¡µæ¹å¼ï¼å¹¶å°è£æäºæ¨¡åæä¾ç»å¼åèè°ç¨ï¼ä¸»è¦æ¯ä»¥ä¸å ç§ï¼\n\n * pagenumberpaginationï¼ä¸»è¦æ¯æä¾page åpage_size è¿è¡åé¡µã\n   * pageï¼å½åé¡µæ°\n   * page_sizeï¼æ¯é¡µå±ç¤ºçæ°é\n * limitoffsetpaginationï¼æä¾limit åoffset è¿è¡åé¡µ\n   * limitï¼å½ååé¡µå±ç¤ºçæ°é\n   * offsetï¼å½åæ°æ®æ¯ä»ç¬¬å è¡å¼å§ã\n * cursorpaginationï¼å¯¹ç»æéä¸­æä¾åè¿ä¸åéçé¾æ¥æ¥è¿è¡æä½ï¼ä¸åè®¸éæè·³å¨å°ä»»æä½ç½®ã\n\n\n# èªå®ä¹åé¡µ\n\næ¡æ¶æ¬èº«æä¾äºåç±»çæ¨¡åï¼ä½å¨å®éå·¥ä½ä¸­å¹¶ä¸éç¨ï¼æä»¥æä»¬å¯ä»¥éè¿ç»§æ¿çæ¹å¼å¯¹åç½®çåé¡µæ¨¡åä¸­çé¨åå±æ§è¿è¡è¦çï¼ä»¥ç¬¦åèªèº«ä¸å¡ã\n\nclass largeresultssetpagination(pagenumberpagination):\n    page_size = 1000\n    page_size_query_param = 'page_size'\n    max_page_size = 10000\n\nclass standardresultssetpagination(pagenumberpagination):\n    page_size = 100   \n    page_size_query_param = 'page_size'\n    max_page_size = 1000\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nåæ°ï¼\n\n * page_sizeï¼è¯·æ±æ¥å£æªæææ¶ï¼é»è®¤ä½¿ç¨è¯¥å¼æ¥æ¥è¯¢æ°æ®é\n * max_page_sizeï¼è¿ä¸ªæ¯éå¶ä¸é¡µæå¤§è½å±ç¤ºçæ°éã\n * page_size_query_paramï¼åç«¯è¯·æ±åé¡µæ°éçå­æ®µ\n\nä¸é¢æ¯é¨åå¸¸ç¨çå­æ®µï¼å¦ææç¹æ®ä¸å¡å¯ä»¥çæºç åè¿è¡ä¿®æ¹ã\n\n\n# èªå®ä¹åé¡µååºæ°æ®\n\nå¨åç½®çåé¡µç±»pagenumberpagination ä¸­ååºçæ°æ®æ ¼å¼å¦ä¸ï¼\n\n{\n    \"count\": æ»æ°,\n    \"next\": ä¸ä¸é¡µçé¾æ¥,\n    \"previous\": ä¸ä¸é¡µçé¾æ¥,\n    \"results\": åé¡µåçæ°æ®\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nä½å®æä»¬å¨ä¸å¡ä¸­å¯è½å¹¶ä¸éè¦next åprevious ï¼åªéè¦ä¿çcount åresults ä¸¤ä¸ªå­æ®µï¼è¿ä¸ªæ¶åæä»¬å¯ä»¥éè¿éåget_paginated_response æ¹æ³éè¦å¯¹ååºçæ°æ®è¿è¡è£åªã\n\nclass largeresultssetpagination(pagenumberpagination):\n    page_size = 1000\n    page_size_query_param = 'page_size'\n    max_page_size = 10000\n\n    def get_paginated_response(self, data):\n        return response(ordereddict([\n            ('count', self.page.paginator.count),\n            ('results', data)\n        ]))\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# éç½®\n\n\n# å¨å±\n\nå¨settings.py ä¸­å¯ä»¥è®¾ç½®å¨å±çåé¡µæ¨¡å¼ï¼å¨rest_framework ä¸­è®¾ç½®default_pagination_class ï¼è¯¥keyæ¯æå®åé¡µæ¨¡å¼ä½¿ç¨åªä¸ªåé¡µç±»ï¼èè¿éä½¿ç¨çæ¯drfæ¡æ¶ä¸­åç½®çåé¡µç±»limitoffsetpaginationï¼å¹¶è®¾ç½®åæ°page_sizeæå®æ¯é¡µé»è®¤å±ç¤ºçæ°éã\n\nrest_framework = {\n    'default_pagination_class': 'rest_framework.pagination.limitoffsetpagination',\n    'page_size': 100\n}\n\n\n1\n2\n3\n4\n\n\nè¯¥é¡¹éç½®ä¼å¯¹å¨å±çæï¼ä¹å°±æ¯æ¯ä¸ä¸ªviewçlistæ¥è¯¢é½ä¼èµ°è¯¥åé¡µæ¨¡å¼ã\n\n\n# å±é¨\n\nå¨æäºä¸å¡åºæ¯æ¯ä¸éè¦åé¡µçï¼æèä¸åçæ¥å£éè¦ä½¿ç¨çåé¡µæ¨¡å¼ä¸åï¼é£ä¹ä¸é¢çå¨å±éç½®æ¹æ³å°±ä¸éç¨çäºï¼è¿ä¸ªæ¶åå°±éè¦ä½¿ç¨å±é¨éç½®çæ¹å¼ã\n\né¦åä¸è¿è¡å¨å±æ¨¡å¼ï¼å¨éè¦åé¡µçviewä¸­æ·»å pagination_class å¹¶è®¾ç½®å¯¹åºçåé¡µæ¨¡å¼ç±»ï¼è¿éä½¿ç¨çæ¯èªå®ä¹çåé¡µç±»ï¼è¯¥éç½®åªä¼å¨æ¬viewä¸­çæã\n\nclass billingrecordsview(generics.listapiview):\n    queryset = billing.objects.all()\n    serializer_class = billingrecordsserializer\n    pagination_class = largeresultssetpagination\n\n\n1\n2\n3\n4\n",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"flaskç»åmongo",frontmatter:{tags:["python","flask"],title:"flaskç»åmongo",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/c59edf/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨flaskä¸­éæç¬¬ä¸æ¹åºflask-mongoengineæ¥éè¿ORMæä½mongoæ°æ®åº",feed:{enable:!0},categories:["ç¼ç¨","python","flask"],comment:!0,meta:[{name:"twitter:title",content:"flaskç»åmongo"},{name:"twitter:description",content:"å¨flaskä¸­éæç¬¬ä¸æ¹åºflask-mongoengineæ¥éè¿ORMæä½mongoæ°æ®åº"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/07.flask/02.flask%E7%BB%93%E5%90%88mongo.html"},{property:"og:type",content:"article"},{property:"og:title",content:"flaskç»åmongo"},{property:"og:description",content:"å¨flaskä¸­éæç¬¬ä¸æ¹åºflask-mongoengineæ¥éè¿ORMæä½mongoæ°æ®åº"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/07.flask/02.flask%E7%BB%93%E5%90%88mongo.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"flask"},{itemprop:"name",content:"flaskç»åmongo"},{itemprop:"description",content:"å¨flaskä¸­éæç¬¬ä¸æ¹åºflask-mongoengineæ¥éè¿ORMæä½mongoæ°æ®åº"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/07.flask/02.flask%E7%BB%93%E5%90%88mongo.html",relativePath:"04.ç¼ç¨/01.python/07.flask/02.flaskç»åmongo.md",key:"v-364f49b5",path:"/pages/c59edf/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:83},{level:2,title:"ä½¿ç¨",slug:"ä½¿ç¨",normalizedTitle:"ä½¿ç¨",charIndex:26},{level:2,title:"è§£æ±ºé®é¢",slug:"è§£æ±ºé®é¢",normalizedTitle:"è§£æ±ºé®é¢",charIndex:857}],headersStr:"ç®ä» ç¸å³é¾æ¥ ä½¿ç¨ è§£æ±ºé®é¢",content:'# ç®ä»\n\næ¬ææ¯flaskä¸­å¯¹mongoçæä½. ä½¿ç¨Flask-MongoEngineéæäºmongoçæä½ï¼ä½¿ç¨çæ¯ç±»ä¼¼äºdjangoä¸­çormæä½ã\n\n\n# ç¸å³é¾æ¥\n\nFlask-MongoEngineææ¡£\n\nMongoEngineææ¡£\n\n\n# ä½¿ç¨\n\nmongoçéç½®. flaskå°è¿ä¸ªéç½®å è½½è¿æ¥å³å¯.\n\nMONGODB_SETTINGS = {\n    "db": "lifeAssistant",\n    "host": "192.168.0.206",\n    "port": 27017\n}\n\n\n1\n2\n3\n4\n5\n\n\nåå»ºmongoå¼æ.\n\nfrom flask_mongoengine import MongoEngine\nmongodb = MongoEngine()\n\n\n1\n2\n\n\nåå»ºDocumentï¼ç±»ä¼¼äºdjangoçmodel.\n\nfrom lifeAssistant.extension import mongodb\n\nclass Article(mongodb.Document):\n    category = mongodb.StringField()\n    category2 = mongodb.StringField()\n    title = mongodb.StringField()\n    content = mongodb.StringField()\n    publisher = mongodb.StringField()\n    publisher_time = mongodb.StringField()\n    create_time = mongodb.StringField()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nä½¿ç¨Documentè¿è¡æä½. å¶ä»æä½è¯·çå®æ¹ææ¡£\n\n\n# éè¿idè·åæ°æ®.  \ninstance = Article.objects.get_or_404(id=id)\n\n\n1\n2\n3\n\n\n\n# è§£æ±ºé®é¢\n\nmongoæ°æ®è½¬json\n\né®é¢: mongoè½¬jsonæ¶ï¼ä¼è¾åºObjectIdè¿å¯¹è±¡ï¼èä¸æ¯ç´æ¥çidå¼ï¼è¿ä¸ªæ¶åéè¦è½¬æ¢.\n\n\n# è¿ä¸ªæ¯å°mongo Documentå¯¹è±¡è½¬æ¢æjsonçç¼ç å¨\nclass MongoEncoder(JSONEncoder):\n    def default(self, o):\n\n        # è½¬æ¢æ¥æ\n        if isinstance(o, (datetime, date)):\n            pass\n\n        # è½¬æ¢Document\n        if isinstance(o, BaseDocument):\n            return o.to_mongo()\n\n        # è½¬æ¢id\n        if isinstance(o, ObjectId):\n            return str(o)\n\n        return JSONEncoder.default(self, o)\n\n\n\n# å¨èå¾ä¸æ·»å mongoè§£ç å¨.  jsonifyä¼èªå¨å°Documentå¯¹è±¡è½¬æjson\nbp = Blueprint("article", __name__, url_prefix="/article")\nbp.json_encoder = MongoEncoder\n\n\n@bp.route("/<id>/", methods=("GET",))\ndef article(id: str):\n    instance = Article.objects.get_or_404(id=id)\n\n    return jsonify({\n        "code": 0,\n        "msg": "success",\n        "data": instance\n    })\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n',normalizedContent:'# ç®ä»\n\næ¬ææ¯flaskä¸­å¯¹mongoçæä½. ä½¿ç¨flask-mongoengineéæäºmongoçæä½ï¼ä½¿ç¨çæ¯ç±»ä¼¼äºdjangoä¸­çormæä½ã\n\n\n# ç¸å³é¾æ¥\n\nflask-mongoengineææ¡£\n\nmongoengineææ¡£\n\n\n# ä½¿ç¨\n\nmongoçéç½®. flaskå°è¿ä¸ªéç½®å è½½è¿æ¥å³å¯.\n\nmongodb_settings = {\n    "db": "lifeassistant",\n    "host": "192.168.0.206",\n    "port": 27017\n}\n\n\n1\n2\n3\n4\n5\n\n\nåå»ºmongoå¼æ.\n\nfrom flask_mongoengine import mongoengine\nmongodb = mongoengine()\n\n\n1\n2\n\n\nåå»ºdocumentï¼ç±»ä¼¼äºdjangoçmodel.\n\nfrom lifeassistant.extension import mongodb\n\nclass article(mongodb.document):\n    category = mongodb.stringfield()\n    category2 = mongodb.stringfield()\n    title = mongodb.stringfield()\n    content = mongodb.stringfield()\n    publisher = mongodb.stringfield()\n    publisher_time = mongodb.stringfield()\n    create_time = mongodb.stringfield()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nä½¿ç¨documentè¿è¡æä½. å¶ä»æä½è¯·çå®æ¹ææ¡£\n\n\n# éè¿idè·åæ°æ®.  \ninstance = article.objects.get_or_404(id=id)\n\n\n1\n2\n3\n\n\n\n# è§£æ±ºé®é¢\n\nmongoæ°æ®è½¬json\n\né®é¢: mongoè½¬jsonæ¶ï¼ä¼è¾åºobjectidè¿å¯¹è±¡ï¼èä¸æ¯ç´æ¥çidå¼ï¼è¿ä¸ªæ¶åéè¦è½¬æ¢.\n\n\n# è¿ä¸ªæ¯å°mongo documentå¯¹è±¡è½¬æ¢æjsonçç¼ç å¨\nclass mongoencoder(jsonencoder):\n    def default(self, o):\n\n        # è½¬æ¢æ¥æ\n        if isinstance(o, (datetime, date)):\n            pass\n\n        # è½¬æ¢document\n        if isinstance(o, basedocument):\n            return o.to_mongo()\n\n        # è½¬æ¢id\n        if isinstance(o, objectid):\n            return str(o)\n\n        return jsonencoder.default(self, o)\n\n\n\n# å¨èå¾ä¸æ·»å mongoè§£ç å¨.  jsonifyä¼èªå¨å°documentå¯¹è±¡è½¬æjson\nbp = blueprint("article", __name__, url_prefix="/article")\nbp.json_encoder = mongoencoder\n\n\n@bp.route("/<id>/", methods=("get",))\ndef article(id: str):\n    instance = article.objects.get_or_404(id=id)\n\n    return jsonify({\n        "code": 0,\n        "msg": "success",\n        "data": instance\n    })\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"tornado æä»¶ä¸ä¼ ",frontmatter:{title:"tornado æä»¶ä¸ä¼ ",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/4c38f5/",tags:["python","tornado"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"tornadoå®ç°çæä»¶ä¸ä¼ åè½",feed:{enable:!0},categories:["ç¼ç¨","python","tornado"],comment:!0,meta:[{name:"twitter:title",content:"tornado æä»¶ä¸ä¼ "},{name:"twitter:description",content:"tornadoå®ç°çæä»¶ä¸ä¼ åè½"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/01.tornado%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tornado æä»¶ä¸ä¼ "},{property:"og:description",content:"tornadoå®ç°çæä»¶ä¸ä¼ åè½"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/01.tornado%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"tornado"},{itemprop:"name",content:"tornado æä»¶ä¸ä¼ "},{itemprop:"description",content:"tornadoå®ç°çæä»¶ä¸ä¼ åè½"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/01.tornado%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.html",relativePath:"04.ç¼ç¨/01.python/08.tornado/01.tornado æä»¶ä¸ä¼ .md",key:"v-2f2878f8",path:"/pages/4c38f5/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"æ å­",slug:"æ å­",normalizedTitle:"æ å­",charIndex:71}],headersStr:"ç®ä» æ å­",content:'# ç®ä»\n\næç« ä»ç»çæ¯ä½¿ç¨tornadoå®ææä»¶çä¸ä¼ åè½\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# æ å­\n\nè®¾ç½®æä»¶ä¸ä¼ çè·¯å¾\n\nä»£ç : tornado_learning/settings.py\n\nBASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nsettings = {\n    "MEDIA_ROOT": os.path.join(BASE_DIR, "media"),\n}\n\n\n1\n2\n3\n4\n\n\nä¿å­ä¸ä¼ æä»¶\n\nè·ååç«¯ä¼ éè¿æ¥çfront_imageæä»¶ï¼ç¶ååä½¿ç¨aiofileså®æä¸ä¼ æä»¶çäºè¿å¶å¼æ­¥åå¥ã\n\nä»£ç : /apps/hello/uploadHandler.py\n\n\nfrom tornado_learning.handler import BaseHandler\nimport os\nimport uuid\nimport aiofiles\n\nclass UploadHandler(BaseHandler):\n\n    async def post(self):\n        ret_data = {}\n\n        files_meta = self.request.files.get("front_image", None)\n        if not files_meta:\n            self.set_status(400)\n            ret_data["front_image"] = "è¯·ä¸ä¼ å¾ç"\n        else:\n            for meta in files_meta:\n                filename = meta["filename"]\n                new_filename = "{uuid}_{filename}".format(uuid=uuid.uuid1(), filename=filename)\n                file_path = os.path.join(self.settings["MEDIA_ROOT"], new_filename)\n\n                async with aiofiles.open(file_path, "wb") as f:\n                    await f.write(meta["body"])\n\n                ret_data[\'file_path\'] = file_path\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n',normalizedContent:'# ç®ä»\n\næç« ä»ç»çæ¯ä½¿ç¨tornadoå®ææä»¶çä¸ä¼ åè½\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# æ å­\n\nè®¾ç½®æä»¶ä¸ä¼ çè·¯å¾\n\nä»£ç : tornado_learning/settings.py\n\nbase_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nsettings = {\n    "media_root": os.path.join(base_dir, "media"),\n}\n\n\n1\n2\n3\n4\n\n\nä¿å­ä¸ä¼ æä»¶\n\nè·ååç«¯ä¼ éè¿æ¥çfront_imageæä»¶ï¼ç¶ååä½¿ç¨aiofileså®æä¸ä¼ æä»¶çäºè¿å¶å¼æ­¥åå¥ã\n\nä»£ç : /apps/hello/uploadhandler.py\n\n\nfrom tornado_learning.handler import basehandler\nimport os\nimport uuid\nimport aiofiles\n\nclass uploadhandler(basehandler):\n\n    async def post(self):\n        ret_data = {}\n\n        files_meta = self.request.files.get("front_image", none)\n        if not files_meta:\n            self.set_status(400)\n            ret_data["front_image"] = "è¯·ä¸ä¼ å¾ç"\n        else:\n            for meta in files_meta:\n                filename = meta["filename"]\n                new_filename = "{uuid}_{filename}".format(uuid=uuid.uuid1(), filename=filename)\n                file_path = os.path.join(self.settings["media_root"], new_filename)\n\n                async with aiofiles.open(file_path, "wb") as f:\n                    await f.write(meta["body"])\n\n                ret_data[\'file_path\'] = file_path\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯",frontmatter:{tags:["python","tornado"],title:"tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/c24905/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"tornadoä½¿ç¨jwtå®ç°ç¨æ·çå¼æ­¥è®¤è¯",feed:{enable:!0},categories:["ç¼ç¨","python","tornado"],comment:!0,meta:[{name:"twitter:title",content:"tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯"},{name:"twitter:description",content:"tornadoä½¿ç¨jwtå®ç°ç¨æ·çå¼æ­¥è®¤è¯"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/02.tornado%20%E4%BD%BF%E7%94%A8jwt%E5%AE%8C%E6%88%90%E7%94%A8%E6%88%B7%E5%BC%82%E6%AD%A5%E8%AE%A4%E8%AF%81.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯"},{property:"og:description",content:"tornadoä½¿ç¨jwtå®ç°ç¨æ·çå¼æ­¥è®¤è¯"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/02.tornado%20%E4%BD%BF%E7%94%A8jwt%E5%AE%8C%E6%88%90%E7%94%A8%E6%88%B7%E5%BC%82%E6%AD%A5%E8%AE%A4%E8%AF%81.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"tornado"},{itemprop:"name",content:"tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯"},{itemprop:"description",content:"tornadoä½¿ç¨jwtå®ç°ç¨æ·çå¼æ­¥è®¤è¯"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/02.tornado%20%E4%BD%BF%E7%94%A8jwt%E5%AE%8C%E6%88%90%E7%94%A8%E6%88%B7%E5%BC%82%E6%AD%A5%E8%AE%A4%E8%AF%81.html",relativePath:"04.ç¼ç¨/01.python/08.tornado/02.tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯.md",key:"v-33efde74",path:"/pages/c24905/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"æ å­",slug:"æ å­",normalizedTitle:"æ å­",charIndex:156}],headersStr:"ç®ä» æ å­",content:'# ç®ä»\n\nå¨ä½¿ç¨ç¹å®åè½æ¶ï¼éè¦éªè¯ç¨æ·æ¯å¦ç»å½ãä½¿ç¨jwtå°ç¨æ·ä¸ææçä¿¡æ¯ä¿å­å¨å®¢æ·ç«¯ä¸ï¼ç¶åè®¿é®æ¶ï¼å°å å¯çä¿¡æ¯åéç»æå¡ç«¯éªè¯ã\n\nåsessionçä¸åä¹å¤å¨äºï¼sessionéè¦å¨ä¸¤ç«¯é½å­å¨ï¼èjwtä»å¨å®¢æ·ç«¯å­å¨ã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# æ å­\n\nåå»ºå¼æ­¥éªè¯çè£é¥°å¨\n\nä»headerä¸­è·åtsessionidçjwt tokenä¿¡æ¯ï¼ç¶åä»tokenè·åç¨æ·idï¼ä»æ°æ®åºä¸­æ¥æ¾ç¨æ·ä¿¡æ¯ï¼åéªè¯tokenæ¯å¦è¿æã\n\nä»£ç : utils/authenticated_async.py\n\ndef authenticated_async(method):\n    async def wrapper(self, *args, **kwargs):\n\n        # ret_data = {}\n\n        tsessionid = self.request.headers.get("tsessionid", None)\n        if tsessionid:\n\n            try:\n                payload = jwt.decode(tsessionid, self.settings["secret_key"], leeway=self.settings["jwt_expire"],\n                                     options={"verify_exp": True})\n\n                user_id = payload["id"]\n                try:\n                    user = await self.application.objects.get(User, id=user_id)\n                    self._current_user = user\n                    await method(self, *args, **kwargs)\n                except User.DoesNotExist as e:\n                    self.set_status(401)\n            except jwt.ExpiredSignatureError as e:\n                self.set_status(401)\n\n    return wrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nå¨è¯·æ±ä¸æ·»å ç¨æ·è®¤è¯\n\næ¯æ¬¡å¨è¯·æ±è¯¥æ¥å£æ¶ï¼é½éè¦å¯¹è¿è¡ç¨æ·è®¤è¯ï¼è®¤è¯éè¿æè½è®¿é®è¯¥æ¥å£ã\n\nä»£ç : apps/school/handle.py\n\n\nfrom utils.authenticated_async import authenticated_async\n\nclass StudentHandler(BaseHandler):\n\n    @authenticated_async\n    async def get(self):\n        id = self.get_argument("id", None)\n        if not id:\n            return self.write("please provide the \'id\'")\n\n        student = await self.application.objects.get(Student, id=id)\n\n        try:\n            self.write({\n                "id": student.id,\n                "name": student.name\n            })\n        except Student.DoesNotExist:\n            raise tornado.webHttpError(404, "Object not found")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n',normalizedContent:'# ç®ä»\n\nå¨ä½¿ç¨ç¹å®åè½æ¶ï¼éè¦éªè¯ç¨æ·æ¯å¦ç»å½ãä½¿ç¨jwtå°ç¨æ·ä¸ææçä¿¡æ¯ä¿å­å¨å®¢æ·ç«¯ä¸ï¼ç¶åè®¿é®æ¶ï¼å°å å¯çä¿¡æ¯åéç»æå¡ç«¯éªè¯ã\n\nåsessionçä¸åä¹å¤å¨äºï¼sessionéè¦å¨ä¸¤ç«¯é½å­å¨ï¼èjwtä»å¨å®¢æ·ç«¯å­å¨ã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# æ å­\n\nåå»ºå¼æ­¥éªè¯çè£é¥°å¨\n\nä»headerä¸­è·åtsessionidçjwt tokenä¿¡æ¯ï¼ç¶åä»tokenè·åç¨æ·idï¼ä»æ°æ®åºä¸­æ¥æ¾ç¨æ·ä¿¡æ¯ï¼åéªè¯tokenæ¯å¦è¿æã\n\nä»£ç : utils/authenticated_async.py\n\ndef authenticated_async(method):\n    async def wrapper(self, *args, **kwargs):\n\n        # ret_data = {}\n\n        tsessionid = self.request.headers.get("tsessionid", none)\n        if tsessionid:\n\n            try:\n                payload = jwt.decode(tsessionid, self.settings["secret_key"], leeway=self.settings["jwt_expire"],\n                                     options={"verify_exp": true})\n\n                user_id = payload["id"]\n                try:\n                    user = await self.application.objects.get(user, id=user_id)\n                    self._current_user = user\n                    await method(self, *args, **kwargs)\n                except user.doesnotexist as e:\n                    self.set_status(401)\n            except jwt.expiredsignatureerror as e:\n                self.set_status(401)\n\n    return wrapper\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nå¨è¯·æ±ä¸æ·»å ç¨æ·è®¤è¯\n\næ¯æ¬¡å¨è¯·æ±è¯¥æ¥å£æ¶ï¼é½éè¦å¯¹è¿è¡ç¨æ·è®¤è¯ï¼è®¤è¯éè¿æè½è®¿é®è¯¥æ¥å£ã\n\nä»£ç : apps/school/handle.py\n\n\nfrom utils.authenticated_async import authenticated_async\n\nclass studenthandler(basehandler):\n\n    @authenticated_async\n    async def get(self):\n        id = self.get_argument("id", none)\n        if not id:\n            return self.write("please provide the \'id\'")\n\n        student = await self.application.objects.get(student, id=id)\n\n        try:\n            self.write({\n                "id": student.id,\n                "name": student.name\n            })\n        except student.doesnotexist:\n            raise tornado.webhttperror(404, "object not found")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"tornado ç¨æ·å¯ç  bcryptå å¯",frontmatter:{tags:["python","tornado"],title:"tornado ç¨æ·å¯ç  bcryptå å¯",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/22f35b/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä½¿ç¨bcryptæ¥å®ç°å¯¹ç¨æ·å¯ç è¿è¡å å¯",feed:{enable:!0},categories:["ç¼ç¨","python","tornado"],comment:!0,meta:[{name:"twitter:title",content:"tornado ç¨æ·å¯ç  bcryptå å¯"},{name:"twitter:description",content:"ä½¿ç¨bcryptæ¥å®ç°å¯¹ç¨æ·å¯ç è¿è¡å å¯"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/03.tornado%20%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%20bcrypt%E5%8A%A0%E5%AF%86.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tornado ç¨æ·å¯ç  bcryptå å¯"},{property:"og:description",content:"ä½¿ç¨bcryptæ¥å®ç°å¯¹ç¨æ·å¯ç è¿è¡å å¯"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/03.tornado%20%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%20bcrypt%E5%8A%A0%E5%AF%86.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"tornado"},{itemprop:"name",content:"tornado ç¨æ·å¯ç  bcryptå å¯"},{itemprop:"description",content:"ä½¿ç¨bcryptæ¥å®ç°å¯¹ç¨æ·å¯ç è¿è¡å å¯"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/03.tornado%20%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%20bcrypt%E5%8A%A0%E5%AF%86.html",relativePath:"04.ç¼ç¨/01.python/08.tornado/03.tornado ç¨æ·å¯ç  bcryptå å¯.md",key:"v-5000cd97",path:"/pages/22f35b/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"python å¦ä½ä½¿ç¨bcrypt æ å­",slug:"python-å¦ä½ä½¿ç¨bcrypt-æ å­",normalizedTitle:"python å¦ä½ä½¿ç¨bcrypt æ å­",charIndex:175},{level:2,title:"tornado ä½¿ç¨ bcrypt å å¯å¯ç æ å­ã",slug:"tornado-ä½¿ç¨-bcrypt-å å¯å¯ç æ å­ã",normalizedTitle:"tornado ä½¿ç¨ bcrypt å å¯å¯ç æ å­ã",charIndex:437},{level:3,title:"åå»ºuser model",slug:"åå»ºuser-model",normalizedTitle:"åå»ºuser model",charIndex:467},{level:3,title:"æ³¨åçhandler",slug:"æ³¨åçhandler",normalizedTitle:"æ³¨åçhandler",charIndex:2218}],headersStr:"ç®ä» python å¦ä½ä½¿ç¨bcrypt æ å­ tornado ä½¿ç¨ bcrypt å å¯å¯ç æ å­ã åå»ºuser model æ³¨åçhandler",content:'# ç®ä»\n\nbcrypt å¯ä»¥éè¿å ççæ¹å¼å¯¹å¯ç è¿è¡å å¯ï¼æ´å çå®å¨å¯é ã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\nä¼ç¹\n\nmd5å å¯ï¼æ¯ä¸ªå¯¹åºçææå¯ç ï¼å¯¹åºçæ¯ä¸æ ·çå å¯çå¯æï¼æ¯è¾å®¹æçè¿è¡è§£å¯ãèbcryptæ¯ä¸æ¬¡çææå¯ç å¾å°çæ¯ä¸åçå å¯çå¯æï¼å ä¸ºå¯ææ¯éè¿éæºççç»åå å¯ï¼æä»¥æ´å å®å¨ã\n\n\n# python å¦ä½ä½¿ç¨bcrypt æ å­\n\nfrom bcrypt import hashpw, gensalt\n\n# è¿ä¸ªæ¯éæºçæçç\nsalt = gensalt(12)\n\n# è¿ä¸ªæ¯éè¿çå»å å¯\npasswd = hashpw("123456".encode(\'utf8\'), salt)\n\n# å°è¾å¥çææå¯ç ä¸å¯æå¯ç è¿è¡å å¯ï¼æ¯å¦ç­äºå¯æå¯ç ã\nhashpw(input_passwd.encode(\'utf8\'), passwd) == passwd\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# tornado ä½¿ç¨ bcrypt å å¯å¯ç æ å­ã\n\n\n# åå»ºuser model\n\nå¨user modelä¸­çå¯ç å­æ®µä½¿ç¨èªå®ä¹çPasswordField.\n\nä»£ç /apps/user/models.py\n\nclass PasswordHash(bytes):\n    def check_password(self, password):\n        """\n        æ¯è¾ä¼ å¥çå¯ç åæ°æ®åºä¸­çå¯ç æ¯å¦å¹é\n        :param password:\n        :return:\n        """\n        password = password.encode(\'utf-8\')\n        return hashpw(password, self) == self\n\nclass PasswordField(BlobField):\n    def __init__(self, iterations=12, *args, **kwargs):\n        if None in (hashpw, gensalt):\n            raise ValueError(\'Missing library required for PasswordField: bcrypt\')\n        self.bcrypt_iterations = iterations\n        self.raw_password = None\n        super(PasswordField, self).__init__(*args, **kwargs)\n\n    def db_value(self, value):\n        """\n        å°pythonçå¼è½¬æ¢æå­å¥æ°æ®åºçå¼\n        å­å¥æ°æ®åºçå¼ï¼æ¯éè¿bcryptå å¯åçå¯æã\n        :param value:\n        :return:\n        """\n        if isinstance(value, PasswordHash):\n            return bytes(value)\n\n        if isinstance(value, str):\n            value = value.encode(\'utf-8\')\n        salt = gensalt(self.bcrypt_iterations)\n        return value if value is None else hashpw(value, salt)\n\n    def python_value(self, value):\n        """\n        å°æ°æ®åºä¸­çå¼è½¬æ¢æpythonä¸­çå¼\n        è¿ä¸ªå¼æ¯ä¸ä¸ªPasswordHashå¯¹è±¡ãè¯¥å¯¹è±¡æä¾æ¯è¾å¯ç çæ¹æ³ã\n        :param value:\n        :return:\n        """\n        if isinstance(value, str):\n            value = value.encode(\'utf-8\')\n\n        return PasswordHash(value)\n\nclass User(BaseModel):\n    username = CharField(max_length=16, verbose_name="ç¨æ·å", index=True, unique=True)\n    password = PasswordField(verbose_name="å¯ç ")\n    address = CharField(max_length=200, null=True, verbose_name="å°å")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n\n\n\n# æ³¨åçhandler\n\næ³¨åçæ¥å£\n\nä»£ç : /apps/user/handler.py\n\nclass RegisterHandler(BaseHandler):\n\n    async def post(self):\n\n        ret_data = {}\n\n        registerForm = RegisterForm(self.request.arguments)\n        if registerForm.validate():\n            username = registerForm.username.data\n\n            try:\n                exist_user = await self.application.objects.get(User, username=username)\n                ret_data["username"] = "ç¨æ·åå·²ç»å­å¨"\n            except User.DoesNotExist as e:\n                user = await self.application.objects.create(User, **registerForm.data)\n                ret_data["id"] = user.id\n        else:\n            self.set_status(400)\n            for field in registerForm.erros:\n                ret_data[field] = registerForm[field][0]\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n',normalizedContent:'# ç®ä»\n\nbcrypt å¯ä»¥éè¿å ççæ¹å¼å¯¹å¯ç è¿è¡å å¯ï¼æ´å çå®å¨å¯é ã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\nä¼ç¹\n\nmd5å å¯ï¼æ¯ä¸ªå¯¹åºçææå¯ç ï¼å¯¹åºçæ¯ä¸æ ·çå å¯çå¯æï¼æ¯è¾å®¹æçè¿è¡è§£å¯ãèbcryptæ¯ä¸æ¬¡çææå¯ç å¾å°çæ¯ä¸åçå å¯çå¯æï¼å ä¸ºå¯ææ¯éè¿éæºççç»åå å¯ï¼æä»¥æ´å å®å¨ã\n\n\n# python å¦ä½ä½¿ç¨bcrypt æ å­\n\nfrom bcrypt import hashpw, gensalt\n\n# è¿ä¸ªæ¯éæºçæçç\nsalt = gensalt(12)\n\n# è¿ä¸ªæ¯éè¿çå»å å¯\npasswd = hashpw("123456".encode(\'utf8\'), salt)\n\n# å°è¾å¥çææå¯ç ä¸å¯æå¯ç è¿è¡å å¯ï¼æ¯å¦ç­äºå¯æå¯ç ã\nhashpw(input_passwd.encode(\'utf8\'), passwd) == passwd\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# tornado ä½¿ç¨ bcrypt å å¯å¯ç æ å­ã\n\n\n# åå»ºuser model\n\nå¨user modelä¸­çå¯ç å­æ®µä½¿ç¨èªå®ä¹çpasswordfield.\n\nä»£ç /apps/user/models.py\n\nclass passwordhash(bytes):\n    def check_password(self, password):\n        """\n        æ¯è¾ä¼ å¥çå¯ç åæ°æ®åºä¸­çå¯ç æ¯å¦å¹é\n        :param password:\n        :return:\n        """\n        password = password.encode(\'utf-8\')\n        return hashpw(password, self) == self\n\nclass passwordfield(blobfield):\n    def __init__(self, iterations=12, *args, **kwargs):\n        if none in (hashpw, gensalt):\n            raise valueerror(\'missing library required for passwordfield: bcrypt\')\n        self.bcrypt_iterations = iterations\n        self.raw_password = none\n        super(passwordfield, self).__init__(*args, **kwargs)\n\n    def db_value(self, value):\n        """\n        å°pythonçå¼è½¬æ¢æå­å¥æ°æ®åºçå¼\n        å­å¥æ°æ®åºçå¼ï¼æ¯éè¿bcryptå å¯åçå¯æã\n        :param value:\n        :return:\n        """\n        if isinstance(value, passwordhash):\n            return bytes(value)\n\n        if isinstance(value, str):\n            value = value.encode(\'utf-8\')\n        salt = gensalt(self.bcrypt_iterations)\n        return value if value is none else hashpw(value, salt)\n\n    def python_value(self, value):\n        """\n        å°æ°æ®åºä¸­çå¼è½¬æ¢æpythonä¸­çå¼\n        è¿ä¸ªå¼æ¯ä¸ä¸ªpasswordhashå¯¹è±¡ãè¯¥å¯¹è±¡æä¾æ¯è¾å¯ç çæ¹æ³ã\n        :param value:\n        :return:\n        """\n        if isinstance(value, str):\n            value = value.encode(\'utf-8\')\n\n        return passwordhash(value)\n\nclass user(basemodel):\n    username = charfield(max_length=16, verbose_name="ç¨æ·å", index=true, unique=true)\n    password = passwordfield(verbose_name="å¯ç ")\n    address = charfield(max_length=200, null=true, verbose_name="å°å")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n\n\n\n# æ³¨åçhandler\n\næ³¨åçæ¥å£\n\nä»£ç : /apps/user/handler.py\n\nclass registerhandler(basehandler):\n\n    async def post(self):\n\n        ret_data = {}\n\n        registerform = registerform(self.request.arguments)\n        if registerform.validate():\n            username = registerform.username.data\n\n            try:\n                exist_user = await self.application.objects.get(user, username=username)\n                ret_data["username"] = "ç¨æ·åå·²ç»å­å¨"\n            except user.doesnotexist as e:\n                user = await self.application.objects.create(user, **registerform.data)\n                ret_data["id"] = user.id\n        else:\n            self.set_status(400)\n            for field in registerform.erros:\n                ret_data[field] = registerform[field][0]\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"tornado ç»åwtformsä½¿ç¨è¡¨åæä½",frontmatter:{tags:["python","tornado"],title:"tornado ç»åwtformsä½¿ç¨è¡¨åæä½",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/7ac01f/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"tornadoä½¿ç¨wtformsæ¥å¯¹è¡¨åè¿è¡éªè¯ä¸æä½ã",feed:{enable:!0},categories:["ç¼ç¨","python","tornado"],comment:!0,meta:[{name:"twitter:title",content:"tornado ç»åwtformsä½¿ç¨è¡¨åæä½"},{name:"twitter:description",content:"tornadoä½¿ç¨wtformsæ¥å¯¹è¡¨åè¿è¡éªè¯ä¸æä½ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/04.tornado%20%E7%BB%93%E5%90%88wtforms%E4%BD%BF%E7%94%A8%E8%A1%A8%E5%8D%95%E6%93%8D%E4%BD%9C.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tornado ç»åwtformsä½¿ç¨è¡¨åæä½"},{property:"og:description",content:"tornadoä½¿ç¨wtformsæ¥å¯¹è¡¨åè¿è¡éªè¯ä¸æä½ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/04.tornado%20%E7%BB%93%E5%90%88wtforms%E4%BD%BF%E7%94%A8%E8%A1%A8%E5%8D%95%E6%93%8D%E4%BD%9C.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"tornado"},{itemprop:"name",content:"tornado ç»åwtformsä½¿ç¨è¡¨åæä½"},{itemprop:"description",content:"tornadoä½¿ç¨wtformsæ¥å¯¹è¡¨åè¿è¡éªè¯ä¸æä½ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/04.tornado%20%E7%BB%93%E5%90%88wtforms%E4%BD%BF%E7%94%A8%E8%A1%A8%E5%8D%95%E6%93%8D%E4%BD%9C.html",relativePath:"04.ç¼ç¨/01.python/08.tornado/04.tornado ç»åwtformsä½¿ç¨è¡¨åæä½.md",key:"v-fad5dda8",path:"/pages/7ac01f/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ä¾å­",slug:"ä¾å­",normalizedTitle:"ä¾å­",charIndex:110},{level:2,title:"htmlè¡¨å",slug:"htmlè¡¨å",normalizedTitle:"htmlè¡¨å",charIndex:1458},{level:2,title:"wtforms è¯»åjson",slug:"wtforms-è¯»åjson",normalizedTitle:"wtforms è¯»åjson",charIndex:2568}],headersStr:"ç®ä» ä¾å­ htmlè¡¨å wtforms è¯»åjson",content:'# ç®ä»\n\nå¨è·åè¯·æ±æ¶ï¼éè¦å°è¯·æ±çåæ°è¿è¡éªè¯ã\nä½¿ç¨wtformsåtornadoçç»åï¼å¯ä»¥è·åå°è¯·æ±çåæ°ï¼å¹¶ä¸å¯¹åæ°è¿è¡éªè¯ã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# ä¾å­\n\nåå»ºstudentçform\n\nä»£ç : apps/shchool/forms.py\n\n\nfrom wtforms_tornado import Form\nfrom wtforms import StringField, IntegerField, TextAreaField\nfrom wtforms.validators import DataRequired, Length\n\nclass StudentForm(Form):\n    """\n    å¯ä»¥ä½ä¸ºstudentç post å put çè¡¨åä½¿ç¨ã\n    """\n\n    id = IntegerField("id", null=True)\n    name = StringField("å§å", validators=[DataRequired("è¯·è¾å¥å§å")])\n    age = IntegerField("å¹´é¾", validators=[DataRequired("è¯·è¾å¥å¹´é¾")])\n    desc = TextAreaField("ä¸ªäººç®ä»", validators=[DataRequired("è¯·è¾å¥ä¸ªäººç®ä»")])\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶åéè¿formæ¥æ¶åæ°ï¼å¯¹åæ°è¿è¡éªè¯ï¼éªè¯éè¿åæä½modelï¼å¯¹æ°æ®åºè¿è¡ä¿å­æä½\n\néè¿éåstudent_from.errorså¾å°æ ¡éªå¤±è´¥çå­æ®µï¼ç¶ååè¿åå°åç«¯æç¤ºã\n\nä»£ç : apps/school/handler.py\n\n\nimport tornado\n\nfrom apps.school.forms import StudentForm\nfrom apps.school.models import Student\nfrom tornado_learning.handler import BaseHandler\n\nclass StudentHandler(BaseHandler):\n\n        async def post(self):\n\n        ret_data = {}\n\n        student_form = StudentForm(self.request.arguments)\n        if student_form.validate():\n            await self.application.objects.create(Student, **student_form.data)\n\n            ret_data["ret"] = "success"\n        else:\n            for field in student_form.errors:\n                ret_data[field] = ret_data.errors[field][0]\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n\n# htmlè¡¨å\n\nè¿å¯ä»¥éè¿wtformsåå»ºå¯¹åºçmodelæ¨¡æ¿è¡¨åã\n\nä¸ªäººä¸æ¯å¾æ¨èä½¿ç¨ï¼å ä¸ºååç«¯è¦åæ§å¤ªå¼ºã\n\nè·åè¡¨å\n\nä»£ç : apps/school/forms.py\n\nclass StudentFormHandler(BaseHandler):\n\n    def get(self):\n        studentForm = StudentForm()\n        return self.render("student.html", studentForm=studentForm)\n\n\n1\n2\n3\n4\n5\n\n\nè¡¨åçhtmlæ¨¡æ¿\nå°è¯¥æä»¶æ¾å¨templatesè·¯å¾ä¸\n\nä»£ç : templates/student.html\n\n<form action="/student" , method="post">\n    {% autoescape None %}\n    {% for field in studentForm %}\n        <span>{{ field.label.text }} :</span>\n        {{ field(placeholder="è¯·è¾å¥"+field.label.text) }}\n\n        {% if field.errors %}\n            {% for error_msg in field.errors %}\n                <div class="error-msg">{{ error_msg }}</div>\n                {% end %}\n                {% else %}\n                <div class="error-msg"></div>\n            {% end %}\n    {% end %}\n\n    <label>\n        <span>&nbsp;</span>\n        <input type="submit" class="button" value="æäº¤"/>\n    </label>\n</form>\n</body>\n</html>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\néè¦å¨è®¾ç½®é¡¹ä¸­è®¾ç½®æ¨¡æ¿è·¯å¾\nä»£ç :tornado_learning/settings.py\n\nsettings = {\n    "template_path": "templates"\n}\n\n\n1\n2\n3\n\n\n\n# wtforms è¯»åjson\n\nä½¿ç¨wtforms_jsonå¯ä»¥ä½¿è¡¨åç´æ¥å¯¹jsonåæ°çè¯»åã\n\nåå§åwtforms_json\n\né¦ééè¦å¯¹wtforms_jsonåå§åã\nä»£ç : server.py\n\nimport wtforms_json\nwtforms_json.init()\n\n\n1\n2\n\n\nå¨handlerä¸­è·åjsonåæ°ï¼ç¶åè¯»å¥å°formä¸­\n\nä»£ç : apps/school/handler.py\n\nclass TeacherHandler(BaseHandler):\n   \n    async def post(self):\n\n        ret_data = {}\n\n        param = self.request.body.decode("utf8")\n        param = json.loads(param)\n\n        teacherForm = TeacherForm.from_json(param)\n        print(teacherForm.data)\n        if teacherForm.validate():\n            teacher = await self.application.objects.create(Teacher, **teacherForm.data)\n\n            ret_data["ret"] = "success"\n        else:\n            for field in teacherForm.errors:\n                ret_data[field] = teacherForm.errors[field][0]\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n',normalizedContent:'# ç®ä»\n\nå¨è·åè¯·æ±æ¶ï¼éè¦å°è¯·æ±çåæ°è¿è¡éªè¯ã\nä½¿ç¨wtformsåtornadoçç»åï¼å¯ä»¥è·åå°è¯·æ±çåæ°ï¼å¹¶ä¸å¯¹åæ°è¿è¡éªè¯ã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# ä¾å­\n\nåå»ºstudentçform\n\nä»£ç : apps/shchool/forms.py\n\n\nfrom wtforms_tornado import form\nfrom wtforms import stringfield, integerfield, textareafield\nfrom wtforms.validators import datarequired, length\n\nclass studentform(form):\n    """\n    å¯ä»¥ä½ä¸ºstudentç post å put çè¡¨åä½¿ç¨ã\n    """\n\n    id = integerfield("id", null=true)\n    name = stringfield("å§å", validators=[datarequired("è¯·è¾å¥å§å")])\n    age = integerfield("å¹´é¾", validators=[datarequired("è¯·è¾å¥å¹´é¾")])\n    desc = textareafield("ä¸ªäººç®ä»", validators=[datarequired("è¯·è¾å¥ä¸ªäººç®ä»")])\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nç¶åéè¿formæ¥æ¶åæ°ï¼å¯¹åæ°è¿è¡éªè¯ï¼éªè¯éè¿åæä½modelï¼å¯¹æ°æ®åºè¿è¡ä¿å­æä½\n\néè¿éåstudent_from.errorså¾å°æ ¡éªå¤±è´¥çå­æ®µï¼ç¶ååè¿åå°åç«¯æç¤ºã\n\nä»£ç : apps/school/handler.py\n\n\nimport tornado\n\nfrom apps.school.forms import studentform\nfrom apps.school.models import student\nfrom tornado_learning.handler import basehandler\n\nclass studenthandler(basehandler):\n\n        async def post(self):\n\n        ret_data = {}\n\n        student_form = studentform(self.request.arguments)\n        if student_form.validate():\n            await self.application.objects.create(student, **student_form.data)\n\n            ret_data["ret"] = "success"\n        else:\n            for field in student_form.errors:\n                ret_data[field] = ret_data.errors[field][0]\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n\n# htmlè¡¨å\n\nè¿å¯ä»¥éè¿wtformsåå»ºå¯¹åºçmodelæ¨¡æ¿è¡¨åã\n\nä¸ªäººä¸æ¯å¾æ¨èä½¿ç¨ï¼å ä¸ºååç«¯è¦åæ§å¤ªå¼ºã\n\nè·åè¡¨å\n\nä»£ç : apps/school/forms.py\n\nclass studentformhandler(basehandler):\n\n    def get(self):\n        studentform = studentform()\n        return self.render("student.html", studentform=studentform)\n\n\n1\n2\n3\n4\n5\n\n\nè¡¨åçhtmlæ¨¡æ¿\nå°è¯¥æä»¶æ¾å¨templatesè·¯å¾ä¸\n\nä»£ç : templates/student.html\n\n<form action="/student" , method="post">\n    {% autoescape none %}\n    {% for field in studentform %}\n        <span>{{ field.label.text }} :</span>\n        {{ field(placeholder="è¯·è¾å¥"+field.label.text) }}\n\n        {% if field.errors %}\n            {% for error_msg in field.errors %}\n                <div class="error-msg">{{ error_msg }}</div>\n                {% end %}\n                {% else %}\n                <div class="error-msg"></div>\n            {% end %}\n    {% end %}\n\n    <label>\n        <span>&nbsp;</span>\n        <input type="submit" class="button" value="æäº¤"/>\n    </label>\n</form>\n</body>\n</html>\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\néè¦å¨è®¾ç½®é¡¹ä¸­è®¾ç½®æ¨¡æ¿è·¯å¾\nä»£ç :tornado_learning/settings.py\n\nsettings = {\n    "template_path": "templates"\n}\n\n\n1\n2\n3\n\n\n\n# wtforms è¯»åjson\n\nä½¿ç¨wtforms_jsonå¯ä»¥ä½¿è¡¨åç´æ¥å¯¹jsonåæ°çè¯»åã\n\nåå§åwtforms_json\n\né¦ééè¦å¯¹wtforms_jsonåå§åã\nä»£ç : server.py\n\nimport wtforms_json\nwtforms_json.init()\n\n\n1\n2\n\n\nå¨handlerä¸­è·åjsonåæ°ï¼ç¶åè¯»å¥å°formä¸­\n\nä»£ç : apps/school/handler.py\n\nclass teacherhandler(basehandler):\n   \n    async def post(self):\n\n        ret_data = {}\n\n        param = self.request.body.decode("utf8")\n        param = json.loads(param)\n\n        teacherform = teacherform.from_json(param)\n        print(teacherform.data)\n        if teacherform.validate():\n            teacher = await self.application.objects.create(teacher, **teacherform.data)\n\n            ret_data["ret"] = "success"\n        else:\n            for field in teacherform.errors:\n                ret_data[field] = teacherform.errors[field][0]\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"tornado finishåwriteåºå«",frontmatter:{tags:["python","tornado"],title:"tornado finishåwriteåºå«",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/d18657/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»tornadoä¸­finishåwriteçåºå«",feed:{enable:!0},categories:["ç¼ç¨","python","tornado"],comment:!0,meta:[{name:"twitter:title",content:"tornado finishåwriteåºå«"},{name:"twitter:description",content:"ä»ç»tornadoä¸­finishåwriteçåºå«"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/05.tornado%20finish%E5%92%8Cwrite%E5%8C%BA%E5%88%AB.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tornado finishåwriteåºå«"},{property:"og:description",content:"ä»ç»tornadoä¸­finishåwriteçåºå«"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/05.tornado%20finish%E5%92%8Cwrite%E5%8C%BA%E5%88%AB.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"tornado"},{itemprop:"name",content:"tornado finishåwriteåºå«"},{itemprop:"description",content:"ä»ç»tornadoä¸­finishåwriteçåºå«"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/05.tornado%20finish%E5%92%8Cwrite%E5%8C%BA%E5%88%AB.html",relativePath:"04.ç¼ç¨/01.python/08.tornado/05.tornado finishåwriteåºå«.md",key:"v-7f082a66",path:"/pages/d18657/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ä¾å­",slug:"ä¾å­",normalizedTitle:"ä¾å­",charIndex:82},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:556}],headersStr:"ç®ä» ä¾å­ æ»ç»",content:'# ç®ä»\n\nfinishåwriteé½å¯ä»¥å°åç«¯çæ°æ®ä¼ è¾å°åç«¯ãä»ä»¬æå¥å·®å«åã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# ä¾å­\n\nä»£ç apps/hello/write_finish_handler.py\n\nfrom tornado_learning.handler import BaseHandler\nimport time\n\nclass Write_Finish_Handler(BaseHandler):\n\n    def get(self):\n        self.write("hello")\n        time.sleep(4)\n        self.finish("world")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨ç­å¾4ç§åï¼åæ¶è¾åºï¼ hello world\n\nclass Finish_Write_Handler(BaseHandler):\n\n    def get(self):\n        self.finish("hello")\n        self.write("world")\n\n\n1\n2\n3\n4\n5\n\n\nè¾åº: hello\nå¹¶ä¸æ¥é: Cannot write() after finish()\n\n\n# æ»ç»\n\nself.finish()ä»£è¡¨ååºå°åç«¯çç»ç»ãå¹¶ä¸å¯ä»¥å¨finshååä¸äºä¸ååºç»åç«¯æ å³çæä½ï¼ç¼©ç­ååºæ¶é´ã\nself.write()å¹¶ä¸ä¼é©¬ä¸å°æ°æ®è¿ååç«¯ï¼å¿é¡»å¨self.finsh()æèreturnåæä¼ååºï¼ç±»ä¼¼ä»¥ç¼å­å§ã',normalizedContent:'# ç®ä»\n\nfinishåwriteé½å¯ä»¥å°åç«¯çæ°æ®ä¼ è¾å°åç«¯ãä»ä»¬æå¥å·®å«åã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# ä¾å­\n\nä»£ç apps/hello/write_finish_handler.py\n\nfrom tornado_learning.handler import basehandler\nimport time\n\nclass write_finish_handler(basehandler):\n\n    def get(self):\n        self.write("hello")\n        time.sleep(4)\n        self.finish("world")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨ç­å¾4ç§åï¼åæ¶è¾åºï¼ hello world\n\nclass finish_write_handler(basehandler):\n\n    def get(self):\n        self.finish("hello")\n        self.write("world")\n\n\n1\n2\n3\n4\n5\n\n\nè¾åº: hello\nå¹¶ä¸æ¥é: cannot write() after finish()\n\n\n# æ»ç»\n\nself.finish()ä»£è¡¨ååºå°åç«¯çç»ç»ãå¹¶ä¸å¯ä»¥å¨finshååä¸äºä¸ååºç»åç«¯æ å³çæä½ï¼ç¼©ç­ååºæ¶é´ã\nself.write()å¹¶ä¸ä¼é©¬ä¸å°æ°æ®è¿ååç«¯ï¼å¿é¡»å¨self.finsh()æèreturnåæä¼ååºï¼ç±»ä¼¼ä»¥ç¼å­å§ã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pythonç®åä½¿ç¨grpc",frontmatter:{title:"pythonç®åä½¿ç¨grpc",date:"2022-09-06T19:45:31.000Z",permalink:"/pages/f9d78c/",tags:["python"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ç®åä»ç»Pythonå¦ä½ä½¿ç¨grpc",feed:{enable:!0},categories:["ç¼ç¨","python","å¶ä»"],comment:!0,meta:[{name:"twitter:title",content:"pythonç®åä½¿ç¨grpc"},{name:"twitter:description",content:"ç®åä»ç»Pythonå¦ä½ä½¿ç¨grpc"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/01.python%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8grpc.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pythonç®åä½¿ç¨grpc"},{property:"og:description",content:"ç®åä»ç»Pythonå¦ä½ä½¿ç¨grpc"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/01.python%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8grpc.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-09-06T19:45:31.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pythonç®åä½¿ç¨grpc"},{itemprop:"description",content:"ç®åä»ç»Pythonå¦ä½ä½¿ç¨grpc"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/01.python%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8grpc.html",relativePath:"04.ç¼ç¨/01.python/09.å¶ä»/01.pythonç®åä½¿ç¨grpc.md",key:"v-4371bf05",path:"/pages/f9d78c/",headers:[{level:2,title:"0. ç¸å³é¾æ¥",slug:"_0-ç¸å³é¾æ¥",normalizedTitle:"0. ç¸å³é¾æ¥",charIndex:2},{level:2,title:"1. åå»ºprotobufæä»¶",slug:"_1-åå»ºprotobufæä»¶",normalizedTitle:"1. åå»ºprotobufæä»¶",charIndex:117},{level:2,title:"2. ç¼è¯protoæä»¶",slug:"_2-ç¼è¯protoæä»¶",normalizedTitle:"2. ç¼è¯protoæä»¶",charIndex:827},{level:2,title:"3. ç®åæµè¯protobufæ°æ®ç»æçåºååä¸ååºåå",slug:"_3-ç®åæµè¯protobufæ°æ®ç»æçåºååä¸ååºåå",normalizedTitle:"3. ç®åæµè¯protobufæ°æ®ç»æçåºååä¸ååºåå",charIndex:1419},{level:2,title:"4. åå»ºgrpcæå¡ç«¯",slug:"_4-åå»ºgrpcæå¡ç«¯",normalizedTitle:"4. åå»ºgrpcæå¡ç«¯",charIndex:1900},{level:2,title:"5. åå»ºgrpcå®¢æ·ç«¯",slug:"_5-åå»ºgrpcå®¢æ·ç«¯",normalizedTitle:"5. åå»ºgrpcå®¢æ·ç«¯",charIndex:2902}],headersStr:"0. ç¸å³é¾æ¥ 1. åå»ºprotobufæä»¶ 2. ç¼è¯protoæä»¶ 3. ç®åæµè¯protobufæ°æ®ç»æçåºååä¸ååºåå 4. åå»ºgrpcæå¡ç«¯ 5. åå»ºgrpcå®¢æ·ç«¯",content:"# 0. ç¸å³é¾æ¥\n\næºç æ¡ä¾ï¼https://github.com/tenqaz/python-examples\n\nå®æ¹ææ¡£ï¼https://grpc.io/docs/languages/python/quickstart\n\n\n# 1. åå»ºprotobufæä»¶\n\nå¨ç®å½protoç®å½ä¸åå»ºuser.protoæä»¶ï¼åå»ºUserçrpcæå¡å®ä¹ï¼è¯¥æå¡ä¸­åå«AddUseråGetUserä¸¤ä¸ªè°ç¨ï¼å¹¶ä½¿ç¨ä¸é¢åå»ºçå¯¹åºçç»æä½ä½ä¸ºè¯·æ±ä½åååºä½ã æ³¨æï¼éè¦æ·»å package protoï¼å¦åä¸é¢ç¼è¯çæçpythonæä»¶å¼ç¨è·¯å¾åä¸æ­£ç¡®ã\n\nsyntax = \"proto3\";\n\n// åå\npackage proto;\n\n// å®ä¹User rpcæå¡\nservice User {\n  // å®ä¹rpcæå¡çæ¹æ³\n  rpc AddUser (UserRequest) returns (UserResponse);\n  rpc GetUser (GetUserRequest) returns (GetUserResponse);\n}\n\n// è¯·æ±çç»æä½\nmessage UserRequest {\n  string name = 1;\n  uint32 age = 2;\n}\n\n// ååºçç»æä½\nmessage UserResponse {\n  string msg = 1;\n  int32 code = 2;\n}\n\nmessage GetUserRequest {\n  string name = 1;\n}\n\nmessage GetUserResponse {\n  string name = 1;\n  string age = 2;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# 2. ç¼è¯protoæä»¶\n\né¦ééè¦å®è£grpcçåºåå·¥å·\n\npython -m pip install grpcio #å®è£grpc\npython -m pip install grpcio-tools #å®è£grpc tools\n\n\n1\n2\n\n\nç¶åï¼è¿è¡å½ä»¤å¯¹protoæä»¶è¿è¡ç¼è¯ï¼ä¼æ ¹æ®ä¸é¢çprotoæä»¶çæå¯¹åºçpythonæä»¶ï¼ä½ ä¼åç°å¨protoç®å½ä¸åå»ºäºuser_pb2.pyåuser_pb2_grpc.pyä¸¤ä¸ªæä»¶\n\npython -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I. ./proto/user.proto\n\n\n1\n\n * --python_out=.ï¼protobufç¸å³ä»£ç æä»¶çæå¨è¿é\n * --grpc_python_out=.ï¼grpcç¸å³ä»£ç çæå¨è¿é\n * -I. ./proto/user.protoï¼protoæä»¶è·¯å¾\n\nç¼è¯åï¼\n\n * user_pb2.pyï¼ç¨æ¥å protobuf æ°æ®è¿è¡äº¤äºï¼è¿ä¸ªå°±æ¯æ ¹æ®protoæä»¶å®ä¹å¥½çæ°æ®ç»æç±»åçæçpythonåçæ°æ®ç»ææä»¶\n * user_pb2_grpc.py: ç¨æ¥å grpc è¿è¡äº¤äºï¼è¿ä¸ªå°±æ¯å®ä¹äºrpcæ¹æ³çç±»ï¼åå«äºç±»çè¯·æ±åæ°åååºç­ç­ï¼å¯ç¨pythonç´æ¥å®ä¾åè°ç¨\n\n\n# 3. ç®åæµè¯protobufæ°æ®ç»æçåºååä¸ååºåå\n\næä»¬åå»ºproto_test.pyæä»¶ï¼åå»ºUserå¯¹è±¡ï¼å¡«åå¼ï¼å¹¶å°è¯¥å¯¹è±¡åºååæå­ç¬¦ä¸²è¾åº\n\nfrom proto import user_pb2\n\n# åå»ºStudentå¯¹è±¡ï¼å°è¯¥å¯¹è±¡åºååæå­ç¬¦ä¸²\ns = user_pb2.UserRequest()\ns.name = \"zhangsan\"\ns.age = 12\nreq_str = s.SerializeToString()\nprint(req_str)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nè¾åºï¼\n\nb'\\n\\x08zhangsan\\x10\\x0c'\n\n\n1\n\n\nç¶åæä»¬ååå»ºUserå¯¹è±¡å°å°ä¸é¢çè¾åºçåºååå­ç¬¦ä¸²ååºååè¿æ¥ã\n\n# å°ä¸é¢çè¾åºçåºååå­ç¬¦ä¸²ååºååæå¯¹è±¡\ns2 = user_pb2.UserRequest()\ns2.ParseFromString(req_str)\nprint(s2.name)\nprint(s2.age)\n\n\n1\n2\n3\n4\n5\n\n\nè¾åºï¼\n\nzhangsan\n12\n\n\n1\n2\n\n\n\n# 4. åå»ºgrpcæå¡ç«¯\n\nä¸é¢æ¯ä½¿ç¨ä¹ååå»ºçprotobufågrpcæä»¶æ¥æå»ºgrpcæå¡ç«¯ä»£ç ã\n\nimport logging\nfrom concurrent import futures\n\nimport grpc\n\nfrom proto import user_pb2, user_pb2_grpc\n\n\nclass UserService(user_pb2_grpc.UserServicer):\n\n    # å®ç°protoæä»¶ä¸­rpcçè°ç¨\n    def AddUser(self, request: user_pb2.UserRequest, context):\n        return user_pb2.UserResponse(msg='add user(name={},age={}) success'.format(request.name, request.age), code=0)\n\n    def GetUser(self, request: user_pb2.GetUserRequest, context):\n        return user_pb2.GetUserResponse(name=request.name, age=\"1888\")\n\n\ndef serve():\n    # ä½¿ç¨çº¿ç¨æ± æ¥å®ægrpcçè¯·æ±\n    server = grpc.server(futures.ThreadPoolExecutor(max_workers=5))\n    user_pb2_grpc.add_UserServicer_to_server(UserService(), server)\n    server.add_insecure_port('[::]:50051')  # ç»å®ç«¯å£\n    server.start()\n    server.wait_for_termination()\n\n\nif __name__ == '__main__':\n    logging.basicConfig()\n    serve()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\nè¿è¡è¯¥æå¡ç«¯ï¼ä¼é»å¡ç­å¾å®¢æ·ç«¯çè¯·æ±ã\n\n\n# 5. åå»ºgrpcå®¢æ·ç«¯\n\nimport logging\n\nimport grpc\n\nfrom proto import user_pb2, user_pb2_grpc\n\n\ndef run():\n    # è¿æ¥rpcæå¡\n    with grpc.insecure_channel('localhost:50051') as channel:\n        stub = user_pb2_grpc.UserStub(channel)\n\n        # è°ç¨rpcæå¡çAddUseræ¹æ³\n        response: user_pb2.UserResponse = stub.AddUser(user_pb2.UserRequest(name=\"zhangsan\", age=18))\n        print(\"add user, response is 'msg={}, code={}'\".format(response.msg, response.code))\n\n        # è°ç¨rpcæå¡çGetUseræ¹æ³\n        response: user_pb2.GetUserResponse = stub.GetUser(user_pb2.GetUserRequest(name=\"lisi\"))\n        print(\"get user[name={}, age={}]\".format(response.name, response.age))\n\n\nif __name__ == '__main__':\n    logging.basicConfig()\n    run()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\nè¿è¡å®¢æ·ç«¯ï¼è°ç¨rpcæå¡ï¼è¾åºï¼\n\nadd user, response is 'msg=add user(name=zhangsan,age=18) success, code=0'\nget user[name=lisi, age=1888]\n\n\n1\n2\n",normalizedContent:"# 0. ç¸å³é¾æ¥\n\næºç æ¡ä¾ï¼https://github.com/tenqaz/python-examples\n\nå®æ¹ææ¡£ï¼https://grpc.io/docs/languages/python/quickstart\n\n\n# 1. åå»ºprotobufæä»¶\n\nå¨ç®å½protoç®å½ä¸åå»ºuser.protoæä»¶ï¼åå»ºuserçrpcæå¡å®ä¹ï¼è¯¥æå¡ä¸­åå«adduserågetuserä¸¤ä¸ªè°ç¨ï¼å¹¶ä½¿ç¨ä¸é¢åå»ºçå¯¹åºçç»æä½ä½ä¸ºè¯·æ±ä½åååºä½ã æ³¨æï¼éè¦æ·»å package protoï¼å¦åä¸é¢ç¼è¯çæçpythonæä»¶å¼ç¨è·¯å¾åä¸æ­£ç¡®ã\n\nsyntax = \"proto3\";\n\n// åå\npackage proto;\n\n// å®ä¹user rpcæå¡\nservice user {\n  // å®ä¹rpcæå¡çæ¹æ³\n  rpc adduser (userrequest) returns (userresponse);\n  rpc getuser (getuserrequest) returns (getuserresponse);\n}\n\n// è¯·æ±çç»æä½\nmessage userrequest {\n  string name = 1;\n  uint32 age = 2;\n}\n\n// ååºçç»æä½\nmessage userresponse {\n  string msg = 1;\n  int32 code = 2;\n}\n\nmessage getuserrequest {\n  string name = 1;\n}\n\nmessage getuserresponse {\n  string name = 1;\n  string age = 2;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# 2. ç¼è¯protoæä»¶\n\né¦ééè¦å®è£grpcçåºåå·¥å·\n\npython -m pip install grpcio #å®è£grpc\npython -m pip install grpcio-tools #å®è£grpc tools\n\n\n1\n2\n\n\nç¶åï¼è¿è¡å½ä»¤å¯¹protoæä»¶è¿è¡ç¼è¯ï¼ä¼æ ¹æ®ä¸é¢çprotoæä»¶çæå¯¹åºçpythonæä»¶ï¼ä½ ä¼åç°å¨protoç®å½ä¸åå»ºäºuser_pb2.pyåuser_pb2_grpc.pyä¸¤ä¸ªæä»¶\n\npython -m grpc_tools.protoc --python_out=. --grpc_python_out=. -i. ./proto/user.proto\n\n\n1\n\n * --python_out=.ï¼protobufç¸å³ä»£ç æä»¶çæå¨è¿é\n * --grpc_python_out=.ï¼grpcç¸å³ä»£ç çæå¨è¿é\n * -i. ./proto/user.protoï¼protoæä»¶è·¯å¾\n\nç¼è¯åï¼\n\n * user_pb2.pyï¼ç¨æ¥å protobuf æ°æ®è¿è¡äº¤äºï¼è¿ä¸ªå°±æ¯æ ¹æ®protoæä»¶å®ä¹å¥½çæ°æ®ç»æç±»åçæçpythonåçæ°æ®ç»ææä»¶\n * user_pb2_grpc.py: ç¨æ¥å grpc è¿è¡äº¤äºï¼è¿ä¸ªå°±æ¯å®ä¹äºrpcæ¹æ³çç±»ï¼åå«äºç±»çè¯·æ±åæ°åååºç­ç­ï¼å¯ç¨pythonç´æ¥å®ä¾åè°ç¨\n\n\n# 3. ç®åæµè¯protobufæ°æ®ç»æçåºååä¸ååºåå\n\næä»¬åå»ºproto_test.pyæä»¶ï¼åå»ºuserå¯¹è±¡ï¼å¡«åå¼ï¼å¹¶å°è¯¥å¯¹è±¡åºååæå­ç¬¦ä¸²è¾åº\n\nfrom proto import user_pb2\n\n# åå»ºstudentå¯¹è±¡ï¼å°è¯¥å¯¹è±¡åºååæå­ç¬¦ä¸²\ns = user_pb2.userrequest()\ns.name = \"zhangsan\"\ns.age = 12\nreq_str = s.serializetostring()\nprint(req_str)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nè¾åºï¼\n\nb'\\n\\x08zhangsan\\x10\\x0c'\n\n\n1\n\n\nç¶åæä»¬ååå»ºuserå¯¹è±¡å°å°ä¸é¢çè¾åºçåºååå­ç¬¦ä¸²ååºååè¿æ¥ã\n\n# å°ä¸é¢çè¾åºçåºååå­ç¬¦ä¸²ååºååæå¯¹è±¡\ns2 = user_pb2.userrequest()\ns2.parsefromstring(req_str)\nprint(s2.name)\nprint(s2.age)\n\n\n1\n2\n3\n4\n5\n\n\nè¾åºï¼\n\nzhangsan\n12\n\n\n1\n2\n\n\n\n# 4. åå»ºgrpcæå¡ç«¯\n\nä¸é¢æ¯ä½¿ç¨ä¹ååå»ºçprotobufågrpcæä»¶æ¥æå»ºgrpcæå¡ç«¯ä»£ç ã\n\nimport logging\nfrom concurrent import futures\n\nimport grpc\n\nfrom proto import user_pb2, user_pb2_grpc\n\n\nclass userservice(user_pb2_grpc.userservicer):\n\n    # å®ç°protoæä»¶ä¸­rpcçè°ç¨\n    def adduser(self, request: user_pb2.userrequest, context):\n        return user_pb2.userresponse(msg='add user(name={},age={}) success'.format(request.name, request.age), code=0)\n\n    def getuser(self, request: user_pb2.getuserrequest, context):\n        return user_pb2.getuserresponse(name=request.name, age=\"1888\")\n\n\ndef serve():\n    # ä½¿ç¨çº¿ç¨æ± æ¥å®ægrpcçè¯·æ±\n    server = grpc.server(futures.threadpoolexecutor(max_workers=5))\n    user_pb2_grpc.add_userservicer_to_server(userservice(), server)\n    server.add_insecure_port('[::]:50051')  # ç»å®ç«¯å£\n    server.start()\n    server.wait_for_termination()\n\n\nif __name__ == '__main__':\n    logging.basicconfig()\n    serve()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\nè¿è¡è¯¥æå¡ç«¯ï¼ä¼é»å¡ç­å¾å®¢æ·ç«¯çè¯·æ±ã\n\n\n# 5. åå»ºgrpcå®¢æ·ç«¯\n\nimport logging\n\nimport grpc\n\nfrom proto import user_pb2, user_pb2_grpc\n\n\ndef run():\n    # è¿æ¥rpcæå¡\n    with grpc.insecure_channel('localhost:50051') as channel:\n        stub = user_pb2_grpc.userstub(channel)\n\n        # è°ç¨rpcæå¡çadduseræ¹æ³\n        response: user_pb2.userresponse = stub.adduser(user_pb2.userrequest(name=\"zhangsan\", age=18))\n        print(\"add user, response is 'msg={}, code={}'\".format(response.msg, response.code))\n\n        # è°ç¨rpcæå¡çgetuseræ¹æ³\n        response: user_pb2.getuserresponse = stub.getuser(user_pb2.getuserrequest(name=\"lisi\"))\n        print(\"get user[name={}, age={}]\".format(response.name, response.age))\n\n\nif __name__ == '__main__':\n    logging.basicconfig()\n    run()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\nè¿è¡å®¢æ·ç«¯ï¼è°ç¨rpcæå¡ï¼è¾åºï¼\n\nadd user, response is 'msg=add user(name=zhangsan,age=18) success, code=0'\nget user[name=lisi, age=1888]\n\n\n1\n2\n",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½",frontmatter:{tags:["python","tornado"],title:"tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/113ab1/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"tornadoä¸­ä½¿ç¨peewee-asyncæ¥å®æå¼æ­¥ormæ°æ®åºæä½",feed:{enable:!0},categories:["ç¼ç¨","python","tornado"],comment:!0,meta:[{name:"twitter:title",content:"tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½"},{name:"twitter:description",content:"tornadoä¸­ä½¿ç¨peewee-asyncæ¥å®æå¼æ­¥ormæ°æ®åºæä½"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/06.tornado%20%E4%BD%BF%E7%94%A8peewee-async%20%E5%AE%8C%E6%88%90%E5%BC%82%E6%AD%A5orm%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½"},{property:"og:description",content:"tornadoä¸­ä½¿ç¨peewee-asyncæ¥å®æå¼æ­¥ormæ°æ®åºæä½"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/06.tornado%20%E4%BD%BF%E7%94%A8peewee-async%20%E5%AE%8C%E6%88%90%E5%BC%82%E6%AD%A5orm%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{property:"article:tag",content:"tornado"},{itemprop:"name",content:"tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½"},{itemprop:"description",content:"tornadoä¸­ä½¿ç¨peewee-asyncæ¥å®æå¼æ­¥ormæ°æ®åºæä½"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/08.tornado/06.tornado%20%E4%BD%BF%E7%94%A8peewee-async%20%E5%AE%8C%E6%88%90%E5%BC%82%E6%AD%A5orm%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C.html",relativePath:"04.ç¼ç¨/01.python/08.tornado/06.tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½.md",key:"v-13f4cf5a",path:"/pages/113ab1/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"éç½®",slug:"éç½®",normalizedTitle:"éç½®",charIndex:169},{level:2,title:"åå»ºmodel",slug:"åå»ºmodel",normalizedTitle:"åå»ºmodel",charIndex:1026},{level:2,title:"å¢å æ¹æ¥",slug:"å¢å æ¹æ¥",normalizedTitle:"å¢å æ¹æ¥",charIndex:2523},{level:2,title:"è¿è¡¨æ¥è¯¢",slug:"è¿è¡¨æ¥è¯¢",normalizedTitle:"è¿è¡¨æ¥è¯¢",charIndex:4290}],headersStr:"ç®ä» éç½® åå»ºmodel å¢å æ¹æ¥ è¿è¡¨æ¥è¯¢",content:'# ç®ä»\n\ntornadoæ¯ä¸ä¸ªå¼æ­¥webæ¡æ¶ï¼å¶ä¸­ä¸è½ä½¿ç¨é»å¡çæä½ï¼ä¸ç¶ä¼å¯¼è´æ´ä¸ªç¨åºçé»å¡ãæ°æ®åºæä½æ¶ä¸å¯é¿åçéè¦ä½¿ç¨ï¼è¿ééç¨çæ¯peewee-asyncå»è§£å³ã\n\npeewee-async æ¯ä¸ä¸ªä¸º peewee ormæ¡æ¶æä¾å¼æ­¥æ¥å£çåºã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# éç½®\n\nå¨settings.pyæä»¶ä¸­åå»ºè¿æ¥æ°æ®åº\nä»£ç : server.py\n\nimport peewee_async\n\ndatabase = peewee_async.MySQLDatabase("tornado_learning", "127.0.0.1", port=3306, user="root", password="root1234")\n\n\n1\n2\n3\n\n\nå¨server.pyä¸­å¼ç¨æ°æ®åºè¿æ¥ï¼å¹¶å å¥å°appä¸­\n\nfrom peewee_async import Manager\nfrom tornado import web, ioloop\n\nfrom tornado_learning.settings import database\nfrom tornado_learning.settings import settings\nfrom tornado_learning.urls import urlpattern\n\n\ndef make_app():    \n    app = web.Application(urlpattern, debug=True, **settings)    \n    \n    # å°±å¨è¿éæ·»å æ°æ®åºè¿æ¥\n    objects = Manager(database)    \n    \n    # ç¦æ­¢ä½¿ç¨åæ­¥æä½\n    database.set_allow_sync(False)    \n    app.objects = objects    \n    return app\n\nif __name__ == \'__main__\':   \n    app = make_app()   \n    app.listen(8888)    \n    ioloop.IOLoop.current().start()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n\n# åå»ºmodel\n\nåå»ºéç¨çBaseModelç±»\ncreate_timeæ¯æ¯ä¸ªmodelé½éè¦çå­æ®µï¼å°ä¸¤ä¸ªå­æ®µæåå°BaseModelä¸­ã\nidå­æ®µå¨peeweeä¸­ä¼ä¸ºæ¯ä¸ªmodelèªå¨åå»ºã\nä¸ºæ¯ä¸ä¸ªmodelæå®database\nå¨éç½®ç®å½tornado_learningä¸­åå»ºmodel.py\n\nä»£ç : tornado_learning/models\n\nfrom datetime import datetime\n\nfrom peewee import Model, DateTimeField\n\nfrom tornado_learning.settings import database\n\nclass BaseModel(Model):   \n    create_time = DateTimeField(default=datetime.now, verbose_name="åå»ºæ¶é´")    \n    class Meta:        \n        database = database\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nåå»ºmodelç±»\n\n> è¿éçstudentåteacherçå³ç³»æ¯1å¯¹å¤ã\n\nåå»ºstudentçæ¨¡åç±»ã\nä»£ç : apps/school/models.py\n\nfrom peewee import CharField, IntegerField, TextField\nfrom tornado_learning.models import BaseModel\n\nclass Student(BaseModel):    \n    name = CharField(max_length=100, null=False, verbose_name="å­¦çå")    \n    age = IntegerField(null=False, verbose_name="å¹´é¾")    \n    desc = TextField(verbose_name="ä¸ªäººç®ä»")\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåå»ºteacherçæ¨¡åç±»\n\nclass Teacher(BaseModel):    \n    student = ForeignKeyField(rel_model=Student, related_name="teachers")    \n    name = CharField(max_length=100, null=False, verbose_name="èå¸å")   \n    age = IntegerField(null=False, verbose_name="å¹´é¾")   \n    subject = CharField(max_length=100, null=False, verbose_name="å­¦ç§")\n\n\n1\n2\n3\n4\n5\n\n\nä½¿ç¨å·¥å·ç±»åå»ºè¡¨\nå¨tools/init_db.pyä¸­åå§åè¡¨ã\nè¿è¡è¯¥æä»¶å³å¯å¨æ°æ®åºä¸­åå»ºè¡¨\n\nfrom tornado_learning.settings import database\nfrom apps.school.models import Student\n\ndef init_db():    \n    database.create_tables([Student, student])\n\nif __name__ == \'__main__\':    \n    init_db()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# å¢å æ¹æ¥\n\nä¸é¢æ¯å¢å æ¹æ¥çä¾å­ã\n\n> formè¡¨åçä½¿ç¨å¯ä»¥åèæçæç« <<tornado ç»åwtformsä½¿ç¨è¡¨åæä½\n\nä»£ç : apps/school/handler.py\n\n\nimport tornado\n\nfrom apps.school.forms import StudentForm\nfrom apps.school.models import Student\nfrom tornado_learning.handler import BaseHandler\n\nclass StudentHandler(BaseHandler):\n\n    async def get(self):\n        id = self.get_argument("id", None)\n        if not id:\n            return self.write("please provide the \'id\'")\n\n        student = await self.application.objects.get(Student, id=id)\n\n        try:\n            self.write({\n                "id": student.id,\n                "name": student.name\n            })\n        except Student.DoesNotExist:\n            raise tornado.webHttpError(404, "Object not found")\n\n    async def post(self):\n\n        student_form = StudentForm(self.request.arguments)\n        if student_form.validate():\n            await self.application.objects.create(Student, **student_form.data)\n\n            self.write("åå»ºæå")\n        else:\n            self.write("æ ¡éªå¤±è´¥")\n\n    async def delete(self):\n        id = self.get_argument("id", None)\n        if not id:\n            return self.write("please provide the \'id\'")\n\n        student = await self.application.objects.get(Student, id=id)\n        await self.application.objects.delete(student)\n\n        self.write("å é¤æå")\n\n    async def put(self):\n        studentForm = StudentForm(self.request.arguments)\n\n        student = Student(**studentForm.data)\n\n        if studentForm.validate():\n            await self.application.objects.update(student)\n            self.write("æ´æ°æå")\n        else:\n            print(studentForm.errors)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n\n\n\n# è¿è¡¨æ¥è¯¢\n\nå¨teacher modelä¸­æ·»å extendæ¹æ³ï¼æ¼åè¿è¡¨æ¥è¯¢çæ¹æ³ï¼æ¹ä¾¿ä½¿ç¨ã\nä»£ç : apps/school/model.py\n\nclass Teacher(BaseModel):\n    student = ForeignKeyField(rel_model=Student, related_name="teachers")\n    name = CharField(max_length=100, null=False, verbose_name="èå¸å")\n    age = IntegerField(null=False, verbose_name="å¹´é¾")\n    subject = CharField(max_length=100, null=False, verbose_name="å­¦ç§")\n\n    @classmethod\n    def extend(cls):\n        return cls.select(cls, Student.name, Student.age).join(Student)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nä½¿ç¨peeweeæ¼ååºæ¥è¯¢ï¼ç¶åéè¿å¼æ­¥æ§è¡å¾å°ç»æ\nä»£ç : apps/school/handler.py\n\nclass TeacherHandler(BaseHandler):\n\n    async def get(self):\n        ret_data = {"data": []}\n\n        teacher_query = Teacher.extend()\n        teacher_query = teacher_query.filter(Teacher.age > 20)\n        teachers = await self.application.objects.execute(teacher_query)\n\n        for teacher in teachers:\n            item_dict = {\n                "teacher_name": teacher.name,\n                "teacher_age": teacher.age,\n                "student_name": teacher.student.name,\n                "student_age": teacher.student.age\n            }\n            ret_data[\'data\'].append(item_dict)\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n',normalizedContent:'# ç®ä»\n\ntornadoæ¯ä¸ä¸ªå¼æ­¥webæ¡æ¶ï¼å¶ä¸­ä¸è½ä½¿ç¨é»å¡çæä½ï¼ä¸ç¶ä¼å¯¼è´æ´ä¸ªç¨åºçé»å¡ãæ°æ®åºæä½æ¶ä¸å¯é¿åçéè¦ä½¿ç¨ï¼è¿ééç¨çæ¯peewee-asyncå»è§£å³ã\n\npeewee-async æ¯ä¸ä¸ªä¸º peewee ormæ¡æ¶æä¾å¼æ­¥æ¥å£çåºã\n\nè¯¥é¡¹ç®çgithubå°å: tornado_learning.git\n\n\n# éç½®\n\nå¨settings.pyæä»¶ä¸­åå»ºè¿æ¥æ°æ®åº\nä»£ç : server.py\n\nimport peewee_async\n\ndatabase = peewee_async.mysqldatabase("tornado_learning", "127.0.0.1", port=3306, user="root", password="root1234")\n\n\n1\n2\n3\n\n\nå¨server.pyä¸­å¼ç¨æ°æ®åºè¿æ¥ï¼å¹¶å å¥å°appä¸­\n\nfrom peewee_async import manager\nfrom tornado import web, ioloop\n\nfrom tornado_learning.settings import database\nfrom tornado_learning.settings import settings\nfrom tornado_learning.urls import urlpattern\n\n\ndef make_app():    \n    app = web.application(urlpattern, debug=true, **settings)    \n    \n    # å°±å¨è¿éæ·»å æ°æ®åºè¿æ¥\n    objects = manager(database)    \n    \n    # ç¦æ­¢ä½¿ç¨åæ­¥æä½\n    database.set_allow_sync(false)    \n    app.objects = objects    \n    return app\n\nif __name__ == \'__main__\':   \n    app = make_app()   \n    app.listen(8888)    \n    ioloop.ioloop.current().start()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\n\n# åå»ºmodel\n\nåå»ºéç¨çbasemodelç±»\ncreate_timeæ¯æ¯ä¸ªmodelé½éè¦çå­æ®µï¼å°ä¸¤ä¸ªå­æ®µæåå°basemodelä¸­ã\nidå­æ®µå¨peeweeä¸­ä¼ä¸ºæ¯ä¸ªmodelèªå¨åå»ºã\nä¸ºæ¯ä¸ä¸ªmodelæå®database\nå¨éç½®ç®å½tornado_learningä¸­åå»ºmodel.py\n\nä»£ç : tornado_learning/models\n\nfrom datetime import datetime\n\nfrom peewee import model, datetimefield\n\nfrom tornado_learning.settings import database\n\nclass basemodel(model):   \n    create_time = datetimefield(default=datetime.now, verbose_name="åå»ºæ¶é´")    \n    class meta:        \n        database = database\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nåå»ºmodelç±»\n\n> è¿éçstudentåteacherçå³ç³»æ¯1å¯¹å¤ã\n\nåå»ºstudentçæ¨¡åç±»ã\nä»£ç : apps/school/models.py\n\nfrom peewee import charfield, integerfield, textfield\nfrom tornado_learning.models import basemodel\n\nclass student(basemodel):    \n    name = charfield(max_length=100, null=false, verbose_name="å­¦çå")    \n    age = integerfield(null=false, verbose_name="å¹´é¾")    \n    desc = textfield(verbose_name="ä¸ªäººç®ä»")\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåå»ºteacherçæ¨¡åç±»\n\nclass teacher(basemodel):    \n    student = foreignkeyfield(rel_model=student, related_name="teachers")    \n    name = charfield(max_length=100, null=false, verbose_name="èå¸å")   \n    age = integerfield(null=false, verbose_name="å¹´é¾")   \n    subject = charfield(max_length=100, null=false, verbose_name="å­¦ç§")\n\n\n1\n2\n3\n4\n5\n\n\nä½¿ç¨å·¥å·ç±»åå»ºè¡¨\nå¨tools/init_db.pyä¸­åå§åè¡¨ã\nè¿è¡è¯¥æä»¶å³å¯å¨æ°æ®åºä¸­åå»ºè¡¨\n\nfrom tornado_learning.settings import database\nfrom apps.school.models import student\n\ndef init_db():    \n    database.create_tables([student, student])\n\nif __name__ == \'__main__\':    \n    init_db()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# å¢å æ¹æ¥\n\nä¸é¢æ¯å¢å æ¹æ¥çä¾å­ã\n\n> formè¡¨åçä½¿ç¨å¯ä»¥åèæçæç« <<tornado ç»åwtformsä½¿ç¨è¡¨åæä½\n\nä»£ç : apps/school/handler.py\n\n\nimport tornado\n\nfrom apps.school.forms import studentform\nfrom apps.school.models import student\nfrom tornado_learning.handler import basehandler\n\nclass studenthandler(basehandler):\n\n    async def get(self):\n        id = self.get_argument("id", none)\n        if not id:\n            return self.write("please provide the \'id\'")\n\n        student = await self.application.objects.get(student, id=id)\n\n        try:\n            self.write({\n                "id": student.id,\n                "name": student.name\n            })\n        except student.doesnotexist:\n            raise tornado.webhttperror(404, "object not found")\n\n    async def post(self):\n\n        student_form = studentform(self.request.arguments)\n        if student_form.validate():\n            await self.application.objects.create(student, **student_form.data)\n\n            self.write("åå»ºæå")\n        else:\n            self.write("æ ¡éªå¤±è´¥")\n\n    async def delete(self):\n        id = self.get_argument("id", none)\n        if not id:\n            return self.write("please provide the \'id\'")\n\n        student = await self.application.objects.get(student, id=id)\n        await self.application.objects.delete(student)\n\n        self.write("å é¤æå")\n\n    async def put(self):\n        studentform = studentform(self.request.arguments)\n\n        student = student(**studentform.data)\n\n        if studentform.validate():\n            await self.application.objects.update(student)\n            self.write("æ´æ°æå")\n        else:\n            print(studentform.errors)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n\n\n\n# è¿è¡¨æ¥è¯¢\n\nå¨teacher modelä¸­æ·»å extendæ¹æ³ï¼æ¼åè¿è¡¨æ¥è¯¢çæ¹æ³ï¼æ¹ä¾¿ä½¿ç¨ã\nä»£ç : apps/school/model.py\n\nclass teacher(basemodel):\n    student = foreignkeyfield(rel_model=student, related_name="teachers")\n    name = charfield(max_length=100, null=false, verbose_name="èå¸å")\n    age = integerfield(null=false, verbose_name="å¹´é¾")\n    subject = charfield(max_length=100, null=false, verbose_name="å­¦ç§")\n\n    @classmethod\n    def extend(cls):\n        return cls.select(cls, student.name, student.age).join(student)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nä½¿ç¨peeweeæ¼ååºæ¥è¯¢ï¼ç¶åéè¿å¼æ­¥æ§è¡å¾å°ç»æ\nä»£ç : apps/school/handler.py\n\nclass teacherhandler(basehandler):\n\n    async def get(self):\n        ret_data = {"data": []}\n\n        teacher_query = teacher.extend()\n        teacher_query = teacher_query.filter(teacher.age > 20)\n        teachers = await self.application.objects.execute(teacher_query)\n\n        for teacher in teachers:\n            item_dict = {\n                "teacher_name": teacher.name,\n                "teacher_age": teacher.age,\n                "student_name": teacher.student.name,\n                "student_age": teacher.student.age\n            }\n            ret_data[\'data\'].append(item_dict)\n\n        return self.finish(ret_data)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾",frontmatter:{tags:["python"],title:"pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/72664a/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ç®åä»ç»pyspark streamingä»¥åæ¶è´¹kafkaçç¤ºä¾",feed:{enable:!0},categories:["ç¼ç¨","python","å¶ä»"],comment:!0,meta:[{name:"image",content:"https://img-blog.csdnimg.cn/20190416164155495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIyOTE4MjQz,size_16,color_FFFFFF,t_70"},{name:"twitter:title",content:"pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾"},{name:"twitter:description",content:"ç®åä»ç»pyspark streamingä»¥åæ¶è´¹kafkaçç¤ºä¾"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://img-blog.csdnimg.cn/20190416164155495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIyOTE4MjQz,size_16,color_FFFFFF,t_70"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/02.pyspark%20streaming%E7%AE%80%E4%BB%8B%20%E5%92%8C%20%E6%B6%88%E8%B4%B9%20kafka%E7%A4%BA%E4%BE%8B.html"},{property:"og:type",content:"article"},{property:"og:title",content:"pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾"},{property:"og:description",content:"ç®åä»ç»pyspark streamingä»¥åæ¶è´¹kafkaçç¤ºä¾"},{property:"og:image",content:"https://img-blog.csdnimg.cn/20190416164155495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIyOTE4MjQz,size_16,color_FFFFFF,t_70"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/02.pyspark%20streaming%E7%AE%80%E4%BB%8B%20%E5%92%8C%20%E6%B6%88%E8%B4%B9%20kafka%E7%A4%BA%E4%BE%8B.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"python"},{itemprop:"name",content:"pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾"},{itemprop:"description",content:"ç®åä»ç»pyspark streamingä»¥åæ¶è´¹kafkaçç¤ºä¾"},{itemprop:"image",content:"https://img-blog.csdnimg.cn/20190416164155495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIyOTE4MjQz,size_16,color_FFFFFF,t_70"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/02.pyspark%20streaming%E7%AE%80%E4%BB%8B%20%E5%92%8C%20%E6%B6%88%E8%B4%B9%20kafka%E7%A4%BA%E4%BE%8B.html",relativePath:"04.ç¼ç¨/01.python/09.å¶ä»/02.pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾.md",key:"v-ba59602c",path:"/pages/72664a/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"åºç¡æ°æ®æº",slug:"åºç¡æ°æ®æº",normalizedTitle:"åºç¡æ°æ®æº",charIndex:314},{level:2,title:"é«çº§æ°æ®æº",slug:"é«çº§æ°æ®æº",normalizedTitle:"é«çº§æ°æ®æº",charIndex:1431},{level:3,title:"Spark Streaming å kafka æ´å",slug:"spark-streaming-å-kafka-æ´å",normalizedTitle:"spark streaming å kafka æ´å",charIndex:1441}],headersStr:"ç®ä» åºç¡æ°æ®æº é«çº§æ°æ®æº Spark Streaming å kafka æ´å",content:'# ç®ä»\n\n> å¹¶ä¸æ¯çæ­£çå®æ¶å¤çæ¡æ¶ï¼åªæ¯æç§æ¶é´è¿è¡å¾®æ¹å¤çè¿è¡ï¼æ¶é´å¯ä»¥è®¾ç½®çå°½å¯è½çå°ã\n\n> å°ä¸åçé¢æ°æ®æºçæ°æ®ç»è¿SparkStreaming å¤çä¹åå°ç»æè¾åºå°å¤é¨æä»¶ç³»ç»\n\n * ç¹ç¹\n\n> ä½å»¶æ¶ è½ä»éè¯¯ä¸­æç¬çæ¢å¤: fault-tolerant è½å¤è¿è¡å¨æç¾ä¸åçèç¹ è½å¤å°æ¹å¤çãæºå¨å­¦ä¹ ãå¾è®¡ç®ç­èªæ¡æ¶åSpark Streaming ç»¼åèµ·æ¥ä½¿ç¨\n\n * ç²ç²åº¦\n\n> Spark Streamingæ¥æ¶å°å®æ¶æ°æ®æµï¼ææ°æ®æç§æå®çæ¶é´æ®µåæä¸ççå°çæ°æ®åï¼ç¶åæå°çæ°æ®åä¼ ç»Spark Engineå¤çã\n\n * ç»ç²åº¦\n\n * æ°æ®æº kafkaæä¾äºä¸¤ç§æ°æ®æºã\n\n 1. åºç¡æ°æ®æºï¼å¯ä»¥ç´æ¥éè¿streamingContext APIå®ç°ãå¦æä»¶ç³»ç»åsocketè¿æ¥\n 2. é«çº§çæ°æ®æºï¼å¦Kafka, Flume, Kinesisç­ç­. å¯ä»¥éè¿é¢å¤çç±»åºå»å®ç°ã\n\n\n# åºç¡æ°æ®æº\n\n 1. ä½¿ç¨å®æ¹çæ¡ä¾\n\n/spark/examples/src/main/python/streaming\n\nnc -lk 6789\n\n 2. å¤çsocketæ°æ®\n\nç¤ºä¾ä»£ç å¦ä¸: è¯»åsocketä¸­çæ°æ®è¿è¡æµå¤ç\n\nfrom pyspark import SparkContext\nfrom pyspark.streaming import StreamingContext\n\n# local å¿é¡»è®¾ä¸º2\nsc = SparkContext("local[2]", "NetworkWordCount")\nssc = StreamingContext(sc, 1)\n\nlines = ssc.socketTextStream("localhost", 9999)\n\nwords = lines.flatMap(lambda line: line.split(" "))\n\npairs = words.map(lambda word: (word, 1))\nwordCounts = pairs.reduceByKey(lambda x, y: x + y)\n\nwordCounts.pprint()\n\nssc.start()\nssc.awaitTermination()\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\næµè¯\n\n> nc -lk 9999\n\n 3. å¤çæä»¶ç³»ç»æ°æ®\n\n> æä»¶ç³»ç»(fileStream(that is, HDFSM S3, NFS))æä¸æ¯æpythonï¼pythonä»æ¯æææ¬æä»¶(textFileStream)\n\nç¤ºä¾å¦ä¸ï¼ä½æªæåï¼æ¾ä¸å°è¯¥æä»¶ã\n\n\nlines = ssc.textFileStream("hdfs://txz-data0:9820/user/jim/workflow/crash/python/crash_2_hdfs.py")\n\n\n\n1\n2\n3\n\n\n * streaming context\n\n * DStreams\n\n> æç»­åçæ°æ®æµ å¯¹DStreamæä½ç®å­ï¼ æ¯å¦map/flatMap,å¶å®åºå±ä¼è¢«ç¿»è¯ä¸ºå¯¹DStreamä¸­çæ¯ä¸ªRDDé½åç¸åçæä½ï¼å ä¸ºä¸ä¸ªDStreamæ¯ç±ä¸åæ¹æ¬¡çRDDæ\n\n * Input DStreams and Receivers\n\n\n# é«çº§æ°æ®æº\n\n\n# Spark Streaming å kafka æ´å\n\nä¸¤ç§æ¨¡å¼\n\n * receiver æ¨¡å¼\n\nfrom pyspark.streaming.kafka import KafkaUtils\nfrom pyspark import SparkContext\nfrom pyspark.streaming import StreamingContext\n\nsc = SparkContext("local[2]", "NetworkWordCount")\nsc.setLogLevel("OFF")\nssc = StreamingContext(sc, 1)\n\n# åå»ºKafka streaming\nline = KafkaUtils.createStream(ssc, "192.168.0.208:2181", \'test\', {"jim_test": 1})\n\n# åè¯\nwords = line.flatMap(lambda line: line.split(" "))\npairs = words.map(lambda word: (word, 1))\nwordCounts = pairs.reduceByKey(lambda x, y: x + y)\nwordCounts.pprint()\n\nssc.start()\nssc.awaitTermination()\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n * no receiver\n\næ ¹æ®ä¸é¢çä»£ç æ¿æ¢æcreateStreamå³å¯ã\n\nline = KafkaUtils.createDirectStream(ssc, ["jim_test"], {"metadata.broker.list": "192.168.0.208:9092"})\n\n\n1\n\n\nè¿è¡:\n\n> spark-submit --jars spark-streaming-kafka-0-8-assembly_2.11-2.4.0.jar test_spark_stream.py\n\néè¦ä¸è½½ç¸åºçjarå.ä¸è½½å°åå¦ä¸ï¼æç´¢ã https://search.maven.org\n\njarçæ¬ä¼å¨è¿è¡ç¨åºæ¶æ¥éæéã',normalizedContent:'# ç®ä»\n\n> å¹¶ä¸æ¯çæ­£çå®æ¶å¤çæ¡æ¶ï¼åªæ¯æç§æ¶é´è¿è¡å¾®æ¹å¤çè¿è¡ï¼æ¶é´å¯ä»¥è®¾ç½®çå°½å¯è½çå°ã\n\n> å°ä¸åçé¢æ°æ®æºçæ°æ®ç»è¿sparkstreaming å¤çä¹åå°ç»æè¾åºå°å¤é¨æä»¶ç³»ç»\n\n * ç¹ç¹\n\n> ä½å»¶æ¶ è½ä»éè¯¯ä¸­æç¬çæ¢å¤: fault-tolerant è½å¤è¿è¡å¨æç¾ä¸åçèç¹ è½å¤å°æ¹å¤çãæºå¨å­¦ä¹ ãå¾è®¡ç®ç­èªæ¡æ¶åspark streaming ç»¼åèµ·æ¥ä½¿ç¨\n\n * ç²ç²åº¦\n\n> spark streamingæ¥æ¶å°å®æ¶æ°æ®æµï¼ææ°æ®æç§æå®çæ¶é´æ®µåæä¸ççå°çæ°æ®åï¼ç¶åæå°çæ°æ®åä¼ ç»spark engineå¤çã\n\n * ç»ç²åº¦\n\n * æ°æ®æº kafkaæä¾äºä¸¤ç§æ°æ®æºã\n\n 1. åºç¡æ°æ®æºï¼å¯ä»¥ç´æ¥éè¿streamingcontext apiå®ç°ãå¦æä»¶ç³»ç»åsocketè¿æ¥\n 2. é«çº§çæ°æ®æºï¼å¦kafka, flume, kinesisç­ç­. å¯ä»¥éè¿é¢å¤çç±»åºå»å®ç°ã\n\n\n# åºç¡æ°æ®æº\n\n 1. ä½¿ç¨å®æ¹çæ¡ä¾\n\n/spark/examples/src/main/python/streaming\n\nnc -lk 6789\n\n 2. å¤çsocketæ°æ®\n\nç¤ºä¾ä»£ç å¦ä¸: è¯»åsocketä¸­çæ°æ®è¿è¡æµå¤ç\n\nfrom pyspark import sparkcontext\nfrom pyspark.streaming import streamingcontext\n\n# local å¿é¡»è®¾ä¸º2\nsc = sparkcontext("local[2]", "networkwordcount")\nssc = streamingcontext(sc, 1)\n\nlines = ssc.sockettextstream("localhost", 9999)\n\nwords = lines.flatmap(lambda line: line.split(" "))\n\npairs = words.map(lambda word: (word, 1))\nwordcounts = pairs.reducebykey(lambda x, y: x + y)\n\nwordcounts.pprint()\n\nssc.start()\nssc.awaittermination()\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\næµè¯\n\n> nc -lk 9999\n\n 3. å¤çæä»¶ç³»ç»æ°æ®\n\n> æä»¶ç³»ç»(filestream(that is, hdfsm s3, nfs))æä¸æ¯æpythonï¼pythonä»æ¯æææ¬æä»¶(textfilestream)\n\nç¤ºä¾å¦ä¸ï¼ä½æªæåï¼æ¾ä¸å°è¯¥æä»¶ã\n\n\nlines = ssc.textfilestream("hdfs://txz-data0:9820/user/jim/workflow/crash/python/crash_2_hdfs.py")\n\n\n\n1\n2\n3\n\n\n * streaming context\n\n * dstreams\n\n> æç»­åçæ°æ®æµ å¯¹dstreamæä½ç®å­ï¼ æ¯å¦map/flatmap,å¶å®åºå±ä¼è¢«ç¿»è¯ä¸ºå¯¹dstreamä¸­çæ¯ä¸ªrddé½åç¸åçæä½ï¼å ä¸ºä¸ä¸ªdstreamæ¯ç±ä¸åæ¹æ¬¡çrddæ\n\n * input dstreams and receivers\n\n\n# é«çº§æ°æ®æº\n\n\n# spark streaming å kafka æ´å\n\nä¸¤ç§æ¨¡å¼\n\n * receiver æ¨¡å¼\n\nfrom pyspark.streaming.kafka import kafkautils\nfrom pyspark import sparkcontext\nfrom pyspark.streaming import streamingcontext\n\nsc = sparkcontext("local[2]", "networkwordcount")\nsc.setloglevel("off")\nssc = streamingcontext(sc, 1)\n\n# åå»ºkafka streaming\nline = kafkautils.createstream(ssc, "192.168.0.208:2181", \'test\', {"jim_test": 1})\n\n# åè¯\nwords = line.flatmap(lambda line: line.split(" "))\npairs = words.map(lambda word: (word, 1))\nwordcounts = pairs.reducebykey(lambda x, y: x + y)\nwordcounts.pprint()\n\nssc.start()\nssc.awaittermination()\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n * no receiver\n\næ ¹æ®ä¸é¢çä»£ç æ¿æ¢æcreatestreamå³å¯ã\n\nline = kafkautils.createdirectstream(ssc, ["jim_test"], {"metadata.broker.list": "192.168.0.208:9092"})\n\n\n1\n\n\nè¿è¡:\n\n> spark-submit --jars spark-streaming-kafka-0-8-assembly_2.11-2.4.0.jar test_spark_stream.py\n\néè¦ä¸è½½ç¸åºçjarå.ä¸è½½å°åå¦ä¸ï¼æç´¢ã https://search.maven.org\n\njarçæ¬ä¼å¨è¿è¡ç¨åºæ¶æ¥éæéã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ",frontmatter:{title:"åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ",date:"2025-05-12T12:46:45.000Z",permalink:"/pages/7f6078/",categories:["ç¼ç¨","python","å¶ä»"],tags:["ç¼ç å·¥å·"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"pre-commit æ¯ä¸ä¸ªå¼æºå·¥å·ï¼ç¨äºç®¡çåæ§è¡ Git é©å­ï¼ç¡®ä¿ä»£ç åºçä¸è´æ§åè´¨éãéè¿å¨æäº¤ä»£ç åèªå¨è¿è¡ä»£ç é£æ ¼æ£æ¥ï¼Lintingï¼åæ ¼å¼ä¿®æ­£ï¼Formattingï¼ï¼å®æå©äºä¿æé¡¹ç®ä»£ç çç»ä¸æ åãæ¬æå°éè¿ä¸ä¸ª Python é¡¹ç®çå®ä¾ï¼å±ç¤ºå¦ä½éç½® pre-commit å·¥ä½æµãæ¬ææ¨å¨ä»ç»ä½¿ç¨ pre-commit å¯¹ Python é¡¹ç®è¿è¡ä»£ç æ£æ¥çæ¹æ³ï¼ä»¥æååç°å¹¶è§£å³ä»£ç ä¸­çé®é¢ï¼æé«ä»£ç çæ´ä½è´¨éã",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ"},{name:"twitter:description",content:"pre-commit æ¯ä¸ä¸ªå¼æºå·¥å·ï¼ç¨äºç®¡çåæ§è¡ Git é©å­ï¼ç¡®ä¿ä»£ç åºçä¸è´æ§åè´¨éãéè¿å¨æäº¤ä»£ç åèªå¨è¿è¡ä»£ç é£æ ¼æ£æ¥ï¼Lintingï¼åæ ¼å¼ä¿®æ­£ï¼Formattingï¼ï¼å®æå©äºä¿æé¡¹ç®ä»£ç çç»ä¸æ åãæ¬æå°éè¿ä¸ä¸ª Python é¡¹ç®çå®ä¾ï¼å±ç¤ºå¦ä½éç½® pre-commit å·¥ä½æµãæ¬ææ¨å¨ä»ç»ä½¿ç¨ pre-commit å¯¹ Python é¡¹ç®è¿è¡ä»£ç æ£æ¥çæ¹æ³ï¼ä»¥æååç°å¹¶è§£å³ä»£ç ä¸­çé®é¢ï¼æé«ä»£ç çæ´ä½è´¨éã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/03.%E5%9F%BA%E4%BA%8Epre-commit%E7%9A%84Python%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ"},{property:"og:description",content:"pre-commit æ¯ä¸ä¸ªå¼æºå·¥å·ï¼ç¨äºç®¡çåæ§è¡ Git é©å­ï¼ç¡®ä¿ä»£ç åºçä¸è´æ§åè´¨éãéè¿å¨æäº¤ä»£ç åèªå¨è¿è¡ä»£ç é£æ ¼æ£æ¥ï¼Lintingï¼åæ ¼å¼ä¿®æ­£ï¼Formattingï¼ï¼å®æå©äºä¿æé¡¹ç®ä»£ç çç»ä¸æ åãæ¬æå°éè¿ä¸ä¸ª Python é¡¹ç®çå®ä¾ï¼å±ç¤ºå¦ä½éç½® pre-commit å·¥ä½æµãæ¬ææ¨å¨ä»ç»ä½¿ç¨ pre-commit å¯¹ Python é¡¹ç®è¿è¡ä»£ç æ£æ¥çæ¹æ³ï¼ä»¥æååç°å¹¶è§£å³ä»£ç ä¸­çé®é¢ï¼æé«ä»£ç çæ´ä½è´¨éã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/03.%E5%9F%BA%E4%BA%8Epre-commit%E7%9A%84Python%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-05-12T12:46:45.000Z"},{property:"article:tag",content:"ç¼ç å·¥å·"},{itemprop:"name",content:"åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ"},{itemprop:"description",content:"pre-commit æ¯ä¸ä¸ªå¼æºå·¥å·ï¼ç¨äºç®¡çåæ§è¡ Git é©å­ï¼ç¡®ä¿ä»£ç åºçä¸è´æ§åè´¨éãéè¿å¨æäº¤ä»£ç åèªå¨è¿è¡ä»£ç é£æ ¼æ£æ¥ï¼Lintingï¼åæ ¼å¼ä¿®æ­£ï¼Formattingï¼ï¼å®æå©äºä¿æé¡¹ç®ä»£ç çç»ä¸æ åãæ¬æå°éè¿ä¸ä¸ª Python é¡¹ç®çå®ä¾ï¼å±ç¤ºå¦ä½éç½® pre-commit å·¥ä½æµãæ¬ææ¨å¨ä»ç»ä½¿ç¨ pre-commit å¯¹ Python é¡¹ç®è¿è¡ä»£ç æ£æ¥çæ¹æ³ï¼ä»¥æååç°å¹¶è§£å³ä»£ç ä¸­çé®é¢ï¼æé«ä»£ç çæ´ä½è´¨éã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/01.python/09.%E5%85%B6%E4%BB%96/03.%E5%9F%BA%E4%BA%8Epre-commit%E7%9A%84Python%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5.html",relativePath:"04.ç¼ç¨/01.python/09.å¶ä»/03.åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ.md",key:"v-4edff9fd",path:"/pages/7f6078/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ä½¿ç¨",slug:"ä½¿ç¨",normalizedTitle:"ä½¿ç¨",charIndex:165},{level:2,title:"æä½³å®è·µ",slug:"æä½³å®è·µ",normalizedTitle:"æä½³å®è·µ",charIndex:2956},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:3082}],headersStr:"ç®ä» ä½¿ç¨ æä½³å®è·µ æ»ç»",content:'# ç®ä»\n\npre-commit æ¯ä¸ä¸ªå¼æºå·¥å·ï¼ç¨äºç®¡çåæ§è¡ Git é©å­ï¼ç¡®ä¿ä»£ç åºçä¸è´æ§åè´¨éãéè¿å¨æäº¤ä»£ç åèªå¨è¿è¡ä»£ç é£æ ¼æ£æ¥ï¼Lintingï¼åæ ¼å¼ä¿®æ­£ï¼Formattingï¼ï¼å®æå©äºä¿æé¡¹ç®ä»£ç çç»ä¸æ åãæ¬æå°éè¿ä¸ä¸ª Python é¡¹ç®çå®ä¾ï¼å±ç¤ºå¦ä½éç½® pre-commit å·¥ä½æµã\n\næ¬ææ¨å¨ä»ç»ä½¿ç¨ pre-commit å¯¹ Python é¡¹ç®è¿è¡ä»£ç æ£æ¥çæ¹æ³ï¼ä»¥æååç°å¹¶è§£å³ä»£ç ä¸­çé®é¢ï¼æé«ä»£ç çæ´ä½è´¨éãæä¸­æåçææä»£ç ç¤ºä¾å¯ä»¥å¨ pre-commit-demo æ¾å°ã\n\n\n# ä½¿ç¨\n\n 1. å®è£\n\né¦åï¼å®è£ pre-commitï¼\n\npip install pre-commit\n\n\n1\n\n\nå®è£æååï¼æ¨å¯ä»¥éè¿ä»¥ä¸å½ä»¤éªè¯å®è£æ¯å¦æåï¼\n\n$ pre-commit --version \npre-commit 4.2.0\n\n\n1\n2\n\n\næ¥ä¸æ¥ï¼è®¾ç½® Git é©å­èæ¬ï¼\n\n$ pre-commit install\npre-commit installed at .git/hooks/pre-commit\n\n\n1\n2\n\n 1. åå»ºéç½®æä»¶ å¨é¡¹ç®çæ ¹ç®å½ä¸åå»º .pre-commit-config.yaml æä»¶ï¼å¹¶æ¨èä½¿ç¨ææ°ç¨³å®çï¼\n\nrepos:\n  - repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v2.3.0\n    hooks:\n      - id: check-yaml\n      - id: check-json\n      - id: check-toml\n      - id: end-of-file-fixer\n      - id: trailing-whitespace\n  - repo: https://github.com/psf/black\n    rev: 22.10.0\n    hooks:\n      - id: black\n  - repo: https://github.com/PyCQA/isort\n    rev: 5.13.2\n    hooks:\n      - id: isort\n  - repo: https://github.com/PyCQA/flake8\n    rev: 7.2.0\n    hooks:\n      - id: flake8\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\néç½®æä»¶è¯´æ:\n\n * repos: åå«è¦ä½¿ç¨çä»åºåè¡¨ã\n * repo: æ¯ä¸ªä»åºç URLã\n * rev: çæ¬å·ï¼å»ºè®®ä½¿ç¨ææ°ç¨³å®çã\n * hooks: éè¦æ§è¡çé©å­åè¡¨ã\n * id: åä¸ªé©å­çæ è¯ç¬¦ã\n\næ¯ä¸ªé©å­ ID çå·ä½ä½ç¨å¯åèç¸åºä»åºçå®æ¹ææ¡£ã\n\n 3. æ§è¡ä¸åºç¨\n\nå¨æ§è¡ commit å½ä»¤æ¶ï¼ä¼èªå¨è°ç¨éç½®æä»¶ä¸­å®ä¹çé©å­èæ¬ï¼æ£æ¥ä»£ç æ¯å¦ç¬¦åè§èãä¾å¦ï¼\n\n$ pre-commit_demo % git add *\n$ pre-commit_demo % git commit -m "add main.py"\nCheck Yaml...........................................(no files to check)Skipped\nCheck JSON...........................................(no files to check)Skipped\nCheck Toml...........................................(no files to check)Skipped\nFix End of Files.........................................................Passed\nTrim Trailing Whitespace.................................................Passed\nblack....................................................................Passed\nisort....................................................................Passed\nflake8...................................................................Passed\n[main 27890fe] add main.py\n 1 file changed, 1 insertion(+)\n create mode 100644 main.py\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\né»è®¤æåµä¸ï¼ä»æ£æ¥æ°æ·»å æä¿®æ¹çæä»¶ãè¥éæå¨æ£æ¥æææä»¶ï¼å¯ä»¥ä½¿ç¨å¦ä¸å½ä»¤ï¼\n\n$ pre-commit run --all-files\nCheck Yaml...............................................................Passed\nCheck JSON...........................................(no files to check)Skipped\nCheck Toml...............................................................Passed\nFix End of Files.........................................................Passed\nTrim Trailing Whitespace.................................................Passed\nblack....................................................................Passed\nisort....................................................................Passed\nflake8...................................................................Passed\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¦éä¸´æ¶è·³è¿æ ¡éªï¼å¯å¨ commit å½ä»¤ä¸­å ä¸ --no-verify åæ°ï¼\n\n$ git commit -m "add main.py" --no-verify\n\n\n1\n\n\n\n# æä½³å®è·µ\n\n 1. å°.pre-commit-config.yamlçº³å¥çæ¬æ§å¶ï¼ç¡®ä¿å¢ééç½®ä¸è´\n 2. å®æè¿è¡pre-commit autoupdateä¿æå·¥å·ææ°çæ¬\n 3. ä¼åä¿®å¤èä¸æ¯--no-verifyï¼è®©è§èæä¸ºèèè®°å¿.\n\n\n# æ»ç»\n\néè¿æ¬æçå®è·µï¼æä»¬å·²ç»ä¸ºPythoné¡¹ç®æ­å»ºäºèªå¨åä»£ç è´¨æ£æµæ°´çº¿ãpre-commit å°±åä¸ä½å°½èçä»£ç å®¡æ¥åï¼å¸®æä»¬åå°ï¼\n\n * è§èå®æ¤èï¼èªå¨æ§è¡ä»£ç æ ¼å¼åï¼Black/isortï¼åéææ£æ¥ï¼flake8ï¼\n * æçå éå¨ï¼æ¦æªé®é¢å¨æäº¤åï¼é¿åCI/CDç¯èåå¤è¿å·¥\n * å¢éåä½èï¼ç»ä¸é¡¹ç®ä»£ç é£æ ¼ï¼éä½å¤äººåä½ææ¬',normalizedContent:'# ç®ä»\n\npre-commit æ¯ä¸ä¸ªå¼æºå·¥å·ï¼ç¨äºç®¡çåæ§è¡ git é©å­ï¼ç¡®ä¿ä»£ç åºçä¸è´æ§åè´¨éãéè¿å¨æäº¤ä»£ç åèªå¨è¿è¡ä»£ç é£æ ¼æ£æ¥ï¼lintingï¼åæ ¼å¼ä¿®æ­£ï¼formattingï¼ï¼å®æå©äºä¿æé¡¹ç®ä»£ç çç»ä¸æ åãæ¬æå°éè¿ä¸ä¸ª python é¡¹ç®çå®ä¾ï¼å±ç¤ºå¦ä½éç½® pre-commit å·¥ä½æµã\n\næ¬ææ¨å¨ä»ç»ä½¿ç¨ pre-commit å¯¹ python é¡¹ç®è¿è¡ä»£ç æ£æ¥çæ¹æ³ï¼ä»¥æååç°å¹¶è§£å³ä»£ç ä¸­çé®é¢ï¼æé«ä»£ç çæ´ä½è´¨éãæä¸­æåçææä»£ç ç¤ºä¾å¯ä»¥å¨ pre-commit-demo æ¾å°ã\n\n\n# ä½¿ç¨\n\n 1. å®è£\n\né¦åï¼å®è£ pre-commitï¼\n\npip install pre-commit\n\n\n1\n\n\nå®è£æååï¼æ¨å¯ä»¥éè¿ä»¥ä¸å½ä»¤éªè¯å®è£æ¯å¦æåï¼\n\n$ pre-commit --version \npre-commit 4.2.0\n\n\n1\n2\n\n\næ¥ä¸æ¥ï¼è®¾ç½® git é©å­èæ¬ï¼\n\n$ pre-commit install\npre-commit installed at .git/hooks/pre-commit\n\n\n1\n2\n\n 1. åå»ºéç½®æä»¶ å¨é¡¹ç®çæ ¹ç®å½ä¸åå»º .pre-commit-config.yaml æä»¶ï¼å¹¶æ¨èä½¿ç¨ææ°ç¨³å®çï¼\n\nrepos:\n  - repo: https://github.com/pre-commit/pre-commit-hooks\n    rev: v2.3.0\n    hooks:\n      - id: check-yaml\n      - id: check-json\n      - id: check-toml\n      - id: end-of-file-fixer\n      - id: trailing-whitespace\n  - repo: https://github.com/psf/black\n    rev: 22.10.0\n    hooks:\n      - id: black\n  - repo: https://github.com/pycqa/isort\n    rev: 5.13.2\n    hooks:\n      - id: isort\n  - repo: https://github.com/pycqa/flake8\n    rev: 7.2.0\n    hooks:\n      - id: flake8\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\néç½®æä»¶è¯´æ:\n\n * repos: åå«è¦ä½¿ç¨çä»åºåè¡¨ã\n * repo: æ¯ä¸ªä»åºç urlã\n * rev: çæ¬å·ï¼å»ºè®®ä½¿ç¨ææ°ç¨³å®çã\n * hooks: éè¦æ§è¡çé©å­åè¡¨ã\n * id: åä¸ªé©å­çæ è¯ç¬¦ã\n\næ¯ä¸ªé©å­ id çå·ä½ä½ç¨å¯åèç¸åºä»åºçå®æ¹ææ¡£ã\n\n 3. æ§è¡ä¸åºç¨\n\nå¨æ§è¡ commit å½ä»¤æ¶ï¼ä¼èªå¨è°ç¨éç½®æä»¶ä¸­å®ä¹çé©å­èæ¬ï¼æ£æ¥ä»£ç æ¯å¦ç¬¦åè§èãä¾å¦ï¼\n\n$ pre-commit_demo % git add *\n$ pre-commit_demo % git commit -m "add main.py"\ncheck yaml...........................................(no files to check)skipped\ncheck json...........................................(no files to check)skipped\ncheck toml...........................................(no files to check)skipped\nfix end of files.........................................................passed\ntrim trailing whitespace.................................................passed\nblack....................................................................passed\nisort....................................................................passed\nflake8...................................................................passed\n[main 27890fe] add main.py\n 1 file changed, 1 insertion(+)\n create mode 100644 main.py\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\né»è®¤æåµä¸ï¼ä»æ£æ¥æ°æ·»å æä¿®æ¹çæä»¶ãè¥éæå¨æ£æ¥æææä»¶ï¼å¯ä»¥ä½¿ç¨å¦ä¸å½ä»¤ï¼\n\n$ pre-commit run --all-files\ncheck yaml...............................................................passed\ncheck json...........................................(no files to check)skipped\ncheck toml...............................................................passed\nfix end of files.........................................................passed\ntrim trailing whitespace.................................................passed\nblack....................................................................passed\nisort....................................................................passed\nflake8...................................................................passed\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¦éä¸´æ¶è·³è¿æ ¡éªï¼å¯å¨ commit å½ä»¤ä¸­å ä¸ --no-verify åæ°ï¼\n\n$ git commit -m "add main.py" --no-verify\n\n\n1\n\n\n\n# æä½³å®è·µ\n\n 1. å°.pre-commit-config.yamlçº³å¥çæ¬æ§å¶ï¼ç¡®ä¿å¢ééç½®ä¸è´\n 2. å®æè¿è¡pre-commit autoupdateä¿æå·¥å·ææ°çæ¬\n 3. ä¼åä¿®å¤èä¸æ¯--no-verifyï¼è®©è§èæä¸ºèèè®°å¿.\n\n\n# æ»ç»\n\néè¿æ¬æçå®è·µï¼æä»¬å·²ç»ä¸ºpythoné¡¹ç®æ­å»ºäºèªå¨åä»£ç è´¨æ£æµæ°´çº¿ãpre-commit å°±åä¸ä½å°½èçä»£ç å®¡æ¥åï¼å¸®æä»¬åå°ï¼\n\n * è§èå®æ¤èï¼èªå¨æ§è¡ä»£ç æ ¼å¼åï¼black/isortï¼åéææ£æ¥ï¼flake8ï¼\n * æçå éå¨ï¼æ¦æªé®é¢å¨æäº¤åï¼é¿åci/cdç¯èåå¤è¿å·¥\n * å¢éåä½èï¼ç»ä¸é¡¹ç®ä»£ç é£æ ¼ï¼éä½å¤äººåä½ææ¬',charsets:{cjk:!0},lastUpdated:"2025/05/13, 17:42:32",lastUpdatedTimestamp:1747129352e3},{title:"ginä¸­validatoræ¨¡åçæºç åæ",frontmatter:{tags:["goè¯­è¨","gin"],title:"ginä¸­validatoræ¨¡åçæºç åæ",date:"2022-09-11T16:23:04.000Z",permalink:"/pages/c41003/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨ginä¸­ä½¿ç¨çæ¯validatoræ¨¡åæ¥å¯¹è¡¨åè¿è¡æ ¡éªçï¼æ¬æä¸»è¦æ¯å¯¹è¯¥æ¨¡åçæºç åæä¸å­¦ä¹ ",feed:{enable:!0},categories:["ç¼ç¨","goè¯­è¨"],comment:!0,meta:[{name:"twitter:title",content:"ginä¸­validatoræ¨¡åçæºç åæ"},{name:"twitter:description",content:"å¨ginä¸­ä½¿ç¨çæ¯validatoræ¨¡åæ¥å¯¹è¡¨åè¿è¡æ ¡éªçï¼æ¬æä¸»è¦æ¯å¯¹è¯¥æ¨¡åçæºç åæä¸å­¦ä¹ "},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/02.%20gin%E4%B8%ADvalidator%E6%A8%A1%E5%9D%97%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ginä¸­validatoræ¨¡åçæºç åæ"},{property:"og:description",content:"å¨ginä¸­ä½¿ç¨çæ¯validatoræ¨¡åæ¥å¯¹è¡¨åè¿è¡æ ¡éªçï¼æ¬æä¸»è¦æ¯å¯¹è¯¥æ¨¡åçæºç åæä¸å­¦ä¹ "},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/02.%20gin%E4%B8%ADvalidator%E6%A8%A1%E5%9D%97%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-09-11T16:23:04.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"gin"},{itemprop:"name",content:"ginä¸­validatoræ¨¡åçæºç åæ"},{itemprop:"description",content:"å¨ginä¸­ä½¿ç¨çæ¯validatoræ¨¡åæ¥å¯¹è¡¨åè¿è¡æ ¡éªçï¼æ¬æä¸»è¦æ¯å¯¹è¯¥æ¨¡åçæºç åæä¸å­¦ä¹ "}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/02.%20gin%E4%B8%ADvalidator%E6%A8%A1%E5%9D%97%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/02. ginä¸­validatoræ¨¡åçæºç åæ.md",key:"v-69c6394c",path:"/pages/c41003/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"æå è½½validateå¯¹è±¡",slug:"æå è½½validateå¯¹è±¡",normalizedTitle:"æå è½½validateå¯¹è±¡",charIndex:62},{level:2,title:"å¤ç§è¯·æ±åæ°çæ ¡éª",slug:"å¤ç§è¯·æ±åæ°çæ ¡éª",normalizedTitle:"å¤ç§è¯·æ±åæ°çæ ¡éª",charIndex:1555},{level:2,title:"é©å­æ¹æ³",slug:"é©å­æ¹æ³",normalizedTitle:"é©å­æ¹æ³",charIndex:3621},{level:2,title:"å¯¹è±¡æ± çåºç¨",slug:"å¯¹è±¡æ± çåºç¨",normalizedTitle:"å¯¹è±¡æ± çåºç¨",charIndex:4816},{level:2,title:"æ ¹æ®æ ç­¾æ ¡éªè¿ç¨",slug:"æ ¹æ®æ ç­¾æ ¡éªè¿ç¨",normalizedTitle:"æ ¹æ®æ ç­¾æ ¡éªè¿ç¨",charIndex:6027},{level:2,title:"éè¯¯æç¤ºä¿¡æ¯ç¿»è¯",slug:"éè¯¯æç¤ºä¿¡æ¯ç¿»è¯",normalizedTitle:"éè¯¯æç¤ºä¿¡æ¯ç¿»è¯",charIndex:9749}],headersStr:"ç®ä» æå è½½validateå¯¹è±¡ å¤ç§è¯·æ±åæ°çæ ¡éª é©å­æ¹æ³ å¯¹è±¡æ± çåºç¨ æ ¹æ®æ ç­¾æ ¡éªè¿ç¨ éè¯¯æç¤ºä¿¡æ¯ç¿»è¯",content:'# ç®ä»\n\nå¨ginä¸­ä½¿ç¨çæ¯validatoræ¨¡åæ¥å¯¹è¡¨åè¿è¡æ ¡éªçã\n\nvalidatoræ¨¡ågithubå°å\n\n\n# æå è½½validateå¯¹è±¡\n\nä¼æå¨ç¥ï¼å¨apiå±éè¦ä½¿ç¨gin.Contextä¸­çShouldBindJSONæ¹æ³æ¥å¯¹requestä¸­çjsonå­æ®µè¿è¡æ ¡éªï¼ä¾å­å¦ä¸:\n\nfunc login(c *gin.Context) {\n\n\tvar user User\n\tif err := c.ShouldBindJSON(&user); err != nil {\n\n\t\terrs, ok := err.(validator.ValidationErrors)\n\t\tif !ok {\n\t\t\t// éæ ¡éªéè¯¯ï¼å¶ä»éè¯¯ç´æ¥è¿å\n\t\t\tc.JSON(http.StatusOK, gin.H{"msg": err.Error()})\n\t\t\treturn\n\t\t}\n\n\t\tc.JSON(http.StatusOK, gin.H{"msg": errs.Translate(global.Trans)})\n\t\treturn\n\t}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå¨c.ShourdBindJSONä¸­ï¼ä¸ç´å¾ä¸è·³è½¬ï¼è·å°è·¯å¾binding/default_validator.goä¸ï¼å¯ä»¥çå°ä»£ç å¦ä¸ï¼å¯¹è¡¨åçæ ¡éªæ¯è°ç¨v.validate.Struct(obj)æ¥å®æçï¼è¿éçvalidateæ¯validatoråºä¸­Validateå¯¹è±¡ï¼æä»¥å¨ä¹åä½¿ç¨v.lazyinit()æ¥åå»ºè¯¥å¯¹è±¡ã\n\n// validateStruct receives struct type\nfunc (v *defaultValidator) validateStruct(obj any) error {\n\tv.lazyinit()\n\treturn v.validate.Struct(obj)\n}\n\n\n1\n2\n3\n4\n5\n\n\nåçv.lazyinit()æ¹æ³ï¼è¿éä½¿ç¨äºonce.Doæ¹æ³ï¼è¯¥onceæ¯sync.Onecå¯¹è±¡ï¼Doä¸­çæ¹æ³åªä¼æ§è¡ä¸æ¬¡ï¼ä¹å°±æ¯åªä¼åå»ºä¸æ¬¡Validateå¯¹è±¡ï¼ä¿æè¯¥å¯¹è±¡çåä¾ã\n\ntype defaultValidator struct {\n\tonce     sync.Once\n\tvalidate *validator.Validate\n}\n\nfunc (v *defaultValidator) lazyinit() {\n\tv.once.Do(func() {\n\t\tv.validate = validator.New()\n\t\tv.validate.SetTagName("binding")\n\t})\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\né£ä¹æè¿ä¹ä¸ç§åºæ¯ï¼å¦æææ³è¦å¯¹validatorä¸­çvalidateå¯¹è±¡è¿è¡éç½®ï¼è¯¥æä¹åå¢ï¼å ä¸ºä¸é¢é½æ¯å¨ä½¿ç¨æ¶æå è½½æå è½½çï¼æä»¬éè¦æåæ¿å°validateå¯¹è±¡å¹¶è¿è¡éç½®ï¼è¯¥å¦ä½å¤çï¼\n\nå¨ä»£ç binding/default_validator.goä¸­ï¼æä¾äºEngineæ¹æ³ï¼æä»¬å¯ä»¥ä½¿ç¨è¯¥æ¹æ³ç»ä½¿ç¨è¿è°ç¨æåå è½½validateå¯¹è±¡ï¼å¹¶è¿åè¯¥å¯¹è±¡ï¼å°±å¯ä»¥è¿è¡éç½®äºã\n\nfunc (v *defaultValidator) Engine() any {\n\tv.lazyinit()\n\treturn v.validate\n}\n\n\n1\n2\n3\n4\n\n\nç»è®ºï¼\n\n * ç»æä½ä¸­çå¯¹è±¡å¯ä»¥ä½¿ç¨æå è½½çæ¹å¼ï¼å¨ä½¿ç¨çæ¶ååè¿è¡åå»ºã\n\n * å¯ä»¥ä½¿ç¨once.Doçæ¹æ³åå»ºå¯¹è±¡ä¿æåä¾ã\n\n * å¯ä»¥æä¾æ¹æ³æåå è½½å¯¹è±¡ï¼ç¶åè¿ååºæ¥è¿è¡ä½¿ç¨éç½®\n\n\n# å¤ç§è¯·æ±åæ°çæ ¡éª\n\næä»¬ä½¿ç¨c.ShouldBindJSON(&user)å¯ä»¥å¯¹jsonæ ¼å¼çè¯·æ±åæ°è¿è¡æ ¡éªï¼ä¹å¯ä»¥ä½¿ç¨c.ShouldBindXMLå¯¹xmlæ ¼å¼çè¯·æ±åæ°è¿è¡æ ¡éªã\n\nå¨ä»£ç binding/binding.goä¸­å¯ä»¥çå°å®ä¹äºå¤ç§å¯¹requestè¿è¡æ ¡éªçå¨å±å¯¹è±¡ã\n\nvar (\n\tJSON          = jsonBinding{}\n\tXML           = xmlBinding{}\n\tForm          = formBinding{}\n\tQuery         = queryBinding{}\n\tFormPost      = formPostBinding{}\n\tFormMultipart = formMultipartBinding{}\n\tProtoBuf      = protobufBinding{}\n\tMsgPack       = msgpackBinding{}\n\tYAML          = yamlBinding{}\n\tUri           = uriBinding{}\n\tHeader        = headerBinding{}\n\tTOML          = tomlBinding{}\n)\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¿å¥c.ShouldBindJSONæ¹æ³ï¼å¯ä»¥çå°è°ç¨äºc.ShouldBindWithæ¹æ³å¹¶å°è¡¨åå¯¹è±¡åå¨å±çJSONå¯¹è±¡ä¼ å¥å¶ä¸­ã\n\n// ShouldBindJSON is a shortcut for c.ShouldBindWith(obj, binding.JSON).\nfunc (c *Context) ShouldBindJSON(obj any) error {\n\treturn c.ShouldBindWith(obj, binding.JSON)\n}\n\n\n1\n2\n3\n4\n\n\nå¨c.ShouldBindWithä¸­ï¼æ¯ç´æ¥ä½¿ç¨ä¸é¢çJSONå¨å±å¯¹è±¡çbindæ¹æ³ï¼å°requetsåè¡¨åå¯¹è±¡ä¼ å¥å¶ä¸­ã\n\n// ShouldBindWith binds the passed struct pointer using the specified binding engine.\n// See the binding package.\nfunc (c *Context) ShouldBindWith(obj any, b binding.Binding) error {\n\treturn b.Bind(c.Request, obj)\n}\n\n\n1\n2\n3\n4\n5\n\n\nåçb.Bindæ¹æ³ï¼ä½ ä¼åç°ï¼å®åçäºææ¯ï¼æ ¡éªè¯·æ±åæ°æ¯å¦ä¸ºjsonæ ¼å¼ï¼ç¶ååè°ç¨validateæ¹æ³ï¼è¯¥æ¹æ³å°±æ¯å»åå»ºgo-palygroundæ¨¡åä¸­Validateå¯¹è±¡ï¼ç¶åè°ç¨å¶structæ¹æ³è¿è¡åæ°éªè¯ã\n\nfunc (jsonBinding) Bind(req *http.Request, obj any) error {\n\tif req == nil || req.Body == nil {\n\t\treturn errors.New("invalid request")\n\t}\n\treturn decodeJSON(req.Body, obj)\n}\n\nfunc decodeJSON(r io.Reader, obj any) error {\n\tdecoder := json.NewDecoder(r)\n\tif EnableDecoderUseNumber {\n\t\tdecoder.UseNumber()\n\t}\n\tif EnableDecoderDisallowUnknownFields {\n\t\tdecoder.DisallowUnknownFields()\n\t}\n\tif err := decoder.Decode(obj); err != nil {\n\t\treturn err\n\t}\n\treturn validate(obj)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nä½ åççShouldBindXMLæ¹æ³ï¼å°±ä¼åç°æ¯åä¸é¢ä¸æ ·çè¿ç¨ï¼è°ç¨çæ¯å¨å±å¯¹è±¡XMLä¸­çbindæ¹æ³ï¼ç¶ååæ ¡éªè¯·æ±åæ°æ¯å¦ä¸ºxmlæ ¼å¼ï¼æç»è°ç¨validateæ¹æ³ã\n\næ»ç»ï¼\n\nå¨binding/binding.goä¸­çå¨å±å¯¹è±¡é½å®ç°äºä¸ä¸ªbindæ¹æ³ï¼è¯¥æ¹æ³æ¯å¯¹è¯·æ±åæ°çæ ¼å¼è¿è¡æ£éªï¼ç¶åæç»ä¼è°ç¨validateæ¹æ³ï¼å»åå»ºgo-palygroundæ¨¡åä¸­Validateå¯¹è±¡ï¼åè°ç¨å¶structå¯¹è±¡è¿è¡è¯·æ±åæ°çåå®¹æ ¡éªã\n\nåå»ºå¤ä¸ªShouldBindXXXï¼å¨ä¸åçæ¹æ³ä¸­ä½¿ç¨ä¸åçå¨å±å¯¹è±¡ï¼è¿äºå¯¹è±¡é½æä¸ä¸ªç¸åçæ¹æ³bindï¼ç¶ååç»ä¸è°ç¨bindæ¹æ³è¿è¡æ ¡éªã\n\n\n# é©å­æ¹æ³\n\nvalidatoråºä¸­Validateç»æä½æä¾äºä¸ç³»åçé©å­æ¹æ³ï¼å¨æ ¡éªä¸­çè¿ç¨ä¸­ï¼æä¾ç»ä½¿ç¨èæ¥ä¿®æ¹å¶ä¸­çé¨ååå®¹ã\n\næä»¬çä¸ä¸validator_instance.goæä»¶ä¸­Validateç»æä½ï¼è¯¥ç»æä½ä¸­åå«äºhasTagNameFuncåtagNameFuncä¸¤ä¸ªåéï¼tagNameFuncä»£è¡¨çé©å­æ¹æ³ï¼ä½¿ç¨èå¯ä»¥èªå®æ¹æ³æ¥èµå¼ç»å®ï¼hasTagNameFuncæ¯boolç±»åä»£è¡¨æ¯å¦éç½®äºé©å­æ¹æ³.\n\ntype Validate struct {\n\ttagName          string\n\tpool             *sync.Pool\n\thasCustomFuncs   bool\n\thasTagNameFunc   bool\n\ttagNameFunc      TagNameFunc\n\tstructLevelFuncs map[reflect.Type]StructLevelFuncCtx\n\tcustomFuncs      map[reflect.Type]CustomTypeFunc\n\taliases          map[string]string\n\tvalidations      map[string]internalValidationFuncWrapper\n\ttransTagFunc     map[ut.Translator]map[string]TranslationFunc // map[<locale>]map[<tag>]TranslationFunc\n\ttagCache         *tagCache\n\tstructCache      *structCache\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nä½¿ç¨èå¯ä»¥è°ç¨RegisterTagNameFuncæ¹æ³æ¥æ³¨åèªå·±åçæ¹æ³\n\nfunc (v *Validate) RegisterTagNameFunc(fn TagNameFunc) {\n\tv.tagNameFunc = fn\n\tv.hasTagNameFunc = true\n}\n\n\n1\n2\n3\n4\n\n\nå¨ä»£ç cache.goä¸­extractStructCacheæ¹æ³ä¸­æä¸é¢ä¸æ®µä»£ç ï¼éè¿è°ç¨hasTagNameFuncæ¹æ³æ¥å¤æ­æ¯å¦è®¾ç½®äºé©å­æ¹æ³ï¼å¦æè®¾ç½®äºï¼åè°ç¨tagNameFuncæ¥æ§è¡ä½¿ç¨èèªå®çæ¹æ³ã\n\n\t\tif v.hasTagNameFunc {\n\t\t\tname := v.tagNameFunc(fld)\n\t\t\tif len(name) > 0 {\n\t\t\t\tcustomName = name\n\t\t\t}\n\t\t}\n\n\n1\n2\n3\n4\n5\n6\n\n\næ»ç»ï¼\n\n * å¯ä»¥æä¾é©å­æ¹æ³æ´é²ç»ä½¿ç¨èåä¸å°æ§è¡è¿ç¨ä¸­æ¥ã\n\n\n# å¯¹è±¡æ± çåºç¨\n\nçæä»¶validator_instance.goä¸­çStructæ¹æ³ï¼è¿ä¸ªæ¹æ³å°±æ¯è¡¨åçæ ¡éªçå¥å£æ¹æ³ï¼å¯ä»¥çå°å®åè°ç¨äºStructCtxæ¹æ³ã\n\nfunc (v *Validate) Struct(s interface{}) error {\n\treturn v.StructCtx(context.Background(), s)\n}\n\n\n1\n2\n3\n\n\nåæ¥ççStructCtxæ¹æ³ï¼å¶ä¸­poolæ¯*sync.Poolç±»åï¼è°ç¨Getæ¹æ³è·åvalidateå¯¹è±¡ï¼ç¶ååè°ç¨å¶validateStructæ¹æ³ï¼å¶ä¸­ä¼è¿è¡è¯·æ±åæ°çæ ¡éªï¼ç¶åå¦ææ ¡éªæè¯¯ï¼ä¼å°éè¯¯ä¿¡æ¯ä¿å­å¨errsä¸­ãvaludateä½¿ç¨å®æåï¼åputåpoolä¸­ã\n\nå ä¸ºæ¯ä¸æ¬¡æ ¡éªé½éè¦åå»ºvalidateå¯¹è±¡ï¼æä»¥è¿éä½¿ç¨äºsync.Poolå¯ä»¥å¤ç¨ä¸´æ¶å¯¹è±¡ï¼åå°åå­çåéï¼éä½GCååã\n\nfunc (v *Validate) StructCtx(ctx context.Context, s interface{}) (err error) {\n\n\tval := reflect.ValueOf(s)\n\ttop := val\n\n\tif val.Kind() == reflect.Ptr && !val.IsNil() {\n\t\tval = val.Elem()\n\t}\n\n\tif val.Kind() != reflect.Struct || val.Type() == timeType {\n\t\treturn &InvalidValidationError{Type: reflect.TypeOf(s)}\n\t}\n\n\t// good to validate\n\tvd := v.pool.Get().(*validate)\n\tvd.top = top\n\tvd.isPartial = false\n\t// vd.hasExcludes = false // only need to reset in StructPartial and StructExcept\n\n\tvd.validateStruct(ctx, top, val, val.Type(), vd.ns[0:0], vd.actualNs[0:0], nil)\n\n\tif len(vd.errs) > 0 {\n\t\terr = vd.errs\n\t\tvd.errs = nil\n\t}\n\n\tv.pool.Put(vd)\n\n\treturn\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\næ»ç»ï¼\n\n * å½éè¦é¢ç¹åå»ºç¸åå¯¹è±¡ï¼å¹¶ä¸è¯¥å¯¹è±¡æ¯æ ç¶ææ¶ï¼å¯ä»¥ä½¿ç¨sync.Poolæ¥æé«å¤ç¨ä¸´æ¶å¯¹è±¡ï¼åå°åå­çåéï¼éä½GCååã\n\n\n# æ ¹æ®æ ç­¾æ ¡éªè¿ç¨\n\nå¨æå è½½åå»ºvalidatorçValidateå¯¹è±¡æ¶ï¼æ¯è°ç¨validator_instance.goä¸­Newæ¹æ³æ¥åå»ºè¯¥å¯¹è±¡ï¼å¨è¯¥æ¹æ³ä¸­åå§åæææ ç­¾åæ ç­¾å¯¹åºçæ ¡éªæ¹æ³å¹¶ä¿å­å¨Validateå¯¹è±¡ä¸­çvalidationsåéä¸­\n\nfor k, val := range bakedInValidators {\n\tswitch k {\n\t// these require that even if the value is nil that the validation should run, omitempty still overrides this behaviour\n\tcase requiredIfTag, requiredUnlessTag, requiredWithTag, requiredWithAllTag, requiredWithoutTag, requiredWithoutAllTag,\n\t\texcludedWithTag, excludedWithAllTag, excludedWithoutTag, excludedWithoutAllTag:\n\t\t_ = v.registerValidation(k, wrapFunc(val), true, true)\n\tdefault:\n\t\t// no need to error check here, baked in will always be valid\n\t\t_ = v.registerValidation(k, wrapFunc(val), true, false)\n\t}\n}\n\n\nfunc (v *Validate) registerValidation(tag string, fn FuncCtx, bakedIn bool, nilCheckable bool) error {\n\tif len(tag) == 0 {\n\t\treturn errors.New("function Key cannot be empty")\n\t}\n\n\tif fn == nil {\n\t\treturn errors.New("function cannot be empty")\n\t}\n\n\t_, ok := restrictedTags[tag]\n\tif !bakedIn && (ok || strings.ContainsAny(tag, restrictedTagChars)) {\n\t\tpanic(fmt.Sprintf(restrictedTagErr, tag))\n\t}\n\tv.validations[tag] = internalValidationFuncWrapper{fn: fn, runValidatinOnNil: nilCheckable}\n\treturn nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\næä»¬å¯ä»¥å¨baked_in.goæä»¶ä¸­çå°æå®ä¹ä»¥æ ç­¾ä¸ºkeyï¼æ ¡éªæ¹æ³ä¸ºvalueçmapå¯¹è±¡ã\n\nbakedInValidators = map[string]Func{\n\t\t"required":                      hasValue,\n\t\t"required_if":                   requiredIf,\n\t\t"required_unless":               requiredUnless,\n\t\t"required_with":                 requiredWith,\n\t\t"required_with_all":             requiredWithAll,\n\t\t"required_without":              requiredWithout,\n\t\t"required_without_all":          requiredWithoutAll,\n......\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨ä»£ç cache.goä¸­extractStructCacheæ¹æ³ä¸­ï¼ä¼éåè¯·æ±åæ°çæ¯ä¸ä¸ªå­æ®µï¼ç¶åæ ¹æ®è¯¥å­æ®µçtagåå»ºå¯¹åºçctagå¯¹è±¡ï¼ååå»ºè¯¥å­æ®µçcFieldå¯¹è±¡ï¼å¹¶å°ctagä¼ å¥ã\n\n\t\tif len(tag) > 0 {\n\t\t\tctag, _ = v.parseFieldTagsRecursive(tag, fld.Name, "", false)\n\t\t} else {\n\t\t\t// even if field doesn\'t have validations need cTag for traversing to potential inner/nested\n\t\t\t// elements of the field.\n\t\t\tctag = new(cTag)\n\t\t}\n\n\t\tcs.fields = append(cs.fields, &cField{\n\t\t\tidx:        i,\n\t\t\tname:       fld.Name,\n\t\t\taltName:    customName,\n\t\t\tcTags:      ctag,\n\t\t\tnamesEqual: fld.Name == customName,\n\t\t})\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå¨ä¸é¢çv.parseFieldTagsRecursiveæ¹æ³ä¸­ä¼å°ä»ä¹åç¼å­çvalidatetionséåä¸­æ¾å°è¯¥ctagçæ ¡éªæ¹æ³ï¼ç¶åèµå¼ctag.fnæ¹æ³ã\n\nif wrapper, ok := v.validations[current.tag]; ok {\n\tcurrent.fn = wrapper.fn\n\tcurrent.runValidationWhenNil = wrapper.runValidatinOnNil\n} else {\n\tpanic(strings.TrimSpace(fmt.Sprintf(undefinedValidation, current.tag, fieldName)))\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨æä»¶validator.goä¸­traverseFieldæ¹æ³æ ¡éªå­æ®µä¸­ä¼è°ç¨ä¸é¢ä¼ éçfnæ¹æ³ï¼è¿åå¼ä¸ºfalseæ¶ï¼ä¼åå»ºfieldErrorå¯¹è±¡ä¿å­å¨validateçerrsä¸­\n\nif !ct.fn(ctx, v) {\n\n\tv.str1 = string(append(ns, cf.altName...))\n\n\tif v.v.hasTagNameFunc {\n\t\tv.str2 = string(append(structNs, cf.name...))\n\t} else {\n\t\tv.str2 = v.str1\n\t}\n\n\tv.errs = append(v.errs,\n\t\t&fieldError{\n\t\t\tv:              v.v,\n\t\t\ttag:            ct.aliasTag,\n\t\t\tactualTag:      ct.tag,\n\t\t\tns:             v.str1,\n\t\t\tstructNs:       v.str2,\n\t\t\tfieldLen:       uint8(len(cf.altName)),\n\t\t\tstructfieldLen: uint8(len(cf.name)),\n\t\t\tvalue:          current.Interface(),\n\t\t\tparam:          ct.param,\n\t\t\tkind:           kind,\n\t\t\ttyp:            typ,\n\t\t},\n)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\næç»å°è¿ä¸ªerrorå¨validator_instance.goä¸­çStructCtxæ¹æ³ä¸­è¿ååºå»ã\n\nvd.validateStruct(ctx, top, val, val.Type(), vd.ns[0:0], vd.actualNs[0:0], nil)\n\nif len(vd.errs) > 0 {\n\terr = vd.errs\n\tvd.errs = nil\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nç»è®ºï¼\n\n * errorå¹¶ä¸æ¯è°ç¨validateStructè¿ååºæ¥çï¼èæ¯éè¿å¨ç»æä½ä¸­åå»ºäºä¸ä¸ªerrorï¼å¨è¿ç¨ä¸­å¦æåçäºéè¯¯åå°è¯¥éè¯¯ä¿¡æ¯ä¿å­å¨ç»æä½çerroråéä¸­ï¼ä¹æ¯ä¸ç§errorçè¿åæ¹å¼ã\n\n * ååå§åææçæ ¡éªæ¹æ³ï¼ç¶ååæ ¹æ®æ¯ä¸ªå­æ®µéæ©æ ¡éªæ¹æ³è¿è¡æ§è¡ãé»è¾éå¸¸æ¸æ°ã\n\n\n# éè¯¯æç¤ºä¿¡æ¯ç¿»è¯\n\nä»ä¸é¢çè¿ç¨å¯ä»¥åç°ï¼ä»è½å¤åç°åªä¸ªå­æ®µååªä¸ªtagä¸­åçäºéè¯¯ï¼å¦ä¸æç¤ºï¼\n\n{\'msg\': "Key: \'User.password\' Error:Field validation for \'password\' failed on the \'required\' tag"}\n\n\n1\n\n\nä½æ¯æä»¬éè¦çæ¶åäººæ§åçéè¯¯æç¤ºã\n\nå¨ä»£ç translations/zh/zh.goçRegisterDefaultTranslationsæ¹æ³ä¸­å¯ä»¥çå°å®ä¹äºæ¯ä¸ªtagåå¯¹åºä¸­ææç¤ºä¿¡æ¯ãè¿äºä¿¡æ¯ä¼æ³¨åå°validatorçValidate.transTagFuncåéä¸­ã\n\nfunc RegisterDefaultTranslations(v *validator.Validate, trans ut.Translator) (err error) {\n\n\ttranslations := []struct {\n\t\ttag             string\n\t\ttranslation     string\n\t\toverride        bool\n\t\tcustomRegisFunc validator.RegisterTranslationsFunc\n\t\tcustomTransFunc validator.TranslationFunc\n\t}{\n\t\t{\n\t\t\ttag:         "required",\n\t\t\ttranslation: "{0}ä¸ºå¿å¡«å­æ®µ",\n\t\t\toverride:    false,\n\t\t},\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næ¯ä¸ªå­æ®µçéè¯¯å¯¹è±¡é½æTranslateæ¹æ³ï¼å½è°ç¨æ¹æ³æ¶ï¼ä¼éåå½åææéè¯¯çå­æ®µï¼ç¶ååæ¾å°æ¯ä¸ªTagå¯¹åºçæç¤ºä¿¡æ¯è¾åºã\n\nfunc (ve ValidationErrors) Translate(ut ut.Translator) ValidationErrorsTranslations {\n\n\ttrans := make(ValidationErrorsTranslations)\n\n\tvar fe *fieldError\n\n\tfor i := 0; i < len(ve); i++ {\n\t\tfe = ve[i].(*fieldError)\n\n\t\t// // in case an Anonymous struct was used, ensure that the key\n\t\t// // would be \'Username\' instead of ".Username"\n\t\t// if len(fe.ns) > 0 && fe.ns[:1] == "." {\n\t\t// \ttrans[fe.ns[1:]] = fe.Translate(ut)\n\t\t// \tcontinue\n\t\t// }\n\n\t\ttrans[fe.ns] = fe.Translate(ut)\n\t}\n\n\treturn trans\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿ä¸ªæ¯æ¯ä¸ä¸ªå­æ®µéè¿tagè·åæç¤ºä¿¡æ¯ã\n\nfunc (fe *fieldError) Translate(ut ut.Translator) string {\n\n\tm, ok := fe.v.transTagFunc[ut]\n\tif !ok {\n\t\treturn fe.Error()\n\t}\n\n\tfn, ok := m[fe.tag]\n\tif !ok {\n\t\treturn fe.Error()\n\t}\n\n\treturn fn(ut, fe)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n',normalizedContent:'# ç®ä»\n\nå¨ginä¸­ä½¿ç¨çæ¯validatoræ¨¡åæ¥å¯¹è¡¨åè¿è¡æ ¡éªçã\n\nvalidatoræ¨¡ågithubå°å\n\n\n# æå è½½validateå¯¹è±¡\n\nä¼æå¨ç¥ï¼å¨apiå±éè¦ä½¿ç¨gin.contextä¸­çshouldbindjsonæ¹æ³æ¥å¯¹requestä¸­çjsonå­æ®µè¿è¡æ ¡éªï¼ä¾å­å¦ä¸:\n\nfunc login(c *gin.context) {\n\n\tvar user user\n\tif err := c.shouldbindjson(&user); err != nil {\n\n\t\terrs, ok := err.(validator.validationerrors)\n\t\tif !ok {\n\t\t\t// éæ ¡éªéè¯¯ï¼å¶ä»éè¯¯ç´æ¥è¿å\n\t\t\tc.json(http.statusok, gin.h{"msg": err.error()})\n\t\t\treturn\n\t\t}\n\n\t\tc.json(http.statusok, gin.h{"msg": errs.translate(global.trans)})\n\t\treturn\n\t}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå¨c.shourdbindjsonä¸­ï¼ä¸ç´å¾ä¸è·³è½¬ï¼è·å°è·¯å¾binding/default_validator.goä¸ï¼å¯ä»¥çå°ä»£ç å¦ä¸ï¼å¯¹è¡¨åçæ ¡éªæ¯è°ç¨v.validate.struct(obj)æ¥å®æçï¼è¿éçvalidateæ¯validatoråºä¸­validateå¯¹è±¡ï¼æä»¥å¨ä¹åä½¿ç¨v.lazyinit()æ¥åå»ºè¯¥å¯¹è±¡ã\n\n// validatestruct receives struct type\nfunc (v *defaultvalidator) validatestruct(obj any) error {\n\tv.lazyinit()\n\treturn v.validate.struct(obj)\n}\n\n\n1\n2\n3\n4\n5\n\n\nåçv.lazyinit()æ¹æ³ï¼è¿éä½¿ç¨äºonce.doæ¹æ³ï¼è¯¥onceæ¯sync.onecå¯¹è±¡ï¼doä¸­çæ¹æ³åªä¼æ§è¡ä¸æ¬¡ï¼ä¹å°±æ¯åªä¼åå»ºä¸æ¬¡validateå¯¹è±¡ï¼ä¿æè¯¥å¯¹è±¡çåä¾ã\n\ntype defaultvalidator struct {\n\tonce     sync.once\n\tvalidate *validator.validate\n}\n\nfunc (v *defaultvalidator) lazyinit() {\n\tv.once.do(func() {\n\t\tv.validate = validator.new()\n\t\tv.validate.settagname("binding")\n\t})\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\né£ä¹æè¿ä¹ä¸ç§åºæ¯ï¼å¦æææ³è¦å¯¹validatorä¸­çvalidateå¯¹è±¡è¿è¡éç½®ï¼è¯¥æä¹åå¢ï¼å ä¸ºä¸é¢é½æ¯å¨ä½¿ç¨æ¶æå è½½æå è½½çï¼æä»¬éè¦æåæ¿å°validateå¯¹è±¡å¹¶è¿è¡éç½®ï¼è¯¥å¦ä½å¤çï¼\n\nå¨ä»£ç binding/default_validator.goä¸­ï¼æä¾äºengineæ¹æ³ï¼æä»¬å¯ä»¥ä½¿ç¨è¯¥æ¹æ³ç»ä½¿ç¨è¿è°ç¨æåå è½½validateå¯¹è±¡ï¼å¹¶è¿åè¯¥å¯¹è±¡ï¼å°±å¯ä»¥è¿è¡éç½®äºã\n\nfunc (v *defaultvalidator) engine() any {\n\tv.lazyinit()\n\treturn v.validate\n}\n\n\n1\n2\n3\n4\n\n\nç»è®ºï¼\n\n * ç»æä½ä¸­çå¯¹è±¡å¯ä»¥ä½¿ç¨æå è½½çæ¹å¼ï¼å¨ä½¿ç¨çæ¶ååè¿è¡åå»ºã\n\n * å¯ä»¥ä½¿ç¨once.doçæ¹æ³åå»ºå¯¹è±¡ä¿æåä¾ã\n\n * å¯ä»¥æä¾æ¹æ³æåå è½½å¯¹è±¡ï¼ç¶åè¿ååºæ¥è¿è¡ä½¿ç¨éç½®\n\n\n# å¤ç§è¯·æ±åæ°çæ ¡éª\n\næä»¬ä½¿ç¨c.shouldbindjson(&user)å¯ä»¥å¯¹jsonæ ¼å¼çè¯·æ±åæ°è¿è¡æ ¡éªï¼ä¹å¯ä»¥ä½¿ç¨c.shouldbindxmlå¯¹xmlæ ¼å¼çè¯·æ±åæ°è¿è¡æ ¡éªã\n\nå¨ä»£ç binding/binding.goä¸­å¯ä»¥çå°å®ä¹äºå¤ç§å¯¹requestè¿è¡æ ¡éªçå¨å±å¯¹è±¡ã\n\nvar (\n\tjson          = jsonbinding{}\n\txml           = xmlbinding{}\n\tform          = formbinding{}\n\tquery         = querybinding{}\n\tformpost      = formpostbinding{}\n\tformmultipart = formmultipartbinding{}\n\tprotobuf      = protobufbinding{}\n\tmsgpack       = msgpackbinding{}\n\tyaml          = yamlbinding{}\n\turi           = uribinding{}\n\theader        = headerbinding{}\n\ttoml          = tomlbinding{}\n)\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¿å¥c.shouldbindjsonæ¹æ³ï¼å¯ä»¥çå°è°ç¨äºc.shouldbindwithæ¹æ³å¹¶å°è¡¨åå¯¹è±¡åå¨å±çjsonå¯¹è±¡ä¼ å¥å¶ä¸­ã\n\n// shouldbindjson is a shortcut for c.shouldbindwith(obj, binding.json).\nfunc (c *context) shouldbindjson(obj any) error {\n\treturn c.shouldbindwith(obj, binding.json)\n}\n\n\n1\n2\n3\n4\n\n\nå¨c.shouldbindwithä¸­ï¼æ¯ç´æ¥ä½¿ç¨ä¸é¢çjsonå¨å±å¯¹è±¡çbindæ¹æ³ï¼å°requetsåè¡¨åå¯¹è±¡ä¼ å¥å¶ä¸­ã\n\n// shouldbindwith binds the passed struct pointer using the specified binding engine.\n// see the binding package.\nfunc (c *context) shouldbindwith(obj any, b binding.binding) error {\n\treturn b.bind(c.request, obj)\n}\n\n\n1\n2\n3\n4\n5\n\n\nåçb.bindæ¹æ³ï¼ä½ ä¼åç°ï¼å®åçäºææ¯ï¼æ ¡éªè¯·æ±åæ°æ¯å¦ä¸ºjsonæ ¼å¼ï¼ç¶ååè°ç¨validateæ¹æ³ï¼è¯¥æ¹æ³å°±æ¯å»åå»ºgo-palygroundæ¨¡åä¸­validateå¯¹è±¡ï¼ç¶åè°ç¨å¶structæ¹æ³è¿è¡åæ°éªè¯ã\n\nfunc (jsonbinding) bind(req *http.request, obj any) error {\n\tif req == nil || req.body == nil {\n\t\treturn errors.new("invalid request")\n\t}\n\treturn decodejson(req.body, obj)\n}\n\nfunc decodejson(r io.reader, obj any) error {\n\tdecoder := json.newdecoder(r)\n\tif enabledecoderusenumber {\n\t\tdecoder.usenumber()\n\t}\n\tif enabledecoderdisallowunknownfields {\n\t\tdecoder.disallowunknownfields()\n\t}\n\tif err := decoder.decode(obj); err != nil {\n\t\treturn err\n\t}\n\treturn validate(obj)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nä½ åççshouldbindxmlæ¹æ³ï¼å°±ä¼åç°æ¯åä¸é¢ä¸æ ·çè¿ç¨ï¼è°ç¨çæ¯å¨å±å¯¹è±¡xmlä¸­çbindæ¹æ³ï¼ç¶ååæ ¡éªè¯·æ±åæ°æ¯å¦ä¸ºxmlæ ¼å¼ï¼æç»è°ç¨validateæ¹æ³ã\n\næ»ç»ï¼\n\nå¨binding/binding.goä¸­çå¨å±å¯¹è±¡é½å®ç°äºä¸ä¸ªbindæ¹æ³ï¼è¯¥æ¹æ³æ¯å¯¹è¯·æ±åæ°çæ ¼å¼è¿è¡æ£éªï¼ç¶åæç»ä¼è°ç¨validateæ¹æ³ï¼å»åå»ºgo-palygroundæ¨¡åä¸­validateå¯¹è±¡ï¼åè°ç¨å¶structå¯¹è±¡è¿è¡è¯·æ±åæ°çåå®¹æ ¡éªã\n\nåå»ºå¤ä¸ªshouldbindxxxï¼å¨ä¸åçæ¹æ³ä¸­ä½¿ç¨ä¸åçå¨å±å¯¹è±¡ï¼è¿äºå¯¹è±¡é½æä¸ä¸ªç¸åçæ¹æ³bindï¼ç¶ååç»ä¸è°ç¨bindæ¹æ³è¿è¡æ ¡éªã\n\n\n# é©å­æ¹æ³\n\nvalidatoråºä¸­validateç»æä½æä¾äºä¸ç³»åçé©å­æ¹æ³ï¼å¨æ ¡éªä¸­çè¿ç¨ä¸­ï¼æä¾ç»ä½¿ç¨èæ¥ä¿®æ¹å¶ä¸­çé¨ååå®¹ã\n\næä»¬çä¸ä¸validator_instance.goæä»¶ä¸­validateç»æä½ï¼è¯¥ç»æä½ä¸­åå«äºhastagnamefuncåtagnamefuncä¸¤ä¸ªåéï¼tagnamefuncä»£è¡¨çé©å­æ¹æ³ï¼ä½¿ç¨èå¯ä»¥èªå®æ¹æ³æ¥èµå¼ç»å®ï¼hastagnamefuncæ¯boolç±»åä»£è¡¨æ¯å¦éç½®äºé©å­æ¹æ³.\n\ntype validate struct {\n\ttagname          string\n\tpool             *sync.pool\n\thascustomfuncs   bool\n\thastagnamefunc   bool\n\ttagnamefunc      tagnamefunc\n\tstructlevelfuncs map[reflect.type]structlevelfuncctx\n\tcustomfuncs      map[reflect.type]customtypefunc\n\taliases          map[string]string\n\tvalidations      map[string]internalvalidationfuncwrapper\n\ttranstagfunc     map[ut.translator]map[string]translationfunc // map[<locale>]map[<tag>]translationfunc\n\ttagcache         *tagcache\n\tstructcache      *structcache\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nä½¿ç¨èå¯ä»¥è°ç¨registertagnamefuncæ¹æ³æ¥æ³¨åèªå·±åçæ¹æ³\n\nfunc (v *validate) registertagnamefunc(fn tagnamefunc) {\n\tv.tagnamefunc = fn\n\tv.hastagnamefunc = true\n}\n\n\n1\n2\n3\n4\n\n\nå¨ä»£ç cache.goä¸­extractstructcacheæ¹æ³ä¸­æä¸é¢ä¸æ®µä»£ç ï¼éè¿è°ç¨hastagnamefuncæ¹æ³æ¥å¤æ­æ¯å¦è®¾ç½®äºé©å­æ¹æ³ï¼å¦æè®¾ç½®äºï¼åè°ç¨tagnamefuncæ¥æ§è¡ä½¿ç¨èèªå®çæ¹æ³ã\n\n\t\tif v.hastagnamefunc {\n\t\t\tname := v.tagnamefunc(fld)\n\t\t\tif len(name) > 0 {\n\t\t\t\tcustomname = name\n\t\t\t}\n\t\t}\n\n\n1\n2\n3\n4\n5\n6\n\n\næ»ç»ï¼\n\n * å¯ä»¥æä¾é©å­æ¹æ³æ´é²ç»ä½¿ç¨èåä¸å°æ§è¡è¿ç¨ä¸­æ¥ã\n\n\n# å¯¹è±¡æ± çåºç¨\n\nçæä»¶validator_instance.goä¸­çstructæ¹æ³ï¼è¿ä¸ªæ¹æ³å°±æ¯è¡¨åçæ ¡éªçå¥å£æ¹æ³ï¼å¯ä»¥çå°å®åè°ç¨äºstructctxæ¹æ³ã\n\nfunc (v *validate) struct(s interface{}) error {\n\treturn v.structctx(context.background(), s)\n}\n\n\n1\n2\n3\n\n\nåæ¥ççstructctxæ¹æ³ï¼å¶ä¸­poolæ¯*sync.poolç±»åï¼è°ç¨getæ¹æ³è·åvalidateå¯¹è±¡ï¼ç¶ååè°ç¨å¶validatestructæ¹æ³ï¼å¶ä¸­ä¼è¿è¡è¯·æ±åæ°çæ ¡éªï¼ç¶åå¦ææ ¡éªæè¯¯ï¼ä¼å°éè¯¯ä¿¡æ¯ä¿å­å¨errsä¸­ãvaludateä½¿ç¨å®æåï¼åputåpoolä¸­ã\n\nå ä¸ºæ¯ä¸æ¬¡æ ¡éªé½éè¦åå»ºvalidateå¯¹è±¡ï¼æä»¥è¿éä½¿ç¨äºsync.poolå¯ä»¥å¤ç¨ä¸´æ¶å¯¹è±¡ï¼åå°åå­çåéï¼éä½gcååã\n\nfunc (v *validate) structctx(ctx context.context, s interface{}) (err error) {\n\n\tval := reflect.valueof(s)\n\ttop := val\n\n\tif val.kind() == reflect.ptr && !val.isnil() {\n\t\tval = val.elem()\n\t}\n\n\tif val.kind() != reflect.struct || val.type() == timetype {\n\t\treturn &invalidvalidationerror{type: reflect.typeof(s)}\n\t}\n\n\t// good to validate\n\tvd := v.pool.get().(*validate)\n\tvd.top = top\n\tvd.ispartial = false\n\t// vd.hasexcludes = false // only need to reset in structpartial and structexcept\n\n\tvd.validatestruct(ctx, top, val, val.type(), vd.ns[0:0], vd.actualns[0:0], nil)\n\n\tif len(vd.errs) > 0 {\n\t\terr = vd.errs\n\t\tvd.errs = nil\n\t}\n\n\tv.pool.put(vd)\n\n\treturn\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\næ»ç»ï¼\n\n * å½éè¦é¢ç¹åå»ºç¸åå¯¹è±¡ï¼å¹¶ä¸è¯¥å¯¹è±¡æ¯æ ç¶ææ¶ï¼å¯ä»¥ä½¿ç¨sync.poolæ¥æé«å¤ç¨ä¸´æ¶å¯¹è±¡ï¼åå°åå­çåéï¼éä½gcååã\n\n\n# æ ¹æ®æ ç­¾æ ¡éªè¿ç¨\n\nå¨æå è½½åå»ºvalidatorçvalidateå¯¹è±¡æ¶ï¼æ¯è°ç¨validator_instance.goä¸­newæ¹æ³æ¥åå»ºè¯¥å¯¹è±¡ï¼å¨è¯¥æ¹æ³ä¸­åå§åæææ ç­¾åæ ç­¾å¯¹åºçæ ¡éªæ¹æ³å¹¶ä¿å­å¨validateå¯¹è±¡ä¸­çvalidationsåéä¸­\n\nfor k, val := range bakedinvalidators {\n\tswitch k {\n\t// these require that even if the value is nil that the validation should run, omitempty still overrides this behaviour\n\tcase requirediftag, requiredunlesstag, requiredwithtag, requiredwithalltag, requiredwithouttag, requiredwithoutalltag,\n\t\texcludedwithtag, excludedwithalltag, excludedwithouttag, excludedwithoutalltag:\n\t\t_ = v.registervalidation(k, wrapfunc(val), true, true)\n\tdefault:\n\t\t// no need to error check here, baked in will always be valid\n\t\t_ = v.registervalidation(k, wrapfunc(val), true, false)\n\t}\n}\n\n\nfunc (v *validate) registervalidation(tag string, fn funcctx, bakedin bool, nilcheckable bool) error {\n\tif len(tag) == 0 {\n\t\treturn errors.new("function key cannot be empty")\n\t}\n\n\tif fn == nil {\n\t\treturn errors.new("function cannot be empty")\n\t}\n\n\t_, ok := restrictedtags[tag]\n\tif !bakedin && (ok || strings.containsany(tag, restrictedtagchars)) {\n\t\tpanic(fmt.sprintf(restrictedtagerr, tag))\n\t}\n\tv.validations[tag] = internalvalidationfuncwrapper{fn: fn, runvalidatinonnil: nilcheckable}\n\treturn nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\næä»¬å¯ä»¥å¨baked_in.goæä»¶ä¸­çå°æå®ä¹ä»¥æ ç­¾ä¸ºkeyï¼æ ¡éªæ¹æ³ä¸ºvalueçmapå¯¹è±¡ã\n\nbakedinvalidators = map[string]func{\n\t\t"required":                      hasvalue,\n\t\t"required_if":                   requiredif,\n\t\t"required_unless":               requiredunless,\n\t\t"required_with":                 requiredwith,\n\t\t"required_with_all":             requiredwithall,\n\t\t"required_without":              requiredwithout,\n\t\t"required_without_all":          requiredwithoutall,\n......\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¨ä»£ç cache.goä¸­extractstructcacheæ¹æ³ä¸­ï¼ä¼éåè¯·æ±åæ°çæ¯ä¸ä¸ªå­æ®µï¼ç¶åæ ¹æ®è¯¥å­æ®µçtagåå»ºå¯¹åºçctagå¯¹è±¡ï¼ååå»ºè¯¥å­æ®µçcfieldå¯¹è±¡ï¼å¹¶å°ctagä¼ å¥ã\n\n\t\tif len(tag) > 0 {\n\t\t\tctag, _ = v.parsefieldtagsrecursive(tag, fld.name, "", false)\n\t\t} else {\n\t\t\t// even if field doesn\'t have validations need ctag for traversing to potential inner/nested\n\t\t\t// elements of the field.\n\t\t\tctag = new(ctag)\n\t\t}\n\n\t\tcs.fields = append(cs.fields, &cfield{\n\t\t\tidx:        i,\n\t\t\tname:       fld.name,\n\t\t\taltname:    customname,\n\t\t\tctags:      ctag,\n\t\t\tnamesequal: fld.name == customname,\n\t\t})\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå¨ä¸é¢çv.parsefieldtagsrecursiveæ¹æ³ä¸­ä¼å°ä»ä¹åç¼å­çvalidatetionséåä¸­æ¾å°è¯¥ctagçæ ¡éªæ¹æ³ï¼ç¶åèµå¼ctag.fnæ¹æ³ã\n\nif wrapper, ok := v.validations[current.tag]; ok {\n\tcurrent.fn = wrapper.fn\n\tcurrent.runvalidationwhennil = wrapper.runvalidatinonnil\n} else {\n\tpanic(strings.trimspace(fmt.sprintf(undefinedvalidation, current.tag, fieldname)))\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨æä»¶validator.goä¸­traversefieldæ¹æ³æ ¡éªå­æ®µä¸­ä¼è°ç¨ä¸é¢ä¼ éçfnæ¹æ³ï¼è¿åå¼ä¸ºfalseæ¶ï¼ä¼åå»ºfielderrorå¯¹è±¡ä¿å­å¨validateçerrsä¸­\n\nif !ct.fn(ctx, v) {\n\n\tv.str1 = string(append(ns, cf.altname...))\n\n\tif v.v.hastagnamefunc {\n\t\tv.str2 = string(append(structns, cf.name...))\n\t} else {\n\t\tv.str2 = v.str1\n\t}\n\n\tv.errs = append(v.errs,\n\t\t&fielderror{\n\t\t\tv:              v.v,\n\t\t\ttag:            ct.aliastag,\n\t\t\tactualtag:      ct.tag,\n\t\t\tns:             v.str1,\n\t\t\tstructns:       v.str2,\n\t\t\tfieldlen:       uint8(len(cf.altname)),\n\t\t\tstructfieldlen: uint8(len(cf.name)),\n\t\t\tvalue:          current.interface(),\n\t\t\tparam:          ct.param,\n\t\t\tkind:           kind,\n\t\t\ttyp:            typ,\n\t\t},\n)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\næç»å°è¿ä¸ªerrorå¨validator_instance.goä¸­çstructctxæ¹æ³ä¸­è¿ååºå»ã\n\nvd.validatestruct(ctx, top, val, val.type(), vd.ns[0:0], vd.actualns[0:0], nil)\n\nif len(vd.errs) > 0 {\n\terr = vd.errs\n\tvd.errs = nil\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nç»è®ºï¼\n\n * errorå¹¶ä¸æ¯è°ç¨validatestructè¿ååºæ¥çï¼èæ¯éè¿å¨ç»æä½ä¸­åå»ºäºä¸ä¸ªerrorï¼å¨è¿ç¨ä¸­å¦æåçäºéè¯¯åå°è¯¥éè¯¯ä¿¡æ¯ä¿å­å¨ç»æä½çerroråéä¸­ï¼ä¹æ¯ä¸ç§errorçè¿åæ¹å¼ã\n\n * ååå§åææçæ ¡éªæ¹æ³ï¼ç¶ååæ ¹æ®æ¯ä¸ªå­æ®µéæ©æ ¡éªæ¹æ³è¿è¡æ§è¡ãé»è¾éå¸¸æ¸æ°ã\n\n\n# éè¯¯æç¤ºä¿¡æ¯ç¿»è¯\n\nä»ä¸é¢çè¿ç¨å¯ä»¥åç°ï¼ä»è½å¤åç°åªä¸ªå­æ®µååªä¸ªtagä¸­åçäºéè¯¯ï¼å¦ä¸æç¤ºï¼\n\n{\'msg\': "key: \'user.password\' error:field validation for \'password\' failed on the \'required\' tag"}\n\n\n1\n\n\nä½æ¯æä»¬éè¦çæ¶åäººæ§åçéè¯¯æç¤ºã\n\nå¨ä»£ç translations/zh/zh.goçregisterdefaulttranslationsæ¹æ³ä¸­å¯ä»¥çå°å®ä¹äºæ¯ä¸ªtagåå¯¹åºä¸­ææç¤ºä¿¡æ¯ãè¿äºä¿¡æ¯ä¼æ³¨åå°validatorçvalidate.transtagfuncåéä¸­ã\n\nfunc registerdefaulttranslations(v *validator.validate, trans ut.translator) (err error) {\n\n\ttranslations := []struct {\n\t\ttag             string\n\t\ttranslation     string\n\t\toverride        bool\n\t\tcustomregisfunc validator.registertranslationsfunc\n\t\tcustomtransfunc validator.translationfunc\n\t}{\n\t\t{\n\t\t\ttag:         "required",\n\t\t\ttranslation: "{0}ä¸ºå¿å¡«å­æ®µ",\n\t\t\toverride:    false,\n\t\t},\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\næ¯ä¸ªå­æ®µçéè¯¯å¯¹è±¡é½ætranslateæ¹æ³ï¼å½è°ç¨æ¹æ³æ¶ï¼ä¼éåå½åææéè¯¯çå­æ®µï¼ç¶ååæ¾å°æ¯ä¸ªtagå¯¹åºçæç¤ºä¿¡æ¯è¾åºã\n\nfunc (ve validationerrors) translate(ut ut.translator) validationerrorstranslations {\n\n\ttrans := make(validationerrorstranslations)\n\n\tvar fe *fielderror\n\n\tfor i := 0; i < len(ve); i++ {\n\t\tfe = ve[i].(*fielderror)\n\n\t\t// // in case an anonymous struct was used, ensure that the key\n\t\t// // would be \'username\' instead of ".username"\n\t\t// if len(fe.ns) > 0 && fe.ns[:1] == "." {\n\t\t// \ttrans[fe.ns[1:]] = fe.translate(ut)\n\t\t// \tcontinue\n\t\t// }\n\n\t\ttrans[fe.ns] = fe.translate(ut)\n\t}\n\n\treturn trans\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿ä¸ªæ¯æ¯ä¸ä¸ªå­æ®µéè¿tagè·åæç¤ºä¿¡æ¯ã\n\nfunc (fe *fielderror) translate(ut ut.translator) string {\n\n\tm, ok := fe.v.transtagfunc[ut]\n\tif !ok {\n\t\treturn fe.error()\n\t}\n\n\tfn, ok := m[fe.tag]\n\tif !ok {\n\t\treturn fe.error()\n\t}\n\n\treturn fn(ut, fe)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"goç®åä½¿ç¨grpc",frontmatter:{tags:["goè¯­è¨"],title:"goç®åä½¿ç¨grpc",date:"2022-09-07T20:10:13.000Z",permalink:"/pages/87014e/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»goæ¯å¦ä½ä½¿ç¨grpcç",feed:{enable:!0},categories:["ç¼ç¨","goè¯­è¨"],comment:!0,meta:[{name:"twitter:title",content:"goç®åä½¿ç¨grpc"},{name:"twitter:description",content:"ä»ç»goæ¯å¦ä½ä½¿ç¨grpcç"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/01.go%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8grpc.html"},{property:"og:type",content:"article"},{property:"og:title",content:"goç®åä½¿ç¨grpc"},{property:"og:description",content:"ä»ç»goæ¯å¦ä½ä½¿ç¨grpcç"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/01.go%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8grpc.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-09-07T20:10:13.000Z"},{property:"article:tag",content:"goè¯­è¨"},{itemprop:"name",content:"goç®åä½¿ç¨grpc"},{itemprop:"description",content:"ä»ç»goæ¯å¦ä½ä½¿ç¨grpcç"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/01.go%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8grpc.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/01.goç®åä½¿ç¨grpc.md",key:"v-3d85724c",path:"/pages/87014e/",headers:[{level:2,title:"0.ç¸å³é¾æ¥",slug:"_0-ç¸å³é¾æ¥",normalizedTitle:"0.ç¸å³é¾æ¥",charIndex:2},{level:2,title:"1. å®ä¹protoæä»¶",slug:"_1-å®ä¹protoæä»¶",normalizedTitle:"1. å®ä¹protoæä»¶",charIndex:143},{level:2,title:"2. ç¼è¯protoæä»¶",slug:"_2-ç¼è¯protoæä»¶",normalizedTitle:"2. ç¼è¯protoæä»¶",charIndex:800},{level:2,title:"3. åå»ºgrpcæå¡ç«¯",slug:"_3-åå»ºgrpcæå¡ç«¯",normalizedTitle:"3. åå»ºgrpcæå¡ç«¯",charIndex:1378},{level:2,title:"4. åå»ºgrpcå®¢æ·ç«¯",slug:"_4-åå»ºgrpcå®¢æ·ç«¯",normalizedTitle:"4. åå»ºgrpcå®¢æ·ç«¯",charIndex:2874},{level:2,title:"5. è¿è¡ç»æ",slug:"_5-è¿è¡ç»æ",normalizedTitle:"5. è¿è¡ç»æ",charIndex:4043}],headersStr:"0.ç¸å³é¾æ¥ 1. å®ä¹protoæä»¶ 2. ç¼è¯protoæä»¶ 3. åå»ºgrpcæå¡ç«¯ 4. åå»ºgrpcå®¢æ·ç«¯ 5. è¿è¡ç»æ",content:'# 0.ç¸å³é¾æ¥\n\ngrpc githubï¼https://github.com/grpc/grpc-go\n\nå®æ¹ææ¡£ï¼https://grpc.io/docs/languages/go/\n\næ¡ä¾ä»£ç ï¼https://github.com/tenqaz/go-examples\n\n\n# 1. å®ä¹protoæä»¶\n\nprotoæä»¶æ¯ç¨æ¥é¢åå®ä¹çæ¶æ¯æ ¼å¼ãæ°æ®åä¼æç§protoæä»¶æå®ä¹çæ¶æ¯æ ¼å¼å®æäºè¿å¶ç æµçç¼ç åè§£ç ã\n\nsyntax = "proto3";\n\n// æå®çæç go æä»¶å­æ¾ä½ç½®åå¶åå\noption go_package = "./;proto";\n\n// å®ä¹User rpcæå¡\nservice User {\n  // å®ä¹rpcæå¡çæ¹æ³\n  rpc AddUser (UserRequest) returns (UserResponse);\n  rpc GetUser (GetUserRequest) returns (GetUserResponse);\n}\n\n// è¯·æ±çç»æä½\nmessage UserRequest {\n  string name = 1;\n  uint32 age = 2;\n}\n\n// ååºçç»æä½\nmessage UserResponse {\n  string msg = 1;\n  int32 code = 2;\n}\n\nmessage GetUserRequest {\n  string name = 1;\n}\n\nmessage GetUserResponse {\n  string name = 1;\n  string age = 2;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# 2. ç¼è¯protoæä»¶\n\né¦åéè¦å®è£protocçäºè¿å¶æä»¶ï¼æ¯ç¨æ¥ç¼è¯protoçã\n\nä¸è½½å°åï¼https://github.com/protocolbuffers/protobuf/releases\n\nç¶ååä¸è½½å®è£ç¼è¯protoæä»¶çæä»¶\n\n$ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28\n$ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2\n\n\n1\n2\n\n\nè¿å¥protoç®å½ä¸ä½¿ç¨ä»¥ä¸å½ä»¤å¯¹protoæä»¶è¿è¡ç¼è¯ï¼ä¼çæä¸¤ä¸ªæä»¶user.pb.goåuser_grpc.pb.goä¸¤ä¸ªæä»¶\n\nprotoc --go_out=. --go-grpc_out=. user.proto\n\n\n1\n\n * --go_out=. protobufç¸å³ä»£ç æä»¶çæå¨è¯¥ç®å½ä¸\n * --go-grpc_out=. grpcç¸å³ä»£ç æä»¶çæå¨è¯¥ç®å½ä¸\n\nç¼è¯å:\n\n * user.pb.goï¼ä¸»è¦æ¯è¯·æ±ä¸ç¸åºæ°æ®åçç»æä½å®ä¹ï¼å®¢æ·ç«¯åæå¡ç«¯é½å¯ä»¥éè¿è¯¥ç»æä½è¿è¡åºååä¸ååºååã\n * user_grpc.pb.goï¼ä¸»è¦æ¯grpcçæå¡ç«¯åå®¢æ·ç«¯ä»£ç ï¼éè¿å®ç°åè°ç¨æ¥å£æ¥äºç¸æ²éã\n\n\n# 3. åå»ºgrpcæå¡ç«¯\n\næä»¬é¦åè¦å®ç°user_grpc.pb.goä¸­çUserServeræ¥å£ï¼è¯¥æ¥å£ä¸­çæ¹æ³æ¯æä»¬å¨protoæä»¶ä¸­å®ä¹çrpcæå¡AddUseråGetUserã\n\nä¸è¿ï¼ä½ ä¼åç°å¶ä¸­è¿å¤äºä¸ªmustEmbedUnimplementedUserServeræ¹æ³ï¼ä½æ¯æä»¬protoæä»¶ä¸­å¹¶æ²¡æå®ä¹ï¼è¿ä¸ªæ¯ç¨æ¥å¼å®¹ä½¿ç¨çãä½ çå¯ä»¥æä»¶ä¸­UnimplementedUserServerç»æä½å®ç°äºUserServeræ¥å£ï¼èªå·±å®ä¹UserServiceåå«UnimplementedUserServerï¼å³ä½¿æ²¡æå®ç°UserServeræææ¥å£ï¼ä¹ä¸ä¼æ¥éã\n\npackage main\n\nimport (\n\t"context"\n\t"fmt"\n\t"google.golang.org/grpc"\n\t"log"\n\t"net"\n\t"simple_example/proto"\n)\n\n// UserService å®ä¹ç»æä½ï¼å®ç°UserServer\ntype UserService struct {\n\tproto.UnimplementedUserServer\n}\n\nfunc NewUserService() *UserService {\n\treturn &UserService{}\n}\n\n// AddUser å®ç°rpcæ¹æ³\nfunc (us *UserService) AddUser(ctx context.Context, request *proto.UserRequest) (*proto.UserResponse, error) {\n\tfmt.Printf("add user success. name = %s, age = %d\\n", request.GetName(), request.GetAge())\n\treturn &proto.UserResponse{Msg: "success", Code: 0}, nil\n}\n\nfunc (us *UserService) GetUser(ctx context.Context, request *proto.GetUserRequest) (*proto.GetUserResponse, error) {\n\tfmt.Printf("get user. name = %s\\n", request.GetName())\n\treturn &proto.GetUserResponse{Name: request.GetName(), Age: 1999}, nil\n}\n\nfunc main() {\n\t// çå¬ç«¯å£\n\tlis, err := net.Listen("tcp", fmt.Sprintf("localhost:%d", 8000))\n\tif err != nil {\n\t\tlog.Fatalf("failed to listen: %v", err)\n\t}\n\tgrpcServer := grpc.NewServer()\n\n\t// æ³¨årpcæå¡\n\tproto.RegisterUserServer(grpcServer, NewUserService())\n\tgrpcServer.Serve(lis)\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n\n\n\n# 4. åå»ºgrpcå®¢æ·ç«¯\n\nè°ç¨user_grpc.pb.goæä»¶ä¸­çNewUserClientæ¹æ³æ¥åå»ºè°ç¨rpcæå¡çå®¢æ·ç«¯ï¼è°ç¨rpcæ¹æ³æ¶ä½¿ç¨user.pb.goä¸­çç»æä½ä½ä¸ºè¾å¥ä¸è¾åºã\n\npackage main\n\nimport (\n\t"context"\n\t"fmt"\n\t"google.golang.org/grpc"\n\t"google.golang.org/grpc/credentials/insecure"\n\t"log"\n\t"simple_example/proto"\n)\n\nfunc main() {\n\tvar opts []grpc.DialOption\n\topts = append(opts, grpc.WithTransportCredentials(insecure.NewCredentials()))\n\n\tconn, err := grpc.Dial("localhost:8000", opts...)\n\tif err != nil {\n\t\tlog.Fatalf("fail to dial: %v", err)\n\t}\n\tdefer conn.Close()\n\n\tclient := proto.NewUserClient(conn)\n\n\t// è°ç¨rpcæå¡AddUseræ¹æ³\n\tresp, err := client.AddUser(context.Background(), &proto.UserRequest{Name: "zhengwenfeng", Age: 18})\n\tif err != nil {\n\t\tlog.Fatalf("fail to AddUser: %v", err)\n\t}\n\tfmt.Printf("AddUser, msg = %s, code = %d\\n", resp.Msg, resp.Code)\n\n\t// è°ç¨rpcæå¡GetUseræ¹æ³\n\tgetuserResp, err := client.GetUser(context.Background(), &proto.GetUserRequest{Name: "zhangsan"})\n\tif err != nil {\n\t\tlog.Fatalf("fail to GetUser: %v", err)\n\t}\n\tfmt.Printf("GetUser, Name = %s, Age = %d", getuserResp.Name, getuserResp.Age)\n\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\n\n# 5. è¿è¡ç»æ\n\né¦åè¿è¡æå¡ç«¯çå¬rpcæå¡ ç¶ååè¿è¡å®¢æ·ç«¯è°ç¨æå¡ã æå¡ç«¯è¾åºï¼\n\nadd user success. name = zhengwenfeng, age = 18\nget user success. name = zhangsan\n\n\n1\n2\n\n\nå®¢æ·ç«¯è¾åºï¼\n\nAddUser, msg = success, code = 0\nGetUser, Name = zhangsan, Age = 1999\n\n\n1\n2\n',normalizedContent:'# 0.ç¸å³é¾æ¥\n\ngrpc githubï¼https://github.com/grpc/grpc-go\n\nå®æ¹ææ¡£ï¼https://grpc.io/docs/languages/go/\n\næ¡ä¾ä»£ç ï¼https://github.com/tenqaz/go-examples\n\n\n# 1. å®ä¹protoæä»¶\n\nprotoæä»¶æ¯ç¨æ¥é¢åå®ä¹çæ¶æ¯æ ¼å¼ãæ°æ®åä¼æç§protoæä»¶æå®ä¹çæ¶æ¯æ ¼å¼å®æäºè¿å¶ç æµçç¼ç åè§£ç ã\n\nsyntax = "proto3";\n\n// æå®çæç go æä»¶å­æ¾ä½ç½®åå¶åå\noption go_package = "./;proto";\n\n// å®ä¹user rpcæå¡\nservice user {\n  // å®ä¹rpcæå¡çæ¹æ³\n  rpc adduser (userrequest) returns (userresponse);\n  rpc getuser (getuserrequest) returns (getuserresponse);\n}\n\n// è¯·æ±çç»æä½\nmessage userrequest {\n  string name = 1;\n  uint32 age = 2;\n}\n\n// ååºçç»æä½\nmessage userresponse {\n  string msg = 1;\n  int32 code = 2;\n}\n\nmessage getuserrequest {\n  string name = 1;\n}\n\nmessage getuserresponse {\n  string name = 1;\n  string age = 2;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\n\n# 2. ç¼è¯protoæä»¶\n\né¦åéè¦å®è£protocçäºè¿å¶æä»¶ï¼æ¯ç¨æ¥ç¼è¯protoçã\n\nä¸è½½å°åï¼https://github.com/protocolbuffers/protobuf/releases\n\nç¶ååä¸è½½å®è£ç¼è¯protoæä»¶çæä»¶\n\n$ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28\n$ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2\n\n\n1\n2\n\n\nè¿å¥protoç®å½ä¸ä½¿ç¨ä»¥ä¸å½ä»¤å¯¹protoæä»¶è¿è¡ç¼è¯ï¼ä¼çæä¸¤ä¸ªæä»¶user.pb.goåuser_grpc.pb.goä¸¤ä¸ªæä»¶\n\nprotoc --go_out=. --go-grpc_out=. user.proto\n\n\n1\n\n * --go_out=. protobufç¸å³ä»£ç æä»¶çæå¨è¯¥ç®å½ä¸\n * --go-grpc_out=. grpcç¸å³ä»£ç æä»¶çæå¨è¯¥ç®å½ä¸\n\nç¼è¯å:\n\n * user.pb.goï¼ä¸»è¦æ¯è¯·æ±ä¸ç¸åºæ°æ®åçç»æä½å®ä¹ï¼å®¢æ·ç«¯åæå¡ç«¯é½å¯ä»¥éè¿è¯¥ç»æä½è¿è¡åºååä¸ååºååã\n * user_grpc.pb.goï¼ä¸»è¦æ¯grpcçæå¡ç«¯åå®¢æ·ç«¯ä»£ç ï¼éè¿å®ç°åè°ç¨æ¥å£æ¥äºç¸æ²éã\n\n\n# 3. åå»ºgrpcæå¡ç«¯\n\næä»¬é¦åè¦å®ç°user_grpc.pb.goä¸­çuserserveræ¥å£ï¼è¯¥æ¥å£ä¸­çæ¹æ³æ¯æä»¬å¨protoæä»¶ä¸­å®ä¹çrpcæå¡adduserågetuserã\n\nä¸è¿ï¼ä½ ä¼åç°å¶ä¸­è¿å¤äºä¸ªmustembedunimplementeduserserveræ¹æ³ï¼ä½æ¯æä»¬protoæä»¶ä¸­å¹¶æ²¡æå®ä¹ï¼è¿ä¸ªæ¯ç¨æ¥å¼å®¹ä½¿ç¨çãä½ çå¯ä»¥æä»¶ä¸­unimplementeduserserverç»æä½å®ç°äºuserserveræ¥å£ï¼èªå·±å®ä¹userserviceåå«unimplementeduserserverï¼å³ä½¿æ²¡æå®ç°userserveræææ¥å£ï¼ä¹ä¸ä¼æ¥éã\n\npackage main\n\nimport (\n\t"context"\n\t"fmt"\n\t"google.golang.org/grpc"\n\t"log"\n\t"net"\n\t"simple_example/proto"\n)\n\n// userservice å®ä¹ç»æä½ï¼å®ç°userserver\ntype userservice struct {\n\tproto.unimplementeduserserver\n}\n\nfunc newuserservice() *userservice {\n\treturn &userservice{}\n}\n\n// adduser å®ç°rpcæ¹æ³\nfunc (us *userservice) adduser(ctx context.context, request *proto.userrequest) (*proto.userresponse, error) {\n\tfmt.printf("add user success. name = %s, age = %d\\n", request.getname(), request.getage())\n\treturn &proto.userresponse{msg: "success", code: 0}, nil\n}\n\nfunc (us *userservice) getuser(ctx context.context, request *proto.getuserrequest) (*proto.getuserresponse, error) {\n\tfmt.printf("get user. name = %s\\n", request.getname())\n\treturn &proto.getuserresponse{name: request.getname(), age: 1999}, nil\n}\n\nfunc main() {\n\t// çå¬ç«¯å£\n\tlis, err := net.listen("tcp", fmt.sprintf("localhost:%d", 8000))\n\tif err != nil {\n\t\tlog.fatalf("failed to listen: %v", err)\n\t}\n\tgrpcserver := grpc.newserver()\n\n\t// æ³¨årpcæå¡\n\tproto.registeruserserver(grpcserver, newuserservice())\n\tgrpcserver.serve(lis)\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n\n\n\n# 4. åå»ºgrpcå®¢æ·ç«¯\n\nè°ç¨user_grpc.pb.goæä»¶ä¸­çnewuserclientæ¹æ³æ¥åå»ºè°ç¨rpcæå¡çå®¢æ·ç«¯ï¼è°ç¨rpcæ¹æ³æ¶ä½¿ç¨user.pb.goä¸­çç»æä½ä½ä¸ºè¾å¥ä¸è¾åºã\n\npackage main\n\nimport (\n\t"context"\n\t"fmt"\n\t"google.golang.org/grpc"\n\t"google.golang.org/grpc/credentials/insecure"\n\t"log"\n\t"simple_example/proto"\n)\n\nfunc main() {\n\tvar opts []grpc.dialoption\n\topts = append(opts, grpc.withtransportcredentials(insecure.newcredentials()))\n\n\tconn, err := grpc.dial("localhost:8000", opts...)\n\tif err != nil {\n\t\tlog.fatalf("fail to dial: %v", err)\n\t}\n\tdefer conn.close()\n\n\tclient := proto.newuserclient(conn)\n\n\t// è°ç¨rpcæå¡adduseræ¹æ³\n\tresp, err := client.adduser(context.background(), &proto.userrequest{name: "zhengwenfeng", age: 18})\n\tif err != nil {\n\t\tlog.fatalf("fail to adduser: %v", err)\n\t}\n\tfmt.printf("adduser, msg = %s, code = %d\\n", resp.msg, resp.code)\n\n\t// è°ç¨rpcæå¡getuseræ¹æ³\n\tgetuserresp, err := client.getuser(context.background(), &proto.getuserrequest{name: "zhangsan"})\n\tif err != nil {\n\t\tlog.fatalf("fail to getuser: %v", err)\n\t}\n\tfmt.printf("getuser, name = %s, age = %d", getuserresp.name, getuserresp.age)\n\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n\n\n\n# 5. è¿è¡ç»æ\n\né¦åè¿è¡æå¡ç«¯çå¬rpcæå¡ ç¶ååè¿è¡å®¢æ·ç«¯è°ç¨æå¡ã æå¡ç«¯è¾åºï¼\n\nadd user success. name = zhengwenfeng, age = 18\nget user success. name = zhangsan\n\n\n1\n2\n\n\nå®¢æ·ç«¯è¾åºï¼\n\nadduser, msg = success, code = 0\ngetuser, name = zhangsan, age = 1999\n\n\n1\n2\n',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯",frontmatter:{tags:["goè¯­è¨","gin"],title:"ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯",date:"2022-09-11T16:53:33.000Z",permalink:"/pages/cf9a4d/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¦ä½ä¼åginæ¡æ¶ä¸­è¡¨åçéè¯¯æç¤ºä¿¡æ¯",feed:{enable:!0},categories:["ç¼ç¨","goè¯­è¨"],comment:!0,meta:[{name:"twitter:title",content:"ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯"},{name:"twitter:description",content:"å¦ä½ä¼åginæ¡æ¶ä¸­è¡¨åçéè¯¯æç¤ºä¿¡æ¯"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/03.%E4%BC%98%E5%8C%96gin%E8%A1%A8%E5%8D%95%E7%9A%84%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯"},{property:"og:description",content:"å¦ä½ä¼åginæ¡æ¶ä¸­è¡¨åçéè¯¯æç¤ºä¿¡æ¯"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/03.%E4%BC%98%E5%8C%96gin%E8%A1%A8%E5%8D%95%E7%9A%84%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-09-11T16:53:33.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"gin"},{itemprop:"name",content:"ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯"},{itemprop:"description",content:"å¦ä½ä¼åginæ¡æ¶ä¸­è¡¨åçéè¯¯æç¤ºä¿¡æ¯"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/03.%E4%BC%98%E5%8C%96gin%E8%A1%A8%E5%8D%95%E7%9A%84%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/03.ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯.md",key:"v-465edabc",path:"/pages/cf9a4d/",headers:[{level:2,title:"ç¸å³é¾æ¥",slug:"ç¸å³é¾æ¥",normalizedTitle:"ç¸å³é¾æ¥",charIndex:2},{level:2,title:"ç®åä½¿ç¨è¡¨åæ£éªè¯·æ±åæ°",slug:"ç®åä½¿ç¨è¡¨åæ£éªè¯·æ±åæ°",normalizedTitle:"ç®åä½¿ç¨è¡¨åæ£éªè¯·æ±åæ°",charIndex:27},{level:2,title:"ç¿»è¯",slug:"ç¿»è¯",normalizedTitle:"ç¿»è¯",charIndex:970},{level:2,title:"ä¼åè¿åå­æ®µçkey",slug:"ä¼åè¿åå­æ®µçkey",normalizedTitle:"ä¼åè¿åå­æ®µçkey",charIndex:3105},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:5184}],headersStr:"ç¸å³é¾æ¥ ç®åä½¿ç¨è¡¨åæ£éªè¯·æ±åæ° ç¿»è¯ ä¼åè¿åå­æ®µçkey æ»ç»",content:'# ç¸å³é¾æ¥\n\nginå®æ¹ä¾å­\n\næç« çä»£ç \n\n\n# ç®åä½¿ç¨è¡¨åæ£éªè¯·æ±åæ°\n\nåå»ºä¸ä¸ªç®åçç»å½ä¾å­ï¼æä»¬å¯¹usernameåpasswordç»å®äºrequiredæ ç­¾ï¼ä»£è¡¨çè¯·æ±loginæ¥å£çåæ°ä¸­å¿é¡»åå«è¿ä¸¤ä¸ªå­æ®µã\n\ntype User struct {\n\tUserName string `json:"username" binding:"required"`\n\tPassword string `json:"password" binding:"required"`\n}\n\nfunc login(c *gin.Context) {\n\n\tvar user User\n\tif err := c.ShouldBindJSON(&user); err != nil {\n\t\tc.JSON(http.StatusOK, gin.H{"msg": err.Error()})\n\t\treturn\n\t}\n\n\tif user.UserName != "admin" || user.Password != "123456" {\n\t\tc.JSON(http.StatusUnauthorized, gin.H{"msg": "unauthorized"})\n\t\treturn\n\t}\n\n\tc.JSON(http.StatusOK, gin.H{"msg": "you are logged in"})\n}\n\nfunc main() {\n\tr := gin.Default()\n\tr.POST("/login", login)\n\tr.Run() // çå¬å¹¶å¨ 0.0.0.0:8080 ä¸å¯å¨æå¡\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\næä»¬ä½¿ç¨ä»å¸¦æusernameå»è¯·æ±loginæ¥å£ï¼ä¼è¾åºå¦ä¸ï¼æç¤ºæä»¬Passwordæ ¡éªå¤±è´¥äºï¼å ä¸ºrequiredçæ ç­¾å¯¼è´çãä½æ¯è¿ä¸ªæç¤ºå¹¶ä¸åå¥½ï¼æä»¬éè¦è¿è¡ä¼åå±ç¤ºã\n\n{\'msg\': "Key: \'User.Password\' Error:Field validation for \'Password\' failed on the \'required\' tag"}\n\n\n1\n\n\n\n# ç¿»è¯\n\næä»¬éè¦å¯¹ä¸é¢çæç¤ºä¿¡æ¯è¿è¡ä¸ä¸ªç¿»è¯ï¼å¹¶ä¸å¯ä»¥æ¯æåç§è¯­è¨çåå¥½æ§æç¤ºã\n\næä»¬å¨global/global.goæä»¶ä¸­åå»ºä¸ä¸ªå¨å±åéï¼è¯¥å¨å±åéå¨åé¢çè¡¨åç¿»è¯ä¸­éè¦ä½¿ç¨å°\n\nimport ut "github.com/go-playground/universal-translator"\n\nvar (\n\tTrans ut.Translator\n)\n\n\n1\n2\n3\n4\n5\n\n\nå¨initialize/validator.goæä»¶ä¸­ç¼ååå®¹å¦ä¸ï¼è·åginä¸­çvalidateå¯¹è±¡ï¼ç¶åç»è¯¥å¯¹è±¡ç»å®ä¸­æåè±æçåå¥½æç¤ºä¿¡æ¯ï¼æä»¬å¯ä»¥éè¿localeæ¥è®¾ç½®æä»¬éè¦ä½¿ç¨ä¸­æè¿æ¯è±æçä¿¡æ¯ã\n\nfunc InitTrans(locale string) (err error) {\n\n\tif v, ok := binding.Validator.Engine().(*validator.Validate); ok {\n\n\t\t// ç¿»è¯\n\t\tzhT := zh.New()\n\t\tenT := en.New()\n\t\tuni := ut.New(enT, zhT, enT)\n\n\t\tglobal.Trans, ok = uni.GetTranslator(locale)\n\t\tif !ok {\n\t\t\treturn fmt.Errorf("uni.GetTranslator(%s) error", locale)\n\t\t}\n\n\t\tswitch locale {\n\t\tcase "zh":\n\t\t\tzh_translations.RegisterDefaultTranslations(v, global.Trans)\n\t\tcase "en":\n\t\t\ten_translations.RegisterDefaultTranslations(v, global.Trans)\n\t\tdefault:\n\t\t\ten_translations.RegisterDefaultTranslations(v, global.Trans)\n\t\t}\n\n\t\treturn\n\t}\n\treturn\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\næåå¨main.goä¸­çmainæ¹æ³ä¸è°ç¨ä¸é¢çInitTransæ¹æ³æ¥åå§åç¿»è¯åå®¹ã\n\nåå°loginæ¹æ³ä¸­ShouldBindJSONè¿åçerrorè½¬ævalidator.ValidationErrorsç±»åï¼è¯¥ç±»ååå«ä¸ä¸ªTranslateæ¹æ³ï¼è°ç¨è¯¥æ¹æ³ï¼åå°ä¹åçå¨å±åéTransä¼ å¥ã\n\nfunc login(c *gin.Context) {\n\n\tvar user User\n\tif err := c.ShouldBindJSON(&user); err != nil {\n\n\t\terrs, ok := err.(validator.ValidationErrors)\n\t\tif !ok {\n\t\t\t// éæ ¡éªéè¯¯ï¼å¶ä»éè¯¯ç´æ¥è¿å\n\t\t\tc.JSON(http.StatusOK, gin.H{"msg": err.Error()})\n\t\t\treturn\n\t\t}\n\n\t\tc.JSON(http.StatusOK, gin.H{"msg": errs.Translate(global.Trans)})\n\t\treturn\n\t}\n\n\tif user.UserName != "admin" || user.Password != "123456" {\n\t\tc.JSON(http.StatusUnauthorized, gin.H{"msg": "unauthorized"})\n\t\treturn\n\t}\n\n\tc.JSON(http.StatusOK, gin.H{"msg": "you are logged in"})\n}\n\nfunc main() {\n\terr := initialize.InitTrans("zh")\n\tif err != nil {\n\t\tfmt.Printf("åå§åç¿»è¯å¨éè¯¯, err = %s", err.Error())\n\t\treturn\n\t}\n\n\tr := gin.Default()\n\tr.POST("/login", login)\n\tr.Run() // çå¬å¹¶å¨ 0.0.0.0:8080 ä¸å¯å¨æå¡\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n\n\næä»¬åä½¿ç¨ä»å¸¦æusernameå­æ®µå»è¯·æ±loginæ¥å£ï¼è¾åºåå®¹å¦ä¸ã\n\n{\'msg\': {\'User.Password\': \'Passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\nä½æ¯ï¼åç°æç¤ºä¿¡æ¯çkeyæ¯User.Passwordï¼æ¯è¡¨åå¯¹è±¡åå¶å­æ®µåç§°ï¼æä»¬åºè¯¥æ³è¦çæ¯ï¼\n\n{\'msg\': {\'password\': \'Passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\n\n# ä¼åè¿åå­æ®µçkey\n\næä»¬ä¿®æ¹InitTransæ¹æ³ï¼éè¿go-playgroundæä¾çæ¹æ³RegisterTagNameFuncæ¥å°æä»¬èªå®ä¹çæ¹æ³æ³¨åè¿å»ï¼è¯¥èªå®ä¹æ¹æ³çç®çæ¯ä¿®æ¹ä¸é¢çPasswordæ¹ä¸ºjsonä¸­çpasswordï¼å¯ä»¥æ¹æjsonæ ç­¾ä¸­çå¼ä½ä¸ºè¿åã\n\nfunc InitTrans(locale string) (err error) {\n\n\tif v, ok := binding.Validator.Engine().(*validator.Validate); ok {\n\n\t\t//ä¿®æ¹è¿åå­æ®µkeyçæ ¼å¼\n\t\tv.RegisterTagNameFunc(func(fld reflect.StructField) string {\n\t\t\tname := strings.SplitN(fld.Tag.Get("json"), ",", 2)[0]\n\t\t\tif name == "-" {\n\t\t\t\treturn ""\n\t\t\t}\n\t\t\treturn name\n\t\t})\n\n\t\t// ç¿»è¯\n\t\tzhT := zh.New()\n\t\tenT := en.New()\n\t\tuni := ut.New(enT, zhT, enT)\n\n\t\tglobal.Trans, ok = uni.GetTranslator(locale)\n\t\tif !ok {\n\t\t\treturn fmt.Errorf("uni.GetTranslator(%s) error", locale)\n\t\t}\n\n\t\tswitch locale {\n\t\tcase "zh":\n\t\t\tzh_translations.RegisterDefaultTranslations(v, global.Trans)\n\t\tcase "en":\n\t\t\ten_translations.RegisterDefaultTranslations(v, global.Trans)\n\t\tdefault:\n\t\t\ten_translations.RegisterDefaultTranslations(v, global.Trans)\n\t\t}\n\n\t\treturn\n\t}\n\treturn\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nåè¯·æ±ï¼ååºå¦ä¸ï¼åç°passwordå·²ç»æ¹å¥½äºï¼ä½æ¯Userä¹æ³å é¤ã\n\n{\'msg\': {\'User.password\': \'passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\næä»¬å¨utils/validator.goæä»¶ä¸­ç¼åä»£ç å¦ä¸ï¼è¯¥æ¹æ³æ¯ç¨æ¥å é¤Userçã\n\nfunc RemoveTopStruct(fields map[string]string) map[string]string {\n\tres := map[string]string{}\n\tfor field, err := range fields {\n\t\tres[field[strings.Index(field, ".")+1:]] = err\n\t}\n\treturn res\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nåå¨ç¿»è¯è¿åçéè¯¯ä¿¡æ¯åä¸è¯¥æ¹æ³ã\n\nfunc login(c *gin.Context) {\n\n\tvar user User\n\tif err := c.ShouldBindJSON(&user); err != nil {\n\n\t\terrs, ok := err.(validator.ValidationErrors)\n\t\tif !ok {\n\t\t\t// éæ ¡éªéè¯¯ï¼å¶ä»éè¯¯ç´æ¥è¿å\n\t\t\tc.JSON(http.StatusOK, gin.H{"msg": err.Error()})\n\t\t\treturn\n\t\t}\n\n\t\tc.JSON(http.StatusOK, gin.H{"msg": utils.RemoveTopStruct(errs.Translate(global.Trans))})\n\t\treturn\n\t}\n\n\tif user.UserName != "admin" || user.Password != "123456" {\n\t\tc.JSON(http.StatusUnauthorized, gin.H{"msg": "unauthorized"})\n\t\treturn\n\t}\n\n\tc.JSON(http.StatusOK, gin.H{"msg": "you are logged in"})\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåæ§è¡ï¼ç¸åºç»æå¦ä¸ï¼è¿ä¸ªå°±æ¯æä»¬æ³è¦çä¿¡æ¯ã\n\n{\'msg\': {\'password\': \'passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\n\n# æ»ç»\n\nä¸ªäººè§çè½ç¶ginçµæ´»å°å·§ï¼ä½æ¯åè½ççå¾ä¸å®åãæ¯æ¬¡ä¸æ¬¡è¾åºåå¥½ä¿¡æ¯ï¼æä»¬é½è¦æå¨è°ç¨Translateæ¥ç¿»è¯ï¼å¹¶ä¸è¿éè¦éè¿RemoveTopStructæ¹æ³æ¥ä¿®æ¹è¿åçä¿¡æ¯ï¼æç®åçæ¥è¯´ï¼åºè¯¥ç±æ¡æ¶æ¥åï¼æä»¬åªéè¦éè¿éç½®ï¼å°±è½èªå¨è¾åºæä»¬æ³è¦çåå¥½æç¤ºä¿¡æ¯æå¯¹ã',normalizedContent:'# ç¸å³é¾æ¥\n\nginå®æ¹ä¾å­\n\næç« çä»£ç \n\n\n# ç®åä½¿ç¨è¡¨åæ£éªè¯·æ±åæ°\n\nåå»ºä¸ä¸ªç®åçç»å½ä¾å­ï¼æä»¬å¯¹usernameåpasswordç»å®äºrequiredæ ç­¾ï¼ä»£è¡¨çè¯·æ±loginæ¥å£çåæ°ä¸­å¿é¡»åå«è¿ä¸¤ä¸ªå­æ®µã\n\ntype user struct {\n\tusername string `json:"username" binding:"required"`\n\tpassword string `json:"password" binding:"required"`\n}\n\nfunc login(c *gin.context) {\n\n\tvar user user\n\tif err := c.shouldbindjson(&user); err != nil {\n\t\tc.json(http.statusok, gin.h{"msg": err.error()})\n\t\treturn\n\t}\n\n\tif user.username != "admin" || user.password != "123456" {\n\t\tc.json(http.statusunauthorized, gin.h{"msg": "unauthorized"})\n\t\treturn\n\t}\n\n\tc.json(http.statusok, gin.h{"msg": "you are logged in"})\n}\n\nfunc main() {\n\tr := gin.default()\n\tr.post("/login", login)\n\tr.run() // çå¬å¹¶å¨ 0.0.0.0:8080 ä¸å¯å¨æå¡\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\næä»¬ä½¿ç¨ä»å¸¦æusernameå»è¯·æ±loginæ¥å£ï¼ä¼è¾åºå¦ä¸ï¼æç¤ºæä»¬passwordæ ¡éªå¤±è´¥äºï¼å ä¸ºrequiredçæ ç­¾å¯¼è´çãä½æ¯è¿ä¸ªæç¤ºå¹¶ä¸åå¥½ï¼æä»¬éè¦è¿è¡ä¼åå±ç¤ºã\n\n{\'msg\': "key: \'user.password\' error:field validation for \'password\' failed on the \'required\' tag"}\n\n\n1\n\n\n\n# ç¿»è¯\n\næä»¬éè¦å¯¹ä¸é¢çæç¤ºä¿¡æ¯è¿è¡ä¸ä¸ªç¿»è¯ï¼å¹¶ä¸å¯ä»¥æ¯æåç§è¯­è¨çåå¥½æ§æç¤ºã\n\næä»¬å¨global/global.goæä»¶ä¸­åå»ºä¸ä¸ªå¨å±åéï¼è¯¥å¨å±åéå¨åé¢çè¡¨åç¿»è¯ä¸­éè¦ä½¿ç¨å°\n\nimport ut "github.com/go-playground/universal-translator"\n\nvar (\n\ttrans ut.translator\n)\n\n\n1\n2\n3\n4\n5\n\n\nå¨initialize/validator.goæä»¶ä¸­ç¼ååå®¹å¦ä¸ï¼è·åginä¸­çvalidateå¯¹è±¡ï¼ç¶åç»è¯¥å¯¹è±¡ç»å®ä¸­æåè±æçåå¥½æç¤ºä¿¡æ¯ï¼æä»¬å¯ä»¥éè¿localeæ¥è®¾ç½®æä»¬éè¦ä½¿ç¨ä¸­æè¿æ¯è±æçä¿¡æ¯ã\n\nfunc inittrans(locale string) (err error) {\n\n\tif v, ok := binding.validator.engine().(*validator.validate); ok {\n\n\t\t// ç¿»è¯\n\t\tzht := zh.new()\n\t\tent := en.new()\n\t\tuni := ut.new(ent, zht, ent)\n\n\t\tglobal.trans, ok = uni.gettranslator(locale)\n\t\tif !ok {\n\t\t\treturn fmt.errorf("uni.gettranslator(%s) error", locale)\n\t\t}\n\n\t\tswitch locale {\n\t\tcase "zh":\n\t\t\tzh_translations.registerdefaulttranslations(v, global.trans)\n\t\tcase "en":\n\t\t\ten_translations.registerdefaulttranslations(v, global.trans)\n\t\tdefault:\n\t\t\ten_translations.registerdefaulttranslations(v, global.trans)\n\t\t}\n\n\t\treturn\n\t}\n\treturn\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\næåå¨main.goä¸­çmainæ¹æ³ä¸è°ç¨ä¸é¢çinittransæ¹æ³æ¥åå§åç¿»è¯åå®¹ã\n\nåå°loginæ¹æ³ä¸­shouldbindjsonè¿åçerrorè½¬ævalidator.validationerrorsç±»åï¼è¯¥ç±»ååå«ä¸ä¸ªtranslateæ¹æ³ï¼è°ç¨è¯¥æ¹æ³ï¼åå°ä¹åçå¨å±åétransä¼ å¥ã\n\nfunc login(c *gin.context) {\n\n\tvar user user\n\tif err := c.shouldbindjson(&user); err != nil {\n\n\t\terrs, ok := err.(validator.validationerrors)\n\t\tif !ok {\n\t\t\t// éæ ¡éªéè¯¯ï¼å¶ä»éè¯¯ç´æ¥è¿å\n\t\t\tc.json(http.statusok, gin.h{"msg": err.error()})\n\t\t\treturn\n\t\t}\n\n\t\tc.json(http.statusok, gin.h{"msg": errs.translate(global.trans)})\n\t\treturn\n\t}\n\n\tif user.username != "admin" || user.password != "123456" {\n\t\tc.json(http.statusunauthorized, gin.h{"msg": "unauthorized"})\n\t\treturn\n\t}\n\n\tc.json(http.statusok, gin.h{"msg": "you are logged in"})\n}\n\nfunc main() {\n\terr := initialize.inittrans("zh")\n\tif err != nil {\n\t\tfmt.printf("åå§åç¿»è¯å¨éè¯¯, err = %s", err.error())\n\t\treturn\n\t}\n\n\tr := gin.default()\n\tr.post("/login", login)\n\tr.run() // çå¬å¹¶å¨ 0.0.0.0:8080 ä¸å¯å¨æå¡\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n\n\næä»¬åä½¿ç¨ä»å¸¦æusernameå­æ®µå»è¯·æ±loginæ¥å£ï¼è¾åºåå®¹å¦ä¸ã\n\n{\'msg\': {\'user.password\': \'passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\nä½æ¯ï¼åç°æç¤ºä¿¡æ¯çkeyæ¯user.passwordï¼æ¯è¡¨åå¯¹è±¡åå¶å­æ®µåç§°ï¼æä»¬åºè¯¥æ³è¦çæ¯ï¼\n\n{\'msg\': {\'password\': \'passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\n\n# ä¼åè¿åå­æ®µçkey\n\næä»¬ä¿®æ¹inittransæ¹æ³ï¼éè¿go-playgroundæä¾çæ¹æ³registertagnamefuncæ¥å°æä»¬èªå®ä¹çæ¹æ³æ³¨åè¿å»ï¼è¯¥èªå®ä¹æ¹æ³çç®çæ¯ä¿®æ¹ä¸é¢çpasswordæ¹ä¸ºjsonä¸­çpasswordï¼å¯ä»¥æ¹æjsonæ ç­¾ä¸­çå¼ä½ä¸ºè¿åã\n\nfunc inittrans(locale string) (err error) {\n\n\tif v, ok := binding.validator.engine().(*validator.validate); ok {\n\n\t\t//ä¿®æ¹è¿åå­æ®µkeyçæ ¼å¼\n\t\tv.registertagnamefunc(func(fld reflect.structfield) string {\n\t\t\tname := strings.splitn(fld.tag.get("json"), ",", 2)[0]\n\t\t\tif name == "-" {\n\t\t\t\treturn ""\n\t\t\t}\n\t\t\treturn name\n\t\t})\n\n\t\t// ç¿»è¯\n\t\tzht := zh.new()\n\t\tent := en.new()\n\t\tuni := ut.new(ent, zht, ent)\n\n\t\tglobal.trans, ok = uni.gettranslator(locale)\n\t\tif !ok {\n\t\t\treturn fmt.errorf("uni.gettranslator(%s) error", locale)\n\t\t}\n\n\t\tswitch locale {\n\t\tcase "zh":\n\t\t\tzh_translations.registerdefaulttranslations(v, global.trans)\n\t\tcase "en":\n\t\t\ten_translations.registerdefaulttranslations(v, global.trans)\n\t\tdefault:\n\t\t\ten_translations.registerdefaulttranslations(v, global.trans)\n\t\t}\n\n\t\treturn\n\t}\n\treturn\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nåè¯·æ±ï¼ååºå¦ä¸ï¼åç°passwordå·²ç»æ¹å¥½äºï¼ä½æ¯userä¹æ³å é¤ã\n\n{\'msg\': {\'user.password\': \'passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\næä»¬å¨utils/validator.goæä»¶ä¸­ç¼åä»£ç å¦ä¸ï¼è¯¥æ¹æ³æ¯ç¨æ¥å é¤userçã\n\nfunc removetopstruct(fields map[string]string) map[string]string {\n\tres := map[string]string{}\n\tfor field, err := range fields {\n\t\tres[field[strings.index(field, ".")+1:]] = err\n\t}\n\treturn res\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\nåå¨ç¿»è¯è¿åçéè¯¯ä¿¡æ¯åä¸è¯¥æ¹æ³ã\n\nfunc login(c *gin.context) {\n\n\tvar user user\n\tif err := c.shouldbindjson(&user); err != nil {\n\n\t\terrs, ok := err.(validator.validationerrors)\n\t\tif !ok {\n\t\t\t// éæ ¡éªéè¯¯ï¼å¶ä»éè¯¯ç´æ¥è¿å\n\t\t\tc.json(http.statusok, gin.h{"msg": err.error()})\n\t\t\treturn\n\t\t}\n\n\t\tc.json(http.statusok, gin.h{"msg": utils.removetopstruct(errs.translate(global.trans))})\n\t\treturn\n\t}\n\n\tif user.username != "admin" || user.password != "123456" {\n\t\tc.json(http.statusunauthorized, gin.h{"msg": "unauthorized"})\n\t\treturn\n\t}\n\n\tc.json(http.statusok, gin.h{"msg": "you are logged in"})\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nåæ§è¡ï¼ç¸åºç»æå¦ä¸ï¼è¿ä¸ªå°±æ¯æä»¬æ³è¦çä¿¡æ¯ã\n\n{\'msg\': {\'password\': \'passwordä¸ºå¿å¡«å­æ®µ\'}}\n\n\n1\n\n\n\n# æ»ç»\n\nä¸ªäººè§çè½ç¶ginçµæ´»å°å·§ï¼ä½æ¯åè½ççå¾ä¸å®åãæ¯æ¬¡ä¸æ¬¡è¾åºåå¥½ä¿¡æ¯ï¼æä»¬é½è¦æå¨è°ç¨translateæ¥ç¿»è¯ï¼å¹¶ä¸è¿éè¦éè¿removetopstructæ¹æ³æ¥ä¿®æ¹è¿åçä¿¡æ¯ï¼æç®åçæ¥è¯´ï¼åºè¯¥ç±æ¡æ¶æ¥åï¼æä»¬åªéè¦éè¿éç½®ï¼å°±è½èªå¨è¾åºæä»¬æ³è¦çåå¥½æç¤ºä¿¡æ¯æå¯¹ã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"goä¸­å¦ä½å¤çerror",frontmatter:{title:"goä¸­å¦ä½å¤çerror",date:"2022-11-14T10:11:11.000Z",permalink:"/pages/d93df5/",tags:["goè¯­è¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨ go ä¸­æ panic çæºå¶ï¼ä½ panic æå³çç¨åºç»æ­¢ï¼ä»£ç ä¸è½ç»§ç»­è¿è¡äºï¼ä¸è½ææè°ç¨èæ¥è§£å³å®ãè error æ¯é¢æä¸­çå¼å¸¸ï¼å¸æè°ç¨èå¯ä»¥å¯¹å¶è¿è¡å¤ççã",categories:["ç¼ç¨","goè¯­è¨"],comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"goä¸­å¦ä½å¤çerror"},{name:"twitter:description",content:"å¨ go ä¸­æ panic çæºå¶ï¼ä½ panic æå³çç¨åºç»æ­¢ï¼ä»£ç ä¸è½ç»§ç»­è¿è¡äºï¼ä¸è½ææè°ç¨èæ¥è§£å³å®ãè error æ¯é¢æä¸­çå¼å¸¸ï¼å¸æè°ç¨èå¯ä»¥å¯¹å¶è¿è¡å¤ççã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/04.go%E4%B8%AD%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86error.html"},{property:"og:type",content:"article"},{property:"og:title",content:"goä¸­å¦ä½å¤çerror"},{property:"og:description",content:"å¨ go ä¸­æ panic çæºå¶ï¼ä½ panic æå³çç¨åºç»æ­¢ï¼ä»£ç ä¸è½ç»§ç»­è¿è¡äºï¼ä¸è½ææè°ç¨èæ¥è§£å³å®ãè error æ¯é¢æä¸­çå¼å¸¸ï¼å¸æè°ç¨èå¯ä»¥å¯¹å¶è¿è¡å¤ççã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/04.go%E4%B8%AD%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86error.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-11-14T10:11:11.000Z"},{property:"article:tag",content:"goè¯­è¨"},{itemprop:"name",content:"goä¸­å¦ä½å¤çerror"},{itemprop:"description",content:"å¨ go ä¸­æ panic çæºå¶ï¼ä½ panic æå³çç¨åºç»æ­¢ï¼ä»£ç ä¸è½ç»§ç»­è¿è¡äºï¼ä¸è½ææè°ç¨èæ¥è§£å³å®ãè error æ¯é¢æä¸­çå¼å¸¸ï¼å¸æè°ç¨èå¯ä»¥å¯¹å¶è¿è¡å¤ççã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/04.go%E4%B8%AD%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86error.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/04.goä¸­å¦ä½å¤çerror.md",key:"v-2afdd346",path:"/pages/d93df5/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. error æ¯ä»ä¹ï¼",slug:"_1-error-æ¯ä»ä¹",normalizedTitle:"1. error æ¯ä»ä¹ï¼",charIndex:195},{level:2,title:"2. éè¯¯ç±»å",slug:"_2-éè¯¯ç±»å",normalizedTitle:"2. éè¯¯ç±»å",charIndex:1465},{level:3,title:"2.1 Sentinel Error(é¢å®ä¹éè¯¯)",slug:"_2-1-sentinel-error-é¢å®ä¹éè¯¯",normalizedTitle:"2.1 sentinel error(é¢å®ä¹éè¯¯)",charIndex:1477},{level:3,title:"2.2 Error types(èªå®ä¹éç±»å)",slug:"_2-2-error-types-èªå®ä¹éç±»å",normalizedTitle:"2.2 error types(èªå®ä¹éç±»å)",charIndex:2033},{level:3,title:"2.3 Opaque errors(ä¸éæçéè¯¯)",slug:"_2-3-opaque-errors-ä¸éæçéè¯¯",normalizedTitle:"2.3 opaque errors(ä¸éæçéè¯¯)",charIndex:3015},{level:2,title:"3. ä¼éçå¤çéè¯¯",slug:"_3-ä¼éçå¤çéè¯¯",normalizedTitle:"3. ä¼éçå¤çéè¯¯",charIndex:3513},{level:3,title:"3.1 æ éè¯¯çæ­£å¸¸æµç¨ä»£ç ",slug:"_3-1-æ éè¯¯çæ­£å¸¸æµç¨ä»£ç ",normalizedTitle:"3.1 æ éè¯¯çæ­£å¸¸æµç¨ä»£ç ",charIndex:3528},{level:3,title:"3.2 åå°ä¸å¿è¦çå¤æ­",slug:"_3-2-åå°ä¸å¿è¦çå¤æ­",normalizedTitle:"3.2 åå°ä¸å¿è¦çå¤æ­",charIndex:3794},{level:3,title:"3.3 å° error åé¨å­å¨èµ·æ¥",slug:"_3-3-å°-error-åé¨å­å¨èµ·æ¥",normalizedTitle:"3.3 å° error åé¨å­å¨èµ·æ¥",charIndex:4059},{level:3,title:"3.4 å°éå¤æä½æ½ç¦»åºæ¥",slug:"_3-4-å°éå¤æä½æ½ç¦»åºæ¥",normalizedTitle:"3.4 å°éå¤æä½æ½ç¦»åºæ¥",charIndex:4865},{level:2,title:"4. Wrap erros",slug:"_4-wrap-erros",normalizedTitle:"4. wrap erros",charIndex:6248},{level:2,title:"5. pkg/errors",slug:"_5-pkg-errors",normalizedTitle:"5. pkg/errors",charIndex:8186},{level:2,title:"6. error çæä½³å®è·µ",slug:"_6-error-çæä½³å®è·µ",normalizedTitle:"6. error çæä½³å®è·µ",charIndex:9741},{level:2,title:"åèèµæ",slug:"åèèµæ",normalizedTitle:"åèèµæ",charIndex:10492}],headersStr:"0. åè¨ 1. error æ¯ä»ä¹ï¼ 2. éè¯¯ç±»å 2.1 Sentinel Error(é¢å®ä¹éè¯¯) 2.2 Error types(èªå®ä¹éç±»å) 2.3 Opaque errors(ä¸éæçéè¯¯) 3. ä¼éçå¤çéè¯¯ 3.1 æ éè¯¯çæ­£å¸¸æµç¨ä»£ç  3.2 åå°ä¸å¿è¦çå¤æ­ 3.3 å° error åé¨å­å¨èµ·æ¥ 3.4 å°éå¤æä½æ½ç¦»åºæ¥ 4. Wrap erros 5. pkg/errors 6. error çæä½³å®è·µ åèèµæ",content:'# 0. åè¨\n\ngo ä¸­çå¼å¸¸å¤çåå¶ä»è¯­è¨å¤§ä¸ç¸åï¼å JavaãC++ãpython ç­è¯­è¨é½æ¯éè¿æåº Exception æ¥å¤çå¼å¸¸ï¼è go æ¯éè¿è¿å error æ¥å¤å®å¼å¸¸ï¼å¹¶è¿è¡å¤çã\n\nå¨ go ä¸­æ panic çæºå¶ï¼ä½ panic æå³çç¨åºç»æ­¢ï¼ä»£ç ä¸è½ç»§ç»­è¿è¡äºï¼ä¸è½ææè°ç¨èæ¥è§£å³å®ãè error æ¯é¢æä¸­çå¼å¸¸ï¼å¸æè°ç¨èå¯ä»¥å¯¹å¶è¿è¡å¤ççã\n\n\n# 1. error æ¯ä»ä¹ï¼\n\nä¸¾ä¸ªä¾å­ï¼ä½¿ç¨ Open æ¥æå¼æä»¶ï¼ä½æ¯å¯è½è¯¥è·¯å¾çæä»¶ä¸å­å¨ï¼åºç°å¼å¸¸ï¼å¨ go æ¯éè¿å¤æ­ err æ¯å¦ä¸º nil æ¥å¤å®æå¼æä»¶æ¯å¦æåã\n\nf, err := os.Open(path)\nif err != nil {\n    // handle error\n}\n\n// do stuff\n\n\n1\n2\n3\n4\n5\n6\n\n\né®é¢æ¥äºï¼error æ¯ä»ä¹ï¼\n\næ¥çæºç ä¼åç°ï¼error æ¯ä¸ä¸ªåå« Error æ¹æ³çæ¥å£ï¼è¿åçæ¯å®ç°äºè¯¥æ¥å£çå¯¹è±¡ã\n\ntype error interface {  \n   Error() string  \n}\n\n\n1\n2\n3\n\n\næä»¬ä¸è¬ä½¿ç¨æ¯éè¿ errors.New()æ¥è¿åä¸ä¸ªå®ç°äº error æ¥å£çå¯¹è±¡ãè¿ä¸ªå¯¹è±¡æ¯ä¸ä¸ªåå«äºå­ç¬¦ä¸²çç»æä½ï¼ç¶åå¯ä»¥éè¿ Error æ¹æ³æ¥è·åå­ç¬¦ä¸²ã\n\nfunc New(text string) error {  \n   return &errorString{text}  \n}  \n  \n// errorString is a trivial implementation of error.\ntype errorString struct {  \n   s string  \n}  \n  \nfunc (e *errorString) Error() string {  \n   return e.s  \n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\næä»¬å¯ä»¥æ³¨æå° New æ¹æ³è¿åçæ¯ errorString çå°åï¼ä¹å°±æ¯è¯´ï¼å¨æä»¬å°ä¸¤ä¸ª error æ¯è¾ç¸ç­æ¶ï¼æ¯è¾æ¯å°åï¼æ¯ä¸¤ä¸ª error æ¯å¦ä¸ºåä¸ä¸ªå¯¹è±¡ï¼èä¸æ¯å¶ä¸­çéè¯¯å­ç¬¦ä¸²ã\n\nimport (\n\t"errors"\n\t"fmt"\n)\n\ntype errorString string\n\nfunc (e errorString) Error() string {\n\treturn string(e)\n}\n\nfunc New(text string) error {\n\treturn errorString(text)\n}\n\nvar ErrNamedType = New("EOF")\nvar ErrStructType = errors.New("EOF")\n\nfunc main() {\n\n\tif ErrNamedType == New("EOF") {\n\t\tfmt.Println("Named Type Error")\n\t}\n\n\tif ErrStructType == errors.New("EOF") {\n\t\tfmt.Println("Struct Type Error")\n\t}\n\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\nè¾åºï¼\n\nNamed Type Error\n\n\n1\n\n\n\n# 2. éè¯¯ç±»å\n\n\n# 2.1 Sentinel Error(é¢å®ä¹éè¯¯)\n\nå¶å®å°±æ¯åé¢å®ä¹ä¸äºå¯ä»¥é¢æä¸­çéè¯¯ï¼å¨ä½¿ç¨è¿ç¨ä¸­ï¼éè¿å¤æ­ error æ¯å±äºåªä¸ç§ error å¹¶è¿è¡å¯¹åºçå¤çã\n\nä¸¾ä¸ªæ å­ï¼å¨ io.EOF å°±æ¯ä¸ä¸ªé¢å®ä¹çéè¯¯ï¼å®æ¯è¡¨ç¤ºè¾å¥æµä¸­çç»å°¾ã\n\nvar EOF = errors.New("EOF")\n\n\n1\n\n\nå¨ä»æµä¸­è¯»åå­ç¬¦çæ¶åï¼ä¼éè¿å¤æ­ error æ¯å¦ç­äº io.EOF æ¥å¤å®æ¯å¦è¯»å®ãæ³¨æè¿éæ¯å¤æ­ error çæéæ¯å¦ç¸ç­ã\n\nn, err := reader.Read(p)  \nif err != nil {  \n   if err == io.EOF {  \n      fmt.Println("The resource is read!")  \n      break  \n   }  \n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nè¿ç§æ¹å¼ä¸å»ºè®®ä½¿ç¨ï¼åå æ¯ï¼\n\n * å®ä¼æä¸ºä½  API çå¬å±é¨å\n\nå ä¸ºå¬å±å½æ°éè¦è¿åä¸ä¸ªåºå®ç errorï¼é£ä¹è¿ä¸ª error å°±å¿é¡»æ¯å¬å¼çï¼é£ä¹å°±éè¦ææ¡£è®°å½ï¼è¿ä¼å¢å  API çè¡¨é¢ç§¯ã\n\n * å¢å è°ç¨èçè¦åæ§\n\nè°ç¨èå¿é¡»è¦ç¥é io.EOF è¿ä¸ª error ï¼å¹¶å¨è°ç¨çå°æ¹ä½¿ç¨è¯¥ error å¤æ­æ¯å¦ç»æã\n\n\n# 2.2 Error types(èªå®ä¹éç±»å)\n\néè¿å®ç° error æ¥å£æ¥åå»ºèªå®ä¹éè¯¯ç±»åãå Sentinel Error ç¸æ¯ï¼æ¯éè¿å¤æ­ç±»åæ¥ç¥éæ¯åªç§éè¯¯ï¼å¹¶ä¸å¯ä»¥è¾åºæ´å¤çä¸ä¸æéè¯¯ä¿¡æ¯ã\n\néè¿èªå®ä¹ MyErrorï¼å¹¶å®ç° error æ¥å£ä¸­ç Error çæ¹æ³ã\n\ntype MyError struct {\n\tMsg  string\n\tFile string\n\tLine int\n}\n\nfunc (e *MyError) Error() string {\n\treturn fmt.Sprintf("%s:%d: %s", e.File, e.Line, e.Msg)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\ntest æ¹æ³ä¸­è¿åçæ¯èªå®ä¹ç errorï¼æä»¬éè¿æ­è¨è½¬æ¢ error æ MyError ç±»åï¼ç¶ååè¾åºæ´å¤çä¸ä¸æä¿¡æ¯ã\n\nfunc test() error {\n\treturn &MyError{"Something happened", "server.go", 42}\n}\n\nfunc main() {\n\terr := test()\n\tswitch err := err.(type) {\n\tcase nil:\n\t\t// success\n\tcase *MyError:\n\t\tfmt.Println("error occured on line:", err.Line)\n\tdefault:\n\t\t// unknown error\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå¨æ ååº os.PathError ä¸­ï¼èªå®ä¹äº PathError ï¼ä¹æ¯ç¸åçç¨æ³ã\n\ntype PathError struct {\n\tOp   string\n\tPath string\n\tErr  error\n}\n\nfunc (e *PathError) Error() string { return e.Op + " " + e.Path + ": " + e.Err.Error() }\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næä»¬ä¹å°½å¯è½é¿åä½¿ç¨ Error typesï¼å ä¸ºå®å Sentinel Erorr ä¸æ ·ä¼åè°ç¨èäº§çè¦åï¼ä¼ä½ä¸º API çä¸é¨åã\n\n\n# 2.3 Opaque errors(ä¸éæçéè¯¯)\n\nError types æ¯éè¿å¤æ­ error çç±»åæ¥èµ°ä¸åçé»è¾ï¼è Opaque errors æ¯éè¿å¤æ­ error çè¡ä¸ºæ¥èµ°ä¸åçé»è¾ã\n\nå¨ net.Error ä¸­å®ä¹å¦ä¸ï¼é¤äºåå« error å¤ï¼è¿åå« Timeout å Temporary æ¹æ³ã\n\ntype Error interface {\n\terror\n\tTimeout() bool \n\tTemporary() bool\n}\n\n\n1\n2\n3\n4\n5\n\n\né¤äºå¤æ­æ¯å¦æ error ä¹å¤ï¼è¿å¯ä»¥éè¿æ¹æ³æ¥å¤æ­æ¯åªç§ç±»åç error ç¶åè¿è¡å¯¹åºçå¤çã\n\nif netErr, ok := err.(net.Error); ok && netErr.Timeout() {\n\treturn false\n}\n\nif netErr, ok := err.(net.Error); ok && netErr.Temporary() {\n\treturn false\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå®ä¸æ¯æ©å± error æ´å¤çä¿¡æ¯ï¼èæ¯æ©å±å¶æ¹æ³ã\n\n\n# 3. ä¼éçå¤çéè¯¯\n\n\n# 3.1 æ éè¯¯çæ­£å¸¸æµç¨ä»£ç \n\næ éè¯¯çæ­£å¸¸æµç¨ä»£ç ï¼å°æä¸ºä¸æ¡ç´çº¿ï¼èä¸æ¯ç¼©è¿çä»£ç ã\n\néè¯¯çåæ³ï¼\n\n// no\nf, err := os.Open(path)\nif err == nil {\n    // do stuff\n}\n\n// handle error\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næ­£ç¡®çåæ³ï¼\n\n// ok\nf, err := os.Open(path)\nif err != nil {\n    // handle error\n}\n\n// do stuff\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 3.2 åå°ä¸å¿è¦çå¤æ­\n\nfunc AuthenticateRequest(r *Request) error {\n    err := authenticate(r.User)\n    err != nil {\n        return err\n    }\n    return nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næ¹ä¸ºï¼\n\nfunc AuthenticateRequest(r *Request) error {\n    return authenticate(r.User)\n}\n\n\n1\n2\n3\n\n\n\n# 3.3 å° error åé¨å­å¨èµ·æ¥\n\nerr å¨åé¨ä¸´æ¶å¨å­ï¼å¨æåå¨è¿ååºæ¥ã\n\nä¸é¢ä¾å­ä¸­ï¼éè¿å¾ªç¯è¯» reader æ¯ä¸è¡çæ°æ®ï¼æ¯æ¬¡å¤æ­ err æ¯ä¸æ¯ nil æ¥å¤æ­æ¯å¦è¯»å®ï¼å¦ææ¯åéåºå¾ªç¯ï¼åè¿åã\n\nfunc CountLines(r io.Reader)  (int, error) {\n\tvar (\n\t\tbr = bufio.NewReader(r)\n\t\tlines int\n\t\terr error\n\t)\n\n\tfor {\n\t\t_, err = br.ReadString(\'\\n\')\n\t\tlines++\n\t\tif err != nil {\n\t\t\tbreak\n\t\t}\n\t}\n\n\tif err != io.EOF {\n\t\treturn 0, err\n\t}\n\n\treturn lines, nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\næ¹è¿çæ¬ï¼\n\ntype Scanner struct {\n\terr          error     // Sticky error.\n\t...\n}\n\nfunc CountLines(r io.Reader)  (int, error) {\n\tsc := bufio.NewScanner(r)\n\tlines := 0\n\n\tfor sc.Scan() {\n\t\tlines++\n\t}\n\n\treturn lines, sc.Err()\n}\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\næ¯æ¬¡å¾ªç¯é½ä¼å¤æ­ Scan çè¿åå¼ï¼å½æ åå®¹è¿åæ¶ï¼åä¼è¿å Falseï¼åç»æå¾ªç¯ï¼å¹¶è¿åç»æãå¾ªç¯ä¸­åºç°ç error ä¼å¨ Scan ä¸­éè¿ s.setErr(err) ä¿å­å¨å¯¹è±¡ç err å±æ§ä¸­ã\n\nä»£ç ææ¾ç®æ´äºè®¸å¤ã\n\n\n# 3.4 å°éå¤æä½æ½ç¦»åºæ¥\n\nççä¸é¢çä»£ç ï¼éé¢å¤æ¬¡ä½¿ç¨ fmt.Fprintf()å¹¶å¤æ­å¶è¿åå¼æ¯å¦ä¸º err\n\ntype Header struct {\n\tKey, Value string\n}\n\ntype Status struct {\n\tCode   int\n\tReason string\n}\n\nfunc WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error {\n\t_, err := fmt.Fprintf(w, "HTTP/1.1 %d %s\\r\\n", st.Code, st.Reason)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, h := range headers {\n\t\t_, err := fmt.Fprintf(w, "%s: %s\\r\\n", h.Key, h.Value)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\n\tif _, err := fmt.Fprintf(w, "\\r\\n"); err != nil {\n\t\treturn err\n\t}\n\n\t_, err = io.Copy(w, body)\n\treturn err\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\næä»¬åå»ºä¸ä¸ª errWrite ç»æä½å¹¶å®ç° Write æ¹æ³ï¼ä¹å°±æ¯å¨åæ¥ç write æ¹æ³ä¸­åäºä¸å±å¹¶åå¥½éè¯¯å¤æ­ï¼ç¶åå¨æ¯ä¸ä¸ª fmt.Fprintf ä½¿ç¨æä»¬å®ä¹ç errWrite è¿è¡åå¥ï¼è¿æ ·å°±è¾¾å°äºå¤ç¨çææï¼ä»£ç ä¹å¥½çäºè®¸å¤ã\n\ntype errWrite struct {\n\tio.Writer\n\terr error\n}\n\nfunc (e *errWrite) Write(buf []byte) (int, error) {\n\tif e.err != nil {\n\t\treturn 0, e.err\n\t}\n\n\tvar n int\n\tn, e.err = e.Writer.Write(buf)\n\treturn n, e.err\n}\n\nfunc WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error {\n\tew := &errWrite{Writer: w}\n\tfmt.Fprintf(ew, "HTTP/1.1 %d %s\\r\\n", st.Code, st.Reason)\n\n\tfor _, h := range headers {\n\t\tfmt.Fprintf(ew, "%s: %s\\r\\n", h.Key, h.Value)\n\t}\n\n\tfmt.Fprintf(w, "\\r\\n")\n\n\tio.Copy(ew, body)\n\treturn ew.err\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n\n\n\n# 4. Wrap erros\n\nå¨æä»¬å¼åä¸­ï¼å¸¸å¸¸ä¼å¨éè¯¯å¤çä¸­ï¼è®°å½äºæ¥å¿ï¼å¹¶ä¸å°éè¯¯ç»è¿åäºã\n\nå¨ os.Open æ¾ä¸å°æä»¶æ¶ä¼è¿å errorï¼å¤ç error æ¶ï¼å° error çä¿¡æ¯æä¸æ¥å¿ï¼å¹¶ä¸å° err è¿è¡è¿åï¼å¨ main å½æ°ä¸­ï¼æ¿å° error ååæ¬¡æä¸ error çæ¥å¿ï¼è¿ä¸ªæ¥å¿åä¸é¢æé¨åæ¯éå¤çæ¥å¿ã\n\nå¨ä»£ç è°ç¨é¾å¤çæ¶åï¼ä¼æä¸æ´å¤çéå¤æ¥å¿ï¼æ¥å¿ä¸­åºç°éå¸¸å¤çåªé³ï¼éå¸¸å½±åææ¥éè¯¯ã\n\nfunc ReadFile(path string) ([]byte, error) {\n\tf, err := os.Open(path)\n\tif err != nil {\n\t\tlog.Printf("could not open file: %v", err)\n\t\treturn nil, err\n\t}\n\tdefer f.Close()\n\n\tread := bufio.NewReader(f)\n\n\tline, _, err := read.ReadLine()\n\treturn line, err\n}\n\nfunc main() {\n\t_, err := ReadFile("test.txt")\n\tif err != nil {\n\t\tfmt.Println(err)\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡è¾åºï¼\n\n2022/11/05 17:03:16 could not open file: open test.txt: The system cannot find t\nhe file specified.\n2022/11/05 17:03:16 open test.txt: The system cannot find the file specified.\n\n\n1\n2\n3\n\n\nå¯ä»¥ä½¿ç¨ fmt.Errorf æ¥å¯¹åå§éè¯¯è¿è¡åè£ï¼é¤äºåå§éè¯¯ä¿¡æ¯ä¹å¤ï¼å¨æ·»å é¢å¤å¾ä¿¡æ¯å¹¶è¿åã\n\nf, err := os.Open(path)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf("open file failed: %w", err)\n\t}\n\n\n1\n2\n3\n4\n\n\nè¾åºï¼\n\n2022/11/05 17:04:43 open file failed: open test.txt: The system cannot find the\nfile specified.\n\n\n1\n2\n\n\nfmt.Errorf è¿åçæ¯ä¸ä¸ªæ°çè¢«åè£ç errorï¼errors.Is å¯ä»¥ä¸å±ä¸å±çå¥å¼åè£æ¥å¤æ­æ¯å¦ä¸ºåå§éè¯¯ï¼ä½æ¯å®æ¯åæéå¤æ­çï¼è¿é os.Open è¿åçåå§éè¯¯æ¯ os.PathError ä½æ¯å ä¸ºè¿åçæ¯å°åï¼æä»¥æ æ³ç¨ errors.Is å¤æ­ã\n\nfunc main() {\n\n\t_, err := ReadFile("test.txt")\n\tvar pathError *os.PathError\n\n\tif errors.Is(err, pathError) {\n\t\tfmt.Println("is PathError")\n\t} else {\n\t\tfmt.Println("no PathError")\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¾åºï¼\n\nno PathError\n\n\n1\n\n\nè¿éå¯ä»¥ç¨ errors.As æ¥å¤æ­ err æ¯å¦ä¸º os.PathError ç±»åï¼å³ä½¿ err æ¯å°åã\n\nè¿éå¤æ­äºæ¯å¦ä¸º os.PathError éè¯¯ï¼å¹¶ä¸å°è¿åç err è½¬æ¢æäºè¯¥éè¯¯ï¼æä»¬å¯ä»¥è°ç¨å¶ä¸­çå±æ§æ¥è·åæ´å¤çä¿¡æ¯ã\n\nfunc main() {\n\n\t_, err := ReadFile("test.txt")\n\tvar pathError *os.PathError\n\n\tif errors.As(err, &pathError) {\n\t\tfmt.Println(pathError.Path)\n\t}\n\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¾åºï¼\n\ntest.txt\n\n\n1\n\n\nè¿å¯ä»¥éè¿ errors.UnWrap æ¥è·ååºå±éè¯¯ï¼å°åå§éè¯¯ç»è§£æåºæ¥ã\n\nfunc main() {\n\t_, err := ReadFile("test.txt")\n\terr = errors.Unwrap(err)\n\tfmt.Printf("ori err: %v", err)\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# 5. pkg/errors\n\nä¸é¢ä»ç»çé½æ¯åçç errors å¤çæ¨¡åï¼ç°å¨ä»ç» pkg/errors æ¨¡åï¼å®å¨å¼å®¹åç errorsï¼å¹¶ä¸å¯¹å¶è¿è¡å¢å¼ºï¼ä¸»è¦æ¯æ·»å äºä¿å­å æ çè½åã\n\nå¯ä»¥ä½¿ç¨ errors.Wrap è¿è¡å¯¹ error çåè£ï¼å¹¶æ·»å é¢å¤çä¿¡æ¯ã\n\nfunc ReadFile(path string) ([]byte, error) {\n\tf, err := os.Open(path)\n\tif err != nil {\n\t\treturn nil, errors.Wrap(err, "could not open file")\n\t}\n\tdefer f.Close()\n\n\tread := bufio.NewReader(f)\n\n\tline, _, err := read.ReadLine()\n\treturn line, err\n}\n\nfunc main() {\n\t_, err := ReadFile("test.txt")\n\tif err != nil {\n\t\tfmt.Println(err)\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nè¾åºï¼\n\ncould not open file: open test.txt: The system cannot find the file specified.\n\n\n1\n\n\nä½å®è¿æä¸ä¸ªæ´å¼ºçåè½æ¯ä¼ä¿å­å½åçå æ ä¿¡æ¯ï¼ä½¿ç¨%+v å¯ä»¥æå°åºæ¥ã\n\nfunc main() {\n\t_, err := ReadFile("test.txt")\n\tif err != nil {\n\t\tfmt.Printf("stack track: \\n%+v", err)\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nè¾åºï¼\n\nstack track:\nopen test.txt: The system cannot find the file specified.\ncould not open file\nmain.ReadFile\n        D:/code/go_demo/main3.go:13\nmain.main\n        D:/code/go_demo/main3.go:24\nruntime.main\n        D:/install/go18.3/src/runtime/proc.go:250\nruntime.goexit\n        D:/install/go18.3/src/runtime/asm_amd64.s:1571\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå¦æä¸æ³ä¿å­å æ ä¿¡æ¯ï¼åªæ·»å é¢å¤çä¿¡æ¯ï¼å¯ä»¥ä½¿ç¨ errors.WithMessage æ·»å ã\n\n\tf, err := os.Open(path)\n\tif err != nil {\n\t\treturn nil, errors.WithMessage(err, "could not open file")\n\t}\n\n\n1\n2\n3\n4\n\n\nè¾åºï¼\n\ncould not open file: open test.txt: The system cannot find the file specified.\n\n\n1\n\n\nè¿æå ä¸ªå¸¸è§çæ¹æ³\n\n// çæéè¯¯çåæ¶å¸¦ä¸å æ ä¿¡æ¯\nfunc New(message string) error\n\n// åªéå è°ç¨å æ ä¿¡æ¯\nfunc WithStack(err error) error\n\n// è·å¾ææ ¹æ¬çéè¯¯åå \nfunc Cause(err error) error\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 6. error çæä½³å®è·µ\n\nå¤ç error çæ¹å¼è¿ä¹å¤ï¼æä»¬è¯¥å¦ä½æä¼çä½¿ç¨å®ä»¬å¢ï¼æä»¥ä¸å ä¸ªæ¹æ³ï¼\n\n * å¨èªå·±çåºç¨ä»£ç ä¸­ï¼ä½¿ç¨ errors.New æè errors.Errorf æ¥è¿åéè¯¯\n\nfunc parseArgs(args []string) error {\n\tif len(args) < 3 {\n\t\treturn errors.Errorf("not enough arguments")\n\t}\n\n\treturn nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n * å¦æè°ç¨å¶ä»ååçå½æ°ï¼éå¸¸ç®åçç´æ¥è¿åã\n\nif err != nil {\n\treturn err\n}\n\n\n1\n2\n3\n\n * å¦æåå¶ä»åºè¿è¡åä½ï¼èèä½¿ç¨ errors.Wrap æè errors.Wrapf ä¿å­å æ ä¿¡æ¯ãåæ ·éç¨äºåæ ååºåä½çæ¶åã\n\nf, err := os.Open(path)\nif err != nil {\n\treturn errors.Wrapf(err, "failed to open %q", path)\n\n\n1\n2\n3\n\n\n * ç´æ¥è¿åéè¯¯ï¼èä¸æ¯æ¯ä¸ªéè¯¯äº§ççå°æ¹å°å¤ææ¥å¿ã\n\n * å¨ç¨åºçé¡¶é¨æèæ¯å·¥ä½ç goroutine é¡¶é¨ï¼è¯·æ±å¥å£ï¼ï¼ä½¿ç¨ %+v æå æ è¯¦æè®°å½ã\n\nfunc main() {\n\terr := app.Run()\n\tif err != nil {\n\t\tfmt.Printf("FATAL: %+V\\n", err)\n\t\tos.Exit(1)\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n * ä½¿ç¨ errors.Cause è·å root errorï¼åè¿è¡å sentinel error å¤å®ã\n\n\n# åèèµæ\n\n * io.EOF è®¾è®¡çç¼ºé·',normalizedContent:'# 0. åè¨\n\ngo ä¸­çå¼å¸¸å¤çåå¶ä»è¯­è¨å¤§ä¸ç¸åï¼å javaãc++ãpython ç­è¯­è¨é½æ¯éè¿æåº exception æ¥å¤çå¼å¸¸ï¼è go æ¯éè¿è¿å error æ¥å¤å®å¼å¸¸ï¼å¹¶è¿è¡å¤çã\n\nå¨ go ä¸­æ panic çæºå¶ï¼ä½ panic æå³çç¨åºç»æ­¢ï¼ä»£ç ä¸è½ç»§ç»­è¿è¡äºï¼ä¸è½ææè°ç¨èæ¥è§£å³å®ãè error æ¯é¢æä¸­çå¼å¸¸ï¼å¸æè°ç¨èå¯ä»¥å¯¹å¶è¿è¡å¤ççã\n\n\n# 1. error æ¯ä»ä¹ï¼\n\nä¸¾ä¸ªä¾å­ï¼ä½¿ç¨ open æ¥æå¼æä»¶ï¼ä½æ¯å¯è½è¯¥è·¯å¾çæä»¶ä¸å­å¨ï¼åºç°å¼å¸¸ï¼å¨ go æ¯éè¿å¤æ­ err æ¯å¦ä¸º nil æ¥å¤å®æå¼æä»¶æ¯å¦æåã\n\nf, err := os.open(path)\nif err != nil {\n    // handle error\n}\n\n// do stuff\n\n\n1\n2\n3\n4\n5\n6\n\n\né®é¢æ¥äºï¼error æ¯ä»ä¹ï¼\n\næ¥çæºç ä¼åç°ï¼error æ¯ä¸ä¸ªåå« error æ¹æ³çæ¥å£ï¼è¿åçæ¯å®ç°äºè¯¥æ¥å£çå¯¹è±¡ã\n\ntype error interface {  \n   error() string  \n}\n\n\n1\n2\n3\n\n\næä»¬ä¸è¬ä½¿ç¨æ¯éè¿ errors.new()æ¥è¿åä¸ä¸ªå®ç°äº error æ¥å£çå¯¹è±¡ãè¿ä¸ªå¯¹è±¡æ¯ä¸ä¸ªåå«äºå­ç¬¦ä¸²çç»æä½ï¼ç¶åå¯ä»¥éè¿ error æ¹æ³æ¥è·åå­ç¬¦ä¸²ã\n\nfunc new(text string) error {  \n   return &errorstring{text}  \n}  \n  \n// errorstring is a trivial implementation of error.\ntype errorstring struct {  \n   s string  \n}  \n  \nfunc (e *errorstring) error() string {  \n   return e.s  \n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\næä»¬å¯ä»¥æ³¨æå° new æ¹æ³è¿åçæ¯ errorstring çå°åï¼ä¹å°±æ¯è¯´ï¼å¨æä»¬å°ä¸¤ä¸ª error æ¯è¾ç¸ç­æ¶ï¼æ¯è¾æ¯å°åï¼æ¯ä¸¤ä¸ª error æ¯å¦ä¸ºåä¸ä¸ªå¯¹è±¡ï¼èä¸æ¯å¶ä¸­çéè¯¯å­ç¬¦ä¸²ã\n\nimport (\n\t"errors"\n\t"fmt"\n)\n\ntype errorstring string\n\nfunc (e errorstring) error() string {\n\treturn string(e)\n}\n\nfunc new(text string) error {\n\treturn errorstring(text)\n}\n\nvar errnamedtype = new("eof")\nvar errstructtype = errors.new("eof")\n\nfunc main() {\n\n\tif errnamedtype == new("eof") {\n\t\tfmt.println("named type error")\n\t}\n\n\tif errstructtype == errors.new("eof") {\n\t\tfmt.println("struct type error")\n\t}\n\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\nè¾åºï¼\n\nnamed type error\n\n\n1\n\n\n\n# 2. éè¯¯ç±»å\n\n\n# 2.1 sentinel error(é¢å®ä¹éè¯¯)\n\nå¶å®å°±æ¯åé¢å®ä¹ä¸äºå¯ä»¥é¢æä¸­çéè¯¯ï¼å¨ä½¿ç¨è¿ç¨ä¸­ï¼éè¿å¤æ­ error æ¯å±äºåªä¸ç§ error å¹¶è¿è¡å¯¹åºçå¤çã\n\nä¸¾ä¸ªæ å­ï¼å¨ io.eof å°±æ¯ä¸ä¸ªé¢å®ä¹çéè¯¯ï¼å®æ¯è¡¨ç¤ºè¾å¥æµä¸­çç»å°¾ã\n\nvar eof = errors.new("eof")\n\n\n1\n\n\nå¨ä»æµä¸­è¯»åå­ç¬¦çæ¶åï¼ä¼éè¿å¤æ­ error æ¯å¦ç­äº io.eof æ¥å¤å®æ¯å¦è¯»å®ãæ³¨æè¿éæ¯å¤æ­ error çæéæ¯å¦ç¸ç­ã\n\nn, err := reader.read(p)  \nif err != nil {  \n   if err == io.eof {  \n      fmt.println("the resource is read!")  \n      break  \n   }  \n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nè¿ç§æ¹å¼ä¸å»ºè®®ä½¿ç¨ï¼åå æ¯ï¼\n\n * å®ä¼æä¸ºä½  api çå¬å±é¨å\n\nå ä¸ºå¬å±å½æ°éè¦è¿åä¸ä¸ªåºå®ç errorï¼é£ä¹è¿ä¸ª error å°±å¿é¡»æ¯å¬å¼çï¼é£ä¹å°±éè¦ææ¡£è®°å½ï¼è¿ä¼å¢å  api çè¡¨é¢ç§¯ã\n\n * å¢å è°ç¨èçè¦åæ§\n\nè°ç¨èå¿é¡»è¦ç¥é io.eof è¿ä¸ª error ï¼å¹¶å¨è°ç¨çå°æ¹ä½¿ç¨è¯¥ error å¤æ­æ¯å¦ç»æã\n\n\n# 2.2 error types(èªå®ä¹éç±»å)\n\néè¿å®ç° error æ¥å£æ¥åå»ºèªå®ä¹éè¯¯ç±»åãå sentinel error ç¸æ¯ï¼æ¯éè¿å¤æ­ç±»åæ¥ç¥éæ¯åªç§éè¯¯ï¼å¹¶ä¸å¯ä»¥è¾åºæ´å¤çä¸ä¸æéè¯¯ä¿¡æ¯ã\n\néè¿èªå®ä¹ myerrorï¼å¹¶å®ç° error æ¥å£ä¸­ç error çæ¹æ³ã\n\ntype myerror struct {\n\tmsg  string\n\tfile string\n\tline int\n}\n\nfunc (e *myerror) error() string {\n\treturn fmt.sprintf("%s:%d: %s", e.file, e.line, e.msg)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\ntest æ¹æ³ä¸­è¿åçæ¯èªå®ä¹ç errorï¼æä»¬éè¿æ­è¨è½¬æ¢ error æ myerror ç±»åï¼ç¶ååè¾åºæ´å¤çä¸ä¸æä¿¡æ¯ã\n\nfunc test() error {\n\treturn &myerror{"something happened", "server.go", 42}\n}\n\nfunc main() {\n\terr := test()\n\tswitch err := err.(type) {\n\tcase nil:\n\t\t// success\n\tcase *myerror:\n\t\tfmt.println("error occured on line:", err.line)\n\tdefault:\n\t\t// unknown error\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå¨æ ååº os.patherror ä¸­ï¼èªå®ä¹äº patherror ï¼ä¹æ¯ç¸åçç¨æ³ã\n\ntype patherror struct {\n\top   string\n\tpath string\n\terr  error\n}\n\nfunc (e *patherror) error() string { return e.op + " " + e.path + ": " + e.err.error() }\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næä»¬ä¹å°½å¯è½é¿åä½¿ç¨ error typesï¼å ä¸ºå®å sentinel erorr ä¸æ ·ä¼åè°ç¨èäº§çè¦åï¼ä¼ä½ä¸º api çä¸é¨åã\n\n\n# 2.3 opaque errors(ä¸éæçéè¯¯)\n\nerror types æ¯éè¿å¤æ­ error çç±»åæ¥èµ°ä¸åçé»è¾ï¼è opaque errors æ¯éè¿å¤æ­ error çè¡ä¸ºæ¥èµ°ä¸åçé»è¾ã\n\nå¨ net.error ä¸­å®ä¹å¦ä¸ï¼é¤äºåå« error å¤ï¼è¿åå« timeout å temporary æ¹æ³ã\n\ntype error interface {\n\terror\n\ttimeout() bool \n\ttemporary() bool\n}\n\n\n1\n2\n3\n4\n5\n\n\né¤äºå¤æ­æ¯å¦æ error ä¹å¤ï¼è¿å¯ä»¥éè¿æ¹æ³æ¥å¤æ­æ¯åªç§ç±»åç error ç¶åè¿è¡å¯¹åºçå¤çã\n\nif neterr, ok := err.(net.error); ok && neterr.timeout() {\n\treturn false\n}\n\nif neterr, ok := err.(net.error); ok && neterr.temporary() {\n\treturn false\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå®ä¸æ¯æ©å± error æ´å¤çä¿¡æ¯ï¼èæ¯æ©å±å¶æ¹æ³ã\n\n\n# 3. ä¼éçå¤çéè¯¯\n\n\n# 3.1 æ éè¯¯çæ­£å¸¸æµç¨ä»£ç \n\næ éè¯¯çæ­£å¸¸æµç¨ä»£ç ï¼å°æä¸ºä¸æ¡ç´çº¿ï¼èä¸æ¯ç¼©è¿çä»£ç ã\n\néè¯¯çåæ³ï¼\n\n// no\nf, err := os.open(path)\nif err == nil {\n    // do stuff\n}\n\n// handle error\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næ­£ç¡®çåæ³ï¼\n\n// ok\nf, err := os.open(path)\nif err != nil {\n    // handle error\n}\n\n// do stuff\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 3.2 åå°ä¸å¿è¦çå¤æ­\n\nfunc authenticaterequest(r *request) error {\n    err := authenticate(r.user)\n    err != nil {\n        return err\n    }\n    return nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\næ¹ä¸ºï¼\n\nfunc authenticaterequest(r *request) error {\n    return authenticate(r.user)\n}\n\n\n1\n2\n3\n\n\n\n# 3.3 å° error åé¨å­å¨èµ·æ¥\n\nerr å¨åé¨ä¸´æ¶å¨å­ï¼å¨æåå¨è¿ååºæ¥ã\n\nä¸é¢ä¾å­ä¸­ï¼éè¿å¾ªç¯è¯» reader æ¯ä¸è¡çæ°æ®ï¼æ¯æ¬¡å¤æ­ err æ¯ä¸æ¯ nil æ¥å¤æ­æ¯å¦è¯»å®ï¼å¦ææ¯åéåºå¾ªç¯ï¼åè¿åã\n\nfunc countlines(r io.reader)  (int, error) {\n\tvar (\n\t\tbr = bufio.newreader(r)\n\t\tlines int\n\t\terr error\n\t)\n\n\tfor {\n\t\t_, err = br.readstring(\'\\n\')\n\t\tlines++\n\t\tif err != nil {\n\t\t\tbreak\n\t\t}\n\t}\n\n\tif err != io.eof {\n\t\treturn 0, err\n\t}\n\n\treturn lines, nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\næ¹è¿çæ¬ï¼\n\ntype scanner struct {\n\terr          error     // sticky error.\n\t...\n}\n\nfunc countlines(r io.reader)  (int, error) {\n\tsc := bufio.newscanner(r)\n\tlines := 0\n\n\tfor sc.scan() {\n\t\tlines++\n\t}\n\n\treturn lines, sc.err()\n}\n\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\næ¯æ¬¡å¾ªç¯é½ä¼å¤æ­ scan çè¿åå¼ï¼å½æ åå®¹è¿åæ¶ï¼åä¼è¿å falseï¼åç»æå¾ªç¯ï¼å¹¶è¿åç»æãå¾ªç¯ä¸­åºç°ç error ä¼å¨ scan ä¸­éè¿ s.seterr(err) ä¿å­å¨å¯¹è±¡ç err å±æ§ä¸­ã\n\nä»£ç ææ¾ç®æ´äºè®¸å¤ã\n\n\n# 3.4 å°éå¤æä½æ½ç¦»åºæ¥\n\nççä¸é¢çä»£ç ï¼éé¢å¤æ¬¡ä½¿ç¨ fmt.fprintf()å¹¶å¤æ­å¶è¿åå¼æ¯å¦ä¸º err\n\ntype header struct {\n\tkey, value string\n}\n\ntype status struct {\n\tcode   int\n\treason string\n}\n\nfunc writeresponse(w io.writer, st status, headers []header, body io.reader) error {\n\t_, err := fmt.fprintf(w, "http/1.1 %d %s\\r\\n", st.code, st.reason)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, h := range headers {\n\t\t_, err := fmt.fprintf(w, "%s: %s\\r\\n", h.key, h.value)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\n\tif _, err := fmt.fprintf(w, "\\r\\n"); err != nil {\n\t\treturn err\n\t}\n\n\t_, err = io.copy(w, body)\n\treturn err\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n\n\næä»¬åå»ºä¸ä¸ª errwrite ç»æä½å¹¶å®ç° write æ¹æ³ï¼ä¹å°±æ¯å¨åæ¥ç write æ¹æ³ä¸­åäºä¸å±å¹¶åå¥½éè¯¯å¤æ­ï¼ç¶åå¨æ¯ä¸ä¸ª fmt.fprintf ä½¿ç¨æä»¬å®ä¹ç errwrite è¿è¡åå¥ï¼è¿æ ·å°±è¾¾å°äºå¤ç¨çææï¼ä»£ç ä¹å¥½çäºè®¸å¤ã\n\ntype errwrite struct {\n\tio.writer\n\terr error\n}\n\nfunc (e *errwrite) write(buf []byte) (int, error) {\n\tif e.err != nil {\n\t\treturn 0, e.err\n\t}\n\n\tvar n int\n\tn, e.err = e.writer.write(buf)\n\treturn n, e.err\n}\n\nfunc writeresponse(w io.writer, st status, headers []header, body io.reader) error {\n\tew := &errwrite{writer: w}\n\tfmt.fprintf(ew, "http/1.1 %d %s\\r\\n", st.code, st.reason)\n\n\tfor _, h := range headers {\n\t\tfmt.fprintf(ew, "%s: %s\\r\\n", h.key, h.value)\n\t}\n\n\tfmt.fprintf(w, "\\r\\n")\n\n\tio.copy(ew, body)\n\treturn ew.err\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n\n\n\n# 4. wrap erros\n\nå¨æä»¬å¼åä¸­ï¼å¸¸å¸¸ä¼å¨éè¯¯å¤çä¸­ï¼è®°å½äºæ¥å¿ï¼å¹¶ä¸å°éè¯¯ç»è¿åäºã\n\nå¨ os.open æ¾ä¸å°æä»¶æ¶ä¼è¿å errorï¼å¤ç error æ¶ï¼å° error çä¿¡æ¯æä¸æ¥å¿ï¼å¹¶ä¸å° err è¿è¡è¿åï¼å¨ main å½æ°ä¸­ï¼æ¿å° error ååæ¬¡æä¸ error çæ¥å¿ï¼è¿ä¸ªæ¥å¿åä¸é¢æé¨åæ¯éå¤çæ¥å¿ã\n\nå¨ä»£ç è°ç¨é¾å¤çæ¶åï¼ä¼æä¸æ´å¤çéå¤æ¥å¿ï¼æ¥å¿ä¸­åºç°éå¸¸å¤çåªé³ï¼éå¸¸å½±åææ¥éè¯¯ã\n\nfunc readfile(path string) ([]byte, error) {\n\tf, err := os.open(path)\n\tif err != nil {\n\t\tlog.printf("could not open file: %v", err)\n\t\treturn nil, err\n\t}\n\tdefer f.close()\n\n\tread := bufio.newreader(f)\n\n\tline, _, err := read.readline()\n\treturn line, err\n}\n\nfunc main() {\n\t_, err := readfile("test.txt")\n\tif err != nil {\n\t\tfmt.println(err)\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡è¾åºï¼\n\n2022/11/05 17:03:16 could not open file: open test.txt: the system cannot find t\nhe file specified.\n2022/11/05 17:03:16 open test.txt: the system cannot find the file specified.\n\n\n1\n2\n3\n\n\nå¯ä»¥ä½¿ç¨ fmt.errorf æ¥å¯¹åå§éè¯¯è¿è¡åè£ï¼é¤äºåå§éè¯¯ä¿¡æ¯ä¹å¤ï¼å¨æ·»å é¢å¤å¾ä¿¡æ¯å¹¶è¿åã\n\nf, err := os.open(path)\n\tif err != nil {\n\t\treturn nil, fmt.errorf("open file failed: %w", err)\n\t}\n\n\n1\n2\n3\n4\n\n\nè¾åºï¼\n\n2022/11/05 17:04:43 open file failed: open test.txt: the system cannot find the\nfile specified.\n\n\n1\n2\n\n\nfmt.errorf è¿åçæ¯ä¸ä¸ªæ°çè¢«åè£ç errorï¼errors.is å¯ä»¥ä¸å±ä¸å±çå¥å¼åè£æ¥å¤æ­æ¯å¦ä¸ºåå§éè¯¯ï¼ä½æ¯å®æ¯åæéå¤æ­çï¼è¿é os.open è¿åçåå§éè¯¯æ¯ os.patherror ä½æ¯å ä¸ºè¿åçæ¯å°åï¼æä»¥æ æ³ç¨ errors.is å¤æ­ã\n\nfunc main() {\n\n\t_, err := readfile("test.txt")\n\tvar patherror *os.patherror\n\n\tif errors.is(err, patherror) {\n\t\tfmt.println("is patherror")\n\t} else {\n\t\tfmt.println("no patherror")\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¾åºï¼\n\nno patherror\n\n\n1\n\n\nè¿éå¯ä»¥ç¨ errors.as æ¥å¤æ­ err æ¯å¦ä¸º os.patherror ç±»åï¼å³ä½¿ err æ¯å°åã\n\nè¿éå¤æ­äºæ¯å¦ä¸º os.patherror éè¯¯ï¼å¹¶ä¸å°è¿åç err è½¬æ¢æäºè¯¥éè¯¯ï¼æä»¬å¯ä»¥è°ç¨å¶ä¸­çå±æ§æ¥è·åæ´å¤çä¿¡æ¯ã\n\nfunc main() {\n\n\t_, err := readfile("test.txt")\n\tvar patherror *os.patherror\n\n\tif errors.as(err, &patherror) {\n\t\tfmt.println(patherror.path)\n\t}\n\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nè¾åºï¼\n\ntest.txt\n\n\n1\n\n\nè¿å¯ä»¥éè¿ errors.unwrap æ¥è·ååºå±éè¯¯ï¼å°åå§éè¯¯ç»è§£æåºæ¥ã\n\nfunc main() {\n\t_, err := readfile("test.txt")\n\terr = errors.unwrap(err)\n\tfmt.printf("ori err: %v", err)\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# 5. pkg/errors\n\nä¸é¢ä»ç»çé½æ¯åçç errors å¤çæ¨¡åï¼ç°å¨ä»ç» pkg/errors æ¨¡åï¼å®å¨å¼å®¹åç errorsï¼å¹¶ä¸å¯¹å¶è¿è¡å¢å¼ºï¼ä¸»è¦æ¯æ·»å äºä¿å­å æ çè½åã\n\nå¯ä»¥ä½¿ç¨ errors.wrap è¿è¡å¯¹ error çåè£ï¼å¹¶æ·»å é¢å¤çä¿¡æ¯ã\n\nfunc readfile(path string) ([]byte, error) {\n\tf, err := os.open(path)\n\tif err != nil {\n\t\treturn nil, errors.wrap(err, "could not open file")\n\t}\n\tdefer f.close()\n\n\tread := bufio.newreader(f)\n\n\tline, _, err := read.readline()\n\treturn line, err\n}\n\nfunc main() {\n\t_, err := readfile("test.txt")\n\tif err != nil {\n\t\tfmt.println(err)\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nè¾åºï¼\n\ncould not open file: open test.txt: the system cannot find the file specified.\n\n\n1\n\n\nä½å®è¿æä¸ä¸ªæ´å¼ºçåè½æ¯ä¼ä¿å­å½åçå æ ä¿¡æ¯ï¼ä½¿ç¨%+v å¯ä»¥æå°åºæ¥ã\n\nfunc main() {\n\t_, err := readfile("test.txt")\n\tif err != nil {\n\t\tfmt.printf("stack track: \\n%+v", err)\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n\n\nè¾åºï¼\n\nstack track:\nopen test.txt: the system cannot find the file specified.\ncould not open file\nmain.readfile\n        d:/code/go_demo/main3.go:13\nmain.main\n        d:/code/go_demo/main3.go:24\nruntime.main\n        d:/install/go18.3/src/runtime/proc.go:250\nruntime.goexit\n        d:/install/go18.3/src/runtime/asm_amd64.s:1571\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå¦æä¸æ³ä¿å­å æ ä¿¡æ¯ï¼åªæ·»å é¢å¤çä¿¡æ¯ï¼å¯ä»¥ä½¿ç¨ errors.withmessage æ·»å ã\n\n\tf, err := os.open(path)\n\tif err != nil {\n\t\treturn nil, errors.withmessage(err, "could not open file")\n\t}\n\n\n1\n2\n3\n4\n\n\nè¾åºï¼\n\ncould not open file: open test.txt: the system cannot find the file specified.\n\n\n1\n\n\nè¿æå ä¸ªå¸¸è§çæ¹æ³\n\n// çæéè¯¯çåæ¶å¸¦ä¸å æ ä¿¡æ¯\nfunc new(message string) error\n\n// åªéå è°ç¨å æ ä¿¡æ¯\nfunc withstack(err error) error\n\n// è·å¾ææ ¹æ¬çéè¯¯åå \nfunc cause(err error) error\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 6. error çæä½³å®è·µ\n\nå¤ç error çæ¹å¼è¿ä¹å¤ï¼æä»¬è¯¥å¦ä½æä¼çä½¿ç¨å®ä»¬å¢ï¼æä»¥ä¸å ä¸ªæ¹æ³ï¼\n\n * å¨èªå·±çåºç¨ä»£ç ä¸­ï¼ä½¿ç¨ errors.new æè errors.errorf æ¥è¿åéè¯¯\n\nfunc parseargs(args []string) error {\n\tif len(args) < 3 {\n\t\treturn errors.errorf("not enough arguments")\n\t}\n\n\treturn nil\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n * å¦æè°ç¨å¶ä»ååçå½æ°ï¼éå¸¸ç®åçç´æ¥è¿åã\n\nif err != nil {\n\treturn err\n}\n\n\n1\n2\n3\n\n * å¦æåå¶ä»åºè¿è¡åä½ï¼èèä½¿ç¨ errors.wrap æè errors.wrapf ä¿å­å æ ä¿¡æ¯ãåæ ·éç¨äºåæ ååºåä½çæ¶åã\n\nf, err := os.open(path)\nif err != nil {\n\treturn errors.wrapf(err, "failed to open %q", path)\n\n\n1\n2\n3\n\n\n * ç´æ¥è¿åéè¯¯ï¼èä¸æ¯æ¯ä¸ªéè¯¯äº§ççå°æ¹å°å¤ææ¥å¿ã\n\n * å¨ç¨åºçé¡¶é¨æèæ¯å·¥ä½ç goroutine é¡¶é¨ï¼è¯·æ±å¥å£ï¼ï¼ä½¿ç¨ %+v æå æ è¯¦æè®°å½ã\n\nfunc main() {\n\terr := app.run()\n\tif err != nil {\n\t\tfmt.printf("fatal: %+v\\n", err)\n\t\tos.exit(1)\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n * ä½¿ç¨ errors.cause è·å root errorï¼åè¿è¡å sentinel error å¤å®ã\n\n\n# åèèµæ\n\n * io.eof è®¾è®¡çç¼ºé·',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±",frontmatter:{title:"tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±",date:"2023-11-09T15:49:47.000Z",permalink:"/pages/36b0b2/",tags:["goè¯­è¨","logstash","ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"logstashä»æ°æ®æºæåæ¥å¿ï¼ç¶åéè¿tcpæä»¶åéå°proxyè¿ç¨ä¸­ãå¨ä¸å¡ä¾§åç°æ¥å¿éææ¾å°äºï¼æä»¥æäºè¿ä¸æ¬¡çé®é¢ææ¥ã",comment:!0,categories:["ç¼ç¨","goè¯­è¨"],feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20231109171607.png"},{name:"twitter:title",content:"tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±"},{name:"twitter:description",content:"logstashä»æ°æ®æºæåæ¥å¿ï¼ç¶åéè¿tcpæä»¶åéå°proxyè¿ç¨ä¸­ãå¨ä¸å¡ä¾§åç°æ¥å¿éææ¾å°äºï¼æä»¥æäºè¿ä¸æ¬¡çé®é¢ææ¥ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20231109171607.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/05.tcp%E7%BC%93%E5%AD%98%E5%BC%95%E8%B5%B7%E7%9A%84%E6%97%A5%E5%BF%97%E4%B8%A2%E5%A4%B1.html"},{property:"og:type",content:"article"},{property:"og:title",content:"tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±"},{property:"og:description",content:"logstashä»æ°æ®æºæåæ¥å¿ï¼ç¶åéè¿tcpæä»¶åéå°proxyè¿ç¨ä¸­ãå¨ä¸å¡ä¾§åç°æ¥å¿éææ¾å°äºï¼æä»¥æäºè¿ä¸æ¬¡çé®é¢ææ¥ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20231109171607.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/05.tcp%E7%BC%93%E5%AD%98%E5%BC%95%E8%B5%B7%E7%9A%84%E6%97%A5%E5%BF%97%E4%B8%A2%E5%A4%B1.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-11-09T15:49:47.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"logstash"},{property:"article:tag",content:"ç¼ç¨"},{itemprop:"name",content:"tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±"},{itemprop:"description",content:"logstashä»æ°æ®æºæåæ¥å¿ï¼ç¶åéè¿tcpæä»¶åéå°proxyè¿ç¨ä¸­ãå¨ä¸å¡ä¾§åç°æ¥å¿éææ¾å°äºï¼æä»¥æäºè¿ä¸æ¬¡çé®é¢ææ¥ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20231109171607.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/05.tcp%E7%BC%93%E5%AD%98%E5%BC%95%E8%B5%B7%E7%9A%84%E6%97%A5%E5%BF%97%E4%B8%A2%E5%A4%B1.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/05.tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±.md",key:"v-2f3e170c",path:"/pages/36b0b2/",headers:[{level:2,title:"èæ¯",slug:"èæ¯",normalizedTitle:"èæ¯",charIndex:2},{level:2,title:"é®é¢ææ¥å®ä½",slug:"é®é¢ææ¥å®ä½",normalizedTitle:"é®é¢ææ¥å®ä½",charIndex:78},{level:2,title:"ä»£ç ææ¥",slug:"ä»£ç ææ¥",normalizedTitle:"ä»£ç ææ¥",charIndex:1167},{level:2,title:"è§£å³æ¹æ³",slug:"è§£å³æ¹æ³",normalizedTitle:"è§£å³æ¹æ³",charIndex:2432},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:2749}],headersStr:"èæ¯ é®é¢ææ¥å®ä½ ä»£ç ææ¥ è§£å³æ¹æ³ æ»ç»",content:'# èæ¯\n\nlogstashä»æ°æ®æºæåæ¥å¿ï¼ç¶åéè¿tcpæä»¶åéå°proxyè¿ç¨ä¸­ãå¨ä¸å¡ä¾§åç°æ¥å¿éææ¾å°äºï¼æä»¥æäºè¿ä¸æ¬¡çé®é¢ææ¥ã\n\n\n\n\n# é®é¢ææ¥å®ä½\n\né¦åä»logstashä¾§å¼å§æ£æ¥ãæä»¬åçlogstashçæ¥å¿ï¼æ²¡æææ¾çæ¥éä¿¡æ¯ã\n\nç¶ååæ¥çlogstashç®¡éçç¶æãå¯ä»¥å¾ææ¾ççå°ï¼å¨outputç®¡éä¸­ï¼inè¿è¿å¤§äºoutï¼ä¹å°±æ¯logstashæåçæ¥å¿å·²ç»å°äºoutputç®¡éï¼ä½æ¯æ æ³è¾åºåºå»ï¼å¹¶ä¸duration_in_millisæ¶é´å¾é¿ï¼è¿ä¸ªä»£è¡¨çååºå»çéçå¾æ¢ï¼è¿æ¯ä»ä¹åå å¢ï¼\n\ncurl -XGET \'localhost:9600/_node/stats/pipelines/azure_event_hubs?pretty\'\n\n{\n    ...\n"outputs" : [ {\n        "id" : "99b12e190d297be5d6113d04cf10089a3dccbaef7eed0cc41515e8e5af5f4595",\n        "name" : "tcp",\n        "events" : {\n        "in" : 341,\n        "out" : 69,\n        "duration_in_millis" : 519709\n        }\n    } \n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¦ä¹æ¯åéæ¹çåå ï¼è¦ä¹æ¯æ¥æ¶æ¹çåå ãæåä»åéæ¹è¿è¡ææ¥ï¼æå¨outputç®¡éä¸­ï¼é¤äºtcpæä»¶å¤ï¼è¿æ·»å äºstdoutæä»¶ï¼ä¹å°±æ¯æ¥å¿æ¥äºé¤äºä¼éè¿tcpåéå¤ï¼è¿ä¼æå°å¨æ åè¾åºä¸­ã\n\noutput {\n\n    tcp {\n        ...\n    }\n\n    stdout {}\n\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nç¶åç­å¾ä¸æ®µæ¶é´ï¼ç¶ååæ¥çè¯¥ç®¡éçä¿¡æ¯ï¼stdoutæä»¶çinåoutå®å¨ç¸ç­ï¼ä½tcpæä»¶inåoutè¿æ¯ç¸å·®çå¤§ï¼ä¹å°±æ¯outputç®¡éåºè¯¥æ²¡é®é¢ã\n\næååè®¾proxyç«¯æé®é¢ãæ¥å¿æ¯å¯ä»¥ä»logstashç«¯åéå°proxyç«¯çï¼åªæ¯å¾æ¢ï¼å¹¶ä¸è¿æå¶ä»æ°æ®æºä¹å¨å¾proxyç«¯åéæ¥å¿ï¼ä¹æ²¡æè¿ä¸ªé®é¢ï¼æä»¥æçªç¶æ³å°ï¼è¯¥æ°æ®æºçæ¥å¿å¾å¤§ï¼ä¼ä¸ä¼æ¯è¿ä¸ªåå å¯¼è´çå¢ï¼\n\næä»ä¸é¢æ åè¾åºä¸­æäºä¸æ¡æ¥å¿åºæ¥ï¼134kå¤§å°ï¼ç¶åææå¨çç¨ncå½ä»¤å°æ¥å¿åéå°proxyï¼å ä¸ºæ¥å¿å¾å¤§ï¼ææ¯å°æ¥å¿åå¥å°æä»¶ï¼ç¶ååç¨ç®¡éçæ¹å¼åéç\n\ncat test.txt | nc \n\n\n1\n\n\néè¿æ¥çproxyçæ¥å¿åç°ï¼å¶æ ¹æ¬æ²¡ææ¶å°è¯¥æ¡æ¥å¿ãé£ä¹é®é¢åå æ¾å°äºï¼å°±æ¯å ä¸ºæ¥å¿å¤ªå¤§ï¼å¯¼è´æ¥å¿åçäºä¸¢å¤±ã\n\n\n# ä»£ç ææ¥\n\nproxyæå¡çæ¯golangåçï¼éè¿æ¥çä»£ç ï¼è¿éä½¿ç¨äºbufio.NewScanneræ¥å¾ªç¯è¯»åè¿æ¥ä¸­çæ°æ®ã\n\n\tscanner := bufio.NewScanner(conn)\n\n\tfor scanner.Scan() {\n\t\t// å¤çæ°æ®\n\t\tmsg := scanner.Text()\n        ...\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥çNewScanneræ¹æ³å¯ä»¥çå°æä¸ä¸ªmaxTokenSizeåæ°ï¼ç¶åç¨çé»è®¤å¼MaxScanTokenSize\n\nfunc NewScanner(r io.Reader) *Scanner {\n\treturn &Scanner{\n\t\tr:            r,\n\t\tsplit:        ScanLines,\n\t\tmaxTokenSize: MaxScanTokenSize,\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåè·³è½¬ï¼æä¸ä¸ªåå§åç¼å­å¤§å°startBufSizeä¸º4kåæå¤§çç¼å­å¤§å°MaxScanTokenSizeä¸º64kãä½æ¯æä»¬çæ¥å¿å¤§å°ä¸º134kï¼å·²ç»å¤§äºæå¤§å¤§å°äºï¼æä»¥æ æ³æ¥æ¶å°è¯¥æ¥å¿ï¼ä¹å°±æ¯å ä¸ºè¿ä¸ªåå å¯¼è´äºæ¥å¿åçäºä¸¢å¤±ã\n\nconst (\n\tMaxScanTokenSize = 64 * 1024\n\n\tstartBufSize = 4096\n)\n\n\n1\n2\n3\n4\n5\n\n\næä»¬åçä¸Scanæ¹æ³ï¼æä¸æ®µä»£ç å¦ä¸ï¼å¦ææ¿å°çæ°æ®çå¤§å°å¤§äºmaxTokenSizeï¼åä¼ä½¿ç¨s.setErr(ErrTooLong)è®°å½éè¯¯ï¼ç¶åè¿åfalse\n\n\nfunc (s *Scanner) Scan() bool {\n\n    ..\n    const maxInt = int(^uint(0) >> 1)\n    if len(s.buf) >= s.maxTokenSize || len(s.buf) > maxInt/2 {\n        s.setErr(ErrTooLong)\n        return false\n    }\n    newSize := len(s.buf) * 2\n    if newSize == 0 {\n        newSize = startBufSize\n    }\n    if newSize > s.maxTokenSize {\n        newSize = s.maxTokenSize\n    }\n    newBuf := make([]byte, newSize)\n    copy(newBuf, s.buf[s.start:s.end])\n    ...\n\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nä½æ¯æä»¬å¨ä¸å¡ä»£ç ä¸­ï¼å¹¶æ²¡æå¤æ­è¯¥éè¯¯ï¼ä¹å°±æ¯å¦æScanæ¹æ³è½ç¶è¿åäºfalseï¼å¾ªç¯ç»æäºï¼ä½æ¯å¹¶æ²¡æä»»ä½éè¯¯ä¿¡æ¯ãä¹å°±æ¯æ æ³åç°è¯¥é®é¢ã\n\n\n# è§£å³æ¹æ³\n\n 1. å°TCPçæå¤§ç¼å­å¤§å°ä¿®æ¹ä¸ºéç½®æä»¶å¯éç½®çï¼è¿æ ·å¦ææ¥å¿å¾å¤§ï¼å¯ä»¥ä¿®æ¹éç½®å¢å¤§ç¼å­ä¸éãåºä¸­ææä¾Bufferæ¹æ³æ¥è®¾ç½®è¯¥ä¸éã\n\n 2. å¨Scanåçéè¯¯æ¶ï¼æå°éè¯¯æ¥å¿ï¼ä»£ç å¦ä¸ï¼\n\n\nscanner := bufio.NewScanner(conn)\n\nfor scanner.Scan() {\n    // å¤çæ°æ®\n    msg := scanner.Text()\n    ...\n\nif err := scanner.Err(); err != nil {\n    log.Errorf("æ«æè¾å¥æ¶åçéè¯¯ï¼%s", err)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# æ»ç»\n\n 1. è¦æé«èªå·±çææ¥çææ®µï¼çæç»ä»¶æä¾çææ¥æºå¶ï¼è®©ä½ äºåååã\n 2. æ¯ä¸ä¸ªæä¾çåæ°é½è³å³éè¦ï¼æä»¥æä»¬é½éè¦æä¸å®ççè§£ï¼å¯ä»¥åå°BUGçåç',normalizedContent:'# èæ¯\n\nlogstashä»æ°æ®æºæåæ¥å¿ï¼ç¶åéè¿tcpæä»¶åéå°proxyè¿ç¨ä¸­ãå¨ä¸å¡ä¾§åç°æ¥å¿éææ¾å°äºï¼æä»¥æäºè¿ä¸æ¬¡çé®é¢ææ¥ã\n\n\n\n\n# é®é¢ææ¥å®ä½\n\né¦åä»logstashä¾§å¼å§æ£æ¥ãæä»¬åçlogstashçæ¥å¿ï¼æ²¡æææ¾çæ¥éä¿¡æ¯ã\n\nç¶ååæ¥çlogstashç®¡éçç¶æãå¯ä»¥å¾ææ¾ççå°ï¼å¨outputç®¡éä¸­ï¼inè¿è¿å¤§äºoutï¼ä¹å°±æ¯logstashæåçæ¥å¿å·²ç»å°äºoutputç®¡éï¼ä½æ¯æ æ³è¾åºåºå»ï¼å¹¶ä¸duration_in_millisæ¶é´å¾é¿ï¼è¿ä¸ªä»£è¡¨çååºå»çéçå¾æ¢ï¼è¿æ¯ä»ä¹åå å¢ï¼\n\ncurl -xget \'localhost:9600/_node/stats/pipelines/azure_event_hubs?pretty\'\n\n{\n    ...\n"outputs" : [ {\n        "id" : "99b12e190d297be5d6113d04cf10089a3dccbaef7eed0cc41515e8e5af5f4595",\n        "name" : "tcp",\n        "events" : {\n        "in" : 341,\n        "out" : 69,\n        "duration_in_millis" : 519709\n        }\n    } \n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¦ä¹æ¯åéæ¹çåå ï¼è¦ä¹æ¯æ¥æ¶æ¹çåå ãæåä»åéæ¹è¿è¡ææ¥ï¼æå¨outputç®¡éä¸­ï¼é¤äºtcpæä»¶å¤ï¼è¿æ·»å äºstdoutæä»¶ï¼ä¹å°±æ¯æ¥å¿æ¥äºé¤äºä¼éè¿tcpåéå¤ï¼è¿ä¼æå°å¨æ åè¾åºä¸­ã\n\noutput {\n\n    tcp {\n        ...\n    }\n\n    stdout {}\n\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nç¶åç­å¾ä¸æ®µæ¶é´ï¼ç¶ååæ¥çè¯¥ç®¡éçä¿¡æ¯ï¼stdoutæä»¶çinåoutå®å¨ç¸ç­ï¼ä½tcpæä»¶inåoutè¿æ¯ç¸å·®çå¤§ï¼ä¹å°±æ¯outputç®¡éåºè¯¥æ²¡é®é¢ã\n\næååè®¾proxyç«¯æé®é¢ãæ¥å¿æ¯å¯ä»¥ä»logstashç«¯åéå°proxyç«¯çï¼åªæ¯å¾æ¢ï¼å¹¶ä¸è¿æå¶ä»æ°æ®æºä¹å¨å¾proxyç«¯åéæ¥å¿ï¼ä¹æ²¡æè¿ä¸ªé®é¢ï¼æä»¥æçªç¶æ³å°ï¼è¯¥æ°æ®æºçæ¥å¿å¾å¤§ï¼ä¼ä¸ä¼æ¯è¿ä¸ªåå å¯¼è´çå¢ï¼\n\næä»ä¸é¢æ åè¾åºä¸­æäºä¸æ¡æ¥å¿åºæ¥ï¼134kå¤§å°ï¼ç¶åææå¨çç¨ncå½ä»¤å°æ¥å¿åéå°proxyï¼å ä¸ºæ¥å¿å¾å¤§ï¼ææ¯å°æ¥å¿åå¥å°æä»¶ï¼ç¶ååç¨ç®¡éçæ¹å¼åéç\n\ncat test.txt | nc \n\n\n1\n\n\néè¿æ¥çproxyçæ¥å¿åç°ï¼å¶æ ¹æ¬æ²¡ææ¶å°è¯¥æ¡æ¥å¿ãé£ä¹é®é¢åå æ¾å°äºï¼å°±æ¯å ä¸ºæ¥å¿å¤ªå¤§ï¼å¯¼è´æ¥å¿åçäºä¸¢å¤±ã\n\n\n# ä»£ç ææ¥\n\nproxyæå¡çæ¯golangåçï¼éè¿æ¥çä»£ç ï¼è¿éä½¿ç¨äºbufio.newscanneræ¥å¾ªç¯è¯»åè¿æ¥ä¸­çæ°æ®ã\n\n\tscanner := bufio.newscanner(conn)\n\n\tfor scanner.scan() {\n\t\t// å¤çæ°æ®\n\t\tmsg := scanner.text()\n        ...\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥çnewscanneræ¹æ³å¯ä»¥çå°æä¸ä¸ªmaxtokensizeåæ°ï¼ç¶åç¨çé»è®¤å¼maxscantokensize\n\nfunc newscanner(r io.reader) *scanner {\n\treturn &scanner{\n\t\tr:            r,\n\t\tsplit:        scanlines,\n\t\tmaxtokensize: maxscantokensize,\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåè·³è½¬ï¼æä¸ä¸ªåå§åç¼å­å¤§å°startbufsizeä¸º4kåæå¤§çç¼å­å¤§å°maxscantokensizeä¸º64kãä½æ¯æä»¬çæ¥å¿å¤§å°ä¸º134kï¼å·²ç»å¤§äºæå¤§å¤§å°äºï¼æä»¥æ æ³æ¥æ¶å°è¯¥æ¥å¿ï¼ä¹å°±æ¯å ä¸ºè¿ä¸ªåå å¯¼è´äºæ¥å¿åçäºä¸¢å¤±ã\n\nconst (\n\tmaxscantokensize = 64 * 1024\n\n\tstartbufsize = 4096\n)\n\n\n1\n2\n3\n4\n5\n\n\næä»¬åçä¸scanæ¹æ³ï¼æä¸æ®µä»£ç å¦ä¸ï¼å¦ææ¿å°çæ°æ®çå¤§å°å¤§äºmaxtokensizeï¼åä¼ä½¿ç¨s.seterr(errtoolong)è®°å½éè¯¯ï¼ç¶åè¿åfalse\n\n\nfunc (s *scanner) scan() bool {\n\n    ..\n    const maxint = int(^uint(0) >> 1)\n    if len(s.buf) >= s.maxtokensize || len(s.buf) > maxint/2 {\n        s.seterr(errtoolong)\n        return false\n    }\n    newsize := len(s.buf) * 2\n    if newsize == 0 {\n        newsize = startbufsize\n    }\n    if newsize > s.maxtokensize {\n        newsize = s.maxtokensize\n    }\n    newbuf := make([]byte, newsize)\n    copy(newbuf, s.buf[s.start:s.end])\n    ...\n\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nä½æ¯æä»¬å¨ä¸å¡ä»£ç ä¸­ï¼å¹¶æ²¡æå¤æ­è¯¥éè¯¯ï¼ä¹å°±æ¯å¦æscanæ¹æ³è½ç¶è¿åäºfalseï¼å¾ªç¯ç»æäºï¼ä½æ¯å¹¶æ²¡æä»»ä½éè¯¯ä¿¡æ¯ãä¹å°±æ¯æ æ³åç°è¯¥é®é¢ã\n\n\n# è§£å³æ¹æ³\n\n 1. å°tcpçæå¤§ç¼å­å¤§å°ä¿®æ¹ä¸ºéç½®æä»¶å¯éç½®çï¼è¿æ ·å¦ææ¥å¿å¾å¤§ï¼å¯ä»¥ä¿®æ¹éç½®å¢å¤§ç¼å­ä¸éãåºä¸­ææä¾bufferæ¹æ³æ¥è®¾ç½®è¯¥ä¸éã\n\n 2. å¨scanåçéè¯¯æ¶ï¼æå°éè¯¯æ¥å¿ï¼ä»£ç å¦ä¸ï¼\n\n\nscanner := bufio.newscanner(conn)\n\nfor scanner.scan() {\n    // å¤çæ°æ®\n    msg := scanner.text()\n    ...\n\nif err := scanner.err(); err != nil {\n    log.errorf("æ«æè¾å¥æ¶åçéè¯¯ï¼%s", err)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# æ»ç»\n\n 1. è¦æé«èªå·±çææ¥çææ®µï¼çæç»ä»¶æä¾çææ¥æºå¶ï¼è®©ä½ äºåååã\n 2. æ¯ä¸ä¸ªæä¾çåæ°é½è³å³éè¦ï¼æä»¥æä»¬é½éè¦æä¸å®ççè§£ï¼å¯ä»¥åå°bugçåç',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ",frontmatter:{title:"Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ",date:"2025-06-09T20:07:50.000Z",permalink:"/pages/d2c214/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goé«è¯­è¨æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoåç¨æ± çå·¥ä½åçãå®ç°æ¹å¼åæ§è½ä¼åç­ç¥ï¼åå«åºåæµè¯å¯¹æ¯åå®éåºç¨åºæ¯åæ",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17494714259921749471425027.png"},{name:"twitter:title",content:"Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ"},{name:"twitter:description",content:"æ·±å¥è§£æGoåç¨æ± çå·¥ä½åçãå®ç°æ¹å¼åæ§è½ä¼åç­ç¥ï¼åå«åºåæµè¯å¯¹æ¯åå®éåºç¨åºæ¯åæ"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17494714259921749471425027.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/01.Go%E5%8D%8F%E7%A8%8B%E6%B1%A0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ"},{property:"og:description",content:"æ·±å¥è§£æGoåç¨æ± çå·¥ä½åçãå®ç°æ¹å¼åæ§è½ä¼åç­ç¥ï¼åå«åºåæµè¯å¯¹æ¯åå®éåºç¨åºæ¯åæ"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17494714259921749471425027.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/01.Go%E5%8D%8F%E7%A8%8B%E6%B1%A0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-09T20:07:50.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goé«è¯­è¨æ§è½ç¼ç¨"},{itemprop:"name",content:"Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ"},{itemprop:"description",content:"æ·±å¥è§£æGoåç¨æ± çå·¥ä½åçãå®ç°æ¹å¼åæ§è½ä¼åç­ç¥ï¼åå«åºåæµè¯å¯¹æ¯åå®éåºç¨åºæ¯åæ"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17494714259921749471425027.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/01.Go%E5%8D%8F%E7%A8%8B%E6%B1%A0%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/01.Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ.md",key:"v-66d9b7c0",path:"/pages/d2c214/",headers:[{level:2,title:"ä¸ºä»ä¹éè¦åç¨æ± ?",slug:"ä¸ºä»ä¹éè¦åç¨æ± ",normalizedTitle:"ä¸ºä»ä¹éè¦åç¨æ± ?",charIndex:2},{level:2,title:"æä¹ä½¿ç¨åç¨æ± ?",slug:"æä¹ä½¿ç¨åç¨æ± ",normalizedTitle:"æä¹ä½¿ç¨åç¨æ± ?",charIndex:171},{level:2,title:"Worker Pools è¯¥è®¾ç½®æå¤å¤§ï¼",slug:"worker-pools-è¯¥è®¾ç½®æå¤å¤§",normalizedTitle:"worker pools è¯¥è®¾ç½®æå¤å¤§ï¼",charIndex:1090},{level:2,title:"BenchMark",slug:"benchmark",normalizedTitle:"benchmark",charIndex:1314},{level:2,title:"ä»ä¹æ¶åä½¿ç¨ Worker Pools?",slug:"ä»ä¹æ¶åä½¿ç¨-worker-pools",normalizedTitle:"ä»ä¹æ¶åä½¿ç¨ worker pools?",charIndex:2892},{level:2,title:"ä»ä¹æ¶åè¯¥é¿åä½¿ç¨ Worker pools?",slug:"ä»ä¹æ¶åè¯¥é¿åä½¿ç¨-worker-pools",normalizedTitle:"ä»ä¹æ¶åè¯¥é¿åä½¿ç¨ worker pools?",charIndex:2959}],headersStr:"ä¸ºä»ä¹éè¦åç¨æ± ? æä¹ä½¿ç¨åç¨æ± ? Worker Pools è¯¥è®¾ç½®æå¤å¤§ï¼ BenchMark ä»ä¹æ¶åä½¿ç¨ Worker Pools? ä»ä¹æ¶åè¯¥é¿åä½¿ç¨ Worker pools?",content:'# ä¸ºä»ä¹éè¦åç¨æ± ?\n\ngoroutine è½ç¶æ¯è½»éçº§çå¹¶åæ¨¡åï¼ä½æ¯åç¨ä¹æ¯ææ ç©ºé´çï¼å¹¶ä¸æä¸ä¸æåæ¢çå¼éï¼å½åç¨æ°éå¢å æ¶ï¼æ§è½å¯è½ä¼æ¥å§çä¸éï¼çè³å¯¼è´ç¨åºå´©æºã\n\nèåç¨æ± éå¶ gorotinue çæ°éï¼å¹¶ä»å±äº«çä»»å¡éåä¸­æåä»»å¡æ§è¡ï¼ä»èè®© goroutineå¯æ§ï¼ä¸ä¼è¶è¿å¶å¤ççè½åï¼ä¿è¯æå¡çç¨³å®æ§ã\n\n\n\n\n# æä¹ä½¿ç¨åç¨æ± ?\n\næååå»º 5 ä¸ªworkerï¼ååå»ºä¸ä¸ª jobs channel ç¨äºä¼ éä»»å¡ï¼æåå¨ä¸æ­å°å°ä»»å¡çäº§å°éåä¸­ï¼workerè·åå°ä»»å¡åæ§è¡ï¼æåå° jobs closeæï¼åç¨ä¹å°±é½éåºäºï¼æåç¨åºéåºã\n\nfunc worker(id int, jobs <-chan int, results chan<- [32]byte) {\n    for j := range jobs {\n        results <- doWork(j)\n    }\n}\n\nfunc doWork(n int) [32]byte {\n    data := []byte(fmt.Sprintf("payload-%d", n))\n    return sha256.Sum256(data) //\n}\n\nfunc main() {\n    jobs := make(chan int, 100)\n    results := make(chan [32]byte, 100)\n\n    for w := 1; w <= 5; w++ {\n        go worker(w, jobs, results)\n    }\n\n    for j := 1; j <= 10; j++ {\n        jobs <- j\n    }\n    close(jobs)\n\n    for a := 1; a <= 10; a++ {\n        <-results\n    }\n\n    fmt.Println("ending")\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\nå¯ä»¥èªå·±å®ç°ï¼ä¹å¯ä»¥ç´æ¥å©ç¨å·²ç»å®ç°å¥½çå¼æºåç¨æ± ã\n\nhttps://github.com/Jeffail/tunny\n\nhttps://github.com/panjf2000/ants\n\nhttps://github.com/bytedance/gopkg/tree/main/util/gopool\n\n\n# Worker Pools è¯¥è®¾ç½®æå¤å¤§ï¼\n\næ± ä¸­çåç¨æä¼çåç¨æ°éå CPU æ ¸æ°å¯åç¸å³ãå¯ä»¥ä½¿ç¨ runtime.NumCPU() æ runtime.GOMAXPROCS(0) æ¥è·å CPU æ ¸æ°ã\n\nå¯¹äº CPU å¯éåä»»å¡ï¼éå¸¸å·¥ä½åç¨æ°å°äºæç­äºé»è¾ CPU æ ¸æ°ï¼å¯ä»¥è®© CPU å©ç¨çè¾¾å°æå¤§ãèå¯¹äº IO å¯éåä»»å¡ï¼å¯ä»¥è®©å·¥ä½åç¨æ°å¤§äºCPUæ ¸æ°ï¼ä»¥ä¸ºéå° IO ä¼è¿è¡é»å¡ï¼ä¹å°±æ¯å·¥ä½åç¨å¤§é¨åæ¶é´å¤äºé»å¡ç¶æã\n\n\n# BenchMark\n\nä½¿ç¨åç¨æ± åä¸ä½¿ç¨åç¨æ± å¤ç 10000 ä¸ªä»»å¡ç BenchMark æ¯è¾\n\nconst (\n    numJobs     = 10000\n    workerCount = 10\n)\n\nfunc doWork(n int) [32]byte {\n    data := []byte(fmt.Sprintf("payload-%d", n))\n    return sha256.Sum256(data)\n}\n\nfunc BenchmarkUnboundedGoroutines(b *testing.B) {\n    for range b.N {\n        var wg sync.WaitGroup\n        wg.Add(numJobs)\n\n        for j := 0; j < numJobs; j++ {\n            go func(job int) {\n                _ = doWork(job)\n                wg.Done()\n            }(j)\n        }\n        wg.Wait()\n    }\n}\n\nfunc worker(jobs <-chan int, wg *sync.WaitGroup) {\n    for job := range jobs {\n        _ = doWork(job)\n        wg.Done()\n    }\n}\n\nfunc BenchmarkWorkerPool(b *testing.B) {\n    for range b.N {\n        var wg sync.WaitGroup\n        wg.Add(numJobs)\n\n        jobs := make(chan int, numJobs)\n        for w := 0; w < workerCount; w++ {\n            go worker(jobs, &wg)\n        }\n\n        for j := 0; j < numJobs; j++ {\n            jobs <- j\n        }\n\n        close(jobs)\n        wg.Wait()\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n\n\nè¿è¡ç»æå¦ä¸ï¼ä½¿ç¨åç¨æ± ä½¿ç¨çèµæºæ´å°ï¼æ´å¿«çå®æå·¥ä½ã\n\n $ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkUnboundedGoroutines-12              486           2501263 ns/op          639942 B/op      39754 allocs/op\nBenchmarkWorkerPool-12                       776           1540660 ns/op          320554 B/op      19758 allocs/op\nPASS\nok      main/demo       3.343s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# ä»ä¹æ¶åä½¿ç¨ Worker Pools?\n\n * æå¤§éææ éå¶çä»»å¡æµå¤çã\n * ä¸ºäºç¨åºçç¨³å®æ§ï¼éå¶å¹¶è¡æä½çæ°éã\n\n\n# ä»ä¹æ¶åè¯¥é¿åä½¿ç¨ Worker pools?\n\n * å¯¹ä»»å¡çå»¶è¿éå¸¸ææï¼éè¦ç«å³æ§è¡ã\n * ä½è´è½½çæåµä¸ï¼ä½¿ç¨åç¨æ± åèå¢é«äºææ¬ã\n * å·¥ä½éè¾å°å¹¶ä¸æ¯æéçã',normalizedContent:'# ä¸ºä»ä¹éè¦åç¨æ± ?\n\ngoroutine è½ç¶æ¯è½»éçº§çå¹¶åæ¨¡åï¼ä½æ¯åç¨ä¹æ¯ææ ç©ºé´çï¼å¹¶ä¸æä¸ä¸æåæ¢çå¼éï¼å½åç¨æ°éå¢å æ¶ï¼æ§è½å¯è½ä¼æ¥å§çä¸éï¼çè³å¯¼è´ç¨åºå´©æºã\n\nèåç¨æ± éå¶ gorotinue çæ°éï¼å¹¶ä»å±äº«çä»»å¡éåä¸­æåä»»å¡æ§è¡ï¼ä»èè®© goroutineå¯æ§ï¼ä¸ä¼è¶è¿å¶å¤ççè½åï¼ä¿è¯æå¡çç¨³å®æ§ã\n\n\n\n\n# æä¹ä½¿ç¨åç¨æ± ?\n\næååå»º 5 ä¸ªworkerï¼ååå»ºä¸ä¸ª jobs channel ç¨äºä¼ éä»»å¡ï¼æåå¨ä¸æ­å°å°ä»»å¡çäº§å°éåä¸­ï¼workerè·åå°ä»»å¡åæ§è¡ï¼æåå° jobs closeæï¼åç¨ä¹å°±é½éåºäºï¼æåç¨åºéåºã\n\nfunc worker(id int, jobs <-chan int, results chan<- [32]byte) {\n    for j := range jobs {\n        results <- dowork(j)\n    }\n}\n\nfunc dowork(n int) [32]byte {\n    data := []byte(fmt.sprintf("payload-%d", n))\n    return sha256.sum256(data) //\n}\n\nfunc main() {\n    jobs := make(chan int, 100)\n    results := make(chan [32]byte, 100)\n\n    for w := 1; w <= 5; w++ {\n        go worker(w, jobs, results)\n    }\n\n    for j := 1; j <= 10; j++ {\n        jobs <- j\n    }\n    close(jobs)\n\n    for a := 1; a <= 10; a++ {\n        <-results\n    }\n\n    fmt.println("ending")\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n\n\nå¯ä»¥èªå·±å®ç°ï¼ä¹å¯ä»¥ç´æ¥å©ç¨å·²ç»å®ç°å¥½çå¼æºåç¨æ± ã\n\nhttps://github.com/jeffail/tunny\n\nhttps://github.com/panjf2000/ants\n\nhttps://github.com/bytedance/gopkg/tree/main/util/gopool\n\n\n# worker pools è¯¥è®¾ç½®æå¤å¤§ï¼\n\næ± ä¸­çåç¨æä¼çåç¨æ°éå cpu æ ¸æ°å¯åç¸å³ãå¯ä»¥ä½¿ç¨ runtime.numcpu() æ runtime.gomaxprocs(0) æ¥è·å cpu æ ¸æ°ã\n\nå¯¹äº cpu å¯éåä»»å¡ï¼éå¸¸å·¥ä½åç¨æ°å°äºæç­äºé»è¾ cpu æ ¸æ°ï¼å¯ä»¥è®© cpu å©ç¨çè¾¾å°æå¤§ãèå¯¹äº io å¯éåä»»å¡ï¼å¯ä»¥è®©å·¥ä½åç¨æ°å¤§äºcpuæ ¸æ°ï¼ä»¥ä¸ºéå° io ä¼è¿è¡é»å¡ï¼ä¹å°±æ¯å·¥ä½åç¨å¤§é¨åæ¶é´å¤äºé»å¡ç¶æã\n\n\n# benchmark\n\nä½¿ç¨åç¨æ± åä¸ä½¿ç¨åç¨æ± å¤ç 10000 ä¸ªä»»å¡ç benchmark æ¯è¾\n\nconst (\n    numjobs     = 10000\n    workercount = 10\n)\n\nfunc dowork(n int) [32]byte {\n    data := []byte(fmt.sprintf("payload-%d", n))\n    return sha256.sum256(data)\n}\n\nfunc benchmarkunboundedgoroutines(b *testing.b) {\n    for range b.n {\n        var wg sync.waitgroup\n        wg.add(numjobs)\n\n        for j := 0; j < numjobs; j++ {\n            go func(job int) {\n                _ = dowork(job)\n                wg.done()\n            }(j)\n        }\n        wg.wait()\n    }\n}\n\nfunc worker(jobs <-chan int, wg *sync.waitgroup) {\n    for job := range jobs {\n        _ = dowork(job)\n        wg.done()\n    }\n}\n\nfunc benchmarkworkerpool(b *testing.b) {\n    for range b.n {\n        var wg sync.waitgroup\n        wg.add(numjobs)\n\n        jobs := make(chan int, numjobs)\n        for w := 0; w < workercount; w++ {\n            go worker(jobs, &wg)\n        }\n\n        for j := 0; j < numjobs; j++ {\n            jobs <- j\n        }\n\n        close(jobs)\n        wg.wait()\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n\n\nè¿è¡ç»æå¦ä¸ï¼ä½¿ç¨åç¨æ± ä½¿ç¨çèµæºæ´å°ï¼æ´å¿«çå®æå·¥ä½ã\n\n $ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkunboundedgoroutines-12              486           2501263 ns/op          639942 b/op      39754 allocs/op\nbenchmarkworkerpool-12                       776           1540660 ns/op          320554 b/op      19758 allocs/op\npass\nok      main/demo       3.343s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# ä»ä¹æ¶åä½¿ç¨ worker pools?\n\n * æå¤§éææ éå¶çä»»å¡æµå¤çã\n * ä¸ºäºç¨åºçç¨³å®æ§ï¼éå¶å¹¶è¡æä½çæ°éã\n\n\n# ä»ä¹æ¶åè¯¥é¿åä½¿ç¨ worker pools?\n\n * å¯¹ä»»å¡çå»¶è¿éå¸¸ææï¼éè¦ç«å³æ§è¡ã\n * ä½è´è½½çæåµä¸ï¼ä½¿ç¨åç¨æ± åèå¢é«äºææ¬ã\n * å·¥ä½éè¾å°å¹¶ä¸æ¯æéçã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢",frontmatter:{title:"ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢",date:"2025-05-13T16:18:01.000Z",permalink:"/pages/91d2d9/",categories:["ç¼ç¨","goè¯­è¨"],tags:["goè¯­è¨","åå¸","å·¥ä½è®°å½"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æè®°å½èªå·±å¨å·¥ä½ä¸­ææ¥etcdåºç¨åå¸å¼éèå¯¼è´çæ³é²ä¸æ­»éé®é¢ï¼å¹¶éè¿åææºç æ¾å°æ ¹å ï¼æç»è§£å³ã",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢"},{name:"twitter:description",content:"æ¬æè®°å½èªå·±å¨å·¥ä½ä¸­ææ¥etcdåºç¨åå¸å¼éèå¯¼è´çæ³é²ä¸æ­»éé®é¢ï¼å¹¶éè¿åææºç æ¾å°æ ¹å ï¼æç»è§£å³ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/06.%E4%BD%BF%E7%94%A8etcd%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2%E4%B8%8E%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢"},{property:"og:description",content:"æ¬æè®°å½èªå·±å¨å·¥ä½ä¸­ææ¥etcdåºç¨åå¸å¼éèå¯¼è´çæ³é²ä¸æ­»éé®é¢ï¼å¹¶éè¿åææºç æ¾å°æ ¹å ï¼æç»è§£å³ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/06.%E4%BD%BF%E7%94%A8etcd%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2%E4%B8%8E%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-05-13T16:18:01.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"åå¸"},{property:"article:tag",content:"å·¥ä½è®°å½"},{itemprop:"name",content:"ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢"},{itemprop:"description",content:"æ¬æè®°å½èªå·±å¨å·¥ä½ä¸­ææ¥etcdåºç¨åå¸å¼éèå¯¼è´çæ³é²ä¸æ­»éé®é¢ï¼å¹¶éè¿åææºç æ¾å°æ ¹å ï¼æç»è§£å³ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/06.%E4%BD%BF%E7%94%A8etcd%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2%E4%B8%8E%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/06.ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢.md",key:"v-569242f6",path:"/pages/91d2d9/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"é®é¢éç°",slug:"é®é¢éç°",normalizedTitle:"é®é¢éç°",charIndex:62},{level:3,title:"ç°è±¡æè¿°",slug:"ç°è±¡æè¿°",normalizedTitle:"ç°è±¡æè¿°",charIndex:71},{level:3,title:"æå°å¤ç°ä»£ç ",slug:"æå°å¤ç°ä»£ç ",normalizedTitle:"æå°å¤ç°ä»£ç ",charIndex:243},{level:2,title:"æ ¹å åæ",slug:"æ ¹å åæ",normalizedTitle:"æ ¹å åæ",charIndex:672},{level:3,title:"æ¶æç¤ºæå¾",slug:"æ¶æç¤ºæå¾",normalizedTitle:"æ¶æç¤ºæå¾",charIndex:681},{level:3,title:"æºç å³é®è·¯å¾",slug:"æºç å³é®è·¯å¾",normalizedTitle:"æºç å³é®è·¯å¾",charIndex:1044},{level:2,title:"è§£å³æ¹æ¡",slug:"è§£å³æ¹æ¡",normalizedTitle:"è§£å³æ¹æ¡",charIndex:1205},{level:2,title:"æä½³å®è·µ",slug:"æä½³å®è·µ",normalizedTitle:"æä½³å®è·µ",charIndex:1732},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:1842}],headersStr:"ç®ä» é®é¢éç° ç°è±¡æè¿° æå°å¤ç°ä»£ç  æ ¹å åæ æ¶æç¤ºæå¾ æºç å³é®è·¯å¾ è§£å³æ¹æ¡ æä½³å®è·µ æ»ç»",content:'# ç®ä»\n\næ¬æè®°å½èªå·±å¨å·¥ä½ä¸­ææ¥etcdåºç¨åå¸å¼éèå¯¼è´çæ³é²ä¸æ­»éé®é¢ï¼å¹¶éè¿åææºç æ¾å°æ ¹å ï¼æç»è§£å³ã\n\n\n# é®é¢éç°\n\n\n# ç°è±¡æè¿°\n\næå¡åºç°æ°æ®å¥åºå¤±è´¥ï¼ä¸ä¼´éåå­æç»­å¢é¿ãå³é®ç°è±¡ï¼\n\n 1. éæ®çï¼éè¿etcdctl get --prefix /my-lock/å¯çå°éKEYé¿æå­å¨\n 2. ç§çº¦ç»­æï¼etcdctl lease timetoliveæ¾ç¤ºç§çº¦TTLä¸æ­éç½®\n 3. èµæºå¢é¿ï¼Goç¨åºåç¨æ°éè¯·æ±éçº¿æ§å¢é¿ï¼å¯éè¿pprofè§æµï¼\n\n\n# æå°å¤ç°ä»£ç \n\nfunc main() {\n\t// ... etcd clientåå§åä»£ç ä¸å...\n\n\t// å³é®é®é¢ç¹1ï¼ç¼ºå¤±sessionå³é­\n\tsession, _ := concurrency.NewSession(cli)\n\t// defer session.Close() // æææ³¨éå¯¼è´åç¨æ³æ¼\n\n\t// å³é®é®é¢ç¹2ï¼æªéæ¾é\n\tmutex := concurrency.NewMutex(session, "/my-lock/")\n\tctx, _ := context.WithTimeout(context.Background(), 5*time.Second)\n\t_ = mutex.Lock(ctx)\n\t\n\t// ...ä¸å¡é»è¾ä»£ç ...\n\t\n\t// å³é®é®é¢ç¹3ï¼é»æ­¢ç¨åºéåºï¼ä»ç¨äºdemoï¼\n\tselect {} \n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\n\n# æ ¹å åæ\n\n\n# æ¶æç¤ºæå¾\n\n+--------------+      å®æç»­çº¦      +------+\n|  Go routine  |-----------------\x3e| etcd |\n+--------------+  (KeepAlive)     +------+\n       â²\n       â æªè°ç¨Close()\n       âââââââ+\n              |\n+---------------------------+\n| session.Close() æ ¸å¿ä½ç¨ï¼|\n| 1. åæ­¢ç»­çº¦åç¨           |\n| 2. éæ¾ç§çº¦              |\n+---------------------------+\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# æºç å³é®è·¯å¾\n\nåç¨æ³æ¼è·¯å¾ï¼ NewSession() â go keepAliveåç¨ â client.KeepAlive() â åå°åç¨ç»­çº¦(sendKeepAliveLoop)\n\nèµæºéæ¾è·¯å¾ï¼ session.Close() â Orphan() â å³é­ä¸ä¸æ â è§¦åkeepAliveåç¨éåº\n\n\n# è§£å³æ¹æ¡\n\nå¨åå»ºsessionåï¼ç¡®ä¿è°ç¨Close()æ¹æ³ï¼åæ¶éæ¾èµæºã\n\nfunc main() {\n\t// ...åå§åä»£ç ä¸å...\n\n\tsession, err := concurrency.NewSession(cli)\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer session.Close() // æ°å¢å³é®ä¿®å¤\n\n\tmutex := concurrency.NewMutex(session, "/my-lock/")\n\tctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)\n\tdefer cancel() // ç¡®ä¿ä¸ä¸æåæ¶\n\n\tif err := mutex.Lock(ctx); err != nil {\n\t\tlog.Fatal(err)\n\t}\n\tdefer mutex.Unlock(context.TODO()) // åä¿é©éæ¾é\n\n\t// ...ä¸å¡é»è¾...\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\n\n# æä½³å®è·µ\n\n 1. èµæºéæ¾ä¸ååï¼\n\n * å¯¹æ¯ä¸ªNewSession()å¿é¡»éå¯¹defer Close()\n * éæä½å¿é¡»åè£¹å¨Lock()/Unlock()ä¸­\n * ä½¿ç¨å¸¦è¶æ¶çä¸ä¸æï¼å»ºè®®ä¸è¶è¿5sï¼\n\n\n# æ»ç»\n\n 1. etcdç¹æ§ï¼ä¼è¯åéçè®¾è®¡éè¦å®¢æ·ç«¯ä¸»å¨ç»´æ¤çå½å¨æ\n 2. è°è¯æå·§ï¼ä½¿ç¨go tool pprofè§å¯goroutineå¢é¿è¶å¿',normalizedContent:'# ç®ä»\n\næ¬æè®°å½èªå·±å¨å·¥ä½ä¸­ææ¥etcdåºç¨åå¸å¼éèå¯¼è´çæ³é²ä¸æ­»éé®é¢ï¼å¹¶éè¿åææºç æ¾å°æ ¹å ï¼æç»è§£å³ã\n\n\n# é®é¢éç°\n\n\n# ç°è±¡æè¿°\n\næå¡åºç°æ°æ®å¥åºå¤±è´¥ï¼ä¸ä¼´éåå­æç»­å¢é¿ãå³é®ç°è±¡ï¼\n\n 1. éæ®çï¼éè¿etcdctl get --prefix /my-lock/å¯çå°ékeyé¿æå­å¨\n 2. ç§çº¦ç»­æï¼etcdctl lease timetoliveæ¾ç¤ºç§çº¦ttlä¸æ­éç½®\n 3. èµæºå¢é¿ï¼goç¨åºåç¨æ°éè¯·æ±éçº¿æ§å¢é¿ï¼å¯éè¿pprofè§æµï¼\n\n\n# æå°å¤ç°ä»£ç \n\nfunc main() {\n\t// ... etcd clientåå§åä»£ç ä¸å...\n\n\t// å³é®é®é¢ç¹1ï¼ç¼ºå¤±sessionå³é­\n\tsession, _ := concurrency.newsession(cli)\n\t// defer session.close() // æææ³¨éå¯¼è´åç¨æ³æ¼\n\n\t// å³é®é®é¢ç¹2ï¼æªéæ¾é\n\tmutex := concurrency.newmutex(session, "/my-lock/")\n\tctx, _ := context.withtimeout(context.background(), 5*time.second)\n\t_ = mutex.lock(ctx)\n\t\n\t// ...ä¸å¡é»è¾ä»£ç ...\n\t\n\t// å³é®é®é¢ç¹3ï¼é»æ­¢ç¨åºéåºï¼ä»ç¨äºdemoï¼\n\tselect {} \n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\n\n# æ ¹å åæ\n\n\n# æ¶æç¤ºæå¾\n\n+--------------+      å®æç»­çº¦      +------+\n|  go routine  |-----------------\x3e| etcd |\n+--------------+  (keepalive)     +------+\n       â²\n       â æªè°ç¨close()\n       âââââââ+\n              |\n+---------------------------+\n| session.close() æ ¸å¿ä½ç¨ï¼|\n| 1. åæ­¢ç»­çº¦åç¨           |\n| 2. éæ¾ç§çº¦              |\n+---------------------------+\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# æºç å³é®è·¯å¾\n\nåç¨æ³æ¼è·¯å¾ï¼ newsession() â go keepaliveåç¨ â client.keepalive() â åå°åç¨ç»­çº¦(sendkeepaliveloop)\n\nèµæºéæ¾è·¯å¾ï¼ session.close() â orphan() â å³é­ä¸ä¸æ â è§¦åkeepaliveåç¨éåº\n\n\n# è§£å³æ¹æ¡\n\nå¨åå»ºsessionåï¼ç¡®ä¿è°ç¨close()æ¹æ³ï¼åæ¶éæ¾èµæºã\n\nfunc main() {\n\t// ...åå§åä»£ç ä¸å...\n\n\tsession, err := concurrency.newsession(cli)\n\tif err != nil {\n\t\tlog.fatal(err)\n\t}\n\tdefer session.close() // æ°å¢å³é®ä¿®å¤\n\n\tmutex := concurrency.newmutex(session, "/my-lock/")\n\tctx, cancel := context.withtimeout(context.background(), 5*time.second)\n\tdefer cancel() // ç¡®ä¿ä¸ä¸æåæ¶\n\n\tif err := mutex.lock(ctx); err != nil {\n\t\tlog.fatal(err)\n\t}\n\tdefer mutex.unlock(context.todo()) // åä¿é©éæ¾é\n\n\t// ...ä¸å¡é»è¾...\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\n\n# æä½³å®è·µ\n\n 1. èµæºéæ¾ä¸ååï¼\n\n * å¯¹æ¯ä¸ªnewsession()å¿é¡»éå¯¹defer close()\n * éæä½å¿é¡»åè£¹å¨lock()/unlock()ä¸­\n * ä½¿ç¨å¸¦è¶æ¶çä¸ä¸æï¼å»ºè®®ä¸è¶è¿5sï¼\n\n\n# æ»ç»\n\n 1. etcdç¹æ§ï¼ä¼è¯åéçè®¾è®¡éè¦å®¢æ·ç«¯ä¸»å¨ç»´æ¤çå½å¨æ\n 2. è°è¯æå·§ï¼ä½¿ç¨go tool pprofè§å¯goroutineå¢é¿è¶å¿',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ",frontmatter:{title:"Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ",date:"2025-06-14T10:43:04.000Z",permalink:"/pages/88360d/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨Goè¯­è¨ä¸­ï¼éåæ¯æ¥å¸¸å¼åä¸­æå¸¸è§çæä½ä¹ä¸ãä¸åçéåæ¹å¼ä¼å¯¹æ§è½äº§çæ¾èå½±åãæ¬æå°æ·±å¥åæGoè¯­è¨ä¸­éåçæ§è½ç¹ç¹ï¼å¹¶æ¢è®¨å¦ä½ä¼åéåä»¥æé«ä»£ç æçã",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ"},{name:"twitter:description",content:"å¨Goè¯­è¨ä¸­ï¼éåæ¯æ¥å¸¸å¼åä¸­æå¸¸è§çæä½ä¹ä¸ãä¸åçéåæ¹å¼ä¼å¯¹æ§è½äº§çæ¾èå½±åãæ¬æå°æ·±å¥åæGoè¯­è¨ä¸­éåçæ§è½ç¹ç¹ï¼å¹¶æ¢è®¨å¦ä½ä¼åéåä»¥æé«ä»£ç æçã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/03.Go%E8%AF%AD%E8%A8%80%E9%81%8D%E5%8E%86%E6%80%A7%E8%83%BD%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ"},{property:"og:description",content:"å¨Goè¯­è¨ä¸­ï¼éåæ¯æ¥å¸¸å¼åä¸­æå¸¸è§çæä½ä¹ä¸ãä¸åçéåæ¹å¼ä¼å¯¹æ§è½äº§çæ¾èå½±åãæ¬æå°æ·±å¥åæGoè¯­è¨ä¸­éåçæ§è½ç¹ç¹ï¼å¹¶æ¢è®¨å¦ä½ä¼åéåä»¥æé«ä»£ç æçã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/03.Go%E8%AF%AD%E8%A8%80%E9%81%8D%E5%8E%86%E6%80%A7%E8%83%BD%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T10:43:04.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ"},{itemprop:"description",content:"å¨Goè¯­è¨ä¸­ï¼éåæ¯æ¥å¸¸å¼åä¸­æå¸¸è§çæä½ä¹ä¸ãä¸åçéåæ¹å¼ä¼å¯¹æ§è½äº§çæ¾èå½±åãæ¬æå°æ·±å¥åæGoè¯­è¨ä¸­éåçæ§è½ç¹ç¹ï¼å¹¶æ¢è®¨å¦ä½ä¼åéåä»¥æé«ä»£ç æçã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/03.Go%E8%AF%AD%E8%A8%80%E9%81%8D%E5%8E%86%E6%80%A7%E8%83%BD%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/03.Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ.md",key:"v-deed5aca",path:"/pages/88360d/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"ä¸ç§éåæ¹å¼å¯¹æ¯",slug:"ä¸ç§éåæ¹å¼å¯¹æ¯",normalizedTitle:"ä¸ç§éåæ¹å¼å¯¹æ¯",charIndex:122},{level:2,title:"[]int Benchmarkæµè¯",slug:"int-benchmarkæµè¯",normalizedTitle:"[]int benchmarkæµè¯",charIndex:372},{level:2,title:"[]struct Benchmark æµè¯",slug:"struct-benchmark-æµè¯",normalizedTitle:"[]struct benchmark æµè¯",charIndex:1513},{level:2,title:"[]*struch Benchmark æµè¯",slug:"struch-benchmark-æµè¯",normalizedTitle:"[]*struch benchmark æµè¯",charIndex:2836},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:4284}],headersStr:"åè¨ ä¸ç§éåæ¹å¼å¯¹æ¯ []int Benchmarkæµè¯ []struct Benchmark æµè¯ []*struch Benchmark æµè¯ æ»ç»",content:"# åè¨\n\nå¨Goè¯­è¨ä¸­ï¼éåæ¯æ¥å¸¸å¼åä¸­æå¸¸è§çæä½ä¹ä¸ãä¸åçéåæ¹å¼ä¼å¯¹æ§è½äº§çæ¾èå½±åãæ¬æå°æ·±å¥åæï¼\n\n 1. åºæ¬åçéåçæ§è½ç¹ç¹\n 2. ç»æä½åççéåä¼å\n 3. æéåççæ§è½ä¼å¿\n 4. å®éåºæ¯ä¸­çæä½³å®è·µ\n\n\n# ä¸ç§éåæ¹å¼å¯¹æ¯\n\nGoè¯­è¨ä¸­ä¸»è¦æä¸ç§éååççæ¹å¼ï¼\n\n// 1. ç´¢å¼éå\nfor i := 0; i < len(slice); i++ {\n    // ä½¿ç¨slice[i]\n}\n\n// 2. rangeéåå¼\nfor _, v := range slice {\n    // ä½¿ç¨v\n}\n\n// 3. rangeéåç´¢å¼åå¼\nfor i, v := range slice {\n    // ä½¿ç¨iåv\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# []int Benchmarkæµè¯\n\nfunc BenchmarkIndexLoop(b *testing.B) {\n    slice := make([]int, 1000)\n    for i := 0; i < b.N; i++ {\n        for j := 0; j < len(slice); j++ {\n            _ = slice[j]\n        }\n    }\n}\n\nfunc BenchmarkRangeValue(b *testing.B) {\n    slice := make([]int, 1000)\n    for i := 0; i < b.N; i++ {\n        for _, v := range slice {\n            _ = v\n        }\n    }\n}\n\nfunc BenchmarkRangeIndexValue(b *testing.B) {\n    slice := make([]int, 1000)\n    for i := 0; i < b.N; i++ {\n        for j, v := range slice {\n            _, _ = j, v\n        }\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\næµè¯ç»æå¦ä¸ï¼å¯ä»¥åç°ä¸èæ§è½æ¥è¿ï¼åºæ¬ç¸å·®ä¸å¤§ã\n\n% go test -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkIndexLoop-12            4721586               235.7 ns/op             0 B/op          0 allocs/op\nBenchmarkRangeValue-12           5085130               234.3 ns/op             0 B/op          0 allocs/op\nBenchmarkRangeIndexValue-12      5101604               233.9 ns/op             0 B/op          0 allocs/op\nPASS\nok      main/demo       4.560s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# []struct Benchmark æµè¯\n\n\ntype Item struct {\n\tID   int\n\tData [4096]byte // å¢å æ°æ®éä»¥æ¾å¤§æ§è½å·®å¼\n}\n\nfunc BenchmarkStructIndex(b *testing.B) {\n\tvar slice [1000]Item\n\tfor i := 0; i < b.N; i++ {\n\t\tvar tmp int\n\t\tfor j := 0; j < len(slice); j++ {\n\t\t\ttmp = slice[j].ID\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc BenchmarkStructRangeValue(b *testing.B) {\n\tvar slice [1000]Item\n\tfor i := 0; i < b.N; i++ {\n\t\tvar tmp int\n\t\tfor _, v := range slice {\n\t\t\ttmp = v.ID\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc BenchmarkStructRangeIndexValue(b *testing.B) {\n\tvar slice [1000]Item\n\tfor i := 0; i < b.N; i++ {\n\t\tvar tmp int\n\t\tfor j := range slice {\n\t\t\ttmp = slice[j].ID\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥åç°éè¿ç´¢å¼çæ¹å¼åå¼çä¸¤ç§æ¹å¼ç¸å·®ä¸å¤§ï¼ä½æ¯ç´æ¥åå¼çæ¹å¼æ§è½å·®äº 500 å¤åï¼è¿æ¯å ä¸ºç´æ¥åå¼æ¶ä¼è¿è¡æ°æ®çå¤å¶ï¼èç´¢å¼åå¼ä¸ä¼è¿è¡æ°æ®çå¤å¶ã\n\n$ go test  -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkStructIndex-12                  4735326               237.9 ns/op             0 B/op          0 allocs/op\nBenchmarkStructRangeValue-12               17096             69135 ns/op               0 B/op          0 allocs/op\nBenchmarkStructRangeIndexValue-12        5123646               234.6 ns/op             0 B/op          0 allocs/op\nPASS\nok      main/demo       4.983s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# []*struch Benchmark æµè¯\n\n\ntype Item struct {\n\tID   int\n\tData [4096]byte // å¢å æ°æ®éä»¥æ¾å¤§æ§è½å·®å¼\n}\n\nfunc BenchmarkStructIndex(b *testing.B) {\n\tvar slice [1000]*Item\n\tfor i := range slice {\n\t\tslice[i] = &Item{}\n\t}\n\tfor i := 0; i < b.N; i++ {\n\t\tvar tmp int\n\t\tfor j := 0; j < len(slice); j++ {\n\t\t\ttmp = slice[j].ID\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc BenchmarkStructRangeValue(b *testing.B) {\n\tvar slice [1000]*Item\n\tfor i := range slice {\n\t\tslice[i] = &Item{}\n\t}\n\tfor i := 0; i < b.N; i++ {\n\t\tvar tmp int\n\t\tfor _, v := range slice {\n\t\t\ttmp = v.ID\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc BenchmarkStructRangeIndexValue(b *testing.B) {\n\tvar slice [1000]*Item\n\tfor i := range slice {\n\t\tslice[i] = &Item{}\n\t}\n\tfor i := 0; i < b.N; i++ {\n\t\tvar tmp int\n\t\tfor j := range slice {\n\t\t\ttmp = slice[j].ID\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n\n\nè¿è¡ç»æå¦ä¸ï¼ä¸èæ§è½ç¸è¿ï¼ä½æ¯æä¸ªå¥½å¤æ¯å¯ä»¥ç´æ¥ä¿®æ¹æéå¯¹åºç»æä½çå¼ã\n\ngo test  -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkStructIndex-12                  1864108               656.9 ns/op             2 B/op          0 allocs/op\nBenchmarkStructRangeValue-12             1577792               748.6 ns/op             3 B/op          0 allocs/op\nBenchmarkStructRangeIndexValue-12        1843874               661.4 ns/op             2 B/op          0 allocs/op\nPASS\nok      main/demo       5.995s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# æ»ç»\n\næ ¹æ®æµè¯ç»æï¼æä»¬å¾åºä»¥ä¸ç»è®ºï¼\n\n 1. åºç¡ç±»ååçï¼ä¸ç§éåæ¹å¼æ§è½ç¸å½ï¼å¯æç¼ç ä¹ æ¯éæ©\n 2. å¤§ç»æä½åçï¼\n    * é¿åä½¿ç¨for _, v := rangeç´æ¥å¼éå\n    * ä¼åä½¿ç¨ç´¢å¼éåærangeç´¢å¼éå\n 3. éè¦ä¿®æ¹åç´ æ¶ï¼\n    * ä½¿ç¨æéåç([]*T)æ§è½æ¥è¿ä¸æ´çµæ´»\n 4. æ§è½å³é®è·¯å¾ï¼\n    * å¯¹å¤§ç»æä½éåæä½ï¼ç´¢å¼éåæ§è½æä¼\n    * å¯¹å°ç»æä½æåºç¡ç±»åï¼å·®å¼å¯å¿½ç¥\n\nè®°ä½ï¼æ²¡æç»å¯¹çæä½³æ¹å¼ï¼åªææéåå½ååºæ¯çéæ©ï¼",normalizedContent:"# åè¨\n\nå¨goè¯­è¨ä¸­ï¼éåæ¯æ¥å¸¸å¼åä¸­æå¸¸è§çæä½ä¹ä¸ãä¸åçéåæ¹å¼ä¼å¯¹æ§è½äº§çæ¾èå½±åãæ¬æå°æ·±å¥åæï¼\n\n 1. åºæ¬åçéåçæ§è½ç¹ç¹\n 2. ç»æä½åççéåä¼å\n 3. æéåççæ§è½ä¼å¿\n 4. å®éåºæ¯ä¸­çæä½³å®è·µ\n\n\n# ä¸ç§éåæ¹å¼å¯¹æ¯\n\ngoè¯­è¨ä¸­ä¸»è¦æä¸ç§éååççæ¹å¼ï¼\n\n// 1. ç´¢å¼éå\nfor i := 0; i < len(slice); i++ {\n    // ä½¿ç¨slice[i]\n}\n\n// 2. rangeéåå¼\nfor _, v := range slice {\n    // ä½¿ç¨v\n}\n\n// 3. rangeéåç´¢å¼åå¼\nfor i, v := range slice {\n    // ä½¿ç¨iåv\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# []int benchmarkæµè¯\n\nfunc benchmarkindexloop(b *testing.b) {\n    slice := make([]int, 1000)\n    for i := 0; i < b.n; i++ {\n        for j := 0; j < len(slice); j++ {\n            _ = slice[j]\n        }\n    }\n}\n\nfunc benchmarkrangevalue(b *testing.b) {\n    slice := make([]int, 1000)\n    for i := 0; i < b.n; i++ {\n        for _, v := range slice {\n            _ = v\n        }\n    }\n}\n\nfunc benchmarkrangeindexvalue(b *testing.b) {\n    slice := make([]int, 1000)\n    for i := 0; i < b.n; i++ {\n        for j, v := range slice {\n            _, _ = j, v\n        }\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\næµè¯ç»æå¦ä¸ï¼å¯ä»¥åç°ä¸èæ§è½æ¥è¿ï¼åºæ¬ç¸å·®ä¸å¤§ã\n\n% go test -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkindexloop-12            4721586               235.7 ns/op             0 b/op          0 allocs/op\nbenchmarkrangevalue-12           5085130               234.3 ns/op             0 b/op          0 allocs/op\nbenchmarkrangeindexvalue-12      5101604               233.9 ns/op             0 b/op          0 allocs/op\npass\nok      main/demo       4.560s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# []struct benchmark æµè¯\n\n\ntype item struct {\n\tid   int\n\tdata [4096]byte // å¢å æ°æ®éä»¥æ¾å¤§æ§è½å·®å¼\n}\n\nfunc benchmarkstructindex(b *testing.b) {\n\tvar slice [1000]item\n\tfor i := 0; i < b.n; i++ {\n\t\tvar tmp int\n\t\tfor j := 0; j < len(slice); j++ {\n\t\t\ttmp = slice[j].id\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc benchmarkstructrangevalue(b *testing.b) {\n\tvar slice [1000]item\n\tfor i := 0; i < b.n; i++ {\n\t\tvar tmp int\n\t\tfor _, v := range slice {\n\t\t\ttmp = v.id\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc benchmarkstructrangeindexvalue(b *testing.b) {\n\tvar slice [1000]item\n\tfor i := 0; i < b.n; i++ {\n\t\tvar tmp int\n\t\tfor j := range slice {\n\t\t\ttmp = slice[j].id\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥åç°éè¿ç´¢å¼çæ¹å¼åå¼çä¸¤ç§æ¹å¼ç¸å·®ä¸å¤§ï¼ä½æ¯ç´æ¥åå¼çæ¹å¼æ§è½å·®äº 500 å¤åï¼è¿æ¯å ä¸ºç´æ¥åå¼æ¶ä¼è¿è¡æ°æ®çå¤å¶ï¼èç´¢å¼åå¼ä¸ä¼è¿è¡æ°æ®çå¤å¶ã\n\n$ go test  -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkstructindex-12                  4735326               237.9 ns/op             0 b/op          0 allocs/op\nbenchmarkstructrangevalue-12               17096             69135 ns/op               0 b/op          0 allocs/op\nbenchmarkstructrangeindexvalue-12        5123646               234.6 ns/op             0 b/op          0 allocs/op\npass\nok      main/demo       4.983s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# []*struch benchmark æµè¯\n\n\ntype item struct {\n\tid   int\n\tdata [4096]byte // å¢å æ°æ®éä»¥æ¾å¤§æ§è½å·®å¼\n}\n\nfunc benchmarkstructindex(b *testing.b) {\n\tvar slice [1000]*item\n\tfor i := range slice {\n\t\tslice[i] = &item{}\n\t}\n\tfor i := 0; i < b.n; i++ {\n\t\tvar tmp int\n\t\tfor j := 0; j < len(slice); j++ {\n\t\t\ttmp = slice[j].id\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc benchmarkstructrangevalue(b *testing.b) {\n\tvar slice [1000]*item\n\tfor i := range slice {\n\t\tslice[i] = &item{}\n\t}\n\tfor i := 0; i < b.n; i++ {\n\t\tvar tmp int\n\t\tfor _, v := range slice {\n\t\t\ttmp = v.id\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\nfunc benchmarkstructrangeindexvalue(b *testing.b) {\n\tvar slice [1000]*item\n\tfor i := range slice {\n\t\tslice[i] = &item{}\n\t}\n\tfor i := 0; i < b.n; i++ {\n\t\tvar tmp int\n\t\tfor j := range slice {\n\t\t\ttmp = slice[j].id\n\t\t}\n\t\t_ = tmp\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n\n\nè¿è¡ç»æå¦ä¸ï¼ä¸èæ§è½ç¸è¿ï¼ä½æ¯æä¸ªå¥½å¤æ¯å¯ä»¥ç´æ¥ä¿®æ¹æéå¯¹åºç»æä½çå¼ã\n\ngo test  -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkstructindex-12                  1864108               656.9 ns/op             2 b/op          0 allocs/op\nbenchmarkstructrangevalue-12             1577792               748.6 ns/op             3 b/op          0 allocs/op\nbenchmarkstructrangeindexvalue-12        1843874               661.4 ns/op             2 b/op          0 allocs/op\npass\nok      main/demo       5.995s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# æ»ç»\n\næ ¹æ®æµè¯ç»æï¼æä»¬å¾åºä»¥ä¸ç»è®ºï¼\n\n 1. åºç¡ç±»ååçï¼ä¸ç§éåæ¹å¼æ§è½ç¸å½ï¼å¯æç¼ç ä¹ æ¯éæ©\n 2. å¤§ç»æä½åçï¼\n    * é¿åä½¿ç¨for _, v := rangeç´æ¥å¼éå\n    * ä¼åä½¿ç¨ç´¢å¼éåærangeç´¢å¼éå\n 3. éè¦ä¿®æ¹åç´ æ¶ï¼\n    * ä½¿ç¨æéåç([]*t)æ§è½æ¥è¿ä¸æ´çµæ´»\n 4. æ§è½å³é®è·¯å¾ï¼\n    * å¯¹å¤§ç»æä½éåæä½ï¼ç´¢å¼éåæ§è½æä¼\n    * å¯¹å°ç»æä½æåºç¡ç±»åï¼å·®å¼å¯å¿½ç¥\n\nè®°ä½ï¼æ²¡æç»å¯¹çæä½³æ¹å¼ï¼åªææéåå½ååºæ¯çéæ©ï¼",charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå",frontmatter:{title:"Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå",date:"2025-06-14T09:34:09.000Z",permalink:"/pages/49057b/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨æ¥å£è£ç®±(Boxing)æºå¶ï¼åå«æ§è½å½±ååæãåºåæµè¯å¯¹æ¯åæä½³å®è·µå»ºè®®",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨æ¥å£è£ç®±(Boxing)æºå¶ï¼åå«æ§è½å½±ååæãåºåæµè¯å¯¹æ¯åæä½³å®è·µå»ºè®®"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/02.Go%E8%AF%AD%E8%A8%80Interface%20Boxing%E5%8E%9F%E7%90%86%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨æ¥å£è£ç®±(Boxing)æºå¶ï¼åå«æ§è½å½±ååæãåºåæµè¯å¯¹æ¯åæä½³å®è·µå»ºè®®"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/02.Go%E8%AF%AD%E8%A8%80Interface%20Boxing%E5%8E%9F%E7%90%86%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T09:34:09.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨æ¥å£è£ç®±(Boxing)æºå¶ï¼åå«æ§è½å½±ååæãåºåæµè¯å¯¹æ¯åæä½³å®è·µå»ºè®®"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/02.Go%E8%AF%AD%E8%A8%80Interface%20Boxing%E5%8E%9F%E7%90%86%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/02.Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå.md",key:"v-2835a650",path:"/pages/49057b/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"Interface Boxingåç",slug:"interface-boxingåç",normalizedTitle:"interface boxingåç",charIndex:123},{level:2,title:"åºç¡ç¤ºä¾åæ",slug:"åºç¡ç¤ºä¾åæ",normalizedTitle:"åºç¡ç¤ºä¾åæ",charIndex:258},{level:3,title:"å¼ç±»åèµå¼",slug:"å¼ç±»åèµå¼",normalizedTitle:"å¼ç±»åèµå¼",charIndex:269},{level:3,title:"å¯¹æ¯å·ä½ç±»å",slug:"å¯¹æ¯å·ä½ç±»å",normalizedTitle:"å¯¹æ¯å·ä½ç±»å",charIndex:665},{level:2,title:"ç»æä½ç¤ºä¾",slug:"ç»æä½ç¤ºä¾",normalizedTitle:"ç»æä½ç¤ºä¾",charIndex:1241},{level:3,title:"å¼ç±»åç»æä½",slug:"å¼ç±»åç»æä½",normalizedTitle:"å¼ç±»åç»æä½",charIndex:1251},{level:3,title:"æéç±»åç»æä½",slug:"æéç±»åç»æä½",normalizedTitle:"æéç±»åç»æä½",charIndex:1665},{level:2,title:"æ§è½åºåæµè¯",slug:"æ§è½åºåæµè¯",normalizedTitle:"æ§è½åºåæµè¯",charIndex:2176},{level:3,title:"å¼ç±»å",slug:"å¼ç±»å",normalizedTitle:"å¼ç±»å",charIndex:269},{level:3,title:"åçæä½æ§è½",slug:"åçæä½æ§è½",normalizedTitle:"åçæä½æ§è½",charIndex:3087},{level:3,title:"å½æ°è°ç¨æ§è½",slug:"å½æ°è°ç¨æ§è½",normalizedTitle:"å½æ°è°ç¨æ§è½",charIndex:4164},{level:2,title:"ä»ä¹æ¶ååè®¸Interface Boxing?",slug:"ä»ä¹æ¶ååè®¸interface-boxing",normalizedTitle:"ä»ä¹æ¶ååè®¸interface boxing?",charIndex:4876},{level:2,title:"æä½³å®è·µ",slug:"æä½³å®è·µ",normalizedTitle:"æä½³å®è·µ",charIndex:5386}],headersStr:"åè¨ Interface Boxingåç åºç¡ç¤ºä¾åæ å¼ç±»åèµå¼ å¯¹æ¯å·ä½ç±»å ç»æä½ç¤ºä¾ å¼ç±»åç»æä½ æéç±»åç»æä½ æ§è½åºåæµè¯ å¼ç±»å åçæä½æ§è½ å½æ°è°ç¨æ§è½ ä»ä¹æ¶ååè®¸Interface Boxing? æä½³å®è·µ",content:'# åè¨\n\nå¨Goè¯­è¨ä¸­ï¼interface{} æ¯ä¸ç§å¼ºå¤§çæ½è±¡æºå¶ï¼ä½å°å·ä½ç±»åèµå¼ç» interface{} (ç§°ä¸ºBoxing)ä¼å¸¦æ¥ä¸å®çæ§è½å¼éãæ¬æå°æ·±å¥åæ interface boxing çåçãæ§è½å½±ååä¼åå®è·µã\n\n\n# Interface Boxingåç\n\nå°å·ä½ç±»åçå¼èµå¼ç»interface{}çè¿ç¨ç§°ä¸ºBoxingãå¨è¿ä¸ªè¿ç¨ä¸­ï¼\n\n 1. å¼ä¼å¨å ä¸åéæ°åå­å¹¶æ·è´\n 2. å°æéåå¯¹åºç±»åèµå¼ç»interface{}åé\n 3. è¿ä¼å¸¦æ¥é¢å¤æ§è½å¼éå¹¶å¢å GCåå\n\n\n# åºç¡ç¤ºä¾åæ\n\n\n# å¼ç±»åèµå¼\n\nå°æ´å 1 èµå¼ç» interface{} åé demo ä¸­\n\nfunc main() {\n\tvar demo interface{}\n\tdemo = 1   // åçboxingï¼æ´å1éé¸å°å \n\tfmt.Println(demo)\n}\n\n\n1\n2\n3\n4\n5\n\n\nè¿è¡æ¶æ·»å  -gcflags="-m" åæ°ï¼æ¥çéé¸åæçç»æãå¯ä»¥çå° 1 éé¸å°å ä¸­äºã\n\n$ go run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.Println\n./main.go:11:9: 1 escapes to heap\n./main.go:12:13: ... argument does not escape\n1\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# å¯¹æ¯å·ä½ç±»å\n\næä»¬å¨å¯¹æ¯ç¨å·ä½çç±»åæ¥èµå¼ 1ï¼å¯ä»¥çå°æ¯æ²¡æéé¸çï¼ä½æ¯åç° demo åçäºéé¸å°å ï¼è¿æ¯ä¸ºä»ä¹å¢ï¼\n\nfunc main() {\n\tvar demo int\n\tdemo = 1\n\tfmt.Println(demo)\n}\n\n\n\n1\n2\n3\n4\n5\n6\n\n\n% go run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.Println\n./main.go:12:13: ... argument does not escape\n./main.go:12:14: demo escapes to heap\n1\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥ç fmt.Println çæºç å®ç°å¯ä»¥åç°ï¼å¶åæ°æ¯ interface{} ç±»åï¼å° demo ä¼ åç» Println æ¶ï¼ä¹ä¼åç Boxing è¿ç¨ï¼ä¹ä¼åçå¨å ä¸­ç³è¯·æ°åå­ä»¥åå¤å¶çè¿ç¨ï¼æä»¥ä¼åçéé¸ã\n\ntype any = interface{}\n\nfunc Println(a ...any) (n int, err error) {\n\treturn Fprintln(os.Stdout, a...)\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# ç»æä½ç¤ºä¾\n\n\n# å¼ç±»åç»æä½\n\nå°ä¸ä¸ªç»æä½èµå¼ç» inteface{}\n\ntype Person struct {\n\tName string\n}\n\nfunc main() {\n\tvar demo interface{}\n\tdemo = Person{}\n\tfmt.Println(demo)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¯ä»¥çå° Person{} æ¯æåçéé¸çï¼è¿éå°±æ¯åçäº Boxing\n\n$ go run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.Println\n./main.go:11:15: Person{} escapes to heap\n./main.go:12:13: ... argument does not escape\n{}\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# æéç±»åç»æä½\n\nåæ¥çç´æ¥å°æéèµå¼ç» interface{}\n\ntype Person struct {\n\tName string\n}\n\nfunc main() {\n\tvar demo interface{}\n\tdemo = &Person{}\n\tfmt.Println(demo)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¯ä»¥çå°è¿éä¾ç¶åçäºå éé¸ï¼è¿æ¯å ä¸º &Person{} åå°åæä½æ¬èº«å°±æ¯å¨å ä¸ç³è¯·åå­çï¼ç¶åå°å°åèµå¼ç» interface{} çåéï¼è¿éæ¯æ²¡æåç boxing çã\n\ngo run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.Println\n./main.go:11:9: &Person{} escapes to heap\n./main.go:12:13: ... argument does not escape\n&{}\n\n\n1\n2\n3\n4\n5\n6\n\n\né£ä¹é®é¢æ¥äºï¼è¿ä¸¤ç§æ¹å¼é½ä¼å¨å ä¸ç³è¯·åå­ï¼é£ä¹ä¸¤ç§æ¹å¼æ¯ä¸æ¯æ²¡æåºå«å¢ï¼\n\n\n# æ§è½åºåæµè¯\n\n\n# å¼ç±»å\n\nfunc BenchmarkBoxedNotInterface(b *testing.B) {\n\tjobs := make([]int, 0, 1000)\n\tfor range b.N {\n\t\tjobs = jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tjobs = append(jobs, j)\n\t\t}\n\t}\n}\n\nfunc BenchmarkBoxedWithInterface(b *testing.B) {\n\tjobs := make([]interface{}, 0, 1000)\n\tfor range b.N {\n\t\tjobs = jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tjobs = append(jobs, j)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nBenchmarkBoxedNotInterface å®å¨ä¸éè¦ç³è¯·å åå­ï¼å¹¶ä¸æ¯ BenchmarkBoxedWithInterface è¦å¿«20å¤åã\n\n$ go test -bench=. -benchmem\ngoos: darwin\ngoarch: arm64\npkg: code/interface_demo\ncpu: Apple M4 Pro\nBenchmarkBoxedNotInterface-12            4832395               249.5 ns/op             0 B/op          0 allocs/op\nBenchmarkBoxedWithInterface-12            232382              4596 ns/op            5952 B/op        744 allocs/op\nPASS\nok      code/interface_demo     9.662s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# åçæä½æ§è½\n\næä»¬æ¥å¯¹ä¸é¢ä¸¤ç§æ¹å¼æ¥è¿è¡ Benchmark ççä¸¤èæ§è½å¯¹æ¯ã\n\n\ntype Worker interface {\n\tWork()\n}\n\ntype LargeJob struct {\n\tpayload [4096]byte\n}\n\nfunc (LargeJob) Work() {}\n\nfunc BenchmarkBoxedLargeSlice(b *testing.B) {\n\tjobs := make([]Worker, 0, 1000)\n\tfor range b.N {\n\t\tjobs = jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tvar job LargeJob\n\t\t\tjobs = append(jobs, job)\n\t\t}\n\t}\n}\n\nfunc BenchmarkPointerLargeSlice(b *testing.B) {\n\tjobs := make([]Worker, 0, 1000)\n\tfor range b.N {\n\t\tjobs := jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tjob := &LargeJob{}\n\t\t\tjobs = append(jobs, job)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå°ä¸¤èåå­ç³è¯·æ¯å·®ä¸å¤çï¼ä½æ¯æçä¸ä½¿ç¨æéçè¦å¿«ä¸ 15%ï¼\n\n$ go test -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkBoxedLargeSlice-12                 2935            406307 ns/op         4096014 B/op       1000 allocs/op\nBenchmarkPointerLargeSlice-12               3434            342263 ns/op         4096010 B/op       1000 allocs/op\nPASS\nok      main/demo       3.589s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å½æ°è°ç¨æ§è½\n\n\nvar sink Worker\n\nfunc call(w Worker) {\n\tsink = w\n}\n\nfunc BenchmarkCallWithValue(b *testing.B) {\n\tfor range b.N {\n\t\tvar j LargeJob\n\t\tcall(j)\n\t}\n}\n\nfunc BenchmarkCallWithPointer(b *testing.B) {\n\tfor range b.N {\n\t\tj := &LargeJob{}\n\t\tcall(j)\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå°ä¸¤èåå­ç³è¯·å·®ä¸å¤ï¼ä½æéä¼ éæçè¦æ´é«ã\n\n% go test -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkCallWithValue-12        2959195               388.3 ns/op          4096 B/op          1 allocs/op\nBenchmarkCallWithPointer-12      3513249               339.7 ns/op          4096 B/op          1 allocs/op\nPASS\nok      main/demo       3.419s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# ä»ä¹æ¶ååè®¸Interface Boxing?\n\n * æ¥å£æ¯æè§£è¦åæ¨¡ååï¼æä»¥åççä½¿ç¨æ¥å£æ¥è®¾è®¡ APIï¼å³ä½¿æ Interface Boxing çææ¬ä¹æ¯å¼å¾è±è´¹ç\n\ntype Storage interface {\n    Save([]byte) error\n}\nfunc Process(s Storage) { /* ... */ }\n\n\n1\n2\n3\n4\n\n * å¦æå¼å¾å°ï¼ææ¬ä¹æ¯å¿½ç¥ä¸è®¡ç\n\nvar i interface{}\ni = 123 // safe and cheap\n\n\n1\n2\n\n * å¦æåªæ¯ç­æçä½¿ç¨ï¼å¼éä¹æ¯å°ç\n\nå¯ä»¥çå°fmt.Println ä¸­çå®ç°æ¯ç¨æ¥å£ä½ä¸ºæ¥æ¶åæ°\n\nfunc Println(a ...any) (n int, err error) {\n\treturn Fprintln(os.Stdout, a...)\n}\n\n\n1\n2\n3\n\n\nè¿éå³ä½¿æInterface Boxingï¼ä½åªæ¯ç­æçä¸æ¬¡ï¼ææ¬ä¹ä½ã\n\nfmt.Println("value:", someStruct) // implicit boxing is fine\n\n\n1\n\n\n\n# æä½³å®è·µ\n\n * ä¼ éç»æ¥å£æ¶ä½¿ç¨æéãå¯ä»¥é¿ååå­çéå¤å¤å¶ä¸ç³è¯·ã\n * å¦æè®¾è®¡ API æ¶ï¼ç±»åå·²ç»ç¡®å®å¹¶ä¸æ¯ç¨³å®çï¼å°½å¯è½é¿åä½¿ç¨ interface ã\n * å°½å¯è½ä½¿ç¨ç¹å®ç±»åçå®¹å¨ã',normalizedContent:'# åè¨\n\nå¨goè¯­è¨ä¸­ï¼interface{} æ¯ä¸ç§å¼ºå¤§çæ½è±¡æºå¶ï¼ä½å°å·ä½ç±»åèµå¼ç» interface{} (ç§°ä¸ºboxing)ä¼å¸¦æ¥ä¸å®çæ§è½å¼éãæ¬æå°æ·±å¥åæ interface boxing çåçãæ§è½å½±ååä¼åå®è·µã\n\n\n# interface boxingåç\n\nå°å·ä½ç±»åçå¼èµå¼ç»interface{}çè¿ç¨ç§°ä¸ºboxingãå¨è¿ä¸ªè¿ç¨ä¸­ï¼\n\n 1. å¼ä¼å¨å ä¸åéæ°åå­å¹¶æ·è´\n 2. å°æéåå¯¹åºç±»åèµå¼ç»interface{}åé\n 3. è¿ä¼å¸¦æ¥é¢å¤æ§è½å¼éå¹¶å¢å gcåå\n\n\n# åºç¡ç¤ºä¾åæ\n\n\n# å¼ç±»åèµå¼\n\nå°æ´å 1 èµå¼ç» interface{} åé demo ä¸­\n\nfunc main() {\n\tvar demo interface{}\n\tdemo = 1   // åçboxingï¼æ´å1éé¸å°å \n\tfmt.println(demo)\n}\n\n\n1\n2\n3\n4\n5\n\n\nè¿è¡æ¶æ·»å  -gcflags="-m" åæ°ï¼æ¥çéé¸åæçç»æãå¯ä»¥çå° 1 éé¸å°å ä¸­äºã\n\n$ go run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.println\n./main.go:11:9: 1 escapes to heap\n./main.go:12:13: ... argument does not escape\n1\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# å¯¹æ¯å·ä½ç±»å\n\næä»¬å¨å¯¹æ¯ç¨å·ä½çç±»åæ¥èµå¼ 1ï¼å¯ä»¥çå°æ¯æ²¡æéé¸çï¼ä½æ¯åç° demo åçäºéé¸å°å ï¼è¿æ¯ä¸ºä»ä¹å¢ï¼\n\nfunc main() {\n\tvar demo int\n\tdemo = 1\n\tfmt.println(demo)\n}\n\n\n\n1\n2\n3\n4\n5\n6\n\n\n% go run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.println\n./main.go:12:13: ... argument does not escape\n./main.go:12:14: demo escapes to heap\n1\n\n\n1\n2\n3\n4\n5\n6\n\n\næ¥ç fmt.println çæºç å®ç°å¯ä»¥åç°ï¼å¶åæ°æ¯ interface{} ç±»åï¼å° demo ä¼ åç» println æ¶ï¼ä¹ä¼åç boxing è¿ç¨ï¼ä¹ä¼åçå¨å ä¸­ç³è¯·æ°åå­ä»¥åå¤å¶çè¿ç¨ï¼æä»¥ä¼åçéé¸ã\n\ntype any = interface{}\n\nfunc println(a ...any) (n int, err error) {\n\treturn fprintln(os.stdout, a...)\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# ç»æä½ç¤ºä¾\n\n\n# å¼ç±»åç»æä½\n\nå°ä¸ä¸ªç»æä½èµå¼ç» inteface{}\n\ntype person struct {\n\tname string\n}\n\nfunc main() {\n\tvar demo interface{}\n\tdemo = person{}\n\tfmt.println(demo)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¯ä»¥çå° person{} æ¯æåçéé¸çï¼è¿éå°±æ¯åçäº boxing\n\n$ go run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.println\n./main.go:11:15: person{} escapes to heap\n./main.go:12:13: ... argument does not escape\n{}\n\n\n1\n2\n3\n4\n5\n6\n\n\n\n# æéç±»åç»æä½\n\nåæ¥çç´æ¥å°æéèµå¼ç» interface{}\n\ntype person struct {\n\tname string\n}\n\nfunc main() {\n\tvar demo interface{}\n\tdemo = &person{}\n\tfmt.println(demo)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nå¯ä»¥çå°è¿éä¾ç¶åçäºå éé¸ï¼è¿æ¯å ä¸º &person{} åå°åæä½æ¬èº«å°±æ¯å¨å ä¸ç³è¯·åå­çï¼ç¶åå°å°åèµå¼ç» interface{} çåéï¼è¿éæ¯æ²¡æåç boxing çã\n\ngo run -gcflags="-m" main.go \n# command-line-arguments\n./main.go:12:13: inlining call to fmt.println\n./main.go:11:9: &person{} escapes to heap\n./main.go:12:13: ... argument does not escape\n&{}\n\n\n1\n2\n3\n4\n5\n6\n\n\né£ä¹é®é¢æ¥äºï¼è¿ä¸¤ç§æ¹å¼é½ä¼å¨å ä¸ç³è¯·åå­ï¼é£ä¹ä¸¤ç§æ¹å¼æ¯ä¸æ¯æ²¡æåºå«å¢ï¼\n\n\n# æ§è½åºåæµè¯\n\n\n# å¼ç±»å\n\nfunc benchmarkboxednotinterface(b *testing.b) {\n\tjobs := make([]int, 0, 1000)\n\tfor range b.n {\n\t\tjobs = jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tjobs = append(jobs, j)\n\t\t}\n\t}\n}\n\nfunc benchmarkboxedwithinterface(b *testing.b) {\n\tjobs := make([]interface{}, 0, 1000)\n\tfor range b.n {\n\t\tjobs = jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tjobs = append(jobs, j)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nbenchmarkboxednotinterface å®å¨ä¸éè¦ç³è¯·å åå­ï¼å¹¶ä¸æ¯ benchmarkboxedwithinterface è¦å¿«20å¤åã\n\n$ go test -bench=. -benchmem\ngoos: darwin\ngoarch: arm64\npkg: code/interface_demo\ncpu: apple m4 pro\nbenchmarkboxednotinterface-12            4832395               249.5 ns/op             0 b/op          0 allocs/op\nbenchmarkboxedwithinterface-12            232382              4596 ns/op            5952 b/op        744 allocs/op\npass\nok      code/interface_demo     9.662s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# åçæä½æ§è½\n\næä»¬æ¥å¯¹ä¸é¢ä¸¤ç§æ¹å¼æ¥è¿è¡ benchmark ççä¸¤èæ§è½å¯¹æ¯ã\n\n\ntype worker interface {\n\twork()\n}\n\ntype largejob struct {\n\tpayload [4096]byte\n}\n\nfunc (largejob) work() {}\n\nfunc benchmarkboxedlargeslice(b *testing.b) {\n\tjobs := make([]worker, 0, 1000)\n\tfor range b.n {\n\t\tjobs = jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tvar job largejob\n\t\t\tjobs = append(jobs, job)\n\t\t}\n\t}\n}\n\nfunc benchmarkpointerlargeslice(b *testing.b) {\n\tjobs := make([]worker, 0, 1000)\n\tfor range b.n {\n\t\tjobs := jobs[:0]\n\t\tfor j := 0; j < 1000; j++ {\n\t\t\tjob := &largejob{}\n\t\t\tjobs = append(jobs, job)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå°ä¸¤èåå­ç³è¯·æ¯å·®ä¸å¤çï¼ä½æ¯æçä¸ä½¿ç¨æéçè¦å¿«ä¸ 15%ï¼\n\n$ go test -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkboxedlargeslice-12                 2935            406307 ns/op         4096014 b/op       1000 allocs/op\nbenchmarkpointerlargeslice-12               3434            342263 ns/op         4096010 b/op       1000 allocs/op\npass\nok      main/demo       3.589s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å½æ°è°ç¨æ§è½\n\n\nvar sink worker\n\nfunc call(w worker) {\n\tsink = w\n}\n\nfunc benchmarkcallwithvalue(b *testing.b) {\n\tfor range b.n {\n\t\tvar j largejob\n\t\tcall(j)\n\t}\n}\n\nfunc benchmarkcallwithpointer(b *testing.b) {\n\tfor range b.n {\n\t\tj := &largejob{}\n\t\tcall(j)\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå°ä¸¤èåå­ç³è¯·å·®ä¸å¤ï¼ä½æéä¼ éæçè¦æ´é«ã\n\n% go test -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkcallwithvalue-12        2959195               388.3 ns/op          4096 b/op          1 allocs/op\nbenchmarkcallwithpointer-12      3513249               339.7 ns/op          4096 b/op          1 allocs/op\npass\nok      main/demo       3.419s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# ä»ä¹æ¶ååè®¸interface boxing?\n\n * æ¥å£æ¯æè§£è¦åæ¨¡ååï¼æä»¥åççä½¿ç¨æ¥å£æ¥è®¾è®¡ apiï¼å³ä½¿æ interface boxing çææ¬ä¹æ¯å¼å¾è±è´¹ç\n\ntype storage interface {\n    save([]byte) error\n}\nfunc process(s storage) { /* ... */ }\n\n\n1\n2\n3\n4\n\n * å¦æå¼å¾å°ï¼ææ¬ä¹æ¯å¿½ç¥ä¸è®¡ç\n\nvar i interface{}\ni = 123 // safe and cheap\n\n\n1\n2\n\n * å¦æåªæ¯ç­æçä½¿ç¨ï¼å¼éä¹æ¯å°ç\n\nå¯ä»¥çå°fmt.println ä¸­çå®ç°æ¯ç¨æ¥å£ä½ä¸ºæ¥æ¶åæ°\n\nfunc println(a ...any) (n int, err error) {\n\treturn fprintln(os.stdout, a...)\n}\n\n\n1\n2\n3\n\n\nè¿éå³ä½¿æinterface boxingï¼ä½åªæ¯ç­æçä¸æ¬¡ï¼ææ¬ä¹ä½ã\n\nfmt.println("value:", somestruct) // implicit boxing is fine\n\n\n1\n\n\n\n# æä½³å®è·µ\n\n * ä¼ éç»æ¥å£æ¶ä½¿ç¨æéãå¯ä»¥é¿ååå­çéå¤å¤å¶ä¸ç³è¯·ã\n * å¦æè®¾è®¡ api æ¶ï¼ç±»åå·²ç»ç¡®å®å¹¶ä¸æ¯ç¨³å®çï¼å°½å¯è½é¿åä½¿ç¨ interface ã\n * å°½å¯è½ä½¿ç¨ç¹å®ç±»åçå®¹å¨ã',charsets:{cjk:!0},lastUpdated:"2025/09/22, 16:52:15",lastUpdatedTimestamp:1758531135e3},{title:"Goè¯­è¨é¶æ·è´ææ¯å®å¨æå",frontmatter:{title:"Goè¯­è¨é¶æ·è´ææ¯å®å¨æå",date:"2025-06-14T11:42:51.000Z",permalink:"/pages/4f7497/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨ä¸­é¶æ·è´ææ¯çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17498741316891749874131178.png"},{name:"twitter:title",content:"Goè¯­è¨é¶æ·è´ææ¯å®å¨æå"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­é¶æ·è´ææ¯çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17498741316891749874131178.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/04.Go%E8%AF%AD%E8%A8%80%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨é¶æ·è´ææ¯å®å¨æå"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­é¶æ·è´ææ¯çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17498741316891749874131178.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/04.Go%E8%AF%AD%E8%A8%80%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T11:42:51.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨é¶æ·è´ææ¯å®å¨æå"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­é¶æ·è´ææ¯çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17498741316891749874131178.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/04.Go%E8%AF%AD%E8%A8%80%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/04.Goè¯­è¨é¶æ·è´ææ¯å®å¨æå.md",key:"v-1c8f04f0",path:"/pages/4f7497/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"io.CopyBuffer",slug:"io-copybuffer",normalizedTitle:"io.copybuffer",charIndex:181},{level:2,title:"é«ææ°æ®è®¿é®åç",slug:"é«ææ°æ®è®¿é®åç",normalizedTitle:"é«ææ°æ®è®¿é®åç",charIndex:456},{level:2,title:"mmap",slug:"mmap",normalizedTitle:"mmap",charIndex:1438},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:3011}],headersStr:"åè¨ io.CopyBuffer é«ææ°æ®è®¿é®åç mmap æ»ç»",content:'# åè¨\n\né¶æ·è´(Zero-Copy)æ¯é«æ§è½ç¼ç¨ä¸­çå³é®ææ¯ï¼å®éè¿é¿åä¸å¿è¦çæ°æ®å¤å¶ï¼å¯ä»¥æ¾èæåI/Oå¯éååºç¨çæ§è½ãæ¬æå°æ·±å¥æ¢è®¨ï¼\n\n * é¶æ·è´çæ ¸å¿åçä¸ä¼å¿\n * Goè¯­è¨ä¸­å®ç°é¶æ·è´çä¸ç§ä¸»è¦æ¹å¼\n * å®éåºæ¯ä¸­çæ§è½å¯¹æ¯æ°æ®\n * å¦ä½æ ¹æ®ä¸å¡åºæ¯éæ©æä½³æ¹æ¡\n\néè¿æ¬æï¼ä½ å°ææ¡å¦ä½å¨èªå·±çé¡¹ç®ä¸­åºç¨è¿äºææ¯æ¥æåæ§è½ã\n\n\n# io.CopyBuffer\n\nå¨è¯»åæ¶ä½¿ç¨ io.Reader å io.Writer æ¥å£æ¶ï¼å¯ä»¥ä½¿ç¨ io.CopyBuffer æ¥æä¾éå¤ä½¿ç¨çç¼å­åºï¼é¿åäºéå¤çåéä¸­é´çç¼å­ã\n\nfunc StreamData(src io.Reader, dst io.Writer) error {\n    buf := make([]byte, 4096) // Reusable buffer\n    _, err := io.CopyBuffer(dst, src, buf)\n    return err\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# é«ææ°æ®è®¿é®åç\n\nåççåºå±æ¯ä¸ä¸ªæ°ç»ï¼æä»¥åºäºè¯¥æ°ç»è¿åä¸ä¸ªåçå¯ä»¥åå°åå­çæ·è´ï¼èä¸æ¯å°åçæ·è´å°ä¸ä¸ªæ°çåçä¸­\n\nfunc process(buffer []byte) []byte {\n    return buffer[128:256] // returns a slice reference without copying\n}\n\n\n1\n2\n3\n\n\nBenchmark\n\néå¯¹æ¾ç¤ºå¤å¶åé¶å¤å¶åççæ§è½åºåæµè¯æ¯è¾\n\nfunc BenchmarkCopy(b *testing.B) {\n\tdata := make([]byte, 64*1024)\n\tfor range b.N {\n\t\tbuf := make([]byte, len(data))\n\t\tcopy(buf, data)\n\t}\n}\n\nfunc BenchmarkSlice(b *testing.B) {\n\tdata := make([]byte, 64*1024)\n\tfor range b.N {\n\t\t_ = data[:]\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nè¿è¡ç»æå¦ä¸ï¼BenchmarkCopy æ¯æ¬¡é½ä¼åéæ°çåå­ï¼å¹¶è¿è¡æ°æ®çå¤å¶æä½ï¼è BenchmarkSliceé½æ¯å¯¹ç¸åçæ°ç»è¿è¡åçï¼æ²¡æä»»ä½çåéåå­åå¤å¶æ°æ®çæä½ï¼BenchmarkSliceæ è®ºæ¯è¿è¡è¿æ¯åå­ä¸é½ä¼äº BenchmarkCopy\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkCopy-12          356439              3546 ns/op           65536 B/op          1 allocs/op\nBenchmarkSlice-12       1000000000               0.2336 ns/op          0 B/op          0 allocs/op\nPASS\nok      main/demo       2.918s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# mmap\n\næ­£å¸¸è¯»åæä»¶æ¶ï¼æ¯éè¦å°ç£çä¸­çæä»¶è¯»åå°åæ ¸ç©ºé´ï¼åå¤å¶å°ç¨æ·ç©ºé´è¿è¡è®¿é®ã\n\n\n\nèä½¿ç¨mmapçæ¹å¼ï¼æ¯ç´æ¥å°ç£çä¸­çæä»¶æ å°å°åå­ä¸­ç´æ¥è®¿é®ï¼åå°äºå°åæ ¸ç©ºé´ä¸ç¨æ·ç©ºé´æ°æ®çå¤å¶ã\n\n\n\nä»£ç ç¤ºä¾\n\nimport "golang.org/x/exp/mmap"\n\nfunc ReadFileZeroCopy(path string) ([]byte, error) {\n    r, err := mmap.Open(path)\n    if err != nil {\n        return nil, err\n    }\n    defer r.Close()\n\n    data := make([]byte, r.Len())\n    _, err = r.ReadAt(data, 0)\n    return data, err\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåºåæµè¯\n\nä½¿ç¨ os.Open å mmap.Open å¯¹ 5M æä»¶çè¯»åæ§è½çåºåæµè¯ã\n\nfunc BenchmarkReadWithCopy(b *testing.B) {\n\tf, err := os.Open("./5MB.bin")\n\tif err != nil {\n\t\tb.Fatalf("failed to open file: %v", err)\n\t}\n\tdefer f.Close()\n\n\tbuf := make([]byte, 4*1024*1024) // 4MB buffer\n\tfor range b.N {\n\t\t_, err := f.ReadAt(buf, 0)\n\t\tif err != nil && err != io.EOF {\n\t\t\tb.Fatal(err)\n\t\t}\n\t}\n}\n\nfunc BenchmarkReadWithMmap(b *testing.B) {\n\tr, err := mmap.Open("./5MB.bin")\n\tif err != nil {\n\t\tb.Fatalf("failed to mmap file: %v", err)\n\t}\n\tdefer r.Close()\n\n\tbuf := make([]byte, r.Len())\n\tfor range b.N {\n\t\t_, err := r.ReadAt(buf, 0)\n\t\tif err != nil && err != io.EOF {\n\t\t\tb.Fatal(err)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n\n\nè¿è¡ç»æå¦ä¸ï¼ä½¿ç¨mmapæ¯æ åè¯»è¦å¿«ä¸å°ï¼åå­ç³è¯·ä¸ä¹è¦å°ã\n\n$ go test -bench=. -benchmem .              \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkReadWithCopy-12           13136             90918 ns/op             319 B/op          0 allocs/op\nBenchmarkReadWithMmap-12           19350             65262 ns/op             270 B/op          0 allocs/op\nPASS\nok      main/demo       7.067s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# æ»ç»\n\næ ¹æ®æµè¯ç»æï¼æä»¬å¾åºä»¥ä¸ç»è®ºï¼\n\n 1. ç¼å²åºéç¨ï¼\n    \n    * ä½¿ç¨io.CopyBufferéç¨ç¼å²åº\n    * éåæµå¼æ°æ®ä¼ è¾åºæ¯\n\n 2. åçæä½ï¼\n    \n    * ä¼åä½¿ç¨åçå¼ç¨èéå®æ´å¤å¶\n    * ç¹å«éåå¤§åæ°æ®å¤ç\n\n 3. æä»¶è¯»åï¼\n    \n    * å¤§æä»¶å¤çä¼åèèmmap\n    * æ³¨æmmapçåå­æ å°ç¹æ§\n\n 4. éç¨åºæ¯ï¼\n    \n    * é«ååéç½ç»åºç¨\n    * å¤§æä»¶å¤ç\n    * åå­ææååºç¨\n\nè®°ä½ï¼é¶æ·è´è½å¥½ï¼ä½ä¹è¦èèä»£ç å¯è¯»æ§åç»´æ¤ææ¬ï¼å¨æ§è½å³é®è·¯å¾ä¸ä½¿ç¨æææä½³ï¼',normalizedContent:'# åè¨\n\né¶æ·è´(zero-copy)æ¯é«æ§è½ç¼ç¨ä¸­çå³é®ææ¯ï¼å®éè¿é¿åä¸å¿è¦çæ°æ®å¤å¶ï¼å¯ä»¥æ¾èæåi/oå¯éååºç¨çæ§è½ãæ¬æå°æ·±å¥æ¢è®¨ï¼\n\n * é¶æ·è´çæ ¸å¿åçä¸ä¼å¿\n * goè¯­è¨ä¸­å®ç°é¶æ·è´çä¸ç§ä¸»è¦æ¹å¼\n * å®éåºæ¯ä¸­çæ§è½å¯¹æ¯æ°æ®\n * å¦ä½æ ¹æ®ä¸å¡åºæ¯éæ©æä½³æ¹æ¡\n\néè¿æ¬æï¼ä½ å°ææ¡å¦ä½å¨èªå·±çé¡¹ç®ä¸­åºç¨è¿äºææ¯æ¥æåæ§è½ã\n\n\n# io.copybuffer\n\nå¨è¯»åæ¶ä½¿ç¨ io.reader å io.writer æ¥å£æ¶ï¼å¯ä»¥ä½¿ç¨ io.copybuffer æ¥æä¾éå¤ä½¿ç¨çç¼å­åºï¼é¿åäºéå¤çåéä¸­é´çç¼å­ã\n\nfunc streamdata(src io.reader, dst io.writer) error {\n    buf := make([]byte, 4096) // reusable buffer\n    _, err := io.copybuffer(dst, src, buf)\n    return err\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# é«ææ°æ®è®¿é®åç\n\nåççåºå±æ¯ä¸ä¸ªæ°ç»ï¼æä»¥åºäºè¯¥æ°ç»è¿åä¸ä¸ªåçå¯ä»¥åå°åå­çæ·è´ï¼èä¸æ¯å°åçæ·è´å°ä¸ä¸ªæ°çåçä¸­\n\nfunc process(buffer []byte) []byte {\n    return buffer[128:256] // returns a slice reference without copying\n}\n\n\n1\n2\n3\n\n\nbenchmark\n\néå¯¹æ¾ç¤ºå¤å¶åé¶å¤å¶åççæ§è½åºåæµè¯æ¯è¾\n\nfunc benchmarkcopy(b *testing.b) {\n\tdata := make([]byte, 64*1024)\n\tfor range b.n {\n\t\tbuf := make([]byte, len(data))\n\t\tcopy(buf, data)\n\t}\n}\n\nfunc benchmarkslice(b *testing.b) {\n\tdata := make([]byte, 64*1024)\n\tfor range b.n {\n\t\t_ = data[:]\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nè¿è¡ç»æå¦ä¸ï¼benchmarkcopy æ¯æ¬¡é½ä¼åéæ°çåå­ï¼å¹¶è¿è¡æ°æ®çå¤å¶æä½ï¼è benchmarksliceé½æ¯å¯¹ç¸åçæ°ç»è¿è¡åçï¼æ²¡æä»»ä½çåéåå­åå¤å¶æ°æ®çæä½ï¼benchmarksliceæ è®ºæ¯è¿è¡è¿æ¯åå­ä¸é½ä¼äº benchmarkcopy\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkcopy-12          356439              3546 ns/op           65536 b/op          1 allocs/op\nbenchmarkslice-12       1000000000               0.2336 ns/op          0 b/op          0 allocs/op\npass\nok      main/demo       2.918s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# mmap\n\næ­£å¸¸è¯»åæä»¶æ¶ï¼æ¯éè¦å°ç£çä¸­çæä»¶è¯»åå°åæ ¸ç©ºé´ï¼åå¤å¶å°ç¨æ·ç©ºé´è¿è¡è®¿é®ã\n\n\n\nèä½¿ç¨mmapçæ¹å¼ï¼æ¯ç´æ¥å°ç£çä¸­çæä»¶æ å°å°åå­ä¸­ç´æ¥è®¿é®ï¼åå°äºå°åæ ¸ç©ºé´ä¸ç¨æ·ç©ºé´æ°æ®çå¤å¶ã\n\n\n\nä»£ç ç¤ºä¾\n\nimport "golang.org/x/exp/mmap"\n\nfunc readfilezerocopy(path string) ([]byte, error) {\n    r, err := mmap.open(path)\n    if err != nil {\n        return nil, err\n    }\n    defer r.close()\n\n    data := make([]byte, r.len())\n    _, err = r.readat(data, 0)\n    return data, err\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nåºåæµè¯\n\nä½¿ç¨ os.open å mmap.open å¯¹ 5m æä»¶çè¯»åæ§è½çåºåæµè¯ã\n\nfunc benchmarkreadwithcopy(b *testing.b) {\n\tf, err := os.open("./5mb.bin")\n\tif err != nil {\n\t\tb.fatalf("failed to open file: %v", err)\n\t}\n\tdefer f.close()\n\n\tbuf := make([]byte, 4*1024*1024) // 4mb buffer\n\tfor range b.n {\n\t\t_, err := f.readat(buf, 0)\n\t\tif err != nil && err != io.eof {\n\t\t\tb.fatal(err)\n\t\t}\n\t}\n}\n\nfunc benchmarkreadwithmmap(b *testing.b) {\n\tr, err := mmap.open("./5mb.bin")\n\tif err != nil {\n\t\tb.fatalf("failed to mmap file: %v", err)\n\t}\n\tdefer r.close()\n\n\tbuf := make([]byte, r.len())\n\tfor range b.n {\n\t\t_, err := r.readat(buf, 0)\n\t\tif err != nil && err != io.eof {\n\t\t\tb.fatal(err)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n\n\nè¿è¡ç»æå¦ä¸ï¼ä½¿ç¨mmapæ¯æ åè¯»è¦å¿«ä¸å°ï¼åå­ç³è¯·ä¸ä¹è¦å°ã\n\n$ go test -bench=. -benchmem .              \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkreadwithcopy-12           13136             90918 ns/op             319 b/op          0 allocs/op\nbenchmarkreadwithmmap-12           19350             65262 ns/op             270 b/op          0 allocs/op\npass\nok      main/demo       7.067s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# æ»ç»\n\næ ¹æ®æµè¯ç»æï¼æä»¬å¾åºä»¥ä¸ç»è®ºï¼\n\n 1. ç¼å²åºéç¨ï¼\n    \n    * ä½¿ç¨io.copybufferéç¨ç¼å²åº\n    * éåæµå¼æ°æ®ä¼ è¾åºæ¯\n\n 2. åçæä½ï¼\n    \n    * ä¼åä½¿ç¨åçå¼ç¨èéå®æ´å¤å¶\n    * ç¹å«éåå¤§åæ°æ®å¤ç\n\n 3. æä»¶è¯»åï¼\n    \n    * å¤§æä»¶å¤çä¼åèèmmap\n    * æ³¨æmmapçåå­æ å°ç¹æ§\n\n 4. éç¨åºæ¯ï¼\n    \n    * é«ååéç½ç»åºç¨\n    * å¤§æä»¶å¤ç\n    * åå­ææååºç¨\n\nè®°ä½ï¼é¶æ·è´è½å¥½ï¼ä½ä¹è¦èèä»£ç å¯è¯»æ§åç»´æ¤ææ¬ï¼å¨æ§è½å³é®è·¯å¾ä¸ä½¿ç¨æææä½³ï¼',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ",frontmatter:{title:"Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ",date:"2025-06-14T14:06:39.000Z",permalink:"/pages/b03207/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨ä¸­ä¸å¯åæ°æ®å±äº«æ¨¡å¼çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µ",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­ä¸å¯åæ°æ®å±äº«æ¨¡å¼çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µ"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/05.Go%E8%AF%AD%E8%A8%80%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB%EF%BC%9A%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­ä¸å¯åæ°æ®å±äº«æ¨¡å¼çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µ"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/05.Go%E8%AF%AD%E8%A8%80%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB%EF%BC%9A%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T14:06:39.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­ä¸å¯åæ°æ®å±äº«æ¨¡å¼çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µ"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/05.Go%E8%AF%AD%E8%A8%80%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB%EF%BC%9A%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/05.Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ.md",key:"v-e7a69188",path:"/pages/b03207/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"æ¡ä¾ä¸ï¼å±äº«éç½®",slug:"æ¡ä¾ä¸-å±äº«éç½®",normalizedTitle:"æ¡ä¾ä¸ï¼å±äº«éç½®",charIndex:93},{level:2,title:"æ¡ä¾äºï¼ä¸å¯åè·¯ç±è¡¨",slug:"æ¡ä¾äº-ä¸å¯åè·¯ç±è¡¨",normalizedTitle:"æ¡ä¾äºï¼ä¸å¯åè·¯ç±è¡¨",charIndex:1280},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:2285}],headersStr:"åè¨ æ¡ä¾ä¸ï¼å±äº«éç½® æ¡ä¾äºï¼ä¸å¯åè·¯ç±è¡¨ æ»ç»",content:'# åè¨\n\nå¯¹å±äº«æ°æ®çå¹¶åè®¿é®å¾å¾éè¦ç¨å°éï¼èè¿æ¯ä¸ä¸ªå¸¸è§çæ§è½ç¶é¢ãèä¸å¯åæ°æ®å±äº«å¼ä¸ç§ä¸éè¦ç¨éæ¥ä¿æ¤å±äº«æ°æ®çæ¹å¼ï¼åå»ºåçæ°æ®æ°¸è¿ä¸æ¹åï¼è¿æ ·å°±ä¸ä¼æç«äºé®é¢äºã\n\n\n# æ¡ä¾ä¸ï¼å±äº«éç½®\n\n 1. åå»ºéç½®ç»æä½\n\n// config.go\ntype Config struct {\n    LogLevel string\n    Timeout  time.Duration\n    Features map[string]bool // å¿é¡»æ·±æ·è´ï¼åå§mapçä¿®æ¹ä¼å½±åå·²åå»ºçéç½®\n}\n\n\n1\n2\n3\n4\n5\n6\n\n 2. æ¯æ¬¡è·åéç½®é½æ¯ç¬ç«ç\n\nfunc NewConfig(logLevel string, timeout time.Duration, features map[string]bool) *Config {\n    copiedFeatures := make(map[string]bool, len(features))\n    for k, v := range features {\n        copiedFeatures[k] = v\n    }\n\n    return &Config{\n        LogLevel: logLevel,\n        Timeout:  timeout,\n        Features: copiedFeatures,\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n 3. ä½¿ç¨ atomic.Value æ¥å­å¨å¹¶å®å¨çæ´æ°å½åéç½®\n\nvar currentConfig atomic.Pointer[Config] // Go 1.19+ ç¹æ§\n\n// LoadInitialConfig åå§åéç½®ï¼å¿é¡»ä¿è¯çº¿ç¨å®å¨ï¼\nfunc LoadInitialConfig() {\n    cfg := NewConfig("info", 5*time.Second, map[string]bool{"beta": true})\n    currentConfig.Store(cfg) // åå­å­å¨åå§éç½®\n}\n\n// GetConfig å®å¨è·åå½åéç½®ï¼é¶éæ¶èï¼\nfunc GetConfig() *Config {\n    return currentConfig.Load() // åå­å è½½æé\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n 4. å¨å¤çç¨åºä¸­ä½¿ç¨\n\nfunc handler(w http.ResponseWriter, r *http.Request) {\n    cfg := GetConfig()\n    if cfg.Features["beta"] {\n        // Enable beta path\n    }\n    // Use cfg.Timeout, cfg.LogLevel, etc.\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# æ¡ä¾äºï¼ä¸å¯åè·¯ç±è¡¨\n\n 1. åå»ºè·¯ç±ç»æä½\n\ntype Route struct {\n    Path    string\n    Backend string\n}\n\ntype RoutingTable struct {\n    Routes []Route\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 2. æ¯æ¬¡è·åé½æ¯å¨æ°çæ¬\n\nâfunc NewRoutingTable(routes []Route) *RoutingTable {\n    copied := make([]Route, len(routes))\n    copy(copied, routes)\n    return &RoutingTable{Routes: copied}\n}\n\n\n1\n2\n3\n4\n5\n\n 3. ä»¥åå­çæ¹å¼å­å¨åä¿®æ¹\n\nvar currentRoutes atomic.Pointer[RoutingTable]\n\nfunc LoadInitialRoutes() {\n    table := NewRoutingTable([]Route{\n        {Path: "/api", Backend: "http://api.internal"},\n        {Path: "/admin", Backend: "http://admin.internal"},\n    })\n    currentRoutes.Store(table)\n}\n\nfunc GetRoutingTable() *RoutingTable {\n    return currentRoutes.Load()\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n 4. å¹¶åè·¯ç±è¯·æ±\n\nfunc routeRequest(path string) string {\n    table := GetRoutingTable()\n    for _, route := range table.Routes {\n        if strings.HasPrefix(path, route.Path) {\n            return route.Backend\n        }\n    }\n    return ""\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# æ»ç»\n\nåºç¨åºæ¯\n\n * è¯»å¤åå°ï¼éç½®ä¿¡æ¯ãè·¯ç±è¡¨ç­ä½é¢åæ´æ°æ®\n * é«æ§è½è¦æ±ï¼éè¦é¿åéç«äºçç­ç¹è·¯å¾\n\næ³¨æäºé¡¹\n\n * æ·±æ·è´ææ¬ï¼å½æ°æ®ç»æå¤ææ¶ï¼åµå¥map/sliceï¼ï¼éè¦èèæ·è´æ§è½\n * åå­æ¶èï¼æ¯æ¬¡æ´æ°é½ä¼åå»ºæ°å¯¹è±¡ï¼éæè¡¡åå­ä¸æ§è½\n * åå­æ§ä¿è¯ï¼æ´æ°æä½å¿é¡»å®å¨æ¿æ¢éç½®å¯¹è±¡ï¼é¿åé¨åæ´æ°',normalizedContent:'# åè¨\n\nå¯¹å±äº«æ°æ®çå¹¶åè®¿é®å¾å¾éè¦ç¨å°éï¼èè¿æ¯ä¸ä¸ªå¸¸è§çæ§è½ç¶é¢ãèä¸å¯åæ°æ®å±äº«å¼ä¸ç§ä¸éè¦ç¨éæ¥ä¿æ¤å±äº«æ°æ®çæ¹å¼ï¼åå»ºåçæ°æ®æ°¸è¿ä¸æ¹åï¼è¿æ ·å°±ä¸ä¼æç«äºé®é¢äºã\n\n\n# æ¡ä¾ä¸ï¼å±äº«éç½®\n\n 1. åå»ºéç½®ç»æä½\n\n// config.go\ntype config struct {\n    loglevel string\n    timeout  time.duration\n    features map[string]bool // å¿é¡»æ·±æ·è´ï¼åå§mapçä¿®æ¹ä¼å½±åå·²åå»ºçéç½®\n}\n\n\n1\n2\n3\n4\n5\n6\n\n 2. æ¯æ¬¡è·åéç½®é½æ¯ç¬ç«ç\n\nfunc newconfig(loglevel string, timeout time.duration, features map[string]bool) *config {\n    copiedfeatures := make(map[string]bool, len(features))\n    for k, v := range features {\n        copiedfeatures[k] = v\n    }\n\n    return &config{\n        loglevel: loglevel,\n        timeout:  timeout,\n        features: copiedfeatures,\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n 3. ä½¿ç¨ atomic.value æ¥å­å¨å¹¶å®å¨çæ´æ°å½åéç½®\n\nvar currentconfig atomic.pointer[config] // go 1.19+ ç¹æ§\n\n// loadinitialconfig åå§åéç½®ï¼å¿é¡»ä¿è¯çº¿ç¨å®å¨ï¼\nfunc loadinitialconfig() {\n    cfg := newconfig("info", 5*time.second, map[string]bool{"beta": true})\n    currentconfig.store(cfg) // åå­å­å¨åå§éç½®\n}\n\n// getconfig å®å¨è·åå½åéç½®ï¼é¶éæ¶èï¼\nfunc getconfig() *config {\n    return currentconfig.load() // åå­å è½½æé\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n 4. å¨å¤çç¨åºä¸­ä½¿ç¨\n\nfunc handler(w http.responsewriter, r *http.request) {\n    cfg := getconfig()\n    if cfg.features["beta"] {\n        // enable beta path\n    }\n    // use cfg.timeout, cfg.loglevel, etc.\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# æ¡ä¾äºï¼ä¸å¯åè·¯ç±è¡¨\n\n 1. åå»ºè·¯ç±ç»æä½\n\ntype route struct {\n    path    string\n    backend string\n}\n\ntype routingtable struct {\n    routes []route\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 2. æ¯æ¬¡è·åé½æ¯å¨æ°çæ¬\n\nâfunc newroutingtable(routes []route) *routingtable {\n    copied := make([]route, len(routes))\n    copy(copied, routes)\n    return &routingtable{routes: copied}\n}\n\n\n1\n2\n3\n4\n5\n\n 3. ä»¥åå­çæ¹å¼å­å¨åä¿®æ¹\n\nvar currentroutes atomic.pointer[routingtable]\n\nfunc loadinitialroutes() {\n    table := newroutingtable([]route{\n        {path: "/api", backend: "http://api.internal"},\n        {path: "/admin", backend: "http://admin.internal"},\n    })\n    currentroutes.store(table)\n}\n\nfunc getroutingtable() *routingtable {\n    return currentroutes.load()\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n 4. å¹¶åè·¯ç±è¯·æ±\n\nfunc routerequest(path string) string {\n    table := getroutingtable()\n    for _, route := range table.routes {\n        if strings.hasprefix(path, route.path) {\n            return route.backend\n        }\n    }\n    return ""\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# æ»ç»\n\nåºç¨åºæ¯\n\n * è¯»å¤åå°ï¼éç½®ä¿¡æ¯ãè·¯ç±è¡¨ç­ä½é¢åæ´æ°æ®\n * é«æ§è½è¦æ±ï¼éè¦é¿åéç«äºçç­ç¹è·¯å¾\n\næ³¨æäºé¡¹\n\n * æ·±æ·è´ææ¬ï¼å½æ°æ®ç»æå¤ææ¶ï¼åµå¥map/sliceï¼ï¼éè¦èèæ·è´æ§è½\n * åå­æ¶èï¼æ¯æ¬¡æ´æ°é½ä¼åå»ºæ°å¯¹è±¡ï¼éæè¡¡åå­ä¸æ§è½\n * åå­æ§ä¿è¯ï¼æ´æ°æä½å¿é¡»å®å¨æ¿æ¢éç½®å¯¹è±¡ï¼é¿åé¨åæ´æ°',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:24:58",lastUpdatedTimestamp:1749918298e3},{title:"Goè¯­è¨åå­é¢åéå®å¨æå",frontmatter:{title:"Goè¯­è¨åå­é¢åéå®å¨æå",date:"2025-06-14T14:51:20.000Z",permalink:"/pages/d7dbc7/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨ä¸­SliceåMapçåå­é¢åéææ¯ï¼åå«æ§è½å¯¹æ¯æµè¯åå®éåºç¨åºæ¯åæ",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17584416417421758441641274.png"},{name:"twitter:title",content:"Goè¯­è¨åå­é¢åéå®å¨æå"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­SliceåMapçåå­é¢åéææ¯ï¼åå«æ§è½å¯¹æ¯æµè¯åå®éåºç¨åºæ¯åæ"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17584416417421758441641274.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/06.Go%E8%AF%AD%E8%A8%80%E5%86%85%E5%AD%98%E9%A2%84%E5%88%86%E9%85%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨åå­é¢åéå®å¨æå"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­SliceåMapçåå­é¢åéææ¯ï¼åå«æ§è½å¯¹æ¯æµè¯åå®éåºç¨åºæ¯åæ"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17584416417421758441641274.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/06.Go%E8%AF%AD%E8%A8%80%E5%86%85%E5%AD%98%E9%A2%84%E5%88%86%E9%85%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T14:51:20.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨åå­é¢åéå®å¨æå"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­SliceåMapçåå­é¢åéææ¯ï¼åå«æ§è½å¯¹æ¯æµè¯åå®éåºç¨åºæ¯åæ"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17584416417421758441641274.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/06.Go%E8%AF%AD%E8%A8%80%E5%86%85%E5%AD%98%E9%A2%84%E5%88%86%E9%85%8D%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/06.Goè¯­è¨åå­é¢åéå®å¨æå.md",key:"v-2bccd8fe",path:"/pages/d7dbc7/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"Slice é¢åé",slug:"slice-é¢åé",normalizedTitle:"slice é¢åé",charIndex:89},{level:2,title:"Benchmark",slug:"benchmark",normalizedTitle:"benchmark",charIndex:643},{level:2,title:"Map é¢åé",slug:"map-é¢åé",normalizedTitle:"map é¢åé",charIndex:1489},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:1668}],headersStr:"åè¨ Slice é¢åé Benchmark Map é¢åé æ»ç»",content:'# åè¨\n\nSlice å Map ä¼å¨æçæ©å±æ¥éç¨æ°çåç´ æ°éï¼ç©ºé´ä¸è¶³æ¶æ¯ä¼è¿è¡åéæ°çåå­ãå¤å¶ãä»¥åæ§åå­çåæ¶æä½ï¼èé¢ç¹çè°æ´å¤§å°çæä½ä¼æ¾èçéä½æ§è½ã\n\n\n# Slice é¢åé\n\næ²¡ææå®é¿åº¦çåå»ºä¸ä¸ªåçï¼ åçä¸æ­å°æ°å¢åç´ æ¶ï¼å¯ä»¥çå°å¶å®¹éä¹æ¯å¨ä¸æ­å°éå¢ï¼æä»¬ç¥éåççåºå±æ¯æ°ç»ï¼æ¯ä¸å¯åçï¼æä»¥å®ä¼ä¸æ­å°åå»ºçæ°çæ°ç»ï¼ç¶ååç´ çåå®¹å¤å¶å°æ°çæ°ç»ä¸­ï¼ä»èå¯¼è´åå­çåéãå¤å¶å GC çååã\n\n\n\nimport "fmt"\n\nfunc main() {\n\tvar result []int\n    s := make([]int, 0)\n\tfor i := 0; i < 1000; i++ {\n\t\ts = append(s, i)\n\t\tfmt.Printf("Len: %d, Cap: %d\\n", len(s), cap(s))\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nè¿è¡è¾åºï¼\n\nLen: 1, Cap: 1\nLen: 2, Cap: 2\nLen: 3, Cap: 4\nLen: 4, Cap: 4\nLen: 5, Cap: 8\n\n\n1\n2\n3\n4\n5\n\n\nèæä»¬æå®åççå¤§å°ï¼åå¯ä»¥é¿åä»¥ä¸ååã\n\nresult := make([]int, 0, 1000)\nfor i := 0; i < 10000; i++ {\n    result = append(result, i)\n}\n\n\n1\n2\n3\n4\n\n\n\n# Benchmark\n\nimport (\n\t"testing"\n)\n\nfunc BenchmarkAppendNoPrealloc(b *testing.B) {\n\tfor range b.N {\n\t\tvar s []int\n\t\tfor j := 0; j < 10000; j++ {\n\t\t\ts = append(s, j)\n\t\t}\n\t}\n}\n\nfunc BenchmarkAppendWithPrealloc(b *testing.B) {\n\tfor range b.N {\n\t\ts := make([]int, 0, 10000)\n\t\tfor j := 0; j < 10000; j++ {\n\t\t\ts = append(s, j)\n\t\t}\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå°ååéåå¤§äºï¼éåº¦å¿«äºè¿ 4 åï¼åå­åéçå¤§å°åæ¬¡æ°åå°äºã\n\n$ go test -bench=. -benchmem .                              \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkAppendNoPrealloc-12               44973             24788 ns/op          357628 B/op         19 allocs/op\nBenchmarkAppendWithPrealloc-12            185312              6448 ns/op           81920 B/op          1 allocs/op\nPASS\nok      main/demo       5.005s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# Map é¢åé\n\nMap åºå±æ¯ä¸ä¸ªåå¸è¡¨ï¼ä¹æ¯ä¸ä¸ªç±»ä¼¼äºæ°ç»çç»æï¼æä»¥æä»¬ä¹å¯ä»¥ä½¿ç¨makeæ¥å¯¹å¶è¿è¡å¤§å°çåå§åæä½ã\n\nm := make(map[int]string, 10000)\nfor i := 0; i < 10000; i++ {\n    m[i] = fmt.Sprintf("val-%d", i)\n}\n\n\n1\n2\n3\n4\n\n\n\n# æ»ç»\n\nåºç¨åºæ¯\n\n * Slice å Map çæ°éå·²ç¥æèå¯é¢æµæ¶ã\n * ç¨åºæ¯ä¸ä¸ªé«ååéæ°æ®å¤ççæå¡ã\n\næ³¨æäºé¡¹\n\næ°æ®æ°éååå¾å¤§ä¸å¯ä»¥é¢æµãè¿åº¦çåéä¼å¯¼è´å¤§éçåå­æµªè´¹ã',normalizedContent:'# åè¨\n\nslice å map ä¼å¨æçæ©å±æ¥éç¨æ°çåç´ æ°éï¼ç©ºé´ä¸è¶³æ¶æ¯ä¼è¿è¡åéæ°çåå­ãå¤å¶ãä»¥åæ§åå­çåæ¶æä½ï¼èé¢ç¹çè°æ´å¤§å°çæä½ä¼æ¾èçéä½æ§è½ã\n\n\n# slice é¢åé\n\næ²¡ææå®é¿åº¦çåå»ºä¸ä¸ªåçï¼ åçä¸æ­å°æ°å¢åç´ æ¶ï¼å¯ä»¥çå°å¶å®¹éä¹æ¯å¨ä¸æ­å°éå¢ï¼æä»¬ç¥éåççåºå±æ¯æ°ç»ï¼æ¯ä¸å¯åçï¼æä»¥å®ä¼ä¸æ­å°åå»ºçæ°çæ°ç»ï¼ç¶ååç´ çåå®¹å¤å¶å°æ°çæ°ç»ä¸­ï¼ä»èå¯¼è´åå­çåéãå¤å¶å gc çååã\n\n\n\nimport "fmt"\n\nfunc main() {\n\tvar result []int\n    s := make([]int, 0)\n\tfor i := 0; i < 1000; i++ {\n\t\ts = append(s, i)\n\t\tfmt.printf("len: %d, cap: %d\\n", len(s), cap(s))\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nè¿è¡è¾åºï¼\n\nlen: 1, cap: 1\nlen: 2, cap: 2\nlen: 3, cap: 4\nlen: 4, cap: 4\nlen: 5, cap: 8\n\n\n1\n2\n3\n4\n5\n\n\nèæä»¬æå®åççå¤§å°ï¼åå¯ä»¥é¿åä»¥ä¸ååã\n\nresult := make([]int, 0, 1000)\nfor i := 0; i < 10000; i++ {\n    result = append(result, i)\n}\n\n\n1\n2\n3\n4\n\n\n\n# benchmark\n\nimport (\n\t"testing"\n)\n\nfunc benchmarkappendnoprealloc(b *testing.b) {\n\tfor range b.n {\n\t\tvar s []int\n\t\tfor j := 0; j < 10000; j++ {\n\t\t\ts = append(s, j)\n\t\t}\n\t}\n}\n\nfunc benchmarkappendwithprealloc(b *testing.b) {\n\tfor range b.n {\n\t\ts := make([]int, 0, 10000)\n\t\tfor j := 0; j < 10000; j++ {\n\t\t\ts = append(s, j)\n\t\t}\n\t}\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå°ååéåå¤§äºï¼éåº¦å¿«äºè¿ 4 åï¼åå­åéçå¤§å°åæ¬¡æ°åå°äºã\n\n$ go test -bench=. -benchmem .                              \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkappendnoprealloc-12               44973             24788 ns/op          357628 b/op         19 allocs/op\nbenchmarkappendwithprealloc-12            185312              6448 ns/op           81920 b/op          1 allocs/op\npass\nok      main/demo       5.005s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# map é¢åé\n\nmap åºå±æ¯ä¸ä¸ªåå¸è¡¨ï¼ä¹æ¯ä¸ä¸ªç±»ä¼¼äºæ°ç»çç»æï¼æä»¥æä»¬ä¹å¯ä»¥ä½¿ç¨makeæ¥å¯¹å¶è¿è¡å¤§å°çåå§åæä½ã\n\nm := make(map[int]string, 10000)\nfor i := 0; i < 10000; i++ {\n    m[i] = fmt.sprintf("val-%d", i)\n}\n\n\n1\n2\n3\n4\n\n\n\n# æ»ç»\n\nåºç¨åºæ¯\n\n * slice å map çæ°éå·²ç¥æèå¯é¢æµæ¶ã\n * ç¨åºæ¯ä¸ä¸ªé«ååéæ°æ®å¤ççæå¡ã\n\næ³¨æäºé¡¹\n\næ°æ®æ°éååå¾å¤§ä¸å¯ä»¥é¢æµãè¿åº¦çåéä¼å¯¼è´å¤§éçåå­æµªè´¹ã',charsets:{cjk:!0},lastUpdated:"2025/09/22, 16:52:15",lastUpdatedTimestamp:1758531135e3},{title:"Goè¯­è¨åå­æä½å®å¨æå",frontmatter:{title:"Goè¯­è¨åå­æä½å®å¨æå",date:"2025-06-14T15:02:33.000Z",permalink:"/pages/821b25/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨åå­æä½çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨åå­æä½å®å¨æå"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨åå­æä½çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/07.Go%E8%AF%AD%E8%A8%80%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨åå­æä½å®å¨æå"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨åå­æä½çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/07.Go%E8%AF%AD%E8%A8%80%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T15:02:33.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨åå­æä½å®å¨æå"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨åå­æä½çå®ç°åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«è¯¦ç»åºåæµè¯æ°æ®åå®éåºç¨åºæ¯åæ"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/07.Go%E8%AF%AD%E8%A8%80%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/07.Goè¯­è¨åå­æä½å®å¨æå.md",key:"v-6dda71f1",path:"/pages/821b25/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"åå­æä½ vs äºæ¥é",slug:"åå­æä½-vs-äºæ¥é",normalizedTitle:"åå­æä½ vs äºæ¥é",charIndex:160},{level:2,title:"åå­æä½ä½¿ç¨åºæ¯",slug:"åå­æä½ä½¿ç¨åºæ¯",normalizedTitle:"åå­æä½ä½¿ç¨åºæ¯",charIndex:300},{level:3,title:"1. è®¡æ°å¨å®ç°",slug:"_1-è®¡æ°å¨å®ç°",normalizedTitle:"1. è®¡æ°å¨å®ç°",charIndex:313},{level:3,title:"2. ç¶ææ å¿æ§å¶",slug:"_2-ç¶ææ å¿æ§å¶",normalizedTitle:"2. ç¶ææ å¿æ§å¶",charIndex:551},{level:3,title:"3. åæ¬¡åå§å(æ¿ä»£sync.Once)",slug:"_3-åæ¬¡åå§å-æ¿ä»£sync-once",normalizedTitle:"3. åæ¬¡åå§å(æ¿ä»£sync.once)",charIndex:785},{level:3,title:"4. æ éæ æ°æ®ç»æå®ç°",slug:"_4-æ éæ æ°æ®ç»æå®ç°",normalizedTitle:"4. æ éæ æ°æ®ç»æå®ç°",charIndex:975},{level:2,title:"æ§è½å¯¹æ¯æµè¯",slug:"æ§è½å¯¹æ¯æµè¯",normalizedTitle:"æ§è½å¯¹æ¯æµè¯",charIndex:1273},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:2117}],headersStr:"åè¨ åå­æä½ vs äºæ¥é åå­æä½ä½¿ç¨åºæ¯ 1. è®¡æ°å¨å®ç° 2. ç¶ææ å¿æ§å¶ 3. åæ¬¡åå§å(æ¿ä»£sync.Once) 4. æ éæ æ°æ®ç»æå®ç° æ§è½å¯¹æ¯æµè¯ æ»ç»",content:"# åè¨\n\nåå­æä½æ¯æä¸å¯ä¸­æ­çä¸ä¸ªæä¸ç³»åæä½ï¼è¿äºæä½è¦ä¹å¨é¨æ§è¡æåï¼è¦ä¹å¨é¨ä¸æ§è¡ãå¨Goè¯­è¨ä¸­ï¼éè¿sync/atomicåæä¾åå­æä½æ¯æãåè®¸å¨ä¸éç¨äºæ¥éçæåµä¸å®å¨å°å¹¶åè®¿é®å±äº«æ°æ®ï¼å éä¼å¼å¥åè°å¼éï¼æ§è½å¯è½ä¼ä¸éï¼èåå­æä½ä½¿ç¨ CPU æä»¤ç´æ¥å¨ç¡¬ä»¶å±é¢è¿è¡æä½ï¼ä»èææ´é«çæ§è½ã\n\n\n# åå­æä½ vs äºæ¥é\n\nç¹æ§     åå­æä½           äºæ¥é\næ§è½     æ´é«(CPUæä»¤çº§æ¯æ)   è¾ä½(éè¦ç³»ç»è°ç¨)\nä½¿ç¨åºæ¯   ç®ååå­æä½         å¤æä»£ç åä¿æ¤\nå¯æä½æ§   æé(ä»æ¯æåºæ¬ç±»å)    çµæ´»(å¯ä¿æ¤ä»»æä»£ç )\n\n\n# åå­æä½ä½¿ç¨åºæ¯\n\n\n# 1. è®¡æ°å¨å®ç°\n\nvar requestCount atomic.Int64 // Go 1.19+æ°çAPI\n\n// å¤çè¯·æ±æ¶å®å¨éå¢è®¡æ°å¨\nfunc HandleRequest() {\n    requestCount.Add(1) // åå­éå¢\n}\n\n// è·åå½åè¯·æ±æ°\nfunc GetRequestCount() int64 {\n    return requestCount.Load()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 2. ç¶ææ å¿æ§å¶\n\nvar shutdown atomic.Int32\n\nfunc mainLoop() {\n    for {\n        if shutdown.Load() == 1 {\n            break\n        }\n        // do work\n    }\n}\n\nfunc stop() {\n    shutdown.Store(1)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# 3. åæ¬¡åå§å(æ¿ä»£sync.Once)\n\nvar initialized atomic.Int32\n\nfunc maybeInit() {\n    if initialized.CompareAndSwap(0, 1) {\n        // åªæç¬¬ä¸ä¸ªè°ç¨èä¼æ§è¡è¿é\n    }\n\n    // å¶ä»è°ç¨èç´æ¥è¿å\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 4. æ éæ æ°æ®ç»æå®ç°\n\ntype node struct {\n    next *node\n    val  any\n}\n\nvar head atomic.Pointer[node]\n\nfunc push(n *node) {\n    for {\n        old := head.Load()\n        n.next = old\n        if head.CompareAndSwap(old, n) {\n            return\n        }\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# æ§è½å¯¹æ¯æµè¯\n\néå¯¹ä½¿ç¨äºæ¥éååå­æä½ç Benchmark\n\nfunc BenchmarkAtomicIncrement(b *testing.B) {\n\tvar counter atomic.Int64\n\tb.RunParallel(func(pb *testing.PB) {\n\t\tfor pb.Next() {\n\t\t\tcounter.Add(1)\n\t\t}\n\t})\n}\n\nfunc BenchmarkMutexIncrement(b *testing.B) {\n\tvar (\n\t\tcounter int64\n\t\tmu      sync.Mutex\n\t)\n\tb.RunParallel(func(pb *testing.PB) {\n\t\tfor pb.Next() {\n\t\t\tmu.Lock()\n\t\t\tcounter++\n\t\t\tmu.Unlock()\n\t\t}\n\t})\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¿è¡ç»æå¦ä¸ï¼åå­æä½è¦æ¯å äºæ¥éå¿«ä¸çº¦ 40%ã\n\n$ go test  -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkAtomicIncrement-12     22237474                55.00 ns/op            0 B/op          0 allocs/op\nBenchmarkMutexIncrement-12      13650686                84.53 ns/op            0 B/op          0 allocs/op\nPASS\nok      main/demo       2.841s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# æ»ç»\n\n * ä¼åä½¿ç¨åå­æä½çåºæ¯ï¼\n   \n   * è®¡æ°å¨ãç¶ææ å¿ç­ç®åå±äº«åé\n   * æ§è½ææçå¹¶åæ§å¶\n   * æ éæ°æ®ç»æå®ç°\n\n * éè¦ä½¿ç¨äºæ¥éçåºæ¯ï¼\n   \n   * ä¿æ¤å¤æé»è¾ä»£ç å\n   * éè¦ä¿æ¤å¤ä¸ªåéçä¸å\n   * æ§è¡IOæä½ç­èæ¶ä»»å¡æ¶",normalizedContent:"# åè¨\n\nåå­æä½æ¯æä¸å¯ä¸­æ­çä¸ä¸ªæä¸ç³»åæä½ï¼è¿äºæä½è¦ä¹å¨é¨æ§è¡æåï¼è¦ä¹å¨é¨ä¸æ§è¡ãå¨goè¯­è¨ä¸­ï¼éè¿sync/atomicåæä¾åå­æä½æ¯æãåè®¸å¨ä¸éç¨äºæ¥éçæåµä¸å®å¨å°å¹¶åè®¿é®å±äº«æ°æ®ï¼å éä¼å¼å¥åè°å¼éï¼æ§è½å¯è½ä¼ä¸éï¼èåå­æä½ä½¿ç¨ cpu æä»¤ç´æ¥å¨ç¡¬ä»¶å±é¢è¿è¡æä½ï¼ä»èææ´é«çæ§è½ã\n\n\n# åå­æä½ vs äºæ¥é\n\nç¹æ§     åå­æä½           äºæ¥é\næ§è½     æ´é«(cpuæä»¤çº§æ¯æ)   è¾ä½(éè¦ç³»ç»è°ç¨)\nä½¿ç¨åºæ¯   ç®ååå­æä½         å¤æä»£ç åä¿æ¤\nå¯æä½æ§   æé(ä»æ¯æåºæ¬ç±»å)    çµæ´»(å¯ä¿æ¤ä»»æä»£ç )\n\n\n# åå­æä½ä½¿ç¨åºæ¯\n\n\n# 1. è®¡æ°å¨å®ç°\n\nvar requestcount atomic.int64 // go 1.19+æ°çapi\n\n// å¤çè¯·æ±æ¶å®å¨éå¢è®¡æ°å¨\nfunc handlerequest() {\n    requestcount.add(1) // åå­éå¢\n}\n\n// è·åå½åè¯·æ±æ°\nfunc getrequestcount() int64 {\n    return requestcount.load()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 2. ç¶ææ å¿æ§å¶\n\nvar shutdown atomic.int32\n\nfunc mainloop() {\n    for {\n        if shutdown.load() == 1 {\n            break\n        }\n        // do work\n    }\n}\n\nfunc stop() {\n    shutdown.store(1)\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\n\n# 3. åæ¬¡åå§å(æ¿ä»£sync.once)\n\nvar initialized atomic.int32\n\nfunc maybeinit() {\n    if initialized.compareandswap(0, 1) {\n        // åªæç¬¬ä¸ä¸ªè°ç¨èä¼æ§è¡è¿é\n    }\n\n    // å¶ä»è°ç¨èç´æ¥è¿å\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 4. æ éæ æ°æ®ç»æå®ç°\n\ntype node struct {\n    next *node\n    val  any\n}\n\nvar head atomic.pointer[node]\n\nfunc push(n *node) {\n    for {\n        old := head.load()\n        n.next = old\n        if head.compareandswap(old, n) {\n            return\n        }\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# æ§è½å¯¹æ¯æµè¯\n\néå¯¹ä½¿ç¨äºæ¥éååå­æä½ç benchmark\n\nfunc benchmarkatomicincrement(b *testing.b) {\n\tvar counter atomic.int64\n\tb.runparallel(func(pb *testing.pb) {\n\t\tfor pb.next() {\n\t\t\tcounter.add(1)\n\t\t}\n\t})\n}\n\nfunc benchmarkmutexincrement(b *testing.b) {\n\tvar (\n\t\tcounter int64\n\t\tmu      sync.mutex\n\t)\n\tb.runparallel(func(pb *testing.pb) {\n\t\tfor pb.next() {\n\t\t\tmu.lock()\n\t\t\tcounter++\n\t\t\tmu.unlock()\n\t\t}\n\t})\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¿è¡ç»æå¦ä¸ï¼åå­æä½è¦æ¯å äºæ¥éå¿«ä¸çº¦ 40%ã\n\n$ go test  -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkatomicincrement-12     22237474                55.00 ns/op            0 b/op          0 allocs/op\nbenchmarkmutexincrement-12      13650686                84.53 ns/op            0 b/op          0 allocs/op\npass\nok      main/demo       2.841s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# æ»ç»\n\n * ä¼åä½¿ç¨åå­æä½çåºæ¯ï¼\n   \n   * è®¡æ°å¨ãç¶ææ å¿ç­ç®åå±äº«åé\n   * æ§è½ææçå¹¶åæ§å¶\n   * æ éæ°æ®ç»æå®ç°\n\n * éè¦ä½¿ç¨äºæ¥éçåºæ¯ï¼\n   \n   * ä¿æ¤å¤æé»è¾ä»£ç å\n   * éè¦ä¿æ¤å¤ä¸ªåéçä¸å\n   * æ§è¡ioæä½ç­èæ¶ä»»å¡æ¶",charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ",frontmatter:{title:"Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ",date:"2025-06-14T17:30:57.000Z",permalink:"/pages/c19d45/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨å æ åéæºå¶ä¸éé¸åæåçï¼åå«æ§è½å¯¹æ¯æµè¯åå®éä¼åå»ºè®®",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨å æ åéæºå¶ä¸éé¸åæåçï¼åå«æ§è½å¯¹æ¯æµè¯åå®éä¼åå»ºè®®"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/08.Go%E8%AF%AD%E8%A8%80%E5%A0%86%E6%A0%88%E5%88%86%E9%85%8D%E4%B8%8E%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨å æ åéæºå¶ä¸éé¸åæåçï¼åå«æ§è½å¯¹æ¯æµè¯åå®éä¼åå»ºè®®"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/08.Go%E8%AF%AD%E8%A8%80%E5%A0%86%E6%A0%88%E5%88%86%E9%85%8D%E4%B8%8E%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T17:30:57.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨å æ åéæºå¶ä¸éé¸åæåçï¼åå«æ§è½å¯¹æ¯æµè¯åå®éä¼åå»ºè®®"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/08.Go%E8%AF%AD%E8%A8%80%E5%A0%86%E6%A0%88%E5%88%86%E9%85%8D%E4%B8%8E%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/08.Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ.md",key:"v-ccb4316a",path:"/pages/c19d45/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:3,title:"1.1 ä¸ºä»ä¹éè¦å³æ³¨å æ åéï¼",slug:"_1-1-ä¸ºä»ä¹éè¦å³æ³¨å æ åé",normalizedTitle:"1.1 ä¸ºä»ä¹éè¦å³æ³¨å æ åéï¼",charIndex:12},{level:3,title:"1.2 ä»ä¹æ¯éé¸åæï¼",slug:"_1-2-ä»ä¹æ¯éé¸åæ",normalizedTitle:"1.2 ä»ä¹æ¯éé¸åæï¼",charIndex:166},{level:2,title:"2. éé¸åæå®æ",slug:"_2-éé¸åæå®æ",normalizedTitle:"2. éé¸åæå®æ",charIndex:243},{level:3,title:"2.1 å¦ä½æ¥çéé¸åæç»æ",slug:"_2-1-å¦ä½æ¥çéé¸åæç»æ",normalizedTitle:"2.1 å¦ä½æ¥çéé¸åæç»æ",charIndex:257},{level:3,title:"2.2å¸¸è§çéé¸åºæ¯",slug:"_2-2å¸¸è§çéé¸åºæ¯",normalizedTitle:"2.2å¸¸è§çéé¸åºæ¯",charIndex:542},{level:2,title:"3. å ä¸æ çæ§è½åºåæµè¯",slug:"_3-å ä¸æ çæ§è½åºåæµè¯",normalizedTitle:"3. å ä¸æ çæ§è½åºåæµè¯",charIndex:1106},{level:2,title:"4. æä½³å®è·µ",slug:"_4-æä½³å®è·µ",normalizedTitle:"4. æä½³å®è·µ",charIndex:2892},{level:3,title:"4.1 ä¼åæ åéåºæ¯",slug:"_4-1-ä¼åæ åéåºæ¯",normalizedTitle:"4.1 ä¼åæ åéåºæ¯",charIndex:2904},{level:3,title:"4.2 ä¸å¿å¼ºæ±æ åéçåºæ¯",slug:"_4-2-ä¸å¿å¼ºæ±æ åéçåºæ¯",normalizedTitle:"4.2 ä¸å¿å¼ºæ±æ åéçåºæ¯",charIndex:2959},{level:2,title:"5. æ»ç»",slug:"_5-æ»ç»",normalizedTitle:"5. æ»ç»",charIndex:3044}],headersStr:"1. åè¨ 1.1 ä¸ºä»ä¹éè¦å³æ³¨å æ åéï¼ 1.2 ä»ä¹æ¯éé¸åæï¼ 2. éé¸åæå®æ 2.1 å¦ä½æ¥çéé¸åæç»æ 2.2å¸¸è§çéé¸åºæ¯ 3. å ä¸æ çæ§è½åºåæµè¯ 4. æä½³å®è·µ 4.1 ä¼åæ åéåºæ¯ 4.2 ä¸å¿å¼ºæ±æ åéçåºæ¯ 5. æ»ç»",content:'# 1. åè¨\n\n\n# 1.1 ä¸ºä»ä¹éè¦å³æ³¨å æ åéï¼\n\nå¨Goè¯­è¨ä¸­ï¼åå­åéä¸»è¦æä¸¤ç§æ¹å¼ï¼\n\n * æ åéï¼è½»éå¿«éï¼å½æ°ç»ææ¶èªå¨éæ¾ï¼ä¸äº§çåå¾\n * å åéï¼éè¦åå¾åæ¶(GC)åä¸ï¼å¼éè¾å¤§\n\nå³é®åºå«ï¼\n\n * æ åéæ¯å åéå¿«10-100å\n * æ åéä¸ä¼å¢å GCåå\n * å åéçå¯¹è±¡çå½å¨ææ´é¿\n\n\n# 1.2 ä»ä¹æ¯éé¸åæï¼\n\néé¸åææ¯Goç¼è¯å¨å¨ç¼è¯æ¶è¿è¡çä¸ç§ä¼åææ¯ï¼å®ä¼åæåéççå½å¨æåä½¿ç¨æ¹å¼ï¼èªå¨å³å®å°åéåéå¨æ ä¸è¿æ¯å ä¸ã\n\n\n# 2. éé¸åæå®æ\n\n\n# 2.1 å¦ä½æ¥çéé¸åæç»æ\n\nå¨ä¸é¢ä»£ç ä¸­ï¼å°xçåéçå°åè¿ååºå»äºï¼è¿ä¸ªæ¶åä¼å°xæ¾å°å ä¸ã\n\nfunc allocate() *int {\n\tx := 42\n\treturn &x // x escapes to the heap\n}\n\nfunc main() {\n\tallocate()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\néè¿æ·»å åæ°-gcflags="-m"å¯ä»¥çå°å¦ä¸éé¸çä¿¡æ¯\n\n$ go build -gcflags="-m"  main.go\n...\n./main.go:4:2: moved to heap: x\n\n\n1\n2\n3\n\n\n\n# 2.2å¸¸è§çéé¸åºæ¯\n\n 1. è¿åå±é¨åéæé\n\nfunc escape() *int {\n    x := 10\n    return &x // escapes\n}\n\n\n1\n2\n3\n4\n\n 2. é­åä½¿ç¨å±é¨åé\n\nfunc closureEscape() func() int {\n    x := 5\n    return func() int { return x } // x escapes\n}\n\n\n1\n2\n3\n4\n\n 3. æ¥å£ç±»åè½¬æ¢\n\nfunc toInterface(i int) interface{} {\n    return i // escapes if type info needed at runtime\n}\n\n\n1\n2\n3\n\n 4. å¨å±åéèµå¼\n\nvar global *int\n\nfunc assignGlobal() {\n    x := 7\n    global = &x // escapes\n}\n\n\n1\n2\n3\n4\n5\n6\n\n 5. å¤§å°ºå¯¸å¯¹è±¡\n\nfunc makeLargeSlice() []int {\n    s := make([]int, 10000) // may escape due to size\n    return s\n}\n\n\n1\n2\n3\n4\n\n\n\n# 3. å ä¸æ çæ§è½åºåæµè¯\n\ntype Data struct {\n\tA, B, C int\n}\n\n// æ åé\nfunc StackAlloc() Data {\n    return Data{1, 2, 3} // stays on stack\n}\n\n// å åé\nfunc HeapAlloc() *Data {\n    return &Data{1, 2, 3} // escapes to heap\n}\n\nfunc BenchmarkStackAlloc(b *testing.B) {\n    for b.Loop() {\n        _ = StackAlloc()\n    }\n}\n\nfunc BenchmarkHeapAlloc(b *testing.B) {\n    for b.Loop() {\n        _ = HeapAlloc()\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\néè¿è¿è¡ä¼åç°ä¸¤èåºå«å¹¶ä¸å¤§ï¼èä¸ç«ç¶æ²¡æå çç³è¯·ãè¿æ¯å ä¸ºç¼è¯å¨å¾èªæï¼å®åç°éè¿HeapAllocè¿åçæéæ²¡æä»»ä½æä¹ï¼æä»¥ä¹å°±æå®æ¾å¨äºæ ä¸ã\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkStackAlloc-12          1000000000               0.2373 ns/op          0 B/op          0 allocs/op\nBenchmarkHeapAlloc-12           1000000000               0.2253 ns/op          0 B/op          0 allocs/op\nPASS\nok      main/demo       1.176s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\næéè¦å¼ºå¶è®©å®åéå°å ä¸ï¼ä½¿ç¨å¨å±èµå¼ï¼ä¿®æ¹ä»£ç åå¦ä¸\n\ntype Data struct {\n\tA, B, C int\n}\n\nvar sink *Data\n\nfunc HeapAllocEscape() {\n\td := &Data{1, 2, 3}\n\tsink = d // d escapes to heap\n}\n\nfunc StackAlloc() Data {\n\treturn Data{1, 2, 3} // stays on stack\n}\n\nfunc BenchmarkStackAlloc(b *testing.B) {\n\tfor range b.N {\n\t\t_ = StackAlloc()\n\t}\n}\n\nfunc BenchmarkHeapAlloc(b *testing.B) {\n\tfor range b.N {\n\t\tHeapAllocEscape()\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\nè¿è¡ç»æå¦ä¸ï¼ä½¿ç¨å å­å¨çå¼éï¼35åçæ¢è°ç¨ï¼24 å­èçåéå 1 æ¬¡åå¾åæ¶çå¯¹è±¡ã\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkStackAlloc-12          1000000000               0.2285 ns/op          0 B/op          0 allocs/op\nBenchmarkHeapAlloc-12           147388731                8.117 ns/op          24 B/op          1 allocs/op\nPASS\nok      main/demo       3.064s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 4. æä½³å®è·µ\n\n\n# 4.1 ä¼åæ åéåºæ¯\n\n * GC ååå¤§çæ¶å\n * å¯¹äºç­æçå°å¯¹è±¡\n * é«é¢è°ç¨çå½æ°åé¨\n\n\n# 4.2 ä¸å¿å¼ºæ±æ åéçåºæ¯\n\n * å·¥åæ¹æ³è¿åå¯¹è±¡æé(Goæ¯ç¨æ³)\n * å¯¹è±¡éè¦è·¨å½æ°çå½å¨æã\n * ä¸é¢ç¹åå»ºçå°å¯¹è±¡\n * ä¼åä¼å½±åä»£ç å¯è¯»æ§æ¶\n\n\n# 5. æ»ç»\n\n 1. éé¸åææ¯Goçéè¦ä¼åææ®µï¼èªå¨å³å®åéåéä½ç½®ã\n 2. æ åéæ§è½ä¼å¿ææ¾ï¼éåç­çå½å¨æå¯¹è±¡ã\n 3. å åéè½ç¶è¾æ¢ï¼ä½å¨æäºåºæ¯ä¸æ¯å¿è¦ä¸åççã\n 4. ä¼åæ¶è¦å¹³è¡¡æ§è½ä¸ä»£ç è´¨éï¼é¿åè¿åº¦ä¼åã',normalizedContent:'# 1. åè¨\n\n\n# 1.1 ä¸ºä»ä¹éè¦å³æ³¨å æ åéï¼\n\nå¨goè¯­è¨ä¸­ï¼åå­åéä¸»è¦æä¸¤ç§æ¹å¼ï¼\n\n * æ åéï¼è½»éå¿«éï¼å½æ°ç»ææ¶èªå¨éæ¾ï¼ä¸äº§çåå¾\n * å åéï¼éè¦åå¾åæ¶(gc)åä¸ï¼å¼éè¾å¤§\n\nå³é®åºå«ï¼\n\n * æ åéæ¯å åéå¿«10-100å\n * æ åéä¸ä¼å¢å gcåå\n * å åéçå¯¹è±¡çå½å¨ææ´é¿\n\n\n# 1.2 ä»ä¹æ¯éé¸åæï¼\n\néé¸åææ¯goç¼è¯å¨å¨ç¼è¯æ¶è¿è¡çä¸ç§ä¼åææ¯ï¼å®ä¼åæåéççå½å¨æåä½¿ç¨æ¹å¼ï¼èªå¨å³å®å°åéåéå¨æ ä¸è¿æ¯å ä¸ã\n\n\n# 2. éé¸åæå®æ\n\n\n# 2.1 å¦ä½æ¥çéé¸åæç»æ\n\nå¨ä¸é¢ä»£ç ä¸­ï¼å°xçåéçå°åè¿ååºå»äºï¼è¿ä¸ªæ¶åä¼å°xæ¾å°å ä¸ã\n\nfunc allocate() *int {\n\tx := 42\n\treturn &x // x escapes to the heap\n}\n\nfunc main() {\n\tallocate()\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\néè¿æ·»å åæ°-gcflags="-m"å¯ä»¥çå°å¦ä¸éé¸çä¿¡æ¯\n\n$ go build -gcflags="-m"  main.go\n...\n./main.go:4:2: moved to heap: x\n\n\n1\n2\n3\n\n\n\n# 2.2å¸¸è§çéé¸åºæ¯\n\n 1. è¿åå±é¨åéæé\n\nfunc escape() *int {\n    x := 10\n    return &x // escapes\n}\n\n\n1\n2\n3\n4\n\n 2. é­åä½¿ç¨å±é¨åé\n\nfunc closureescape() func() int {\n    x := 5\n    return func() int { return x } // x escapes\n}\n\n\n1\n2\n3\n4\n\n 3. æ¥å£ç±»åè½¬æ¢\n\nfunc tointerface(i int) interface{} {\n    return i // escapes if type info needed at runtime\n}\n\n\n1\n2\n3\n\n 4. å¨å±åéèµå¼\n\nvar global *int\n\nfunc assignglobal() {\n    x := 7\n    global = &x // escapes\n}\n\n\n1\n2\n3\n4\n5\n6\n\n 5. å¤§å°ºå¯¸å¯¹è±¡\n\nfunc makelargeslice() []int {\n    s := make([]int, 10000) // may escape due to size\n    return s\n}\n\n\n1\n2\n3\n4\n\n\n\n# 3. å ä¸æ çæ§è½åºåæµè¯\n\ntype data struct {\n\ta, b, c int\n}\n\n// æ åé\nfunc stackalloc() data {\n    return data{1, 2, 3} // stays on stack\n}\n\n// å åé\nfunc heapalloc() *data {\n    return &data{1, 2, 3} // escapes to heap\n}\n\nfunc benchmarkstackalloc(b *testing.b) {\n    for b.loop() {\n        _ = stackalloc()\n    }\n}\n\nfunc benchmarkheapalloc(b *testing.b) {\n    for b.loop() {\n        _ = heapalloc()\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\néè¿è¿è¡ä¼åç°ä¸¤èåºå«å¹¶ä¸å¤§ï¼èä¸ç«ç¶æ²¡æå çç³è¯·ãè¿æ¯å ä¸ºç¼è¯å¨å¾èªæï¼å®åç°éè¿heapallocè¿åçæéæ²¡æä»»ä½æä¹ï¼æä»¥ä¹å°±æå®æ¾å¨äºæ ä¸ã\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkstackalloc-12          1000000000               0.2373 ns/op          0 b/op          0 allocs/op\nbenchmarkheapalloc-12           1000000000               0.2253 ns/op          0 b/op          0 allocs/op\npass\nok      main/demo       1.176s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\næéè¦å¼ºå¶è®©å®åéå°å ä¸ï¼ä½¿ç¨å¨å±èµå¼ï¼ä¿®æ¹ä»£ç åå¦ä¸\n\ntype data struct {\n\ta, b, c int\n}\n\nvar sink *data\n\nfunc heapallocescape() {\n\td := &data{1, 2, 3}\n\tsink = d // d escapes to heap\n}\n\nfunc stackalloc() data {\n\treturn data{1, 2, 3} // stays on stack\n}\n\nfunc benchmarkstackalloc(b *testing.b) {\n\tfor range b.n {\n\t\t_ = stackalloc()\n\t}\n}\n\nfunc benchmarkheapalloc(b *testing.b) {\n\tfor range b.n {\n\t\theapallocescape()\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n\n\nè¿è¡ç»æå¦ä¸ï¼ä½¿ç¨å å­å¨çå¼éï¼35åçæ¢è°ç¨ï¼24 å­èçåéå 1 æ¬¡åå¾åæ¶çå¯¹è±¡ã\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkstackalloc-12          1000000000               0.2285 ns/op          0 b/op          0 allocs/op\nbenchmarkheapalloc-12           147388731                8.117 ns/op          24 b/op          1 allocs/op\npass\nok      main/demo       3.064s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 4. æä½³å®è·µ\n\n\n# 4.1 ä¼åæ åéåºæ¯\n\n * gc ååå¤§çæ¶å\n * å¯¹äºç­æçå°å¯¹è±¡\n * é«é¢è°ç¨çå½æ°åé¨\n\n\n# 4.2 ä¸å¿å¼ºæ±æ åéçåºæ¯\n\n * å·¥åæ¹æ³è¿åå¯¹è±¡æé(goæ¯ç¨æ³)\n * å¯¹è±¡éè¦è·¨å½æ°çå½å¨æã\n * ä¸é¢ç¹åå»ºçå°å¯¹è±¡\n * ä¼åä¼å½±åä»£ç å¯è¯»æ§æ¶\n\n\n# 5. æ»ç»\n\n 1. éé¸åææ¯goçéè¦ä¼åææ®µï¼èªå¨å³å®åéåéä½ç½®ã\n 2. æ åéæ§è½ä¼å¿ææ¾ï¼éåç­çå½å¨æå¯¹è±¡ã\n 3. å åéè½ç¶è¾æ¢ï¼ä½å¨æäºåºæ¯ä¸æ¯å¿è¦ä¸åççã\n 4. ä¼åæ¶è¦å¹³è¡¡æ§è½ä¸ä»£ç è´¨éï¼é¿åè¿åº¦ä¼åã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:24:58",lastUpdatedTimestamp:1749918298e3},{title:"Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨",frontmatter:{title:"Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨",date:"2025-06-14T19:41:46.000Z",permalink:"/pages/df4833/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨ç©ºç»æä½çç¹æ§åå¶å¨é«æ§è½åºæ¯ä¸çåºç¨å®è·µ",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨ç©ºç»æä½çç¹æ§åå¶å¨é«æ§è½åºæ¯ä¸çåºç¨å®è·µ"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/09.Go%E8%AF%AD%E8%A8%80%E7%A9%BA%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A%E9%9B%B6%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E7%9A%84%E9%AB%98%E6%95%88%E7%BC%96%E7%A8%8B.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨ç©ºç»æä½çç¹æ§åå¶å¨é«æ§è½åºæ¯ä¸çåºç¨å®è·µ"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/09.Go%E8%AF%AD%E8%A8%80%E7%A9%BA%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A%E9%9B%B6%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E7%9A%84%E9%AB%98%E6%95%88%E7%BC%96%E7%A8%8B.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T19:41:46.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨ç©ºç»æä½çç¹æ§åå¶å¨é«æ§è½åºæ¯ä¸çåºç¨å®è·µ"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/09.Go%E8%AF%AD%E8%A8%80%E7%A9%BA%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A%E9%9B%B6%E5%86%85%E5%AD%98%E6%B6%88%E8%80%97%E7%9A%84%E9%AB%98%E6%95%88%E7%BC%96%E7%A8%8B.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/09.Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨.md",key:"v-3b2ad750",path:"/pages/df4833/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:2,title:"2. åºç¨åºæ¯",slug:"_2-åºç¨åºæ¯",normalizedTitle:"2. åºç¨åºæ¯",charIndex:111},{level:3,title:"2.1 å®ç° Set æ°æ®ç»æ",slug:"_2-1-å®ç°-set-æ°æ®ç»æ",normalizedTitle:"2.1 å®ç° set æ°æ®ç»æ",charIndex:123},{level:3,title:"2.2 ä½ä¸ºchannelçä¿¡å·",slug:"_2-2-ä½ä¸ºchannelçä¿¡å·",normalizedTitle:"2.2 ä½ä¸ºchannelçä¿¡å·",charIndex:619},{level:3,title:"2.3 ä»åå«æ¹æ³çç»æä½",slug:"_2-3-ä»åå«æ¹æ³çç»æä½",normalizedTitle:"2.3 ä»åå«æ¹æ³çç»æä½",charIndex:956},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:1313}],headersStr:"1. åè¨ 2. åºç¨åºæ¯ 2.1 å®ç° Set æ°æ®ç»æ 2.2 ä½ä¸ºchannelçä¿¡å· 2.3 ä»åå«æ¹æ³çç»æä½ 3. æ»ç»",content:'# 1. åè¨\n\nç©ºç»æä½ä¸å ç¨ä»»ä½åå­ç©ºé´ï¼ææç©ºç»æä½å®ä¾å±äº«ç¸åçåå­å°åãè¿ç§ç¹æ§ä½¿å¶æä¸ºGoè¯­è¨ä¸­å®ç°é«ææ°æ®ç»æåå¹¶åæ¨¡å¼ççæ³éæ©ãæ¬æå°æ·±å¥æ¢è®¨ç©ºç»æä½çå·¥ä½åçåå¶å¨é«æ§è½ç¼ç¨ä¸­çå¸ååºç¨åºæ¯ã\n\n\n# 2. åºç¨åºæ¯\n\n\n# 2.1 å®ç° Set æ°æ®ç»æ\n\nGoæ ååºæ²¡æSetç±»åï¼ä½å¯ä»¥ç¨map[T]struct{}é«æå®ç°ï¼\n\ntype Set map[string]struct{}\n\n// æ£æ¥åç´ æ¯å¦å­å¨\nfunc (s Set) Has(key string) bool {\n\t_, ok := s[key]\n\treturn ok\n}\n\n// æ·»å åç´ \nfunc (s Set) Add(key string) {\n\ts[key] = struct{}{}\n}\n\n// å é¤åç´ \nfunc (s Set) Delete(key string) {\n\tdelete(s, key)\n}\n\nfunc main() {\n\ts := make(Set)\n\ts.Add("Tom")\n\ts.Add("Sam")\n\tfmt.Println(s.Has("Tom"))   // true\n\tfmt.Println(s.Has("Jack"))  // false\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\n\n# 2.2 ä½ä¸ºchannelçä¿¡å·\n\nç©ºç»æä½å¸¸ç¨äºchanneléä¿¡ï¼è¡¨ç¤ºçº¯ä¿¡å·éç¥ï¼\n\nfunc worker(done chan struct{}) {\n    // æ¨¡æå·¥ä½\n    time.Sleep(time.Second)\n    \n    // åéå®æä¿¡å·\n    done <- struct{}{}\n}\n\nfunc main() {\n    done := make(chan struct{})\n    go worker(done)\n    \n    // ç­å¾å·¥ä½å®æ\n    <-done\n    fmt.Println("Work done")\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# 2.3 ä»åå«æ¹æ³çç»æä½\n\nå½åªéè¦æ¹æ³ä¸éè¦å­å¨æ°æ®æ¶ï¼\n\ntype Logger struct{} // ä¸éè¦ç¶æå­å¨\n\nfunc (l Logger) Info(msg string) {\n    fmt.Printf("[INFO] %s\\n", msg)\n}\n\nfunc (l Logger) Error(msg string) {\n    fmt.Printf("[ERROR] %s\\n", msg)\n}\n\nfunc main() {\n    var log Logger\n    log.Info("System started")\n    log.Error("Connection failed")\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\n\n# 3. æ»ç»\n\nç©ºç»æä½æ¯Goè¯­è¨ä¸­å®ç°é«æ§è½ä»£ç çéè¦å·¥å·ï¼ç¹å«éç¨äºï¼\n\n 1. éè¦éåè¯­ä¹ä½ä¸éè¦å­å¨æ°æ®çåºæ¯\n 2. çº¯ä¿¡å·éç¥çå¹¶åéä¿¡\n 3. æ ç¶æçæ¹æ³éå\n\nåçä½¿ç¨ç©ºç»æä½å¯ä»¥æ¾èéä½åå­å ç¨ï¼æåç¨åºæ§è½ã',normalizedContent:'# 1. åè¨\n\nç©ºç»æä½ä¸å ç¨ä»»ä½åå­ç©ºé´ï¼ææç©ºç»æä½å®ä¾å±äº«ç¸åçåå­å°åãè¿ç§ç¹æ§ä½¿å¶æä¸ºgoè¯­è¨ä¸­å®ç°é«ææ°æ®ç»æåå¹¶åæ¨¡å¼ççæ³éæ©ãæ¬æå°æ·±å¥æ¢è®¨ç©ºç»æä½çå·¥ä½åçåå¶å¨é«æ§è½ç¼ç¨ä¸­çå¸ååºç¨åºæ¯ã\n\n\n# 2. åºç¨åºæ¯\n\n\n# 2.1 å®ç° set æ°æ®ç»æ\n\ngoæ ååºæ²¡æsetç±»åï¼ä½å¯ä»¥ç¨map[t]struct{}é«æå®ç°ï¼\n\ntype set map[string]struct{}\n\n// æ£æ¥åç´ æ¯å¦å­å¨\nfunc (s set) has(key string) bool {\n\t_, ok := s[key]\n\treturn ok\n}\n\n// æ·»å åç´ \nfunc (s set) add(key string) {\n\ts[key] = struct{}{}\n}\n\n// å é¤åç´ \nfunc (s set) delete(key string) {\n\tdelete(s, key)\n}\n\nfunc main() {\n\ts := make(set)\n\ts.add("tom")\n\ts.add("sam")\n\tfmt.println(s.has("tom"))   // true\n\tfmt.println(s.has("jack"))  // false\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\n\n# 2.2 ä½ä¸ºchannelçä¿¡å·\n\nç©ºç»æä½å¸¸ç¨äºchanneléä¿¡ï¼è¡¨ç¤ºçº¯ä¿¡å·éç¥ï¼\n\nfunc worker(done chan struct{}) {\n    // æ¨¡æå·¥ä½\n    time.sleep(time.second)\n    \n    // åéå®æä¿¡å·\n    done <- struct{}{}\n}\n\nfunc main() {\n    done := make(chan struct{})\n    go worker(done)\n    \n    // ç­å¾å·¥ä½å®æ\n    <-done\n    fmt.println("work done")\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\n\n# 2.3 ä»åå«æ¹æ³çç»æä½\n\nå½åªéè¦æ¹æ³ä¸éè¦å­å¨æ°æ®æ¶ï¼\n\ntype logger struct{} // ä¸éè¦ç¶æå­å¨\n\nfunc (l logger) info(msg string) {\n    fmt.printf("[info] %s\\n", msg)\n}\n\nfunc (l logger) error(msg string) {\n    fmt.printf("[error] %s\\n", msg)\n}\n\nfunc main() {\n    var log logger\n    log.info("system started")\n    log.error("connection failed")\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\n\n# 3. æ»ç»\n\nç©ºç»æä½æ¯goè¯­è¨ä¸­å®ç°é«æ§è½ä»£ç çéè¦å·¥å·ï¼ç¹å«éç¨äºï¼\n\n 1. éè¦éåè¯­ä¹ä½ä¸éè¦å­å¨æ°æ®çåºæ¯\n 2. çº¯ä¿¡å·éç¥çå¹¶åéä¿¡\n 3. æ ç¶æçæ¹æ³éå\n\nåçä½¿ç¨ç©ºç»æä½å¯ä»¥æ¾èéä½åå­å ç¨ï¼æåç¨åºæ§è½ã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå",frontmatter:{title:"Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå",date:"2025-06-14T20:18:52.000Z",permalink:"/pages/d4c8eb/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:[null],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æè¯¦ç»å¯¹æ¯äºGoè¯­è¨ä¸­6ç§å­ç¬¦ä¸²æ¼æ¥æ¹å¼çæ§è½å·®å¼ï¼éè¿åºåæµè¯æ°æ®æ­ç¤ºæä½³å®è·µï¼å¹¶æä¾å®éå¼åä¸­çä¼åå»ºè®®ã",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå"},{name:"twitter:description",content:"æ¬æè¯¦ç»å¯¹æ¯äºGoè¯­è¨ä¸­6ç§å­ç¬¦ä¸²æ¼æ¥æ¹å¼çæ§è½å·®å¼ï¼éè¿åºåæµè¯æ°æ®æ­ç¤ºæä½³å®è·µï¼å¹¶æä¾å®éå¼åä¸­çä¼åå»ºè®®ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/11.Go%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå"},{property:"og:description",content:"æ¬æè¯¦ç»å¯¹æ¯äºGoè¯­è¨ä¸­6ç§å­ç¬¦ä¸²æ¼æ¥æ¹å¼çæ§è½å·®å¼ï¼éè¿åºåæµè¯æ°æ®æ­ç¤ºæä½³å®è·µï¼å¹¶æä¾å®éå¼åä¸­çä¼åå»ºè®®ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/11.Go%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T20:18:52.000Z"},{property:"article:tag",content:null},{itemprop:"name",content:"Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå"},{itemprop:"description",content:"æ¬æè¯¦ç»å¯¹æ¯äºGoè¯­è¨ä¸­6ç§å­ç¬¦ä¸²æ¼æ¥æ¹å¼çæ§è½å·®å¼ï¼éè¿åºåæµè¯æ°æ®æ­ç¤ºæä½³å®è·µï¼å¹¶æä¾å®éå¼åä¸­çä¼åå»ºè®®ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/11.Go%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/11.Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå.md",key:"v-d6123402",path:"/pages/d4c8eb/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"åºåæµè¯å¤§æ¯æ¼",slug:"åºåæµè¯å¤§æ¯æ¼",normalizedTitle:"åºåæµè¯å¤§æ¯æ¼",charIndex:221},{level:2,title:"æ§è½åæ",slug:"æ§è½åæ",normalizedTitle:"æ§è½åæ",charIndex:2904},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:3098}],headersStr:"ç®ä» åºåæµè¯å¤§æ¯æ¼ æ§è½åæ æ»ç»",content:'# ç®ä»\n\nå¨Goè¯­è¨ä¸­ï¼å¸¸è§çå­ç¬¦ä¸²æ¼æ¥æ¹å¼æä»¥ä¸6ç§ï¼\n\n 1. +å·æ¼æ¥ï¼æç®åçæ¼æ¥æ¹å¼\n 2. fmt.Sprintfï¼æ ¼å¼åæ¼æ¥\n 3. strings.Builderï¼ä¸é¨ä¼åçå­ç¬¦ä¸²æå»ºå¨\n 4. bytes.Bufferï¼å­èç¼å²åº\n 5. []byteè½¬æ¢ï¼å­èåçè½¬æ¢\n 6. é¢åé[]byteï¼é¢ååéè¶³å¤ç©ºé´çå­èåç\n\næ¬æä¸»è¦æ¯éå¯¹ä¸é¢åç§æ¹å¼è¿è¡åºåæµè¯ï¼å¸®å©æä»¬å¨ä»¥åçç¼ç è¿ç¨ä¸­éæ©æä¼çæ¹å¼ã\n\n\n# åºåæµè¯å¤§æ¯æ¼\n\nconst letterBytes = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"\n\nfunc randomString(n int) string {\n\tb := make([]byte, n)\n\tfor i := range b {\n\t\tb[i] = letterBytes[rand.Intn(len(letterBytes))]\n\t}\n\treturn string(b)\n}\n\nfunc plusConcat(n int, str string) string {\n\ts := ""\n\tfor i := 0; i < n; i++ {\n\t\ts += str\n\t}\n\treturn s\n}\n\nfunc sprintfConcat(n int, str string) string {\n\ts := ""\n\tfor i := 0; i < n; i++ {\n\t\ts = fmt.Sprintf("%s%s", s, str)\n\t}\n\treturn s\n}\n\nfunc builderConcat(n int, str string) string {\n\tvar builder strings.Builder\n\tfor i := 0; i < n; i++ {\n\t\tbuilder.WriteString(str)\n\t}\n\treturn builder.String()\n}\n\nfunc bufferConcat(n int, s string) string {\n\tbuf := new(bytes.Buffer)\n\tfor i := 0; i < n; i++ {\n\t\tbuf.WriteString(s)\n\t}\n\treturn buf.String()\n}\n\nfunc byteConcat(n int, str string) string {\n\tbuf := make([]byte, 0)\n\tfor i := 0; i < n; i++ {\n\t\tbuf = append(buf, str...)\n\t}\n\treturn string(buf)\n}\n\nfunc preByteConcat(n int, str string) string {\n\tbuf := make([]byte, 0, n*len(str))\n\tfor i := 0; i < n; i++ {\n\t\tbuf = append(buf, str...)\n\t}\n\treturn string(buf)\n}\n\nfunc benchmark(b *testing.B, f func(int, string) string) {\n\tvar str = randomString(10)\n\tfor i := 0; i < b.N; i++ {\n\t\tf(10000, str)\n\t}\n}\n\nfunc BenchmarkPlusConcat(b *testing.B)    { benchmark(b, plusConcat) }\nfunc BenchmarkSprintfConcat(b *testing.B) { benchmark(b, sprintfConcat) }\nfunc BenchmarkBuilderConcat(b *testing.B) { benchmark(b, builderConcat) }\nfunc BenchmarkBufferConcat(b *testing.B)  { benchmark(b, bufferConcat) }\nfunc BenchmarkByteConcat(b *testing.B)    { benchmark(b, byteConcat) }\nfunc BenchmarkPreByteConcat(b *testing.B) { benchmark(b, preByteConcat) }\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n\n\nç»æå¦ä¸ï¼\n\ngo test  -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkPlusConcat-12                36          32238928 ns/op        530999857 B/op     10045 allocs/op\nBenchmarkSprintfConcat-12             20          56848854 ns/op        833393446 B/op     34184 allocs/op\nBenchmarkBuilderConcat-12          23143             51218 ns/op          514804 B/op         23 allocs/op\nBenchmarkBufferConcat-12           29152             40997 ns/op          368578 B/op         13 allocs/op\nBenchmarkByteConcat-12             19549             60984 ns/op          621301 B/op         24 allocs/op\nBenchmarkPreByteConcat-12          50913             24879 ns/op          212994 B/op          2 allocs/op\nPASS\nok      main/demo       10.263s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# æ§è½åæ\n\n+å·åfmt.Sprintfæ§è½å·®çåå ï¼\n\n 1. æ¯æ¬¡æä½é½ä¼åå»ºæ°çå­ç¬¦ä¸²\n 2. äº§çå¤§éåå­åéååå¾åæ¶åå\n\nstrings.Builder/bytes.Bufferè¡¨ç°å¥½çåå \n\n 1. åé¨ä½¿ç¨[]byteç¼å²åº\n 2. æéæ©å®¹ï¼åå°åå­åéæ¬¡æ°\n\né¢åé[]byteæä½³çåå \n\n 1. ä¸æ¬¡æ§åéè¶³å¤åå­\n 2. å®å¨é¿åäºæ©å®¹å¸¦æ¥çæ§è½æè\n\n\n# æ»ç»\n\néè¿æµè¯æä»¬åç°ï¼\n\n * é¢åé[]byteæ§è½æä½³ï¼éåé«æ§è½åºæ¯\n * strings.Builderæ¯éç¨åºæ¯çæä½³éæ©\n * +å·åfmt.Sprintfå¨å¾ªç¯æ¼æ¥ä¸­æ§è½æå·®\n\nå¨å®éå¼åä¸­ï¼åºæ ¹æ®åºæ¯éæ©åéçæ¹æ³ï¼å¨ä»£ç å¯è¯»æ§åæ§è½ä¹é´åå¾å¹³è¡¡ã',normalizedContent:'# ç®ä»\n\nå¨goè¯­è¨ä¸­ï¼å¸¸è§çå­ç¬¦ä¸²æ¼æ¥æ¹å¼æä»¥ä¸6ç§ï¼\n\n 1. +å·æ¼æ¥ï¼æç®åçæ¼æ¥æ¹å¼\n 2. fmt.sprintfï¼æ ¼å¼åæ¼æ¥\n 3. strings.builderï¼ä¸é¨ä¼åçå­ç¬¦ä¸²æå»ºå¨\n 4. bytes.bufferï¼å­èç¼å²åº\n 5. []byteè½¬æ¢ï¼å­èåçè½¬æ¢\n 6. é¢åé[]byteï¼é¢ååéè¶³å¤ç©ºé´çå­èåç\n\næ¬æä¸»è¦æ¯éå¯¹ä¸é¢åç§æ¹å¼è¿è¡åºåæµè¯ï¼å¸®å©æä»¬å¨ä»¥åçç¼ç è¿ç¨ä¸­éæ©æä¼çæ¹å¼ã\n\n\n# åºåæµè¯å¤§æ¯æ¼\n\nconst letterbytes = "abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz"\n\nfunc randomstring(n int) string {\n\tb := make([]byte, n)\n\tfor i := range b {\n\t\tb[i] = letterbytes[rand.intn(len(letterbytes))]\n\t}\n\treturn string(b)\n}\n\nfunc plusconcat(n int, str string) string {\n\ts := ""\n\tfor i := 0; i < n; i++ {\n\t\ts += str\n\t}\n\treturn s\n}\n\nfunc sprintfconcat(n int, str string) string {\n\ts := ""\n\tfor i := 0; i < n; i++ {\n\t\ts = fmt.sprintf("%s%s", s, str)\n\t}\n\treturn s\n}\n\nfunc builderconcat(n int, str string) string {\n\tvar builder strings.builder\n\tfor i := 0; i < n; i++ {\n\t\tbuilder.writestring(str)\n\t}\n\treturn builder.string()\n}\n\nfunc bufferconcat(n int, s string) string {\n\tbuf := new(bytes.buffer)\n\tfor i := 0; i < n; i++ {\n\t\tbuf.writestring(s)\n\t}\n\treturn buf.string()\n}\n\nfunc byteconcat(n int, str string) string {\n\tbuf := make([]byte, 0)\n\tfor i := 0; i < n; i++ {\n\t\tbuf = append(buf, str...)\n\t}\n\treturn string(buf)\n}\n\nfunc prebyteconcat(n int, str string) string {\n\tbuf := make([]byte, 0, n*len(str))\n\tfor i := 0; i < n; i++ {\n\t\tbuf = append(buf, str...)\n\t}\n\treturn string(buf)\n}\n\nfunc benchmark(b *testing.b, f func(int, string) string) {\n\tvar str = randomstring(10)\n\tfor i := 0; i < b.n; i++ {\n\t\tf(10000, str)\n\t}\n}\n\nfunc benchmarkplusconcat(b *testing.b)    { benchmark(b, plusconcat) }\nfunc benchmarksprintfconcat(b *testing.b) { benchmark(b, sprintfconcat) }\nfunc benchmarkbuilderconcat(b *testing.b) { benchmark(b, builderconcat) }\nfunc benchmarkbufferconcat(b *testing.b)  { benchmark(b, bufferconcat) }\nfunc benchmarkbyteconcat(b *testing.b)    { benchmark(b, byteconcat) }\nfunc benchmarkprebyteconcat(b *testing.b) { benchmark(b, prebyteconcat) }\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n\n\nç»æå¦ä¸ï¼\n\ngo test  -bench=. -benchmem .\ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkplusconcat-12                36          32238928 ns/op        530999857 b/op     10045 allocs/op\nbenchmarksprintfconcat-12             20          56848854 ns/op        833393446 b/op     34184 allocs/op\nbenchmarkbuilderconcat-12          23143             51218 ns/op          514804 b/op         23 allocs/op\nbenchmarkbufferconcat-12           29152             40997 ns/op          368578 b/op         13 allocs/op\nbenchmarkbyteconcat-12             19549             60984 ns/op          621301 b/op         24 allocs/op\nbenchmarkprebyteconcat-12          50913             24879 ns/op          212994 b/op          2 allocs/op\npass\nok      main/demo       10.263s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\n\n# æ§è½åæ\n\n+å·åfmt.sprintfæ§è½å·®çåå ï¼\n\n 1. æ¯æ¬¡æä½é½ä¼åå»ºæ°çå­ç¬¦ä¸²\n 2. äº§çå¤§éåå­åéååå¾åæ¶åå\n\nstrings.builder/bytes.bufferè¡¨ç°å¥½çåå \n\n 1. åé¨ä½¿ç¨[]byteç¼å²åº\n 2. æéæ©å®¹ï¼åå°åå­åéæ¬¡æ°\n\né¢åé[]byteæä½³çåå \n\n 1. ä¸æ¬¡æ§åéè¶³å¤åå­\n 2. å®å¨é¿åäºæ©å®¹å¸¦æ¥çæ§è½æè\n\n\n# æ»ç»\n\néè¿æµè¯æä»¬åç°ï¼\n\n * é¢åé[]byteæ§è½æä½³ï¼éåé«æ§è½åºæ¯\n * strings.builderæ¯éç¨åºæ¯çæä½³éæ©\n * +å·åfmt.sprintfå¨å¾ªç¯æ¼æ¥ä¸­æ§è½æå·®\n\nå¨å®éå¼åä¸­ï¼åºæ ¹æ®åºæ¯éæ©åéçæ¹æ³ï¼å¨ä»£ç å¯è¯»æ§åæ§è½ä¹é´åå¾å¹³è¡¡ã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ",frontmatter:{title:"Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ",date:"2025-06-14T20:32:05.000Z",permalink:"/pages/f9a2a3/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¥è§£æGoè¯­è¨ä¸­å»¶è¿åå§åçå®ç°åçåæä½³å®è·µï¼åæ¬sync.Onceãsync.OnceValueåsync.OnceValuesçä½¿ç¨åºæ¯åæ§è½ä¼å¿",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ"},{name:"twitter:description",content:"å¥è§£æGoè¯­è¨ä¸­å»¶è¿åå§åçå®ç°åçåæä½³å®è·µï¼åæ¬sync.Onceãsync.OnceValueåsync.OnceValuesçä½¿ç¨åºæ¯åæ§è½ä¼å¿"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/12.Go%E8%AF%AD%E8%A8%80%E5%BB%B6%E8%BF%9F%E5%88%9D%E5%A7%8B%E5%8C%96(Lazy%20Initialization)%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ"},{property:"og:description",content:"å¥è§£æGoè¯­è¨ä¸­å»¶è¿åå§åçå®ç°åçåæä½³å®è·µï¼åæ¬sync.Onceãsync.OnceValueåsync.OnceValuesçä½¿ç¨åºæ¯åæ§è½ä¼å¿"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/12.Go%E8%AF%AD%E8%A8%80%E5%BB%B6%E8%BF%9F%E5%88%9D%E5%A7%8B%E5%8C%96(Lazy%20Initialization)%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T20:32:05.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ"},{itemprop:"description",content:"å¥è§£æGoè¯­è¨ä¸­å»¶è¿åå§åçå®ç°åçåæä½³å®è·µï¼åæ¬sync.Onceãsync.OnceValueåsync.OnceValuesçä½¿ç¨åºæ¯åæ§è½ä¼å¿"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/12.Go%E8%AF%AD%E8%A8%80%E5%BB%B6%E8%BF%9F%E5%88%9D%E5%A7%8B%E5%8C%96(Lazy%20Initialization)%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/12.Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ.md",key:"v-1ba8c576",path:"/pages/f9a2a3/",headers:[{level:2,title:"1. ç®ä»",slug:"_1-ç®ä»",normalizedTitle:"1. ç®ä»",charIndex:2},{level:2,title:"2. å»¶è¿åå§åå®ç°",slug:"_2-å»¶è¿åå§åå®ç°",normalizedTitle:"2. å»¶è¿åå§åå®ç°",charIndex:79},{level:3,title:"2.1 sync.Once",slug:"_2-1-sync-once",normalizedTitle:"2.1 sync.once",charIndex:94},{level:3,title:"2.2 sync.OnceValue (Go 1.21+)",slug:"_2-2-sync-oncevalue-go-1-21",normalizedTitle:"2.2 sync.oncevalue (go 1.21+)",charIndex:476},{level:3,title:"2.3 éè¯¯å¤çæ¹æ¡ï¼sync.OnceValues",slug:"_2-3-éè¯¯å¤çæ¹æ¡-sync-oncevalues",normalizedTitle:"2.3 éè¯¯å¤çæ¹æ¡ï¼sync.oncevalues",charIndex:784},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:1095}],headersStr:"1. ç®ä» 2. å»¶è¿åå§åå®ç° 2.1 sync.Once 2.2 sync.OnceValue (Go 1.21+) 2.3 éè¯¯å¤çæ¹æ¡ï¼sync.OnceValues 3. æ»ç»",content:'# 1. ç®ä»\n\nå¨æäºèµæºåå§åææ¬å¾é«ï¼çè³å¨æäºä»£ç è·¯å¾æªè§¦åæ ¹æ¬æ²¡æå¿è¦åå§åï¼å¯ä»¥å°å¯¹è±¡çåå»ºãéç½®ç­èæ¶æä½æ¨è¿å°çæ­£éè¦ä½¿ç¨æ¶ææ§è¡ã\n\n\n# 2. å»¶è¿åå§åå®ç°\n\n\n# 2.1 sync.Once\n\nsync.Once æ¯Goæ ååºæä¾ççº¿ç¨å®å¨åå§åå·¥å·ï¼ç¡®ä¿åå§åä»£ç åªæ§è¡ä¸æ¬¡ï¼\n\nvar (\n    resource *MyResource  // éè¦å»¶è¿åå§åçèµæº\n    once     sync.Once    // æ§å¶åå§åçåæ­¥åè¯­\n)\n\nfunc getResource() *MyResource {\n    once.Do(func() {\n        resource = &MyResource{\n            // åå§åä»£ç \n        }\n    })\n    return resource\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nç¹ç¹ï¼\n\n * çº¿ç¨å®å¨ï¼éåå¹¶ååºæ¯\n * åå§åé»è¾ä¸ä¸å¡ä»£ç è¦å\n * éè¦é¢å¤å®ä¹å¨å±åé\n\n\n# 2.2 sync.OnceValue (Go 1.21+)\n\nGo 1.21å¼å¥äºæ´ç®æ´çsync.OnceValueï¼éåè¿ååä¸ªå¼çåºæ¯ï¼\n\nvar getResource = sync.OnceValue(func() *MyResource {\n    return &MyResource{\n        // åå§åä»£ç \n    }\n})\n\n// ä½¿ç¨ç¤ºä¾\nfunc main() {\n    res := getResource()  // ç¬¬ä¸æ¬¡è°ç¨æ¶åå§å\n    _ = getResource()     // åç»­è°ç¨ç´æ¥è¿åç¼å­å¼\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# 2.3 éè¯¯å¤çæ¹æ¡ï¼sync.OnceValues\n\nå½åå§åå¯è½è¿åéè¯¯æ¶ï¼ä½¿ç¨sync.OnceValuesï¼\n\nvar getConfig = sync.OnceValues(func() (*Config, error) {\n    return loadConfig("config.yml")\n})\n\nfunc main() {\n    config, err := getConfig()\n    if err != nil {\n        log.Fatal("å è½½éç½®å¤±è´¥:", err)\n    }\n    // ä½¿ç¨éç½®...\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 3. æ»ç»\n\nå¨ä»¥ä¸åºæ¯ä¸­éåä½¿ç¨å»¶è¿åå§å:\n\n * èµæºåå§åææ¬éå¸¸é«ã\n * ä¸ºäºæé«å¯å¨æ§è½ååå­æçã\n * å½å¹¶éææçèµæºé½éè¦å¨è¿è¡æ¶ç«å³ä½¿ç¨ï¼çè³æ ¹æ¬ä¸éè¦ä½¿ç¨ã',normalizedContent:'# 1. ç®ä»\n\nå¨æäºèµæºåå§åææ¬å¾é«ï¼çè³å¨æäºä»£ç è·¯å¾æªè§¦åæ ¹æ¬æ²¡æå¿è¦åå§åï¼å¯ä»¥å°å¯¹è±¡çåå»ºãéç½®ç­èæ¶æä½æ¨è¿å°çæ­£éè¦ä½¿ç¨æ¶ææ§è¡ã\n\n\n# 2. å»¶è¿åå§åå®ç°\n\n\n# 2.1 sync.once\n\nsync.once æ¯goæ ååºæä¾ççº¿ç¨å®å¨åå§åå·¥å·ï¼ç¡®ä¿åå§åä»£ç åªæ§è¡ä¸æ¬¡ï¼\n\nvar (\n    resource *myresource  // éè¦å»¶è¿åå§åçèµæº\n    once     sync.once    // æ§å¶åå§åçåæ­¥åè¯­\n)\n\nfunc getresource() *myresource {\n    once.do(func() {\n        resource = &myresource{\n            // åå§åä»£ç \n        }\n    })\n    return resource\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\nç¹ç¹ï¼\n\n * çº¿ç¨å®å¨ï¼éåå¹¶ååºæ¯\n * åå§åé»è¾ä¸ä¸å¡ä»£ç è¦å\n * éè¦é¢å¤å®ä¹å¨å±åé\n\n\n# 2.2 sync.oncevalue (go 1.21+)\n\ngo 1.21å¼å¥äºæ´ç®æ´çsync.oncevalueï¼éåè¿ååä¸ªå¼çåºæ¯ï¼\n\nvar getresource = sync.oncevalue(func() *myresource {\n    return &myresource{\n        // åå§åä»£ç \n    }\n})\n\n// ä½¿ç¨ç¤ºä¾\nfunc main() {\n    res := getresource()  // ç¬¬ä¸æ¬¡è°ç¨æ¶åå§å\n    _ = getresource()     // åç»­è°ç¨ç´æ¥è¿åç¼å­å¼\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\n\n# 2.3 éè¯¯å¤çæ¹æ¡ï¼sync.oncevalues\n\nå½åå§åå¯è½è¿åéè¯¯æ¶ï¼ä½¿ç¨sync.oncevaluesï¼\n\nvar getconfig = sync.oncevalues(func() (*config, error) {\n    return loadconfig("config.yml")\n})\n\nfunc main() {\n    config, err := getconfig()\n    if err != nil {\n        log.fatal("å è½½éç½®å¤±è´¥:", err)\n    }\n    // ä½¿ç¨éç½®...\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 3. æ»ç»\n\nå¨ä»¥ä¸åºæ¯ä¸­éåä½¿ç¨å»¶è¿åå§å:\n\n * èµæºåå§åææ¬éå¸¸é«ã\n * ä¸ºäºæé«å¯å¨æ§è½ååå­æçã\n * å½å¹¶éææçèµæºé½éè¦å¨è¿è¡æ¶ç«å³ä½¿ç¨ï¼çè³æ ¹æ¬ä¸éè¦ä½¿ç¨ã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨ç»æä½åå­å¯¹é½å®å¨æå",frontmatter:{title:"Goè¯­è¨ç»æä½åå­å¯¹é½å®å¨æå",date:"2025-06-14T19:54:38.000Z",permalink:"/pages/13969e/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨ç»æä½åå­å¯¹é½åçä¸ä¼åå®è·µï¼åå«æ§è½æµè¯æ°æ®åå®ç¨å·¥å·æ¨è",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17499021159591749902115421.png"},{name:"twitter:title",content:"Goè¯­è¨ç»æä½åå­å¯¹é½å®å¨æå"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨ç»æä½åå­å¯¹é½åçä¸ä¼åå®è·µï¼åå«æ§è½æµè¯æ°æ®åå®ç¨å·¥å·æ¨è"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17499021159591749902115421.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/10.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨ç»æä½åå­å¯¹é½å®å¨æå"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨ç»æä½åå­å¯¹é½åçä¸ä¼åå®è·µï¼åå«æ§è½æµè¯æ°æ®åå®ç¨å·¥å·æ¨è"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17499021159591749902115421.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/10.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T19:54:38.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨ç»æä½åå­å¯¹é½å®å¨æå"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨ç»æä½åå­å¯¹é½åçä¸ä¼åå®è·µï¼åå«æ§è½æµè¯æ°æ®åå®ç¨å·¥å·æ¨è"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17499021159591749902115421.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/10.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/10.Goè¯­è¨é«æ§è½ç¼ç¨ä¹ç»æä½åå­å¯¹é½.md",key:"v-3ff27440",path:"/pages/13969e/",headers:[{level:2,title:"1. ç®ä»",slug:"_1-ç®ä»",normalizedTitle:"1. ç®ä»",charIndex:2},{level:2,title:"2. ä½¿ç¨ç»æä½åå­å¯¹é½æææ¯æä¹æ ·çï¼",slug:"_2-ä½¿ç¨ç»æä½åå­å¯¹é½æææ¯æä¹æ ·ç",normalizedTitle:"2. ä½¿ç¨ç»æä½åå­å¯¹é½æææ¯æä¹æ ·çï¼",charIndex:85},{level:2,title:"3. ä»ä¹æ¯ç»æä½åå­å¯¹é½ï¼",slug:"_3-ä»ä¹æ¯ç»æä½åå­å¯¹é½",normalizedTitle:"3. ä»ä¹æ¯ç»æä½åå­å¯¹é½ï¼",charIndex:575},{level:2,title:"4. éå¯¹ç»æä½æ¯å¦å¯¹é½çåºåæµè¯",slug:"_4-éå¯¹ç»æä½æ¯å¦å¯¹é½çåºåæµè¯",normalizedTitle:"4. éå¯¹ç»æä½æ¯å¦å¯¹é½çåºåæµè¯",charIndex:985},{level:2,title:"5. å¼å®¹ç¡¬ä»¶å¹³å°ä¸æ¶æ",slug:"_5-å¼å®¹ç¡¬ä»¶å¹³å°ä¸æ¶æ",normalizedTitle:"5. å¼å®¹ç¡¬ä»¶å¹³å°ä¸æ¶æ",charIndex:1796},{level:2,title:"6. åå­å¯¹é½è§å",slug:"_6-åå­å¯¹é½è§å",normalizedTitle:"6. åå­å¯¹é½è§å",charIndex:2223},{level:3,title:"6.1 å¯¹é½ç³»æ°",slug:"_6-1-å¯¹é½ç³»æ°",normalizedTitle:"6.1 å¯¹é½ç³»æ°",charIndex:2237},{level:3,title:"6.2 å­æ®µåç§»é",slug:"_6-2-å­æ®µåç§»é",normalizedTitle:"6.2 å­æ®µåç§»é",charIndex:2871},{level:3,title:"6.3 struct åå­å¯¹é½è§å",slug:"_6-3-struct-åå­å¯¹é½è§å",normalizedTitle:"6.3 struct åå­å¯¹é½è§å",charIndex:2947},{level:3,title:"6.4 struct{} ä½ä¸ºç»æä½æåä¸ä¸ªå­æ®µ",slug:"_6-4-struct-ä½ä¸ºç»æä½æåä¸ä¸ªå­æ®µ",normalizedTitle:"6.4 struct{} ä½ä¸ºç»æä½æåä¸ä¸ªå­æ®µ",charIndex:3473},{level:2,title:"7. fieldalignment linter",slug:"_7-fieldalignment-linter",normalizedTitle:"7. fieldalignment linter",charIndex:4201},{level:2,title:"8. æä½³å®è·µ",slug:"_8-æä½³å®è·µ",normalizedTitle:"8. æä½³å®è·µ",charIndex:4883}],headersStr:"1. ç®ä» 2. ä½¿ç¨ç»æä½åå­å¯¹é½æææ¯æä¹æ ·çï¼ 3. ä»ä¹æ¯ç»æä½åå­å¯¹é½ï¼ 4. éå¯¹ç»æä½æ¯å¦å¯¹é½çåºåæµè¯ 5. å¼å®¹ç¡¬ä»¶å¹³å°ä¸æ¶æ 6. åå­å¯¹é½è§å 6.1 å¯¹é½ç³»æ° 6.2 å­æ®µåç§»é 6.3 struct åå­å¯¹é½è§å 6.4 struct{} ä½ä¸ºç»æä½æåä¸ä¸ªå­æ®µ 7. fieldalignment linter 8. æä½³å®è·µ",content:'# 1. ç®ä»\n\nå¨Goè¯­è¨å¼åä¸­ï¼ç»æä½åå­å¯¹é½æ¯å½±åç¨åºæ§è½ååå­æççå³é®å ç´ ãæ¬æå°ä»åºå±åçåºåï¼è¯¦ç»è§£æåå­å¯¹é½çå·¥ä½æºå¶åå¶å¯¹ç¨åºæ§è½çå®éå½±åã\n\n\n# 2. ä½¿ç¨ç»æä½åå­å¯¹é½æææ¯æä¹æ ·çï¼\n\nåå»ºä¸¤ä¸ªç»æä½ï¼å¶ä¸­çæååéæ°éåç±»åå®æä¸è´ï¼åªæé¡ºåºææ¾çä¸ä¸æ ·ã\n\nimport (\n\t"fmt"\n\t"unsafe"\n)\n\ntype PoorlyAligned struct {\n\tflag  bool\n\tcount int64\n\tid    byte\n}\n\ntype WellAligned struct {\n\tcount int64\n\tflag  bool\n\tid    byte\n}\n\nfunc main() {\n\tfmt.Println(unsafe.Sizeof(PoorlyAligned{}))\n\tfmt.Println(unsafe.Sizeof(WellAligned{}))\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå° PoorlyAligned çåå­å¤§å°æ¯24ï¼è WellAligned çåå­å¤§å°æ¯ 16\n\n24\n16\n\n\n1\n2\n\n\nä¸ºä»ä¹æ¹äºåéçé¡ºåºï¼å´å¨åå­ä¸­çå¤§å°åä¸ä¸æ ·äºå¢ï¼\n\n\n# 3. ä»ä¹æ¯ç»æä½åå­å¯¹é½ï¼\n\nCPU è®¿é®åå­æ¶æ¯æ ¹æ®å­é¿æ¥è®¿é®èä¸æ¯å­èãæ¯å¦ 32 ä½ç CPU å­é¿æ¯ 4 å­èï¼64 ä½ç CPU æ¶ 8 å­èãè¿ä¹è®¾è®¡çç®çæ¯åå° CPU è®¿é®åå­çæ¬¡æ°ï¼æé«ååéã\n\nè¿ä¸ªæ¶åæä»¬çå°ç»æä½ PoorlyAlignedï¼boolæ¯ 4 å­èï¼int64 æ¯ 8 å­èï¼byteæ¯ 4 å­èï¼CPU è¯»å bool åé flag æ¶ï¼å ä¸ºå­é¿æ¯ 8 å­èï¼å¿é¡»å¾è¯» 8 ä¸ªå­èï¼æä»¥å¿é¡»å¾è¡¥ä¸ç©ºç 4 ä¸ªå­èãè int64 ç count åéæ¬èº«æ¯ 8 å­èçä¸éè¦è¡¥ä½ï¼è¯»byte ç id æ¶å flag ä¸æ ·ä¹éè¦è¡¥ 4 ä¸ªå­èï¼æç»æ¯ 24 ä¸ªå­èã\n\n\n\nåçå°ç»æä½ WellAlignedï¼é¡ºåºæ¯ countãflagãidï¼count å¯ä»¥ä¸æ¬¡åèµ°ï¼è bool å¯ä»¥å id å¨åä¸æ¬¡ä¸èµ·åèµ°ï¼æä»¥æç»åªéè¦å¨åå­å­å¨ 16 ä¸ªå­èã\n\n\n\n\n# 4. éå¯¹ç»æä½æ¯å¦å¯¹é½çåºåæµè¯\n\nfunc BenchmarkPoorlyAligned(b *testing.B) {\n\tfor range b.N {\n\t\tvar items = make([]PoorlyAligned, 10_000_000)\n\t\tfor j := range items {\n\t\t\titems[j].count = int64(j)\n\t\t}\n\t}\n}\n\nfunc BenchmarkWellAligned(b *testing.B) {\n\tfor range b.N {\n\t\tvar items = make([]WellAligned, 10_000_000)\n\t\tfor j := range items {\n\t\t\titems[j].count = int64(j)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nè¿è¡ç»æå¦ä¸ï¼åå­å¯¹é½å¨éåº¦ä¸è¦å¿«ä¸çº¦ 35%ï¼åå­åéè¦å°ä¸çº¦ 50%\n\n$ go test -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkPoorlyAligned-12            248           4575658 ns/op        240001038 B/op         1 allocs/op\nBenchmarkWellAligned-12              356           3392792 ns/op        160006157 B/op         1 allocs/op\nPASS\nok      main/demo       5.126s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 5. å¼å®¹ç¡¬ä»¶å¹³å°ä¸æ¶æ\n\næ¥ä¸æ¥çè¿ä¹ä¸ç§æåµï¼f1 int8å ç¨ 1 ä¸ªå­èï¼f2 int16å ç¨ 2 ä¸ªå­èï¼f3 int8 ä¹å ç¨ 1 ä¸ªå­èï¼ä½æ¯è¾åºçå­èå¤§å°å´æ¯ 6 èä¸æ¯ 4ï¼å ä¸ºè¿éä¹åäºåå­å¯¹é½ã\n\ntype S1 struct { \n\tf1 int8\n\tf2 int16\n\tf3 int8\n}\n\nfunc main() {\n\ts1 := S1{}\n\tfmt.Println(unsafe.Sizeof(s1))\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nè¿è¡è¾åºï¼\n\n6\n\n\n1\n\n\né®é¢æ¥äºï¼æä½ç³»ç»ä¸ä¸ªå­é¿ 8 ä¸ªå­èï¼é£ä¹æ è®ºæ¯ 4 è¿æ¯ 6 CPU é½è½å¤ä¸æ¬¡æ¿å°æ´ä½æ°æ®ï¼æçæ¯ä¸æ ·çåã\n\nè¿æ¯å ä¸ºï¼åå­å¯¹é½ä¸ä»ä»æ¯ä¸ºäºä¿è¯ CPU çè¯»åæçï¼è¿æå°±æ¯ä¸ºäºå¼å®¹ç¡¬ä»¶å¹³å°åæ¶æåçéå¶ï¼æ¯å¦å¨ CPU æ¯ ARMæ¶æ æ¶å¼ºå¶è¦ååå­å¯¹é½çï¼ä¸åçè¯åä¼ç´æ¥æ¥éã\n\né£ä¹è¿éçå¯¹é½è§åæ¯æä¹æ ·çå¢ï¼\n\n\n# 6. åå­å¯¹é½è§å\n\n\n# 6.1 å¯¹é½ç³»æ°\n\nå­æ®µç±»åä¸ä»æç±»åå¤§å°ï¼è¿æç±»åå¯¹é½ç³»æ°ï¼ å¶æä»¥ä¸ä¸¤ä¸ªè§å\n\n * Goåå§ç±»åçå¯¹é½ç³»æ°ä¸ç±»åé¿åº¦ç¸ç­ã\n\nå¯ä»¥ä½¿ç¨unsafe.Alignofæ¥æ¥çç±»åçå¯¹é½ç³»æ°ï¼å¯ä»¥åç°ä¸¤èæ¯ä¸è´çã\n\nfunc main() {\n\tfmt.Println(unsafe.Sizeof(int64(1)))      // 8\n\tfmt.Println(unsafe.Sizeof(float32(32)))   // 4\n\n\tfmt.Println(unsafe.Alignof(int64(1)))     // 8\n\tfmt.Println(unsafe.Alignof(float32(32)))  //4\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n * Goç»æä½ç±»åçå¯¹é½ç³»æ°æ¯æé¿å­æ®µçå¯¹é½ç³»æ°åç³»ç»å¯¹é½ç³»æ°ä¸¤èä¸­çæå°çé£ä¸ªã\n\nå¯ä»¥çå°ç»æä½çå¯¹é½ç³»æ°æ¯ 2ï¼è¿æ¯å ä¸ºæé¿å­æ®µæ¯ f2 å¶å¯¹é½ç³»æ°æ¯ 2ï¼æä½ç³»ç»æ¯ 64 ä½ï¼å¶å¯¹é½ç³»æ°æ¯ 8ï¼åæå°çä¹å°±æ¯ 2\n\ntype S1 struct { \n\tf1 int8\n\tf2 int16\n\tf3 int8\n}\n\nfunc main() {\n\ts1 := S1{}\n\tfmt.Println(unsafe.Sizeof(s1))    // 6\n\tfmt.Println(unsafe.Alignof(s1))   // 2\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 6.2 å­æ®µåç§»é\n\nå­æ®µåç§»éæ¯æå¨ç»æä½åå­å¯¹é½åå­æ®µä»èµ·å§ä½ç½®å¼å§çåç§»éï¼ä¹å°±æ¯ä»èµ·å§ä½ç½®å¼å§è®¡ç®çå­èæ°ï¼ç¬¬ä¸ä¸ªå­æ®µçåç§»éæ¯ 0ã\n\n\n# 6.3 struct åå­å¯¹é½è§å\n\nå¯¹é½è§åå¦ä¸ï¼\n\n * ç»æä½ä¸­çæ¯ä¸ªå­æ®µæå¨çåç§»éå¿é¡»æ¯å¶å¯¹é½ç³»æ°çæ´æ°åï¼å¦æä¸è½ä¿è¯åéè¦æ·»å ç©ºçå­èæ¥ä¿è¯åå­å¯¹é½ã\n * ç»æä½çé¿åº¦ä¸å®è¦æ¯å¶æ¬èº«å¯¹é½ç³»æ°çæ´æ°åã\n\nç¥éè§ååï¼ååå°ä¹åç S1 çä¾å­ï¼\n\n * f1 çåç§»éä¸º0ï¼å ç¨ 1 ä¸ªå­èï¼é»è®¤æ¯å¯¹é½çã\n * f2 çå¯¹é½ç³»æ°æ¯2ï¼å¦æä»åç§»é 1 å¼å§å­å¨ï¼åä¸æ¯2çåæ°ï¼å¿é¡»åé¢ç©ºåºä¸ä¸ªï¼ä»åç§»é2å¼å§ï¼ææ¯å¯¹é½ç³»æ°çåæ°ï¼æä»¥ä»åç§»éä»2å¼å§å­å¨ï¼å¹¶å­å¨2ä¸ªå­è\n * f3 çå¯¹é½ç³»æ°æ¯1ï¼ä»åç§»é 5 å¼å§å­å¨ï¼å­å¨ 1 ä¸ªå­èï¼æ¯å¯¹é½çã\n * æ¬ç»æä½çå¯¹é½ç³»æ°æ¯ 2ï¼èå¤§å°éè¦æ¶å¯¹é½ç³»æ°çæ´æ°åï¼èæ ¹æ®åé¢å æ­¥çé¿åº¦æ¯ 5ï¼ä¸è½å¯¹é½ï¼æä»¥è¿éè¦ç©ºåºä¸ä¸ªå­èæè½ä½¿ç»æä½å¯¹é½ï¼ä¹å°±æ¯é¿åº¦ä¸º 6 å­è\n\ntype S1 struct {   // é¿åº¦:6, å¯¹é½ç³»æ°: 2\n\tf1 int8        // é¿åº¦:1, å¯¹é½ç³»æ°: 1\n\tf2 int16       // é¿åº¦:2, å¯¹é½ç³»æ°: 2\n\tf3 int8        // é¿åº¦:1, å¯¹é½ç³»æ°: 1\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n\n\n# 6.4 struct{} ä½ä¸ºç»æä½æåä¸ä¸ªå­æ®µ\n\nstruct{}è¿æ ·çç©ºç»æä½çå¤§å°æ¯ä¸º 0 çï¼å¦æå¶ä½ä¸ºå¶ä»ç»æä½å­æ®µçæ¶åï¼æ¯ä¸å ç¨åå­çï¼ä¹ä¸éè¦èèåå­å¯¹é½çé®é¢ï¼ä½åªæä¸ç§æåµä¾å¤ï¼å°±æ¯struct{}ä½ä¸ºç»æä½çæåä¸ä¸ªå­æ®µæ¶ï¼æ¯ä¼è¿è¡åå­å¯¹é½çï¼èå¶å¯¹é½è§åæ¯ï¼ä¼è¢«å¡«åå¯¹é½å°åä¸ä¸ªå­æ®µçå¤§å°ã\n\nè¿æ¯å ä¸ºå¦æææéæåè¯¥å­æ®µ, è¿åçå°åå°å¨ç»æä½ä¹å¤ï¼å¦ææ­¤æéä¸ç´å­æ´»ä¸éæ¾å¯¹åºçåå­ï¼å°±ä¼æåå­æ³é²çé®é¢ï¼è¯¥åå­ä¸å ç»æä½éæ¾èéæ¾ï¼\n\nå·ä½æ¡ä¾å¦ä¸ï¼demo1ãdemo2ãdemo3ä¸­çstruct{}çé½ä¼æç§åä¸ä¸ªå­æ®µçå¤§å°è¿è¡å¡«åå¯¹é½ã\n\ntype demo1 struct {\n\tc int8\n\ta struct{}\n}\n\ntype demo2 struct {\n\tc int16\n\ta struct{}\n}\n\ntype demo3 struct {\n\tc int32\n\ta struct{}\n}\n\ntype demo4 struct {\n\ta struct{}\n\tc int32\n}\n\nfunc main() {\n\tfmt.Println(unsafe.Sizeof(demo1{})) // 2\n\tfmt.Println(unsafe.Sizeof(demo2{})) // 4\n\tfmt.Println(unsafe.Sizeof(demo3{})) // 8\n\tfmt.Println(unsafe.Sizeof(demo4{})) // 4\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\n\n# 7. fieldalignment linter\n\néè¿ä½¿ç¨fieldalignment linterå·¥å·å¯ä»¥æååç°åå­å¯¹é½é®é¢ï¼å¯ä»¥å¸®å©æä»¬æ¥å¯¹ç»æä½ä¸­çå­æ®µé¡ºåºè¿è¡æ­£ç¡®çæåï¼åå°åå­çå ç¨ï¼æé«è¿è¡çæçã\n\nè¯¥ç»æä½éè¿ä¸é¢çåæï¼é¿åº¦ä¸º 6ï¼ä¸ºäºåå­å¯¹é½æ¯è¡¥äº 2 ä¸ªå­èçã\n\ntype S1 struct {\n\tf1 int8\n\tf2 int16\n\tf3 int8\n}\n\n\n1\n2\n3\n4\n5\n\n\nå¨é¡¹ç®ä¸­æ°å¢æä»¶.golangci.yamlï¼åå®¹å¦ä¸ï¼ä¸»è¦æ¯å° fieldalignmeng åè½å¼å¯\n\nversion: 2\nlinters:\n  default: all\n  enable:\n    - govet\n  settings:\n    govet:\n      enable:\n        - fieldalignment\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nç¶åè¿è¡golangci-lintä¼ææç¤ºï¼ç»æä½çå¤§å°å¯ä»¥è¢«ä¼åï¼ä» 6 å° 4\n\n$ golangci-lint run\n...\nmain.go:9:9: fieldalignment: struct of size 6 could be 4 (govet)\ntype S1 struct {\n...\n\n\n1\n2\n3\n4\n5\n\n\nä¿®æ¹ç»æä½ä¸­å­æ®µé¡ºåºä¸ºä¸éè¦è¡¥é½åå­çæ¹å¼ï¼åæ¬¡è¿è¡ä¸é¢çå½ä»¤åï¼ä¸é¢çæç¤ºéè¯¯ä¿¡æ¯å°±æ²¡æäºã\n\ntype S1 struct {\n\tf1 int8\n\tf3 int8\n\tf2 int16\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# 8. æä½³å®è·µ\n\n * éè¿å¯¹å­æ®µçæåºæ¥åå°åé¨æ æä¹çå¡«åã\n * å°½å¯è½å°ç±»åå¤§å°ç¸åçå­æ®µæ¾å¨ä¸èµ·ï¼é¿åå¤§å°äº¤æ¿ã\n * ä½¿ç¨ fieldalignment linter å¯¹ä»£ç è¿è¡æ ¡éªï¼éè¿å·¥å·èªå¨æè·',normalizedContent:'# 1. ç®ä»\n\nå¨goè¯­è¨å¼åä¸­ï¼ç»æä½åå­å¯¹é½æ¯å½±åç¨åºæ§è½ååå­æççå³é®å ç´ ãæ¬æå°ä»åºå±åçåºåï¼è¯¦ç»è§£æåå­å¯¹é½çå·¥ä½æºå¶åå¶å¯¹ç¨åºæ§è½çå®éå½±åã\n\n\n# 2. ä½¿ç¨ç»æä½åå­å¯¹é½æææ¯æä¹æ ·çï¼\n\nåå»ºä¸¤ä¸ªç»æä½ï¼å¶ä¸­çæååéæ°éåç±»åå®æä¸è´ï¼åªæé¡ºåºææ¾çä¸ä¸æ ·ã\n\nimport (\n\t"fmt"\n\t"unsafe"\n)\n\ntype poorlyaligned struct {\n\tflag  bool\n\tcount int64\n\tid    byte\n}\n\ntype wellaligned struct {\n\tcount int64\n\tflag  bool\n\tid    byte\n}\n\nfunc main() {\n\tfmt.println(unsafe.sizeof(poorlyaligned{}))\n\tfmt.println(unsafe.sizeof(wellaligned{}))\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡ç»æå¦ä¸ï¼å¯ä»¥çå° poorlyaligned çåå­å¤§å°æ¯24ï¼è wellaligned çåå­å¤§å°æ¯ 16\n\n24\n16\n\n\n1\n2\n\n\nä¸ºä»ä¹æ¹äºåéçé¡ºåºï¼å´å¨åå­ä¸­çå¤§å°åä¸ä¸æ ·äºå¢ï¼\n\n\n# 3. ä»ä¹æ¯ç»æä½åå­å¯¹é½ï¼\n\ncpu è®¿é®åå­æ¶æ¯æ ¹æ®å­é¿æ¥è®¿é®èä¸æ¯å­èãæ¯å¦ 32 ä½ç cpu å­é¿æ¯ 4 å­èï¼64 ä½ç cpu æ¶ 8 å­èãè¿ä¹è®¾è®¡çç®çæ¯åå° cpu è®¿é®åå­çæ¬¡æ°ï¼æé«ååéã\n\nè¿ä¸ªæ¶åæä»¬çå°ç»æä½ poorlyalignedï¼boolæ¯ 4 å­èï¼int64 æ¯ 8 å­èï¼byteæ¯ 4 å­èï¼cpu è¯»å bool åé flag æ¶ï¼å ä¸ºå­é¿æ¯ 8 å­èï¼å¿é¡»å¾è¯» 8 ä¸ªå­èï¼æä»¥å¿é¡»å¾è¡¥ä¸ç©ºç 4 ä¸ªå­èãè int64 ç count åéæ¬èº«æ¯ 8 å­èçä¸éè¦è¡¥ä½ï¼è¯»byte ç id æ¶å flag ä¸æ ·ä¹éè¦è¡¥ 4 ä¸ªå­èï¼æç»æ¯ 24 ä¸ªå­èã\n\n\n\nåçå°ç»æä½ wellalignedï¼é¡ºåºæ¯ countãflagãidï¼count å¯ä»¥ä¸æ¬¡åèµ°ï¼è bool å¯ä»¥å id å¨åä¸æ¬¡ä¸èµ·åèµ°ï¼æä»¥æç»åªéè¦å¨åå­å­å¨ 16 ä¸ªå­èã\n\n\n\n\n# 4. éå¯¹ç»æä½æ¯å¦å¯¹é½çåºåæµè¯\n\nfunc benchmarkpoorlyaligned(b *testing.b) {\n\tfor range b.n {\n\t\tvar items = make([]poorlyaligned, 10_000_000)\n\t\tfor j := range items {\n\t\t\titems[j].count = int64(j)\n\t\t}\n\t}\n}\n\nfunc benchmarkwellaligned(b *testing.b) {\n\tfor range b.n {\n\t\tvar items = make([]wellaligned, 10_000_000)\n\t\tfor j := range items {\n\t\t\titems[j].count = int64(j)\n\t\t}\n\t}\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nè¿è¡ç»æå¦ä¸ï¼åå­å¯¹é½å¨éåº¦ä¸è¦å¿«ä¸çº¦ 35%ï¼åå­åéè¦å°ä¸çº¦ 50%\n\n$ go test -bench=. -benchmem . \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkpoorlyaligned-12            248           4575658 ns/op        240001038 b/op         1 allocs/op\nbenchmarkwellaligned-12              356           3392792 ns/op        160006157 b/op         1 allocs/op\npass\nok      main/demo       5.126s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 5. å¼å®¹ç¡¬ä»¶å¹³å°ä¸æ¶æ\n\næ¥ä¸æ¥çè¿ä¹ä¸ç§æåµï¼f1 int8å ç¨ 1 ä¸ªå­èï¼f2 int16å ç¨ 2 ä¸ªå­èï¼f3 int8 ä¹å ç¨ 1 ä¸ªå­èï¼ä½æ¯è¾åºçå­èå¤§å°å´æ¯ 6 èä¸æ¯ 4ï¼å ä¸ºè¿éä¹åäºåå­å¯¹é½ã\n\ntype s1 struct { \n\tf1 int8\n\tf2 int16\n\tf3 int8\n}\n\nfunc main() {\n\ts1 := s1{}\n\tfmt.println(unsafe.sizeof(s1))\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n\n\nè¿è¡è¾åºï¼\n\n6\n\n\n1\n\n\né®é¢æ¥äºï¼æä½ç³»ç»ä¸ä¸ªå­é¿ 8 ä¸ªå­èï¼é£ä¹æ è®ºæ¯ 4 è¿æ¯ 6 cpu é½è½å¤ä¸æ¬¡æ¿å°æ´ä½æ°æ®ï¼æçæ¯ä¸æ ·çåã\n\nè¿æ¯å ä¸ºï¼åå­å¯¹é½ä¸ä»ä»æ¯ä¸ºäºä¿è¯ cpu çè¯»åæçï¼è¿æå°±æ¯ä¸ºäºå¼å®¹ç¡¬ä»¶å¹³å°åæ¶æåçéå¶ï¼æ¯å¦å¨ cpu æ¯ armæ¶æ æ¶å¼ºå¶è¦ååå­å¯¹é½çï¼ä¸åçè¯åä¼ç´æ¥æ¥éã\n\né£ä¹è¿éçå¯¹é½è§åæ¯æä¹æ ·çå¢ï¼\n\n\n# 6. åå­å¯¹é½è§å\n\n\n# 6.1 å¯¹é½ç³»æ°\n\nå­æ®µç±»åä¸ä»æç±»åå¤§å°ï¼è¿æç±»åå¯¹é½ç³»æ°ï¼ å¶æä»¥ä¸ä¸¤ä¸ªè§å\n\n * goåå§ç±»åçå¯¹é½ç³»æ°ä¸ç±»åé¿åº¦ç¸ç­ã\n\nå¯ä»¥ä½¿ç¨unsafe.alignofæ¥æ¥çç±»åçå¯¹é½ç³»æ°ï¼å¯ä»¥åç°ä¸¤èæ¯ä¸è´çã\n\nfunc main() {\n\tfmt.println(unsafe.sizeof(int64(1)))      // 8\n\tfmt.println(unsafe.sizeof(float32(32)))   // 4\n\n\tfmt.println(unsafe.alignof(int64(1)))     // 8\n\tfmt.println(unsafe.alignof(float32(32)))  //4\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n * goç»æä½ç±»åçå¯¹é½ç³»æ°æ¯æé¿å­æ®µçå¯¹é½ç³»æ°åç³»ç»å¯¹é½ç³»æ°ä¸¤èä¸­çæå°çé£ä¸ªã\n\nå¯ä»¥çå°ç»æä½çå¯¹é½ç³»æ°æ¯ 2ï¼è¿æ¯å ä¸ºæé¿å­æ®µæ¯ f2 å¶å¯¹é½ç³»æ°æ¯ 2ï¼æä½ç³»ç»æ¯ 64 ä½ï¼å¶å¯¹é½ç³»æ°æ¯ 8ï¼åæå°çä¹å°±æ¯ 2\n\ntype s1 struct { \n\tf1 int8\n\tf2 int16\n\tf3 int8\n}\n\nfunc main() {\n\ts1 := s1{}\n\tfmt.println(unsafe.sizeof(s1))    // 6\n\tfmt.println(unsafe.alignof(s1))   // 2\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# 6.2 å­æ®µåç§»é\n\nå­æ®µåç§»éæ¯æå¨ç»æä½åå­å¯¹é½åå­æ®µä»èµ·å§ä½ç½®å¼å§çåç§»éï¼ä¹å°±æ¯ä»èµ·å§ä½ç½®å¼å§è®¡ç®çå­èæ°ï¼ç¬¬ä¸ä¸ªå­æ®µçåç§»éæ¯ 0ã\n\n\n# 6.3 struct åå­å¯¹é½è§å\n\nå¯¹é½è§åå¦ä¸ï¼\n\n * ç»æä½ä¸­çæ¯ä¸ªå­æ®µæå¨çåç§»éå¿é¡»æ¯å¶å¯¹é½ç³»æ°çæ´æ°åï¼å¦æä¸è½ä¿è¯åéè¦æ·»å ç©ºçå­èæ¥ä¿è¯åå­å¯¹é½ã\n * ç»æä½çé¿åº¦ä¸å®è¦æ¯å¶æ¬èº«å¯¹é½ç³»æ°çæ´æ°åã\n\nç¥éè§ååï¼ååå°ä¹åç s1 çä¾å­ï¼\n\n * f1 çåç§»éä¸º0ï¼å ç¨ 1 ä¸ªå­èï¼é»è®¤æ¯å¯¹é½çã\n * f2 çå¯¹é½ç³»æ°æ¯2ï¼å¦æä»åç§»é 1 å¼å§å­å¨ï¼åä¸æ¯2çåæ°ï¼å¿é¡»åé¢ç©ºåºä¸ä¸ªï¼ä»åç§»é2å¼å§ï¼ææ¯å¯¹é½ç³»æ°çåæ°ï¼æä»¥ä»åç§»éä»2å¼å§å­å¨ï¼å¹¶å­å¨2ä¸ªå­è\n * f3 çå¯¹é½ç³»æ°æ¯1ï¼ä»åç§»é 5 å¼å§å­å¨ï¼å­å¨ 1 ä¸ªå­èï¼æ¯å¯¹é½çã\n * æ¬ç»æä½çå¯¹é½ç³»æ°æ¯ 2ï¼èå¤§å°éè¦æ¶å¯¹é½ç³»æ°çæ´æ°åï¼èæ ¹æ®åé¢å æ­¥çé¿åº¦æ¯ 5ï¼ä¸è½å¯¹é½ï¼æä»¥è¿éè¦ç©ºåºä¸ä¸ªå­èæè½ä½¿ç»æä½å¯¹é½ï¼ä¹å°±æ¯é¿åº¦ä¸º 6 å­è\n\ntype s1 struct {   // é¿åº¦:6, å¯¹é½ç³»æ°: 2\n\tf1 int8        // é¿åº¦:1, å¯¹é½ç³»æ°: 1\n\tf2 int16       // é¿åº¦:2, å¯¹é½ç³»æ°: 2\n\tf3 int8        // é¿åº¦:1, å¯¹é½ç³»æ°: 1\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n\n\n# 6.4 struct{} ä½ä¸ºç»æä½æåä¸ä¸ªå­æ®µ\n\nstruct{}è¿æ ·çç©ºç»æä½çå¤§å°æ¯ä¸º 0 çï¼å¦æå¶ä½ä¸ºå¶ä»ç»æä½å­æ®µçæ¶åï¼æ¯ä¸å ç¨åå­çï¼ä¹ä¸éè¦èèåå­å¯¹é½çé®é¢ï¼ä½åªæä¸ç§æåµä¾å¤ï¼å°±æ¯struct{}ä½ä¸ºç»æä½çæåä¸ä¸ªå­æ®µæ¶ï¼æ¯ä¼è¿è¡åå­å¯¹é½çï¼èå¶å¯¹é½è§åæ¯ï¼ä¼è¢«å¡«åå¯¹é½å°åä¸ä¸ªå­æ®µçå¤§å°ã\n\nè¿æ¯å ä¸ºå¦æææéæåè¯¥å­æ®µ, è¿åçå°åå°å¨ç»æä½ä¹å¤ï¼å¦ææ­¤æéä¸ç´å­æ´»ä¸éæ¾å¯¹åºçåå­ï¼å°±ä¼æåå­æ³é²çé®é¢ï¼è¯¥åå­ä¸å ç»æä½éæ¾èéæ¾ï¼\n\nå·ä½æ¡ä¾å¦ä¸ï¼demo1ãdemo2ãdemo3ä¸­çstruct{}çé½ä¼æç§åä¸ä¸ªå­æ®µçå¤§å°è¿è¡å¡«åå¯¹é½ã\n\ntype demo1 struct {\n\tc int8\n\ta struct{}\n}\n\ntype demo2 struct {\n\tc int16\n\ta struct{}\n}\n\ntype demo3 struct {\n\tc int32\n\ta struct{}\n}\n\ntype demo4 struct {\n\ta struct{}\n\tc int32\n}\n\nfunc main() {\n\tfmt.println(unsafe.sizeof(demo1{})) // 2\n\tfmt.println(unsafe.sizeof(demo2{})) // 4\n\tfmt.println(unsafe.sizeof(demo3{})) // 8\n\tfmt.println(unsafe.sizeof(demo4{})) // 4\n}\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n\n\n\n# 7. fieldalignment linter\n\néè¿ä½¿ç¨fieldalignment linterå·¥å·å¯ä»¥æååç°åå­å¯¹é½é®é¢ï¼å¯ä»¥å¸®å©æä»¬æ¥å¯¹ç»æä½ä¸­çå­æ®µé¡ºåºè¿è¡æ­£ç¡®çæåï¼åå°åå­çå ç¨ï¼æé«è¿è¡çæçã\n\nè¯¥ç»æä½éè¿ä¸é¢çåæï¼é¿åº¦ä¸º 6ï¼ä¸ºäºåå­å¯¹é½æ¯è¡¥äº 2 ä¸ªå­èçã\n\ntype s1 struct {\n\tf1 int8\n\tf2 int16\n\tf3 int8\n}\n\n\n1\n2\n3\n4\n5\n\n\nå¨é¡¹ç®ä¸­æ°å¢æä»¶.golangci.yamlï¼åå®¹å¦ä¸ï¼ä¸»è¦æ¯å° fieldalignmeng åè½å¼å¯\n\nversion: 2\nlinters:\n  default: all\n  enable:\n    - govet\n  settings:\n    govet:\n      enable:\n        - fieldalignment\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\nç¶åè¿è¡golangci-lintä¼ææç¤ºï¼ç»æä½çå¤§å°å¯ä»¥è¢«ä¼åï¼ä» 6 å° 4\n\n$ golangci-lint run\n...\nmain.go:9:9: fieldalignment: struct of size 6 could be 4 (govet)\ntype s1 struct {\n...\n\n\n1\n2\n3\n4\n5\n\n\nä¿®æ¹ç»æä½ä¸­å­æ®µé¡ºåºä¸ºä¸éè¦è¡¥é½åå­çæ¹å¼ï¼åæ¬¡è¿è¡ä¸é¢çå½ä»¤åï¼ä¸é¢çæç¤ºéè¯¯ä¿¡æ¯å°±æ²¡æäºã\n\ntype s1 struct {\n\tf1 int8\n\tf3 int8\n\tf2 int16\n}\n\n\n1\n2\n3\n4\n5\n\n\n\n# 8. æä½³å®è·µ\n\n * éè¿å¯¹å­æ®µçæåºæ¥åå°åé¨æ æä¹çå¡«åã\n * å°½å¯è½å°ç±»åå¤§å°ç¸åçå­æ®µæ¾å¨ä¸èµ·ï¼é¿åå¤§å°äº¤æ¿ã\n * ä½¿ç¨ fieldalignment linter å¯¹ä»£ç è¿è¡æ ¡éªï¼éè¿å·¥å·èªå¨æè·',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£",frontmatter:{title:"Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£",date:"2025-06-14T22:47:01.000Z",permalink:"/pages/d8ed61/",categories:["ç¼ç¨","goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],tags:["goè¯­è¨","goè¯­è¨é«æ§è½ç¼ç¨"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ·±å¥è§£æGoè¯­è¨ä¸­ç¼å²I/Oçå·¥ä½åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«åºåæµè¯æ°æ®å¯¹æ¯åå®éåºç¨åºæ¯åæ",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£"},{name:"twitter:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­ç¼å²I/Oçå·¥ä½åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«åºåæµè¯æ°æ®å¯¹æ¯åå®éåºç¨åºæ¯åæ"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/13.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%95%88IO%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3.html"},{property:"og:type",content:"article"},{property:"og:title",content:"Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£"},{property:"og:description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­ç¼å²I/Oçå·¥ä½åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«åºåæµè¯æ°æ®å¯¹æ¯åå®éåºç¨åºæ¯åæ"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/13.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%95%88IO%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-06-14T22:47:01.000Z"},{property:"article:tag",content:"goè¯­è¨"},{property:"article:tag",content:"goè¯­è¨é«æ§è½ç¼ç¨"},{itemprop:"name",content:"Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£"},{itemprop:"description",content:"æ·±å¥è§£æGoè¯­è¨ä¸­ç¼å²I/Oçå·¥ä½åçãæ§è½ä¼å¿åæä½³å®è·µï¼åå«åºåæµè¯æ°æ®å¯¹æ¯åå®éåºç¨åºæ¯åæ"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/02.go%E8%AF%AD%E8%A8%80/07.go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/13.Go%E8%AF%AD%E8%A8%80%E9%AB%98%E6%95%88IO%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3.html",relativePath:"04.ç¼ç¨/02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/13.Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£.md",key:"v-99455fdc",path:"/pages/d8ed61/",headers:[{level:2,title:"1. ç®ä»",slug:"_1-ç®ä»",normalizedTitle:"1. ç®ä»",charIndex:2},{level:2,title:"2. ä¸å¸¦ç¼å²çåå¥",slug:"_2-ä¸å¸¦ç¼å²çåå¥",normalizedTitle:"2. ä¸å¸¦ç¼å²çåå¥",charIndex:187},{level:2,title:"3. å¸¦ç¼å²çåå¥",slug:"_3-å¸¦ç¼å²çåå¥",normalizedTitle:"3. å¸¦ç¼å²çåå¥",charIndex:374},{level:2,title:"4. æ§å¶ç¼å²åºå®¹é",slug:"_4-æ§å¶ç¼å²åºå®¹é",normalizedTitle:"4. æ§å¶ç¼å²åºå®¹é",charIndex:609},{level:2,title:"5. å¸¦ç¼å²ä¸ä¸å¸¦ç¼å²ç Benchmark",slug:"_5-å¸¦ç¼å²ä¸ä¸å¸¦ç¼å²ç-benchmark",normalizedTitle:"5. å¸¦ç¼å²ä¸ä¸å¸¦ç¼å²ç benchmark",charIndex:760},{level:2,title:"6. æ»ç»",slug:"_6-æ»ç»",normalizedTitle:"6. æ»ç»",charIndex:2681}],headersStr:"1. ç®ä» 2. ä¸å¸¦ç¼å²çåå¥ 3. å¸¦ç¼å²çåå¥ 4. æ§å¶ç¼å²åºå®¹é 5. å¸¦ç¼å²ä¸ä¸å¸¦ç¼å²ç Benchmark 6. æ»ç»",content:'# 1. ç®ä»\n\nå¨è®¡ç®æºç³»ç»ä¸­ï¼I/Oæä½ï¼å¦æä»¶è¯»åãç½ç»éä¿¡ï¼æ¯æ§è½ç¶é¢çä¸»è¦æ¥æºä¹ä¸ãä¸»è¦åå åæ¬ï¼\n\n 1. ç³»ç»è°ç¨å¼éï¼æ¯æ¬¡ç´æ¥I/Oæä½é½æ¶åç¨æ·æååæ ¸æçä¸ä¸æåæ¢\n 2. ç¡¬ä»¶éå¶ï¼ç£çåç½ç»è®¾å¤æ´éåå¤§åæ°æ®ä¼ è¾\n 3. é¢ç¹å°æ°æ®æä½ï¼å¤§éå°æ°æ®åå¥ä¼æ¾èéä½æ§è½\n\nç¼å²ææ¯éè¿å¨åå­ä¸­èåæ°æ®ï¼åå°å®éI/Oæä½æ¬¡æ°ï¼å¯æ¾èæåæ§è½ã\n\n\n# 2. ä¸å¸¦ç¼å²çåå¥\n\nç´æ¥é¢ç¹è°ç¨ç³»ç»APIï¼æ§è½æå·®ï¼\n\n// æ¯æ¬¡åå¥é½è§¦åç³»ç»è°ç¨\nf, _ := os.Create("output.txt")\ndefer f.Close()\n\nfor i := 0; i < 10000; i++ {\n    f.Write([]byte("line\\n"))  // é«ææ¬æä½\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# 3. å¸¦ç¼å²çåå¥\n\nä½¿ç¨bufio.Writerèªå¨ç¼å²ï¼\n\nf, _ := os.Create("output.txt")\ndefer f.Close()\n\nbuf := bufio.NewWriter(f)  // é»è®¤4KBç¼å²\nfor i := 0; i < 10000; i++ {\n    buf.WriteString("line\\n")  // åå­æä½\n}\nbuf.Flush()  // æç»åå¥ç£ç\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 4. æ§å¶ç¼å²åºå®¹é\n\næ ¹æ®åºæ¯è°æ´ç¼å²åºå¤§å°ï¼\n\nf, _ := os.Create("output.txt")\ndefer f.Close()\n\n// 16KBç¼å²ï¼éåå¤§æä»¶åå¥\nbuf := bufio.NewWriterSize(f, 16*1024)  \n\n\n1\n2\n3\n4\n5\n\n\n\n# 5. å¸¦ç¼å²ä¸ä¸å¸¦ç¼å²ç Benchmark\n\næ¯è¾éè¿ç´æ¥è°ç¨os.File.Writeç¸æ¯ï¼ä½¿ç¨bufio.Writeråç£çåå¥ä¸ç¾ä¸è¡æ°æ®ã\n\npackage perf\n\nimport (\n    "bufio"\n    "io"\n    "os"\n    "strconv"\n    "sync"\n    "testing"\n)\n\ntype Data struct {\n    Value []byte\n}\n\nvar dataPool = sync.Pool{\n    New: func() any {\n        return &Data{Value: make([]byte, 0, 32)}\n    },\n}\n\nconst N = 10000\n\nfunc writeNotBuffered(w io.Writer, count int) {\n    for i := 0; i < count; i++ {\n        d := dataPool.Get().(*Data)\n        d.Value = strconv.AppendInt(d.Value[:0], int64(i), 10)\n        w.Write(d.Value)\n        w.Write([]byte(":val\\n"))\n        dataPool.Put(d)\n    }\n}\n\nfunc writeBuffered(w io.Writer, count int) {\n    buf := bufio.NewWriterSize(w, 16*1024)\n    for i := 0; i < count; i++ {\n        d := dataPool.Get().(*Data)\n        d.Value = strconv.AppendInt(d.Value[:0], int64(i), 10)\n        buf.Write(d.Value)\n        buf.Write([]byte(":val\\n"))\n        dataPool.Put(d)\n    }\n    buf.Flush()\n}\n\nfunc BenchmarkWriteNotBuffered(b *testing.B) {\n    for b.Loop() {\n        f, _ := os.CreateTemp("", "nobuf")\n        writeNotBuffered(f, N)\n        f.Close()\n        os.Remove(f.Name())\n    }\n}\n\nfunc BenchmarkWriteBuffered(b *testing.B) {\n    for b.Loop() {\n        f, _ := os.CreateTemp("", "buf")\n        writeBuffered(f, N)\n        f.Close()\n        os.Remove(f.Name())\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n\n\nè¿è¡ç»æå¦ä¸ï¼å¸¦ç¼å²çæ§è½æåäºçº¦ 62 åï¼ä½åå­ç³è¯·å¤äº 30%ã\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: Apple M4 Pro\nBenchmarkWriteNotBuffered-12                  64          18470001 ns/op           53758 B/op      10007 allocs/op\nBenchmarkWriteBuffered-12                   3984            297904 ns/op           70122 B/op      10008 allocs/op\nPASS\nok      main/demo       3.530s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 6. æ»ç»\n\nåºç¨åºæ¯\n\n 1. é¢ç¹çæ§è¡å°æ°æ®éç I/Oã\n 2. åå°ç³»ç»è°ç¨ã\n 3. é«ååéæ¯å»¶è¿æ´éè¦ã\n\nä¸éç¨åºæ¯\n\n 1. å®æ¶æ§è¦æ±é«ã\n 2. è¿åº¦ç¼å²å¯¼è´åå­ä½¿ç¨ä¸åæ§å¶ã',normalizedContent:'# 1. ç®ä»\n\nå¨è®¡ç®æºç³»ç»ä¸­ï¼i/oæä½ï¼å¦æä»¶è¯»åãç½ç»éä¿¡ï¼æ¯æ§è½ç¶é¢çä¸»è¦æ¥æºä¹ä¸ãä¸»è¦åå åæ¬ï¼\n\n 1. ç³»ç»è°ç¨å¼éï¼æ¯æ¬¡ç´æ¥i/oæä½é½æ¶åç¨æ·æååæ ¸æçä¸ä¸æåæ¢\n 2. ç¡¬ä»¶éå¶ï¼ç£çåç½ç»è®¾å¤æ´éåå¤§åæ°æ®ä¼ è¾\n 3. é¢ç¹å°æ°æ®æä½ï¼å¤§éå°æ°æ®åå¥ä¼æ¾èéä½æ§è½\n\nç¼å²ææ¯éè¿å¨åå­ä¸­èåæ°æ®ï¼åå°å®éi/oæä½æ¬¡æ°ï¼å¯æ¾èæåæ§è½ã\n\n\n# 2. ä¸å¸¦ç¼å²çåå¥\n\nç´æ¥é¢ç¹è°ç¨ç³»ç»apiï¼æ§è½æå·®ï¼\n\n// æ¯æ¬¡åå¥é½è§¦åç³»ç»è°ç¨\nf, _ := os.create("output.txt")\ndefer f.close()\n\nfor i := 0; i < 10000; i++ {\n    f.write([]byte("line\\n"))  // é«ææ¬æä½\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\n\n# 3. å¸¦ç¼å²çåå¥\n\nä½¿ç¨bufio.writerèªå¨ç¼å²ï¼\n\nf, _ := os.create("output.txt")\ndefer f.close()\n\nbuf := bufio.newwriter(f)  // é»è®¤4kbç¼å²\nfor i := 0; i < 10000; i++ {\n    buf.writestring("line\\n")  // åå­æä½\n}\nbuf.flush()  // æç»åå¥ç£ç\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\n\n# 4. æ§å¶ç¼å²åºå®¹é\n\næ ¹æ®åºæ¯è°æ´ç¼å²åºå¤§å°ï¼\n\nf, _ := os.create("output.txt")\ndefer f.close()\n\n// 16kbç¼å²ï¼éåå¤§æä»¶åå¥\nbuf := bufio.newwritersize(f, 16*1024)  \n\n\n1\n2\n3\n4\n5\n\n\n\n# 5. å¸¦ç¼å²ä¸ä¸å¸¦ç¼å²ç benchmark\n\næ¯è¾éè¿ç´æ¥è°ç¨os.file.writeç¸æ¯ï¼ä½¿ç¨bufio.writeråç£çåå¥ä¸ç¾ä¸è¡æ°æ®ã\n\npackage perf\n\nimport (\n    "bufio"\n    "io"\n    "os"\n    "strconv"\n    "sync"\n    "testing"\n)\n\ntype data struct {\n    value []byte\n}\n\nvar datapool = sync.pool{\n    new: func() any {\n        return &data{value: make([]byte, 0, 32)}\n    },\n}\n\nconst n = 10000\n\nfunc writenotbuffered(w io.writer, count int) {\n    for i := 0; i < count; i++ {\n        d := datapool.get().(*data)\n        d.value = strconv.appendint(d.value[:0], int64(i), 10)\n        w.write(d.value)\n        w.write([]byte(":val\\n"))\n        datapool.put(d)\n    }\n}\n\nfunc writebuffered(w io.writer, count int) {\n    buf := bufio.newwritersize(w, 16*1024)\n    for i := 0; i < count; i++ {\n        d := datapool.get().(*data)\n        d.value = strconv.appendint(d.value[:0], int64(i), 10)\n        buf.write(d.value)\n        buf.write([]byte(":val\\n"))\n        datapool.put(d)\n    }\n    buf.flush()\n}\n\nfunc benchmarkwritenotbuffered(b *testing.b) {\n    for b.loop() {\n        f, _ := os.createtemp("", "nobuf")\n        writenotbuffered(f, n)\n        f.close()\n        os.remove(f.name())\n    }\n}\n\nfunc benchmarkwritebuffered(b *testing.b) {\n    for b.loop() {\n        f, _ := os.createtemp("", "buf")\n        writebuffered(f, n)\n        f.close()\n        os.remove(f.name())\n    }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n\n\nè¿è¡ç»æå¦ä¸ï¼å¸¦ç¼å²çæ§è½æåäºçº¦ 62 åï¼ä½åå­ç³è¯·å¤äº 30%ã\n\n$ go test -bench=. -benchmem .  \ngoos: darwin\ngoarch: arm64\npkg: main/demo\ncpu: apple m4 pro\nbenchmarkwritenotbuffered-12                  64          18470001 ns/op           53758 b/op      10007 allocs/op\nbenchmarkwritebuffered-12                   3984            297904 ns/op           70122 b/op      10008 allocs/op\npass\nok      main/demo       3.530s\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# 6. æ»ç»\n\nåºç¨åºæ¯\n\n 1. é¢ç¹çæ§è¡å°æ°æ®éç i/oã\n 2. åå°ç³»ç»è°ç¨ã\n 3. é«ååéæ¯å»¶è¿æ´éè¦ã\n\nä¸éç¨åºæ¯\n\n 1. å®æ¶æ§è¦æ±é«ã\n 2. è¿åº¦ç¼å²å¯¼è´åå­ä½¿ç¨ä¸åæ§å¶ã',charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"å¿«éäºè§£iptables",frontmatter:{title:"å¿«éäºè§£iptables",date:"2023-05-15T19:19:11.000Z",permalink:"/pages/72ba9a/",categories:["ç¼ç¨","linux"],tags:["linux","è®¡ç®æºç½ç»","Linuxç½ç»èæå"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"iptablesæ¯ä¸ä¸ªå¨Linuxæä½ç³»ç»ä¸ä½¿ç¨çé²ç«å¢å·¥å·ï¼å®å¯ä»¥ç¨äºéç½®åç®¡çç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230514151755-we6q131.png"},{name:"twitter:title",content:"å¿«éäºè§£iptables"},{name:"twitter:description",content:"iptablesæ¯ä¸ä¸ªå¨Linuxæä½ç³»ç»ä¸ä½¿ç¨çé²ç«å¢å·¥å·ï¼å®å¯ä»¥ç¨äºéç½®åç®¡çç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230514151755-we6q131.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/01.%E5%BF%AB%E9%80%9F%E4%BA%86%E8%A7%A3iptables.html"},{property:"og:type",content:"article"},{property:"og:title",content:"å¿«éäºè§£iptables"},{property:"og:description",content:"iptablesæ¯ä¸ä¸ªå¨Linuxæä½ç³»ç»ä¸ä½¿ç¨çé²ç«å¢å·¥å·ï¼å®å¯ä»¥ç¨äºéç½®åç®¡çç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230514151755-we6q131.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/01.%E5%BF%AB%E9%80%9F%E4%BA%86%E8%A7%A3iptables.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-05-15T19:19:11.000Z"},{property:"article:tag",content:"linux"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"Linuxç½ç»èæå"},{itemprop:"name",content:"å¿«éäºè§£iptables"},{itemprop:"description",content:"iptablesæ¯ä¸ä¸ªå¨Linuxæä½ç³»ç»ä¸ä½¿ç¨çé²ç«å¢å·¥å·ï¼å®å¯ä»¥ç¨äºéç½®åç®¡çç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230514151755-we6q131.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/03.linux/01.%E5%BF%AB%E9%80%9F%E4%BA%86%E8%A7%A3iptables.html",relativePath:"04.ç¼ç¨/03.linux/01.å¿«éäºè§£iptables.md",key:"v-7f2a6202",path:"/pages/72ba9a/",headers:[{level:2,title:"åè¯",slug:"åè¯",normalizedTitle:"åè¯",charIndex:2},{level:3,title:"iptablesæ¯ä»ä¹ï¼",slug:"iptablesæ¯ä»ä¹",normalizedTitle:"iptablesæ¯ä»ä¹ï¼",charIndex:9},{level:3,title:"Netfilteræ¯ä»ä¹ï¼",slug:"netfilteræ¯ä»ä¹",normalizedTitle:"netfilteræ¯ä»ä¹ï¼",charIndex:267},{level:3,title:"iptableså®ç°",slug:"iptableså®ç°",normalizedTitle:"iptableså®ç°",charIndex:1020},{level:2,title:"iptablesä¸æ¿æ§ï¼tableãchainårule",slug:"iptablesä¸æ¿æ§-tableãchainårule",normalizedTitle:"iptablesä¸æ¿æ§ï¼tableãchainårule",charIndex:1140},{level:3,title:"chain",slug:"chain",normalizedTitle:"chain",charIndex:1158},{level:3,title:"table",slug:"table",normalizedTitle:"table",charIndex:11},{level:3,title:"rule",slug:"rule",normalizedTitle:"rule",charIndex:1164},{level:2,title:"iptableså½ä»¤ä½¿ç¨",slug:"iptableså½ä»¤ä½¿ç¨",normalizedTitle:"iptableså½ä»¤ä½¿ç¨",charIndex:2402},{level:3,title:"åæ°",slug:"åæ°",normalizedTitle:"åæ°",charIndex:2419},{level:3,title:"å¸¸è§æ­¦å¨",slug:"å¸¸è§æ­¦å¨",normalizedTitle:"å¸¸è§æ­¦å¨",charIndex:3390},{level:2,title:"å·¨äººçè©è",slug:"å·¨äººçè©è",normalizedTitle:"å·¨äººçè©è",charIndex:4926}],headersStr:"åè¯ iptablesæ¯ä»ä¹ï¼ Netfilteræ¯ä»ä¹ï¼ iptableså®ç° iptablesä¸æ¿æ§ï¼tableãchainårule chain table rule iptableså½ä»¤ä½¿ç¨ åæ° å¸¸è§æ­¦å¨ å·¨äººçè©è",content:"# åè¯\n\n\n# iptablesæ¯ä»ä¹ï¼\n\niptablesæ¯ä¸ä¸ªå¨Linuxæä½ç³»ç»ä¸ä½¿ç¨çé²ç«å¢å·¥å·ï¼å®å¯ä»¥ç¨äºéç½®åç®¡çç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã\n\n 1. è¿æ»¤æ°æ®åï¼iptableså¯ä»¥æ ¹æ®ä¸åçè§åè¿æ»¤ç½ç»æ°æ®åï¼ä¾å¦æ ¹æ®æºIPå°åãç®æ IPå°åãç«¯å£å·ç­è¿è¡è¿æ»¤ã\n\n 2. è½¬åæ°æ®åï¼iptableså¯ä»¥å°ç½ç»æ°æ®åä»ä¸ä¸ªæ¥å£è½¬åå°å¦ä¸ä¸ªæ¥å£ï¼å®ç°ç½ç»æ°æ®çè½¬ååè½ã\n\n 3. ä¿®æ¹æ°æ®åï¼iptableså¯ä»¥ä¿®æ¹ç½ç»æ°æ®åçæºIPå°åãç®æ IPå°åãç«¯å£å·ç­ä¿¡æ¯ï¼å®ç°ç½ç»æ°æ®çä¼ªè£åæ¬ºéªã\n\n\n# Netfilteræ¯ä»ä¹ï¼\n\nNetfilteræ¯Linuxåæ ¸ä¸­çä¸ä¸ªç½ç»æ°æ®åè¿æ»¤æ¡æ¶ï¼å®å¯ä»¥å¨æ°æ®åè¿å¥åç¦»å¼ç½ç»æ¥å£æ¶è¿è¡æ¦æªåå¤çãiptableså°±æ¯åºäºNetfilteræ¡æ¶å®ç°çä¸ä¸ªç¨æ·ç©ºé´å·¥å·ï¼å®å¯ä»¥éè¿è°ç¨Netfilteræä¾çAPIæ¥å®ç°ç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã\n\nnetfilterçæ¶æå°±æ¯å¨æ´ä¸ªç½ç»æµç¨çè¥å¹²ä½ç½®æ¾ç½®ä¸äºé©å­ï¼å¹¶å¨æ¯ä¸ªé©å­ä¸æè½½ä¸äºå¤çå½æ°è¿è¡å¤çã\n\nIPå±ç5ä¸ªé©å­ç¹çä½ç½®ï¼åå«æ¯PREROUTINGãPOSTROUTINGãINPUTãOUTPUTåFORWARDãåçå¾å¦ä¸ï¼\n\nâ\n\nâ\n\nå½ç½å¡ä¸æ¶å°ä¸ä¸ªåéè¾¾åè®®æ æ¶ï¼æåç»è¿çnetfilteré©å­æ¯PREROUTINGï¼å¦æç¡®å®æç¨æ·åäºè¿ä¸ªé©å­å½æ°ï¼é£ä¹åæ ¸å°å¨è¿éå¯¹æ°æ®åè¿è¡ç®çå°åè½¬æ¢ï¼DNATï¼ãä¸ç®¡å¨PREROUTINGææ²¡æåè¿DNATï¼åæ ¸é½ä¼éè¿æ¥æ¬å°è·¯ç±è¡¨å³å®è¿ä¸ªæ°æ®åæ¯åéç»æ¬å°è¿ç¨è¿æ¯åéç»å¶ä»æºå¨ãå¦ææ¯åéç»å¶ä»æºå¨ï¼æå¶ä»network namespaceï¼ï¼å°±ç¸å½äºææ¬å°å½ä½è·¯ç±å¨ï¼å°±ä¼ç»è¿netfilterçFORWARDé©å­ï¼ç¨æ·å¯ä»¥å¨æ­¤å¤è®¾ç½®åè¿æ»¤é©å­å½æ°ï¼ä¾å¦iptablesçrejectå½æ°ãææé©¬ä¸è¦åå°åè®®æ å¤çåé½ä¼ç»è¿POSTROUTINGé©å­ï¼ç¨æ·å¯ä»¥å¨è¿éåä¸æºå°åè½¬æ¢ï¼SNATï¼ææºå°åä¼ªè£ï¼Masqueradeï¼ç®ç§°Masqï¼çé©å­å½æ°ãå¦æç»è¿ä¸é¢çè·¯ç±å³ç­ï¼åæ ¸å³å®æååç»æ¬å°è¿ç¨ï¼å°±ä¼ç»è¿INPUTé©å­ãæ¬å°è¿ç¨æ¶å°æ°æ®ååï¼åç¨æ¥æä¼åç»è¿OUTPUTé©å­ï¼ç¶åç»è¿ä¸æ¬¡è·¯ç±å³ç­ï¼ä¾å¦ï¼å³å®ä»æºå¨çåªåç½å¡åºå»ï¼ä¸ä¸è·³å°åæ¯å¤å°ç­ï¼ï¼æååºåè®®æ çç½ç»ååæ ·ä¼ç»è¿POSTROUTINGé©å­ã\n\n\n# iptableså®ç°\n\niptablesçåºå±å®ç°æ¯éè¿Linuxåæ ¸ä¸­çNetfilteræ¡æ¶æ¥å®ç°çãiptablesæ¯ç¨æ·ç©ºé´çä¸ä¸ªç¨åºï¼éè¿netlinkååæ ¸çnetfilteræ¡æ¶æäº¤éï¼è´è´£å¾é©å­ä¸éç½®åè°å½æ°ã\n\n\n\n\n# iptablesä¸æ¿æ§ï¼tableãchainårule\n\n\n# chain\n\niptablesæ5æ¡åç½®é¾åå«å¯¹åºçnetfilterç5ä¸ªé©å­ï¼\n\n * INPUTé¾ï¼ä¸è¬ç¨äºå¤çè¾å¥æ¬å°è¿ç¨çæ°æ®åã\n * OUTPUTé¾ï¼ä¸è¬ç¨äºå¤çæ¬å°è¿ç¨çè¾åºæ°æ®åã\n * FORWARDé¾ï¼ä¸è¬ç¨äºå¤çè½¬åå°å¶ä»æºå¨/network namespaceçæ°\n   æ®åã\n * PREROUTINGé¾ï¼å¯ä»¥å¨æ­¤å¤è¿è¡DNATã\n * POSTROUTINGé¾ï¼å¯ä»¥å¨æ­¤å¤è¿è¡SNATã\n\n\n# table\n\né¤äº5æ¡åç½®é¾ä¹å¤ï¼è¿å¯ä»¥å¨è¡¨ä¸­å®ä¹èªå·±çé¾ï¼\n\n * filter è¡¨ï¼ç¨äºè¿æ»¤æ°æ®åï¼æ¯é»è®¤çè¡¨ãå®åå« INPUTãOUTPUT å FORWARD ä¸ä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºçæ°æ®åãä»æ¬æºååºçæ°æ®ååè½¬åçæ°æ®åã\n\n * nat è¡¨ï¼ç¨äºç½ç»å°åè½¬æ¢ï¼NATï¼ãå®åå« PREROUTINGãPOSTROUTING å OUTPUT ä¸ä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºåçæ°æ®åãä»æ¬æºååºçæ°æ®ååæ¬æºçæçæ°æ®åã\n\n * mangle è¡¨ï¼ç¨äºä¿®æ¹æ°æ®åçç¹å®å­æ®µãå¦ TTLãTOS ç­ãå®åå« PREROUTINGãINPUTãFORWARDãOUTPUT å POSTROUTING äºä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºåçæ°æ®åãè¿å¥æ¬æºçæ°æ®åãè½¬åçæ°æ®åãä»æ¬æºååºçæ°æ®ååæ¬æºçæçæ°æ®åã\n\n * raw è¡¨ï¼ç¨äºéç½®è¿æ¥è¿½è¸ªç³»ç»ãå®åå« PREROUTING å OUTPUT ä¸¤ä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºåçæ°æ®ååä»æ¬æºååºçæ°æ®åã\n\nè¿5å¼ è¡¨çä¼åçº§ä»é«å°ä½æ¯ï¼rawãmangleãnatãfilterãsecurityã\n\niptablesè¡¨ä¸é¾çå¯¹åºå³ç³»å¾å¦ä¸ï¼\n\nâ\n\n\n\nä¸åçè¡¨æä¸åçé¾ï¼è¿æ¯ä¸ºäºåç±»ç®¡çiptablesè§åï¼ruleï¼çï¼ç³»ç»ææçiptablesè§åé½è¢«ååå°ä¸åçè¡¨éåä¸­ã\n\n\n# rule\n\niptablesçè§åå°±æ¯æè½½netfilteré©å­ä¸çå½æ°ï¼ç¨æ¥ä¿®æ¹æ°æ®åçåå®¹æèè¿æ»¤æ°æ®åç­æä½ï¼iptablesçè¡¨å°±æ¯ææè§åç5ä¸ªé»è¾éåã\n\niptablesè§åå¦ä½ç¼åï¼\n\nä¸æ¡iptablesè§ååå«ä¸¤é¨åä¿¡æ¯ï¼å¹éæ¡ä»¶åå¨ä½ã\n\nå¹éæ¡ä»¶å³ä¸ºå¹éæ°æ®åè¢«è¿æ¡iptablesè§åâæè·âçæ¡ä»¶ï¼ä¾å¦åè®®ç±»åãæºIPãç®çIPãæºç«¯å£ãç®çç«¯å£ãè¿æ¥ç¶æç­ãæ¯æ¡iptablesè§ååè®¸å¤ä¸ªå¹éæ¡ä»¶ä»»æç»åï¼ä»èå®ç°å¤æ¡ä»¶çå¹éï¼å¤æ¡ä»¶ä¹é´æ¯é»è¾ä¸ï¼&&ï¼å³ç³»ã\n\nå¸¸è§å¨ä½å¦ä¸ï¼\n\n * ACCEPTï¼åè®¸æ°æ®åéè¿ã\n\n * DROPï¼ä¸¢å¼æ°æ®åï¼ä¸ç»åºä»»ä½ååºã\n\n * REJECTï¼æç»æ°æ®åï¼ç»åºååºåç¥åéæ¹è¢«æç»ã\n\n * SNATï¼æºå°åè½¬æ¢ï¼ç¨äºç½ç»å°åè½¬æ¢ï¼NATï¼ã\n\n * DNATï¼ç®æ å°åè½¬æ¢ï¼ç¨äºç½ç»å°åè½¬æ¢ï¼NATï¼ã\n\n * REDIRECTï¼éå®åæ°æ®åå°æå®ç«¯å£æ IP å°åã\n\n\n# iptableså½ä»¤ä½¿ç¨\n\n\n# åæ°\n\n * -Aï¼æ·»å è§åå°æå®é¾çæ«å°¾ã\n   ä¾å¦ï¼iptables -A INPUT -s 192.168.1.0/24 -j DROP\n\n * -Dï¼å é¤æå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -D INPUT -s 192.168.1.0/24 -j DROP\n\n * -Iï¼æå¥è§åå°æå®é¾çå¼å¤´ææå®ä½ç½®ã\n   ä¾å¦ï¼iptables -I INPUT 2 -s 192.168.1.0/24 -j DROP\n\n * -Rï¼æ¿æ¢æå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -R INPUT 2 -s 192.168.1.0/24 -j DROP\n\n * -Lï¼ååºæå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -L INPUT\n\n * -Fï¼æ¸ç©ºæå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -F INPUT\n\n * -Nï¼åå»ºæ°çèªå®ä¹é¾ã\n   ä¾å¦ï¼iptables -N MYCHAIN\n\n * -Xï¼å é¤æå®çèªå®ä¹é¾ã\n   ä¾å¦ï¼iptables -X MYCHAIN\n\n * -Pï¼è®¾ç½®æå®é¾çé»è®¤ç­ç¥ã\n   ä¾å¦ï¼iptables -P INPUT DROP\n\n * -sï¼æå®æº IP å°åæå°åæ®µã\n   ä¾å¦ï¼iptables -A INPUT -s 192.168.1.0/24 -j DROP\n\n * -dï¼æå®ç®æ  IP å°åæå°åæ®µã\n   ä¾å¦ï¼iptables -A OUTPUT -d 192.168.1.0/24 -j DROP\n\n * -pï¼æå®åè®®ç±»åã\n   ä¾å¦ï¼iptables -A INPUT -p tcp -j DROP\n\n * -mï¼æå®å¹éæ¨¡åã\n   ä¾å¦ï¼iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n * -jï¼æå®å¨ä½ã\n   ä¾å¦ï¼iptables -A INPUT -s 192.168.1.0/24 -j DROP\n\n * -iï¼æå®è¿å¥æ¥å£ã\n   ä¾å¦ï¼iptables -A INPUT -i eth0 -j DROP\n\n * -oï¼æå®è¾åºæ¥å£ã\n   ä¾å¦ï¼iptables -A OUTPUT -o eth0 -j DROP\n\n\n# å¸¸è§æ­¦å¨\n\n 1. æ¥çææiptablesè§å\n\niptables -L -n\n\n\n1\n\n 2. éç½®é²ç«å¢è§åç­ç¥\n\n * éç½®åè®¸SSHè¿æ¥\n\niptables -A INPUT -s 10.20.30.40/24 -p tcp --dport 22 -j ACCECT\n\n\n1\n\n\n-A INPUT æ¯ä»¥è¿½å çæ¹å¼å¢å è¯¥è§åå¨INPUTé¾ä¸ï¼-s 10.20.30.40/24 -p tcp --dport 22 æ¯å¹éä¸æºå°åä¸º10.20.30.40/24ç½æ®µï¼tcpåè®®åç®çç«¯å£22çæ°æ®åï¼-j ACCET è¡¨ç¤ºåè®¸è¯¥æ°æ®åè¿è¡è¿æ¥ãè¿éæ²¡ææå®è¡¨é»è®¤æ¯filterè¡¨ã\n\n * é»æ­¢æ¥èªæä¸ªIP/ç½æ®µçææè¿æ¥\n\niptables -A INPUT -s 10.10.10.10 -j DROP\n\n\n1\n\n\n-j DROP ä¼åéç»æºå°åä¸º10.10.10.10ä¸ä¸ªè¿æ¥æç»çåç¨æ¥æã\n\n * å°éç«¯å£\n\niptables -A OUTPUT -p tcp --dport 1234 -j DROP\n\n\n1\n\n\nç¦æ­¢æ¬å°è¿ç¨è®¿é®å¤é¨1234ç«¯å£ãå ä¸ºæ¯å¨æè½½OUTPUTé¾ä¸è¯¥æ¡è§åï¼æä»¥æ¯å±è½æ¬å°è¿ç¨å¯¹å¤çè¿æ¥ãå¦ææ³è¦ç¦æ­¢å¤é¨è¿æ¥è®¿é®æ¬å°1234ç«¯å£ï¼åéè¦å¨INPUTé¾ä¸æ°å¢è§åã\n\niptables -A INPUT -p tcp --dport 1234 -j DROP\n\n\n1\n\n * ç«¯å£è½¬å\n\niptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080\n\n\n1\n\n\nè¯¥æ¡è§åæ·»å å°PREROUTINGé¾ä¸çnatè¡¨ä¸­ï¼å¹éä¸eth0ç½å¡ä¸ææç®çç«¯å£ä¸º80çtcpæ°æ®åï¼å¹éä¸åå°è½¬åå°8080ç«¯å£ä¸ãå ä¸ºå°ç®çç«¯å£æ¹åäºï¼åéè¦åå°natè¡¨ä¸­ã\n\n * ç¦ping\n\niptables -A INPUT -p icmp -j DROP\n\n\n1\n\n\nå¨INPUTé¾filterè¡¨ä¸­æ°å¢ç¦æ­¢icmpåè®®æ°æ®åçè§åã\n\n 3. DNAT\n\niptables -t nat -A PREROUTING -d 1.2.3.4 -p tcp --dport 80 -j DNAT --to-destination 10.20.30.40:8080\n\n\n1\n\n\nåç«¯å£è½¬ååçå·®ä¸å¤ï¼åºå«å¨äºï¼ç«¯å£è½¬åä¸ä¿®æ¹IPå°åï¼èè¿éä¿®æ¹äºç®çIPå°åãå¨natè¡¨PREROUTINGä¸­æ°å¢ç®çå°åä¸º1.2.3.4ï¼ç®çç«¯å£80çtcpæ°æ®åçDNATå¨ä½ï¼å°ç®çå°åæ¹ä¸ºäº10.20.30.40:8080ã\n\nDNATä»åçå¨natè¡¨çPREROUTINGé¾ä¸­ï¼å¹¶ä¸è¯¥æä½éè¦ç¡®ä¿å¼å¯ipforwardåè½ã\n\n 4. SNAT\n\niptables -t nat -A POSTROUTING -s 192.168.1.2 -j SNAT --to-source 10.172.16.1\n\n\n1\n\n\nå¨natè¡¨POSTROUTINGé¾ä¸­æ°å¢å°æºå°å192.168.1.2çæ°æ®åè¿è¡SNATæä½ï¼æ¹ä¸ºæºå°å10.172.16.1.\n\nSNATæä½ä»å¯åçå¨natè¡¨çPOSTROUTINGé¾ä¸­ã\n\n 5. ä¿å­ä¸æ¢å¤\n\niptablesè§åä¿®æ¹ä»æ¯ä¸´æ¶çï¼éå¯åä¸¢å¤±ï¼æ§è¡ä»¥ä¸å½ä»¤æ°¸ä¹ä¿å­ã\n\niptables-save\n\n\n1\n\n\nä¹å¯å°è§åä¿å­å¨æä»¶ä¸­\n\niptables-save > iptables.bak\n\n\n1\n\n\nåç»­å¯ä»¥éè¿ä»¥ä¸å½ä»¤è¿è¡æ¢å¤\n\niptables-restore < iptables.bak\n\n\n1\n\n\n\n# å·¨äººçè©è\n\n * ãkubernetesç½ç»æå¨æåã\n\nâ",normalizedContent:"# åè¯\n\n\n# iptablesæ¯ä»ä¹ï¼\n\niptablesæ¯ä¸ä¸ªå¨linuxæä½ç³»ç»ä¸ä½¿ç¨çé²ç«å¢å·¥å·ï¼å®å¯ä»¥ç¨äºéç½®åç®¡çç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã\n\n 1. è¿æ»¤æ°æ®åï¼iptableså¯ä»¥æ ¹æ®ä¸åçè§åè¿æ»¤ç½ç»æ°æ®åï¼ä¾å¦æ ¹æ®æºipå°åãç®æ ipå°åãç«¯å£å·ç­è¿è¡è¿æ»¤ã\n\n 2. è½¬åæ°æ®åï¼iptableså¯ä»¥å°ç½ç»æ°æ®åä»ä¸ä¸ªæ¥å£è½¬åå°å¦ä¸ä¸ªæ¥å£ï¼å®ç°ç½ç»æ°æ®çè½¬ååè½ã\n\n 3. ä¿®æ¹æ°æ®åï¼iptableså¯ä»¥ä¿®æ¹ç½ç»æ°æ®åçæºipå°åãç®æ ipå°åãç«¯å£å·ç­ä¿¡æ¯ï¼å®ç°ç½ç»æ°æ®çä¼ªè£åæ¬ºéªã\n\n\n# netfilteræ¯ä»ä¹ï¼\n\nnetfilteræ¯linuxåæ ¸ä¸­çä¸ä¸ªç½ç»æ°æ®åè¿æ»¤æ¡æ¶ï¼å®å¯ä»¥å¨æ°æ®åè¿å¥åç¦»å¼ç½ç»æ¥å£æ¶è¿è¡æ¦æªåå¤çãiptableså°±æ¯åºäºnetfilteræ¡æ¶å®ç°çä¸ä¸ªç¨æ·ç©ºé´å·¥å·ï¼å®å¯ä»¥éè¿è°ç¨netfilteræä¾çapiæ¥å®ç°ç½ç»æ°æ®åçè¿æ»¤ãè½¬ååä¿®æ¹ç­æä½ã\n\nnetfilterçæ¶æå°±æ¯å¨æ´ä¸ªç½ç»æµç¨çè¥å¹²ä½ç½®æ¾ç½®ä¸äºé©å­ï¼å¹¶å¨æ¯ä¸ªé©å­ä¸æè½½ä¸äºå¤çå½æ°è¿è¡å¤çã\n\nipå±ç5ä¸ªé©å­ç¹çä½ç½®ï¼åå«æ¯preroutingãpostroutingãinputãoutputåforwardãåçå¾å¦ä¸ï¼\n\nâ\n\nâ\n\nå½ç½å¡ä¸æ¶å°ä¸ä¸ªåéè¾¾åè®®æ æ¶ï¼æåç»è¿çnetfilteré©å­æ¯preroutingï¼å¦æç¡®å®æç¨æ·åäºè¿ä¸ªé©å­å½æ°ï¼é£ä¹åæ ¸å°å¨è¿éå¯¹æ°æ®åè¿è¡ç®çå°åè½¬æ¢ï¼dnatï¼ãä¸ç®¡å¨preroutingææ²¡æåè¿dnatï¼åæ ¸é½ä¼éè¿æ¥æ¬å°è·¯ç±è¡¨å³å®è¿ä¸ªæ°æ®åæ¯åéç»æ¬å°è¿ç¨è¿æ¯åéç»å¶ä»æºå¨ãå¦ææ¯åéç»å¶ä»æºå¨ï¼æå¶ä»network namespaceï¼ï¼å°±ç¸å½äºææ¬å°å½ä½è·¯ç±å¨ï¼å°±ä¼ç»è¿netfilterçforwardé©å­ï¼ç¨æ·å¯ä»¥å¨æ­¤å¤è®¾ç½®åè¿æ»¤é©å­å½æ°ï¼ä¾å¦iptablesçrejectå½æ°ãææé©¬ä¸è¦åå°åè®®æ å¤çåé½ä¼ç»è¿postroutingé©å­ï¼ç¨æ·å¯ä»¥å¨è¿éåä¸æºå°åè½¬æ¢ï¼snatï¼ææºå°åä¼ªè£ï¼masqueradeï¼ç®ç§°masqï¼çé©å­å½æ°ãå¦æç»è¿ä¸é¢çè·¯ç±å³ç­ï¼åæ ¸å³å®æååç»æ¬å°è¿ç¨ï¼å°±ä¼ç»è¿inputé©å­ãæ¬å°è¿ç¨æ¶å°æ°æ®ååï¼åç¨æ¥æä¼åç»è¿outputé©å­ï¼ç¶åç»è¿ä¸æ¬¡è·¯ç±å³ç­ï¼ä¾å¦ï¼å³å®ä»æºå¨çåªåç½å¡åºå»ï¼ä¸ä¸è·³å°åæ¯å¤å°ç­ï¼ï¼æååºåè®®æ çç½ç»ååæ ·ä¼ç»è¿postroutingé©å­ã\n\n\n# iptableså®ç°\n\niptablesçåºå±å®ç°æ¯éè¿linuxåæ ¸ä¸­çnetfilteræ¡æ¶æ¥å®ç°çãiptablesæ¯ç¨æ·ç©ºé´çä¸ä¸ªç¨åºï¼éè¿netlinkååæ ¸çnetfilteræ¡æ¶æäº¤éï¼è´è´£å¾é©å­ä¸éç½®åè°å½æ°ã\n\n\n\n\n# iptablesä¸æ¿æ§ï¼tableãchainårule\n\n\n# chain\n\niptablesæ5æ¡åç½®é¾åå«å¯¹åºçnetfilterç5ä¸ªé©å­ï¼\n\n * inputé¾ï¼ä¸è¬ç¨äºå¤çè¾å¥æ¬å°è¿ç¨çæ°æ®åã\n * outputé¾ï¼ä¸è¬ç¨äºå¤çæ¬å°è¿ç¨çè¾åºæ°æ®åã\n * forwardé¾ï¼ä¸è¬ç¨äºå¤çè½¬åå°å¶ä»æºå¨/network namespaceçæ°\n   æ®åã\n * preroutingé¾ï¼å¯ä»¥å¨æ­¤å¤è¿è¡dnatã\n * postroutingé¾ï¼å¯ä»¥å¨æ­¤å¤è¿è¡snatã\n\n\n# table\n\né¤äº5æ¡åç½®é¾ä¹å¤ï¼è¿å¯ä»¥å¨è¡¨ä¸­å®ä¹èªå·±çé¾ï¼\n\n * filter è¡¨ï¼ç¨äºè¿æ»¤æ°æ®åï¼æ¯é»è®¤çè¡¨ãå®åå« inputãoutput å forward ä¸ä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºçæ°æ®åãä»æ¬æºååºçæ°æ®ååè½¬åçæ°æ®åã\n\n * nat è¡¨ï¼ç¨äºç½ç»å°åè½¬æ¢ï¼natï¼ãå®åå« preroutingãpostrouting å output ä¸ä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºåçæ°æ®åãä»æ¬æºååºçæ°æ®ååæ¬æºçæçæ°æ®åã\n\n * mangle è¡¨ï¼ç¨äºä¿®æ¹æ°æ®åçç¹å®å­æ®µãå¦ ttlãtos ç­ãå®åå« preroutingãinputãforwardãoutput å postrouting äºä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºåçæ°æ®åãè¿å¥æ¬æºçæ°æ®åãè½¬åçæ°æ®åãä»æ¬æºååºçæ°æ®ååæ¬æºçæçæ°æ®åã\n\n * raw è¡¨ï¼ç¨äºéç½®è¿æ¥è¿½è¸ªç³»ç»ãå®åå« prerouting å output ä¸¤ä¸ªé¾ï¼åå«ç¨äºå¤çè¿å¥æ¬æºåçæ°æ®ååä»æ¬æºååºçæ°æ®åã\n\nè¿5å¼ è¡¨çä¼åçº§ä»é«å°ä½æ¯ï¼rawãmangleãnatãfilterãsecurityã\n\niptablesè¡¨ä¸é¾çå¯¹åºå³ç³»å¾å¦ä¸ï¼\n\nâ\n\n\n\nä¸åçè¡¨æä¸åçé¾ï¼è¿æ¯ä¸ºäºåç±»ç®¡çiptablesè§åï¼ruleï¼çï¼ç³»ç»ææçiptablesè§åé½è¢«ååå°ä¸åçè¡¨éåä¸­ã\n\n\n# rule\n\niptablesçè§åå°±æ¯æè½½netfilteré©å­ä¸çå½æ°ï¼ç¨æ¥ä¿®æ¹æ°æ®åçåå®¹æèè¿æ»¤æ°æ®åç­æä½ï¼iptablesçè¡¨å°±æ¯ææè§åç5ä¸ªé»è¾éåã\n\niptablesè§åå¦ä½ç¼åï¼\n\nä¸æ¡iptablesè§ååå«ä¸¤é¨åä¿¡æ¯ï¼å¹éæ¡ä»¶åå¨ä½ã\n\nå¹éæ¡ä»¶å³ä¸ºå¹éæ°æ®åè¢«è¿æ¡iptablesè§åâæè·âçæ¡ä»¶ï¼ä¾å¦åè®®ç±»åãæºipãç®çipãæºç«¯å£ãç®çç«¯å£ãè¿æ¥ç¶æç­ãæ¯æ¡iptablesè§ååè®¸å¤ä¸ªå¹éæ¡ä»¶ä»»æç»åï¼ä»èå®ç°å¤æ¡ä»¶çå¹éï¼å¤æ¡ä»¶ä¹é´æ¯é»è¾ä¸ï¼&&ï¼å³ç³»ã\n\nå¸¸è§å¨ä½å¦ä¸ï¼\n\n * acceptï¼åè®¸æ°æ®åéè¿ã\n\n * dropï¼ä¸¢å¼æ°æ®åï¼ä¸ç»åºä»»ä½ååºã\n\n * rejectï¼æç»æ°æ®åï¼ç»åºååºåç¥åéæ¹è¢«æç»ã\n\n * snatï¼æºå°åè½¬æ¢ï¼ç¨äºç½ç»å°åè½¬æ¢ï¼natï¼ã\n\n * dnatï¼ç®æ å°åè½¬æ¢ï¼ç¨äºç½ç»å°åè½¬æ¢ï¼natï¼ã\n\n * redirectï¼éå®åæ°æ®åå°æå®ç«¯å£æ ip å°åã\n\n\n# iptableså½ä»¤ä½¿ç¨\n\n\n# åæ°\n\n * -aï¼æ·»å è§åå°æå®é¾çæ«å°¾ã\n   ä¾å¦ï¼iptables -a input -s 192.168.1.0/24 -j drop\n\n * -dï¼å é¤æå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -d input -s 192.168.1.0/24 -j drop\n\n * -iï¼æå¥è§åå°æå®é¾çå¼å¤´ææå®ä½ç½®ã\n   ä¾å¦ï¼iptables -i input 2 -s 192.168.1.0/24 -j drop\n\n * -rï¼æ¿æ¢æå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -r input 2 -s 192.168.1.0/24 -j drop\n\n * -lï¼ååºæå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -l input\n\n * -fï¼æ¸ç©ºæå®é¾ä¸­çè§åã\n   ä¾å¦ï¼iptables -f input\n\n * -nï¼åå»ºæ°çèªå®ä¹é¾ã\n   ä¾å¦ï¼iptables -n mychain\n\n * -xï¼å é¤æå®çèªå®ä¹é¾ã\n   ä¾å¦ï¼iptables -x mychain\n\n * -pï¼è®¾ç½®æå®é¾çé»è®¤ç­ç¥ã\n   ä¾å¦ï¼iptables -p input drop\n\n * -sï¼æå®æº ip å°åæå°åæ®µã\n   ä¾å¦ï¼iptables -a input -s 192.168.1.0/24 -j drop\n\n * -dï¼æå®ç®æ  ip å°åæå°åæ®µã\n   ä¾å¦ï¼iptables -a output -d 192.168.1.0/24 -j drop\n\n * -pï¼æå®åè®®ç±»åã\n   ä¾å¦ï¼iptables -a input -p tcp -j drop\n\n * -mï¼æå®å¹éæ¨¡åã\n   ä¾å¦ï¼iptables -a input -m state --state established,related -j accept\n\n * -jï¼æå®å¨ä½ã\n   ä¾å¦ï¼iptables -a input -s 192.168.1.0/24 -j drop\n\n * -iï¼æå®è¿å¥æ¥å£ã\n   ä¾å¦ï¼iptables -a input -i eth0 -j drop\n\n * -oï¼æå®è¾åºæ¥å£ã\n   ä¾å¦ï¼iptables -a output -o eth0 -j drop\n\n\n# å¸¸è§æ­¦å¨\n\n 1. æ¥çææiptablesè§å\n\niptables -l -n\n\n\n1\n\n 2. éç½®é²ç«å¢è§åç­ç¥\n\n * éç½®åè®¸sshè¿æ¥\n\niptables -a input -s 10.20.30.40/24 -p tcp --dport 22 -j accect\n\n\n1\n\n\n-a input æ¯ä»¥è¿½å çæ¹å¼å¢å è¯¥è§åå¨inputé¾ä¸ï¼-s 10.20.30.40/24 -p tcp --dport 22 æ¯å¹éä¸æºå°åä¸º10.20.30.40/24ç½æ®µï¼tcpåè®®åç®çç«¯å£22çæ°æ®åï¼-j accet è¡¨ç¤ºåè®¸è¯¥æ°æ®åè¿è¡è¿æ¥ãè¿éæ²¡ææå®è¡¨é»è®¤æ¯filterè¡¨ã\n\n * é»æ­¢æ¥èªæä¸ªip/ç½æ®µçææè¿æ¥\n\niptables -a input -s 10.10.10.10 -j drop\n\n\n1\n\n\n-j drop ä¼åéç»æºå°åä¸º10.10.10.10ä¸ä¸ªè¿æ¥æç»çåç¨æ¥æã\n\n * å°éç«¯å£\n\niptables -a output -p tcp --dport 1234 -j drop\n\n\n1\n\n\nç¦æ­¢æ¬å°è¿ç¨è®¿é®å¤é¨1234ç«¯å£ãå ä¸ºæ¯å¨æè½½outputé¾ä¸è¯¥æ¡è§åï¼æä»¥æ¯å±è½æ¬å°è¿ç¨å¯¹å¤çè¿æ¥ãå¦ææ³è¦ç¦æ­¢å¤é¨è¿æ¥è®¿é®æ¬å°1234ç«¯å£ï¼åéè¦å¨inputé¾ä¸æ°å¢è§åã\n\niptables -a input -p tcp --dport 1234 -j drop\n\n\n1\n\n * ç«¯å£è½¬å\n\niptables -t nat -a prerouting -i eth0 -p tcp --dport 80 -j redirect --to-port 8080\n\n\n1\n\n\nè¯¥æ¡è§åæ·»å å°preroutingé¾ä¸çnatè¡¨ä¸­ï¼å¹éä¸eth0ç½å¡ä¸ææç®çç«¯å£ä¸º80çtcpæ°æ®åï¼å¹éä¸åå°è½¬åå°8080ç«¯å£ä¸ãå ä¸ºå°ç®çç«¯å£æ¹åäºï¼åéè¦åå°natè¡¨ä¸­ã\n\n * ç¦ping\n\niptables -a input -p icmp -j drop\n\n\n1\n\n\nå¨inputé¾filterè¡¨ä¸­æ°å¢ç¦æ­¢icmpåè®®æ°æ®åçè§åã\n\n 3. dnat\n\niptables -t nat -a prerouting -d 1.2.3.4 -p tcp --dport 80 -j dnat --to-destination 10.20.30.40:8080\n\n\n1\n\n\nåç«¯å£è½¬ååçå·®ä¸å¤ï¼åºå«å¨äºï¼ç«¯å£è½¬åä¸ä¿®æ¹ipå°åï¼èè¿éä¿®æ¹äºç®çipå°åãå¨natè¡¨preroutingä¸­æ°å¢ç®çå°åä¸º1.2.3.4ï¼ç®çç«¯å£80çtcpæ°æ®åçdnatå¨ä½ï¼å°ç®çå°åæ¹ä¸ºäº10.20.30.40:8080ã\n\ndnatä»åçå¨natè¡¨çpreroutingé¾ä¸­ï¼å¹¶ä¸è¯¥æä½éè¦ç¡®ä¿å¼å¯ipforwardåè½ã\n\n 4. snat\n\niptables -t nat -a postrouting -s 192.168.1.2 -j snat --to-source 10.172.16.1\n\n\n1\n\n\nå¨natè¡¨postroutingé¾ä¸­æ°å¢å°æºå°å192.168.1.2çæ°æ®åè¿è¡snatæä½ï¼æ¹ä¸ºæºå°å10.172.16.1.\n\nsnatæä½ä»å¯åçå¨natè¡¨çpostroutingé¾ä¸­ã\n\n 5. ä¿å­ä¸æ¢å¤\n\niptablesè§åä¿®æ¹ä»æ¯ä¸´æ¶çï¼éå¯åä¸¢å¤±ï¼æ§è¡ä»¥ä¸å½ä»¤æ°¸ä¹ä¿å­ã\n\niptables-save\n\n\n1\n\n\nä¹å¯å°è§åä¿å­å¨æä»¶ä¸­\n\niptables-save > iptables.bak\n\n\n1\n\n\nåç»­å¯ä»¥éè¿ä»¥ä¸å½ä»¤è¿è¡æ¢å¤\n\niptables-restore < iptables.bak\n\n\n1\n\n\n\n# å·¨äººçè©è\n\n * ãkubernetesç½ç»æå¨æåã\n\nâ",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"çè§£Linux TunTapè®¾å¤",frontmatter:{title:"çè§£Linux TunTapè®¾å¤",date:"2023-05-26T10:20:08.000Z",permalink:"/pages/143447/",categories:["ç¼ç¨","linux"],tags:["linux","è®¡ç®æºç½ç»","Linuxç½ç»èæå"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"TUN/TAPæ¯æä½ç³»ç»åæ ¸ä¸­çèæç½ç»è®¾å¤ï¼å¯ä»¥å®æç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®çäº¤äºãç½ç»åè®®æ ä¸­çæ°æ®éè¿è¯¥è®¾å¤å¯ä»¥è¿å¥å°ç¨æ·ç©ºé´ä¸­ï¼èç¨æ·ç©ºé´ä¸­çç¨åºéè¿è¯¥è®¾å¤ç©ºé´è¿å¥å°åæ ¸ç©ºé´çç½ç»åè®®æ ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230507110448-2vjzt36.png"},{name:"twitter:title",content:"çè§£Linux TunTapè®¾å¤"},{name:"twitter:description",content:"TUN/TAPæ¯æä½ç³»ç»åæ ¸ä¸­çèæç½ç»è®¾å¤ï¼å¯ä»¥å®æç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®çäº¤äºãç½ç»åè®®æ ä¸­çæ°æ®éè¿è¯¥è®¾å¤å¯ä»¥è¿å¥å°ç¨æ·ç©ºé´ä¸­ï¼èç¨æ·ç©ºé´ä¸­çç¨åºéè¿è¯¥è®¾å¤ç©ºé´è¿å¥å°åæ ¸ç©ºé´çç½ç»åè®®æ ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230507110448-2vjzt36.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/02.%E7%90%86%E8%A7%A3Linux%20TunTap%E8%AE%BE%E5%A4%87.html"},{property:"og:type",content:"article"},{property:"og:title",content:"çè§£Linux TunTapè®¾å¤"},{property:"og:description",content:"TUN/TAPæ¯æä½ç³»ç»åæ ¸ä¸­çèæç½ç»è®¾å¤ï¼å¯ä»¥å®æç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®çäº¤äºãç½ç»åè®®æ ä¸­çæ°æ®éè¿è¯¥è®¾å¤å¯ä»¥è¿å¥å°ç¨æ·ç©ºé´ä¸­ï¼èç¨æ·ç©ºé´ä¸­çç¨åºéè¿è¯¥è®¾å¤ç©ºé´è¿å¥å°åæ ¸ç©ºé´çç½ç»åè®®æ ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230507110448-2vjzt36.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/02.%E7%90%86%E8%A7%A3Linux%20TunTap%E8%AE%BE%E5%A4%87.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-05-26T10:20:08.000Z"},{property:"article:tag",content:"linux"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"Linuxç½ç»èæå"},{itemprop:"name",content:"çè§£Linux TunTapè®¾å¤"},{itemprop:"description",content:"TUN/TAPæ¯æä½ç³»ç»åæ ¸ä¸­çèæç½ç»è®¾å¤ï¼å¯ä»¥å®æç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®çäº¤äºãç½ç»åè®®æ ä¸­çæ°æ®éè¿è¯¥è®¾å¤å¯ä»¥è¿å¥å°ç¨æ·ç©ºé´ä¸­ï¼èç¨æ·ç©ºé´ä¸­çç¨åºéè¿è¯¥è®¾å¤ç©ºé´è¿å¥å°åæ ¸ç©ºé´çç½ç»åè®®æ ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/2023-04-13-2330-20230507110448-2vjzt36.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/03.linux/02.%E7%90%86%E8%A7%A3Linux%20TunTap%E8%AE%BE%E5%A4%87.html",relativePath:"04.ç¼ç¨/03.linux/02.çè§£Linux TunTapè®¾å¤.md",key:"v-26efa3da",path:"/pages/143447/",headers:[{level:2,title:"å¥é¨",slug:"å¥é¨",normalizedTitle:"å¥é¨",charIndex:2},{level:2,title:"åºç¨ç¨åºéè¿tunè®¾å¤è·åpingæ°æ®å",slug:"åºç¨ç¨åºéè¿tunè®¾å¤è·åpingæ°æ®å",normalizedTitle:"åºç¨ç¨åºéè¿tunè®¾å¤è·åpingæ°æ®å",charIndex:293},{level:2,title:"ä½¿ç¨tunè®¾å¤å®æåºäºUDPçå®¹å¨è·¨èç¹éä¿¡",slug:"ä½¿ç¨tunè®¾å¤å®æåºäºudpçå®¹å¨è·¨èç¹éä¿¡",normalizedTitle:"ä½¿ç¨tunè®¾å¤å®æåºäºudpçå®¹å¨è·¨èç¹éä¿¡",charIndex:3535},{level:2,title:"å·¨äººçè©è",slug:"å·¨äººçè©è",normalizedTitle:"å·¨äººçè©è",charIndex:8804}],headersStr:"å¥é¨ åºç¨ç¨åºéè¿tunè®¾å¤è·åpingæ°æ®å ä½¿ç¨tunè®¾å¤å®æåºäºUDPçå®¹å¨è·¨èç¹éä¿¡ å·¨äººçè©è",content:'# å¥é¨\n\nTUN/TAPæ¯æä½ç³»ç»åæ ¸ä¸­çèæç½ç»è®¾å¤ï¼å¯ä»¥å®æç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®çäº¤äºãç½ç»åè®®æ ä¸­çæ°æ®éè¿è¯¥è®¾å¤å¯ä»¥è¿å¥å°ç¨æ·ç©ºé´ä¸­ï¼èç¨æ·ç©ºé´ä¸­çç¨åºéè¿è¯¥è®¾å¤ç©ºé´è¿å¥å°åæ ¸ç©ºé´çç½ç»åè®®æ ã\n\nTUNæ¨¡æçæ¯ä¸å±è®¾å¤ï¼æä½ä¸å±çæ°æ®åï¼èTAPæ¨¡æçäºå±è®¾å¤ï¼æä½äºå±çæ°æ®åã\n\n> ç©çç½å¡ä¸èæç½å¡çåºå«æ¯ï¼ç©çç½å¡æ¯å¤çä¸åæ ¸ç©ºé´çç½ç»åè®®æ æ°æ®äº¤äºçé¨æ·ï¼èèæç½å¡æ¯ç¨æ·ç©ºé´ååæ ¸ç©ºé´äº¤äºçé¨æ·ã\n\n/dev/net/tun æ¯linuxæä¾çå­ç¬¦è®¾å¤ï¼åå¥è¯¥è®¾å¤çæ°æ®ä¼åéå°èæç½å¡ä¸­ï¼èåéå°èæç½å¡ä¸­çæ°æ®ä¹ä¼åºç°å¨å­ç¬¦è®¾å¤ä¸­ã\n\n\n\nâ\n\n\n# åºç¨ç¨åºéè¿tunè®¾å¤è·åpingæ°æ®å\n\n\n\nappç¨åºéè¿æå¼tunå­ç¬¦è®¾å¤åå»ºåºtunèæç½å¡ãç¶åéè¿pingå½ä»¤åéICMPæ°æ®åå°ç½ç»åè®®æ ä¸­ï¼è¿ä¸ªè¿ç¨æ¯ä»ç¨æ·ç©ºé´å°åæ ¸ç©ºé´ï¼åéè¿è·¯ç±å°æ°æ®åè½¬åå°tunèæç½å¡ä¸­ï¼å ä¸ºtunç½å¡ç¹æ§ï¼ä¼è¿å¥å°æå¼è¯¥tunè®¾å¤ç¨æ·ç©ºé´appç¨åºä¸­ã\n\nappç¨åºä»£ç å¦ä¸ï¼\n\nimport os\nimport struct\nfrom fcntl import ioctl\n\nBUFFER_SIZE = 4096\n\n# å®æèæç½å¡çæ³¨å\nTUNSETIFF = 0x400454ca\n\n# è®¾å¤æ¨¡å¼\nIFF_TUN = 0x0001\nIFF_TAP = 0x0002\n\n\ndef create_tunnel(tun_name=\'tun%d\', tun_mode=IFF_TUN):\n    # ä»¥è¯»åçæ¹å¼æå¼å­ç¬¦è®¾å¤tunï¼è·åå°è®¾å¤æè¿°ç¬¦\n    tun_fd = os.open("/dev/net/tun", os.O_RDWR)\n\n    # å¯¹è¯¥è®¾å¤è¿è¡éç½®ï¼è®¾å¤åç§°åè®¾å¤æ¨¡å¼ã\n    ifn = ioctl(tun_fd, TUNSETIFF, struct.pack(b"16sH", tun_name.encode(), tun_mode))\n\n    # è·åå°è®¾å¤åç§°\n    tun_name = ifn[:16].decode().strip("\\x00")\n    return tun_fd, tun_name\n\n\ndef main():\n    tun_fd, tun_name = create_tunnel()\n\n    while True:\n        data = os.read(tun_fd, BUFFER_SIZE)\n        print(f"get data from tun. data size = {len(data)}")\n\n\nif __name__ == \'__main__\':\n    main()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nè¿è¡åè¾åºï¼\n\n# python3 tun_demo.py\nOpen tun/tap device: tun0 for reading...\n\n\n1\n2\n\n\néè¿ip a å½ä»¤åç°tunè®¾å¤å·²ç»åå»ºï¼ä½å¶ç¶æä¸ºDOWN\n\n# ip a | grep -C tun\n45: tun0: <POINTOPOINT,MULTICAST,NOARP> mtu 1500 qdisc noop state DOWN group default qlen 500\n    link/none\n\n\n1\n2\n3\n\n\nå¯¹å¶è®¾ç½®ä¸ä¸ªipå¹¶å°å®ç¶æè®¾ç½®ä¸ºUP\n\nip a add 192.37.1.2/24 dev tun0\nip link set tun0 up\n\n\n1\n2\n\n\néç½®å¥½ipåï¼ä¼åç°èªå¨éç½®äºå¦ä¸è·¯ç±:\n\n...\n192.37.1.0/24 dev tun0 proto kernel scope link src 192.37.1.2 \n...\n\n\n1\n2\n3\n\n\nåæ¬¡æ¥çtunè®¾å¤ï¼åç°å·²ç»éç½®å¥½\n\n# ip a | grep tun0\n45: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    inet 192.37.1.1/24 scope global tun0\n\n\n1\n2\n3\n\n\nå¹¶ä¸è¿æ¶ä¼åç°tun0å·²ç»æ¥æ¶å°äº3ä¸ªæ°æ®å\n\n# python3 tun_demo.py\nOpen tun/tap device: tun0 for reading...\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 52\n\n\n1\n2\n3\n4\n5\n\n\nè¿æ¶åä½¿ç¨tcpdumpçå¬tun0ï¼æ§è¡ping 192.37.1.2ï¼æ¯æååçï¼ä½æ¯tcpdumpå´æ²¡ææå°ä»»ä½åã\n\n> pingå½ä»¤ä¼æ ¹æ®ç®æ IPå°ååå­ç½æ©ç æ¥å¤æ­æ°æ®åçç®çå°ï¼å¦æç®çå°å¨æ¬å°ç½ç»ä¸­ï¼pingå½ä»¤ä¼ç´æ¥å°æ°æ®ååéå°æ¬å°ç½ç»ï¼èä¸æ¯éè¿TUNè®¾å¤åéã\n\n# tcpdump -i tun0 -n\n...\n\n# ping 192.37.1.2 -c 3\nPING 192.37.1.2 (192.37.1.2) 56(84) bytes of data.\n64 bytes from 192.37.1.2: icmp_seq=1 ttl=64 time=0.148 ms\n64 bytes from 192.37.1.2: icmp_seq=2 ttl=64 time=0.114 ms\n64 bytes from 192.37.1.2: icmp_seq=3 ttl=64 time=0.316 ms\n\n--- 192.37.1.2 ping statistics ---\n3 packets transmitted, 3 received, 0% packet loss, time 1999ms\nrtt min/avg/max/mdev = 0.114/0.192/0.316/0.089 ms\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\næ¹ä¸ºping 192.37.1.3ï¼å¯ä»¥çå°ç¨åºæ¶å°äºæ¶å°äºæ°æ®åï¼tcpdumpä¹æå°äºåï¼ä½æ¯å ä¸ºæ²¡æåä»»ä½çå¤çä¹æ²¡æååï¼æä»¥pingå½ä»¤çå°ä¸å°ååã\n\n# python3 tun_demo.py\nOpen tun/tap device: tun0 for reading...\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 52\n\nget data from tun. data size = 88\nget data from tun. data size = 88\nget data from tun. data size = 88\n\n# tcpdump -i tun0 -n\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on tun0, link-type RAW (Raw IP), capture size 262144 bytes\n22:56:41.018149 IP 192.37.1.2 > 192.37.1.3: ICMP echo request, id 22559, seq 1, length 64\n22:56:42.018871 IP 192.37.1.2 > 192.37.1.3: ICMP echo request, id 22559, seq 2, length 64\n22:56:43.022732 IP 192.37.1.2 > 192.37.1.3: ICMP echo request, id 22559, seq 3, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nâ\n\n\n# ä½¿ç¨tunè®¾å¤å®æåºäºUDPçå®¹å¨è·¨èç¹éä¿¡\n\nä½¿ç¨tunè®¾å¤åºäºUDPå®æå®¹å¨è·¨èç¹éä¿¡ãå¦ä¸å¾æç¤ºï¼\n\nâ\n\n\n\néä¿¡æµç¨æ¯ï¼å¨Node1ä¸­çNS1è¿è¡ping Node2ä¸­NS2çveth0ç½å¡çIPï¼ICMPçIPåä¼éè¿veth0å°è¾¾veth1ä¸­ï¼å¹¶è¿å¥å°å®¿ä¸»æºçç½ç»åè®®æ ï¼éè¿è·¯ç±éç½®è¾¾å°tunè®¾å¤ï¼è¿æ¶appæå¡ä»tunè®¾å¤ä¸­è¯»åå°IPåæ°æ®ï¼ç¶åå°å¶å°è£å¨UDPåä¸­ï¼å¹¶éè¿eth0ç½å¡åéå°Node2çeth0ç½å¡ä¸ï¼éè¿ç½ç»åè®®æ è§£åè¾¾å°appç¨åºä¸­ï¼æ¿å°éé¢çIPåï¼å°å¶åå¥å°tunè®¾å¤ä¸­ï¼è¿å¥å°ç½ç»åè®®æ ä¸­ï¼éè¿è·¯ç±è¾¾å°veth1ä¸­ï¼ç¶åå°è¾¾net ns1çveth0ç½å¡ã\n\nappç¨åºç®åå®ç°å¦ä¸ï¼\n\nimport os\nimport socket\nimport struct\nimport threading\nfrom fcntl import ioctl\nimport click\n\nBIND_ADDRESS = (\'0.0.0.0\', 7000)\nBUFFER_SIZE = 4096\n\nTUNSETIFF = 0x400454ca\nIFF_TUN = 0x0001\nIFF_TAP = 0x0002\n\n\ndef create_tunnel(tun_name=\'tun%d\', tun_mode=IFF_TUN):\n    tun_fd = os.open("/dev/net/tun", os.O_RDWR)\n    ifn = ioctl(tun_fd, TUNSETIFF, struct.pack(b"16sH", tun_name.encode(), tun_mode))\n    tun_name = ifn[:16].decode().strip("\\x00")\n    return tun_fd, tun_name\n\n\ndef start_tunnel(tun_name):\n    os.popen(f"ip link set {tun_name} up")\n\n\ndef udp_server(udp_socket, tun_fd):\n    while True:\n        data, addr = udp_socket.recvfrom(2048)\n        print("get data from udp.")\n        if not data:\n            break\n\n        os.write(tun_fd, data)\n\n\n@click.command()\n@click.option("--peer_node_ip", "-p", required=True, help="å¯¹ç«¯èç¹IP")\ndef main(peer_node_ip):\n    peer_node_addr = (peer_node_ip, 7000)\n\n    tun_fd, tun_name = create_tunnel()\n    start_tunnel(tun_name)\n\n    udp_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)\n    udp_socket.bind(BIND_ADDRESS)\n\n    t = threading.Thread(target=udp_server, args=(udp_socket, tun_fd))\n    t.daemon = True\n    t.start()\n\n    while True:\n        data = os.read(tun_fd, BUFFER_SIZE)\n        print(f"get data from tun. data size = {len(data)}")\n        udp_socket.sendto(data, peer_node_addr)\n\n\nif __name__ == \'__main__\':\n    main()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n\n\nå¨Node1ä¸­è¿è¡è¯¥ç¨åºï¼è®¾ç½®Node2 IP\n\npython3 tun_app.py -p 10.65.132.187\n\n\n1\n\n\nå¯ä»¥çå°å·²ç»åå»ºäºtunè®¾å¤\n\n# ip link show tun0\n...\n109: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500\n    link/none \n    inet6 fe80::8e98:91a4:6537:d77a/64 scope link flags 800 \n       valid_lft forever preferred_lft forever\n...\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå¨Node1ä¸­åå»ºNetwork Namespaceå½åä¸ºnet1ï¼ä½¿ç¨å®æ¥å®ææ¨¡æå®¹å¨ç½ç»ã\n\nip netns add net1\n\n\n1\n\n\nç¶ååå»ºveth pairï¼å®ä»¬æ¯ä¸å¯¹ç½å¡ï¼åå«ä¸ºå½åä¸ºveth0åveth1\n\nip link add veth0 type veth peer name veth1\n\n\n1\n\n\nå°å¶ä¸ç«¯æ¥å¥å°net1ä¸­ï¼å¹¶è®¾ç½®å¥½å¶IPå°åä¸º10.1.1.2/24\n\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 10.1.1.2/24 dev veth0\nip netns exec net1 ip link set dev veth0 up\n\n\n1\n2\n3\n\n\nå¼å¯å¨å®¿ä¸»æºä¸çveth1ç½å¡ï¼å¹¶è®¾ç½®å¶IPä¸º10.1.1.1/24\n\nip a add 10.1.1.1/24 dev veth1\nip link set dev veth1 up\n\n\n1\n2\n\n\nåå°net1ä¸­çé»è®¤è·¯ç±è®¾ç½®æé½èµ°veth0ï¼è¿æ ·ï¼ping Node2ä¸­net2çç½ç»åå¯ä»¥å°veth1ä¸­ï¼ä¹å°±è¿å¥å°äºå®¿ä¸»æºçç½ç»åè®®æ ä¸­ã\n\nip netns exec net1 ip r add default via 10.1.1.1 dev veth0\n\n\n1\n\n\nå¨å®¿ä¸»æºä¸è¿éè¦æ·»å è·¯ç±ï¼è®¿é®Node2ä¸­net2æ¶é½è·¯ç±å°tun0è®¾å¤\n\nip r add 10.1.2.0/24 dev tun0\n\n\n1\n\n\nè¿æ¶ï¼å¨Node1 net1ä¸­ping Node2 net2æ¶ï¼æ­£å¸¸æ¥è¯´æ¯å¯ä»¥å¨appä¸­çå°ä»tunæ¶å°IPåçï¼è½ç¶æ²¡æååï¼é£æ¯å ä¸ºappç¨åºæ¶å°ååæ²¡æåä»»ä½ååæä½ã\n\n# ip netns exec net1 ping 10.1.2.2 -c 3\nPING 10.1.2.2 (10.1.2.2) 56(84) bytes of data.\n--- 10.1.2.2 ping statistics ---\n3 packets transmitted, 0 received, 100% packet loss, time 2001ms\n\n\n1\n2\n3\n4\n\n\næä»¬éè¿tcpdumpæåveth1ç½å¡ï¼å¯ä»¥çå°æ¶å°äºARPè¯·æ±ï¼æ³è¦è·å10.1.2.2çMACå°åï¼ä½æ¯ä¸ç´è·åä¸å°ï¼æä»¥å¯¼è´IPåæ æ³éè¿è·¯ç±è¾¾å°TUNè®¾å¤\n\n# tcpdump -i veth1 -n\n00:45:13.988076 ARP, Request who-has 10.1.2.2 tell 10.1.1.2, length 28\n\n\n1\n2\n\n\nè¿ä¸ªæ¶åéè¦å¼å¯veth1çarpä»£çï¼å°veth1çMACå°åä½ä¸ºARPçåå¤ã\n\necho 1 >  /proc/sys/net/ipv4/conf/veth1/proxy_arp\n\n\n1\n\n\nåæ¬¡ping Node2 net2æ¶ï¼å¯ä»¥çå°tcpdumpçå°ARPä¸­åå¤çMACå°åä¸ºveth1çå°åã\n\n# tcpdump -i veth1 -n\n00:45:13.988076 ARP, Request who-has 10.1.2.2 tell 10.1.1.2, length 28\n00:45:13.988100 ARP, Reply 10.1.2.2 is-at 4e:7c:bf:fe:4d:0f, length 28\n\n# ip a | grep -C 3 veth1\n...\n107: veth1@if108: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000\n    link/ether 4e:7c:bf:fe:4d:0f brd ff:ff:ff:ff:ff:ff link-netnsid 3\n    inet 10.1.1.1/24 scope global veth1\n       valid_lft forever preferred_lft forever\n...\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå¹¶ä¸appç¨åºä¸­ä¹ä»tunè®¾å¤ä¸­è·åå°äºIPåã\n\n# python3 tun_app.py -p 10.65.132.187\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 88\nget data from tun. data size = 88\nget data from tun. data size = 88\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå°è¿ä¸æ­¥ï¼Node1çåºæ¬éç½®å®æï¼æ¥ä¸æ¥éç½®Node2ï¼éç½®çæ¹æ³ä¸Node1ä¸è´ï¼å¨Node2æ§è¡å½ä»¤å¦ä¸:\n\n# å¼å¯appç¨åº\npython3 tun_app.py -p 10.61.74.37\n\n# æ°å¢network namespace net2\nip netns add net2\n\n# æ°å¢veth pairè®¾å¤\nip link add veth0 type veth peer name veth1\n\n# éç½®veth pairè®¾å¤\nip link set dev veth0 netns net2\nip netns exec net2 ip addr add 10.1.2.2/24 dev veth0\nip netns exec net2 ip link set dev veth0 up\n\nip a add 10.1.2.1/24 dev veth1\nip link set dev veth1 up\n\n# æ·»å é»è®¤è·¯ç±\nip netns exec net2 ip r add default via 10.1.2.1 dev veth0\n\n# æ·»å tun0è®¾å¤è·¯ç±\nip r add 10.1.1.0/24 dev tun0\n\n# å¼å¯arpä»£ç\necho 1 >  /proc/sys/net/ipv4/conf/veth1/proxy_arp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\néç½®å®æåï¼å¨Node1çnet1ä¸­ping Node2çnet2ï¼å¯ä»¥pingéæååã\n\n# ip netns exec net1 ping 10.1.2.2 \nPING 10.1.2.2 (10.1.2.2) 56(84) bytes of data.\n64 bytes from 10.1.2.2: icmp_seq=1 ttl=62 time=5.46 ms\n64 bytes from 10.1.2.2: icmp_seq=2 ttl=62 time=4.67 ms\n64 bytes from 10.1.2.2: icmp_seq=3 ttl=62 time=5.52 ms\n\n\n1\n2\n3\n4\n5\n\n\n\n# å·¨äººçè©è\n\n * Linux Tun/Tap ä»ç»\n\n * çè§£ Linux èæç½å¡è®¾å¤ tun/tap çä¸å\n\n * åºäºtunè®¾å¤å®ç°å¨ç¨æ·ç©ºé´å¯ä»¥pingéå¤é¨èç¹(golangçæ¬)\n\n * ä¸èµ·å¨æåä¸ä¸ªVPN\n\nâ',normalizedContent:'# å¥é¨\n\ntun/tapæ¯æä½ç³»ç»åæ ¸ä¸­çèæç½ç»è®¾å¤ï¼å¯ä»¥å®æç¨æ·ç©ºé´ä¸åæ ¸ç©ºé´çæ°æ®çäº¤äºãç½ç»åè®®æ ä¸­çæ°æ®éè¿è¯¥è®¾å¤å¯ä»¥è¿å¥å°ç¨æ·ç©ºé´ä¸­ï¼èç¨æ·ç©ºé´ä¸­çç¨åºéè¿è¯¥è®¾å¤ç©ºé´è¿å¥å°åæ ¸ç©ºé´çç½ç»åè®®æ ã\n\ntunæ¨¡æçæ¯ä¸å±è®¾å¤ï¼æä½ä¸å±çæ°æ®åï¼ètapæ¨¡æçäºå±è®¾å¤ï¼æä½äºå±çæ°æ®åã\n\n> ç©çç½å¡ä¸èæç½å¡çåºå«æ¯ï¼ç©çç½å¡æ¯å¤çä¸åæ ¸ç©ºé´çç½ç»åè®®æ æ°æ®äº¤äºçé¨æ·ï¼èèæç½å¡æ¯ç¨æ·ç©ºé´ååæ ¸ç©ºé´äº¤äºçé¨æ·ã\n\n/dev/net/tun æ¯linuxæä¾çå­ç¬¦è®¾å¤ï¼åå¥è¯¥è®¾å¤çæ°æ®ä¼åéå°èæç½å¡ä¸­ï¼èåéå°èæç½å¡ä¸­çæ°æ®ä¹ä¼åºç°å¨å­ç¬¦è®¾å¤ä¸­ã\n\n\n\nâ\n\n\n# åºç¨ç¨åºéè¿tunè®¾å¤è·åpingæ°æ®å\n\n\n\nappç¨åºéè¿æå¼tunå­ç¬¦è®¾å¤åå»ºåºtunèæç½å¡ãç¶åéè¿pingå½ä»¤åéicmpæ°æ®åå°ç½ç»åè®®æ ä¸­ï¼è¿ä¸ªè¿ç¨æ¯ä»ç¨æ·ç©ºé´å°åæ ¸ç©ºé´ï¼åéè¿è·¯ç±å°æ°æ®åè½¬åå°tunèæç½å¡ä¸­ï¼å ä¸ºtunç½å¡ç¹æ§ï¼ä¼è¿å¥å°æå¼è¯¥tunè®¾å¤ç¨æ·ç©ºé´appç¨åºä¸­ã\n\nappç¨åºä»£ç å¦ä¸ï¼\n\nimport os\nimport struct\nfrom fcntl import ioctl\n\nbuffer_size = 4096\n\n# å®æèæç½å¡çæ³¨å\ntunsetiff = 0x400454ca\n\n# è®¾å¤æ¨¡å¼\niff_tun = 0x0001\niff_tap = 0x0002\n\n\ndef create_tunnel(tun_name=\'tun%d\', tun_mode=iff_tun):\n    # ä»¥è¯»åçæ¹å¼æå¼å­ç¬¦è®¾å¤tunï¼è·åå°è®¾å¤æè¿°ç¬¦\n    tun_fd = os.open("/dev/net/tun", os.o_rdwr)\n\n    # å¯¹è¯¥è®¾å¤è¿è¡éç½®ï¼è®¾å¤åç§°åè®¾å¤æ¨¡å¼ã\n    ifn = ioctl(tun_fd, tunsetiff, struct.pack(b"16sh", tun_name.encode(), tun_mode))\n\n    # è·åå°è®¾å¤åç§°\n    tun_name = ifn[:16].decode().strip("\\x00")\n    return tun_fd, tun_name\n\n\ndef main():\n    tun_fd, tun_name = create_tunnel()\n\n    while true:\n        data = os.read(tun_fd, buffer_size)\n        print(f"get data from tun. data size = {len(data)}")\n\n\nif __name__ == \'__main__\':\n    main()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n\n\nè¿è¡åè¾åºï¼\n\n# python3 tun_demo.py\nopen tun/tap device: tun0 for reading...\n\n\n1\n2\n\n\néè¿ip a å½ä»¤åç°tunè®¾å¤å·²ç»åå»ºï¼ä½å¶ç¶æä¸ºdown\n\n# ip a | grep -c tun\n45: tun0: <pointopoint,multicast,noarp> mtu 1500 qdisc noop state down group default qlen 500\n    link/none\n\n\n1\n2\n3\n\n\nå¯¹å¶è®¾ç½®ä¸ä¸ªipå¹¶å°å®ç¶æè®¾ç½®ä¸ºup\n\nip a add 192.37.1.2/24 dev tun0\nip link set tun0 up\n\n\n1\n2\n\n\néç½®å¥½ipåï¼ä¼åç°èªå¨éç½®äºå¦ä¸è·¯ç±:\n\n...\n192.37.1.0/24 dev tun0 proto kernel scope link src 192.37.1.2 \n...\n\n\n1\n2\n3\n\n\nåæ¬¡æ¥çtunè®¾å¤ï¼åç°å·²ç»éç½®å¥½\n\n# ip a | grep tun0\n45: tun0: <pointopoint,multicast,noarp,up,lower_up> mtu 1500 qdisc pfifo_fast state unknown group default qlen 500\n    inet 192.37.1.1/24 scope global tun0\n\n\n1\n2\n3\n\n\nå¹¶ä¸è¿æ¶ä¼åç°tun0å·²ç»æ¥æ¶å°äº3ä¸ªæ°æ®å\n\n# python3 tun_demo.py\nopen tun/tap device: tun0 for reading...\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 52\n\n\n1\n2\n3\n4\n5\n\n\nè¿æ¶åä½¿ç¨tcpdumpçå¬tun0ï¼æ§è¡ping 192.37.1.2ï¼æ¯æååçï¼ä½æ¯tcpdumpå´æ²¡ææå°ä»»ä½åã\n\n> pingå½ä»¤ä¼æ ¹æ®ç®æ ipå°ååå­ç½æ©ç æ¥å¤æ­æ°æ®åçç®çå°ï¼å¦æç®çå°å¨æ¬å°ç½ç»ä¸­ï¼pingå½ä»¤ä¼ç´æ¥å°æ°æ®ååéå°æ¬å°ç½ç»ï¼èä¸æ¯éè¿tunè®¾å¤åéã\n\n# tcpdump -i tun0 -n\n...\n\n# ping 192.37.1.2 -c 3\nping 192.37.1.2 (192.37.1.2) 56(84) bytes of data.\n64 bytes from 192.37.1.2: icmp_seq=1 ttl=64 time=0.148 ms\n64 bytes from 192.37.1.2: icmp_seq=2 ttl=64 time=0.114 ms\n64 bytes from 192.37.1.2: icmp_seq=3 ttl=64 time=0.316 ms\n\n--- 192.37.1.2 ping statistics ---\n3 packets transmitted, 3 received, 0% packet loss, time 1999ms\nrtt min/avg/max/mdev = 0.114/0.192/0.316/0.089 ms\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n\n\næ¹ä¸ºping 192.37.1.3ï¼å¯ä»¥çå°ç¨åºæ¶å°äºæ¶å°äºæ°æ®åï¼tcpdumpä¹æå°äºåï¼ä½æ¯å ä¸ºæ²¡æåä»»ä½çå¤çä¹æ²¡æååï¼æä»¥pingå½ä»¤çå°ä¸å°ååã\n\n# python3 tun_demo.py\nopen tun/tap device: tun0 for reading...\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 52\n\nget data from tun. data size = 88\nget data from tun. data size = 88\nget data from tun. data size = 88\n\n# tcpdump -i tun0 -n\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on tun0, link-type raw (raw ip), capture size 262144 bytes\n22:56:41.018149 ip 192.37.1.2 > 192.37.1.3: icmp echo request, id 22559, seq 1, length 64\n22:56:42.018871 ip 192.37.1.2 > 192.37.1.3: icmp echo request, id 22559, seq 2, length 64\n22:56:43.022732 ip 192.37.1.2 > 192.37.1.3: icmp echo request, id 22559, seq 3, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n\n\nâ\n\n\n# ä½¿ç¨tunè®¾å¤å®æåºäºudpçå®¹å¨è·¨èç¹éä¿¡\n\nä½¿ç¨tunè®¾å¤åºäºudpå®æå®¹å¨è·¨èç¹éä¿¡ãå¦ä¸å¾æç¤ºï¼\n\nâ\n\n\n\néä¿¡æµç¨æ¯ï¼å¨node1ä¸­çns1è¿è¡ping node2ä¸­ns2çveth0ç½å¡çipï¼icmpçipåä¼éè¿veth0å°è¾¾veth1ä¸­ï¼å¹¶è¿å¥å°å®¿ä¸»æºçç½ç»åè®®æ ï¼éè¿è·¯ç±éç½®è¾¾å°tunè®¾å¤ï¼è¿æ¶appæå¡ä»tunè®¾å¤ä¸­è¯»åå°ipåæ°æ®ï¼ç¶åå°å¶å°è£å¨udpåä¸­ï¼å¹¶éè¿eth0ç½å¡åéå°node2çeth0ç½å¡ä¸ï¼éè¿ç½ç»åè®®æ è§£åè¾¾å°appç¨åºä¸­ï¼æ¿å°éé¢çipåï¼å°å¶åå¥å°tunè®¾å¤ä¸­ï¼è¿å¥å°ç½ç»åè®®æ ä¸­ï¼éè¿è·¯ç±è¾¾å°veth1ä¸­ï¼ç¶åå°è¾¾net ns1çveth0ç½å¡ã\n\nappç¨åºç®åå®ç°å¦ä¸ï¼\n\nimport os\nimport socket\nimport struct\nimport threading\nfrom fcntl import ioctl\nimport click\n\nbind_address = (\'0.0.0.0\', 7000)\nbuffer_size = 4096\n\ntunsetiff = 0x400454ca\niff_tun = 0x0001\niff_tap = 0x0002\n\n\ndef create_tunnel(tun_name=\'tun%d\', tun_mode=iff_tun):\n    tun_fd = os.open("/dev/net/tun", os.o_rdwr)\n    ifn = ioctl(tun_fd, tunsetiff, struct.pack(b"16sh", tun_name.encode(), tun_mode))\n    tun_name = ifn[:16].decode().strip("\\x00")\n    return tun_fd, tun_name\n\n\ndef start_tunnel(tun_name):\n    os.popen(f"ip link set {tun_name} up")\n\n\ndef udp_server(udp_socket, tun_fd):\n    while true:\n        data, addr = udp_socket.recvfrom(2048)\n        print("get data from udp.")\n        if not data:\n            break\n\n        os.write(tun_fd, data)\n\n\n@click.command()\n@click.option("--peer_node_ip", "-p", required=true, help="å¯¹ç«¯èç¹ip")\ndef main(peer_node_ip):\n    peer_node_addr = (peer_node_ip, 7000)\n\n    tun_fd, tun_name = create_tunnel()\n    start_tunnel(tun_name)\n\n    udp_socket = socket.socket(socket.af_inet, socket.sock_dgram)\n    udp_socket.bind(bind_address)\n\n    t = threading.thread(target=udp_server, args=(udp_socket, tun_fd))\n    t.daemon = true\n    t.start()\n\n    while true:\n        data = os.read(tun_fd, buffer_size)\n        print(f"get data from tun. data size = {len(data)}")\n        udp_socket.sendto(data, peer_node_addr)\n\n\nif __name__ == \'__main__\':\n    main()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n\n\nå¨node1ä¸­è¿è¡è¯¥ç¨åºï¼è®¾ç½®node2 ip\n\npython3 tun_app.py -p 10.65.132.187\n\n\n1\n\n\nå¯ä»¥çå°å·²ç»åå»ºäºtunè®¾å¤\n\n# ip link show tun0\n...\n109: tun0: <pointopoint,multicast,noarp,up,lower_up> mtu 1500 qdisc pfifo_fast state unknown group default qlen 500\n    link/none \n    inet6 fe80::8e98:91a4:6537:d77a/64 scope link flags 800 \n       valid_lft forever preferred_lft forever\n...\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå¨node1ä¸­åå»ºnetwork namespaceå½åä¸ºnet1ï¼ä½¿ç¨å®æ¥å®ææ¨¡æå®¹å¨ç½ç»ã\n\nip netns add net1\n\n\n1\n\n\nç¶ååå»ºveth pairï¼å®ä»¬æ¯ä¸å¯¹ç½å¡ï¼åå«ä¸ºå½åä¸ºveth0åveth1\n\nip link add veth0 type veth peer name veth1\n\n\n1\n\n\nå°å¶ä¸ç«¯æ¥å¥å°net1ä¸­ï¼å¹¶è®¾ç½®å¥½å¶ipå°åä¸º10.1.1.2/24\n\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 10.1.1.2/24 dev veth0\nip netns exec net1 ip link set dev veth0 up\n\n\n1\n2\n3\n\n\nå¼å¯å¨å®¿ä¸»æºä¸çveth1ç½å¡ï¼å¹¶è®¾ç½®å¶ipä¸º10.1.1.1/24\n\nip a add 10.1.1.1/24 dev veth1\nip link set dev veth1 up\n\n\n1\n2\n\n\nåå°net1ä¸­çé»è®¤è·¯ç±è®¾ç½®æé½èµ°veth0ï¼è¿æ ·ï¼ping node2ä¸­net2çç½ç»åå¯ä»¥å°veth1ä¸­ï¼ä¹å°±è¿å¥å°äºå®¿ä¸»æºçç½ç»åè®®æ ä¸­ã\n\nip netns exec net1 ip r add default via 10.1.1.1 dev veth0\n\n\n1\n\n\nå¨å®¿ä¸»æºä¸è¿éè¦æ·»å è·¯ç±ï¼è®¿é®node2ä¸­net2æ¶é½è·¯ç±å°tun0è®¾å¤\n\nip r add 10.1.2.0/24 dev tun0\n\n\n1\n\n\nè¿æ¶ï¼å¨node1 net1ä¸­ping node2 net2æ¶ï¼æ­£å¸¸æ¥è¯´æ¯å¯ä»¥å¨appä¸­çå°ä»tunæ¶å°ipåçï¼è½ç¶æ²¡æååï¼é£æ¯å ä¸ºappç¨åºæ¶å°ååæ²¡æåä»»ä½ååæä½ã\n\n# ip netns exec net1 ping 10.1.2.2 -c 3\nping 10.1.2.2 (10.1.2.2) 56(84) bytes of data.\n--- 10.1.2.2 ping statistics ---\n3 packets transmitted, 0 received, 100% packet loss, time 2001ms\n\n\n1\n2\n3\n4\n\n\næä»¬éè¿tcpdumpæåveth1ç½å¡ï¼å¯ä»¥çå°æ¶å°äºarpè¯·æ±ï¼æ³è¦è·å10.1.2.2çmacå°åï¼ä½æ¯ä¸ç´è·åä¸å°ï¼æä»¥å¯¼è´ipåæ æ³éè¿è·¯ç±è¾¾å°tunè®¾å¤\n\n# tcpdump -i veth1 -n\n00:45:13.988076 arp, request who-has 10.1.2.2 tell 10.1.1.2, length 28\n\n\n1\n2\n\n\nè¿ä¸ªæ¶åéè¦å¼å¯veth1çarpä»£çï¼å°veth1çmacå°åä½ä¸ºarpçåå¤ã\n\necho 1 >  /proc/sys/net/ipv4/conf/veth1/proxy_arp\n\n\n1\n\n\nåæ¬¡ping node2 net2æ¶ï¼å¯ä»¥çå°tcpdumpçå°arpä¸­åå¤çmacå°åä¸ºveth1çå°åã\n\n# tcpdump -i veth1 -n\n00:45:13.988076 arp, request who-has 10.1.2.2 tell 10.1.1.2, length 28\n00:45:13.988100 arp, reply 10.1.2.2 is-at 4e:7c:bf:fe:4d:0f, length 28\n\n# ip a | grep -c 3 veth1\n...\n107: veth1@if108: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up group default qlen 1000\n    link/ether 4e:7c:bf:fe:4d:0f brd ff:ff:ff:ff:ff:ff link-netnsid 3\n    inet 10.1.1.1/24 scope global veth1\n       valid_lft forever preferred_lft forever\n...\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\nå¹¶ä¸appç¨åºä¸­ä¹ä»tunè®¾å¤ä¸­è·åå°äºipåã\n\n# python3 tun_app.py -p 10.65.132.187\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 52\nget data from tun. data size = 88\nget data from tun. data size = 88\nget data from tun. data size = 88\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nå°è¿ä¸æ­¥ï¼node1çåºæ¬éç½®å®æï¼æ¥ä¸æ¥éç½®node2ï¼éç½®çæ¹æ³ä¸node1ä¸è´ï¼å¨node2æ§è¡å½ä»¤å¦ä¸:\n\n# å¼å¯appç¨åº\npython3 tun_app.py -p 10.61.74.37\n\n# æ°å¢network namespace net2\nip netns add net2\n\n# æ°å¢veth pairè®¾å¤\nip link add veth0 type veth peer name veth1\n\n# éç½®veth pairè®¾å¤\nip link set dev veth0 netns net2\nip netns exec net2 ip addr add 10.1.2.2/24 dev veth0\nip netns exec net2 ip link set dev veth0 up\n\nip a add 10.1.2.1/24 dev veth1\nip link set dev veth1 up\n\n# æ·»å é»è®¤è·¯ç±\nip netns exec net2 ip r add default via 10.1.2.1 dev veth0\n\n# æ·»å tun0è®¾å¤è·¯ç±\nip r add 10.1.1.0/24 dev tun0\n\n# å¼å¯arpä»£ç\necho 1 >  /proc/sys/net/ipv4/conf/veth1/proxy_arp\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\néç½®å®æåï¼å¨node1çnet1ä¸­ping node2çnet2ï¼å¯ä»¥pingéæååã\n\n# ip netns exec net1 ping 10.1.2.2 \nping 10.1.2.2 (10.1.2.2) 56(84) bytes of data.\n64 bytes from 10.1.2.2: icmp_seq=1 ttl=62 time=5.46 ms\n64 bytes from 10.1.2.2: icmp_seq=2 ttl=62 time=4.67 ms\n64 bytes from 10.1.2.2: icmp_seq=3 ttl=62 time=5.52 ms\n\n\n1\n2\n3\n4\n5\n\n\n\n# å·¨äººçè©è\n\n * linux tun/tap ä»ç»\n\n * çè§£ linux èæç½å¡è®¾å¤ tun/tap çä¸å\n\n * åºäºtunè®¾å¤å®ç°å¨ç¨æ·ç©ºé´å¯ä»¥pingéå¤é¨èç¹(golangçæ¬)\n\n * ä¸èµ·å¨æåä¸ä¸ªvpn\n\nâ',charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"çè§£Linux IPIPé§é",frontmatter:{title:"çè§£Linux IPIPé§é",date:"2023-05-26T13:11:26.000Z",permalink:"/pages/c128e7/",categories:["ç¼ç¨","linux"],tags:["linux","è®¡ç®æºç½ç»","Linuxç½ç»èæå"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"IPIPé§éçå·¥ä½åçæ¯å°æºä¸»æºçIPæ°æ®åå°è£å¨ä¸ä¸ªæ°çIPæ°æ®åä¸­ï¼æ°çIPæ°æ®åçç®çå°åæ¯é§éçå¦ä¸ç«¯ãå¨é§éçå¦ä¸ç«¯ï¼æ¥æ¶æ¹å°è§£å°è£åå§IPæ°æ®åï¼å¹¶å°å¶ä¼ éå°ç®æ ä¸»æºãIPIPé§éå¯ä»¥å¨ä¸åçç½ç»ä¹é´å»ºç«è¿æ¥ï¼ä¾å¦å¨IPv4ç½ç»åIPv6ç½ç»ä¹é´å»ºç«è¿æ¥ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_ipip-20230526095538-83tl82w.png"},{name:"twitter:title",content:"çè§£Linux IPIPé§é"},{name:"twitter:description",content:"IPIPé§éçå·¥ä½åçæ¯å°æºä¸»æºçIPæ°æ®åå°è£å¨ä¸ä¸ªæ°çIPæ°æ®åä¸­ï¼æ°çIPæ°æ®åçç®çå°åæ¯é§éçå¦ä¸ç«¯ãå¨é§éçå¦ä¸ç«¯ï¼æ¥æ¶æ¹å°è§£å°è£åå§IPæ°æ®åï¼å¹¶å°å¶ä¼ éå°ç®æ ä¸»æºãIPIPé§éå¯ä»¥å¨ä¸åçç½ç»ä¹é´å»ºç«è¿æ¥ï¼ä¾å¦å¨IPv4ç½ç»åIPv6ç½ç»ä¹é´å»ºç«è¿æ¥ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_ipip-20230526095538-83tl82w.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/04.%E7%90%86%E8%A7%A3Linux%20IPIP%E9%9A%A7%E9%81%93.html"},{property:"og:type",content:"article"},{property:"og:title",content:"çè§£Linux IPIPé§é"},{property:"og:description",content:"IPIPé§éçå·¥ä½åçæ¯å°æºä¸»æºçIPæ°æ®åå°è£å¨ä¸ä¸ªæ°çIPæ°æ®åä¸­ï¼æ°çIPæ°æ®åçç®çå°åæ¯é§éçå¦ä¸ç«¯ãå¨é§éçå¦ä¸ç«¯ï¼æ¥æ¶æ¹å°è§£å°è£åå§IPæ°æ®åï¼å¹¶å°å¶ä¼ éå°ç®æ ä¸»æºãIPIPé§éå¯ä»¥å¨ä¸åçç½ç»ä¹é´å»ºç«è¿æ¥ï¼ä¾å¦å¨IPv4ç½ç»åIPv6ç½ç»ä¹é´å»ºç«è¿æ¥ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_ipip-20230526095538-83tl82w.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/04.%E7%90%86%E8%A7%A3Linux%20IPIP%E9%9A%A7%E9%81%93.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-05-26T13:11:26.000Z"},{property:"article:tag",content:"linux"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"Linuxç½ç»èæå"},{itemprop:"name",content:"çè§£Linux IPIPé§é"},{itemprop:"description",content:"IPIPé§éçå·¥ä½åçæ¯å°æºä¸»æºçIPæ°æ®åå°è£å¨ä¸ä¸ªæ°çIPæ°æ®åä¸­ï¼æ°çIPæ°æ®åçç®çå°åæ¯é§éçå¦ä¸ç«¯ãå¨é§éçå¦ä¸ç«¯ï¼æ¥æ¶æ¹å°è§£å°è£åå§IPæ°æ®åï¼å¹¶å°å¶ä¼ éå°ç®æ ä¸»æºãIPIPé§éå¯ä»¥å¨ä¸åçç½ç»ä¹é´å»ºç«è¿æ¥ï¼ä¾å¦å¨IPv4ç½ç»åIPv6ç½ç»ä¹é´å»ºç«è¿æ¥ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_ipip-20230526095538-83tl82w.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/03.linux/04.%E7%90%86%E8%A7%A3Linux%20IPIP%E9%9A%A7%E9%81%93.html",relativePath:"04.ç¼ç¨/03.linux/04.çè§£Linux IPIPé§é.md",key:"v-32e66a02",path:"/pages/c128e7/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"ä½¿ç¨IPIPé§éå®ç°è·¨ä¸»æºç½ç»",slug:"ä½¿ç¨ipipé§éå®ç°è·¨ä¸»æºç½ç»",normalizedTitle:"ä½¿ç¨ipipé§éå®ç°è·¨ä¸»æºç½ç»",charIndex:190},{level:2,title:"å·¨äººçè©è",slug:"å·¨äººçè©è",normalizedTitle:"å·¨äººçè©è",charIndex:1895}],headersStr:"ç®ä» ä½¿ç¨IPIPé§éå®ç°è·¨ä¸»æºç½ç» å·¨äººçè©è",content:"# ç®ä»\n\nIPIPé§éæ¯ä¸ç§ç¹å¯¹ç¹çé§éåè®®ï¼ç¨äºå¨IPv4ç½ç»ä¸ä¼ è¾IPv4æIPv6æ°æ®åã\n\nIPIPé§éçå·¥ä½åçæ¯å°æºä¸»æºçIPæ°æ®åå°è£å¨ä¸ä¸ªæ°çIPæ°æ®åä¸­ï¼æ°çIPæ°æ®åçç®çå°åæ¯é§éçå¦ä¸ç«¯ãå¨é§éçå¦ä¸ç«¯ï¼æ¥æ¶æ¹å°è§£å°è£åå§IPæ°æ®åï¼å¹¶å°å¶ä¼ éå°ç®æ ä¸»æºãIPIPé§éå¯ä»¥å¨ä¸åçç½ç»ä¹é´å»ºç«è¿æ¥ï¼ä¾å¦å¨IPv4ç½ç»åIPv6ç½ç»ä¹é´å»ºç«è¿æ¥ã\n\n\n# ä½¿ç¨IPIPé§éå®ç°è·¨ä¸»æºç½ç»\n\n\n\né¦åå¨Node1åå»ºtunè®¾å¤å¹¶è®¾ç½®ä¸ºipipæ¨¡å¼ï¼localè®¾ç½®ä¸ºæ¬å°IPå°å10.65.132.187ï¼remoteè®¾ç½®ä¸ºå¯¹ç«¯IP10.65.132.187ï¼è¿ä¸¤ä¸ªæ¯é§éå¤å±IPï¼ç¶ååè®¾ç½®é§éåå±IPï¼10.10.100.10å°10.10.200.10ã\n\nip tunnel add tun1 mode ipip remote 10.65.132.188 local 10.65.132.187\nip link set tun1 up\nip a add 10.10.100.10 peer 10.10.200.10 dev tun1\n\n\n1\n2\n3\n\n\nå¯ä»¥çå°æ·»å äºä¸æ¡è·¯ç±ï¼åéå°ç®çå°å10.10.200.10çåé½ä¼è½¬åå°tun1è®¾å¤ä¸­\n\n# ip r\n...\n10.10.200.10 dev tun1 proto kernel scope link src 10.10.100.10\n...\n\n\n1\n2\n3\n4\n\n\ntunè®¾å¤ä¼å°è¿å¥çIPåå°è£å°ä¸ä¸ªIPåä¸­ï¼æºå°åæ¯ä¹åè®¾ç½®çå¤å±local IPï¼èç®çå°åæ¯å¤å±remote IPï¼ç¶ååéè¿è·¯ç±è¾¾å°ä»ens18ç½å¡åºå»å°Node2ä¸­ã\n\nå¨Node2ä¸åå»ºtunè®¾å¤ï¼éç½®åNode1ä¸æ ·\n\nip tunnel add tun2 mode ipip remote 10.65.132.187 local 10.65.132.188\nip link set tun2 up\nip a add 10.10.200.10 peer 10.10.100.10 dev tun2\n\n\n\n1\n2\n3\n4\n\n\nç¶åå¨Node1ä¸ping Node2çtunè®¾å¤\n\nping 10.10.200.10 -c 1\n\n\n1\n\n\néè¿tcpdumpå¨Node2æåå¦ä¸ï¼\n\n20:16:40.011992 IP 10.65.132.187 > 10.65.132.188: IP 10.10.100.10 > 10.10.200.10: ICMP echo request, id 17609, seq 1, length 64 (ipip-proto-4)\n20:16:40.012099 IP 10.65.132.188 > 10.65.132.187: IP 10.10.200.10 > 10.10.100.10: ICMP echo reply, id 17609, seq 1, length 64 (ipip-proto-4)\n\n\n1\n2\n\n\næ°æ®åè¾¾å°Node2åï¼æ¯ä¸ä¸ªä¸¤å±IPæ°æ®åï¼ä»Node2çens18ç½å¡åºæ¥åï¼è§£å°æ°æ®åï¼åç°åå±çç®çIPæ¯10.10.200.10ä¹å°±æ¯tun2çå°åï¼ç¶åå°æ°æ®ååå°tun2è®¾å¤ã\n\ntun2è®¾å¤æ¶å°æ°æ®åååæ ¹æ®ä¸é¢ç¸åæ­¥éª¤è¿è¡å°è£æ°æ®åååç»tun1ï¼æç»æ´ä¸ªpingè¿ç¨å®æã\n\nIPIPé§éæ¯éè¿IPå°åæ¥æ è¯ç½ç»è®¾å¤çï¼æä»¥ä¸éè¦ä½¿ç¨MACå°åï¼ç´æ¥éè¿IPå°åå³å¯ãéè¿æ¥çtunè®¾å¤ä¿¡æ¯ï¼å¯ä»¥çå°å¶æ¯ä¸å­å¨macå°åçã\n\n# ip -d link show tun1\n59: tun1@NONE: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1480 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/ipip 10.65.132.187 peer 10.65.132.188 promiscuity 0 minmtu 68 maxmtu 65515 \n    ipip ipip remote 10.65.132.188 local 10.65.132.187 ttl inherit pmtudisc addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n\n\n\n# å·¨äººçè©è\n\n * ãKubernetesç½ç»æå¨æåã\n\nâ",normalizedContent:"# ç®ä»\n\nipipé§éæ¯ä¸ç§ç¹å¯¹ç¹çé§éåè®®ï¼ç¨äºå¨ipv4ç½ç»ä¸ä¼ è¾ipv4æipv6æ°æ®åã\n\nipipé§éçå·¥ä½åçæ¯å°æºä¸»æºçipæ°æ®åå°è£å¨ä¸ä¸ªæ°çipæ°æ®åä¸­ï¼æ°çipæ°æ®åçç®çå°åæ¯é§éçå¦ä¸ç«¯ãå¨é§éçå¦ä¸ç«¯ï¼æ¥æ¶æ¹å°è§£å°è£åå§ipæ°æ®åï¼å¹¶å°å¶ä¼ éå°ç®æ ä¸»æºãipipé§éå¯ä»¥å¨ä¸åçç½ç»ä¹é´å»ºç«è¿æ¥ï¼ä¾å¦å¨ipv4ç½ç»åipv6ç½ç»ä¹é´å»ºç«è¿æ¥ã\n\n\n# ä½¿ç¨ipipé§éå®ç°è·¨ä¸»æºç½ç»\n\n\n\né¦åå¨node1åå»ºtunè®¾å¤å¹¶è®¾ç½®ä¸ºipipæ¨¡å¼ï¼localè®¾ç½®ä¸ºæ¬å°ipå°å10.65.132.187ï¼remoteè®¾ç½®ä¸ºå¯¹ç«¯ip10.65.132.187ï¼è¿ä¸¤ä¸ªæ¯é§éå¤å±ipï¼ç¶ååè®¾ç½®é§éåå±ipï¼10.10.100.10å°10.10.200.10ã\n\nip tunnel add tun1 mode ipip remote 10.65.132.188 local 10.65.132.187\nip link set tun1 up\nip a add 10.10.100.10 peer 10.10.200.10 dev tun1\n\n\n1\n2\n3\n\n\nå¯ä»¥çå°æ·»å äºä¸æ¡è·¯ç±ï¼åéå°ç®çå°å10.10.200.10çåé½ä¼è½¬åå°tun1è®¾å¤ä¸­\n\n# ip r\n...\n10.10.200.10 dev tun1 proto kernel scope link src 10.10.100.10\n...\n\n\n1\n2\n3\n4\n\n\ntunè®¾å¤ä¼å°è¿å¥çipåå°è£å°ä¸ä¸ªipåä¸­ï¼æºå°åæ¯ä¹åè®¾ç½®çå¤å±local ipï¼èç®çå°åæ¯å¤å±remote ipï¼ç¶ååéè¿è·¯ç±è¾¾å°ä»ens18ç½å¡åºå»å°node2ä¸­ã\n\nå¨node2ä¸åå»ºtunè®¾å¤ï¼éç½®ånode1ä¸æ ·\n\nip tunnel add tun2 mode ipip remote 10.65.132.187 local 10.65.132.188\nip link set tun2 up\nip a add 10.10.200.10 peer 10.10.100.10 dev tun2\n\n\n\n1\n2\n3\n4\n\n\nç¶åå¨node1ä¸ping node2çtunè®¾å¤\n\nping 10.10.200.10 -c 1\n\n\n1\n\n\néè¿tcpdumpå¨node2æåå¦ä¸ï¼\n\n20:16:40.011992 ip 10.65.132.187 > 10.65.132.188: ip 10.10.100.10 > 10.10.200.10: icmp echo request, id 17609, seq 1, length 64 (ipip-proto-4)\n20:16:40.012099 ip 10.65.132.188 > 10.65.132.187: ip 10.10.200.10 > 10.10.100.10: icmp echo reply, id 17609, seq 1, length 64 (ipip-proto-4)\n\n\n1\n2\n\n\næ°æ®åè¾¾å°node2åï¼æ¯ä¸ä¸ªä¸¤å±ipæ°æ®åï¼ä»node2çens18ç½å¡åºæ¥åï¼è§£å°æ°æ®åï¼åç°åå±çç®çipæ¯10.10.200.10ä¹å°±æ¯tun2çå°åï¼ç¶åå°æ°æ®ååå°tun2è®¾å¤ã\n\ntun2è®¾å¤æ¶å°æ°æ®åååæ ¹æ®ä¸é¢ç¸åæ­¥éª¤è¿è¡å°è£æ°æ®åååç»tun1ï¼æç»æ´ä¸ªpingè¿ç¨å®æã\n\nipipé§éæ¯éè¿ipå°åæ¥æ è¯ç½ç»è®¾å¤çï¼æä»¥ä¸éè¦ä½¿ç¨macå°åï¼ç´æ¥éè¿ipå°åå³å¯ãéè¿æ¥çtunè®¾å¤ä¿¡æ¯ï¼å¯ä»¥çå°å¶æ¯ä¸å­å¨macå°åçã\n\n# ip -d link show tun1\n59: tun1@none: <pointopoint,noarp,up,lower_up> mtu 1480 qdisc noqueue state unknown mode default group default qlen 1000\n    link/ipip 10.65.132.187 peer 10.65.132.188 promiscuity 0 minmtu 68 maxmtu 65515 \n    ipip ipip remote 10.65.132.188 local 10.65.132.187 ttl inherit pmtudisc addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n\n\n\n# å·¨äººçè©è\n\n * ãkubernetesç½ç»æå¨æåã\n\nâ",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"çè§£VXLANç½ç»",frontmatter:{title:"çè§£VXLANç½ç»",date:"2023-05-26T11:38:14.000Z",permalink:"/pages/8a4b28/",categories:["ç¼ç¨","linux"],tags:["linux","è®¡ç®æºç½ç»","Linuxç½ç»èæå"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"å¨ä¸å±å¯è¾¾çç½ç»ä¸­é¨ç½²VXLANï¼å¨æ¯ä¸ªVXLANç½ç»ç«¯ç¹ä¸­é½æä¸ä¸ªVTEPè®¾å¤ï¼è´è´£å°VXLANåè®®çæ°æ®åè¿è¡UDPæ°æ®åçå°ååè§£åï¼å¯ä»¥å°å¶çè§£ä¸ºé§éï¼å°VXLANæ°æ®åä»é»è¾ç½ç»è½¬åå°ç©çç½ç»",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230526124522.png"},{name:"twitter:title",content:"çè§£VXLANç½ç»"},{name:"twitter:description",content:"å¨ä¸å±å¯è¾¾çç½ç»ä¸­é¨ç½²VXLANï¼å¨æ¯ä¸ªVXLANç½ç»ç«¯ç¹ä¸­é½æä¸ä¸ªVTEPè®¾å¤ï¼è´è´£å°VXLANåè®®çæ°æ®åè¿è¡UDPæ°æ®åçå°ååè§£åï¼å¯ä»¥å°å¶çè§£ä¸ºé§éï¼å°VXLANæ°æ®åä»é»è¾ç½ç»è½¬åå°ç©çç½ç»"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230526124522.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/03.%E7%90%86%E8%A7%A3VXLAN%E7%BD%91%E7%BB%9C.html"},{property:"og:type",content:"article"},{property:"og:title",content:"çè§£VXLANç½ç»"},{property:"og:description",content:"å¨ä¸å±å¯è¾¾çç½ç»ä¸­é¨ç½²VXLANï¼å¨æ¯ä¸ªVXLANç½ç»ç«¯ç¹ä¸­é½æä¸ä¸ªVTEPè®¾å¤ï¼è´è´£å°VXLANåè®®çæ°æ®åè¿è¡UDPæ°æ®åçå°ååè§£åï¼å¯ä»¥å°å¶çè§£ä¸ºé§éï¼å°VXLANæ°æ®åä»é»è¾ç½ç»è½¬åå°ç©çç½ç»"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230526124522.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/03.linux/03.%E7%90%86%E8%A7%A3VXLAN%E7%BD%91%E7%BB%9C.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2023-05-26T11:38:14.000Z"},{property:"article:tag",content:"linux"},{property:"article:tag",content:"è®¡ç®æºç½ç»"},{property:"article:tag",content:"Linuxç½ç»èæå"},{itemprop:"name",content:"çè§£VXLANç½ç»"},{itemprop:"description",content:"å¨ä¸å±å¯è¾¾çç½ç»ä¸­é¨ç½²VXLANï¼å¨æ¯ä¸ªVXLANç½ç»ç«¯ç¹ä¸­é½æä¸ä¸ªVTEPè®¾å¤ï¼è´è´£å°VXLANåè®®çæ°æ®åè¿è¡UDPæ°æ®åçå°ååè§£åï¼å¯ä»¥å°å¶çè§£ä¸ºé§éï¼å°VXLANæ°æ®åä»é»è¾ç½ç»è½¬åå°ç©çç½ç»"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230526124522.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/03.linux/03.%E7%90%86%E8%A7%A3VXLAN%E7%BD%91%E7%BB%9C.html",relativePath:"04.ç¼ç¨/03.linux/03.çè§£VXLANç½ç».md",key:"v-5973e693",path:"/pages/8a4b28/",headers:[{level:2,title:"ä»ä¹æ¯VXLAN?",slug:"ä»ä¹æ¯vxlan",normalizedTitle:"ä»ä¹æ¯vxlan?",charIndex:2},{level:2,title:"ç¹å¯¹ç¹çVXLAN",slug:"ç¹å¯¹ç¹çvxlan",normalizedTitle:"ç¹å¯¹ç¹çvxlan",charIndex:159},{level:3,title:"å®æ",slug:"å®æ",normalizedTitle:"å®æ",charIndex:205},{level:3,title:"å¼æµ",slug:"å¼æµ",normalizedTitle:"å¼æµ",charIndex:2072},{level:2,title:"VXLANçå¤æ­æ¨¡å¼",slug:"vxlançå¤æ­æ¨¡å¼",normalizedTitle:"vxlançå¤æ­æ¨¡å¼",charIndex:4578},{level:3,title:"éä¿¡è¿ç¨",slug:"éä¿¡è¿ç¨",normalizedTitle:"éä¿¡è¿ç¨",charIndex:4633},{level:3,title:"ç¯å¢åå¤",slug:"ç¯å¢åå¤",normalizedTitle:"ç¯å¢åå¤",charIndex:5250},{level:3,title:"å¼å§åæ",slug:"å¼å§åæ",normalizedTitle:"å¼å§åæ",charIndex:6883},{level:2,title:"VXLANå¤æ­æ¨¡å¼+æ¡¥æ¥",slug:"vxlanå¤æ­æ¨¡å¼-æ¡¥æ¥",normalizedTitle:"vxlanå¤æ­æ¨¡å¼+æ¡¥æ¥",charIndex:9655},{level:3,title:"éä¿¡è¿ç¨",slug:"éä¿¡è¿ç¨-2",normalizedTitle:"éä¿¡è¿ç¨",charIndex:4633},{level:3,title:"ç¯å¢åå¤",slug:"ç¯å¢åå¤-2",normalizedTitle:"ç¯å¢åå¤",charIndex:5250},{level:3,title:"å¼å§åæ",slug:"å¼å§åæ-2",normalizedTitle:"å¼å§åæ",charIndex:6883},{level:2,title:"å·¨äººçè©è",slug:"å·¨äººçè©è",normalizedTitle:"å·¨äººçè©è",charIndex:13468}],headersStr:"ä»ä¹æ¯VXLAN? ç¹å¯¹ç¹çVXLAN å®æ å¼æµ VXLANçå¤æ­æ¨¡å¼ éä¿¡è¿ç¨ ç¯å¢åå¤ å¼å§åæ VXLANå¤æ­æ¨¡å¼+æ¡¥æ¥ éä¿¡è¿ç¨ ç¯å¢åå¤ å¼å§åæ å·¨äººçè©è",content:"# ä»ä¹æ¯VXLAN?\n\nå¨ä¸å±å¯è¾¾çç½ç»ä¸­é¨ç½²VXLANï¼å¨æ¯ä¸ªVXLANç½ç»ç«¯ç¹ä¸­é½æä¸ä¸ªVTEPè®¾å¤ï¼è´è´£å°VXLANåè®®çæ°æ®åè¿è¡UDPæ°æ®åçå°ååè§£åï¼å¯ä»¥å°å¶çè§£ä¸ºé§éï¼å°VXLANæ°æ®åä»é»è¾ç½ç»è½¬åå°ç©çç½ç»\n\nVXLANä½¿ç¨24ä½çVXLANç½ç»æ è¯ç¬¦ï¼VNIï¼æ¥æ è¯ä¸åçèæç½ç»\n\n\n\n\n# ç¹å¯¹ç¹çVXLAN\n\nå¨å·²ç»ç¥éå¯¹ç«¯VTEPæå¨èç¹ï¼æ¯å¦ä½è¿è¡è·¨èç¹éä¿¡çã\n\n\n\n\n# å®æ\n\nå¨Nodeä¸æ°å¢VTEPè®¾å¤vxlan0ï¼åå»ºå½ä»¤å¦ä¸ï¼\n\nip link add vxlan0 type vxlan id 42 dstport 4789 remote 10.65.132.188 local 10.65.132.187 dev ens18\n\n\n1\n\n * remoteæ¯å¯¹ç«¯èç¹çIP\n * localæ¯æ¬èç¹IP\n * idæ¯VNIçå¼\n * dstport æ¯VTEPè®¾å¤çç«¯å£\n\nåå»ºå¥½åï¼éè¦ç»å®éç½®IPå¹¶å¯ç¨\n\nip a add 172.17.1.2/24 dev vxlan0\nip link set vxlan0 up\n\n\n1\n2\n\n\nvxlan0è¯¦æå¦ä¸ï¼\n\n# ip -d link show dev vxlan0\n114: vxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/ether 86:45:5c:56:49:42 brd ff:ff:ff:ff:ff:ff promiscuity 0 \n    vxlan id 42 remote 10.65.132.187 local 10.61.74.37 dev ens18 srcport 0 0 dstport 4789 ageing 300 noudpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n\n\nå¹¶ä¸å¯ä»¥çå°è·¯ç±ä¸­æ°å¢ä¸æ¡è®°å½ï¼ææç®çå°åæ¯172.17.1.0/24ç½æ®µçåé½è¦èµ°vxlan0è½¬åã\n\n# ip r\n...\n172.17.1.0/24 dev vxlan0 proto kernel scope link src 172.17.1.2\n...\n\n\n1\n2\n3\n4\n\n\nåæ¶fdbè¡¨ä¸­æ°å¢ä»¥ä¸è®°å½ï¼ä»£è¡¨çï¼ææè¿è¿vxlan0åçå¤é¨UDPç®çå°åé½ä¼è®¾ç½®ä¸º10.65.132.187ï¼å¹¶ä»ens18ç½å¡åºå»ã\n\n]# bridge fdb | grep vxlan0\n00:00:00:00:00:00 dev vxlan0 dst 10.65.132.187 via ens18 self permanent\n\n\n1\n2\n\n\nå°è¿éï¼Node1å·²ç»éç½®å¥½äºï¼æä»¬éå¤ä¸é¢æä½è®¾ç½®Node2ï¼åªéè¦å°é¨åIPä¿®æ¹å³å¯ã\n\n# å°Node1ä¸­remoteålocalåè¿æ¥å³å¯.\nip link add vxlan0 type vxlan id 42 dstport 4789 remote 10.65.132.187 dev ens18 local 10.65.132.188 dev ens18\n\n# vxlan0 å°åè®¾ç½®ä¸º172.17.1.3/24\nip a add 172.17.1.3/24 dev vxlan0\nip link set vxlan0 up\n\n# ip -d link show vxlan0\n20: vxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/ether 12:09:3d:c0:97:32 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535 \n    vxlan id 42 remote 10.65.132.187 local 10.65.132.188 dev ens18 srcport 0 0 dstport 4789 ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# å¼æµ\n\nå¨Node2ä¸çå¬Node1çudpæ°æ®å\n\ntcpdump -i ens18 udp and host 10.65.132.187 -n\n\n\n1\n\n\nç¶åå¨Node1ä¸­ping Node2çVTEPè®¾å¤å°å172.17.1.3\n\n[root@k8s-master-07rf9 ~]# ping 172.17.1.3 -c 3\nPING 172.17.1.3 (172.17.1.3) 56(84) bytes of data.\n64 bytes from 172.17.1.3: icmp_seq=1 ttl=64 time=0.841 ms\n64 bytes from 172.17.1.3: icmp_seq=2 ttl=64 time=0.382 ms\n64 bytes from 172.17.1.3: icmp_seq=3 ttl=64 time=0.377 ms\n\n\n1\n2\n3\n4\n5\n\n\nå¯ä»¥çå°tcpdumpæå°çæ°æ®åå¦ä¸ï¼åæ¶å°äºNode1çåè¿æ¥å°è£äºARPæ°æ®åçæ°æ®åï¼æ³è¦ç¥éNode2ä¸­VTEPè®¾å¤çMACå°åï¼ç¶ååç»äºNode1ï¼Node1æ¶å°åï¼å°MACå°åå¡«åï¼åå°å°è£äºICMPçVXLANæ°æ®ååéå°Node2ï¼Node2ä¸­VTEPæ¶å°åå¹¶è§£åï¼æåååç»Node1\n\n[root@k8s-work01-1zapn ~]# tcpdump -i ens18 udp and host 10.65.132.187 -n\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type EN10MB (Ethernet), capture size 262144 bytes\n19:23:36.705418 IP 10.65.132.187.34062 > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Request who-has 172.17.1.3 tell 172.17.1.2, length 28\n19:23:36.705574 IP 10.65.132.188.20835 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Reply 172.17.1.3 is-at 3a:84:39:cc:05:93, length 28\n19:23:36.705880 IP 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.2 > 172.17.1.3: ICMP echo request, id 25707, seq 1, length 64\n19:23:36.705986 IP 10.65.132.188.62793 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.3 > 172.17.1.2: ICMP echo reply, id 25707, seq 1, length 64\n19:23:37.708701 IP 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.2 > 172.17.1.3: ICMP echo request, id 25707, seq 2, length 64\n19:23:37.708846 IP 10.65.132.188.62793 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.3 > 172.17.1.2: ICMP echo reply, id 25707, seq 2, length 64\n19:23:38.732737 IP 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.2 > 172.17.1.3: ICMP echo request, id 25707, seq 3, length 64\n19:23:38.732846 IP 10.65.132.188.62793 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.3 > 172.17.1.2: ICMP echo reply, id 25707, seq 3, length 64\n19:23:41.804637 IP 10.65.132.188.20835 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Request who-has 172.17.1.2 tell 172.17.1.3, length 28\n19:23:41.804917 IP 10.65.132.187.34062 > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Reply 172.17.1.2 is-at c2:a1:4e:56:7d:eb, length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\n\n# VXLANçå¤æ­æ¨¡å¼\n\nå¨æä»¬ä¸ç¥éVTEPæå¨èç¹çæåµä¸ï¼å¹¶ä¸éè¦ä½¿ç¨å¤ä¸ªVTEPç»å»ºé»è¾ç½ç»ã\n\n\n# éä¿¡è¿ç¨\n\n\n\n 1. å¨Node1ä¸éè¿ping Node2ä¸vxlan0è®¾å¤ipï¼æ°æ®åéè¿è·¯ç±å°è¾¾vxlan0ï¼vxlan0åç°ç®çIPåæºIPå±äºåä¸ç½æ®µï¼éè¦ç¥éå¯¹æ¹çMACå°åï¼å æ­¤éè¦åéARPæ¥è¯¢æ¥æã\n 2. ARPæ¥æä¸­ï¼æºMACå°åä¸ºNode1ä¸vxlan0çmacå°åï¼ç®çmacå°åä¸º255.255.255.255ä¹å°±æ¯å¹¿æ­å°åï¼å¹¶ä¸æ·»å VXLANå¤´é¨VNI=42\n 3. å ä¸ºä¸ç¥éå¯¹ç«¯çVTEPè®¾å¤å¨åªå°èç¹ä¸ï¼æä»¥vxlan0ä¼åå¤æ­å°å224.1.1.1åéå¤æ­æ¥æã\n 4. å¤æ­ç»ä¸­ææçä¸»æºé½ä¼æ¶å°æ¥æï¼å¹¶ä¸åæ ¸ä¼å¤æ­è¯¥æ°æ®åä¸ºVXLANæ¥æï¼æ ¹æ®VNIåéç»VTEPè®¾å¤ã\n 5. Node2ä¸­vxlan0æ¶å°æ¥æåï¼è§£åæ¿å°ARPæ¥æï¼ç¶åéè¿ARPæ¥æå­¦ä¹ å°äºå°Node1çvxlan0çmacå°åä¸Node1 IPçæ å°å³ç³»è®°å½å°FDBè¡¨ä¸­ï¼å¹¶ä¸çæARPåºç­æ¥æã\n 6. ARPåºç­æ¥æä¸­ï¼ç®çä¸»æºNode1çMACå°ååç®çä¸»æºNode1ä¸­vxlan0çMACå°åé½éè¿åè¿æ¥çARPæ¥æä¸­å­¦ä¹ å°ï¼æä»¥å¯ä»¥ç´æ¥éè¿åæ­è¿è¡åå¤ã\n 7. Node1æ¶å°ARPåå¤çæ¥æåï¼éè¿æ¥æåå®¹ï¼å°Node2çä¸»æºå°ååvxlan0çMACå°åçæ å°å³ç³»ç¼å­å°FDBè¡¨ä¸­ã\n 8. ç°å¨åæ¹é½å·²ç»éè¿ARPæ¥æè·å¾äºåæ¹çå»ºç«ICMPéä¿¡çææä¿¡æ¯ï¼å¯ä»¥ç´æ¥éè¿éè¿åæ­è¿è¡éä¿¡ã\n\n\n# ç¯å¢åå¤\n\né¦åå¨Node1ä¸­æ°å¢VTEPè®¾å¤vxlan0ï¼VNIä¸º42ï¼éä¿¡ç«¯å£4789ï¼ä¸»æºå°åä¸º10.65.132.187ï¼è®¾ç½®å¤æ­å°åä¸º224.1.1.1ï¼æ°æ®åéè¿ens18çå®ç½å¡åºå»ã\n\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.187 group 224.1.1.1 dev ens18\n\n\n1\n\n\nç»vxlan0æ·»å å°å172.17.1.2/24ï¼å¹¶æå®æèµ·\n\nip addr add 172.17.1.2/24 dev vxlan0\nip link set vxlan0 up\n\n\n1\n2\n\n\næ¥çvxlan0çè¯¦ç»ä¿¡æ¯\n\n# ip -d link  show vxlan0\n22: vxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/ether 4e:92:72:79:59:ed brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535 \n    vxlan id 42 group 224.1.1.1 local 10.65.132.187 dev ens18 srcport 0 0 dstport 4789 ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n\n\n1\n2\n3\n4\n\n\nåççfdbè¡¨ï¼æææ¯ï¼vxlan0å°åçæ¶åï¼é»è®¤ä¼ä½¿ç¨224.1.1.1ä½ä¸ºVXLANåä¹å°±æ¯å¤é¨UDPçç®çIPã\n\n# bridge fdb | grep vxlan0\n00:00:00:00:00:00 dev vxlan0 dst 224.1.1.1 via ens18 self permanent\n\n\n1\n2\n\n\nå¨Node2ä¸éå¤ä¸è¿°æä½\n\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.188 group 224.1.1.1 dev ens18\n\nip addr add 172.17.1.3/24 dev vxlan0\nip link set vxlan0 up\n\n# ip -d link show vxlan0\n11: vxlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/ether ba:d8:43:67:8d:fb brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535 \n    vxlan id 42 group 224.1.1.1 local 10.65.132.188 dev ens18 srcport 0 0 dstport 4789 ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å¼å§åæ\n\nåä½¿ç¨tcpdumpæ¥çå¬Node2ä¸­ens18ç½å¡ä¸­æ¥èªNode1çUDPæ°æ®åï¼ç¶åå¨Node1ä¸ping Node2ä¸­vxlan0è®¾å¤ã\n\nå¯ä»¥çå°æ¯å¯ä»¥pingéçã\n\n# ping 172.17.1.3 -c 1\nPING 172.17.1.3 (172.17.1.3) 56(84) bytes of data.\n64 bytes from 172.17.1.3: icmp_seq=1 ttl=64 time=0.807 ms\n\n--- 172.17.1.3 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 0.807/0.807/0.807/0.000 ms\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåæ¥ççæå°çåï¼\n\n 1. ç¬¬ä¸ä¸ªæ°æ®åï¼å¯ä»¥çå°Node2æ¶å°äºæ¥èªNode1ç VXLANæ°æ®åï¼vniä¸º42ï¼ç®çå°åæ¯å¤æ­IP224.1.1.1ï¼å ä¸ºæä»¬åå»ºçVTEPè®¾å¤è®¾ç½®äºè¯¥å¤æ­IPï¼æä»¥ä¼æ¥æ¶è¯¥æ°æ®åãä¸éé¢å°è£äºARPæ°æ®åï¼éè¦å°172.17.1.3çMACå°ååè¯172.17.1.2ã\n 2. ç¬¬äºä¸ªæ°æ®åå¯ä»¥çå°åå¤äºä¸ä¸ªVXLANæ°æ®åï¼éé¢åå«äºARPåºç­åï¼å°172.17.1.3çmacå°åä¹å°±æ¯vxlan0çå°ååå¤è¿å»ã\n 3. ç¬¬ä¸ä¸ªæ°æ®åæ¯Node1 vxlan0æ ¹æ®å¯¹æ¹çMACå°ååNode2çIPå°åï¼ç´æ¥åæ­åéåå«äºICMPæ°æ®åçVXLANæ°æ®åå°Node2\n 4. ç¬¬åä¸ªæ°æ®åæ¶Node2 vxlan0è¿è¡åå¤ICMPï¼ä¹æ¯åè£¹å¨ä¸ä¸ªVXLANæ°æ®åä¸­ï¼åéå°Node1ä¸­ã\n\n# tcpdump -i ens18 udp and host 10.65.132.187 -n\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type EN10MB (Ethernet), capture size 262144 bytes\n\n10:31:34.560469 IP 10.65.132.187.34062 > 224.1.1.1.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Request who-has 172.17.1.3 tell 172.17.1.2, length 28\n10:31:34.560616 IP 10.65.132.188.20835 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Reply 172.17.1.3 is-at ba:d8:43:67:8d:fb, length 28\n10:31:34.560819 IP 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.2 > 172.17.1.3: ICMP echo request, id 46810, seq 1, length 64\n10:31:34.560935 IP 10.65.132.188.62793 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.3 > 172.17.1.2: ICMP echo reply, id 46810, seq 1, length 64\n10:31:39.661990 IP 10.65.132.188.20835 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Request who-has 172.17.1.2 tell 172.17.1.3, length 28\n10:31:39.662329 IP 10.65.132.187.34062 > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Reply 172.17.1.2 is-at 4e:92:72:79:59:ed, length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nåæ¬¡ping Node2çvxlan0è®¾å¤ï¼éè¿æåå¯ä»¥çå°ï¼ä¸éè¦åéARPæ¥æäºï¼æ¯å ä¸ºNode1å·²ç»ç¼å­äºARPã\n\nç¬¬ä¸ä¸ªæ°æ®åç®çIPä¸åæ¯224.1.1.1å¤æ­å°åäºï¼èæ¯Node2çå°åãæ¯å ä¸ºvxlan0ä¹å·²ç»ç¼å­å°fdbè¡¨ä¸­ã\n\n10:49:36.712777 IP 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.2 > 172.17.1.3: ICMP echo request, id 41695, seq 1, length 64\n10:49:36.712973 IP 10.65.132.188.62793 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.17.1.3 > 172.17.1.2: ICMP echo reply, id 41695, seq 1, length 64\n\n\n1\n2\n3\n4\n\n\næ¥çarpç¼å­\n\n# arp | grep vxlan0\n172.17.1.3               ether   ba:d8:43:67:8d:fb   C                     vxlan0\n\n\n1\n2\n\n\næ¥çfdbè¡¨ï¼æ·»å äºNode2ä¸­vxlan0çMACå°ååNode2å°åçæ å°è¡¨é¡¹ã\n\n# bridge fdb | grep vxlan0\n00:00:00:00:00:00 dev vxlan0 dst 224.1.1.1 via ens18 self permanent\nba:d8:43:67:8d:fb dev vxlan0 dst 10.65.132.188 self\n\n\n1\n2\n3\n\n\n\n# VXLANå¤æ­æ¨¡å¼+æ¡¥æ¥\n\nå¨VXLANçå¤æ­çåºç¡ä¸åå ä¸æ¡¥æ¥ç½ç»ã\n\n\n# éä¿¡è¿ç¨\n\næ¡¥æ¥ç½ç»æ¨¡æåéä¿¡å°å®¿ä¸»æºè¿ç¨å¯ä»¥åèæå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å\n\næ°æ®åè¾¾å°ç½æ¡¥åï¼ç¶ååè½¬åå°vxlan0ä¸­ï¼æ¥ä¸æ¥çæµç¨ä¹ä¸ä¸é¢å°çå¤æ­æ¯ä¸è´çã\n\n\n\n\n# ç¯å¢åå¤\n\nå¨Node1ä¸è¿è¡å¦ä¸å½ä»¤åå¤ç¯å¢\n\n# æ·»å VTEPè®¾å¤\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.187 group 224.1.1.1 dev ens18\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set vxlan0 master bridge0\nip link set vxlan0 up\nip link set bridge0 up\n\n# æ·»å net1æ¨¡æå®¹å¨\nip netns add net1\nip link add veth0 type veth peer name veth1\nip link set dev veth0 up\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nå¨Node2ä¸­éå¤ä¸é¢æä½ï¼å°172.19.1.3/24ç»å®å°å¦ä¸ä¸ªNetwork Namespace net3ä¸­\n\n# æ·»å VTEPè®¾å¤\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.188 group 224.1.1.1 dev ens18\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set vxlan0 master bridge0\nip link set vxlan0 up\nip link set bridge0 up\n\n# æ·»å net1æ¨¡æå®¹å¨\nip netns add net3\nip link add veth0 type veth peer name veth1\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.1.3/24 dev veth0\nip netns exec net3 ip link set veth0 up\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\n\n# å¼å§åæ\n\nå¨Node1çnet1ä¸­ping Node2ä¸­çnet3ï¼å¯ä»¥çå°æååï¼è¯´æç½ç»æ¯éçã\n\n# ip netns exec net1 ping 172.19.1.3 -c 2\nPING 172.19.1.3 (172.19.1.3) 56(84) bytes of data.\n64 bytes from 172.19.1.3: icmp_seq=1 ttl=64 time=0.992 ms\n64 bytes from 172.19.1.3: icmp_seq=2 ttl=64 time=0.605 ms\n\n\n1\n2\n3\n4\n\n\néè¿çå¬Node2çç½å¡ens18ï¼æå°ä»¥ä¸çåï¼\n\n 1. é¦åæ¯Node1åéåå«ARPçUDPåå°å¤æ­å°å224.1.1.1ï¼å ä¸ºNode2æ¯å±äºè¯¥å¤æ­å°åï¼æä»¥ä¼æ¥æ¶è¯¥åï¼å¹¶éè¿vxlan0è¿è¡è§£åï¼æç»æ¿å°ARPåï¼ç¶ååévxlan0çmacå°åè¿è¡arpååï¼ä¹æ¯éè¿å°è£å°UDPåä¸­åéNode1ä¸­ï¼ç¶ååéè¿vxlan0->bridgeè¿å¥å°net1ä¸­ï¼net1ä¸­æ¶å°ARPåï¼å°Node2çå®¹å¨IPå°ååmacå°åç¼å­å°ARPä¸­ã\n\n 2. å¹¶ä¸å¨fdbè¡¨ä¸­æ·»å ä¸é¡¹ï¼net3ççmacå°åä¸Node2çIPå°åæ å°å³ç³»\n\n 3. æ¥ä¸æ¥æ¯éè¿ARPç¼å­æ¾å°MACå°åå¹¶æ·»å å°ICMPçIPåä¸ï¼ç¶ååå°å¶å°è£å°UDPåä¸­ï¼UDPçæºIPæ¯éè¿æ¥è¯¢fdbè¡¨å¾å°çï¼å¯ä»¥ç´æ¥éè¿åæ­åéã\n\n7:15:47.595683 IP 10.65.132.187.34062 > 224.1.1.1.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Request who-has 172.19.1.3 tell 172.19.1.2, length 28\n17:15:47.595863 IP 10.65.132.188.20835 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nARP, Reply 172.19.1.3 is-at 02:fd:f9:7f:61:a7, length 28\n17:15:47.596172 IP 10.65.132.187.42208 > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.19.1.2 > 172.19.1.3: ICMP echo request, id 51397, seq 1, length 64\n17:15:47.596295 IP 10.65.132.188.22080 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.19.1.3 > 172.19.1.2: ICMP echo reply, id 51397, seq 1, length 64\n17:15:48.596543 IP 10.65.132.187.42208 > 10.65.132.188.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.19.1.2 > 172.19.1.3: ICMP echo request, id 51397, seq 2, length 64\n17:15:48.596724 IP 10.65.132.188.22080 > 10.65.132.187.vxlan: VXLAN, flags [I] (0x08), vni 42\nIP 172.19.1.3 > 172.19.1.2: ICMP echo reply, id 51397, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nå¯ä»¥çå°net1ä¸­å·²ç»ç¼å­äºnet3çipå°åä¸macå°å\n\n# Node1\n# ip netns exec net1 arp \nAddress                  HWtype  HWaddress           Flags Mask            Iface\n172.19.1.3               ether   02:fd:f9:7f:61:a7   C                     veth0\n\n\n1\n2\n3\n4\n\n\nnet3ä¸­çmacå°åånet1ä¸­çarpç¼å­æ¯å¯¹åºä¸çã\n\n# ip netns exec net3 ip -d link show veth0\n34: veth0@if33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DEFAULT group default qlen 1000\n    link/ether 02:fd:f9:7f:61:a7 brd ff:ff:ff:ff:ff:ff link-netnsid 0 promiscuity 0 minmtu 68 maxmtu 65535 \n    veth addrgenmode eui64 numtxqueues 8 numrxqueues 8 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n\n\næ¥çfdbè¡¨ï¼æ°å¢äºnet3çmacå°ååNode2çIPå°åæ å°å³ç³»\n\n# bridge fdb | grep vxlan0\n02:fd:f9:7f:61:a7 dev vxlan0 dst 10.65.132.188 self\n\n\n1\n2\n\n\n\n# å·¨äººçè©è\n\n * ãkubernetesç½ç»æå¨æåã",normalizedContent:"# ä»ä¹æ¯vxlan?\n\nå¨ä¸å±å¯è¾¾çç½ç»ä¸­é¨ç½²vxlanï¼å¨æ¯ä¸ªvxlanç½ç»ç«¯ç¹ä¸­é½æä¸ä¸ªvtepè®¾å¤ï¼è´è´£å°vxlanåè®®çæ°æ®åè¿è¡udpæ°æ®åçå°ååè§£åï¼å¯ä»¥å°å¶çè§£ä¸ºé§éï¼å°vxlanæ°æ®åä»é»è¾ç½ç»è½¬åå°ç©çç½ç»\n\nvxlanä½¿ç¨24ä½çvxlanç½ç»æ è¯ç¬¦ï¼vniï¼æ¥æ è¯ä¸åçèæç½ç»\n\n\n\n\n# ç¹å¯¹ç¹çvxlan\n\nå¨å·²ç»ç¥éå¯¹ç«¯vtepæå¨èç¹ï¼æ¯å¦ä½è¿è¡è·¨èç¹éä¿¡çã\n\n\n\n\n# å®æ\n\nå¨nodeä¸æ°å¢vtepè®¾å¤vxlan0ï¼åå»ºå½ä»¤å¦ä¸ï¼\n\nip link add vxlan0 type vxlan id 42 dstport 4789 remote 10.65.132.188 local 10.65.132.187 dev ens18\n\n\n1\n\n * remoteæ¯å¯¹ç«¯èç¹çip\n * localæ¯æ¬èç¹ip\n * idæ¯vniçå¼\n * dstport æ¯vtepè®¾å¤çç«¯å£\n\nåå»ºå¥½åï¼éè¦ç»å®éç½®ipå¹¶å¯ç¨\n\nip a add 172.17.1.2/24 dev vxlan0\nip link set vxlan0 up\n\n\n1\n2\n\n\nvxlan0è¯¦æå¦ä¸ï¼\n\n# ip -d link show dev vxlan0\n114: vxlan0: <broadcast,multicast,up,lower_up> mtu 1450 qdisc noqueue state unknown mode default group default qlen 1000\n    link/ether 86:45:5c:56:49:42 brd ff:ff:ff:ff:ff:ff promiscuity 0 \n    vxlan id 42 remote 10.65.132.187 local 10.61.74.37 dev ens18 srcport 0 0 dstport 4789 ageing 300 noudpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n\n\nå¹¶ä¸å¯ä»¥çå°è·¯ç±ä¸­æ°å¢ä¸æ¡è®°å½ï¼ææç®çå°åæ¯172.17.1.0/24ç½æ®µçåé½è¦èµ°vxlan0è½¬åã\n\n# ip r\n...\n172.17.1.0/24 dev vxlan0 proto kernel scope link src 172.17.1.2\n...\n\n\n1\n2\n3\n4\n\n\nåæ¶fdbè¡¨ä¸­æ°å¢ä»¥ä¸è®°å½ï¼ä»£è¡¨çï¼ææè¿è¿vxlan0åçå¤é¨udpç®çå°åé½ä¼è®¾ç½®ä¸º10.65.132.187ï¼å¹¶ä»ens18ç½å¡åºå»ã\n\n]# bridge fdb | grep vxlan0\n00:00:00:00:00:00 dev vxlan0 dst 10.65.132.187 via ens18 self permanent\n\n\n1\n2\n\n\nå°è¿éï¼node1å·²ç»éç½®å¥½äºï¼æä»¬éå¤ä¸é¢æä½è®¾ç½®node2ï¼åªéè¦å°é¨åipä¿®æ¹å³å¯ã\n\n# å°node1ä¸­remoteålocalåè¿æ¥å³å¯.\nip link add vxlan0 type vxlan id 42 dstport 4789 remote 10.65.132.187 dev ens18 local 10.65.132.188 dev ens18\n\n# vxlan0 å°åè®¾ç½®ä¸º172.17.1.3/24\nip a add 172.17.1.3/24 dev vxlan0\nip link set vxlan0 up\n\n# ip -d link show vxlan0\n20: vxlan0: <broadcast,multicast,up,lower_up> mtu 1450 qdisc noqueue state unknown mode default group default qlen 1000\n    link/ether 12:09:3d:c0:97:32 brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535 \n    vxlan id 42 remote 10.65.132.187 local 10.65.132.188 dev ens18 srcport 0 0 dstport 4789 ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n\n\n\n# å¼æµ\n\nå¨node2ä¸çå¬node1çudpæ°æ®å\n\ntcpdump -i ens18 udp and host 10.65.132.187 -n\n\n\n1\n\n\nç¶åå¨node1ä¸­ping node2çvtepè®¾å¤å°å172.17.1.3\n\n[root@k8s-master-07rf9 ~]# ping 172.17.1.3 -c 3\nping 172.17.1.3 (172.17.1.3) 56(84) bytes of data.\n64 bytes from 172.17.1.3: icmp_seq=1 ttl=64 time=0.841 ms\n64 bytes from 172.17.1.3: icmp_seq=2 ttl=64 time=0.382 ms\n64 bytes from 172.17.1.3: icmp_seq=3 ttl=64 time=0.377 ms\n\n\n1\n2\n3\n4\n5\n\n\nå¯ä»¥çå°tcpdumpæå°çæ°æ®åå¦ä¸ï¼åæ¶å°äºnode1çåè¿æ¥å°è£äºarpæ°æ®åçæ°æ®åï¼æ³è¦ç¥énode2ä¸­vtepè®¾å¤çmacå°åï¼ç¶ååç»äºnode1ï¼node1æ¶å°åï¼å°macå°åå¡«åï¼åå°å°è£äºicmpçvxlanæ°æ®ååéå°node2ï¼node2ä¸­vtepæ¶å°åå¹¶è§£åï¼æåååç»node1\n\n[root@k8s-work01-1zapn ~]# tcpdump -i ens18 udp and host 10.65.132.187 -n\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type en10mb (ethernet), capture size 262144 bytes\n19:23:36.705418 ip 10.65.132.187.34062 > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\narp, request who-has 172.17.1.3 tell 172.17.1.2, length 28\n19:23:36.705574 ip 10.65.132.188.20835 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\narp, reply 172.17.1.3 is-at 3a:84:39:cc:05:93, length 28\n19:23:36.705880 ip 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.2 > 172.17.1.3: icmp echo request, id 25707, seq 1, length 64\n19:23:36.705986 ip 10.65.132.188.62793 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.3 > 172.17.1.2: icmp echo reply, id 25707, seq 1, length 64\n19:23:37.708701 ip 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.2 > 172.17.1.3: icmp echo request, id 25707, seq 2, length 64\n19:23:37.708846 ip 10.65.132.188.62793 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.3 > 172.17.1.2: icmp echo reply, id 25707, seq 2, length 64\n19:23:38.732737 ip 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.2 > 172.17.1.3: icmp echo request, id 25707, seq 3, length 64\n19:23:38.732846 ip 10.65.132.188.62793 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.3 > 172.17.1.2: icmp echo reply, id 25707, seq 3, length 64\n19:23:41.804637 ip 10.65.132.188.20835 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\narp, request who-has 172.17.1.2 tell 172.17.1.3, length 28\n19:23:41.804917 ip 10.65.132.187.34062 > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\narp, reply 172.17.1.2 is-at c2:a1:4e:56:7d:eb, length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n\n\n\n# vxlançå¤æ­æ¨¡å¼\n\nå¨æä»¬ä¸ç¥évtepæå¨èç¹çæåµä¸ï¼å¹¶ä¸éè¦ä½¿ç¨å¤ä¸ªvtepç»å»ºé»è¾ç½ç»ã\n\n\n# éä¿¡è¿ç¨\n\n\n\n 1. å¨node1ä¸éè¿ping node2ä¸vxlan0è®¾å¤ipï¼æ°æ®åéè¿è·¯ç±å°è¾¾vxlan0ï¼vxlan0åç°ç®çipåæºipå±äºåä¸ç½æ®µï¼éè¦ç¥éå¯¹æ¹çmacå°åï¼å æ­¤éè¦åéarpæ¥è¯¢æ¥æã\n 2. arpæ¥æä¸­ï¼æºmacå°åä¸ºnode1ä¸vxlan0çmacå°åï¼ç®çmacå°åä¸º255.255.255.255ä¹å°±æ¯å¹¿æ­å°åï¼å¹¶ä¸æ·»å vxlanå¤´é¨vni=42\n 3. å ä¸ºä¸ç¥éå¯¹ç«¯çvtepè®¾å¤å¨åªå°èç¹ä¸ï¼æä»¥vxlan0ä¼åå¤æ­å°å224.1.1.1åéå¤æ­æ¥æã\n 4. å¤æ­ç»ä¸­ææçä¸»æºé½ä¼æ¶å°æ¥æï¼å¹¶ä¸åæ ¸ä¼å¤æ­è¯¥æ°æ®åä¸ºvxlanæ¥æï¼æ ¹æ®vniåéç»vtepè®¾å¤ã\n 5. node2ä¸­vxlan0æ¶å°æ¥æåï¼è§£åæ¿å°arpæ¥æï¼ç¶åéè¿arpæ¥æå­¦ä¹ å°äºå°node1çvxlan0çmacå°åä¸node1 ipçæ å°å³ç³»è®°å½å°fdbè¡¨ä¸­ï¼å¹¶ä¸çæarpåºç­æ¥æã\n 6. arpåºç­æ¥æä¸­ï¼ç®çä¸»æºnode1çmacå°ååç®çä¸»æºnode1ä¸­vxlan0çmacå°åé½éè¿åè¿æ¥çarpæ¥æä¸­å­¦ä¹ å°ï¼æä»¥å¯ä»¥ç´æ¥éè¿åæ­è¿è¡åå¤ã\n 7. node1æ¶å°arpåå¤çæ¥æåï¼éè¿æ¥æåå®¹ï¼å°node2çä¸»æºå°ååvxlan0çmacå°åçæ å°å³ç³»ç¼å­å°fdbè¡¨ä¸­ã\n 8. ç°å¨åæ¹é½å·²ç»éè¿arpæ¥æè·å¾äºåæ¹çå»ºç«icmpéä¿¡çææä¿¡æ¯ï¼å¯ä»¥ç´æ¥éè¿éè¿åæ­è¿è¡éä¿¡ã\n\n\n# ç¯å¢åå¤\n\né¦åå¨node1ä¸­æ°å¢vtepè®¾å¤vxlan0ï¼vniä¸º42ï¼éä¿¡ç«¯å£4789ï¼ä¸»æºå°åä¸º10.65.132.187ï¼è®¾ç½®å¤æ­å°åä¸º224.1.1.1ï¼æ°æ®åéè¿ens18çå®ç½å¡åºå»ã\n\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.187 group 224.1.1.1 dev ens18\n\n\n1\n\n\nç»vxlan0æ·»å å°å172.17.1.2/24ï¼å¹¶æå®æèµ·\n\nip addr add 172.17.1.2/24 dev vxlan0\nip link set vxlan0 up\n\n\n1\n2\n\n\næ¥çvxlan0çè¯¦ç»ä¿¡æ¯\n\n# ip -d link  show vxlan0\n22: vxlan0: <broadcast,multicast,up,lower_up> mtu 1450 qdisc noqueue state unknown mode default group default qlen 1000\n    link/ether 4e:92:72:79:59:ed brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535 \n    vxlan id 42 group 224.1.1.1 local 10.65.132.187 dev ens18 srcport 0 0 dstport 4789 ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n\n\n1\n2\n3\n4\n\n\nåççfdbè¡¨ï¼æææ¯ï¼vxlan0å°åçæ¶åï¼é»è®¤ä¼ä½¿ç¨224.1.1.1ä½ä¸ºvxlanåä¹å°±æ¯å¤é¨udpçç®çipã\n\n# bridge fdb | grep vxlan0\n00:00:00:00:00:00 dev vxlan0 dst 224.1.1.1 via ens18 self permanent\n\n\n1\n2\n\n\nå¨node2ä¸éå¤ä¸è¿°æä½\n\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.188 group 224.1.1.1 dev ens18\n\nip addr add 172.17.1.3/24 dev vxlan0\nip link set vxlan0 up\n\n# ip -d link show vxlan0\n11: vxlan0: <broadcast,multicast,up,lower_up> mtu 1450 qdisc noqueue state unknown mode default group default qlen 1000\n    link/ether ba:d8:43:67:8d:fb brd ff:ff:ff:ff:ff:ff promiscuity 0 minmtu 68 maxmtu 65535 \n    vxlan id 42 group 224.1.1.1 local 10.65.132.188 dev ens18 srcport 0 0 dstport 4789 ttl auto ageing 300 udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n\n\n\n# å¼å§åæ\n\nåä½¿ç¨tcpdumpæ¥çå¬node2ä¸­ens18ç½å¡ä¸­æ¥èªnode1çudpæ°æ®åï¼ç¶åå¨node1ä¸ping node2ä¸­vxlan0è®¾å¤ã\n\nå¯ä»¥çå°æ¯å¯ä»¥pingéçã\n\n# ping 172.17.1.3 -c 1\nping 172.17.1.3 (172.17.1.3) 56(84) bytes of data.\n64 bytes from 172.17.1.3: icmp_seq=1 ttl=64 time=0.807 ms\n\n--- 172.17.1.3 ping statistics ---\n1 packets transmitted, 1 received, 0% packet loss, time 0ms\nrtt min/avg/max/mdev = 0.807/0.807/0.807/0.000 ms\n\n\n1\n2\n3\n4\n5\n6\n7\n\n\nåæ¥ççæå°çåï¼\n\n 1. ç¬¬ä¸ä¸ªæ°æ®åï¼å¯ä»¥çå°node2æ¶å°äºæ¥èªnode1ç vxlanæ°æ®åï¼vniä¸º42ï¼ç®çå°åæ¯å¤æ­ip224.1.1.1ï¼å ä¸ºæä»¬åå»ºçvtepè®¾å¤è®¾ç½®äºè¯¥å¤æ­ipï¼æä»¥ä¼æ¥æ¶è¯¥æ°æ®åãä¸éé¢å°è£äºarpæ°æ®åï¼éè¦å°172.17.1.3çmacå°ååè¯172.17.1.2ã\n 2. ç¬¬äºä¸ªæ°æ®åå¯ä»¥çå°åå¤äºä¸ä¸ªvxlanæ°æ®åï¼éé¢åå«äºarpåºç­åï¼å°172.17.1.3çmacå°åä¹å°±æ¯vxlan0çå°ååå¤è¿å»ã\n 3. ç¬¬ä¸ä¸ªæ°æ®åæ¯node1 vxlan0æ ¹æ®å¯¹æ¹çmacå°åånode2çipå°åï¼ç´æ¥åæ­åéåå«äºicmpæ°æ®åçvxlanæ°æ®åå°node2\n 4. ç¬¬åä¸ªæ°æ®åæ¶node2 vxlan0è¿è¡åå¤icmpï¼ä¹æ¯åè£¹å¨ä¸ä¸ªvxlanæ°æ®åä¸­ï¼åéå°node1ä¸­ã\n\n# tcpdump -i ens18 udp and host 10.65.132.187 -n\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on ens18, link-type en10mb (ethernet), capture size 262144 bytes\n\n10:31:34.560469 ip 10.65.132.187.34062 > 224.1.1.1.vxlan: vxlan, flags [i] (0x08), vni 42\narp, request who-has 172.17.1.3 tell 172.17.1.2, length 28\n10:31:34.560616 ip 10.65.132.188.20835 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\narp, reply 172.17.1.3 is-at ba:d8:43:67:8d:fb, length 28\n10:31:34.560819 ip 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.2 > 172.17.1.3: icmp echo request, id 46810, seq 1, length 64\n10:31:34.560935 ip 10.65.132.188.62793 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.3 > 172.17.1.2: icmp echo reply, id 46810, seq 1, length 64\n10:31:39.661990 ip 10.65.132.188.20835 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\narp, request who-has 172.17.1.2 tell 172.17.1.3, length 28\n10:31:39.662329 ip 10.65.132.187.34062 > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\narp, reply 172.17.1.2 is-at 4e:92:72:79:59:ed, length 28\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n\n\nåæ¬¡ping node2çvxlan0è®¾å¤ï¼éè¿æåå¯ä»¥çå°ï¼ä¸éè¦åéarpæ¥æäºï¼æ¯å ä¸ºnode1å·²ç»ç¼å­äºarpã\n\nç¬¬ä¸ä¸ªæ°æ®åç®çipä¸åæ¯224.1.1.1å¤æ­å°åäºï¼èæ¯node2çå°åãæ¯å ä¸ºvxlan0ä¹å·²ç»ç¼å­å°fdbè¡¨ä¸­ã\n\n10:49:36.712777 ip 10.65.132.187.jboss-iiop > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.2 > 172.17.1.3: icmp echo request, id 41695, seq 1, length 64\n10:49:36.712973 ip 10.65.132.188.62793 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.17.1.3 > 172.17.1.2: icmp echo reply, id 41695, seq 1, length 64\n\n\n1\n2\n3\n4\n\n\næ¥çarpç¼å­\n\n# arp | grep vxlan0\n172.17.1.3               ether   ba:d8:43:67:8d:fb   c                     vxlan0\n\n\n1\n2\n\n\næ¥çfdbè¡¨ï¼æ·»å äºnode2ä¸­vxlan0çmacå°åånode2å°åçæ å°è¡¨é¡¹ã\n\n# bridge fdb | grep vxlan0\n00:00:00:00:00:00 dev vxlan0 dst 224.1.1.1 via ens18 self permanent\nba:d8:43:67:8d:fb dev vxlan0 dst 10.65.132.188 self\n\n\n1\n2\n3\n\n\n\n# vxlanå¤æ­æ¨¡å¼+æ¡¥æ¥\n\nå¨vxlançå¤æ­çåºç¡ä¸åå ä¸æ¡¥æ¥ç½ç»ã\n\n\n# éä¿¡è¿ç¨\n\næ¡¥æ¥ç½ç»æ¨¡æåéä¿¡å°å®¿ä¸»æºè¿ç¨å¯ä»¥åèæå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å\n\næ°æ®åè¾¾å°ç½æ¡¥åï¼ç¶ååè½¬åå°vxlan0ä¸­ï¼æ¥ä¸æ¥çæµç¨ä¹ä¸ä¸é¢å°çå¤æ­æ¯ä¸è´çã\n\n\n\n\n# ç¯å¢åå¤\n\nå¨node1ä¸è¿è¡å¦ä¸å½ä»¤åå¤ç¯å¢\n\n# æ·»å vtepè®¾å¤\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.187 group 224.1.1.1 dev ens18\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set vxlan0 master bridge0\nip link set vxlan0 up\nip link set bridge0 up\n\n# æ·»å net1æ¨¡æå®¹å¨\nip netns add net1\nip link add veth0 type veth peer name veth1\nip link set dev veth0 up\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net1\nip netns exec net1 ip addr add 172.19.1.2/24 dev veth0\nip netns exec net1 ip link set veth0 up\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nå¨node2ä¸­éå¤ä¸é¢æä½ï¼å°172.19.1.3/24ç»å®å°å¦ä¸ä¸ªnetwork namespace net3ä¸­\n\n# æ·»å vtepè®¾å¤\nip link add vxlan0 type vxlan id 42 dstport 4789 local 10.65.132.188 group 224.1.1.1 dev ens18\n\n# æ·»å ç½æ¡¥\nip link add bridge0 type bridge\nip link set vxlan0 master bridge0\nip link set vxlan0 up\nip link set bridge0 up\n\n# æ·»å net1æ¨¡æå®¹å¨\nip netns add net3\nip link add veth0 type veth peer name veth1\n\n# å°å¦ä¸ç«¯ç»å®å¨ç½æ¡¥ä¸\nip link set dev veth1 up\nip link set dev veth1 master bridge0\n\n# è®¾ç½®net1ä¸­ç½ç»éç½®\nip link set dev veth0 netns net3\nip netns exec net3 ip addr add 172.19.1.3/24 dev veth0\nip netns exec net3 ip link set veth0 up\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\n\n# å¼å§åæ\n\nå¨node1çnet1ä¸­ping node2ä¸­çnet3ï¼å¯ä»¥çå°æååï¼è¯´æç½ç»æ¯éçã\n\n# ip netns exec net1 ping 172.19.1.3 -c 2\nping 172.19.1.3 (172.19.1.3) 56(84) bytes of data.\n64 bytes from 172.19.1.3: icmp_seq=1 ttl=64 time=0.992 ms\n64 bytes from 172.19.1.3: icmp_seq=2 ttl=64 time=0.605 ms\n\n\n1\n2\n3\n4\n\n\néè¿çå¬node2çç½å¡ens18ï¼æå°ä»¥ä¸çåï¼\n\n 1. é¦åæ¯node1åéåå«arpçudpåå°å¤æ­å°å224.1.1.1ï¼å ä¸ºnode2æ¯å±äºè¯¥å¤æ­å°åï¼æä»¥ä¼æ¥æ¶è¯¥åï¼å¹¶éè¿vxlan0è¿è¡è§£åï¼æç»æ¿å°arpåï¼ç¶ååévxlan0çmacå°åè¿è¡arpååï¼ä¹æ¯éè¿å°è£å°udpåä¸­åénode1ä¸­ï¼ç¶ååéè¿vxlan0->bridgeè¿å¥å°net1ä¸­ï¼net1ä¸­æ¶å°arpåï¼å°node2çå®¹å¨ipå°ååmacå°åç¼å­å°arpä¸­ã\n\n 2. å¹¶ä¸å¨fdbè¡¨ä¸­æ·»å ä¸é¡¹ï¼net3ççmacå°åä¸node2çipå°åæ å°å³ç³»\n\n 3. æ¥ä¸æ¥æ¯éè¿arpç¼å­æ¾å°macå°åå¹¶æ·»å å°icmpçipåä¸ï¼ç¶ååå°å¶å°è£å°udpåä¸­ï¼udpçæºipæ¯éè¿æ¥è¯¢fdbè¡¨å¾å°çï¼å¯ä»¥ç´æ¥éè¿åæ­åéã\n\n7:15:47.595683 ip 10.65.132.187.34062 > 224.1.1.1.vxlan: vxlan, flags [i] (0x08), vni 42\narp, request who-has 172.19.1.3 tell 172.19.1.2, length 28\n17:15:47.595863 ip 10.65.132.188.20835 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\narp, reply 172.19.1.3 is-at 02:fd:f9:7f:61:a7, length 28\n17:15:47.596172 ip 10.65.132.187.42208 > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.19.1.2 > 172.19.1.3: icmp echo request, id 51397, seq 1, length 64\n17:15:47.596295 ip 10.65.132.188.22080 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.19.1.3 > 172.19.1.2: icmp echo reply, id 51397, seq 1, length 64\n17:15:48.596543 ip 10.65.132.187.42208 > 10.65.132.188.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.19.1.2 > 172.19.1.3: icmp echo request, id 51397, seq 2, length 64\n17:15:48.596724 ip 10.65.132.188.22080 > 10.65.132.187.vxlan: vxlan, flags [i] (0x08), vni 42\nip 172.19.1.3 > 172.19.1.2: icmp echo reply, id 51397, seq 2, length 64\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nå¯ä»¥çå°net1ä¸­å·²ç»ç¼å­äºnet3çipå°åä¸macå°å\n\n# node1\n# ip netns exec net1 arp \naddress                  hwtype  hwaddress           flags mask            iface\n172.19.1.3               ether   02:fd:f9:7f:61:a7   c                     veth0\n\n\n1\n2\n3\n4\n\n\nnet3ä¸­çmacå°åånet1ä¸­çarpç¼å­æ¯å¯¹åºä¸çã\n\n# ip netns exec net3 ip -d link show veth0\n34: veth0@if33: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state up mode default group default qlen 1000\n    link/ether 02:fd:f9:7f:61:a7 brd ff:ff:ff:ff:ff:ff link-netnsid 0 promiscuity 0 minmtu 68 maxmtu 65535 \n    veth addrgenmode eui64 numtxqueues 8 numrxqueues 8 gso_max_size 65536 gso_max_segs 65535 \n\n\n1\n2\n3\n4\n\n\næ¥çfdbè¡¨ï¼æ°å¢äºnet3çmacå°åånode2çipå°åæ å°å³ç³»\n\n# bridge fdb | grep vxlan0\n02:fd:f9:7f:61:a7 dev vxlan0 dst 10.65.132.188 self\n\n\n1\n2\n\n\n\n# å·¨äººçè©è\n\n * ãkubernetesç½ç»æå¨æåã",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"ä½¿ç¨hueåå»ºozzieçpyspark action workflow",frontmatter:{tags:["hue","python","å¤§æ°æ®"],title:"ä½¿ç¨hueåå»ºozzieçpyspark action workflow",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/aba491/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä»ç»å¦ä½ä½¿ç¨hueæ¥åå»ºozzieæ¥åå»ºä¸ä¸ªspark actionçowrkflow",feed:{enable:!0},categories:["ç¼ç¨","å¶ä»"],comment:!0,meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215736.png"},{name:"twitter:title",content:"ä½¿ç¨hueåå»ºozzieçpyspark action workflow"},{name:"twitter:description",content:"ä»ç»å¦ä½ä½¿ç¨hueæ¥åå»ºozzieæ¥åå»ºä¸ä¸ªspark actionçowrkflow"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215736.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/02.%E4%BD%BF%E7%94%A8hue%E5%88%9B%E5%BB%BAozzie%E7%9A%84pyspark%20action%20workflow.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä½¿ç¨hueåå»ºozzieçpyspark action workflow"},{property:"og:description",content:"ä»ç»å¦ä½ä½¿ç¨hueæ¥åå»ºozzieæ¥åå»ºä¸ä¸ªspark actionçowrkflow"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215736.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/02.%E4%BD%BF%E7%94%A8hue%E5%88%9B%E5%BB%BAozzie%E7%9A%84pyspark%20action%20workflow.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"hue"},{property:"article:tag",content:"python"},{property:"article:tag",content:"å¤§æ°æ®"},{itemprop:"name",content:"ä½¿ç¨hueåå»ºozzieçpyspark action workflow"},{itemprop:"description",content:"ä»ç»å¦ä½ä½¿ç¨hueæ¥åå»ºozzieæ¥åå»ºä¸ä¸ªspark actionçowrkflow"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20220907215736.png"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/02.%E4%BD%BF%E7%94%A8hue%E5%88%9B%E5%BB%BAozzie%E7%9A%84pyspark%20action%20workflow.html",relativePath:"04.ç¼ç¨/09.å¶ä»/02.ä½¿ç¨hueåå»ºozzieçpyspark action workflow.md",key:"v-7e9794a8",path:"/pages/aba491/",headersStr:null,content:'> hueæ¯ä¸ä¸ªApache Hadoop uiç³»ç»ï¼æ¬ç¯æç« ä»ç»å¦ä½ä½¿ç¨hueåå»ºä¸ä¸ªozzieçpyspark actionçworkflow, è¯¥workflowä»åå«ä¸ä¸ªspark actionãæ³¨æï¼æ¬æä½¿ç¨çæ¯pythonè¯­è¨çpysparkã\n\n 1. ç¼åä¸ä¸ªpythonæä½sparkçç¨åºã demo.py\n\nfrom pyspark.sql import SparkSession\n\nspark = SparkSession.builder.enableHiveSupport().appName(\n"demo").getOrCreate()\n\n# spark çä¸äºæä½\n.......\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 2. æ°å»ºworkflow\n\n\n\n> ä¼ å¥éè¦è¿è¡çpythonèæ¬\n\n\n\n 3. å¯¹è¯¥action è¿è¡ä¸äºå±æ§çéç½®ã\n\n> å¯¹sparkè¿è¡è®¾ç½®ï¼å¯ä»¥éæ©sparkçè¿è¡æ¨¡å¼ã é»è®¤ä½¿ç¨çæ¯spark1 çåºå»æ§è¡ï¼å¦æä½¿ç¨çæ¯spark2ï¼åéè¦è®¾ç½®å±æ§oozie.action.sharelib.for.spark=spark2 å¦å¾æç¤ºã\n\n\n\n> è¿å¥2è®¾ç½®ï¼è¿è¡ä¸äºåéçè®¾ç½® oozie.libpath éè¦ä½¿ç¨å°sparkçä¸äºjaråï¼å¡«å¥è·¯å¾jaråè·¯å¾ã\n\n\n\n 4. è¯¥workflowå·²ç»è®¾ç½®æåï¼å¯ä»¥å¯¹å¶è¿è¡è¿è¡è¿è¡æµè¯ã',normalizedContent:'> hueæ¯ä¸ä¸ªapache hadoop uiç³»ç»ï¼æ¬ç¯æç« ä»ç»å¦ä½ä½¿ç¨hueåå»ºä¸ä¸ªozzieçpyspark actionçworkflow, è¯¥workflowä»åå«ä¸ä¸ªspark actionãæ³¨æï¼æ¬æä½¿ç¨çæ¯pythonè¯­è¨çpysparkã\n\n 1. ç¼åä¸ä¸ªpythonæä½sparkçç¨åºã demo.py\n\nfrom pyspark.sql import sparksession\n\nspark = sparksession.builder.enablehivesupport().appname(\n"demo").getorcreate()\n\n# spark çä¸äºæä½\n.......\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n 2. æ°å»ºworkflow\n\n\n\n> ä¼ å¥éè¦è¿è¡çpythonèæ¬\n\n\n\n 3. å¯¹è¯¥action è¿è¡ä¸äºå±æ§çéç½®ã\n\n> å¯¹sparkè¿è¡è®¾ç½®ï¼å¯ä»¥éæ©sparkçè¿è¡æ¨¡å¼ã é»è®¤ä½¿ç¨çæ¯spark1 çåºå»æ§è¡ï¼å¦æä½¿ç¨çæ¯spark2ï¼åéè¦è®¾ç½®å±æ§oozie.action.sharelib.for.spark=spark2 å¦å¾æç¤ºã\n\n\n\n> è¿å¥2è®¾ç½®ï¼è¿è¡ä¸äºåéçè®¾ç½® oozie.libpath éè¦ä½¿ç¨å°sparkçä¸äºjaråï¼å¡«å¥è·¯å¾jaråè·¯å¾ã\n\n\n\n 4. è¯¥workflowå·²ç»è®¾ç½®æåï¼å¯ä»¥å¯¹å¶è¿è¡è¿è¡è¿è¡æµè¯ã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"ä½¿ç¨javaå¼ålogstashçfilteræä»¶",frontmatter:{title:"ä½¿ç¨javaå¼ålogstashçfilteræä»¶",date:"2022-12-20T15:37:33.000Z",permalink:"/pages/7f16f6/",categories:["è®¡ç®æº","ç»ä»¶","å¶ä»"],tags:["ç»ä»¶","logstash","java"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"ä¸»è¦è®°å½ä½¿ç¨javaå¼ålogstashçfilteræä»¶çè¿ç¨ã",feed:{enable:!0},comment:!0,meta:[{name:"twitter:title",content:"ä½¿ç¨javaå¼ålogstashçfilteræä»¶"},{name:"twitter:description",content:"ä¸»è¦è®°å½ä½¿ç¨javaå¼ålogstashçfilteræä»¶çè¿ç¨ã"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/03.%E4%BD%BF%E7%94%A8java%E5%BC%80%E5%8F%91logstash%E7%9A%84filter%E6%8F%92%E4%BB%B6.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ä½¿ç¨javaå¼ålogstashçfilteræä»¶"},{property:"og:description",content:"ä¸»è¦è®°å½ä½¿ç¨javaå¼ålogstashçfilteræä»¶çè¿ç¨ã"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/03.%E4%BD%BF%E7%94%A8java%E5%BC%80%E5%8F%91logstash%E7%9A%84filter%E6%8F%92%E4%BB%B6.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-12-20T15:37:33.000Z"},{property:"article:tag",content:"ç»ä»¶"},{property:"article:tag",content:"logstash"},{property:"article:tag",content:"java"},{itemprop:"name",content:"ä½¿ç¨javaå¼ålogstashçfilteræä»¶"},{itemprop:"description",content:"ä¸»è¦è®°å½ä½¿ç¨javaå¼ålogstashçfilteræä»¶çè¿ç¨ã"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/03.%E4%BD%BF%E7%94%A8java%E5%BC%80%E5%8F%91logstash%E7%9A%84filter%E6%8F%92%E4%BB%B6.html",relativePath:"04.ç¼ç¨/09.å¶ä»/03.ä½¿ç¨javaå¼ålogstashçfilteræä»¶.md",key:"v-7accfee0",path:"/pages/7f16f6/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. åå¤å¼åç¯å¢",slug:"_1-åå¤å¼åç¯å¢",normalizedTitle:"1. åå¤å¼åç¯å¢",charIndex:111},{level:2,title:"2. ç¼å logstash java filter æä»¶",slug:"_2-ç¼å-logstash-java-filter-æä»¶",normalizedTitle:"2. ç¼å logstash java filter æä»¶",charIndex:518},{level:3,title:"2.1 åå¤å®æ¹ demo",slug:"_2-1-åå¤å®æ¹-demo",normalizedTitle:"2.1 åå¤å®æ¹ demo",charIndex:552},{level:3,title:"2.2 å¼å Filter ä»£ç ",slug:"_2-2-å¼å-filter-ä»£ç ",normalizedTitle:"2.2 å¼å filter ä»£ç ",charIndex:835},{level:2,title:"3. ååæµè¯",slug:"_3-ååæµè¯",normalizedTitle:"3. ååæµè¯",charIndex:2129},{level:2,title:"4. æåé¨ç½² Filter æä»¶",slug:"_4-æåé¨ç½²-filter-æä»¶",normalizedTitle:"4. æåé¨ç½² filter æä»¶",charIndex:2368},{level:3,title:"4.1 åæ°æ®ä¿¡æ¯",slug:"_4-1-åæ°æ®ä¿¡æ¯",normalizedTitle:"4.1 åæ°æ®ä¿¡æ¯",charIndex:2390},{level:3,title:"4.2 æåä»»å¡",slug:"_4-2-æåä»»å¡",normalizedTitle:"4.2 æåä»»å¡",charIndex:2588},{level:3,title:"4.3 å®è£",slug:"_4-3-å®è£",normalizedTitle:"4.3 å®è£",charIndex:2659},{level:2,title:"5. éªè¯",slug:"_5-éªè¯",normalizedTitle:"5. éªè¯",charIndex:3043},{level:2,title:"6. ç¸å³é¾æ¥",slug:"_6-ç¸å³é¾æ¥",normalizedTitle:"6. ç¸å³é¾æ¥",charIndex:3700}],headersStr:"0. åè¨ 1. åå¤å¼åç¯å¢ 2. ç¼å logstash java filter æä»¶ 2.1 åå¤å®æ¹ demo 2.2 å¼å Filter ä»£ç  3. ååæµè¯ 4. æåé¨ç½² Filter æä»¶ 4.1 åæ°æ®ä¿¡æ¯ 4.2 æåä»»å¡ 4.3 å®è£ 5. éªè¯ 6. ç¸å³é¾æ¥",content:'# 0. åè¨\n\nå¨å·¥ä½ä¸­éå°ï¼logstash ä¸­ç filter ä¸­åäºå¤§éçè§£æé»è¾ï¼è§£ææ§è½éå°ç¶é¢ï¼æä»¥å¸æå°è¯¥é¨åçé»è¾è½¬æ¢æ java å¼åçæä»¶ï¼ä»¥æé«è§£æéåº¦ã\n\næ¬æä¸»è¦è®°å½æå¼åæä»¶çè¿ç¨ã\n\n\n# 1. åå¤å¼åç¯å¢\n\nä¸è½½ logstash æºç \n\nç´æ¥å¯ä»¥å» logstash github ä¸­éæ©èªå·±ä½¿ç¨ççæ¬è¿è¡ä¸è½½å³å¯ã\n\næå»º logstash\n\nå°ä¸è½½ç logstash åç¼©åè§£ååºæ¥ï¼è¿å¥ logstash æ ¹ç®å½ä¸ï¼å½åè·¯å¾ä¸æ gradlew å gradlew.bat ä¸¤ä¸ªèæ¬æä»¶ï¼åèæ¯å¨ linux ä¸æ§è¡çï¼åèæ¯å¨ windows æ§è¡çèæ¬ã\n\nåè®¾å½åç¯å¢æ¯ windowsï¼æ§è¡ gradlew.bat assemble å½ä»¤å¯ä»¥å¯¹å½åæ¨¡åè¿è¡æå»ºãå¨è¿ä¸ªè¿ç¨ä¸­ä¼å»ä¸è½½ææçä¾èµåå°æ¬å°ãç­å¾æå»ºå®æï¼ç´è³è¾åº BUILD SUCCESSFUL ä»£è¡¨æå»ºæåã\n\n> gradlew.bat èæ¬æ¯å¯¹ gradle çå°è£ï¼å¨æ§è¡è¯¥å½ä»¤æ¶ï¼ä¼ä¸»å¨æ ¹æ® gradle/wrapper/ ä¸çéç½®å»ä¸è½½ gradle å·¥å·ï¼ç¶ååè°ç¨ gradle è¿è¡æå»ºæ¨¡å\n\n\n# 2. ç¼å logstash java filter æä»¶\n\n\n# 2.1 åå¤å®æ¹ demo\n\nä¸è½½ java æä»¶å®æ¹æ¨¡æ¿\n\nå° logstash-filter-java_filter_example ä¸è½½å°æ¬å°ä½¿ç¨ï¼èªå®ä¹å¼åçæä»¶æ¯åºäºè¯¥ example è¿è¡ä¿®æ¹çã\n\næå»ºæä»¶\n\nå¨è¯¥é¡¹ç®çæ ¹ç®å½ä¸ï¼åå»º gradle.properties æä»¶ï¼éè¦æ·»å åéæå® logstash ä¸ç logstash-core ç®å½è·¯å¾ï¼ä½¿ç¨ç»å¯¹è·¯å¾å³å¯ã\n\nLOGSTASH_CORE_PATH=<target_folder>/logstash-core\n\n\n1\n\n\nè¯¥åéæ¯ç» build.gradle æä»¶ä¸­ä½¿ç¨çã\n\n\n# 2.2 å¼å Filter ä»£ç \n\né¦åæ¥çå®æ¹æä¾ç demo Filter ä»£ç ï¼ä»£ç è·¯å¾å¨ï¼src\\main\\java\\org\\logstashplugins\\JavaFilterExample.javaï¼æä»¬å¼åçæä»¶åºæ¬æ¯æç§è¿ä¸ªä¾å­è¿è¡ä¿®æ¹å®ç°çã\n\n * è®¾ç½® pipeline ä¸­çæä»¶åç§°\n\né¦åå¯ä»¥çå°æä¸ä¸ªæ³¨è§£ @LogstashPlugin(name = "java_filter_example") name çå¼æ¯ææä»¬å¨ pipeline ä¸­å¡«åçæä»¶åç§°ã\n\n * å¨ pipeline ä¸­ä¼ åå°æä»¶ä¸­\n\néè¿ PluginConfigSpec.stringSetting å®ä¹åé\n\npublic static final PluginConfigSpec<String> SOURCE_CONFIG = PluginConfigSpec.stringSetting("source", "message");\n\n\n1\n\n\nåéè¿å¨æé æ¹æ³ä¸­è°ç¨ get æ¹æ³å³å¯è·åå°ä¼ å¥çå¼\n\nthis.sourceField = config.get(SOURCE_CONFIG);\n\n\n1\n\n\nå¹¶ä¸éè¦å°æ°å¢çå­æ®µæ·»å å° configSchema æ¹æ³ä¸­å¹¶è¿ååºå»ã\n\n@Override\npublic Collection<PluginConfigSpec<?>> configSchema() {\n\t// should return a list of all configuration options for this plugin\n\treturn Collections.singletonList(SOURCE_CONFIG);\n}\n\n\n1\n2\n3\n4\n5\n\n * filter ä¸»ä½ç¼ç \n\nè¯¥æä»¶çä¸»ä½æ¯ filter æ¹æ³ï¼ä¹å°±æ¯æ°æ®çè¿æ»¤èµ°ç filter æ¹æ³ï¼æä»¬å°æ³è¦åçè§£æè§åå®ç°å¨è¯¥æ¹æ³ä¸­å³å¯ã\n\nå¯ä»¥çå°è¯¥æ¹æ³ä¸­æä¸ä¸ªå¯¹ events éåçå¤çï¼æ¯ä¸ä¸ª Event é½æ¯è¿æ¥çæ¯ä¸æ¡æ°æ®ï¼ç¶åå¯¹è¯¥æ¡æ°æ®è¿è¡å¤çè½¬æ¢ï¼æååå°è½¬æ¢å¥½ç events ä¼ åºå»ã\n\nå¯ä»¥çå°å®æ¹çæ¡ä¾æ¯å°ä¼ å¥ç message å­ç¬¦ä¸²ç¿»è½¬ã\n\n@Override\npublic Collection<Event> filter(Collection<Event> events, FilterMatchListener matchListener) {\n\tfor (Event e : events) {\n\t\tObject f = e.getField(sourceField);\n\t\tif (f instanceof String) {\n\t\t\te.setField(sourceField, StringUtils.reverse((String)f));\n\t\t\tmatchListener.filterMatched(e);\n\t\t}\n\t}\n\n\treturn events;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# 3. ååæµè¯\n\nåæµå¯¹æä»¶æ¥è¯´è³å³éè¦ï¼æä»¶çè§åè½¬æ¢æµç¨ãå¤æ­é»è¾é½éå¸¸å¤ï¼åç§ç±»åçæ°æ®é½å¯è½å¯¼è´æä»¶åºéï¼èæä»¶éªè¯éè¦ç¼è¯ãæåãå®è£åæµè¯ï¼æµç¨è¾é¿ï¼æä»¥æä»¬å¯ä»¥éè¿åæµæ¥åå°ä»¥ä¸æµç¨çè¿è¡ï¼å¨åæµä¸­å°±æææçå¯è½æ§é½éªè¯å°ï¼èçå¤§éçæ¶é´ãå¹¶ä¸å¨åç»­è¿­ä»£ä¿®æ¹ä¸­ï¼å¯ä»¥åå°æ¹å¨å¼åã\n\nå»ºè®®å¯ä»¥ä½¿ç¨ junit çåæ°ååæµæ¹å¼ï¼å¯ä»¥æé«åæµçæçåæ°éãè¿ä¸ªéè¦å¨ build.gradle æä»¶ä¸­ç dependencies æ·»å æ¯æåæ°åçåºæ¥æ¯æã\n\n\n# 4. æåé¨ç½² Filter æä»¶\n\n\n# 4.1 åæ°æ®ä¿¡æ¯\n\næä»¬éè¦å¨ build.gradle æä»¶ä¸­ä¿®æ¹é¨åçæä»¶åæ°æ®ä¿¡æ¯ï¼å descriptionãauthors å email ç­å­æ®µé½å¯ä»¥éæå¡«åï¼ä»¥ä¸å­æ®µéè¦æ³¨æï¼\n\n * groupï¼éè¦åååç¸å\n * pluginClassï¼éè¦åæä»¶ Filter çç±»åç¸å\n * pluginNameï¼éè¦å @LogstashPlugin ä¸­ç name ç¸å\n\n\n# 4.2 æåä»»å¡\n\néè¿æ§è¡ gradlew.bat gem è¿è¡æä»¶æåä»»å¡ï¼æåä¼å¨æä»¶æ ¹ç®ä¸çæ .gem çæä»¶å®è£åæä»¶ã\n\n\n# 4.3 å®è£\n\nå®è£æå¨çº¿å®è£åç¦»çº¿å®è£ä¸¤ç§æ¹å¼ã\n\n> æ³¨æï¼æä»¬éè¦å»å®ç½ä¸è½½å¯ä»¥ç´æ¥ä½¿ç¨ç logstashï¼èä¸è½ä½¿ç¨ä¸é¢èªå·±ä¸è½½ç logstash æºç ã\n\nå¨çº¿å®è£\n\nå¨çº¿å®è£ä¼å»è®¿é® Elastic çå®ç½ï¼æä»¥éè¦æ¯å¨çº¿çç¯å¢ã\n\néè¿æ§è¡ logstash/bin è·¯å¾ä¸ç logstash-plugin å½ä»¤è¿è¡å®è£ï¼ç­å¾çå»å³å¯å®è£æåã\n\nlogstash-plugin install /path/javaPlugin.gem\n\n\n1\n\n\nç¦»çº¿å®è£\n\nå¨æäºåºæ¯ä¸ï¼ç¯å¢æ¯ä¸è½è¿æ¥å¤ç½çï¼æä»¥éè¦ä½¿ç¨ç¦»çº¿å®è£çæ¹å¼ã\n\nå°çæç gem æä»¶åç¼©å° zip åä¸­ï¼ç¶ååä½¿ç¨ logstash-plugin å½ä»¤è¿è¡å®è£ã\n\nlogstash-plugin install file:///tmp/plugin.zip\n\n\n1\n\n\n\n# 5. éªè¯\n\nå®æ¹çæä»¶ example çåè½æ¯ç¿»è½¬å­ç¬¦ä¸²çåè½ï¼æä»¥æä»¬åªéè¦éªè¯è¯¥åè½å³å¯ã\n\n 1. åå»ºä¸ä¸ª pipeline.conf\n\ninput {\n    # è¾å¥ä¸ä¸ªå­ç¬¦ä¸²\n    generator { message => "Hello world!" count => 1 }\n}\n\nfilter {\n\t# å¨æä»¶ä¸­@LogstashPluginéç½®çæä»¶åç§°\n    java_filter_example {}\n}\n\noutput {\n    # ç´æ¥æå°å°æ§å¶å°\n    stdout { }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n 2. å¯å¨ logstash å è½½ä¸é¢ç pipeline.conf\n\nlogstash -f pipeline.conf\n\n\n1\n\n\nè¾åºå¦ä¸ï¼å¯ä»¥çå° message å­æ®µä¸­ç Hello world!è¢«ç¿»è½¬äºã\n\n{\n\t"host" => {\n\t\t"name" => "4-sip0060"\n\t},\n\t"event" => {\n\t\t"original" => "Hello world!",\n\t\t"sequence" => 0\n\t},\n\t"@timestamp" => 2022-12-20T07:27:46.634166300Z,\n\t"@version" => "1",\n\t"message" => "!dlrow olleH"\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# 6. ç¸å³é¾æ¥\n\n * How to write a Java filter plugin',normalizedContent:'# 0. åè¨\n\nå¨å·¥ä½ä¸­éå°ï¼logstash ä¸­ç filter ä¸­åäºå¤§éçè§£æé»è¾ï¼è§£ææ§è½éå°ç¶é¢ï¼æä»¥å¸æå°è¯¥é¨åçé»è¾è½¬æ¢æ java å¼åçæä»¶ï¼ä»¥æé«è§£æéåº¦ã\n\næ¬æä¸»è¦è®°å½æå¼åæä»¶çè¿ç¨ã\n\n\n# 1. åå¤å¼åç¯å¢\n\nä¸è½½ logstash æºç \n\nç´æ¥å¯ä»¥å» logstash github ä¸­éæ©èªå·±ä½¿ç¨ççæ¬è¿è¡ä¸è½½å³å¯ã\n\næå»º logstash\n\nå°ä¸è½½ç logstash åç¼©åè§£ååºæ¥ï¼è¿å¥ logstash æ ¹ç®å½ä¸ï¼å½åè·¯å¾ä¸æ gradlew å gradlew.bat ä¸¤ä¸ªèæ¬æä»¶ï¼åèæ¯å¨ linux ä¸æ§è¡çï¼åèæ¯å¨ windows æ§è¡çèæ¬ã\n\nåè®¾å½åç¯å¢æ¯ windowsï¼æ§è¡ gradlew.bat assemble å½ä»¤å¯ä»¥å¯¹å½åæ¨¡åè¿è¡æå»ºãå¨è¿ä¸ªè¿ç¨ä¸­ä¼å»ä¸è½½ææçä¾èµåå°æ¬å°ãç­å¾æå»ºå®æï¼ç´è³è¾åº build successful ä»£è¡¨æå»ºæåã\n\n> gradlew.bat èæ¬æ¯å¯¹ gradle çå°è£ï¼å¨æ§è¡è¯¥å½ä»¤æ¶ï¼ä¼ä¸»å¨æ ¹æ® gradle/wrapper/ ä¸çéç½®å»ä¸è½½ gradle å·¥å·ï¼ç¶ååè°ç¨ gradle è¿è¡æå»ºæ¨¡å\n\n\n# 2. ç¼å logstash java filter æä»¶\n\n\n# 2.1 åå¤å®æ¹ demo\n\nä¸è½½ java æä»¶å®æ¹æ¨¡æ¿\n\nå° logstash-filter-java_filter_example ä¸è½½å°æ¬å°ä½¿ç¨ï¼èªå®ä¹å¼åçæä»¶æ¯åºäºè¯¥ example è¿è¡ä¿®æ¹çã\n\næå»ºæä»¶\n\nå¨è¯¥é¡¹ç®çæ ¹ç®å½ä¸ï¼åå»º gradle.properties æä»¶ï¼éè¦æ·»å åéæå® logstash ä¸ç logstash-core ç®å½è·¯å¾ï¼ä½¿ç¨ç»å¯¹è·¯å¾å³å¯ã\n\nlogstash_core_path=<target_folder>/logstash-core\n\n\n1\n\n\nè¯¥åéæ¯ç» build.gradle æä»¶ä¸­ä½¿ç¨çã\n\n\n# 2.2 å¼å filter ä»£ç \n\né¦åæ¥çå®æ¹æä¾ç demo filter ä»£ç ï¼ä»£ç è·¯å¾å¨ï¼src\\main\\java\\org\\logstashplugins\\javafilterexample.javaï¼æä»¬å¼åçæä»¶åºæ¬æ¯æç§è¿ä¸ªä¾å­è¿è¡ä¿®æ¹å®ç°çã\n\n * è®¾ç½® pipeline ä¸­çæä»¶åç§°\n\né¦åå¯ä»¥çå°æä¸ä¸ªæ³¨è§£ @logstashplugin(name = "java_filter_example") name çå¼æ¯ææä»¬å¨ pipeline ä¸­å¡«åçæä»¶åç§°ã\n\n * å¨ pipeline ä¸­ä¼ åå°æä»¶ä¸­\n\néè¿ pluginconfigspec.stringsetting å®ä¹åé\n\npublic static final pluginconfigspec<string> source_config = pluginconfigspec.stringsetting("source", "message");\n\n\n1\n\n\nåéè¿å¨æé æ¹æ³ä¸­è°ç¨ get æ¹æ³å³å¯è·åå°ä¼ å¥çå¼\n\nthis.sourcefield = config.get(source_config);\n\n\n1\n\n\nå¹¶ä¸éè¦å°æ°å¢çå­æ®µæ·»å å° configschema æ¹æ³ä¸­å¹¶è¿ååºå»ã\n\n@override\npublic collection<pluginconfigspec<?>> configschema() {\n\t// should return a list of all configuration options for this plugin\n\treturn collections.singletonlist(source_config);\n}\n\n\n1\n2\n3\n4\n5\n\n * filter ä¸»ä½ç¼ç \n\nè¯¥æä»¶çä¸»ä½æ¯ filter æ¹æ³ï¼ä¹å°±æ¯æ°æ®çè¿æ»¤èµ°ç filter æ¹æ³ï¼æä»¬å°æ³è¦åçè§£æè§åå®ç°å¨è¯¥æ¹æ³ä¸­å³å¯ã\n\nå¯ä»¥çå°è¯¥æ¹æ³ä¸­æä¸ä¸ªå¯¹ events éåçå¤çï¼æ¯ä¸ä¸ª event é½æ¯è¿æ¥çæ¯ä¸æ¡æ°æ®ï¼ç¶åå¯¹è¯¥æ¡æ°æ®è¿è¡å¤çè½¬æ¢ï¼æååå°è½¬æ¢å¥½ç events ä¼ åºå»ã\n\nå¯ä»¥çå°å®æ¹çæ¡ä¾æ¯å°ä¼ å¥ç message å­ç¬¦ä¸²ç¿»è½¬ã\n\n@override\npublic collection<event> filter(collection<event> events, filtermatchlistener matchlistener) {\n\tfor (event e : events) {\n\t\tobject f = e.getfield(sourcefield);\n\t\tif (f instanceof string) {\n\t\t\te.setfield(sourcefield, stringutils.reverse((string)f));\n\t\t\tmatchlistener.filtermatched(e);\n\t\t}\n\t}\n\n\treturn events;\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# 3. ååæµè¯\n\nåæµå¯¹æä»¶æ¥è¯´è³å³éè¦ï¼æä»¶çè§åè½¬æ¢æµç¨ãå¤æ­é»è¾é½éå¸¸å¤ï¼åç§ç±»åçæ°æ®é½å¯è½å¯¼è´æä»¶åºéï¼èæä»¶éªè¯éè¦ç¼è¯ãæåãå®è£åæµè¯ï¼æµç¨è¾é¿ï¼æä»¥æä»¬å¯ä»¥éè¿åæµæ¥åå°ä»¥ä¸æµç¨çè¿è¡ï¼å¨åæµä¸­å°±æææçå¯è½æ§é½éªè¯å°ï¼èçå¤§éçæ¶é´ãå¹¶ä¸å¨åç»­è¿­ä»£ä¿®æ¹ä¸­ï¼å¯ä»¥åå°æ¹å¨å¼åã\n\nå»ºè®®å¯ä»¥ä½¿ç¨ junit çåæ°ååæµæ¹å¼ï¼å¯ä»¥æé«åæµçæçåæ°éãè¿ä¸ªéè¦å¨ build.gradle æä»¶ä¸­ç dependencies æ·»å æ¯æåæ°åçåºæ¥æ¯æã\n\n\n# 4. æåé¨ç½² filter æä»¶\n\n\n# 4.1 åæ°æ®ä¿¡æ¯\n\næä»¬éè¦å¨ build.gradle æä»¶ä¸­ä¿®æ¹é¨åçæä»¶åæ°æ®ä¿¡æ¯ï¼å descriptionãauthors å email ç­å­æ®µé½å¯ä»¥éæå¡«åï¼ä»¥ä¸å­æ®µéè¦æ³¨æï¼\n\n * groupï¼éè¦åååç¸å\n * pluginclassï¼éè¦åæä»¶ filter çç±»åç¸å\n * pluginnameï¼éè¦å @logstashplugin ä¸­ç name ç¸å\n\n\n# 4.2 æåä»»å¡\n\néè¿æ§è¡ gradlew.bat gem è¿è¡æä»¶æåä»»å¡ï¼æåä¼å¨æä»¶æ ¹ç®ä¸çæ .gem çæä»¶å®è£åæä»¶ã\n\n\n# 4.3 å®è£\n\nå®è£æå¨çº¿å®è£åç¦»çº¿å®è£ä¸¤ç§æ¹å¼ã\n\n> æ³¨æï¼æä»¬éè¦å»å®ç½ä¸è½½å¯ä»¥ç´æ¥ä½¿ç¨ç logstashï¼èä¸è½ä½¿ç¨ä¸é¢èªå·±ä¸è½½ç logstash æºç ã\n\nå¨çº¿å®è£\n\nå¨çº¿å®è£ä¼å»è®¿é® elastic çå®ç½ï¼æä»¥éè¦æ¯å¨çº¿çç¯å¢ã\n\néè¿æ§è¡ logstash/bin è·¯å¾ä¸ç logstash-plugin å½ä»¤è¿è¡å®è£ï¼ç­å¾çå»å³å¯å®è£æåã\n\nlogstash-plugin install /path/javaplugin.gem\n\n\n1\n\n\nç¦»çº¿å®è£\n\nå¨æäºåºæ¯ä¸ï¼ç¯å¢æ¯ä¸è½è¿æ¥å¤ç½çï¼æä»¥éè¦ä½¿ç¨ç¦»çº¿å®è£çæ¹å¼ã\n\nå°çæç gem æä»¶åç¼©å° zip åä¸­ï¼ç¶ååä½¿ç¨ logstash-plugin å½ä»¤è¿è¡å®è£ã\n\nlogstash-plugin install file:///tmp/plugin.zip\n\n\n1\n\n\n\n# 5. éªè¯\n\nå®æ¹çæä»¶ example çåè½æ¯ç¿»è½¬å­ç¬¦ä¸²çåè½ï¼æä»¥æä»¬åªéè¦éªè¯è¯¥åè½å³å¯ã\n\n 1. åå»ºä¸ä¸ª pipeline.conf\n\ninput {\n    # è¾å¥ä¸ä¸ªå­ç¬¦ä¸²\n    generator { message => "hello world!" count => 1 }\n}\n\nfilter {\n\t# å¨æä»¶ä¸­@logstashpluginéç½®çæä»¶åç§°\n    java_filter_example {}\n}\n\noutput {\n    # ç´æ¥æå°å°æ§å¶å°\n    stdout { }\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n 2. å¯å¨ logstash å è½½ä¸é¢ç pipeline.conf\n\nlogstash -f pipeline.conf\n\n\n1\n\n\nè¾åºå¦ä¸ï¼å¯ä»¥çå° message å­æ®µä¸­ç hello world!è¢«ç¿»è½¬äºã\n\n{\n\t"host" => {\n\t\t"name" => "4-sip0060"\n\t},\n\t"event" => {\n\t\t"original" => "hello world!",\n\t\t"sequence" => 0\n\t},\n\t"@timestamp" => 2022-12-20t07:27:46.634166300z,\n\t"@version" => "1",\n\t"message" => "!dlrow olleh"\n}\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\n\n# 6. ç¸å³é¾æ¥\n\n * how to write a java filter plugin',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"åå¸å¼é",frontmatter:{tags:["åå¸å¼","é","python"],title:"åå¸å¼é",date:"2022-09-21T10:09:01.000Z",permalink:"/pages/d91dfb/",author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬æä»ç»äºåå¸å¼ééå°çé®é¢åå¯¹åºçè§£å³æ¹æ¡",feed:{enable:!0},categories:["ç¼ç¨","å¶ä»"],comment:!0,meta:[{name:"twitter:title",content:"åå¸å¼é"},{name:"twitter:description",content:"æ¬æä»ç»äºåå¸å¼ééå°çé®é¢åå¯¹åºçè§£å³æ¹æ¡"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/01.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.html"},{property:"og:type",content:"article"},{property:"og:title",content:"åå¸å¼é"},{property:"og:description",content:"æ¬æä»ç»äºåå¸å¼ééå°çé®é¢åå¯¹åºçè§£å³æ¹æ¡"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/01.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-09-21T10:09:01.000Z"},{property:"article:tag",content:"åå¸å¼"},{property:"article:tag",content:"é"},{property:"article:tag",content:"python"},{itemprop:"name",content:"åå¸å¼é"},{itemprop:"description",content:"æ¬æä»ç»äºåå¸å¼ééå°çé®é¢åå¯¹åºçè§£å³æ¹æ¡"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/01.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.html",relativePath:"04.ç¼ç¨/09.å¶ä»/01.åå¸å¼é.md",key:"v-23857ed1",path:"/pages/d91dfb/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"æ°æ®åºæ´æ°é®é¢",slug:"æ°æ®åºæ´æ°é®é¢",normalizedTitle:"æ°æ®åºæ´æ°é®é¢",charIndex:34},{level:2,title:"è¶åé®é¢",slug:"è¶åé®é¢",normalizedTitle:"è¶åé®é¢",charIndex:1789},{level:2,title:"åºäºmysqlçä¹è§éæºå¶å®ç°",slug:"åºäºmysqlçä¹è§éæºå¶å®ç°",normalizedTitle:"åºäºmysqlçä¹è§éæºå¶å®ç°",charIndex:3022},{level:2,title:"åºäºmysqlçæ²è§éæºå¶å®ç°",slug:"åºäºmysqlçæ²è§éæºå¶å®ç°",normalizedTitle:"åºäºmysqlçæ²è§éæºå¶å®ç°",charIndex:4436},{level:2,title:"redisåå¸å¼é",slug:"redisåå¸å¼é",normalizedTitle:"redisåå¸å¼é",charIndex:4593},{level:3,title:"åå¸å¼ééè¦è§£å³çé®é¢",slug:"åå¸å¼ééè¦è§£å³çé®é¢",normalizedTitle:"åå¸å¼ééè¦è§£å³çé®é¢",charIndex:4607},{level:3,title:"æåºé®é¢",slug:"æåºé®é¢",normalizedTitle:"æåºé®é¢",charIndex:4804},{level:3,title:"redisä¸­åå­æä½setnx",slug:"redisä¸­åå­æä½setnx",normalizedTitle:"redisä¸­åå­æä½setnx",charIndex:7150},{level:3,title:"æ­»éé®é¢",slug:"æ­»éé®é¢",normalizedTitle:"æ­»éé®é¢",charIndex:7832},{level:3,title:"py-redis-lockåredis-py",slug:"py-redis-lockåredis-py",normalizedTitle:"py-redis-lockåredis-py",charIndex:10238},{level:3,title:"redisçåå¸å¼éä¼ç¼ºç¹",slug:"redisçåå¸å¼éä¼ç¼ºç¹",normalizedTitle:"redisçåå¸å¼éä¼ç¼ºç¹",charIndex:10307}],headersStr:"åè¨ æ°æ®åºæ´æ°é®é¢ è¶åé®é¢ åºäºmysqlçä¹è§éæºå¶å®ç° åºäºmysqlçæ²è§éæºå¶å®ç° redisåå¸å¼é åå¸å¼ééè¦è§£å³çé®é¢ æåºé®é¢ redisä¸­åå­æä½setnx æ­»éé®é¢ py-redis-lockåredis-py redisçåå¸å¼éä¼ç¼ºç¹",content:'# åè¨\n\næ¬æä»ç»äºåå¸å¼ééå°çé®é¢åå¯¹åºçè§£å³æ¹æ¡ã\n\n\n# æ°æ®åºæ´æ°é®é¢\n\nå¨æ°æ®åºä¸­åå»ºä¸ä¸ªååè¡¨ï¼åå«idãnameãcountå­æ®µï¼è¿éä½¿ç¨çpeeweeæ¥æä½æ°æ®åºã\n\nfrom peewee import *\n\ndb = SqliteDatabase(\'people.db\')\n\n\nclass Goods(Model):\n    id = IntegerField()\n    count = IntegerField()\n    name = CharField()\n\n    class Meta:\n        database = db  # This model uses the "people.db" database.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nåå§åæ°æ®è¡¨ä¸­æ°æ®ãç»id=1çåååå§åååæ°éä¸º100\n\nID   NAME      COUNT\n1    clothes   100\n\nä½¿ç¨ä¸¤ä¸ªçº¿ç¨æ¶è´¹ååååºçåºæ¯ï¼æ¯æ¬¡æ¶è´¹æ°éä¸º10ï¼å½ååæ°éåè¶³æ¶ï¼ååæ°éåå°10ãå ä¸ºç¨åºå¯è½ä¼å¨ä»»ä½å°æ¹æåè¿è¡ï¼æä»¬ä½¿ç¨time.Sleepæ¥æé ç¨åºæåçåºæ¯ã\n\nimport time\n\ndef main():\n    # ååºçæ°é\n    num = 10\n\n    goods = Goods.get(Goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        goods.count -= num\n        goods.save()\n\nif __name__ == \'__main__\':\n    import threading\n\n    t1 = threading.Thread(target=main)\n    t2 = threading.Thread(target=main)\n\n    t1.start()\n    t2.start()\n    t1.join()\n    t2.join()\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\nè¿è¡åä¼åç°ï¼ååæ°éåæäº90ï¼è¿ææ¾ä¸ç¬¦åæä»¬çé¢æãä¸¤ä¸ªçº¿ç¨é½æ¶è´¹äº10ä¸ªï¼é¢æç»æåºè¯¥æ¯80æå¯¹ã\n\nID   NAME      COUNT\n1    clothes   90\n\næ§è¡è¿ç¨\n\nå¨t1çº¿ç¨æ¥è¯¢å°çgoodsçååæ°éä¸º100ï¼ä¿å­å¨åéä¸­ï¼åæ­¢ï¼ç¶åt2çº¿ç¨å¼å§æ¥è¯¢ï¼æ¥è¯¢å°çæ°éä¹æ¯100ï¼ç¶åå¾ä¸æ§è¡æ¶ï¼t1å10ï¼è°ç¨saveæ¶æ¯åè¯æ°æ®åºä¿å­çæ°éä¸º90ï¼ç»æãt2çº¿ç¨ä¹æ¯100-10ï¼saveæ¶ï¼ä¹æ¯ä¿å­90ã\n\nè§£å³æ¹æ¡\n\nåºè¯¥è®©æ°æ®åºæ ¹æ®èªå·±å½åçå¼æ´æ°ï¼èä¸æ¯ä½¿ç¨åéä¸­çå¼è¿è¡æ´æ°ã\n\næä»¬æ¢å¤ååçæ°éå°100ï¼ç¶åä¿®æ¹ä»£ç å¦ä¸ï¼ä½¿ç¨updateæ¥è®©æ°æ®åºæ ¹æ®å½åçå¼è¿è¡æ´æ°ã\n\ndef main():\n    # ååºçæ°é\n    num = 10\n\n    goods = Goods.get(Goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = Goods.update(count=Goods.count - num).where(Goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¿è¡ç»æç¬¦åæä»¬çé¢æï¼ååæ°éåæäº80ã\n\nID   NAME      COUNT\n1    clothes   80\n\n\n# è¶åé®é¢\n\nè½ç¶è§£å³äºæ´æ°æ°éä¸ä¸è´çé®é¢ï¼ä¾ç¶æ²¡æè§£å³ååè¶åé®é¢ãååæ°éä¾ç¶æ¯100ï¼ä½æ¯æä»¬ä¸¤ä¸ªçº¿ç¨é½æ³ä¹°99ä»¶ã\n\ndef main():\n    # ååºçæ°é\n    num = 99\n\n    goods = Goods.get(Goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = Goods.update(count=Goods.count - num).where(Goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¿è¡ç»ææ¯ï¼ä¸¤ä¸ªçº¿ç¨é½æåä¹°å¥ï¼æ°æ®åºè¡¨ä¸­çæ°éåæäº-98ãæä»¬è¯å®ææä¸ä¸ªçº¿ç¨ä¹°å¥æåï¼èå¦ä¸ä¸ªçº¿ç¨æ§è¡å¤±è´¥ã\n\nID   NAME      COUNT\n1    clothes   -98\n\nå éè§£å³\n\næä»¬å¨ä¹°å¥ä¹åï¼å ä¸ä¸ªéï¼è¿æ ·åæ¶åªè½æä¸ä¸ªç¨æ·å¨æ§è¡ä¹°å¥ã\n\nimport threading\nR = threading.Lock()\n\ndef main():\n    # ååºçæ°é\n    num = 99\n\n    R.acquire()\n    goods = Goods.get(Goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = Goods.update(count=Goods.count - num).where(Goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n\n    R.release()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡ä¹åï¼å¯ä»¥çå°åºå­ä¸º1ä»¶ï¼åªæä¸ä¸ªçº¿ç¨æ´æ°æåï¼å¦ä¸ä¸ªæ´æ°å¤±è´¥ã\n\nå½åæ¯åä¸ä¸ªæå¡çä¸¤ä¸ªçº¿ç¨ä¸­ï¼å¯ä»¥æ¿å°éä¸æéï¼ä½æ¯å¦æå¨å¾®æå¡ä¸­ï¼æ¯ä¸æ¬¡è¯·æ±å ä¸ºè´è½½åè¡¡å¯è½è¯·æ±å¨ä¸åçæå¡ä¸­ï¼è¿ä¸¤ä¸ªæå¡çè³ä¸å¨åä¸å°æå¡å¨ä¸ï¼é£ä¹è¿ä¸ªéå°±å¤±æäºã\n\nè¿ä¸ªæ¶åéè¦ä½¿ç¨åå¸å¼éæ¥è§£å³è¯¥é®é¢ã â\n\n\n# åºäºmysqlçä¹è§éæºå¶å®ç°\n\nä»ä¹æ¯ä¹è§éï¼\n\nä¹è§éï¼å°±æ¯å¾ä¹è§ï¼æ¯æ¬¡å»æ¿æ°æ®çæ¶åé½è®¤ä¸ºå«äººä¸ä¼ä¿®æ¹ï¼æä»¥ä¸ä¼ä¸éï¼ä½æ¯å¨æ´æ°çæ¶åä¼å¤æ­ä¸ä¸å¨æ­¤æé´å«äººææ²¡æå»æ´æ°è¿ä¸ªæ°æ®ï¼å¯ä»¥ä½¿ç¨çæ¬å·ç­æºå¶ï¼ä¹è§ééç¨äºå¤è¯»çåºç¨ç±»åï¼è¿æ ·å¯ä»¥æé«ååé\n\nå®ç°\n\nä»ä¸å¡ä¸­å®ç°ä¹è§éæºå¶ã\n\nå¨ä¹åçGoodsè¡¨ä¸­æ·»å versionå­æ®µ\n\nclass Goods(Model):\n    id = IntegerField()\n    count = IntegerField()\n    name = CharField()\n    version = IntegerField()\n\n    class Meta:\n        database = db  # This model uses the "people.db" database.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næ°æ®è¡¨å¦ä¸ï¼\n\nID   NAME      COUNT   VERSION\n1    clothes   100     1\n\nå¨æ´æ°æ¡ä»¶ä¸­æ·»å çæ¬çå¤æ­ï¼ç¡®è®¤å¨æ´æ°åºå­æ°éæ¶ï¼æ¯å¦æå¶ä»æå¡æ´æ¹äºè¯¥æ¡è®°å½ï¼å¦ææ²¡æåè¿è¡æ´æ°ãå¹¶ä¸å¨æ´æ°åºå­æ¶ï¼ç»çæ¬å·+1ï¼ä»£è¡¨çè¯¥è®°å½å·²è¢«ä¿®æ¹ã\n\nå¦ææ²¡ææ´æ°æåï¼åä¸ç´éè¯ï¼ç´è³æåä¸ºæ­¢ã\n\ndef main():\n    # ååºçæ°é\n    num = 99\n\n    while True:\n        goods = Goods.get(Goods.id == 1)\n        time.sleep(random.randint(1, 3))\n        if goods.count < num:\n            print("ååæ°éä¸è¶³")\n            break\n        else:\n            query = Goods.update(count=Goods.count - num, version=Goods.version + 1).where(Goods.id == 1,\n                                                                                           Goods.version == goods.version)\n            ok = query.execute()\n            if ok:\n                print("æ´æ°æå")\n                break\n            else:\n                print("æ´æ°å¤±è´¥")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nè¿è¡ç»æï¼\n\næ´æ°æå\næ´æ°å¤±è´¥\nååæ°éä¸è¶³\n\n\n1\n2\n3\n\n\nåºå­å©ä¸1ä»¶ï¼çæ¬å·æ´æ°ä¸º2ï¼ç¬¦åæä»¬çé¢æã\n\nID   NAME      COUNT   VERSION\n1    clothes   1       2\n\nâ ä¼ç¹ï¼\n\n 1. ç®å\n 2. ä¸éè¦é¢å¤çç»ä»¶\n\nç¼ºç¹ï¼\n\nå¹¶åé«æ¶ï¼ä¸æ­çå¯¹æ°æ®åºè¿è¡æ¥è¯¢ï¼ä¸æ ·ä¼å¢å æ°æ®åºçååãæ§è½å·®ã\n\nâ\n\n\n# åºäºmysqlçæ²è§éæºå¶å®ç°\n\næ²è§é,å°±æ¯å¾æ²è§ï¼æ¯æ¬¡å»æ¿æ°æ®çæ¶åé½è®¤ä¸ºå«äººä¼ä¿®æ¹ï¼æä»¥æ¯æ¬¡å¨æ¿æ°æ®çæ¶åé½ä¼ä¸éï¼è¿æ ·å«äººæ³æ¿è¿ä¸ªæ°æ®å°±ä¼blockç´å°å®æ¿å°éãä¼ ç»çå³ç³»åæ°æ®åºéè¾¹å°±ç¨å°äºå¾å¤è¿ç§éæºå¶ï¼æ¯å¦è¡éï¼è¡¨éç­ï¼è¯»éï¼åéç­ï¼é½æ¯å¨åæä½ä¹ååä¸éã\n\nç¼ºç¹ï¼å¹¶åæ§ä¸é«ï¼ä¸å»ºè®®ä½¿ç¨\n\n\n# redisåå¸å¼é\n\n\n# åå¸å¼ééè¦è§£å³çé®é¢\n\n 1. äºæ¥æ§ï¼ä»»ä½æ¶å»åªè½æä¸ä¸ªå®¢æ·æ¥æéï¼ä¸è½åæ¶å¤ä¸ªå®¢æ·è·å\n\n 2. å®å¨æ§ï¼åªæè¢«ææè¯¥éçç¨æ·å é¤ï¼èä¸è½è¢«å¶ä»ç¨æ·å é¤\n\n 3. æ­»éï¼è·åéçå®¢æ·åå ä¸ºæäºåå èå®æºï¼èæªè½éæ¾éï¼å¶ä»å®¢æ·ç«¯æ æ³è·åéï¼éè¦ææºå¶æ¥é¿åè¯¥ç±»é®é¢çåç\n    \n    1. ä»£ç å¼å¸¸ï¼å¯¼è´æ æ³è¿è¡å°release\n    2. ä½ çå½åæå¡å¨ç½ç»é®é¢-èè£\n\n\n# æåºé®é¢\n\næåå»ºä¸ä¸ªrediséçç±»ï¼ä½¿ç¨acquireå éï¼releaseè§£éã\n\nclass Lock:\n    def __init__(self, name):\n        self.redis_client = redis.Redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n        if not self.redis_client.get(self.name):\n            self.redis_client.set(self.name, 1)\n            return True\n        else:\n            while True:\n                import time\n                time.sleep(1)\n                if self.redis_client.get(self.name):\n                    self.redis_client.set(self.name, 1)\n                    return True\n\n    def release(self):\n        self.redis_client.delete(self.name)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nå¨å¥å£å¤å éï¼å¨åºå£å¤éæ¾éï¼è¿æ ·åæ¶åªæä¸ä¸ªæå¡è½å¤æ§è¡æ´æ°æä½ã\n\ndef main():\n    # ååºçæ°é\n    num = 99\n    # ååID\n    goods_id = 1\n\n    lock = Lock("lock:goods_{}".format(goods_id))\n    lock.acquire()\n    goods = Goods.get(Goods.id == goods_id)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = Goods.update(count=Goods.count - num).where(Goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n    lock.release()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nè¿è¡ä¹åï¼åç°åºå­çæ°éæ¯-98ï¼æ²¡æè¾¾å°é¢æçææã\n\nID   NAME      COUNT\n1    clothes   -98\n\næéè¿ææ¥å¿çæ¹å¼ï¼å¨redis_client.getä¹ååreleaseä¸­ææ¥å¿ã\n\nclass Lock:\n    def __init__(self, name):\n        self.redis_client = redis.Redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n\n        if not self.redis_client.get(self.name):\n            print("acquire\\n")\n            self.redis_client.set(self.name, 1)\n            return True\n        else:\n            while True:\n                import time\n                time.sleep(1)\n                if self.redis_client.get(self.name):\n                    self.redis_client.set(self.name, 1)\n                    return True\n\n    def release(self):\n        print("release")\n        self.redis_client.delete(self.name)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¿è¡ç»æå¦ä¸ï¼\n\nacquireacquire\n\næ´æ°æå\nrelease\næ´æ°æå\nrelease\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨æ²¡æéæ¾éçæ¶åï¼ä¸¤ä¸ªçº¿ç¨ç«ç¶é½æ¿å°éäºï¼\n\nå ä¸ºï¼çº¿ç¨t1å¨æ§è¡redis_client.get(self.name)ä¹åè¿æ²¡æredis_client.set(self.name, 1)æ¶ï¼çº¿ç¨t2ä¹è¿æ¥å°è¿ä¸æ­¥äºï¼ä¹å°±æ¯ä¸¤ä¸ªçº¿ç¨åæ¶å¨self.redis_client.get(self.name)åself.redis_client.set(self.name, 1)ä¹é´ã\n\næä»¬éè¦ä¿è¯getåsetæ¯åå­æ§çï¼æè½è§£å³è¯¥é®é¢ã\n\n\n# redisä¸­åå­æä½setnx\n\nredisä¸­èªå¸¦äºä¸ä¸ªåå­æ§æä½setnxï¼å¯ä»¥è¿è¡æ¥è¯¢å¹¶æ´æ°ã\n\nclass Lock:\n    def __init__(self, name):\n        self.redis_client = redis.Redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n#       # å¦æä¸å­å¨ï¼è®¾ç½®å¼ä¸º1ï¼è¿å1. å¦åè¿å0. åå­æä½ã\n        if self.redis_client.setnx(self.name, 1):\n            return True\n        else:\n            while True:\n                import time\n                time.sleep(1)\n                if self.redis_client.setnx(self.name, 1):\n                    return True\n\n    def release(self):\n        self.redis_client.delete(self.name)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nè¿è¡åï¼åºå­æ°éä¸º1ï¼ç¬¦åæä»¬çé¢æã\n\nID   NAME      COUNT\n1    clothes   1\n\n\n# æ­»éé®é¢\n\nè·åéçå®¢æ·åå ä¸ºæäºåå èå®æºï¼èæªè½éæ¾éï¼å¶ä»å®¢æ·ç«¯æ æ³è·åéï¼éè¦ææºå¶æ¥é¿åè¯¥ç±»é®é¢çåç\n\n 1. ä»£ç å¼å¸¸ï¼å¯¼è´æ æ³è¿è¡å°release\n 2. æ­ç¹\n\nâ è§£å³æ¹æ¡ï¼\n\néè¿è®¾ç½®è¿ææ¶é´æ¥è§£å³ï¼æ¯æ¬¡å¨æ¿éæ¶ï¼ç»redisä¸­å¯¹åºçkeyè®¾ç½®ä¸ä¸ªè¿ææ¶é´ï¼å³ä½¿åºç°ä¸é¢çé®é¢ï¼keyä¹è½èªå¨è¢«å é¤ï¼è§£å³æ­»éé®é¢ã\n\nclass Lock:\n    def __init__(self, name):\n        self.redis_client = redis.Redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n        if self.redis_client.set(self.name, 1, nx=True, ex=15):\n            return True\n        else:\n            while True:\n                import time\n                time.sleep(1)\n                if self.redis_client.set(self.name, 1, nx=True, ex=15):\n                    return True\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nä½æ¯ä¼ææ°é®é¢ï¼\n\n * å½åçº¿ç¨å¦æå¨ä¸æ®µæ¶é´åæ²¡ææ§è¡å®ï¼å½åçç¨åºæ²¡ææ§è¡å®ï¼ç¶åkeyè¿æ\n * ä¸å®å¨ï¼å¦ä¸ä¸ªçº¿ç¨è¿æ¥ä»¥åä¼å°å½åçkeyç»å æï¼å¦ä¸ä¸ªçº¿ç¨å æäºæ¬è¯¥å±äºæè®¾ç½®çå¼ã\n\nè§£å³æ¹æ¡ï¼\n\nå¦æå½åçº¿ç¨æ²¡ææ§è¡å®ï¼é£æçè¿ä¸ªçº¿ç¨è¿åºè¯¥å¨éå½çæ¶åå»ç»­ç§ï¼å°è¿ææ¶é´éæ°è®¾ç½®ãä¸è¬æ¯å¨å¿«è¦è¿æç2/3çæ¶åå»ç»­ç§ãå®æ¶ç¨åºå¯ä»¥ä½¿ç¨å¦ä¸ä¸ªçº¿ç¨å»å®æã\n\nclass Lock:\n    def __init__(self, name):\n        self.redis_client = redis.Redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n        if self.redis_client.set(self.name, 1, nx=True, ex=15):\n            # å¯å¨ä¸ä¸ªçº¿ç¨ç¶åå»å®æ¶çå·æ°è¿ä¸ªè¿æï¼è¿ä¸ªæä½æå¥½ä¹æ¯ä½¿ç¨luaèæ¬æ¥å®æã\n            return True\n        else:\n            while True:\n                import time\n                time.sleep(1)\n                if self.redis_client.set(self.name, 1, nx=True, ex=15):\n                    return True\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nâ å¦ä½é²æ­¢æè®¾ç½®çå¼è¢«å¶ä»ççº¿ç¨ç»å é¤æ?\n\nè§£å³æ¹æ³\n\nå¯ä»¥æ¿éçæ¶åçæä¸ä¸ªIDï¼å¹¶å°å¶è®¾ç½®redisä¸­é®å¯¹åºçå¼ï¼å¨å é¤çæ¶åï¼å¤æ­ä»redisä¸­æ¿åºçå¼æ¯å¦ä¸ºè¯¥ç¨åºè®¾ç½®çIDï¼å¦æä¸æ¯ï¼åå é¤å¤±è´¥ã\n\nclass Lock:\n    def __init__(self, name, id=None):\n        self.redis_client = redis.Redis(host="10.61.74.37")\n        self.name = name\n        self.id = id if id else str(uuid.uuid4())\n\n    def acquire(self):\n        if self.redis_client.set(self.name, self.id, nx=True, ex=15):\n            # å¯å¨ä¸ä¸ªçº¿ç¨ç¶åå»å®æ¶çå·æ°è¿ä¸ªè¿æï¼è¿ä¸ªæä½æå¥½ä¹æ¯ä½¿ç¨luaèæ¬æ¥å®æã\n            return True\n        else:\n            while True:\n                import time\n                time.sleep(1)\n                if self.redis_client.set(self.name, self.id, nx=True, ex=15):\n                    return True\n\n    def release(self):\n        val = str(self.redis_client.get(self.name), encoding="utf8")\n        if val == self.id:\n            self.redis_client.delete(self.name)\n        else:\n            print("ä¸è½å é¤èªå·±çé")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nâ ä½æ¯è¿ä¼ææ°çé®é¢ï¼ä¸é¢çreleaseæ¹æ³ï¼getådelete redisä¸­keyåæäºä¸¤ä¸ªæ­¥éª¤ï¼è¿æ¯æå¯è½å¨ä¸¤èä¹é´ä¸­æ­ï¼æä»¥éè¦ä½¿ç¨redisçluaèæ¬æ¥å®ç°ä¸¤èçåå­æä½\n\n\n# py-redis-lockåredis-py\n\nè¯¥åºæ¯å¼æºçåå¸å¼épyå®ç°åºï¼è§£å³äºä¸é¢çé®é¢ãåé¢æç©ºå¯ä»¥åæä¸è¯¥åºçæºç ã\n\n\n# redisçåå¸å¼éä¼ç¼ºç¹\n\nä¼ç¹\n\n * æ§è½é«\n * ç®å\n * redisæ¬èº«ä½¿ç¨å¾é¢ç¹ï¼ä¸éè¦é¢å¤ç»´æ¤\n\nç¼ºç¹\n\n * ä¾èµäºç¬¬ä¸æ¹ç»ä»¶\n\n * åæºçredisææçå¯è½æ§ç¸å¯¹è¾é«ï¼éè¦å¼å¥å¨åµæºå¶\n\n * redisçclusterçå¼å¥ä¼å¯¼è´åæçredisçéä¼æé®é¢ - redlock\n\nâ\n\nâ',normalizedContent:'# åè¨\n\næ¬æä»ç»äºåå¸å¼ééå°çé®é¢åå¯¹åºçè§£å³æ¹æ¡ã\n\n\n# æ°æ®åºæ´æ°é®é¢\n\nå¨æ°æ®åºä¸­åå»ºä¸ä¸ªååè¡¨ï¼åå«idãnameãcountå­æ®µï¼è¿éä½¿ç¨çpeeweeæ¥æä½æ°æ®åºã\n\nfrom peewee import *\n\ndb = sqlitedatabase(\'people.db\')\n\n\nclass goods(model):\n    id = integerfield()\n    count = integerfield()\n    name = charfield()\n\n    class meta:\n        database = db  # this model uses the "people.db" database.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n\n\nåå§åæ°æ®è¡¨ä¸­æ°æ®ãç»id=1çåååå§åååæ°éä¸º100\n\nid   name      count\n1    clothes   100\n\nä½¿ç¨ä¸¤ä¸ªçº¿ç¨æ¶è´¹ååååºçåºæ¯ï¼æ¯æ¬¡æ¶è´¹æ°éä¸º10ï¼å½ååæ°éåè¶³æ¶ï¼ååæ°éåå°10ãå ä¸ºç¨åºå¯è½ä¼å¨ä»»ä½å°æ¹æåè¿è¡ï¼æä»¬ä½¿ç¨time.sleepæ¥æé ç¨åºæåçåºæ¯ã\n\nimport time\n\ndef main():\n    # ååºçæ°é\n    num = 10\n\n    goods = goods.get(goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        goods.count -= num\n        goods.save()\n\nif __name__ == \'__main__\':\n    import threading\n\n    t1 = threading.thread(target=main)\n    t2 = threading.thread(target=main)\n\n    t1.start()\n    t2.start()\n    t1.join()\n    t2.join()\n\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\nè¿è¡åä¼åç°ï¼ååæ°éåæäº90ï¼è¿ææ¾ä¸ç¬¦åæä»¬çé¢æãä¸¤ä¸ªçº¿ç¨é½æ¶è´¹äº10ä¸ªï¼é¢æç»æåºè¯¥æ¯80æå¯¹ã\n\nid   name      count\n1    clothes   90\n\næ§è¡è¿ç¨\n\nå¨t1çº¿ç¨æ¥è¯¢å°çgoodsçååæ°éä¸º100ï¼ä¿å­å¨åéä¸­ï¼åæ­¢ï¼ç¶åt2çº¿ç¨å¼å§æ¥è¯¢ï¼æ¥è¯¢å°çæ°éä¹æ¯100ï¼ç¶åå¾ä¸æ§è¡æ¶ï¼t1å10ï¼è°ç¨saveæ¶æ¯åè¯æ°æ®åºä¿å­çæ°éä¸º90ï¼ç»æãt2çº¿ç¨ä¹æ¯100-10ï¼saveæ¶ï¼ä¹æ¯ä¿å­90ã\n\nè§£å³æ¹æ¡\n\nåºè¯¥è®©æ°æ®åºæ ¹æ®èªå·±å½åçå¼æ´æ°ï¼èä¸æ¯ä½¿ç¨åéä¸­çå¼è¿è¡æ´æ°ã\n\næä»¬æ¢å¤ååçæ°éå°100ï¼ç¶åä¿®æ¹ä»£ç å¦ä¸ï¼ä½¿ç¨updateæ¥è®©æ°æ®åºæ ¹æ®å½åçå¼è¿è¡æ´æ°ã\n\ndef main():\n    # ååºçæ°é\n    num = 10\n\n    goods = goods.get(goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = goods.update(count=goods.count - num).where(goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¿è¡ç»æç¬¦åæä»¬çé¢æï¼ååæ°éåæäº80ã\n\nid   name      count\n1    clothes   80\n\n\n# è¶åé®é¢\n\nè½ç¶è§£å³äºæ´æ°æ°éä¸ä¸è´çé®é¢ï¼ä¾ç¶æ²¡æè§£å³ååè¶åé®é¢ãååæ°éä¾ç¶æ¯100ï¼ä½æ¯æä»¬ä¸¤ä¸ªçº¿ç¨é½æ³ä¹°99ä»¶ã\n\ndef main():\n    # ååºçæ°é\n    num = 99\n\n    goods = goods.get(goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = goods.update(count=goods.count - num).where(goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nè¿è¡ç»ææ¯ï¼ä¸¤ä¸ªçº¿ç¨é½æåä¹°å¥ï¼æ°æ®åºè¡¨ä¸­çæ°éåæäº-98ãæä»¬è¯å®ææä¸ä¸ªçº¿ç¨ä¹°å¥æåï¼èå¦ä¸ä¸ªçº¿ç¨æ§è¡å¤±è´¥ã\n\nid   name      count\n1    clothes   -98\n\nå éè§£å³\n\næä»¬å¨ä¹°å¥ä¹åï¼å ä¸ä¸ªéï¼è¿æ ·åæ¶åªè½æä¸ä¸ªç¨æ·å¨æ§è¡ä¹°å¥ã\n\nimport threading\nr = threading.lock()\n\ndef main():\n    # ååºçæ°é\n    num = 99\n\n    r.acquire()\n    goods = goods.get(goods.id == 1)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = goods.update(count=goods.count - num).where(goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n\n    r.release()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n\n\nè¿è¡ä¹åï¼å¯ä»¥çå°åºå­ä¸º1ä»¶ï¼åªæä¸ä¸ªçº¿ç¨æ´æ°æåï¼å¦ä¸ä¸ªæ´æ°å¤±è´¥ã\n\nå½åæ¯åä¸ä¸ªæå¡çä¸¤ä¸ªçº¿ç¨ä¸­ï¼å¯ä»¥æ¿å°éä¸æéï¼ä½æ¯å¦æå¨å¾®æå¡ä¸­ï¼æ¯ä¸æ¬¡è¯·æ±å ä¸ºè´è½½åè¡¡å¯è½è¯·æ±å¨ä¸åçæå¡ä¸­ï¼è¿ä¸¤ä¸ªæå¡çè³ä¸å¨åä¸å°æå¡å¨ä¸ï¼é£ä¹è¿ä¸ªéå°±å¤±æäºã\n\nè¿ä¸ªæ¶åéè¦ä½¿ç¨åå¸å¼éæ¥è§£å³è¯¥é®é¢ã â\n\n\n# åºäºmysqlçä¹è§éæºå¶å®ç°\n\nä»ä¹æ¯ä¹è§éï¼\n\nä¹è§éï¼å°±æ¯å¾ä¹è§ï¼æ¯æ¬¡å»æ¿æ°æ®çæ¶åé½è®¤ä¸ºå«äººä¸ä¼ä¿®æ¹ï¼æä»¥ä¸ä¼ä¸éï¼ä½æ¯å¨æ´æ°çæ¶åä¼å¤æ­ä¸ä¸å¨æ­¤æé´å«äººææ²¡æå»æ´æ°è¿ä¸ªæ°æ®ï¼å¯ä»¥ä½¿ç¨çæ¬å·ç­æºå¶ï¼ä¹è§ééç¨äºå¤è¯»çåºç¨ç±»åï¼è¿æ ·å¯ä»¥æé«ååé\n\nå®ç°\n\nä»ä¸å¡ä¸­å®ç°ä¹è§éæºå¶ã\n\nå¨ä¹åçgoodsè¡¨ä¸­æ·»å versionå­æ®µ\n\nclass goods(model):\n    id = integerfield()\n    count = integerfield()\n    name = charfield()\n    version = integerfield()\n\n    class meta:\n        database = db  # this model uses the "people.db" database.\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n\n\næ°æ®è¡¨å¦ä¸ï¼\n\nid   name      count   version\n1    clothes   100     1\n\nå¨æ´æ°æ¡ä»¶ä¸­æ·»å çæ¬çå¤æ­ï¼ç¡®è®¤å¨æ´æ°åºå­æ°éæ¶ï¼æ¯å¦æå¶ä»æå¡æ´æ¹äºè¯¥æ¡è®°å½ï¼å¦ææ²¡æåè¿è¡æ´æ°ãå¹¶ä¸å¨æ´æ°åºå­æ¶ï¼ç»çæ¬å·+1ï¼ä»£è¡¨çè¯¥è®°å½å·²è¢«ä¿®æ¹ã\n\nå¦ææ²¡ææ´æ°æåï¼åä¸ç´éè¯ï¼ç´è³æåä¸ºæ­¢ã\n\ndef main():\n    # ååºçæ°é\n    num = 99\n\n    while true:\n        goods = goods.get(goods.id == 1)\n        time.sleep(random.randint(1, 3))\n        if goods.count < num:\n            print("ååæ°éä¸è¶³")\n            break\n        else:\n            query = goods.update(count=goods.count - num, version=goods.version + 1).where(goods.id == 1,\n                                                                                           goods.version == goods.version)\n            ok = query.execute()\n            if ok:\n                print("æ´æ°æå")\n                break\n            else:\n                print("æ´æ°å¤±è´¥")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nè¿è¡ç»æï¼\n\næ´æ°æå\næ´æ°å¤±è´¥\nååæ°éä¸è¶³\n\n\n1\n2\n3\n\n\nåºå­å©ä¸1ä»¶ï¼çæ¬å·æ´æ°ä¸º2ï¼ç¬¦åæä»¬çé¢æã\n\nid   name      count   version\n1    clothes   1       2\n\nâ ä¼ç¹ï¼\n\n 1. ç®å\n 2. ä¸éè¦é¢å¤çç»ä»¶\n\nç¼ºç¹ï¼\n\nå¹¶åé«æ¶ï¼ä¸æ­çå¯¹æ°æ®åºè¿è¡æ¥è¯¢ï¼ä¸æ ·ä¼å¢å æ°æ®åºçååãæ§è½å·®ã\n\nâ\n\n\n# åºäºmysqlçæ²è§éæºå¶å®ç°\n\næ²è§é,å°±æ¯å¾æ²è§ï¼æ¯æ¬¡å»æ¿æ°æ®çæ¶åé½è®¤ä¸ºå«äººä¼ä¿®æ¹ï¼æä»¥æ¯æ¬¡å¨æ¿æ°æ®çæ¶åé½ä¼ä¸éï¼è¿æ ·å«äººæ³æ¿è¿ä¸ªæ°æ®å°±ä¼blockç´å°å®æ¿å°éãä¼ ç»çå³ç³»åæ°æ®åºéè¾¹å°±ç¨å°äºå¾å¤è¿ç§éæºå¶ï¼æ¯å¦è¡éï¼è¡¨éç­ï¼è¯»éï¼åéç­ï¼é½æ¯å¨åæä½ä¹ååä¸éã\n\nç¼ºç¹ï¼å¹¶åæ§ä¸é«ï¼ä¸å»ºè®®ä½¿ç¨\n\n\n# redisåå¸å¼é\n\n\n# åå¸å¼ééè¦è§£å³çé®é¢\n\n 1. äºæ¥æ§ï¼ä»»ä½æ¶å»åªè½æä¸ä¸ªå®¢æ·æ¥æéï¼ä¸è½åæ¶å¤ä¸ªå®¢æ·è·å\n\n 2. å®å¨æ§ï¼åªæè¢«ææè¯¥éçç¨æ·å é¤ï¼èä¸è½è¢«å¶ä»ç¨æ·å é¤\n\n 3. æ­»éï¼è·åéçå®¢æ·åå ä¸ºæäºåå èå®æºï¼èæªè½éæ¾éï¼å¶ä»å®¢æ·ç«¯æ æ³è·åéï¼éè¦ææºå¶æ¥é¿åè¯¥ç±»é®é¢çåç\n    \n    1. ä»£ç å¼å¸¸ï¼å¯¼è´æ æ³è¿è¡å°release\n    2. ä½ çå½åæå¡å¨ç½ç»é®é¢-èè£\n\n\n# æåºé®é¢\n\næåå»ºä¸ä¸ªrediséçç±»ï¼ä½¿ç¨acquireå éï¼releaseè§£éã\n\nclass lock:\n    def __init__(self, name):\n        self.redis_client = redis.redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n        if not self.redis_client.get(self.name):\n            self.redis_client.set(self.name, 1)\n            return true\n        else:\n            while true:\n                import time\n                time.sleep(1)\n                if self.redis_client.get(self.name):\n                    self.redis_client.set(self.name, 1)\n                    return true\n\n    def release(self):\n        self.redis_client.delete(self.name)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n\n\nå¨å¥å£å¤å éï¼å¨åºå£å¤éæ¾éï¼è¿æ ·åæ¶åªæä¸ä¸ªæå¡è½å¤æ§è¡æ´æ°æä½ã\n\ndef main():\n    # ååºçæ°é\n    num = 99\n    # ååid\n    goods_id = 1\n\n    lock = lock("lock:goods_{}".format(goods_id))\n    lock.acquire()\n    goods = goods.get(goods.id == goods_id)\n    time.sleep(random.randint(1, 3))\n    if goods.count < num:\n        print("ååæ°éä¸è¶³")\n    else:\n        query = goods.update(count=goods.count - num).where(goods.id == 1)\n        ok = query.execute()\n        if ok:\n            print("æ´æ°æå")\n        else:\n            print("æ´æ°å¤±è´¥")\n    lock.release()\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n\n\nè¿è¡ä¹åï¼åç°åºå­çæ°éæ¯-98ï¼æ²¡æè¾¾å°é¢æçææã\n\nid   name      count\n1    clothes   -98\n\næéè¿ææ¥å¿çæ¹å¼ï¼å¨redis_client.getä¹ååreleaseä¸­ææ¥å¿ã\n\nclass lock:\n    def __init__(self, name):\n        self.redis_client = redis.redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n\n        if not self.redis_client.get(self.name):\n            print("acquire\\n")\n            self.redis_client.set(self.name, 1)\n            return true\n        else:\n            while true:\n                import time\n                time.sleep(1)\n                if self.redis_client.get(self.name):\n                    self.redis_client.set(self.name, 1)\n                    return true\n\n    def release(self):\n        print("release")\n        self.redis_client.delete(self.name)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n\n\nè¿è¡ç»æå¦ä¸ï¼\n\nacquireacquire\n\næ´æ°æå\nrelease\næ´æ°æå\nrelease\n\n\n1\n2\n3\n4\n5\n6\n\n\nå¨æ²¡æéæ¾éçæ¶åï¼ä¸¤ä¸ªçº¿ç¨ç«ç¶é½æ¿å°éäºï¼\n\nå ä¸ºï¼çº¿ç¨t1å¨æ§è¡redis_client.get(self.name)ä¹åè¿æ²¡æredis_client.set(self.name, 1)æ¶ï¼çº¿ç¨t2ä¹è¿æ¥å°è¿ä¸æ­¥äºï¼ä¹å°±æ¯ä¸¤ä¸ªçº¿ç¨åæ¶å¨self.redis_client.get(self.name)åself.redis_client.set(self.name, 1)ä¹é´ã\n\næä»¬éè¦ä¿è¯getåsetæ¯åå­æ§çï¼æè½è§£å³è¯¥é®é¢ã\n\n\n# redisä¸­åå­æä½setnx\n\nredisä¸­èªå¸¦äºä¸ä¸ªåå­æ§æä½setnxï¼å¯ä»¥è¿è¡æ¥è¯¢å¹¶æ´æ°ã\n\nclass lock:\n    def __init__(self, name):\n        self.redis_client = redis.redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n#       # å¦æä¸å­å¨ï¼è®¾ç½®å¼ä¸º1ï¼è¿å1. å¦åè¿å0. åå­æä½ã\n        if self.redis_client.setnx(self.name, 1):\n            return true\n        else:\n            while true:\n                import time\n                time.sleep(1)\n                if self.redis_client.setnx(self.name, 1):\n                    return true\n\n    def release(self):\n        self.redis_client.delete(self.name)\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n\n\nè¿è¡åï¼åºå­æ°éä¸º1ï¼ç¬¦åæä»¬çé¢æã\n\nid   name      count\n1    clothes   1\n\n\n# æ­»éé®é¢\n\nè·åéçå®¢æ·åå ä¸ºæäºåå èå®æºï¼èæªè½éæ¾éï¼å¶ä»å®¢æ·ç«¯æ æ³è·åéï¼éè¦ææºå¶æ¥é¿åè¯¥ç±»é®é¢çåç\n\n 1. ä»£ç å¼å¸¸ï¼å¯¼è´æ æ³è¿è¡å°release\n 2. æ­ç¹\n\nâ è§£å³æ¹æ¡ï¼\n\néè¿è®¾ç½®è¿ææ¶é´æ¥è§£å³ï¼æ¯æ¬¡å¨æ¿éæ¶ï¼ç»redisä¸­å¯¹åºçkeyè®¾ç½®ä¸ä¸ªè¿ææ¶é´ï¼å³ä½¿åºç°ä¸é¢çé®é¢ï¼keyä¹è½èªå¨è¢«å é¤ï¼è§£å³æ­»éé®é¢ã\n\nclass lock:\n    def __init__(self, name):\n        self.redis_client = redis.redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n        if self.redis_client.set(self.name, 1, nx=true, ex=15):\n            return true\n        else:\n            while true:\n                import time\n                time.sleep(1)\n                if self.redis_client.set(self.name, 1, nx=true, ex=15):\n                    return true\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n\n\nä½æ¯ä¼ææ°é®é¢ï¼\n\n * å½åçº¿ç¨å¦æå¨ä¸æ®µæ¶é´åæ²¡ææ§è¡å®ï¼å½åçç¨åºæ²¡ææ§è¡å®ï¼ç¶åkeyè¿æ\n * ä¸å®å¨ï¼å¦ä¸ä¸ªçº¿ç¨è¿æ¥ä»¥åä¼å°å½åçkeyç»å æï¼å¦ä¸ä¸ªçº¿ç¨å æäºæ¬è¯¥å±äºæè®¾ç½®çå¼ã\n\nè§£å³æ¹æ¡ï¼\n\nå¦æå½åçº¿ç¨æ²¡ææ§è¡å®ï¼é£æçè¿ä¸ªçº¿ç¨è¿åºè¯¥å¨éå½çæ¶åå»ç»­ç§ï¼å°è¿ææ¶é´éæ°è®¾ç½®ãä¸è¬æ¯å¨å¿«è¦è¿æç2/3çæ¶åå»ç»­ç§ãå®æ¶ç¨åºå¯ä»¥ä½¿ç¨å¦ä¸ä¸ªçº¿ç¨å»å®æã\n\nclass lock:\n    def __init__(self, name):\n        self.redis_client = redis.redis(host="10.61.74.37")\n        self.name = name\n\n    def acquire(self):\n        if self.redis_client.set(self.name, 1, nx=true, ex=15):\n            # å¯å¨ä¸ä¸ªçº¿ç¨ç¶åå»å®æ¶çå·æ°è¿ä¸ªè¿æï¼è¿ä¸ªæä½æå¥½ä¹æ¯ä½¿ç¨luaèæ¬æ¥å®æã\n            return true\n        else:\n            while true:\n                import time\n                time.sleep(1)\n                if self.redis_client.set(self.name, 1, nx=true, ex=15):\n                    return true\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nâ å¦ä½é²æ­¢æè®¾ç½®çå¼è¢«å¶ä»ççº¿ç¨ç»å é¤æ?\n\nè§£å³æ¹æ³\n\nå¯ä»¥æ¿éçæ¶åçæä¸ä¸ªidï¼å¹¶å°å¶è®¾ç½®redisä¸­é®å¯¹åºçå¼ï¼å¨å é¤çæ¶åï¼å¤æ­ä»redisä¸­æ¿åºçå¼æ¯å¦ä¸ºè¯¥ç¨åºè®¾ç½®çidï¼å¦æä¸æ¯ï¼åå é¤å¤±è´¥ã\n\nclass lock:\n    def __init__(self, name, id=none):\n        self.redis_client = redis.redis(host="10.61.74.37")\n        self.name = name\n        self.id = id if id else str(uuid.uuid4())\n\n    def acquire(self):\n        if self.redis_client.set(self.name, self.id, nx=true, ex=15):\n            # å¯å¨ä¸ä¸ªçº¿ç¨ç¶åå»å®æ¶çå·æ°è¿ä¸ªè¿æï¼è¿ä¸ªæä½æå¥½ä¹æ¯ä½¿ç¨luaèæ¬æ¥å®æã\n            return true\n        else:\n            while true:\n                import time\n                time.sleep(1)\n                if self.redis_client.set(self.name, self.id, nx=true, ex=15):\n                    return true\n\n    def release(self):\n        val = str(self.redis_client.get(self.name), encoding="utf8")\n        if val == self.id:\n            self.redis_client.delete(self.name)\n        else:\n            print("ä¸è½å é¤èªå·±çé")\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n\n\nâ ä½æ¯è¿ä¼ææ°çé®é¢ï¼ä¸é¢çreleaseæ¹æ³ï¼getådelete redisä¸­keyåæäºä¸¤ä¸ªæ­¥éª¤ï¼è¿æ¯æå¯è½å¨ä¸¤èä¹é´ä¸­æ­ï¼æä»¥éè¦ä½¿ç¨redisçluaèæ¬æ¥å®ç°ä¸¤èçåå­æä½\n\n\n# py-redis-lockåredis-py\n\nè¯¥åºæ¯å¼æºçåå¸å¼épyå®ç°åºï¼è§£å³äºä¸é¢çé®é¢ãåé¢æç©ºå¯ä»¥åæä¸è¯¥åºçæºç ã\n\n\n# redisçåå¸å¼éä¼ç¼ºç¹\n\nä¼ç¹\n\n * æ§è½é«\n * ç®å\n * redisæ¬èº«ä½¿ç¨å¾é¢ç¹ï¼ä¸éè¦é¢å¤ç»´æ¤\n\nç¼ºç¹\n\n * ä¾èµäºç¬¬ä¸æ¹ç»ä»¶\n\n * åæºçredisææçå¯è½æ§ç¸å¯¹è¾é«ï¼éè¦å¼å¥å¨åµæºå¶\n\n * redisçclusterçå¼å¥ä¼å¯¼è´åæçredisçéä¼æé®é¢ - redlock\n\nâ\n\nâ',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"countçæ§è½ä¼å",frontmatter:{title:"countçæ§è½ä¼å",date:"2022-08-10T00:00:00.000Z",permalink:"/pages/19cfb6/",tags:["æ§è½é®é¢","sql","clickhouse"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"éå°çsqlæ¥è¯¢è¯­å¥ä¸­åç°çcountæ§è½ä¼åçé®é¢",feed:{enable:!0},categories:["ç¼ç¨","å¶ä»"],comment:!0,meta:[{name:"twitter:title",content:"countçæ§è½ä¼å"},{name:"twitter:description",content:"éå°çsqlæ¥è¯¢è¯­å¥ä¸­åç°çcountæ§è½ä¼åçé®é¢"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/20.count%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html"},{property:"og:type",content:"article"},{property:"og:title",content:"countçæ§è½ä¼å"},{property:"og:description",content:"éå°çsqlæ¥è¯¢è¯­å¥ä¸­åç°çcountæ§è½ä¼åçé®é¢"},{property:"og:url",content:"https://www.zhengwenfeng.com/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/20.count%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-08-10T00:00:00.000Z"},{property:"article:tag",content:"æ§è½é®é¢"},{property:"article:tag",content:"sql"},{property:"article:tag",content:"clickhouse"},{itemprop:"name",content:"countçæ§è½ä¼å"},{itemprop:"description",content:"éå°çsqlæ¥è¯¢è¯­å¥ä¸­åç°çcountæ§è½ä¼åçé®é¢"}],readingShow:"top"},regularPath:"/04.%E7%BC%96%E7%A8%8B/09.%E5%85%B6%E4%BB%96/20.count%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html",relativePath:"04.ç¼ç¨/09.å¶ä»/20.countçæ§è½ä¼å.md",key:"v-48a6492a",path:"/pages/19cfb6/",headers:[{level:2,title:"é®é¢",slug:"é®é¢",normalizedTitle:"é®é¢",charIndex:2},{level:2,title:"å®ä½é®é¢",slug:"å®ä½é®é¢",normalizedTitle:"å®ä½é®é¢",charIndex:77},{level:2,title:"æ¥è¯¢åæ",slug:"æ¥è¯¢åæ",normalizedTitle:"æ¥è¯¢åæ",charIndex:227}],headersStr:"é®é¢ å®ä½é®é¢ æ¥è¯¢åæ",content:"# é®é¢\n\nä»å¤©æµè¯ç»ææäºBUGï¼åç°æä¸ªæ¥è¯¢æ¥å£è¶æ¶äºï¼è¶æ¶æ¶é´ä¸º1åéã\n\nç®åçç¨çæ°æ®åºæ¯clickhouseï¼æ°æ®éå¤§æ¦å¨20äº¿å·¦å³\n\n\n# å®ä½é®é¢\n\næéè¿è°è¯å°æ¥è¯¢æ°æ®çè¯­å¥æå°åºæ¥ï¼æ¥è¯¢è¯­å¥æ¾å¨æ°æ®åºä¸­æ§è¡ï¼åç°å ç§å°±æ¥è¯¢å®æäºï¼è¿ä¸ªæ¶åæå°±å¥äºæªäºï¼åé¢æåä»ç»çæ¥å£çä»£ç ï¼è·è¸ªè°è¯ååç°ï¼é¤äºä¼æ¥è¯¢æ°æ®ä¹å¤ï¼è¿ä¼æ§è¡æ¥è¯¢æ°æ®éçè¯­å¥ã\n\næå°æ¥è¯¢æ°éçè¯­å¥æå°åºæ¥ï¼æ§è¡è¯¥è¯­å¥ï¼åç°æ¯è¶è¿1åéçï¼çæ¥æ¯å®ä½å°é®é¢äºã\n\n\n# æ¥è¯¢åæ\n\nè¯­å¥å¤§æ¦æ¯ä¸é¢è¿æ ·çï¼å¤§æ¦æ30å¤å¼ è¡¨ï¼ä¹å°±æ¯éè¦union30å¤å¼ è¡¨\n\nselect\n    count(*)\nfrom\n    (\n        select\n            a_field,\n            b_field,\n            c_field,\n            d_field,\n            e_field,\n            f_field\n        from\n            A\n        union\n        all\n        select\n            a_field,\n            b_field,\n            c_field,\n            d_field,\n            e_field,\n            f_field\n        from\n            B\n    )\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\nè¿æ¡è¯­å¥æ¯éè¿å°å¤ä¸ªè¡¨unionæä¸ä¸ªå¤§è¡¨ï¼ç¶ååcountæ±æ°éã\n\né®é¢æ¾èæè§ï¼ä¸ºå¥æä»¬è¦æé ä¸å¼ è¿ä¹å¤§çè¡¨å¨åå­ä¸­åcountæ°éï¼ç´æ¥countæ¯å¼ è¡¨çæ°éåç¸å ä¸å°±æ¯äºãä¼åè¯­å¥å¦ä¸ï¼\n\nselect\n    count(cnt)\nfrom\n    (\n        select\n            count() as cnt\n        from\n            A\n        union\n        all\n        select\n            count() as cnt\n        from\n            B\n    )\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå°è¯¥è¯­å¥æ¾å¨æ°æ®åºæ¥è¯¢ï¼ç§çº§è¿åï¼ç´æ¥ä»1åéä¼åå°1ç§é",normalizedContent:"# é®é¢\n\nä»å¤©æµè¯ç»ææäºbugï¼åç°æä¸ªæ¥è¯¢æ¥å£è¶æ¶äºï¼è¶æ¶æ¶é´ä¸º1åéã\n\nç®åçç¨çæ°æ®åºæ¯clickhouseï¼æ°æ®éå¤§æ¦å¨20äº¿å·¦å³\n\n\n# å®ä½é®é¢\n\næéè¿è°è¯å°æ¥è¯¢æ°æ®çè¯­å¥æå°åºæ¥ï¼æ¥è¯¢è¯­å¥æ¾å¨æ°æ®åºä¸­æ§è¡ï¼åç°å ç§å°±æ¥è¯¢å®æäºï¼è¿ä¸ªæ¶åæå°±å¥äºæªäºï¼åé¢æåä»ç»çæ¥å£çä»£ç ï¼è·è¸ªè°è¯ååç°ï¼é¤äºä¼æ¥è¯¢æ°æ®ä¹å¤ï¼è¿ä¼æ§è¡æ¥è¯¢æ°æ®éçè¯­å¥ã\n\næå°æ¥è¯¢æ°éçè¯­å¥æå°åºæ¥ï¼æ§è¡è¯¥è¯­å¥ï¼åç°æ¯è¶è¿1åéçï¼çæ¥æ¯å®ä½å°é®é¢äºã\n\n\n# æ¥è¯¢åæ\n\nè¯­å¥å¤§æ¦æ¯ä¸é¢è¿æ ·çï¼å¤§æ¦æ30å¤å¼ è¡¨ï¼ä¹å°±æ¯éè¦union30å¤å¼ è¡¨\n\nselect\n    count(*)\nfrom\n    (\n        select\n            a_field,\n            b_field,\n            c_field,\n            d_field,\n            e_field,\n            f_field\n        from\n            a\n        union\n        all\n        select\n            a_field,\n            b_field,\n            c_field,\n            d_field,\n            e_field,\n            f_field\n        from\n            b\n    )\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n\n\nè¿æ¡è¯­å¥æ¯éè¿å°å¤ä¸ªè¡¨unionæä¸ä¸ªå¤§è¡¨ï¼ç¶ååcountæ±æ°éã\n\né®é¢æ¾èæè§ï¼ä¸ºå¥æä»¬è¦æé ä¸å¼ è¿ä¹å¤§çè¡¨å¨åå­ä¸­åcountæ°éï¼ç´æ¥countæ¯å¼ è¡¨çæ°éåç¸å ä¸å°±æ¯äºãä¼åè¯­å¥å¦ä¸ï¼\n\nselect\n    count(cnt)\nfrom\n    (\n        select\n            count() as cnt\n        from\n            a\n        union\n        all\n        select\n            count() as cnt\n        from\n            b\n    )\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n\n\nå°è¯¥è¯­å¥æ¾å¨æ°æ®åºæ¥è¯¢ï¼ç§çº§è¿åï¼ç´æ¥ä»1åéä¼åå°1ç§é",charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"è¯»ä¹¦ç¬è®°:å¦ä½éè¯»ä¸æ¬ä¹¦",frontmatter:{title:"è¯»ä¹¦ç¬è®°:å¦ä½éè¯»ä¸æ¬ä¹¦",date:"2022-10-21T20:52:34.000Z",permalink:"/pages/8bdb8d/",categories:["è¯»ä¹¦ç ´ä¸å·"],tags:["è¯»ä¹¦"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"æ¬ææ¯æéè¯»å®ãå¦ä½éè¯»ä¸æ¬ä¹¦ãçè¯»åæï¼ä½èä¸»è¦æ¯å°éè¯»åä¸ºäºåä¸ªå±æ¬¡ï¼åºç¡éè¯»ãæ£è§éè¯»ãåæéè¯»åä¸»é¢éè¯»ï¼å¹¶è®²è§£è¿å ä¸ªå±æ¬¡è¯¥å¦ä½å»åï¼è½å¤æ´å¥½çå¸®å©æä»¬éè¯»ï¼è®©æä»¬ä»ä¸­æ¶è·å°æ´å¤",feed:{enable:!0},comment:!0,meta:[{name:"twitter:title",content:"è¯»ä¹¦ç¬è®°:å¦ä½éè¯»ä¸æ¬ä¹¦"},{name:"twitter:description",content:"æ¬ææ¯æéè¯»å®ãå¦ä½éè¯»ä¸æ¬ä¹¦ãçè¯»åæï¼ä½èä¸»è¦æ¯å°éè¯»åä¸ºäºåä¸ªå±æ¬¡ï¼åºç¡éè¯»ãæ£è§éè¯»ãåæéè¯»åä¸»é¢éè¯»ï¼å¹¶è®²è§£è¿å ä¸ªå±æ¬¡è¯¥å¦ä½å»åï¼è½å¤æ´å¥½çå¸®å©æä»¬éè¯»ï¼è®©æä»¬ä»ä¸­æ¶è·å°æ´å¤"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/05.%E8%AF%BB%E4%B9%A6%E7%A0%B4%E4%B8%87%E5%8D%B7/01.%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E4%B8%80%E6%9C%AC%E4%B9%A6.html"},{property:"og:type",content:"article"},{property:"og:title",content:"è¯»ä¹¦ç¬è®°:å¦ä½éè¯»ä¸æ¬ä¹¦"},{property:"og:description",content:"æ¬ææ¯æéè¯»å®ãå¦ä½éè¯»ä¸æ¬ä¹¦ãçè¯»åæï¼ä½èä¸»è¦æ¯å°éè¯»åä¸ºäºåä¸ªå±æ¬¡ï¼åºç¡éè¯»ãæ£è§éè¯»ãåæéè¯»åä¸»é¢éè¯»ï¼å¹¶è®²è§£è¿å ä¸ªå±æ¬¡è¯¥å¦ä½å»åï¼è½å¤æ´å¥½çå¸®å©æä»¬éè¯»ï¼è®©æä»¬ä»ä¸­æ¶è·å°æ´å¤"},{property:"og:url",content:"https://www.zhengwenfeng.com/05.%E8%AF%BB%E4%B9%A6%E7%A0%B4%E4%B8%87%E5%8D%B7/01.%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E4%B8%80%E6%9C%AC%E4%B9%A6.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-10-21T20:52:34.000Z"},{property:"article:tag",content:"è¯»ä¹¦"},{itemprop:"name",content:"è¯»ä¹¦ç¬è®°:å¦ä½éè¯»ä¸æ¬ä¹¦"},{itemprop:"description",content:"æ¬ææ¯æéè¯»å®ãå¦ä½éè¯»ä¸æ¬ä¹¦ãçè¯»åæï¼ä½èä¸»è¦æ¯å°éè¯»åä¸ºäºåä¸ªå±æ¬¡ï¼åºç¡éè¯»ãæ£è§éè¯»ãåæéè¯»åä¸»é¢éè¯»ï¼å¹¶è®²è§£è¿å ä¸ªå±æ¬¡è¯¥å¦ä½å»åï¼è½å¤æ´å¥½çå¸®å©æä»¬éè¯»ï¼è®©æä»¬ä»ä¸­æ¶è·å°æ´å¤"}],readingShow:"top"},regularPath:"/05.%E8%AF%BB%E4%B9%A6%E7%A0%B4%E4%B8%87%E5%8D%B7/01.%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BB%E4%B8%80%E6%9C%AC%E4%B9%A6.html",relativePath:"05.è¯»ä¹¦ç ´ä¸å·/01.å¦ä½éè¯»ä¸æ¬ä¹¦.md",key:"v-38488cef",path:"/pages/8bdb8d/",headers:[{level:2,title:"åè¨",slug:"åè¨",normalizedTitle:"åè¨",charIndex:2},{level:2,title:"ä¸»å¨éè¯»",slug:"ä¸»å¨éè¯»",normalizedTitle:"ä¸»å¨éè¯»",charIndex:104},{level:2,title:"éè¯»çç®æ  ï¼ä¸ºè·å¾èµè®¯èè¯»ï¼ä»¥åä¸ºæ±å¾çè§£èè¯»",slug:"éè¯»çç®æ -ä¸ºè·å¾èµè®¯èè¯»-ä»¥åä¸ºæ±å¾çè§£èè¯»",normalizedTitle:"éè¯»çç®æ  ï¼ä¸ºè·å¾èµè®¯èè¯»ï¼ä»¥åä¸ºæ±å¾çè§£èè¯»",charIndex:603},{level:2,title:"çæ­£çéè¯»",slug:"çæ­£çéè¯»",normalizedTitle:"çæ­£çéè¯»",charIndex:705},{level:2,title:"æå¯¼åçå­¦ä¹ ï¼ä»¥åèªæåç°åçå­¦ä¹ ",slug:"æå¯¼åçå­¦ä¹ -ä»¥åèªæåç°åçå­¦ä¹ ",normalizedTitle:"æå¯¼åçå­¦ä¹ ï¼ä»¥åèªæåç°åçå­¦ä¹ ",charIndex:750},{level:2,title:"éè¯»æ¯è·çå·²ä¸ºç¼ºå¸­çæ¥å¿å¨å­¦ä¹ ",slug:"éè¯»æ¯è·çå·²ä¸ºç¼ºå¸­çæ¥å¿å¨å­¦ä¹ ",normalizedTitle:"éè¯»æ¯è·çå·²ä¸ºç¼ºå¸­çæ¥å¿å¨å­¦ä¹ ",charIndex:883},{level:2,title:"åä¸ªå±æ¬¡",slug:"åä¸ªå±æ¬¡",normalizedTitle:"åä¸ªå±æ¬¡",charIndex:38},{level:2,title:"ç¥è¯»",slug:"ç¥è¯»",normalizedTitle:"ç¥è¯»",charIndex:1149},{level:2,title:"éè¯»éåº¦",slug:"éè¯»éåº¦",normalizedTitle:"éè¯»éåº¦",charIndex:1404},{level:2,title:"å¹å»éè¯»çä¹ æ¯",slug:"å¹å»éè¯»çä¹ æ¯",normalizedTitle:"å¹å»éè¯»çä¹ æ¯",charIndex:1551},{level:2,title:"åæéè¯»çè§å",slug:"åæéè¯»çè§å",normalizedTitle:"åæéè¯»çè§å",charIndex:1977},{level:2,title:"è¾å©éè¯»",slug:"è¾å©éè¯»",normalizedTitle:"è¾å©éè¯»",charIndex:3312},{level:2,title:"éè¯»å¥½ä¹¦çéè¦æ§",slug:"éè¯»å¥½ä¹¦çéè¦æ§",normalizedTitle:"éè¯»å¥½ä¹¦çéè¦æ§",charIndex:3689}],headersStr:"åè¨ ä¸»å¨éè¯» éè¯»çç®æ  ï¼ä¸ºè·å¾èµè®¯èè¯»ï¼ä»¥åä¸ºæ±å¾çè§£èè¯» çæ­£çéè¯» æå¯¼åçå­¦ä¹ ï¼ä»¥åèªæåç°åçå­¦ä¹  éè¯»æ¯è·çå·²ä¸ºç¼ºå¸­çæ¥å¿å¨å­¦ä¹  åä¸ªå±æ¬¡ ç¥è¯» éè¯»éåº¦ å¹å»éè¯»çä¹ æ¯ åæéè¯»çè§å è¾å©éè¯» éè¯»å¥½ä¹¦çéè¦æ§",content:'# åè¨\n\næ¬ææ¯æéè¯»å®ãå¦ä½éè¯»ä¸æ¬ä¹¦ãçè¯»åæï¼ä½èä¸»è¦æ¯å°éè¯»åä¸ºäºåä¸ªå±æ¬¡ï¼åºç¡éè¯»ãæ£è§éè¯»ãåæéè¯»åä¸»é¢éè¯»ï¼å¹¶è®²è§£è¿å ä¸ªå±æ¬¡è¯¥å¦ä½å»åï¼è½å¤æ´å¥½çå¸®å©æä»¬éè¯»ï¼è®©æä»¬ä»ä¸­æ¶è·å°æ´å¤\n\n\n# ä¸»å¨éè¯»\n\nä½èæå¡æä»¬éè¦ä¸»å¨è¯»ä¹¦ï¼è¿æ ·æä»¬æè½å¯¹ä¹¦ä¸­ç¥è¯ææ´å¥½çæ¢ç´¢å¹¶æ¶è·å°çä¼æ´å¤ã\n\nåå¨æä»¬éè¯»èµè®¯ä¿¡æ¯çæ¶åï¼ä¸ä»ä»åªéè¦ç¥éäºæä»¶äºçåçï¼è¿éè¦çè§£å®åççèåé»è¾ååçè¿è¡èæ³ï¼å°èªå·±ä»¥åçç¥è¯è¿è¡å³èèµ·æ¥ãè¿å°±æ¯ä¸»å¨çéè¯»ã\n\nå¹¶ä¸æä»¬åä¸»å¨éè¯»æ¶ä¼ä¿æå¤§èçæèå¹¶ä¿ææ¸éçç¶æï¼é£ä¹å¹³æ¶æææ¬²ç¡çäººé½åªæ¯å¨è¢«å¨çæ¥æ¶ç¥è¯ï¼æä»¥æ³¨æåææ æ³éä¸­èµ·æ¥ã\n\né®é¢æ¥äºï¼æä»¬è¯¥å¦ä½åå°ä¸»å¨éè¯»å¢ï¼ç­æ¡æ¯å¸¦çé®é¢å»éè¯»ï¼\n\n * è¿æ¬ä¹¦å¨è®²ä»ä¹ï¼\n * ä½èä»ç»è¯´äºä»ä¹ï¼å¦ä½è¯´çï¼æ¾åºå¯¹åºçæ³æ³ãå£°æåè®ºç¹\n * è¿æ¬ä¹¦æéçåï¼æ¯å¨é¨æéçï¼è¿æ¯é¨åæéçï¼\n * è¿æ¬ä¹¦è·èªå·±æä»ä¹å³ç³»ï¼èªå·±å¯ä»¥å­¦å°ä»ä¹ï¼å¯¹èªå·±æä»ä¹å¯ç¤ºï¼\n\nå¨éè¯»çè¿ç¨ä¸­æåºé¤äºä¸é¢å ä¸ªåºç¡çé®é¢ä¹å¤ï¼è¿éè¦èªå·±å»æåºé®é¢ï¼å¹¶ä¸æ­çå»ä»ä¹¦å¯»æ¾å¹¶åç­é®é¢ãåªæè¿æ ·ç»è¿æèæè½åå°ä¸»å¨éè¯»ã\n\nä½èè¿æå°äºåç¬è®°çå¿è¦æ§ï¼è¿ä¹æ¯ä¸»å¨éè¯»çä¸ä¸ªæ¹å¼ï¼\n\n * è½è®©èªå·±çä¿ææ¸é\n * æ¯ä¸ä¸ªä¸»å¨æèçè¿ç¨å¹¶ç¨è¨è¯­ç»è¡¨è¾¾åºæ¥ã\n * å°èªå·±çææ³ååºæ¥ï¼è®©èªå·±æ´å¥½ççè§£ä½èçææ³ï¼å¹¶å±å¼èªå·±çèæ³ã\n\n\n# éè¯»çç®æ  ï¼ä¸ºè·å¾èµè®¯èè¯»ï¼ä»¥åä¸ºæ±å¾çè§£èè¯»\n\næä»¬æ¯ä¸ºäºè·åå°ä½èè¾åºçç¥è¯èè¯»ä¹¦ï¼èä¸æ¯ä¸ºäºè¯»ä¹¦èè¯»ä¹¦ï¼å¦æè¯»å®è¿æ¬ä¹¦ï¼æ²¡æçè§£å°ä½èæ³è¦è¡¨è¾¾çä¸è¥¿ï¼èªèº«æ²¡ææ¹åï¼é£ä¹åçº¯ç²¹çæµªè´¹æ¶é´ã\n\n\n# çæ­£çéè¯»\n\nä¸åå©å¤åï¼éè¿èªå·±ä¸æ­çæèå»éè¯»ï¼ä»æ¨¡ç³ççè§£å°æ´æ¸æ¥ççè§£ã\n\n\n# æå¯¼åçå­¦ä¹ ï¼ä»¥åèªæåç°åçå­¦ä¹ \n\næ è®ºæ¯æå¯¼åå­¦ä¹ è¿æ¯èªæåç°åå­¦ä¹ é½å¯ä»¥æ¯ä¸»å¨çï¼ä¸è®ºæ¯åªä¸ç§ æ¹å¼ï¼åªæçæ­£å­¦ä¹ å°çäººææ¯ä¸»å¨çå­¦ä¹ èã\n\nå¨æå¯¼åçå­¦ä¹ è¿ç¨ä¸­ï¼è½ç¶æä»¬æ¯è¢«å¨çæ¥æ¶ç¥è¯ï¼çèµ·æ¥æ¯«ä¸è´¹åï¼ä½æ¯ä¸æ ·è¿æ¯éè¦ç»è¿èªå·±çæèæè½ææè·å¾ã\n\n\n# éè¯»æ¯è·çå·²ä¸ºç¼ºå¸­çæ¥å¿å¨å­¦ä¹ \n\næèå¸æ¶ï¼å¯ä»¥åç­ä½ çé®é¢ï¼èçèªå·±æèçæ¶é´ï¼èéè¯»ä¹¦æ¬æ¶ï¼å¿é¡»ç»è¿èªå·±çæèä¸åææå¯è½æç­æ¡ã\n\n\n# åä¸ªå±æ¬¡\n\nä½èå°éè¯»åä¸ºåä¸ªå±æ¬¡ï¼\n\n * åºç¡éè¯»ï¼å°±æ¯æåºç¡çéè¯»ï¼è½è®¤å­å°±è¡ï¼ç»åäºä¹å¹´ä¹å¡æè²åºæ¬å°±è½åå°ã\n * æ£è§éè¯»ï¼å°±æ¯å¨ä¸å®çæ¶é´ä¹åï¼æä½ä¸æ¬ä¹¦çéç¹ã\n * åæéè¯»ï¼æ¯å¨ççéè¯»ãå®æ´çéè¯»ã\n * ä¸»é¢éè¯»ï¼éè¯»èéè¿è¯»å¾å¤çä¹¦ï¼ç¶ååä¸¾è¿äºä¹¦ä¹é´çç¸å³ä¹å¤ãè¿ç§æ¹å¼æ¯æä¸»å¨ãä¹æ¯æè±åæ°çéè¯»ã\n\nä½èæ´æ¬ä¹¦ä¸»è¦æ¯å´ç»è¿åä¸ªå±æ¬¡è¿è¡è®²è§£åæçã\n\n\n# ç¥è¯»\n\n> ä½ èä¸­çç®æ æ¯è¦åç°è¿æ¬ä¹¦å¼ä¸å¼å¾å¤è±æ¶é´ä»ç»éè¯»ãå¶æ¬¡ï¼å°±ç®ä½ å³å®äºä¸åå¤è±æ¶é´ä»ç»éè¯»è¿æ¬ä¹¦ï¼ç¥è¯»ä¹è½åè¯ä½ è®¸å¤è·è¿æ¬ä¹¦æå³çäºã\n\nè¿æ¯ç¥è¯»çç®æ ï¼æä»¬éè¿ç¥è¯»å¯ä»¥èçæ¶é´ï¼æé¤ä¸äºåå¾ä¹¦ã\n\né£ä¹æä»¬æ¹å¦ä½è¿è¡ç¥è¯»å¢ï¼æä»¥ä¸å ä¸ªæ¹æ³ï¼\n\n * åçä¹¦åé¡µï¼ç¶åå¦ææåºå°±åçåºã\n * ç ç©¶ç®å½é¡µã\n * å¦æä¹¦ä¸­éæç´¢å¼ï¼ä¹è¦æ£éä¸ä¸ã\n * å¦æé£æ¯æ¬åçä¹¦è¡£çæ°ä¹¦ï¼ä¸å¦¨è¯»ä¸ä¸åºçèçä»ç»ã\n * ä»ç®å½é¡µä¸­æéå ä¸ªè·ä¸»é¢ç¸å³çç¯ç« æ¥çã\n * å°å¨æ°ç¿»ä¸éï¼éæçä¸ªå æ®µã\n\n\n# éè¯»éåº¦\n\næä»¬å¨æ£è§éè¯»æ¶ï¼æ¯éè¦å¿«éå°éè¯»çï¼å¨ä¸å¼å¾æä»¬è±æ¶é´çå°æ¹è¯»å¿«ä¸ç¹ï¼è¿ä¸ªæ¶åæä»¬æ¶åéè¦ç¥éæä»¬å¨éè¯»ä¸­å¯»æ¾ä»ä¹ï¼è¿æ ·æä»¬æè½å¯¹ä¸åçåå®¹ä½¿ç¨ä¸åçéåº¦æ¥è¿è¡éè¯»ã\n\nå¦ä½æåéè¯»éåº¦ï¼å°æææåæå­å¾åç§»å¨ä¸å»ï¼ç¼çè·çææçä¸å»ï¼å¼ºè¿«èªå·±çç¼çè·çæé¨çå¨ä½ç§»å¨ã\n\n\n# å¹å»éè¯»çä¹ æ¯\n\n> æä»¬è°å°ä¸ä¸ªæææ¯çäººæ¶ï¼å¹¶ä¸æ¯å¨è¯´ä»ç¥éè¯¥å¦ä½å»åé£ä»¶äºï¼èæ¯ä»å·²ç»å»æå»åé£ä»¶äºçä¹ æ¯äºã\n\nå½æä»¬å»æä¹ æ¯åï¼æå°±è½å¤èªç¶çæç§è§åå»åé£ä»¶äºæï¼æææ¯çäººä¹æ¯éè¿ä¸æ­çè®­ç»å°è§åå»æäºä¹ æ¯ã\n\næä»¬å°éè¯»å¹å»æä¹ æ¯åï¼å¯ä»¥æé«éè¯»çè½åä¸éåº¦ï¼æåä¼åèµ°è·¯ä¸åé¥­ä¸æ ·çèªç¶ã\n\n> ä½ ä¸å®è¦å­¦ä¼å¿æé£äºåå¼çæ­¥éª¤ï¼æè½è¡¨ç°åºæ´ä½çå¨ä½ï¼èæ¯ä¸ä¸ªåä¸çæ­¥éª¤é½è¿è¦ç¡®å®è¡¨ç°å¾å¾å¥½ãä½æ¯ï¼ä¸ºäºè¦å¿æè¿äºåä¸çå¨ä½ï¼ä¸å¼å§ä½ å¿é¡»ååå«å­¦ä¼æ¯ä¸ä¸ªåä¸çå¨ä½ãåªæè¿æ ·ï¼ä½ æè½å°ææçå¨ä½è¿ç»èµ·æ¥ï¼åæä¸ä¸ªä¼ç§çæ»éªé«æã\n\néè¯»æ¯éè¦å¤ä¸ªæ­¥éª¤ç»åèµ·æ¥çï¼æä»¬éè¦ä¸æ­çç»ä¹ é»ç¼åä¸ªæ­¥éª¤ï¼å°è¿äºæ­¥éª¤åæä¹ æ¯åéæ¸å¿è®°ï¼ç¶åèªç¶çå°ææçè¿æ¥èµ·æ¥ï¼æç»æä¸ºä¸ä¸ªéè¯»é«æãè¿è®©ææ³å°äºåå¤©å± é¾è®°ä¸­çå¼ ä¸ä¸°æå¼ æ å¿å¤ªææ¶çåºæ¯ï¼åæ¯æå¼ æ å¿æ¯ä¸ä¸ªå¨ä½ï¼çç»ä¹åéæ¸å¿è®°ï¼æç»å°å¤ªæèä¼è´¯éï¼å½æ¶ä¸å¤ªæï¼ç°å¨åç°è¿éæå¼æ²åå·¥ä¹å¦ã\n\n\n# åæéè¯»çè§å\n\n> ä¾ç§ä¹¦æ¬çç§ç±»ä¸ä¸»é¢ä½åç±»ã\n\nä¸åç§ç±»çä¹¦ç±çç®çæ¯ä¸åçï¼æ¯å¦çè®ºæ§çä½åæ¯æä½ è¿æ¯ä»ä¹ï¼èå®ç¨æ§çä½ç¨å¨æä½ å¦ä½å»åä½ æ³åçäºæã\n\nå°ä¹¦ç±çåç±»å¹¶ä¸ç®åï¼æä»¬å¯ä»¥éè¿ä¹¦åãåè¨åä¹¦ä¸­ä¸»é¢åå®¹æ¥åºåã\n\nä¸åç§ç±»çä¹¦ç±ä¹éè¦ä½¿ç¨çæ¯ä¸åçæ¹æ³éè¯»ã\n\n> ç¨æç®ç­çå¥å­è¯´åºæ´æ¬ä¹¦å¨è°äºä»ä¹ã\n\nå¦ææä»¬ç¥éäºè¿æ¬ä¹¦å¨è°ä»ä¹ï¼æä»¬å°±è½æ£æµåºä½èæ³è¦å¹²ä»ä¹ï¼å¹¶è½åç°è¿æ¬ä¹¦çä¸»é¢åéç¹ã\n\néè¿ç»èªå·±æä»äººè®²è¿°è¿æ¬ä¹¦è¯´çä»ä¹ï¼å¯ä»¥éªè¯èªå·±æ¯å¦å¯¹æ¬ä¹¦æ´ä½åå®¹æä¸ä¸ªè¯¦ç»çäºè§£ã\n\n> æç§é¡ºåºä¸å³ç³»ï¼ååºå¨ä¹¦çéè¦é¨åãå°å¨ä¹¦ççº²è¦æåºæ¥ä¹åï¼åå°åä¸ªé¨åççº²è¦ä¹ä¸ä¸ååºã\n\nå¿ä¸­è¦å¯¹ä¹¦ä¸­çæ´ä½æ¶ææä¸ä¸ªäºè§£ï¼æè½ä»å¤ä¸ªæ¹é¢å»çå¾è¿æ¬ä¹¦ã\n\n> æ¾åºä½èå¨é®çé®é¢ï¼æä½èæ³è¦è§£å³çé®é¢ã\n\nä½èåä¹¦æ¶ï¼è¯å®æ¯å¸¦çé®é¢æèæ³è¦è§£å³ä¸ä¸ªé®é¢å»åçãæ¾åºè¿äºé®é¢è½å¤æ´å¥½çä¸ºä¸é¢ä¸¤æ¡æå¡ã\n\n> è¯ éä½èä½¿ç¨çå³é®å­ï¼ä¸ä½èè¾¾æå±è¯ã\n\nç¸åçåå­ä¼åç°åºä¸åçæä¹ï¼æ¯å¦æä»¬å¨è°"éè¯»"æ¶ï¼å¯è½æ¯ä¸ºå¨±ä¹èéè¯»ï¼å¯è½æ¯ä¸ºè·å¾å¨è¯¢èéè¯»ï¼ä¹å¯è½æ¯ä¸ºè¿½æ±çè§£åèéè¯»ãæä»¬éè¦åä½èä¿æä¸è´çè§£ï¼æè½æå±åçææ³ãå¦ææä»¬å¯¹å­å¥æ¯«ä¸ç¨å¿ï¼èªç¶æ æ³è·ä½èè¾¾æå±è¯ï¼ä¹å°±ä¸æ æè·ã\n\næä»¬å¯ä»¥éè¿ä¸ä¸æä¸­å·²ç»çè§£çè¯­å¥å¨å¸®å©èªå·±æ¥æ¨æ²åºæä»¬ä¸çè§£çé£ä¸ªå­çææã\n\n> ä»æéè¦çå¥å­ä¸­æåºä½èçéè¦ä¸»æ¨ã\n\næ¾åºè¯­å¥çä¸»æ¨åï¼éè¦ä½¿ç¨èªå·±çè¯è¯­æ¥è¯´æ¥éªè¯èªå·±å°åºææ²¡æçè§£éå½»ãä¹å¯ä»¥éè¿å°æä¸ªä¾å­æèäºææ¥è¯´æä¸»æ¨æ¥éªè¯ã\n\n> æ¾åºä½èçè®ºè¿°ï¼éæ°æ¶æè¿äºè®ºè¿°çåå åæï¼ä»¥æç½ä½èçä¸»å¼ ã\n\n> ç¡®å®ä½èå·²ç»è§£å³äºåªäºé®é¢ï¼è¿æåªäºæ¯æªè§£å³çãå¨æªè§£å³çé®é¢ä¸­ï¼å®åªäºæ¯ä½èè®¤ä¸ºèªå·±æ æ³è§£å³çé®é¢ã\n\n> å¨ä½ è¯´åºâæåæâï¼âæä¸åæâï¼æâææç¼è¯è®ºâä¹åï¼ä½ ä¸å®è¦è½è¯å®å°è¯´ï¼âæäºè§£äºãâ\n\nå¨æä»¬è¯è®ºä¹åï¼ä¸å®æ¯å¨èªå·±å·²ç»çè§£çåºç¡ä¹ä¸ï¼è¿æ¯å¯¹å¯¹æ¹çåºæ¬ç¤¼è²ãå¨æä»¬ä¸æ¸æ¥çæ¶åä¾¿åæå¯¹æ¹ï¼æ¯æè ¢çï¼å¦æä¸æ¸æ¥è¿ä¸åæå¯¹æ¹çï¼åæ¯æ ç¤¼çãåªæå®å¨çè§£äºï¼ææè¯å¤´è®ºè¶³çèµæ ¼ã\n\n> å½ä½ ä¸åæä½èçè§ç¹æ¶ï¼è¦çæ§å°è¡¨è¾¾èªå·±çæè§ï¼ä¸è¦æ çå°è¾©é©³æäºè®ºã\n\næä»¬éè¦æè°è¯å½åå­¦ä¹ ï¼è¿æ¯ä¸ä¸ªäºç¸å­¦ä¹ åå¤´èé£æ´çè¿ç¨ï¼ä»ä¸­è·åå°ç¥è¯ï¼è¿ææ¯ç®çï¼èä¸æ¯æ æä¹çäºåµã\n\n> å°éç¥è¯ä¸ä¸ªäººè§ç¹çä¸åï¼å¨ä½ä»»ä½è¯æ­ä¹åï¼é½è¦æ¾åºçè®ºåºç¡\n\nä½èæåºæ»¡è¶³åä½èè¾©è®ºèµæ ¼çä¸ä¸ªè§åï¼\n\n * è¯»èä¸å®è¦å®æ´çäºè§£è¿æ¬ä¹¦\n * è¯»èä¸è¦äºå¼ºå¥½èæç²ç®åé©³\n * å°ç¥è¯ä¸çä¸åæè§çåæ¯å¤§ä½ä¸å¯ä»¥è§£å³çé®é¢\n\næä»¬å¨éè¯»ä¸æ¬ä¹¦æ¶å¦ææä¸åçæè§ï¼å¯ä»¥æçºªå¾çè¿è¡è¾©è®ºï¼\n\n * å¨äºè¾©çè¿ç¨ä¸­ä¸è¦å¸¦æèªå·±çæç»ªï¼å¦åå°±ä¸æ¯å¨è¯´çäºã\n * å¨äºè¾©æ¶éè¦åå°åææ¡ä»¶æèåè®¾æ¡ä»¶æåºæ¥ï¼è¿ä¸ªæ¯ä½ åé¢ææå¤æ­çåºç¡ï¼ä½ ä¹è¦æ¥åå¯¹æ¹çåè®¾æ¡ä»¶ï¼å³ä½¿ä½ ä»¬ççæ³å®å¨ç¸åï¼ä½æ¯ä¹éè¦æ¥åã\n * å¨äºè¾©æ¶ï¼éè¦ç«å¨å¯¹æ¹çè§åº¦å»æèï¼è¿æ ·æè½æ¯æè§çäº¤æµï¼èä¸æ¯æ æä¹çäºåµã\n\næä»¬å¨åé©³ä½èé®é¢çæ¶åï¼ä¸å®è¦æ¿åºä¾æ®æ¥è¯æèªå·±çè®ºç¹æå¯¹å¯¹æ¹çå°éã\n\n\n# è¾å©éè¯»\n\nå¯¹äºè¾å©éè¯»ï¼å»ºè®®åå°½èªå·±æè½çéè¿åå¨éè¯»å»å°ä¸æ¬ä¹¦ï¼å¦æè¿æä¸æçåéè¦å¯»æ¾å¤å¨çå¸®å©ã\n\nå¯¹äºå¯¼è¯»ï¼å»ºè®®æ¯å¨è¯»å®ä¸æ¬ä¹¦ä¹ååå»éè¯»ï¼è¿æ¯å ä¸ºï¼\n\n * å¯¼è¯»ä¸ä¸å®æ¯å¯¹çï¼å ä¸ºè¿ä¸ªæ¯å«äººè¯»å®ä¹¦ä¹åèªå·±çæè\n * å³ä½¿æ¯å¯¹çï¼ä¹ä¸æ¯ä¸å®æ¯å¨é¢çï¼å¯è½å¯¼è¯»è¿ä¹ä¼æéæ¼\n * çå¯¼è¯»ä¹ä¼éå¶èªå·±ççè§£ï¼å¹¶ä¸è·çå¯¼è¯»èçè§åº¦å»æèï¼ä½æ²¡æèªå·±çæèã\n\nè¿ä¹åçè¯ï¼ä¹æ¯æå¥½å¤çï¼\n\n * å¸®å©æä»¬è¯ éè¯­å¥ï¼å¹¶æ¾åºå±è¯ä¸ä¸»æ¨ã\n * èªæè¯»ä¹¦çä¸ç§è¡¥åï¼å¨éè¯»å®ä¹åäº§ççé®ç­ï¼å¯ä»¥å¸®å©ä½ è§£ç­ä¸çè§£ã\n\nå¯¹äºæè¦çä½ç¨ï¼\n\n * å¨éè¯»ä¸æ¬ä¹¦ä¹åï¼å¯ä»¥å¤éèªå·±çè®°å¿\n * å¨ä¸»é¢éè¯»æ¶ï¼å¯ä»¥éè¿æè¦ç¸å³èèµ·æ¥ã\n\nå¯¹äºå·¥å·ä¹¦çä½¿ç¨ï¼æä»¬éè¦ç¥éèªå·±æ³è¦æ¾ä»ä¹ï¼åªä¸ç§å·¥å·ææä»¬æ³è¦æ¾çåå®¹ï¼å¹¶å¦ä½ä½¿ç¨ä»ä»¬å¿«éæ¥æ¾å°ä½ æ³è¦æ¾çèµæã\n\n\n# éè¯»å¥½ä¹¦çéè¦æ§\n\n> å¦æä½ æè¯»çä¹¦é½å¨ä½ çè½åèå´ä¹åï¼ä½ å°±æ²¡æ³æåèªå·±çéè¯»è½åãä½ å¿é¡»è½æçºµè¶è¶ä½ è½åçä¹¦ï¼æåæä»¬æè¯´çï¼éè¯»è¶è¶ä½ å¤´èçä¹¦ãåªæé£æ ·çä¹¦è½å¸®å©ä½ çææ³å¢é¿ï¼é¤éä½ è½å¢é¿å¿æºï¼å¦åä½ å­¦ä¸å°ä¸è¥¿ã\n\næä»¬éè¦éè¿æ£è§éè¯»æ¥æé¤æé£äºåä¹¦ï¼æè½èçæ¶é´è¯»æ´å¤çå¥½ä¹¦ã',normalizedContent:'# åè¨\n\næ¬ææ¯æéè¯»å®ãå¦ä½éè¯»ä¸æ¬ä¹¦ãçè¯»åæï¼ä½èä¸»è¦æ¯å°éè¯»åä¸ºäºåä¸ªå±æ¬¡ï¼åºç¡éè¯»ãæ£è§éè¯»ãåæéè¯»åä¸»é¢éè¯»ï¼å¹¶è®²è§£è¿å ä¸ªå±æ¬¡è¯¥å¦ä½å»åï¼è½å¤æ´å¥½çå¸®å©æä»¬éè¯»ï¼è®©æä»¬ä»ä¸­æ¶è·å°æ´å¤\n\n\n# ä¸»å¨éè¯»\n\nä½èæå¡æä»¬éè¦ä¸»å¨è¯»ä¹¦ï¼è¿æ ·æä»¬æè½å¯¹ä¹¦ä¸­ç¥è¯ææ´å¥½çæ¢ç´¢å¹¶æ¶è·å°çä¼æ´å¤ã\n\nåå¨æä»¬éè¯»èµè®¯ä¿¡æ¯çæ¶åï¼ä¸ä»ä»åªéè¦ç¥éäºæä»¶äºçåçï¼è¿éè¦çè§£å®åççèåé»è¾ååçè¿è¡èæ³ï¼å°èªå·±ä»¥åçç¥è¯è¿è¡å³èèµ·æ¥ãè¿å°±æ¯ä¸»å¨çéè¯»ã\n\nå¹¶ä¸æä»¬åä¸»å¨éè¯»æ¶ä¼ä¿æå¤§èçæèå¹¶ä¿ææ¸éçç¶æï¼é£ä¹å¹³æ¶æææ¬²ç¡çäººé½åªæ¯å¨è¢«å¨çæ¥æ¶ç¥è¯ï¼æä»¥æ³¨æåææ æ³éä¸­èµ·æ¥ã\n\né®é¢æ¥äºï¼æä»¬è¯¥å¦ä½åå°ä¸»å¨éè¯»å¢ï¼ç­æ¡æ¯å¸¦çé®é¢å»éè¯»ï¼\n\n * è¿æ¬ä¹¦å¨è®²ä»ä¹ï¼\n * ä½èä»ç»è¯´äºä»ä¹ï¼å¦ä½è¯´çï¼æ¾åºå¯¹åºçæ³æ³ãå£°æåè®ºç¹\n * è¿æ¬ä¹¦æéçåï¼æ¯å¨é¨æéçï¼è¿æ¯é¨åæéçï¼\n * è¿æ¬ä¹¦è·èªå·±æä»ä¹å³ç³»ï¼èªå·±å¯ä»¥å­¦å°ä»ä¹ï¼å¯¹èªå·±æä»ä¹å¯ç¤ºï¼\n\nå¨éè¯»çè¿ç¨ä¸­æåºé¤äºä¸é¢å ä¸ªåºç¡çé®é¢ä¹å¤ï¼è¿éè¦èªå·±å»æåºé®é¢ï¼å¹¶ä¸æ­çå»ä»ä¹¦å¯»æ¾å¹¶åç­é®é¢ãåªæè¿æ ·ç»è¿æèæè½åå°ä¸»å¨éè¯»ã\n\nä½èè¿æå°äºåç¬è®°çå¿è¦æ§ï¼è¿ä¹æ¯ä¸»å¨éè¯»çä¸ä¸ªæ¹å¼ï¼\n\n * è½è®©èªå·±çä¿ææ¸é\n * æ¯ä¸ä¸ªä¸»å¨æèçè¿ç¨å¹¶ç¨è¨è¯­ç»è¡¨è¾¾åºæ¥ã\n * å°èªå·±çææ³ååºæ¥ï¼è®©èªå·±æ´å¥½ççè§£ä½èçææ³ï¼å¹¶å±å¼èªå·±çèæ³ã\n\n\n# éè¯»çç®æ  ï¼ä¸ºè·å¾èµè®¯èè¯»ï¼ä»¥åä¸ºæ±å¾çè§£èè¯»\n\næä»¬æ¯ä¸ºäºè·åå°ä½èè¾åºçç¥è¯èè¯»ä¹¦ï¼èä¸æ¯ä¸ºäºè¯»ä¹¦èè¯»ä¹¦ï¼å¦æè¯»å®è¿æ¬ä¹¦ï¼æ²¡æçè§£å°ä½èæ³è¦è¡¨è¾¾çä¸è¥¿ï¼èªèº«æ²¡ææ¹åï¼é£ä¹åçº¯ç²¹çæµªè´¹æ¶é´ã\n\n\n# çæ­£çéè¯»\n\nä¸åå©å¤åï¼éè¿èªå·±ä¸æ­çæèå»éè¯»ï¼ä»æ¨¡ç³ççè§£å°æ´æ¸æ¥ççè§£ã\n\n\n# æå¯¼åçå­¦ä¹ ï¼ä»¥åèªæåç°åçå­¦ä¹ \n\næ è®ºæ¯æå¯¼åå­¦ä¹ è¿æ¯èªæåç°åå­¦ä¹ é½å¯ä»¥æ¯ä¸»å¨çï¼ä¸è®ºæ¯åªä¸ç§ æ¹å¼ï¼åªæçæ­£å­¦ä¹ å°çäººææ¯ä¸»å¨çå­¦ä¹ èã\n\nå¨æå¯¼åçå­¦ä¹ è¿ç¨ä¸­ï¼è½ç¶æä»¬æ¯è¢«å¨çæ¥æ¶ç¥è¯ï¼çèµ·æ¥æ¯«ä¸è´¹åï¼ä½æ¯ä¸æ ·è¿æ¯éè¦ç»è¿èªå·±çæèæè½ææè·å¾ã\n\n\n# éè¯»æ¯è·çå·²ä¸ºç¼ºå¸­çæ¥å¿å¨å­¦ä¹ \n\næèå¸æ¶ï¼å¯ä»¥åç­ä½ çé®é¢ï¼èçèªå·±æèçæ¶é´ï¼èéè¯»ä¹¦æ¬æ¶ï¼å¿é¡»ç»è¿èªå·±çæèä¸åææå¯è½æç­æ¡ã\n\n\n# åä¸ªå±æ¬¡\n\nä½èå°éè¯»åä¸ºåä¸ªå±æ¬¡ï¼\n\n * åºç¡éè¯»ï¼å°±æ¯æåºç¡çéè¯»ï¼è½è®¤å­å°±è¡ï¼ç»åäºä¹å¹´ä¹å¡æè²åºæ¬å°±è½åå°ã\n * æ£è§éè¯»ï¼å°±æ¯å¨ä¸å®çæ¶é´ä¹åï¼æä½ä¸æ¬ä¹¦çéç¹ã\n * åæéè¯»ï¼æ¯å¨ççéè¯»ãå®æ´çéè¯»ã\n * ä¸»é¢éè¯»ï¼éè¯»èéè¿è¯»å¾å¤çä¹¦ï¼ç¶ååä¸¾è¿äºä¹¦ä¹é´çç¸å³ä¹å¤ãè¿ç§æ¹å¼æ¯æä¸»å¨ãä¹æ¯æè±åæ°çéè¯»ã\n\nä½èæ´æ¬ä¹¦ä¸»è¦æ¯å´ç»è¿åä¸ªå±æ¬¡è¿è¡è®²è§£åæçã\n\n\n# ç¥è¯»\n\n> ä½ èä¸­çç®æ æ¯è¦åç°è¿æ¬ä¹¦å¼ä¸å¼å¾å¤è±æ¶é´ä»ç»éè¯»ãå¶æ¬¡ï¼å°±ç®ä½ å³å®äºä¸åå¤è±æ¶é´ä»ç»éè¯»è¿æ¬ä¹¦ï¼ç¥è¯»ä¹è½åè¯ä½ è®¸å¤è·è¿æ¬ä¹¦æå³çäºã\n\nè¿æ¯ç¥è¯»çç®æ ï¼æä»¬éè¿ç¥è¯»å¯ä»¥èçæ¶é´ï¼æé¤ä¸äºåå¾ä¹¦ã\n\né£ä¹æä»¬æ¹å¦ä½è¿è¡ç¥è¯»å¢ï¼æä»¥ä¸å ä¸ªæ¹æ³ï¼\n\n * åçä¹¦åé¡µï¼ç¶åå¦ææåºå°±åçåºã\n * ç ç©¶ç®å½é¡µã\n * å¦æä¹¦ä¸­éæç´¢å¼ï¼ä¹è¦æ£éä¸ä¸ã\n * å¦æé£æ¯æ¬åçä¹¦è¡£çæ°ä¹¦ï¼ä¸å¦¨è¯»ä¸ä¸åºçèçä»ç»ã\n * ä»ç®å½é¡µä¸­æéå ä¸ªè·ä¸»é¢ç¸å³çç¯ç« æ¥çã\n * å°å¨æ°ç¿»ä¸éï¼éæçä¸ªå æ®µã\n\n\n# éè¯»éåº¦\n\næä»¬å¨æ£è§éè¯»æ¶ï¼æ¯éè¦å¿«éå°éè¯»çï¼å¨ä¸å¼å¾æä»¬è±æ¶é´çå°æ¹è¯»å¿«ä¸ç¹ï¼è¿ä¸ªæ¶åæä»¬æ¶åéè¦ç¥éæä»¬å¨éè¯»ä¸­å¯»æ¾ä»ä¹ï¼è¿æ ·æä»¬æè½å¯¹ä¸åçåå®¹ä½¿ç¨ä¸åçéåº¦æ¥è¿è¡éè¯»ã\n\nå¦ä½æåéè¯»éåº¦ï¼å°æææåæå­å¾åç§»å¨ä¸å»ï¼ç¼çè·çææçä¸å»ï¼å¼ºè¿«èªå·±çç¼çè·çæé¨çå¨ä½ç§»å¨ã\n\n\n# å¹å»éè¯»çä¹ æ¯\n\n> æä»¬è°å°ä¸ä¸ªæææ¯çäººæ¶ï¼å¹¶ä¸æ¯å¨è¯´ä»ç¥éè¯¥å¦ä½å»åé£ä»¶äºï¼èæ¯ä»å·²ç»å»æå»åé£ä»¶äºçä¹ æ¯äºã\n\nå½æä»¬å»æä¹ æ¯åï¼æå°±è½å¤èªç¶çæç§è§åå»åé£ä»¶äºæï¼æææ¯çäººä¹æ¯éè¿ä¸æ­çè®­ç»å°è§åå»æäºä¹ æ¯ã\n\næä»¬å°éè¯»å¹å»æä¹ æ¯åï¼å¯ä»¥æé«éè¯»çè½åä¸éåº¦ï¼æåä¼åèµ°è·¯ä¸åé¥­ä¸æ ·çèªç¶ã\n\n> ä½ ä¸å®è¦å­¦ä¼å¿æé£äºåå¼çæ­¥éª¤ï¼æè½è¡¨ç°åºæ´ä½çå¨ä½ï¼èæ¯ä¸ä¸ªåä¸çæ­¥éª¤é½è¿è¦ç¡®å®è¡¨ç°å¾å¾å¥½ãä½æ¯ï¼ä¸ºäºè¦å¿æè¿äºåä¸çå¨ä½ï¼ä¸å¼å§ä½ å¿é¡»ååå«å­¦ä¼æ¯ä¸ä¸ªåä¸çå¨ä½ãåªæè¿æ ·ï¼ä½ æè½å°ææçå¨ä½è¿ç»èµ·æ¥ï¼åæä¸ä¸ªä¼ç§çæ»éªé«æã\n\néè¯»æ¯éè¦å¤ä¸ªæ­¥éª¤ç»åèµ·æ¥çï¼æä»¬éè¦ä¸æ­çç»ä¹ é»ç¼åä¸ªæ­¥éª¤ï¼å°è¿äºæ­¥éª¤åæä¹ æ¯åéæ¸å¿è®°ï¼ç¶åèªç¶çå°ææçè¿æ¥èµ·æ¥ï¼æç»æä¸ºä¸ä¸ªéè¯»é«æãè¿è®©ææ³å°äºåå¤©å± é¾è®°ä¸­çå¼ ä¸ä¸°æå¼ æ å¿å¤ªææ¶çåºæ¯ï¼åæ¯æå¼ æ å¿æ¯ä¸ä¸ªå¨ä½ï¼çç»ä¹åéæ¸å¿è®°ï¼æç»å°å¤ªæèä¼è´¯éï¼å½æ¶ä¸å¤ªæï¼ç°å¨åç°è¿éæå¼æ²åå·¥ä¹å¦ã\n\n\n# åæéè¯»çè§å\n\n> ä¾ç§ä¹¦æ¬çç§ç±»ä¸ä¸»é¢ä½åç±»ã\n\nä¸åç§ç±»çä¹¦ç±çç®çæ¯ä¸åçï¼æ¯å¦çè®ºæ§çä½åæ¯æä½ è¿æ¯ä»ä¹ï¼èå®ç¨æ§çä½ç¨å¨æä½ å¦ä½å»åä½ æ³åçäºæã\n\nå°ä¹¦ç±çåç±»å¹¶ä¸ç®åï¼æä»¬å¯ä»¥éè¿ä¹¦åãåè¨åä¹¦ä¸­ä¸»é¢åå®¹æ¥åºåã\n\nä¸åç§ç±»çä¹¦ç±ä¹éè¦ä½¿ç¨çæ¯ä¸åçæ¹æ³éè¯»ã\n\n> ç¨æç®ç­çå¥å­è¯´åºæ´æ¬ä¹¦å¨è°äºä»ä¹ã\n\nå¦ææä»¬ç¥éäºè¿æ¬ä¹¦å¨è°ä»ä¹ï¼æä»¬å°±è½æ£æµåºä½èæ³è¦å¹²ä»ä¹ï¼å¹¶è½åç°è¿æ¬ä¹¦çä¸»é¢åéç¹ã\n\néè¿ç»èªå·±æä»äººè®²è¿°è¿æ¬ä¹¦è¯´çä»ä¹ï¼å¯ä»¥éªè¯èªå·±æ¯å¦å¯¹æ¬ä¹¦æ´ä½åå®¹æä¸ä¸ªè¯¦ç»çäºè§£ã\n\n> æç§é¡ºåºä¸å³ç³»ï¼ååºå¨ä¹¦çéè¦é¨åãå°å¨ä¹¦ççº²è¦æåºæ¥ä¹åï¼åå°åä¸ªé¨åççº²è¦ä¹ä¸ä¸ååºã\n\nå¿ä¸­è¦å¯¹ä¹¦ä¸­çæ´ä½æ¶ææä¸ä¸ªäºè§£ï¼æè½ä»å¤ä¸ªæ¹é¢å»çå¾è¿æ¬ä¹¦ã\n\n> æ¾åºä½èå¨é®çé®é¢ï¼æä½èæ³è¦è§£å³çé®é¢ã\n\nä½èåä¹¦æ¶ï¼è¯å®æ¯å¸¦çé®é¢æèæ³è¦è§£å³ä¸ä¸ªé®é¢å»åçãæ¾åºè¿äºé®é¢è½å¤æ´å¥½çä¸ºä¸é¢ä¸¤æ¡æå¡ã\n\n> è¯ éä½èä½¿ç¨çå³é®å­ï¼ä¸ä½èè¾¾æå±è¯ã\n\nç¸åçåå­ä¼åç°åºä¸åçæä¹ï¼æ¯å¦æä»¬å¨è°"éè¯»"æ¶ï¼å¯è½æ¯ä¸ºå¨±ä¹èéè¯»ï¼å¯è½æ¯ä¸ºè·å¾å¨è¯¢èéè¯»ï¼ä¹å¯è½æ¯ä¸ºè¿½æ±çè§£åèéè¯»ãæä»¬éè¦åä½èä¿æä¸è´çè§£ï¼æè½æå±åçææ³ãå¦ææä»¬å¯¹å­å¥æ¯«ä¸ç¨å¿ï¼èªç¶æ æ³è·ä½èè¾¾æå±è¯ï¼ä¹å°±ä¸æ æè·ã\n\næä»¬å¯ä»¥éè¿ä¸ä¸æä¸­å·²ç»çè§£çè¯­å¥å¨å¸®å©èªå·±æ¥æ¨æ²åºæä»¬ä¸çè§£çé£ä¸ªå­çææã\n\n> ä»æéè¦çå¥å­ä¸­æåºä½èçéè¦ä¸»æ¨ã\n\næ¾åºè¯­å¥çä¸»æ¨åï¼éè¦ä½¿ç¨èªå·±çè¯è¯­æ¥è¯´æ¥éªè¯èªå·±å°åºææ²¡æçè§£éå½»ãä¹å¯ä»¥éè¿å°æä¸ªä¾å­æèäºææ¥è¯´æä¸»æ¨æ¥éªè¯ã\n\n> æ¾åºä½èçè®ºè¿°ï¼éæ°æ¶æè¿äºè®ºè¿°çåå åæï¼ä»¥æç½ä½èçä¸»å¼ ã\n\n> ç¡®å®ä½èå·²ç»è§£å³äºåªäºé®é¢ï¼è¿æåªäºæ¯æªè§£å³çãå¨æªè§£å³çé®é¢ä¸­ï¼å®åªäºæ¯ä½èè®¤ä¸ºèªå·±æ æ³è§£å³çé®é¢ã\n\n> å¨ä½ è¯´åºâæåæâï¼âæä¸åæâï¼æâææç¼è¯è®ºâä¹åï¼ä½ ä¸å®è¦è½è¯å®å°è¯´ï¼âæäºè§£äºãâ\n\nå¨æä»¬è¯è®ºä¹åï¼ä¸å®æ¯å¨èªå·±å·²ç»çè§£çåºç¡ä¹ä¸ï¼è¿æ¯å¯¹å¯¹æ¹çåºæ¬ç¤¼è²ãå¨æä»¬ä¸æ¸æ¥çæ¶åä¾¿åæå¯¹æ¹ï¼æ¯æè ¢çï¼å¦æä¸æ¸æ¥è¿ä¸åæå¯¹æ¹çï¼åæ¯æ ç¤¼çãåªæå®å¨çè§£äºï¼ææè¯å¤´è®ºè¶³çèµæ ¼ã\n\n> å½ä½ ä¸åæä½èçè§ç¹æ¶ï¼è¦çæ§å°è¡¨è¾¾èªå·±çæè§ï¼ä¸è¦æ çå°è¾©é©³æäºè®ºã\n\næä»¬éè¦æè°è¯å½åå­¦ä¹ ï¼è¿æ¯ä¸ä¸ªäºç¸å­¦ä¹ åå¤´èé£æ´çè¿ç¨ï¼ä»ä¸­è·åå°ç¥è¯ï¼è¿ææ¯ç®çï¼èä¸æ¯æ æä¹çäºåµã\n\n> å°éç¥è¯ä¸ä¸ªäººè§ç¹çä¸åï¼å¨ä½ä»»ä½è¯æ­ä¹åï¼é½è¦æ¾åºçè®ºåºç¡\n\nä½èæåºæ»¡è¶³åä½èè¾©è®ºèµæ ¼çä¸ä¸ªè§åï¼\n\n * è¯»èä¸å®è¦å®æ´çäºè§£è¿æ¬ä¹¦\n * è¯»èä¸è¦äºå¼ºå¥½èæç²ç®åé©³\n * å°ç¥è¯ä¸çä¸åæè§çåæ¯å¤§ä½ä¸å¯ä»¥è§£å³çé®é¢\n\næä»¬å¨éè¯»ä¸æ¬ä¹¦æ¶å¦ææä¸åçæè§ï¼å¯ä»¥æçºªå¾çè¿è¡è¾©è®ºï¼\n\n * å¨äºè¾©çè¿ç¨ä¸­ä¸è¦å¸¦æèªå·±çæç»ªï¼å¦åå°±ä¸æ¯å¨è¯´çäºã\n * å¨äºè¾©æ¶éè¦åå°åææ¡ä»¶æèåè®¾æ¡ä»¶æåºæ¥ï¼è¿ä¸ªæ¯ä½ åé¢ææå¤æ­çåºç¡ï¼ä½ ä¹è¦æ¥åå¯¹æ¹çåè®¾æ¡ä»¶ï¼å³ä½¿ä½ ä»¬ççæ³å®å¨ç¸åï¼ä½æ¯ä¹éè¦æ¥åã\n * å¨äºè¾©æ¶ï¼éè¦ç«å¨å¯¹æ¹çè§åº¦å»æèï¼è¿æ ·æè½æ¯æè§çäº¤æµï¼èä¸æ¯æ æä¹çäºåµã\n\næä»¬å¨åé©³ä½èé®é¢çæ¶åï¼ä¸å®è¦æ¿åºä¾æ®æ¥è¯æèªå·±çè®ºç¹æå¯¹å¯¹æ¹çå°éã\n\n\n# è¾å©éè¯»\n\nå¯¹äºè¾å©éè¯»ï¼å»ºè®®åå°½èªå·±æè½çéè¿åå¨éè¯»å»å°ä¸æ¬ä¹¦ï¼å¦æè¿æä¸æçåéè¦å¯»æ¾å¤å¨çå¸®å©ã\n\nå¯¹äºå¯¼è¯»ï¼å»ºè®®æ¯å¨è¯»å®ä¸æ¬ä¹¦ä¹ååå»éè¯»ï¼è¿æ¯å ä¸ºï¼\n\n * å¯¼è¯»ä¸ä¸å®æ¯å¯¹çï¼å ä¸ºè¿ä¸ªæ¯å«äººè¯»å®ä¹¦ä¹åèªå·±çæè\n * å³ä½¿æ¯å¯¹çï¼ä¹ä¸æ¯ä¸å®æ¯å¨é¢çï¼å¯è½å¯¼è¯»è¿ä¹ä¼æéæ¼\n * çå¯¼è¯»ä¹ä¼éå¶èªå·±ççè§£ï¼å¹¶ä¸è·çå¯¼è¯»èçè§åº¦å»æèï¼ä½æ²¡æèªå·±çæèã\n\nè¿ä¹åçè¯ï¼ä¹æ¯æå¥½å¤çï¼\n\n * å¸®å©æä»¬è¯ éè¯­å¥ï¼å¹¶æ¾åºå±è¯ä¸ä¸»æ¨ã\n * èªæè¯»ä¹¦çä¸ç§è¡¥åï¼å¨éè¯»å®ä¹åäº§ççé®ç­ï¼å¯ä»¥å¸®å©ä½ è§£ç­ä¸çè§£ã\n\nå¯¹äºæè¦çä½ç¨ï¼\n\n * å¨éè¯»ä¸æ¬ä¹¦ä¹åï¼å¯ä»¥å¤éèªå·±çè®°å¿\n * å¨ä¸»é¢éè¯»æ¶ï¼å¯ä»¥éè¿æè¦ç¸å³èèµ·æ¥ã\n\nå¯¹äºå·¥å·ä¹¦çä½¿ç¨ï¼æä»¬éè¦ç¥éèªå·±æ³è¦æ¾ä»ä¹ï¼åªä¸ç§å·¥å·ææä»¬æ³è¦æ¾çåå®¹ï¼å¹¶å¦ä½ä½¿ç¨ä»ä»¬å¿«éæ¥æ¾å°ä½ æ³è¦æ¾çèµæã\n\n\n# éè¯»å¥½ä¹¦çéè¦æ§\n\n> å¦æä½ æè¯»çä¹¦é½å¨ä½ çè½åèå´ä¹åï¼ä½ å°±æ²¡æ³æåèªå·±çéè¯»è½åãä½ å¿é¡»è½æçºµè¶è¶ä½ è½åçä¹¦ï¼æåæä»¬æè¯´çï¼éè¯»è¶è¶ä½ å¤´èçä¹¦ãåªæé£æ ·çä¹¦è½å¸®å©ä½ çææ³å¢é¿ï¼é¤éä½ è½å¢é¿å¿æºï¼å¦åä½ å­¦ä¸å°ä¸è¥¿ã\n\næä»¬éè¦éè¿æ£è§éè¯»æ¥æé¤æé£äºåä¹¦ï¼æè½èçæ¶é´è¯»æ´å¤çå¥½ä¹¦ã',charsets:{cjk:!0},lastUpdated:"2023/05/01, 18:02:43",lastUpdatedTimestamp:1682935363e3},{title:"åè¯ MCP Server",frontmatter:{title:"åè¯ MCP Server",date:"2025-05-01T16:05:29.000Z",permalink:"/pages/92e280/",categories:["AI"],tags:["AI"],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"MCP å¨ç§°ä¸º Model Context Protocolï¼æ¯ä¸ä¸ªå¤§æ¨¡åæºè½ä½ä¸å¤é¨å·¥å·æèæ°æ®æºçäº¤äºåè®®ãä¹å°±æ¯è¯´ï¼æºè½ä½å¯ä»¥éè¿è¯¥åè®®å»è°ç¨æä»¥æ¯æè¯¥åè®®çæå¡ï¼æ¥å¢å¼ºæºè½ä½çè½åãå¨æ²¡æ MCP æ¶ï¼ä¸åçæºè½ä½é½éè¦å¯¹ä¸åçå¤é¨å·¥å·ååç¬çééæè½è°ç¨ï¼ä¹å°±æ¯é½ç¨èªå·±ç¬æçåè®®ï¼æ MCP åä¹å°±æ¯ç»ä¸äºå¤é¨è°ç¨åè®®ï¼åè½»äºæºè½ä½çå¼åææ¬ï¼ä¹å¯ä»¥å¿«éæ¥å¥ä¸åçå¤é¨æå¡ãæ¬æä¸»è¦æ¯ç®åè®¤è¯ä¸ MCPï¼å¹¶å©ç¨ MCP æ¥è°ç¨æ¬å°æä»¶ç³»ç»åæ°æ®åºæ¥å®ææ¡ä¾ã",comment:!0,feed:{enable:!0},meta:[{name:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17460888546831746088854424.png"},{name:"twitter:title",content:"åè¯ MCP Server"},{name:"twitter:description",content:"MCP å¨ç§°ä¸º Model Context Protocolï¼æ¯ä¸ä¸ªå¤§æ¨¡åæºè½ä½ä¸å¤é¨å·¥å·æèæ°æ®æºçäº¤äºåè®®ãä¹å°±æ¯è¯´ï¼æºè½ä½å¯ä»¥éè¿è¯¥åè®®å»è°ç¨æä»¥æ¯æè¯¥åè®®çæå¡ï¼æ¥å¢å¼ºæºè½ä½çè½åãå¨æ²¡æ MCP æ¶ï¼ä¸åçæºè½ä½é½éè¦å¯¹ä¸åçå¤é¨å·¥å·ååç¬çééæè½è°ç¨ï¼ä¹å°±æ¯é½ç¨èªå·±ç¬æçåè®®ï¼æ MCP åä¹å°±æ¯ç»ä¸äºå¤é¨è°ç¨åè®®ï¼åè½»äºæºè½ä½çå¼åææ¬ï¼ä¹å¯ä»¥å¿«éæ¥å¥ä¸åçå¤é¨æå¡ãæ¬æä¸»è¦æ¯ç®åè®¤è¯ä¸ MCPï¼å¹¶å©ç¨ MCP æ¥è°ç¨æ¬å°æä»¶ç³»ç»åæ°æ®åºæ¥å®ææ¡ä¾ã"},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17460888546831746088854424.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/06.AI/01.%E5%88%9D%E8%AF%86%20MCP%20Server.html"},{property:"og:type",content:"article"},{property:"og:title",content:"åè¯ MCP Server"},{property:"og:description",content:"MCP å¨ç§°ä¸º Model Context Protocolï¼æ¯ä¸ä¸ªå¤§æ¨¡åæºè½ä½ä¸å¤é¨å·¥å·æèæ°æ®æºçäº¤äºåè®®ãä¹å°±æ¯è¯´ï¼æºè½ä½å¯ä»¥éè¿è¯¥åè®®å»è°ç¨æä»¥æ¯æè¯¥åè®®çæå¡ï¼æ¥å¢å¼ºæºè½ä½çè½åãå¨æ²¡æ MCP æ¶ï¼ä¸åçæºè½ä½é½éè¦å¯¹ä¸åçå¤é¨å·¥å·ååç¬çééæè½è°ç¨ï¼ä¹å°±æ¯é½ç¨èªå·±ç¬æçåè®®ï¼æ MCP åä¹å°±æ¯ç»ä¸äºå¤é¨è°ç¨åè®®ï¼åè½»äºæºè½ä½çå¼åææ¬ï¼ä¹å¯ä»¥å¿«éæ¥å¥ä¸åçå¤é¨æå¡ãæ¬æä¸»è¦æ¯ç®åè®¤è¯ä¸ MCPï¼å¹¶å©ç¨ MCP æ¥è°ç¨æ¬å°æä»¶ç³»ç»åæ°æ®åºæ¥å®ææ¡ä¾ã"},{property:"og:image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17460888546831746088854424.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/06.AI/01.%E5%88%9D%E8%AF%86%20MCP%20Server.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2025-05-01T16:05:29.000Z"},{property:"article:tag",content:"AI"},{itemprop:"name",content:"åè¯ MCP Server"},{itemprop:"description",content:"MCP å¨ç§°ä¸º Model Context Protocolï¼æ¯ä¸ä¸ªå¤§æ¨¡åæºè½ä½ä¸å¤é¨å·¥å·æèæ°æ®æºçäº¤äºåè®®ãä¹å°±æ¯è¯´ï¼æºè½ä½å¯ä»¥éè¿è¯¥åè®®å»è°ç¨æä»¥æ¯æè¯¥åè®®çæå¡ï¼æ¥å¢å¼ºæºè½ä½çè½åãå¨æ²¡æ MCP æ¶ï¼ä¸åçæºè½ä½é½éè¦å¯¹ä¸åçå¤é¨å·¥å·ååç¬çééæè½è°ç¨ï¼ä¹å°±æ¯é½ç¨èªå·±ç¬æçåè®®ï¼æ MCP åä¹å°±æ¯ç»ä¸äºå¤é¨è°ç¨åè®®ï¼åè½»äºæºè½ä½çå¼åææ¬ï¼ä¹å¯ä»¥å¿«éæ¥å¥ä¸åçå¤é¨æå¡ãæ¬æä¸»è¦æ¯ç®åè®¤è¯ä¸ MCPï¼å¹¶å©ç¨ MCP æ¥è°ç¨æ¬å°æä»¶ç³»ç»åæ°æ®åºæ¥å®ææ¡ä¾ã"},{itemprop:"image",content:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/17460888546831746088854424.png"}],readingShow:"top"},regularPath:"/06.AI/01.%E5%88%9D%E8%AF%86%20MCP%20Server.html",relativePath:"06.AI/01.åè¯ MCP Server.md",key:"v-602416af",path:"/pages/92e280/",headers:[{level:2,title:"ç®ä»",slug:"ç®ä»",normalizedTitle:"ç®ä»",charIndex:2},{level:2,title:"åå¤å·¥ä½",slug:"åå¤å·¥ä½",normalizedTitle:"åå¤å·¥ä½",charIndex:252},{level:2,title:"éè¿å¤§æ¨¡åæä½æ¬å°æä»¶",slug:"éè¿å¤§æ¨¡åæä½æ¬å°æä»¶",normalizedTitle:"éè¿å¤§æ¨¡åæä½æ¬å°æä»¶",charIndex:376},{level:2,title:"éè¿å¤§æ¨¡åæ¥å®æpostgresçæ¥è¯¢",slug:"éè¿å¤§æ¨¡åæ¥å®æpostgresçæ¥è¯¢",normalizedTitle:"éè¿å¤§æ¨¡åæ¥å®æpostgresçæ¥è¯¢",charIndex:675},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:896}],headersStr:"ç®ä» åå¤å·¥ä½ éè¿å¤§æ¨¡åæä½æ¬å°æä»¶ éè¿å¤§æ¨¡åæ¥å®æpostgresçæ¥è¯¢ æ»ç»",content:"# ç®ä»\n\nMCP å¨ç§°ä¸º Model Context Protocolï¼æ¯ä¸ä¸ªå¤§æ¨¡åæºè½ä½ä¸å¤é¨å·¥å·æèæ°æ®æºçäº¤äºåè®®ãä¹å°±æ¯è¯´ï¼æºè½ä½å¯ä»¥éè¿è¯¥åè®®å»è°ç¨æä»¥æ¯æè¯¥åè®®çæå¡ï¼æ¥å¢å¼ºæºè½ä½çè½åã\n\nå¨æ²¡æ MCP æ¶ï¼ä¸åçæºè½ä½é½éè¦å¯¹ä¸åçå¤é¨å·¥å·ååç¬çééæè½è°ç¨ï¼ä¹å°±æ¯é½ç¨èªå·±ç¬æçåè®®ï¼æ MCP åä¹å°±æ¯ç»ä¸äºå¤é¨è°ç¨åè®®ï¼åè½»äºæºè½ä½çå¼åææ¬ï¼ä¹å¯ä»¥å¿«éæ¥å¥ä¸åçå¤é¨æå¡ã\n\n\n\næ¬æä¸»è¦æ¯ç®åè®¤è¯ä¸ MCPï¼å¹¶å©ç¨ MCP æ¥è°ç¨æ¬å°æä»¶ç³»ç»åæ°æ®åºæ¥å®ææ¡ä¾ã\n\n\n# åå¤å·¥ä½\n\næ¬æä½¿ç¨çæ¯CherryStduioæ¥ä½ä¸ºå¤§æ¨¡åçå®¢æ·ç«¯ã\n\nç¶ååå»é¿éäºç¾ç¼ä¸ç³è¯·åè´¹çå¤§æ¨¡åçé¢åº¦ï¼æ¿å° API KEY\n\næåå°å° API KEY éç½®å° CherryStudio ä¸­ï¼å°±å¯ä»¥ä½¿ç¨å¤§æ¨¡åè¿è¡å¯¹è¯äºã\n\n\n\n\n# éè¿å¤§æ¨¡åæä½æ¬å°æä»¶\n\né¦åéè¦éç½®æ¯ææ¬å°æä»¶ç³»ç»ç MCP Serverï¼è¿ééæ©æ¯çdesktop-commander\n\nå¨é¡µé¢ä¸­æ¾å°æå¡è¿è¡çå½ä»¤\n\nç¶åå¡«åå° CherryStudio ä¸­ï¼ç¹å»ä¿å­å³å¯\n\nè¿å¥å°å¯¹è¯é¡µé¢ï¼éæ©ä½¿ç¨çå¤§æ¨¡åï¼ç¶ååéæ©ä¸é¢æ·»å å¥½çdesktop-commanderæå¡ï¼å°±å¯ä»¥è¿è¡å¯¹è¯äºã\n\nå¨å¯¹è¯ä¸­ï¼è®©å¤§æ¨¡åå¸®å¿å¨æ¡é¢ä¸åå»ºä¸ä¸ªæä»¶ï¼å¯ä»¥çå°å®¢æ·ç«¯åå«è°ç¨äºdesck-commanderæå¡ä¸­çä¸¤ä¸ªæ¹æ³ï¼create_directoryåwrite_file\n\nå¨çåæ¡é¢åç°äºæä»¶hello.txtï¼å¹¶æå¼åç°åå®¹åæä»¬å¯¹è¯ä¸­çåå®¹ä¸è´ã\n\n\n# éè¿å¤§æ¨¡åæ¥å®æpostgresçæ¥è¯¢\n\né¦åéè¦æååå¤å¥½ä¸ä¸ªpostgresæ°æ®åºï¼æ°æ®å¦ä¸ï¼\n\nç¶åæä»¬éæ©æ¯çserver-postgresä½ä¸ºæä»¬çpostgres MCP Serverï¼æ¾å°æå¡è¿è¡çå½ä»¤ã\n\n\n\nå°å½ä»¤éç½®å° CherryStudio ä¸­ï¼ç¹å»ä¿å­å³å¯\n\nå¨å¯¹è¯æ¡ä¸­éæ©æä»¬éç½®å°server-postgresæå¡ï¼ç¶åå°±å¯ä»¥è¿è¡å¯¹è¯äºã\n\nç°å¨å¯ä»¥æ¥å¯¹è¯ä¸­æ°æ®åºçæä½ï¼è®©å®å¸®æä»¬æ¥è¯¢è¡¨ä»¥åè¡¨ä¸­æ°æ®ã\n\n\n# æ»ç»\n\nAIçåå±è¶å¿æ¯è¶æ¥è¶å¿«ï¼èMCPçåºç°ï¼ä½¿å¾AIå¯ä»¥æ´å æ¹ä¾¿çä¸å¤é¨æå¡è¿è¡äº¤äºï¼ä»èå®ç°æ´å æºè½çåºç¨ã",normalizedContent:"# ç®ä»\n\nmcp å¨ç§°ä¸º model context protocolï¼æ¯ä¸ä¸ªå¤§æ¨¡åæºè½ä½ä¸å¤é¨å·¥å·æèæ°æ®æºçäº¤äºåè®®ãä¹å°±æ¯è¯´ï¼æºè½ä½å¯ä»¥éè¿è¯¥åè®®å»è°ç¨æä»¥æ¯æè¯¥åè®®çæå¡ï¼æ¥å¢å¼ºæºè½ä½çè½åã\n\nå¨æ²¡æ mcp æ¶ï¼ä¸åçæºè½ä½é½éè¦å¯¹ä¸åçå¤é¨å·¥å·ååç¬çééæè½è°ç¨ï¼ä¹å°±æ¯é½ç¨èªå·±ç¬æçåè®®ï¼æ mcp åä¹å°±æ¯ç»ä¸äºå¤é¨è°ç¨åè®®ï¼åè½»äºæºè½ä½çå¼åææ¬ï¼ä¹å¯ä»¥å¿«éæ¥å¥ä¸åçå¤é¨æå¡ã\n\n\n\næ¬æä¸»è¦æ¯ç®åè®¤è¯ä¸ mcpï¼å¹¶å©ç¨ mcp æ¥è°ç¨æ¬å°æä»¶ç³»ç»åæ°æ®åºæ¥å®ææ¡ä¾ã\n\n\n# åå¤å·¥ä½\n\næ¬æä½¿ç¨çæ¯cherrystduioæ¥ä½ä¸ºå¤§æ¨¡åçå®¢æ·ç«¯ã\n\nç¶ååå»é¿éäºç¾ç¼ä¸ç³è¯·åè´¹çå¤§æ¨¡åçé¢åº¦ï¼æ¿å° api key\n\næåå°å° api key éç½®å° cherrystudio ä¸­ï¼å°±å¯ä»¥ä½¿ç¨å¤§æ¨¡åè¿è¡å¯¹è¯äºã\n\n\n\n\n# éè¿å¤§æ¨¡åæä½æ¬å°æä»¶\n\né¦åéè¦éç½®æ¯ææ¬å°æä»¶ç³»ç»ç mcp serverï¼è¿ééæ©æ¯çdesktop-commander\n\nå¨é¡µé¢ä¸­æ¾å°æå¡è¿è¡çå½ä»¤\n\nç¶åå¡«åå° cherrystudio ä¸­ï¼ç¹å»ä¿å­å³å¯\n\nè¿å¥å°å¯¹è¯é¡µé¢ï¼éæ©ä½¿ç¨çå¤§æ¨¡åï¼ç¶ååéæ©ä¸é¢æ·»å å¥½çdesktop-commanderæå¡ï¼å°±å¯ä»¥è¿è¡å¯¹è¯äºã\n\nå¨å¯¹è¯ä¸­ï¼è®©å¤§æ¨¡åå¸®å¿å¨æ¡é¢ä¸åå»ºä¸ä¸ªæä»¶ï¼å¯ä»¥çå°å®¢æ·ç«¯åå«è°ç¨äºdesck-commanderæå¡ä¸­çä¸¤ä¸ªæ¹æ³ï¼create_directoryåwrite_file\n\nå¨çåæ¡é¢åç°äºæä»¶hello.txtï¼å¹¶æå¼åç°åå®¹åæä»¬å¯¹è¯ä¸­çåå®¹ä¸è´ã\n\n\n# éè¿å¤§æ¨¡åæ¥å®æpostgresçæ¥è¯¢\n\né¦åéè¦æååå¤å¥½ä¸ä¸ªpostgresæ°æ®åºï¼æ°æ®å¦ä¸ï¼\n\nç¶åæä»¬éæ©æ¯çserver-postgresä½ä¸ºæä»¬çpostgres mcp serverï¼æ¾å°æå¡è¿è¡çå½ä»¤ã\n\n\n\nå°å½ä»¤éç½®å° cherrystudio ä¸­ï¼ç¹å»ä¿å­å³å¯\n\nå¨å¯¹è¯æ¡ä¸­éæ©æä»¬éç½®å°server-postgresæå¡ï¼ç¶åå°±å¯ä»¥è¿è¡å¯¹è¯äºã\n\nç°å¨å¯ä»¥æ¥å¯¹è¯ä¸­æ°æ®åºçæä½ï¼è®©å®å¸®æä»¬æ¥è¯¢è¡¨ä»¥åè¡¨ä¸­æ°æ®ã\n\n\n# æ»ç»\n\naiçåå±è¶å¿æ¯è¶æ¥è¶å¿«ï¼èmcpçåºç°ï¼ä½¿å¾aiå¯ä»¥æ´å æ¹ä¾¿çä¸å¤é¨æå¡è¿è¡äº¤äºï¼ä»èå®ç°æ´å æºè½çåºç¨ã",charsets:{cjk:!0},lastUpdated:"2025/06/15, 00:16:07",lastUpdatedTimestamp:1749917767e3},{title:"å³äº",frontmatter:{title:"å³äº",date:"2019-12-25T14:27:01.000Z",permalink:"/about/",sidebar:!1,article:!1,author:{name:"zhengwenfeng",link:"https://github.com/zhengwenfeng"},description:"å·¥ä½å¹´é: 5å¹´\nèä¸: è½¯ä»¶å¼åå·¥ç¨å¸\nç®å: å¨æåæ¬ç ä¸­~",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"å³äº"},{name:"twitter:description",content:"å·¥ä½å¹´é: 5å¹´\nèä¸: è½¯ä»¶å¼åå·¥ç¨å¸\nç®å: å¨æåæ¬ç ä¸­~"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/08.%E5%85%B3%E4%BA%8E/01.%E5%85%B3%E4%BA%8E.html"},{property:"og:type",content:"article"},{property:"og:title",content:"å³äº"},{property:"og:description",content:"å·¥ä½å¹´é: 5å¹´\nèä¸: è½¯ä»¶å¼åå·¥ç¨å¸\nç®å: å¨æåæ¬ç ä¸­~"},{property:"og:url",content:"https://www.zhengwenfeng.com/08.%E5%85%B3%E4%BA%8E/01.%E5%85%B3%E4%BA%8E.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2019-12-25T14:27:01.000Z"},{itemprop:"name",content:"å³äº"},{itemprop:"description",content:"å·¥ä½å¹´é: 5å¹´\nèä¸: è½¯ä»¶å¼åå·¥ç¨å¸\nç®å: å¨æåæ¬ç ä¸­~"}],readingShow:"top"},regularPath:"/08.%E5%85%B3%E4%BA%8E/01.%E5%85%B3%E4%BA%8E.html",relativePath:"08.å³äº/01.å³äº.md",key:"v-c5fbc8ae",path:"/about/",headers:[{level:2,title:"å³äºåä¸»",slug:"å³äºåä¸»",normalizedTitle:"å³äºåä¸»",charIndex:2},{level:3,title:"æè½æ¸å",slug:"æè½æ¸å",normalizedTitle:"æè½æ¸å",charIndex:54},{level:3,title:"âï¸ èç³»",slug:"èç³»",normalizedTitle:"âï¸ èç³»",charIndex:159},{level:2,title:"å³äºæ¬ç«",slug:"å³äºæ¬ç«",normalizedTitle:"å³äºæ¬ç«",charIndex:396},{level:3,title:"åå®¢åç¨",slug:"åå®¢åç¨",normalizedTitle:"åå®¢åç¨",charIndex:425}],headersStr:"å³äºåä¸» æè½æ¸å âï¸ èç³» å³äºæ¬ç« åå®¢åç¨",content:"# å³äºåä¸»\n\n * å·¥ä½å¹´é: 5å¹´\n * èä¸: è½¯ä»¶å¼åå·¥ç¨å¸\n * ç®å: å¨æåæ¬ç ä¸­~\n\n\n# æè½æ¸å\n\n * ç¼ç¨è¯­è¨: python/go\n * webæ¡æ¶: django/flask/gin\n * æ°æ®åº: mysql/redis/mongo/es\n * å®¹å¨ææ¯: docker/k8s\n\n\n# âï¸ èç³»\n\n * WeChat or QQ: {{ QQ }}\n * Email: zhengwenfeng37@gmail.com\n * GitHub: https://github.com/tenqaz\n * CSDN: https://blog.csdn.net/qq_22918243\n * å¾®åï¼https://weibo.com/u/3983876297\n * Twitter(X)ï¼https://twitter.com/wenfeng_zheng\n\n\n# å³äºæ¬ç«\n\nç¨æ¥è®°å½æ¬äººå­¦ä¹ ãæèåçæ´»ççåå®¢\n\n\n# åå®¢åç¨\n\n * 2023-01-15\n\n> æ·»å äºwalineçè¯è®ºç³»ç»ï¼æ¹ä¾¿è®¨è®ºäº¤æµé®é¢ã\n\n * 2022-08-07\n\n> å³å®éç¨vuepressä½ä¸ºä¸ªäººåå®¢çææ¯æ¡æ¶ï¼å¹¶å¼å§å­¦ä¹ æ­å»ºã",normalizedContent:"# å³äºåä¸»\n\n * å·¥ä½å¹´é: 5å¹´\n * èä¸: è½¯ä»¶å¼åå·¥ç¨å¸\n * ç®å: å¨æåæ¬ç ä¸­~\n\n\n# æè½æ¸å\n\n * ç¼ç¨è¯­è¨: python/go\n * webæ¡æ¶: django/flask/gin\n * æ°æ®åº: mysql/redis/mongo/es\n * å®¹å¨ææ¯: docker/k8s\n\n\n# âï¸ èç³»\n\n * wechat or qq: {{ qq }}\n * email: zhengwenfeng37@gmail.com\n * github: https://github.com/tenqaz\n * csdn: https://blog.csdn.net/qq_22918243\n * å¾®åï¼https://weibo.com/u/3983876297\n * twitter(x)ï¼https://twitter.com/wenfeng_zheng\n\n\n# å³äºæ¬ç«\n\nç¨æ¥è®°å½æ¬äººå­¦ä¹ ãæèåçæ´»ççåå®¢\n\n\n# åå®¢åç¨\n\n * 2023-01-15\n\n> æ·»å äºwalineçè¯è®ºç³»ç»ï¼æ¹ä¾¿è®¨è®ºäº¤æµé®é¢ã\n\n * 2022-08-07\n\n> å³å®éç¨vuepressä½ä¸ºä¸ªäººåå®¢çææ¯æ¡æ¶ï¼å¹¶å¼å§å­¦ä¹ æ­å»ºã",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"ç½ç«",frontmatter:{title:"ç½ç«",permalink:"/pages/beb6c0bd8a66cea6/",date:"2020-04-19T11:33:04.000Z",article:!1,author:{name:"xugaoyi",link:"https://github.com/xugaoyi"},description:"k8s k8sä¸­æå®ç½\nvuepress-theme-vdoing ä¸æ¬¾ä¼ç§çåå®¢ä¸»é¢\nææ¯æç« æå½\nä»£ç çæ®µ å¿«éæ¥çæä¸é¨ææ¯çä»£ç çæ®µ",comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"ç½ç«"},{name:"twitter:description",content:"k8s k8sä¸­æå®ç½\nvuepress-theme-vdoing ä¸æ¬¾ä¼ç§çåå®¢ä¸»é¢\nææ¯æç« æå½\nä»£ç çæ®µ å¿«éæ¥çæä¸é¨ææ¯çä»£ç çæ®µ"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/09.%E6%9B%B4%E5%A4%9A/01.%E6%94%B6%E8%97%8F.html"},{property:"og:type",content:"article"},{property:"og:title",content:"ç½ç«"},{property:"og:description",content:"k8s k8sä¸­æå®ç½\nvuepress-theme-vdoing ä¸æ¬¾ä¼ç§çåå®¢ä¸»é¢\nææ¯æç« æå½\nä»£ç çæ®µ å¿«éæ¥çæä¸é¨ææ¯çä»£ç çæ®µ"},{property:"og:url",content:"https://www.zhengwenfeng.com/09.%E6%9B%B4%E5%A4%9A/01.%E6%94%B6%E8%97%8F.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2020-04-19T11:33:04.000Z"},{itemprop:"name",content:"ç½ç«"},{itemprop:"description",content:"k8s k8sä¸­æå®ç½\nvuepress-theme-vdoing ä¸æ¬¾ä¼ç§çåå®¢ä¸»é¢\nææ¯æç« æå½\nä»£ç çæ®µ å¿«éæ¥çæä¸é¨ææ¯çä»£ç çæ®µ"}],readingShow:"top"},regularPath:"/09.%E6%9B%B4%E5%A4%9A/01.%E6%94%B6%E8%97%8F.html",relativePath:"09.æ´å¤/01.æ¶è.md",key:"v-fe55c380",path:"/pages/beb6c0bd8a66cea6/",headers:[{level:2,title:"ææ¡£",slug:"ææ¡£",normalizedTitle:"ææ¡£",charIndex:12},{level:2,title:"golang",slug:"golang",normalizedTitle:"golang",charIndex:103},{level:2,title:"åå®¢",slug:"åå®¢",normalizedTitle:"åå®¢",charIndex:61},{level:2,title:"ç¤¾åº",slug:"ç¤¾åº",normalizedTitle:"ç¤¾åº",charIndex:324},{level:2,title:"æå·§",slug:"æå·§",normalizedTitle:"æå·§",charIndex:476},{level:2,title:"è§é¢",slug:"è§é¢",normalizedTitle:"è§é¢",charIndex:564},{level:2,title:"ç®æ³",slug:"ç®æ³",normalizedTitle:"ç®æ³",charIndex:727},{level:2,title:"å·¥å·",slug:"å·¥å·",normalizedTitle:"å·¥å·",charIndex:747},{level:2,title:"å¨±ä¹",slug:"å¨±ä¹",normalizedTitle:"å¨±ä¹",charIndex:886}],headersStr:"ææ¡£ golang åå®¢ ç¤¾åº æå·§ è§é¢ ç®æ³ å·¥å· å¨±ä¹",content:"# ä¸ªäººæ¶èå¤¹\n\n\n# ææ¡£\n\n * k8s k8sä¸­æå®ç½\n * vuepress-theme-vdoing ä¸æ¬¾ä¼ç§çåå®¢ä¸»é¢\n * ææ¯æç« æå½\n * ä»£ç çæ®µ å¿«éæ¥çæä¸é¨ææ¯çä»£ç çæ®µ\n\n\n# golang\n\n * hotexamples golangä»£ç ç¤ºä¾ç½ç«\n\n\n# åå®¢\n\n * é®ä¸å³°çç½ç»æ¥å¿\n * é¦ä¸ä¸çææ¯ä¸æ \n * ITç å\n * æå¥\n * å´åºæ\n * é·å£³\n * çç»ç§-DKåå®¢\n * äºä¸«è®²æ¢µ\n * Crayonã®åå®¢\n * Tushar's Blog ä¸ä¸ªå½å¤pythonç¨åºåçåå®¢ï¼æè§ä¸é\n * åæ¢äºåç\n * simpleprogrammer ãè½¯æè½-ä»£ç ä¹å¤ççå­æåãä½èçåå®¢\n\n\n# ç¤¾åº\n\n * Github ç¨åºååæ§äº¤åç¤¾åº\n * æé ä¸ä¸ªå¸®å©å¼åèæé¿çç¤¾åº\n * ç®ä¹¦ æå¾å¤é¢éçåä½ç¤¾åº\n * æå¦ è§£å³ææ¯é®é¢çç¤¾åº\n * stack overflow åä¸ï¼å¤ç½ç\n * InfoQ ä¿è¿è½¯ä»¶å¼ååç¸å³é¢åç¥è¯ä¸åæ°çä¼ æ­\n * V2EX åæå·¥ä½èä»¬çç¤¾åº\n\n\n# æå·§\n\n * Google è¶å¿ æ¥çæé¡¹ææ¯æå³é®å­çç­åº¦è¶å¿ï¼å¯ç¨äºåææé¡¹ææ¯çåå±åæ¯ï¼æå¯¹æ¯æä¸¤é¡¹ææ¯çç­åº¦ã\n * ç¾åº¦ææ° åä¸ï¼ä½ç¾åº¦çæ°æ®ä»éå½åã\n\n\n# è§é¢\n\n * bilibili Bç«ï¼ä¸é¢å¾å¤åè´¹æå­¦è§é¢\n * æè¯¾ç½ å®æè§é¢æç¨\n * å¦å³è¯¾å  æ¯è¾ç³»ç»çåç«¯å¥é¨è§é¢æç¨\n * ä¸­å½å¤§å­¦MOOC æ¶µçè®¡ç®æºãå¤è¯­ãå¿çå­¦ç­ä¸ä¸åè´¹è¯¾ç¨\n * ç»èº«æè²å¹³å° æ¶µççæ´»ãå´è¶£ãèåºãæè½ãèå¹´ãå­¦åç­åè´¹è¯¾ç¨\n * egghead è´¨éè¿ä¸éçç­è§é¢æç¨ï¼å¤ç½\n\n\n# ç®æ³\n\n * leetcode\n\n\n# å·¥å·\n\n * å¾®ä¿¡markdownç¼è¾å¨\n * ossinsight å¯ä»¥çå°githubä¸ç¨æ·æèä»åºçæ°æ®ææ \n * feeddd å¾®ä¿¡å¬ä¼å·çRSSè®¢éæº\n * ChatGPT èå¤©æºè½AIæå¡ï¼å¯ä»¥èªå¨åä»£ç ã\n * corrector ä¸æ¬¾åè´¹çä¸­æçº éæå¡\n\n\n# å¨±ä¹\n\n * ä¸­ææ­å®¢æ¦\n * å¼å¸¸æç¨ å·¥å·ç ´è§£ç½ç«",normalizedContent:"# ä¸ªäººæ¶èå¤¹\n\n\n# ææ¡£\n\n * k8s k8sä¸­æå®ç½\n * vuepress-theme-vdoing ä¸æ¬¾ä¼ç§çåå®¢ä¸»é¢\n * ææ¯æç« æå½\n * ä»£ç çæ®µ å¿«éæ¥çæä¸é¨ææ¯çä»£ç çæ®µ\n\n\n# golang\n\n * hotexamples golangä»£ç ç¤ºä¾ç½ç«\n\n\n# åå®¢\n\n * é®ä¸å³°çç½ç»æ¥å¿\n * é¦ä¸ä¸çææ¯ä¸æ \n * itç å\n * æå¥\n * å´åºæ\n * é·å£³\n * çç»ç§-dkåå®¢\n * äºä¸«è®²æ¢µ\n * crayonã®åå®¢\n * tushar's blog ä¸ä¸ªå½å¤pythonç¨åºåçåå®¢ï¼æè§ä¸é\n * åæ¢äºåç\n * simpleprogrammer ãè½¯æè½-ä»£ç ä¹å¤ççå­æåãä½èçåå®¢\n\n\n# ç¤¾åº\n\n * github ç¨åºååæ§äº¤åç¤¾åº\n * æé ä¸ä¸ªå¸®å©å¼åèæé¿çç¤¾åº\n * ç®ä¹¦ æå¾å¤é¢éçåä½ç¤¾åº\n * æå¦ è§£å³ææ¯é®é¢çç¤¾åº\n * stack overflow åä¸ï¼å¤ç½ç\n * infoq ä¿è¿è½¯ä»¶å¼ååç¸å³é¢åç¥è¯ä¸åæ°çä¼ æ­\n * v2ex åæå·¥ä½èä»¬çç¤¾åº\n\n\n# æå·§\n\n * google è¶å¿ æ¥çæé¡¹ææ¯æå³é®å­çç­åº¦è¶å¿ï¼å¯ç¨äºåææé¡¹ææ¯çåå±åæ¯ï¼æå¯¹æ¯æä¸¤é¡¹ææ¯çç­åº¦ã\n * ç¾åº¦ææ° åä¸ï¼ä½ç¾åº¦çæ°æ®ä»éå½åã\n\n\n# è§é¢\n\n * bilibili bç«ï¼ä¸é¢å¾å¤åè´¹æå­¦è§é¢\n * æè¯¾ç½ å®æè§é¢æç¨\n * å¦å³è¯¾å  æ¯è¾ç³»ç»çåç«¯å¥é¨è§é¢æç¨\n * ä¸­å½å¤§å­¦mooc æ¶µçè®¡ç®æºãå¤è¯­ãå¿çå­¦ç­ä¸ä¸åè´¹è¯¾ç¨\n * ç»èº«æè²å¹³å° æ¶µççæ´»ãå´è¶£ãèåºãæè½ãèå¹´ãå­¦åç­åè´¹è¯¾ç¨\n * egghead è´¨éè¿ä¸éçç­è§é¢æç¨ï¼å¤ç½\n\n\n# ç®æ³\n\n * leetcode\n\n\n# å·¥å·\n\n * å¾®ä¿¡markdownç¼è¾å¨\n * ossinsight å¯ä»¥çå°githubä¸ç¨æ·æèä»åºçæ°æ®ææ \n * feeddd å¾®ä¿¡å¬ä¼å·çrssè®¢éæº\n * chatgpt èå¤©æºè½aiæå¡ï¼å¯ä»¥èªå¨åä»£ç ã\n * corrector ä¸æ¬¾åè´¹çä¸­æçº éæå¡\n\n\n# å¨±ä¹\n\n * ä¸­ææ­å®¢æ¦\n * å¼å¸¸æç¨ å·¥å·ç ´è§£ç½ç«",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"åé¾",frontmatter:{title:"åé¾",date:"2022-10-30T20:28:03.000Z",permalink:"/friends",categories:["æ´å¤"],tags:[null],author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"desc: ä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n  avatar: https://blog.wenfxl.com/images/logo.png\n  link: https://blog.wenfxl.com/\n:::",article:!1,comment:!0,feed:{enable:!0},meta:[{name:"twitter:title",content:"åé¾"},{name:"twitter:description",content:"desc: ä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n  avatar: https://blog.wenfxl.com/images/logo.png\n  link: https://blog.wenfxl.com/\n:::"},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/09.%E6%9B%B4%E5%A4%9A/02.%E5%8F%8B%E9%93%BE.html"},{property:"og:type",content:"article"},{property:"og:title",content:"åé¾"},{property:"og:description",content:"desc: ä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n  avatar: https://blog.wenfxl.com/images/logo.png\n  link: https://blog.wenfxl.com/\n:::"},{property:"og:url",content:"https://www.zhengwenfeng.com/09.%E6%9B%B4%E5%A4%9A/02.%E5%8F%8B%E9%93%BE.html"},{property:"og:site_name",content:"zhengwenfeng"},{property:"article:published_time",content:"2022-10-30T20:28:03.000Z"},{property:"article:tag",content:null},{itemprop:"name",content:"åé¾"},{itemprop:"description",content:"desc: ä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n  avatar: https://blog.wenfxl.com/images/logo.png\n  link: https://blog.wenfxl.com/\n:::"}],readingShow:"top"},regularPath:"/09.%E6%9B%B4%E5%A4%9A/02.%E5%8F%8B%E9%93%BE.html",relativePath:"09.æ´å¤/02.åé¾.md",key:"v-67feae3c",path:"/friends/",headers:[{level:2,title:"åé¾ç³è¯·",slug:"åé¾ç³è¯·",normalizedTitle:"åé¾ç³è¯·",charIndex:1954}],headersStr:"åé¾ç³è¯·",content:"éæå³°çåå®¢\n\næé»é,å¤æ­»å¯ç£\n\nEvan's blog\n\nç§¯è·¬æ­¥ä»¥è³åéï¼åæ¬¢å­¦ä¹ åæ¬¢ä½ ã\n\näºä¸«è®²æ¢µ\n\nð»å­¦ä¹ ðè®°å½ðåäº«\n\néºé¹¿é²å\n\nå¤§éè³ç®ï¼ç¥æè¡é¾ã\n\nCrayonã®åå®¢\n\nç¨åºç¿ && äºæ¬¡ç¿\n\nCase of Xeon\n\nWelcome inside\n\nè¥ç«åå®¢\n\nææ¯æ¹åçæ´»\n\nmqray's blog\n\nææ¥å¤ææ¥ï¼ææ¥ä½å¶å¤ï¼\n\næ±å¡é­æ³å±\n\næ¬¢è¿æè¡èï¼æ¥å°è¿ä¸ªå¹³å¡ä½åè®°è½½äºè®¸å¤æäºçå°å±\n\nèæ¸¡\n\nå¼åæ¥å¸¸\n\nè½©çµåå®¢\n\nä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n\n- name: éæå³°çåå®¢\n  desc: 'æé»é,å¤æ­»å¯ç£'\n  avatar: https://www.zhengwenfeng.com/img/me.jpg\n  link: https://www.zhengwenfeng.com\n  bgColor: '#f8f9fa'\n- name: Evan's blog # æµç§°\n  desc: ç§¯è·¬æ­¥ä»¥è³åéï¼åæ¬¢å­¦ä¹ åæ¬¢ä½ ã # ä»ç»\n  avatar: https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200103123203.jpg # å¤´å\n  link: https://xugaoyi.com/  # é¾æ¥\n  bgColor: '#f8f9fa'\n- name: äºä¸«è®²æ¢µ\n  desc: 'ð»å­¦ä¹ ðè®°å½ðåäº«'\n  avatar: https://wiki.eryajf.net/img/logo.png\n  link: https://wiki.eryajf.net\n  bgColor: '#f8f9fa'\n- name: éºé¹¿é²å\n  desc: 'å¤§éè³ç®ï¼ç¥æè¡é¾ã'\n  avatar: https://pic.cnblogs.com/avatar/1273193/20190806180831.png\n  link: https://www.cnblogs.com/miluluyo/\n  bgColor: '#f8f9fa'\n- name: Crayonã®åå®¢\n  desc: 'ç¨åºç¿ && äºæ¬¡ç¿'\n  avatar: http://sucrayon.top/images/avatar.jpg\n  link: http://sucrayon.top/\n  bgColor: '#f8f9fa'\n- name: Case of Xeon\n  desc: 'Welcome inside'\n  avatar: https://hexo.chensmallx.top/img/avator.jpg\n  link: https://hexo.chensmallx.top/\n  bgColor: '#f8f9fa'\n- name: è¥ç«åå®¢\n  desc: ææ¯æ¹åçæ´»\n  avatar: http://blog.mryxh.cn/favicon.ico\n  link: http://blog.mryxh.cn/\n  bgColor: '#f8f9fa'\n- name: mqray's blog\n  desc: ææ¥å¤ææ¥ï¼ææ¥ä½å¶å¤ï¼\n  avatar: https://mqrayblog.cn/img/avatar.png\n  link: https://mqrayblog.cn/\n- name: æ±å¡é­æ³å±\n  desc: æ¬¢è¿æè¡èï¼æ¥å°è¿ä¸ªå¹³å¡ä½åè®°è½½äºè®¸å¤æäºçå°å±\n  avatar: https://blog.storical.space/images/icon.png\n  link: https://blog.storical.space/\n- name: èæ¸¡\n  desc: å¼åæ¥å¸¸\n  avatar: https://www.lllomh.com/static/images/photos.jpg\n  link: https://www.lllomh.com/\n- name: è½©çµåå®¢\n  desc: ä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n  avatar: https://blog.wenfxl.com/images/logo.png\n  link: https://blog.wenfxl.com/\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n\n\n\n# åé¾ç³è¯·\n\nç³è¯·åè®°å¾åæ·»å æ¬ç«å¦~\n\n * æ¹æ³ä¸\n\nä¸æ èç³» æè å¨æ¬é¡µé¢è¯è®ºåºçè¨æ¨çåé¾ä¿¡æ¯ï¼æ ¼å¼ï¼(ç¹å»ä»£ç åå³ä¸è§ä¸é®å¤å¶)\n\n- name: éæå³°çåå®¢ # æµç§°\n  desc:  æé»é,å¤æ­»å¯ç£ # ä»ç»\n  avatar: https://www.zhengwenfeng.com/img/me.jpg # å¤´å\n  link: https://www.zhengwenfeng.com  # é¾æ¥\n\n\n1\n2\n3\n4\n\n * æ¹æ³äº\n\nforkæ¬é¡¹ç®,å¨docs/æ´å¤/åé¾.mdæä»¶ä¸­ï¼æ°å¢èªå·±çåé¾ï¼ç¶åæäº¤PRå³å¯ã",normalizedContent:"éæå³°çåå®¢\n\næé»é,å¤æ­»å¯ç£\n\nevan's blog\n\nç§¯è·¬æ­¥ä»¥è³åéï¼åæ¬¢å­¦ä¹ åæ¬¢ä½ ã\n\näºä¸«è®²æ¢µ\n\nð»å­¦ä¹ ðè®°å½ðåäº«\n\néºé¹¿é²å\n\nå¤§éè³ç®ï¼ç¥æè¡é¾ã\n\ncrayonã®åå®¢\n\nç¨åºç¿ && äºæ¬¡ç¿\n\ncase of xeon\n\nwelcome inside\n\nè¥ç«åå®¢\n\nææ¯æ¹åçæ´»\n\nmqray's blog\n\nææ¥å¤ææ¥ï¼ææ¥ä½å¶å¤ï¼\n\næ±å¡é­æ³å±\n\næ¬¢è¿æè¡èï¼æ¥å°è¿ä¸ªå¹³å¡ä½åè®°è½½äºè®¸å¤æäºçå°å±\n\nèæ¸¡\n\nå¼åæ¥å¸¸\n\nè½©çµåå®¢\n\nä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n\n- name: éæå³°çåå®¢\n  desc: 'æé»é,å¤æ­»å¯ç£'\n  avatar: https://www.zhengwenfeng.com/img/me.jpg\n  link: https://www.zhengwenfeng.com\n  bgcolor: '#f8f9fa'\n- name: evan's blog # æµç§°\n  desc: ç§¯è·¬æ­¥ä»¥è³åéï¼åæ¬¢å­¦ä¹ åæ¬¢ä½ ã # ä»ç»\n  avatar: https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200103123203.jpg # å¤´å\n  link: https://xugaoyi.com/  # é¾æ¥\n  bgcolor: '#f8f9fa'\n- name: äºä¸«è®²æ¢µ\n  desc: 'ð»å­¦ä¹ ðè®°å½ðåäº«'\n  avatar: https://wiki.eryajf.net/img/logo.png\n  link: https://wiki.eryajf.net\n  bgcolor: '#f8f9fa'\n- name: éºé¹¿é²å\n  desc: 'å¤§éè³ç®ï¼ç¥æè¡é¾ã'\n  avatar: https://pic.cnblogs.com/avatar/1273193/20190806180831.png\n  link: https://www.cnblogs.com/miluluyo/\n  bgcolor: '#f8f9fa'\n- name: crayonã®åå®¢\n  desc: 'ç¨åºç¿ && äºæ¬¡ç¿'\n  avatar: http://sucrayon.top/images/avatar.jpg\n  link: http://sucrayon.top/\n  bgcolor: '#f8f9fa'\n- name: case of xeon\n  desc: 'welcome inside'\n  avatar: https://hexo.chensmallx.top/img/avator.jpg\n  link: https://hexo.chensmallx.top/\n  bgcolor: '#f8f9fa'\n- name: è¥ç«åå®¢\n  desc: ææ¯æ¹åçæ´»\n  avatar: http://blog.mryxh.cn/favicon.ico\n  link: http://blog.mryxh.cn/\n  bgcolor: '#f8f9fa'\n- name: mqray's blog\n  desc: ææ¥å¤ææ¥ï¼ææ¥ä½å¶å¤ï¼\n  avatar: https://mqrayblog.cn/img/avatar.png\n  link: https://mqrayblog.cn/\n- name: æ±å¡é­æ³å±\n  desc: æ¬¢è¿æè¡èï¼æ¥å°è¿ä¸ªå¹³å¡ä½åè®°è½½äºè®¸å¤æäºçå°å±\n  avatar: https://blog.storical.space/images/icon.png\n  link: https://blog.storical.space/\n- name: èæ¸¡\n  desc: å¼åæ¥å¸¸\n  avatar: https://www.lllomh.com/static/images/photos.jpg\n  link: https://www.lllomh.com/\n- name: è½©çµåå®¢\n  desc: ä¸ä¸ªä¸æ³¨äºèç½ææ¯åäº«çä¸ªäººç¬ç«åå®¢ã\n  avatar: https://blog.wenfxl.com/images/logo.png\n  link: https://blog.wenfxl.com/\n\n\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n\n\n\n# åé¾ç³è¯·\n\nç³è¯·åè®°å¾åæ·»å æ¬ç«å¦~\n\n * æ¹æ³ä¸\n\nä¸æ èç³» æè å¨æ¬é¡µé¢è¯è®ºåºçè¨æ¨çåé¾ä¿¡æ¯ï¼æ ¼å¼ï¼(ç¹å»ä»£ç åå³ä¸è§ä¸é®å¤å¶)\n\n- name: éæå³°çåå®¢ # æµç§°\n  desc:  æé»é,å¤æ­»å¯ç£ # ä»ç»\n  avatar: https://www.zhengwenfeng.com/img/me.jpg # å¤´å\n  link: https://www.zhengwenfeng.com  # é¾æ¥\n\n\n1\n2\n3\n4\n\n * æ¹æ³äº\n\nforkæ¬é¡¹ç®,å¨docs/æ´å¤/åé¾.mdæä»¶ä¸­ï¼æ°å¢èªå·±çåé¾ï¼ç¶åæäº¤prå³å¯ã",charsets:{cjk:!0},lastUpdated:"2025/02/09, 23:47:02",lastUpdatedTimestamp:1739116022e3},{title:"å½æ¡£",frontmatter:{archivesPage:!0,title:"å½æ¡£",permalink:"/archives/",article:!1,description:"",meta:[{name:"twitter:title",content:"å½æ¡£"},{name:"twitter:description",content:""},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/@pages/archivesPage.html"},{property:"og:type",content:"article"},{property:"og:title",content:"å½æ¡£"},{property:"og:description",content:""},{property:"og:url",content:"https://www.zhengwenfeng.com/@pages/archivesPage.html"},{property:"og:site_name",content:"zhengwenfeng"},{itemprop:"name",content:"å½æ¡£"},{itemprop:"description",content:""}],readingShow:"top"},regularPath:"/@pages/archivesPage.html",relativePath:"@pages/archivesPage.md",key:"v-31af7045",path:"/archives/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2022/08/09, 07:53:30",lastUpdatedTimestamp:166000281e4},{title:"æ ç­¾",frontmatter:{tagsPage:!0,title:"æ ç­¾",permalink:"/tags/",article:!1,description:"",meta:[{name:"twitter:title",content:"æ ç­¾"},{name:"twitter:description",content:""},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/@pages/tagsPage.html"},{property:"og:type",content:"article"},{property:"og:title",content:"æ ç­¾"},{property:"og:description",content:""},{property:"og:url",content:"https://www.zhengwenfeng.com/@pages/tagsPage.html"},{property:"og:site_name",content:"zhengwenfeng"},{itemprop:"name",content:"æ ç­¾"},{itemprop:"description",content:""}],readingShow:"top"},regularPath:"/@pages/tagsPage.html",relativePath:"@pages/tagsPage.md",key:"v-36a595c5",path:"/tags/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2022/08/09, 07:53:30",lastUpdatedTimestamp:166000281e4},{title:"Home",frontmatter:{home:!0,heroText:"éæå³°çåå®¢",tagline:"æé»é,å¤æ­»å¯ç£ã",hideRightBar:!1,description:"ææ¯åå®¢ï¼ä¸æ³¨äºåç«¯å­¦ä¹ ä¸æ»ç»ï¼python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdownç­ææ¯ç±»æç« ",meta:[{name:"image",content:"https://www.zhengwenfeng.com/img/panda-waving.png"},{name:"twitter:title",content:"éæå³°çåå®¢"},{name:"twitter:description",content:"ææ¯åå®¢ï¼ä¸æ³¨äºåç«¯å­¦ä¹ ä¸æ»ç»ï¼python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdownç­ææ¯ç±»æç« "},{name:"twitter:card",content:"summary_large_image"},{name:"twitter:image",content:"https://www.zhengwenfeng.com/img/panda-waving.png"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/"},{property:"og:type",content:"website"},{property:"og:title",content:"éæå³°çåå®¢"},{property:"og:description",content:"ææ¯åå®¢ï¼ä¸æ³¨äºåç«¯å­¦ä¹ ä¸æ»ç»ï¼python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdownç­ææ¯ç±»æç« "},{property:"og:image",content:"https://www.zhengwenfeng.com/img/panda-waving.png"},{property:"og:url",content:"https://www.zhengwenfeng.com/"},{property:"og:site_name",content:"zhengwenfeng"},{itemprop:"name",content:"éæå³°çåå®¢"},{itemprop:"description",content:"ææ¯åå®¢ï¼ä¸æ³¨äºåç«¯å­¦ä¹ ä¸æ»ç»ï¼python,go,redis,k8s,mysql,kafka,flask,django,tornado,git,github,markdownç­ææ¯ç±»æç« "},{itemprop:"image",content:"https://www.zhengwenfeng.com/img/panda-waving.png"}],readingShow:"top"},regularPath:"/",relativePath:"index.md",key:"v-1e8d1344",path:"/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2022/10/31, 21:57:05",lastUpdatedTimestamp:1667224625e3},{title:"åç±»",frontmatter:{categoriesPage:!0,title:"åç±»",permalink:"/categories/",article:!1,description:"",meta:[{name:"twitter:title",content:"åç±»"},{name:"twitter:description",content:""},{name:"twitter:card",content:"summary"},{name:"twitter:url",content:"https://www.zhengwenfeng.com/@pages/categoriesPage.html"},{property:"og:type",content:"article"},{property:"og:title",content:"åç±»"},{property:"og:description",content:""},{property:"og:url",content:"https://www.zhengwenfeng.com/@pages/categoriesPage.html"},{property:"og:site_name",content:"zhengwenfeng"},{itemprop:"name",content:"åç±»"},{itemprop:"description",content:""}],readingShow:"top"},regularPath:"/@pages/categoriesPage.html",relativePath:"@pages/categoriesPage.md",key:"v-5cc30ba5",path:"/categories/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2022/08/09, 07:53:30",lastUpdatedTimestamp:166000281e4}],themeConfig:{nav:[{text:"é¦é¡µ",link:"/"},{text:"ä¸é¢",items:[{text:"Goè¯­è¨é«æ§è½ç¼ç¨",link:"/go_performance/"},{text:"Bug éç¼ä»¤",link:"/bug_hunt/"}]},{text:"åç±»",link:"/categories/"},{text:"æ ç­¾",link:"/tags/"},{text:"å½æ¡£",link:"/archives/"},{text:"å³äº",link:"/about/"},{text:"æçå·¥å·",items:[{text:"å¯¼èª",link:"https://nav.zhengwenfeng.com/"},{text:"ä»£ç çæ®µ",link:"https://ref.zhengwenfeng.com/"}]},{text:"æ´å¤",link:"/more/",items:[{text:"æ¶è",link:"/pages/beb6c0bd8a66cea6/"},{text:"åé¾",link:"/friends/"},{text:"å¤é¨é¡µé¢",items:[{text:"å¼å¾",link:"https://www.travellings.cn/go.html"}]}]}],sidebarDepth:3,logo:"/img/me.jpg",repo:"tenqaz/tenqaz.github.io",searchMaxSuggestions:10,lastUpdated:"ä¸æ¬¡æ´æ°",docsDir:"docs",editLinks:!1,searchPlaceholder:"æä¸ ðº æç´¢",sidebar:{"/00.ç®å½é¡µ/":[["01.Goè¯­è¨é«æ§è½ç¼ç¨.md","Goè¯­è¨é«æ§è½ç¼ç¨","/go_performance/"],["02.Bug éç¼ä»¤.md","Bug éç¼ä»¤","/bug_hunt/"]],catalogue:{"Goè¯­è¨é«æ§è½ç¼ç¨":"/go_performance/","Bug éç¼ä»¤":"/bug_hunt/"},"/01.äºåç/":[{title:"docker",collapsable:!0,children:[["06.docker/01.å®¹å¨çæ¬è´¨.md","å®¹å¨çæ¬è´¨","/pages/f3cf17/"],["06.docker/02.dockerå®¹å¨.md","dockerå®¹å¨","/pages/39f36e/"],["06.docker/03.æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å.md","æå¨å®ç°dockerå®¹å¨bridgeç½ç»æ¨¡å","/pages/d3768c/"],["06.docker/04.dockerå®¹å¨åæºç½ç».md","dockerå®¹å¨åæºç½ç»","/pages/0ddeb7/"]]},{title:"k8s",collapsable:!0,children:[["07.k8s/03.k8sä¹pod.md","k8sä¹Pod","/pages/2b547f/"],["07.k8s/04.k8sä¹deployment.md","k8sä¹Deployment","/pages/d73c88/"],["07.k8s/05.k8sä¹service.md","k8sä¹Service","/pages/1f860b/"],["07.k8s/06.k8sä¹ConfigMapåSecret.md","k8sä¹ConfigMapåSecret","/pages/ff8188/"],["07.k8s/07.k8sä¹JobåCronJob.md","k8sä¹JobåCronJob","/pages/c96905/"],["07.k8s/08.k8sä¹DaemonSet.md","k8sä¹DaemonSet","/pages/92bee4/"],["07.k8s/09.k8sä¹PVãPVCåStorageClass.md","k8sä¹PVãPVCåStorageClass","/pages/095c75/"],["07.k8s/10.k8sä¹StatefulSet.md","k8sä¹StatefulSet","/pages/d178a2/"],["07.k8s/11.ä½¿ç¨kubeadmå®è£k8s.md","ä½¿ç¨kubeadmå®è£k8s","/pages/9e17c8/"],["07.k8s/12.podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦».md","podä¸­å°ä»£ç ä¸è¿è¡ç¯å¢åç¦»","/pages/27987d/"],["07.k8s/13.djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§.md","djangoåç«¯æå¡ãlogstashåflinkæ¥å¥VictoriaMetricsææ çæ§","/pages/b1b4a3/"],["07.k8s/14.çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç.md","çè§£flannelçä¸ç§å®¹å¨ç½ç»æ¹æ¡åç","/pages/d9d0ce/"],["07.k8s/15.çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç.md","çè§£calicoå®¹å¨ç½ç»éä¿¡æ¹æ¡åç","/pages/f0f725/"],["07.k8s/16.kubernetes serviceå¦ä½éè¿iptablesè½¬å.md","kubernetes serviceå¦ä½éè¿iptablesè½¬å","/pages/b3955c/"],["07.k8s/17.kube-proxyæºç åæ.md","kube-proxyæºç åæ","/pages/6e0045/"]]}],"/02.Bug éç¼ä»¤/":[["01.ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥.md","ä¸æ¬¡æå¡åçº§æ¶pgè¡¨DDLæ§è¡è¶æ¶å¤±è´¥","/pages/cf65ba/"],["02.æå¡å¯å¨æ¶åºç° OOM.md","æå¡å¯å¨æ¶åºç° OOM","/pages/de98b1/"]],"/03.ä¸­é´ä»¶/":[{title:"kafka",collapsable:!0,children:[["01.kafka/01.listeneråadvertised.listenersçä½ç¨.md","kafkaä¸­listeneråadvertised.listenersçä½ç¨","/pages/fa114f/"]]},{title:"mysql",collapsable:!0,children:[["03.mysql/01.mysqlä¹æ¥å¿.md","mysqlä¹æ¥å¿","/pages/2d69c7/"],["03.mysql/02.mysqlä¹MVCCåç.md","mysqlä¹MVCCåç","/pages/0d8f4a/"]]},{title:"redis",collapsable:!0,children:[["05.redis/01.redisä¹äºç§åºæ¬æ°æ®ç±»å.md","redisä¹äºç§åºæ¬æ°æ®ç±»å","/pages/2bbeb3/"],["05.redis/02.redisä¹æä¹å.md","redisä¹æä¹å","/pages/4c6b13/"],["05.redis/03. redisä¹ä¸»ä»åºåæ­¥.md","redisä¹ä¸»ä»åºåæ­¥","/pages/8072eb/"],["05.redis/04. redisä¹å¨åµæºå¶.md","redisä¹å¨åµæºå¶","/pages/ffee9e/"],["05.redis/05. redisä¹åçéç¾¤.md","redisä¹åçéç¾¤","/pages/1c2914/"],["05.redis/06. redisä¹ç¼å­.md","redisä¹ç¼å­","/pages/0d7b25/"]]},{title:"logstash",collapsable:!0,children:[["06.logstash/01.pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿.md","pulsaré»å¡å¯¼è´logstashæ æ³æ¥å¥æ¥å¿","/pages/adedbd/"]]}],"/04.ç¼ç¨/":[{title:"python",collapsable:!0,children:[{title:"åºç¡",collapsable:!0,children:[["01.python/01.åºç¡/01.pythonè¿­ä»£å¨ä¸çæå¨.md","pythonè¿­ä»£å¨ä¸çæå¨","/pages/e31b06/"],["01.python/01.åºç¡/02.pythonåç¼ç¨.md","pythonåç¼ç¨","/pages/5fa368/"],["01.python/01.åºç¡/03.pythonåå¾åæ¶æºå¶.md","pythonåå¾åæ¶æºå¶","/pages/78c648/"],["01.python/01.åºç¡/04.pythonä¸ä¸æç®¡çå¨.md","pythonä¸ä¸æç®¡çå¨","/pages/a6b804/"],["01.python/01.åºç¡/05.pythonè£é¥°å¨çä½¿ç¨æ¹æ³.md","pythonè£é¥°å¨çä½¿ç¨æ¹æ³","/pages/7434f1/"],["01.python/01.åºç¡/06.ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼.md","ä½¿ç¨pythonå®ç°åä¾æ¨¡å¼çä¸ç§æ¹å¼","/pages/33b8d0/"],["01.python/01.åºç¡/07.pythonä¸­importåç.md","pythonä¸­importåç","/pages/d8fd49/"]]},{title:"ç¬¬ä¸æ¹åº",collapsable:!0,children:[["01.python/02.ç¬¬ä¸æ¹åº/01.ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯.md","ä½¿ç¨ddtå®ç°unittestçåæ°åæµè¯","/pages/8d9ab9/"],["01.python/02.ç¬¬ä¸æ¹åº/02.ddtæºç åæ.md","ddtæºç åæ","/pages/069c65/"],["01.python/02.ç¬¬ä¸æ¹åº/03.django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢.md","django-apscheduleå®æ¶ä»»å¡å¼å¸¸åæ­¢","/pages/ec5110/"]]},{title:"django",collapsable:!0,children:[["01.python/06.django/01.django celery ç»åä½¿ç¨.md","django celery ç»åä½¿ç¨","/pages/853501/"],["01.python/06.django/02.django rest_frameworkä½¿ç¨jwt.md","django rest_frameworkä½¿ç¨jwt","/pages/25eafd/"],["01.python/06.django/03.django rest_framework Authentication.md","django rest_framework Authentication","/pages/626675/"],["01.python/06.django/04.django rest_frameworkå¼å¸¸å¤ç.md","django rest_frameworkå¼å¸¸å¤ç","/pages/070fec/"],["01.python/06.django/05.django rest_framework èªå®ä¹ææ¡£.md","django rest_framework èªå®ä¹ææ¡£","/pages/c3af6a/"],["01.python/06.django/06.djangoåç¼©æä»¶ä¸è½½.md","djangoåç¼©æä»¶ä¸è½½","/pages/f2738b/"],["01.python/06.django/07.django rest_frameworkä½¿ç¨pytestååæµè¯.md","django rest_frameworkä½¿ç¨pytestååæµè¯","/pages/c28126/"],["01.python/06.django/08.django restframework choice èªå®ä¹è¾åºæ°æ®.md","django restframework choice èªå®ä¹è¾åºæ°æ®","/pages/b90015/"],["01.python/06.django/09.django Filtering ä½¿ç¨.md","django Filtering ä½¿ç¨","/pages/cfdb5f/"],["01.python/06.django/10.django viewset å Router éåä½¿ç¨æ¶æ¥çé.md","django viewset å Router éåä½¿ç¨æ¶æ¥çé","/pages/e75ceb/"],["01.python/06.django/11.django modelçåºåå.md","django modelçåºåå","/pages/acdd50/"],["01.python/06.django/12.djangoä¸­ä½¿ç¨AbStractUser.md","djangoä¸­ä½¿ç¨AbStractUser","/pages/382755/"],["01.python/06.django/13.django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users.md","django.core.exceptions.ImproperlyConfigured Application labels aren't unique, duplicates users","/pages/060c51/"],["01.python/06.django/14.django ä¸­ mediaéç½®.md","django ä¸­ mediaéç½®","/pages/de01e2/"],["01.python/06.django/15.django å¤é®å¼ç¨èªèº«åon_deleteåæ°.md","django å¤é®å¼ç¨èªèº«åon_deleteåæ°","/pages/b422bd/"],["01.python/06.django/16.django è­¦å while time zone support is active.md","django è­¦å while time zone support is active","/pages/f0d816/"],["01.python/06.django/17.django rest_framework åé¡µ.md","django rest_framework åé¡µ","/pages/cb262f/"],["01.python/06.django/18.django-prometheusä½¿ç¨åæºç åæ.md","django-prometheusä½¿ç¨åæºç åæ","/pages/4b0adb/"]]},{title:"flask",collapsable:!0,children:[["01.python/07.flask/01.Flaskä½¿ç¨flask_socketioå®ç°websocket.md","Flaskä½¿ç¨flask_socketioå®ç°websocket","/pages/b71dc2/"],["01.python/07.flask/02.flaskç»åmongo.md","flaskç»åmongo","/pages/c59edf/"]]},{title:"tornado",collapsable:!0,children:[["01.python/08.tornado/01.tornado æä»¶ä¸ä¼ .md","tornado æä»¶ä¸ä¼ ","/pages/4c38f5/"],["01.python/08.tornado/02.tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯.md","tornado ä½¿ç¨jwtå®æç¨æ·å¼æ­¥è®¤è¯","/pages/c24905/"],["01.python/08.tornado/03.tornado ç¨æ·å¯ç  bcryptå å¯.md","tornado ç¨æ·å¯ç  bcryptå å¯","/pages/22f35b/"],["01.python/08.tornado/04.tornado ç»åwtformsä½¿ç¨è¡¨åæä½.md","tornado ç»åwtformsä½¿ç¨è¡¨åæä½","/pages/7ac01f/"],["01.python/08.tornado/05.tornado finishåwriteåºå«.md","tornado finishåwriteåºå«","/pages/d18657/"],["01.python/08.tornado/06.tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½.md","tornado ä½¿ç¨peewee-async å®æå¼æ­¥ormæ°æ®åºæä½","/pages/113ab1/"]]},{title:"å¶ä»",collapsable:!0,children:[["01.python/09.å¶ä»/01.pythonç®åä½¿ç¨grpc.md","pythonç®åä½¿ç¨grpc","/pages/f9d78c/"],["01.python/09.å¶ä»/02.pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾.md","pyspark streamingç®ä» å æ¶è´¹ kafkaç¤ºä¾","/pages/72664a/"],["01.python/09.å¶ä»/03.åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ.md","åºäºpre-commitçPythonä»£ç è§èè½å°å®è·µ","/pages/7f6078/"]]}]},{title:"goè¯­è¨",collapsable:!0,children:[["02.goè¯­è¨/01.goç®åä½¿ç¨grpc.md","goç®åä½¿ç¨grpc","/pages/87014e/"],["02.goè¯­è¨/02. ginä¸­validatoræ¨¡åçæºç åæ.md","ginä¸­validatoræ¨¡åçæºç åæ","/pages/c41003/"],["02.goè¯­è¨/03.ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯.md","ä¼åginè¡¨åçéè¯¯æç¤ºä¿¡æ¯","/pages/cf9a4d/"],["02.goè¯­è¨/04.goä¸­å¦ä½å¤çerror.md","goä¸­å¦ä½å¤çerror","/pages/d93df5/"],["02.goè¯­è¨/05.tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±.md","tcpç¼å­å¼èµ·çæ¥å¿ä¸¢å¤±","/pages/36b0b2/"],["02.goè¯­è¨/06.ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢.md","ä½¿ç¨etcdåå¸å¼éå¯¼è´çåç¨æ³é²ä¸æ­»éé®é¢","/pages/91d2d9/"],{title:"goè¯­è¨é«æ§è½ç¼ç¨",collapsable:!0,children:[["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/01.Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ.md","Goåç¨æ± æ·±åº¦è§£æï¼åçãå®ç°ä¸æä½³å®è·µ","/pages/d2c214/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/02.Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå.md","Goè¯­è¨Interface Boxingåçä¸æ§è½ä¼åæå","/pages/49057b/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/03.Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ.md","Goè¯­è¨éåæ§è½æ·±åº¦è§£æï¼ä»åçå°ä¼åå®è·µ","/pages/88360d/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/04.Goè¯­è¨é¶æ·è´ææ¯å®å¨æå.md","Goè¯­è¨é¶æ·è´ææ¯å®å¨æå","/pages/4f7497/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/05.Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ.md","Goè¯­è¨ä¸å¯åæ°æ®å±äº«ï¼æ éå¹¶åç¼ç¨å®è·µ","/pages/b03207/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/06.Goè¯­è¨åå­é¢åéå®å¨æå.md","Goè¯­è¨åå­é¢åéå®å¨æå","/pages/d7dbc7/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/07.Goè¯­è¨åå­æä½å®å¨æå.md","Goè¯­è¨åå­æä½å®å¨æå","/pages/821b25/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/08.Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ.md","Goè¯­è¨å æ åéä¸éé¸åææ·±åº¦è§£æ","/pages/c19d45/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/09.Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨.md","Goè¯­è¨ç©ºç»æä½ï¼é¶åå­æ¶èçé«æç¼ç¨","/pages/df4833/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/10.Goè¯­è¨é«æ§è½ç¼ç¨ä¹ç»æä½åå­å¯¹é½.md","Goè¯­è¨ç»æä½åå­å¯¹é½å®å¨æå","/pages/13969e/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/11.Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå.md","Goè¯­è¨å­ç¬¦ä¸²æ¼æ¥æ§è½å¯¹æ¯ä¸ä¼åæå","/pages/d4c8eb/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/12.Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ.md","Goè¯­è¨å»¶è¿åå§å(Lazy Initialization)æä½³å®è·µ","/pages/f9a2a3/"],["02.goè¯­è¨/07.goè¯­è¨é«æ§è½ç¼ç¨/13.Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£.md","Goè¯­è¨é«æIOç¼å²ææ¯è¯¦è§£","/pages/d8ed61/"]]}]},{title:"linux",collapsable:!0,children:[["03.linux/01.å¿«éäºè§£iptables.md","å¿«éäºè§£iptables","/pages/72ba9a/"],["03.linux/02.çè§£Linux TunTapè®¾å¤.md","çè§£Linux TunTapè®¾å¤","/pages/143447/"],["03.linux/03.çè§£VXLANç½ç».md","çè§£VXLANç½ç»","/pages/8a4b28/"],["03.linux/04.çè§£Linux IPIPé§é.md","çè§£Linux IPIPé§é","/pages/c128e7/"]]},{title:"å¶ä»",collapsable:!0,children:[["09.å¶ä»/01.åå¸å¼é.md","åå¸å¼é","/pages/d91dfb/"],["09.å¶ä»/02.ä½¿ç¨hueåå»ºozzieçpyspark action workflow.md","ä½¿ç¨hueåå»ºozzieçpyspark action workflow","/pages/aba491/"],["09.å¶ä»/03.ä½¿ç¨javaå¼ålogstashçfilteræä»¶.md","ä½¿ç¨javaå¼ålogstashçfilteræä»¶","/pages/7f16f6/"],["09.å¶ä»/20.countçæ§è½ä¼å.md","countçæ§è½ä¼å","/pages/19cfb6/"]]}],"/05.è¯»ä¹¦ç ´ä¸å·/":[["01.å¦ä½éè¯»ä¸æ¬ä¹¦.md","è¯»ä¹¦ç¬è®°:å¦ä½éè¯»ä¸æ¬ä¹¦","/pages/8bdb8d/"]],"/06.AI/":[["01.åè¯ MCP Server.md","åè¯ MCP Server","/pages/92e280/"]],"/08.å³äº/":[["01.å³äº.md","å³äº","/about/"]],"/09.æ´å¤/":[["01.æ¶è.md","ç½ç«","/pages/beb6c0bd8a66cea6/"],["02.åé¾.md","åé¾","/friends"]]},author:{name:"zhengwenfeng",link:"https://www.zhengwenfeng.com"},blogger:{avatar:"/img/me.jpg",name:"zhengwenfeng",slogan:"ç©·ååï¼ååéï¼éåä¹"},social:{icons:[{iconClass:"icon-youjian",title:"åé®ä»¶",link:"mailto:326695231@qq.com"},{iconClass:"icon-github",title:"GitHub",link:"https://github.com/tenqaz"},{iconClass:"icon-rss",title:"RSSè®¢é",link:"https://www.zhengwenfeng.com/rss.xml"}]},footer:{createYear:2022,copyrightInfo:'zhengwenfeng | <a href="https://github.com/tenqaz/tenqaz.github.io/master/LICENSE" target="_blank">MIT License</a>'},extendFrontmatter:{author:{name:"zhengwenfeng",link:"https://github.com/tenqaz"},description:"",comment:!0,feed:{enable:!0}},htmlModules:{homeSidebarB:'<div style="padding: 0.95rem">\n    <p style="\n      color: var(--textColor);\n      opacity: 0.9;\n      font-size: 20px;\n      font-weight: bold;\n      margin: 0 0 8px 0;\n    ">å¬ä¼å·</p>\n    <img src="https://open.weixin.qq.com/qr/code?username=gh_15e3ec18b681"  style="width:100%;" />\n    ç¼ç¨é»æ´ï¼æ«ç æèæç´¢å³æ³¨\n    </p>\n    </div>'}}};var wl=t(126),El=t(127),xl=t(21);var Al={computed:{$filterPosts(){return this.$site.pages.filter(n=>{const{frontmatter:{pageComponent:e,article:t,home:r}}=n;return!(e||!1===t||!0===r)})},$sortPosts(){return(n=this.$filterPosts).sort((n,e)=>{const t=n.frontmatter.sticky,r=e.frontmatter.sticky;return t&&r?t==r?Object(xl.a)(n,e):t-r:t&&!r?-1:!t&&r?1:Object(xl.a)(n,e)}),n;var n},$sortPostsByDate(){return(n=this.$filterPosts).sort((n,e)=>Object(xl.a)(n,e)),n;var n},$groupPosts(){return function(n){const e={},t={};for(let r=0,o=n.length;r<o;r++){const{frontmatter:{categories:o,tags:a}}=n[r];"array"===Object(xl.n)(o)&&o.forEach(t=>{t&&(e[t]||(e[t]=[]),e[t].push(n[r]))}),"array"===Object(xl.n)(a)&&a.forEach(e=>{e&&(t[e]||(t[e]=[]),t[e].push(n[r]))})}return{categories:e,tags:t}}(this.$sortPosts)},$categoriesAndTags(){return function(n){const e=[],t=[];for(let t in n.categories)e.push({key:t,length:n.categories[t].length});for(let e in n.tags)t.push({key:e,length:n.tags[e].length});return{categories:e,tags:t}}(this.$groupPosts)}}};Ht.component(wl.default),Ht.component(El.default);function Bl(n){return n.toString().padStart(2,"0")}t(279);Ht.component("Badge",()=>Promise.all([t.e(0),t.e(3)]).then(t.bind(null,472))),Ht.component("CodeBlock",()=>Promise.resolve().then(t.bind(null,126))),Ht.component("CodeGroup",()=>Promise.resolve().then(t.bind(null,127)));t(280);var zl=t(125),jl=t.n(zl),Tl=t(46);let Cl,Sl,Pl;var Il;"valine"===(Il="waline")?t.e(116).then(t.t.bind(null,358,7)).then(n=>Sl=n.default):"gitalk"===Il?Promise.all([t.e(0),t.e(115)]).then(t.t.bind(null,359,7)).then(()=>t.e(114).then(t.t.bind(null,360,7))).then(n=>Cl=n.default):"waline"===Il&&t.e(5).then(t.t.bind(null,361,7)).then(n=>Pl=n.default);function ql(n,e){const t={};return Reflect.ownKeys(n).forEach(r=>{if("string"==typeof n[r])try{t[r]=jl.a.render(n[r],e)}catch(e){console.warn(`Comment config option error at key named "${r}"`),console.warn("More info: "+e.message),t[r]=n[r]}else t[r]=n[r]}),t}console.log(`How to use "waline" in ${Tl.name}@v${Tl.version}:`,Tl.homepage);const Dl={gitalk:{render(n,e){const t=document.createElement("div");t.id=e;document.querySelector("main.page").appendChild(t);new Cl(ql({serverURL:"https://comment.zhengwenfeng.com/"},{frontmatter:n})).render(e)},clear(n){const e=document.querySelector("#"+n);return e&&e.remove(),!0}},valine:{render(n,e){const t=document.createElement("div");t.id=e;document.querySelector("main.page").appendChild(t),new Sl({...ql({serverURL:"https://comment.zhengwenfeng.com/"},{frontmatter:n}),el:"#"+e})},clear(n){const e=document.querySelector("#"+n);return e&&e.remove(),!0}},waline:{render(n,e){const t=document.createElement("div");t.id=e;document.querySelector("main.page").appendChild(t),new Pl({...ql({serverURL:"https://comment.zhengwenfeng.com/"},{frontmatter:n}),el:"#"+e})},clear(n){const e=document.querySelector("#"+n);return e&&e.remove(),!0}}},Nl="vuepress-plugin-comment";let Ol=null;function Rl(n){let e={serverURL:"https://comment.zhengwenfeng.com/"}.el||Nl;return e.startsWith("#")&&(e=e.slice(1)),console.log(e),Dl.waline.clear(e)}function Fl(n){return!1!==n.comment&&!1!==n.comments}function Ll(n){clearTimeout(Ol);if(!document.querySelector("main.page"))return void(Ol=setTimeout(()=>Ll(n),200));let e={serverURL:"https://comment.zhengwenfeng.com/"}.el||Nl;return e.startsWith("#")&&(e=e.slice(1)),Dl.waline.render(n,e)}var Ul={mounted(){Ol=setTimeout(()=>{const n={to:{},from:{},...this.$frontmatter};Rl()&&Fl(n)&&Ll(n)},1e3),this.$router.afterEach((n,e)=>{if(n&&e&&n.path===e.path)return;const t={to:n,from:e,...this.$frontmatter};Rl()&&Fl(t)&&Ll(t)})}},Ml=Object(bl.a)(Ul,(function(){return(0,this._self._c)("div")}),[],!1,null,null,null).exports,Gl={name:"ReadingProgress",data:()=>({readingTop:0,readingHeight:1,progressStyle:null,transform:void 0,running:!1}),watch:{$readingShow(){this.progressStyle=this.getProgressStyle(),this.$readingShow&&window.addEventListener("scroll",this.base)}},mounted(){this.transform=this.getTransform(),this.progressStyle=this.getProgressStyle(),this.$readingShow&&window.addEventListener("scroll",this.base)},beforeDestroy(){this.$readingShow&&window.removeEventListener("scroll",this.base)},methods:{base(){this.running||(this.running=!0,requestAnimationFrame(this.getReadingBase))},getReadingBase(){this.readingHeight=this.getReadingHeight()-this.getScreenHeight(),this.readingTop=this.getReadingTop(),this.progressStyle=this.getProgressStyle(),this.running=!1},getReadingHeight:()=>Math.max(document.body.scrollHeight,document.body.offsetHeight,0),getScreenHeight:()=>Math.max(window.innerHeight,document.documentElement.clientHeight,0),getReadingTop:()=>Math.max(window.pageYOffset,document.documentElement.scrollTop,0),getTransform(){const n=document.createElement("div");return["transform","-webkit-transform","-moz-transform","-o-transform","-ms-transform"].find(e=>e in n.style)||void 0},getProgressStyle(){const n=this.readingTop/this.readingHeight;switch(this.$readingShow){case"top":case"bottom":return this.transform?`${this.transform}: scaleX(${n})`:`width: ${100*n}%`;case"left":case"right":return this.transform?`${this.transform}: scaleY(${n})`:`height: ${100*n}%`;default:return null}}}},Vl=(t(285),Object(bl.a)(Gl,(function(){var n=this._self._c;return n("ClientOnly",[this.$readingShow?n("div",{staticClass:"reading-progress",class:this.$readingShow},[n("div",{staticClass:"progress",style:this.progressStyle})]):this._e()])}),[],!1,null,"3640397f",null).exports),$l=[({Vue:n,options:e,router:t,siteData:r})=>{},({Vue:n,options:e,router:t,siteData:r})=>{r.pages.map(n=>{const{frontmatter:{date:e,author:t}}=n;"string"==typeof e&&"Z"===e.charAt(e.length-1)&&(n.frontmatter.date=function(n){n instanceof Date||(n=new Date(n));return`${n.getUTCFullYear()}-${Bl(n.getUTCMonth()+1)}-${Bl(n.getUTCDate())} ${Bl(n.getUTCHours())}:${Bl(n.getUTCMinutes())}:${Bl(n.getUTCSeconds())}`}(e)),t?n.author=t:r.themeConfig.author&&(n.author=r.themeConfig.author)}),n.mixin(Al)},{},({Vue:n})=>{n.mixin({computed:{$dataBlock(){return this.$options.__data__block__}}})},{},{},({Vue:n})=>{n.component("Comment",Ml)},({router:n})=>{"undefined"!=typeof window&&function(){var n=document.createElement("script"),e=window.location.protocol.split(":")[0];n.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(n,t)}()},({router:n})=>{"undefined"!=typeof window&&(window._hmt=window._hmt||[],function(){var n=document.createElement("script");n.src="https://hm.baidu.com/hm.js?7c28cc47ffa100de44e976f816b0b294";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)}(),n.afterEach((function(n){_hmt.push(["_trackPageview",n.fullPath])})))},({Vue:n})=>{n.component(Vl.name,Vl),n.mixin({computed:{$readingShow(){return this.$page.frontmatter.readingShow}}})}],Wl=["Comment","ReadingProgress"];class Hl extends class{constructor(){this.store=new Ht({data:{state:{}}})}$get(n){return this.store.state[n]}$set(n,e){Ht.set(this.store.state,n,e)}$emit(...n){this.store.$emit(...n)}$on(...n){this.store.$on(...n)}}{}Object.assign(Hl.prototype,{getPageAsyncComponent:ii,getLayoutAsyncComponent:li,getAsyncComponent:ci,getVueComponent:pi});var Zl={install(n){const e=new Hl;n.$vuepress=e,n.prototype.$vuepress=e}};function Kl(n,e){const t=e.toLowerCase();return n.options.routes.some(n=>n.path.toLowerCase()===t)}var Xl={props:{pageKey:String,slotKey:{type:String,default:"default"}},render(n){const e=this.pageKey||this.$parent.$page.key;return ui("pageKey",e),Ht.component(e)||Ht.component(e,ii(e)),Ht.component(e)?n(e):n("")}},Jl={functional:!0,props:{slotKey:String,required:!0},render:(n,{props:e,slots:t})=>n("div",{class:["content__"+e.slotKey]},t()[e.slotKey])},Yl={computed:{openInNewWindowTitle(){return this.$themeLocaleConfig.openNewWindowText||"(opens new window)"}}},Ql=(t(286),t(287),Object(bl.a)(Yl,(function(){var n=this._self._c;return n("span",[n("svg",{staticClass:"icon outbound",attrs:{xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",x:"0px",y:"0px",viewBox:"0 0 100 100",width:"15",height:"15"}},[n("path",{attrs:{fill:"currentColor",d:"M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"}}),this._v(" "),n("polygon",{attrs:{fill:"currentColor",points:"45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"}})]),this._v(" "),n("span",{staticClass:"sr-only"},[this._v(this._s(this.openInNewWindowTitle))])])}),[],!1,null,null,null).exports),nc={functional:!0,render(n,{parent:e,children:t}){if(e._isMounted)return t;e.$once("hook:mounted",()=>{e.$forceUpdate()})}};Ht.config.productionTip=!1,Ht.use($s),Ht.use(Zl),Ht.mixin(function(n,e,t=Ht){!function(n){n.locales&&Object.keys(n.locales).forEach(e=>{n.locales[e].path=e});Object.freeze(n)}(e),t.$vuepress.$set("siteData",e);const r=new(n(t.$vuepress.$get("siteData"))),o=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(r)),a={};return Object.keys(o).reduce((n,e)=>(e.startsWith("$")&&(n[e]=o[e].get),n),a),{computed:a}}(n=>class{setPage(n){this.__page=n}get $site(){return n}get $themeConfig(){return this.$site.themeConfig}get $frontmatter(){return this.$page.frontmatter}get $localeConfig(){const{locales:n={}}=this.$site;let e,t;for(const r in n)"/"===r?t=n[r]:0===this.$page.path.indexOf(r)&&(e=n[r]);return e||t||{}}get $siteTitle(){return this.$localeConfig.title||this.$site.title||""}get $canonicalUrl(){const{canonicalUrl:n}=this.$page.frontmatter;return"string"==typeof n&&n}get $title(){const n=this.$page,{metaTitle:e}=this.$page.frontmatter;if("string"==typeof e)return e;const t=this.$siteTitle,r=n.frontmatter.home?null:n.frontmatter.title||n.title;return t?r?r+" | "+t:t:r||"VuePress"}get $description(){const n=function(n){if(n){const e=n.filter(n=>"description"===n.name)[0];if(e)return e.content}}(this.$page.frontmatter.meta);return n||(this.$page.frontmatter.description||this.$localeConfig.description||this.$site.description||"")}get $lang(){return this.$page.frontmatter.lang||this.$localeConfig.lang||"en-US"}get $localePath(){return this.$localeConfig.path||"/"}get $themeLocaleConfig(){return(this.$site.themeConfig.locales||{})[this.$localePath]||{}}get $page(){return this.__page?this.__page:function(n,e){for(let t=0;t<n.length;t++){const r=n[t];if(r.path.toLowerCase()===e.toLowerCase())return r}return{path:"",frontmatter:{}}}(this.$site.pages,this.$route.path)}},kl)),Ht.component("Content",Xl),Ht.component("ContentSlotsDistributor",Jl),Ht.component("OutboundLink",Ql),Ht.component("ClientOnly",nc),Ht.component("Layout",li("Layout")),Ht.component("NotFound",li("NotFound")),Ht.prototype.$withBase=function(n){const e=this.$site.base;return"/"===n.charAt(0)?e+n.slice(1):n},window.__VUEPRESS__={version:"1.9.5",hash:"c31a666"},async function(n){const e="undefined"!=typeof window&&window.__VUEPRESS_ROUTER_BASE__?window.__VUEPRESS_ROUTER_BASE__:kl.routerBase||kl.base,t=new $s({base:e,mode:"history",fallback:!1,routes:yl,scrollBehavior:(n,e,t)=>t||(n.hash?!Ht.$vuepress.$get("disableScrollBehavior")&&{selector:decodeURIComponent(n.hash)}:{x:0,y:0})});!function(n){n.beforeEach((e,t,r)=>{if(Kl(n,e.path))r();else if(/(\/|\.html)$/.test(e.path))if(/\/$/.test(e.path)){const t=e.path.replace(/\/$/,"")+".html";Kl(n,t)?r(t):r()}else r();else{const t=e.path+"/",o=e.path+".html";Kl(n,o)?r(o):Kl(n,t)?r(t):r()}})}(t);const r={};try{await Promise.all($l.filter(n=>"function"==typeof n).map(e=>e({Vue:Ht,options:r,router:t,siteData:kl,isServer:n})))}catch(n){console.error(n)}return{app:new Ht(Object.assign(r,{router:t,render:n=>n("div",{attrs:{id:"app"}},[n("RouterView",{ref:"layout"}),n("div",{class:"global-ui"},Wl.map(e=>n(e)))])})),router:t}}(!1).then(({app:n,router:e})=>{e.onReady(()=>{n.$mount("#app")})})}]);