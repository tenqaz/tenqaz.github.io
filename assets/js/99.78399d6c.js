(window.webpackJsonp=window.webpackJsonp||[]).push([[99],{459:function(s,a,t){"use strict";t.r(a);var n=t(5),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"什么是vxlan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是vxlan"}},[s._v("#")]),s._v(" 什么是VXLAN?")]),s._v(" "),a("p",[s._v("在三层可达的网络中部署VXLAN，在每个VXLAN网络端点中都有一个VTEP设备，负责将VXLAN协议的数据包进行UDP数据包的封包和解包，可以将其理解为隧道，将VXLAN数据包从逻辑网络转发到物理网络")]),s._v(" "),a("p",[s._v("VXLAN使用24位的VXLAN网络标识符（VNI）来标识不同的虚拟网络")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230526124522.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"点对点的vxlan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#点对点的vxlan"}},[s._v("#")]),s._v(" 点对点的VXLAN")]),s._v(" "),a("p",[s._v("在已经知道对端VTEP所在节点，是如何进行跨节点通信的。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_vxlan_point_to_point.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"实操"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实操"}},[s._v("#")]),s._v(" 实操")]),s._v(" "),a("p",[s._v("在Node上新增VTEP设备vxlan0，创建命令如下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vxlan0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" remote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 dev ens18\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("remote是对端节点的IP")]),s._v(" "),a("li",[s._v("local是本节点IP")]),s._v(" "),a("li",[s._v("id是VNI的值")]),s._v(" "),a("li",[s._v("dstport 是VTEP设备的端口")])]),s._v(" "),a("p",[s._v("创建好后，需要给它配置IP并启用")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2/24 dev vxlan0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 up\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("vxlan0详情如下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip -d link show dev vxlan0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("114")]),s._v(": vxlan0: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1450")]),s._v(" qdisc noqueue state UNKNOWN mode DEFAULT group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/ether "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v(":45:5c:56:49:42 brd ff:ff:ff:ff:ff:ff promiscuity "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n    vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" remote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.61")]),s._v(".74.37 dev ens18 srcport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" ageing "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" noudpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" numrxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" gso_max_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" gso_max_segs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("并且可以看到路由中新增一条记录，所有目的地址是172.17.1.0/24网段的包都要走vxlan0转发。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip r")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.0/24 dev vxlan0 proto kernel scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" src "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("同时fdb表中新增以下记录，代表着，所有进过vxlan0包的外部UDP目的地址都会设置为10.65.132.187，并从ens18网卡出去。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bridge fdb | grep vxlan0")]),s._v("\n00:00:00:00:00:00 dev vxlan0 dst "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 via ens18 self permanent\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("到这里，Node1已经配置好了，我们重复上面操作设置Node2，只需要将部分IP修改即可。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将Node1中remote和local反过来即可.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vxlan0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" remote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 dev ens18 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 dev ens18\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vxlan0 地址设置为172.17.1.3/24")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3/24 dev vxlan0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 up\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip -d link show vxlan0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(": vxlan0: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1450")]),s._v(" qdisc noqueue state UNKNOWN mode DEFAULT group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/ether "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":09:3d:c0:97:32 brd ff:ff:ff:ff:ff:ff promiscuity "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" minmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v(" maxmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n    vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" remote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 dev ens18 srcport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" ttl auto ageing "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" numrxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" gso_max_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" gso_max_segs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"开测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开测"}},[s._v("#")]),s._v(" 开测")]),s._v(" "),a("p",[s._v("在Node2上监听Node1的udp数据包")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("tcpdump "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" ens18 udp and "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后在Node1中ping Node2的VTEP设备地址172.17.1.3")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-07rf9 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 172.17.1.3 -c 3")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.841")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.382")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.377")]),s._v(" ms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("可以看到tcpdump抓到的数据包如下，先收到了Node1的发过来封装了ARP数据包的数据包，想要知道Node2中VTEP设备的MAC地址，然后回给了Node1，Node1收到后，将MAC地址填充，再将封装了ICMP的VXLAN数据包发送到Node2，Node2中VTEP收到包并解包，最后回包给Node1")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-work01-1zapn ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -i ens18 udp and host 10.65.132.187 -n")]),s._v("\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on ens18, link-type EN10MB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:36.705418 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.34062 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Request who-has "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 tell "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:36.705574 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.20835 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Reply "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 is-at 3a:84:39:cc:05:93, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:36.705880 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.jboss-iiop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25707")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:36.705986 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.62793 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25707")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:37.708701 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.jboss-iiop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25707")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:37.708846 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.62793 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25707")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:38.732737 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.jboss-iiop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25707")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:38.732846 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.62793 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("25707")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:41.804637 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.20835 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Request who-has "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 tell "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":23:41.804917 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.34062 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Reply "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 is-at c2:a1:4e:56:7d:eb, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h2",{attrs:{id:"vxlan的多播模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vxlan的多播模式"}},[s._v("#")]),s._v(" VXLAN的多播模式")]),s._v(" "),a("p",[s._v("在我们不知道VTEP所在节点的情况下，并且需要使用多个VTEP组建逻辑网络。")]),s._v(" "),a("h3",{attrs:{id:"通信过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通信过程"}},[s._v("#")]),s._v(" 通信过程")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_vxlan_mutilcast-20230517110009-jnqfwgg.png",alt:""}})]),s._v(" "),a("ol",[a("li",[s._v("在Node1上通过ping Node2上vxlan0设备ip，数据包通过路由到达vxlan0，vxlan0发现目的IP和源IP属于同一网段，需要知道对方的MAC地址，因此需要发送ARP查询报文。")]),s._v(" "),a("li",[s._v("ARP报文中，源MAC地址为Node1上vxlan0的mac地址，目的mac地址为255.255.255.255也就是广播地址，并且添加VXLAN头部VNI=42")]),s._v(" "),a("li",[s._v("因为不知道对端的VTEP设备在哪台节点上，所以vxlan0会向多播地址224.1.1.1发送多播报文。")]),s._v(" "),a("li",[s._v("多播组中所有的主机都会收到报文，并且内核会判断该数据包为VXLAN报文，根据VNI发送给VTEP设备。")]),s._v(" "),a("li",[s._v("Node2中vxlan0收到报文后，解包拿到ARP报文，然后通过ARP报文学习到了将Node1的vxlan0的mac地址与Node1 IP的映射关系记录到FDB表中，并且生成ARP应答报文。")]),s._v(" "),a("li",[s._v("ARP应答报文中，目的主机Node1的MAC地址和目的主机Node1中vxlan0的MAC地址都通过发过来的ARP报文中学习到，所以可以直接通过单播进行回复。")]),s._v(" "),a("li",[s._v("Node1收到ARP回复的报文后，通过报文内容，将Node2的主机地址和vxlan0的MAC地址的映射关系缓存到FDB表中。")]),s._v(" "),a("li",[s._v("现在双方都已经通过ARP报文获得了双方的建立ICMP通信的所有信息，可以直接通过通过单播进行通信。")])]),s._v(" "),a("h3",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("p",[s._v("首先在Node1中新增VTEP设备vxlan0，VNI为42，通信端口4789，主机地址为10.65.132.187，设置多播地址为224.1.1.1，数据包通过ens18真实网卡出去。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vxlan0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 group "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 dev ens18\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("给vxlan0添加地址172.17.1.2/24，并把它拉起")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2/24 dev vxlan0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 up\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("查看vxlan0的详细信息")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip -d link  show vxlan0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(": vxlan0: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1450")]),s._v(" qdisc noqueue state UNKNOWN mode DEFAULT group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/ether 4e:92:72:79:59:ed brd ff:ff:ff:ff:ff:ff promiscuity "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" minmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v(" maxmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n    vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" group "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 dev ens18 srcport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" ttl auto ageing "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" numrxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" gso_max_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" gso_max_segs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("再看看fdb表，意思是，vxlan0封包的时候，默认会使用224.1.1.1作为VXLAN包也就是外部UDP的目的IP。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bridge fdb | grep vxlan0")]),s._v("\n00:00:00:00:00:00 dev vxlan0 dst "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 via ens18 self permanent\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("在Node2上重复上述操作")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vxlan0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 group "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 dev ens18\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3/24 dev vxlan0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 up\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip -d link show vxlan0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(": vxlan0: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1450")]),s._v(" qdisc noqueue state UNKNOWN mode DEFAULT group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/ether ba:d8:43:67:8d:fb brd ff:ff:ff:ff:ff:ff promiscuity "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" minmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v(" maxmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n    vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" group "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 dev ens18 srcport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" ttl auto ageing "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" udpcsum noudp6zerocsumtx noudp6zerocsumrx addrgenmode eui64 numtxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" numrxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" gso_max_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" gso_max_segs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"开始分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开始分析"}},[s._v("#")]),s._v(" 开始分析")]),s._v(" "),a("p",[s._v("先使用tcpdump来监听Node2中ens18网卡中来自Node1的UDP数据包，然后在Node1上ping Node2中vxlan0设备。")]),s._v(" "),a("p",[s._v("可以看到是可以ping通的。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 172.17.1.3 -c 1")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.807")]),s._v(" ms\n\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 0ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.807")]),s._v("/0.807/0.807/0.000 ms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("再来看看抓到的包：")]),s._v(" "),a("ol",[a("li",[s._v("第一个数据包，可以看到Node2收到了来自Node1的 VXLAN数据包，vni为42，目的地址是多播IP224.1.1.1，因为我们创建的VTEP设备设置了该多播IP，所以会接收该数据包。且里面封装了ARP数据包，需要将172.17.1.3的MAC地址告诉172.17.1.2。")]),s._v(" "),a("li",[s._v("第二个数据包可以看到回复了一个VXLAN数据包，里面包含了ARP应答包，将172.17.1.3的mac地址也就是vxlan0的地址回复过去。")]),s._v(" "),a("li",[s._v("第三个数据包是Node1 vxlan0根据对方的MAC地址和Node2的IP地址，直接单播发送包含了ICMP数据包的VXLAN数据包到Node2")]),s._v(" "),a("li",[s._v("第四个数据包时Node2 vxlan0进行回复ICMP，也是包裹在一个VXLAN数据包中，发送到Node1中。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -i ens18 udp and host 10.65.132.187 -n")]),s._v("\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on ens18, link-type EN10MB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":31:34.560469 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.34062 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Request who-has "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 tell "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":31:34.560616 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.20835 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Reply "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 is-at ba:d8:43:67:8d:fb, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":31:34.560819 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.jboss-iiop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("46810")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":31:34.560935 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.62793 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("46810")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":31:39.661990 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.20835 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Request who-has "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 tell "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":31:39.662329 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.34062 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Reply "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 is-at 4e:92:72:79:59:ed, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("再次ping Node2的vxlan0设备，通过抓包可以看到，不需要发送ARP报文了，是因为Node1已经缓存了ARP。")]),s._v(" "),a("p",[s._v("第一个数据包目的IP不再是224.1.1.1多播地址了，而是Node2的地址。是因为vxlan0也已经缓存到fdb表中。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":49:36.712777 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.jboss-iiop "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("41695")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":49:36.712973 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.62793 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("41695")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("查看arp缓存")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# arp | grep vxlan0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.3               ether   ba:d8:43:67:8d:fb   C                     vxlan0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("查看fdb表，添加了Node2中vxlan0的MAC地址和Node2地址的映射表项。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bridge fdb | grep vxlan0")]),s._v("\n00:00:00:00:00:00 dev vxlan0 dst "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 via ens18 self permanent\nba:d8:43:67:8d:fb dev vxlan0 dst "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 self\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"vxlan多播模式-桥接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vxlan多播模式-桥接"}},[s._v("#")]),s._v(" VXLAN多播模式+桥接")]),s._v(" "),a("p",[s._v("在VXLAN的多播的基础上再加上桥接网络。")]),s._v(" "),a("h3",{attrs:{id:"通信过程-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通信过程-2"}},[s._v("#")]),s._v(" 通信过程")]),s._v(" "),a("p",[s._v("桥接网络模拟及通信到宿主机过程可以参考手动实现docker容器bridge网络模型")]),s._v(" "),a("p",[s._v("数据包达到网桥后，然后再转发到vxlan0中，接下来的流程也与上面将的多播是一致的。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/c__Users_User_OneDrive_workspace_excalidraw_vxlan_bridge-20230523170502-dkpk317.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"环境准备-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备-2"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("p",[s._v("在Node1上运行如下命令准备环境")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加VTEP设备")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vxlan0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 group "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 dev ens18\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 master bridge0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 up\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加net1模拟容器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 up\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net1中网络配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net1\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2/24 dev veth0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("在Node2中重复上面操作，将172.19.1.3/24绑定到另一个Network Namespace net3中")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加VTEP设备")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" vxlan0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4789")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 group "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1 dev ens18\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 master bridge0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" vxlan0 up\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加net1模拟容器")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net1中网络配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net3\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3/24 dev veth0\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h3",{attrs:{id:"开始分析-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开始分析-2"}},[s._v("#")]),s._v(" 开始分析")]),s._v(" "),a("p",[s._v("在Node1的net1中ping Node2中的net3，可以看到有回包，说明网络是通的。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec net1 ping 172.19.1.3 -c 2")]),s._v("\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.992")]),s._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.605")]),s._v(" ms\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("通过监听Node2的网卡ens18，抓到以下的包：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("首先是Node1发送包含ARP的UDP包到多播地址224.1.1.1，因为Node2是属于该多播地址，所以会接收该包，并通过vxlan0进行解包，最终拿到ARP包，然后发送vxlan0的mac地址进行arp回包，也是通过封装到UDP包中发送Node1中，然后再通过vxlan0->bridge进入到net1中，net1中收到ARP后，将Node2的容器IP地址和mac地址缓存到ARP中。")])]),s._v(" "),a("li",[a("p",[s._v("并且在fdb表中添加一项，net3的的mac地址与Node2的IP地址映射关系")])]),s._v(" "),a("li",[a("p",[s._v("接下来是通过ARP缓存找到MAC地址并添加到ICMP的IP包上，然后再将其封装到UDP包中，UDP的源IP是通过查询fdb表得到的，可以直接通过单播发送。")])])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(":15:47.595683 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.34062 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.1")]),s._v(".1.1.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Request who-has "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3 tell "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":15:47.595863 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.20835 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nARP, Reply "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3 is-at 02:fd:f9:7f:61:a7, length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":15:47.596172 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.42208 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51397")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":15:47.596295 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.22080 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51397")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":15:48.596543 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.42208 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51397")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":15:48.596724 IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188.22080 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187.vxlan: VXLAN, flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("I"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x08"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", vni "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v("\nIP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51397")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("可以看到net1中已经缓存了net3的ip地址与mac地址")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Node1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec net1 arp ")]),s._v("\nAddress                  HWtype  HWaddress           Flags Mask            Iface\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.3               ether   02:fd:f9:7f:61:a7   C                     veth0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("net3中的mac地址和net1中的arp缓存是对应上的。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec net3 ip -d link show veth0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v(": veth0@if33: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc noqueue state UP mode DEFAULT group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/ether 02:fd:f9:7f:61:a7 brd ff:ff:ff:ff:ff:ff link-netnsid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" promiscuity "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" minmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("68")]),s._v(" maxmtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n    veth addrgenmode eui64 numtxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" numrxqueues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" gso_max_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" gso_max_segs "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65535")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("查看fdb表，新增了net3的mac地址和Node2的IP地址映射关系")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bridge fdb | grep vxlan0")]),s._v("\n02:fd:f9:7f:61:a7 dev vxlan0 dst "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 self\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"巨人的肩膀"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#巨人的肩膀"}},[s._v("#")]),s._v(" 巨人的肩膀")]),s._v(" "),a("ul",[a("li",[s._v("《kubernetes网络权威指南》")])])])}),[],!1,null,null,null);a.default=e.exports}}]);