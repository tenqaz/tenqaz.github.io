(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{383:function(s,n,t){"use strict";t.r(n);var a=t(5),e=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_0-前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_0-前言"}},[s._v("#")]),s._v(" 0. 前言")]),s._v(" "),n("p",[s._v("本文主要介绍flannel在k8s网络中作为网络插件通过UDP、VXLAN、HOST-GATEWAY三种模式来解决容器跨主机网络通信的，并通过手动实现这三种模式深入理解其原理。")]),s._v(" "),n("h2",{attrs:{id:"_1-flannel全局网络地址分配机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-flannel全局网络地址分配机制"}},[s._v("#")]),s._v(" 1. flannel全局网络地址分配机制")]),s._v(" "),n("p",[s._v("每台节点上容器的IP地址是由所属节点自动分配的，那么会存在一个问题是，不同节点上的容器所分配的IP地址则可能会有重复的情况。")]),s._v(" "),n("p",[s._v("flannel设计了一种全局的网络地址分配机制，flannel会为每台节点申请一个独一无二的网段，并存储在etcd中，flannel会将该网段配置到各个节点上的Docker(或者其他容器工具)，当前节点上的容器\n只从分配的网段里中获取IP地址。")]),s._v(" "),n("blockquote",[n("p",[s._v("修改docker启动参数--bip来限制节点容器获得的IP范围。")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603100424.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"_2-udp模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-udp模式"}},[s._v("#")]),s._v(" 2. UDP模式")]),s._v(" "),n("h3",{attrs:{id:"_2-1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-简介"}},[s._v("#")]),s._v(" 2.1 简介")]),s._v(" "),n("p",[s._v("在Flannel的UDP模式中，每个节点都会启动一个UDP服务器，用于监听来自其他节点的数据包。当一个容器向另一个容器发送数据包时，它会将数据包发送到目标容器的IP地址和端口号。Flannel会将该数据包封装在一个UDP数据包中，并将其发送到目标节点的UDP服务器。目标节点的UDP服务器会解析该数据包，并将其传递给目标容器。")]),s._v(" "),n("h3",{attrs:{id:"_2-2-flannel实现udp流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-flannel实现udp流程"}},[s._v("#")]),s._v(" 2.2 flannel实现UDP流程")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230604165519.png",alt:""}})]),s._v(" "),n("p",[s._v("flanneld启动后会通过打开/dev/net/tun的方式创建"),n("a",{attrs:{href:"https://www.zhengwenfeng.com/pages/143447",target:"_blank",rel:"noopener noreferrer"}},[s._v("tun设备"),n("OutboundLink")],1),s._v("，名称为flannel0，该设备是用户空间与内核空间的数据包交互的通道。然后再将从tun设备获取的IP数据包封装到UDP数据包中通过物理网卡发送到其他节点中，内核通过UDP端口转发给flanneld然后解包，得到其中的IP数据包，然后再通过tun设备进入内核空间中，通过路由到达网桥，然后再到目的容器中。")]),s._v(" "),n("p",[s._v("flanneld在其中主要做了：")]),s._v(" "),n("ol",[n("li",[s._v("开启了udp服务，并对udp数据包封包和解包")]),s._v(" "),n("li",[s._v("节点上路由表的动态更新，也就是从网桥出来的数据包目的IP为其他节点容器IP时，需要路由到flanneld中进行封包，并且在flanneld接收UDP包后解封出来的IP包需要通过路由到网桥docker0中")])]),s._v(" "),n("p",[s._v("缺点很明显，仅一次网络传输的数据包经历了2次用户态与内核态的切换，而切换的效率是不高的，每一次的切换都是一次数据的复制。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230604153501.png",alt:""}})]),s._v(" "),n("h3",{attrs:{id:"_2-3-手动模拟flannel实现udp实验"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-手动模拟flannel实现udp实验"}},[s._v("#")]),s._v(" 2.3 手动模拟flannel实现udp实验")]),s._v(" "),n("p",[s._v("首先创建Network Namesapce net1用来模拟容器")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("然后创建一对veth pair网卡veth0和veth1，并将veth0放到net1中，拉起并设置veth0的ip地址为172.19.1.2/24")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2/24 dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("创建网桥设备，拉起并设置ip地址为172.19.1.1/24，将veth1拉起并绑定到网桥bridge0中")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.1/24 dev bridge0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("在net1中添加默认路由，设置下一条地址为网桥bridge0的IP地址，从网桥进入到宿主机的网络协议栈中。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.1 dev veth0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("再运行以下代码，该代码是用来模拟flanneld程序，主要作用是创建了tun设备flannel0，开启了UDP服务收发UDP包，然后就是对容器IP包的封装与解封。")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" os\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" socket\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" struct\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" threading\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fcntl "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" ioctl\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" click\n\nBIND_ADDRESS "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.0.0'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8285")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nBUFFER_SIZE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n\nTUNSETIFF "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x400454ca")]),s._v("\nIFF_TUN "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0001")]),s._v("\nIFF_TAP "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0002")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_tunnel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tun_name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'flannel%d'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_mode"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IFF_TUN"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    tun_fd "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("open")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/dev/net/tun"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("O_RDWR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    ifn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ioctl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" TUNSETIFF"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" struct"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pack"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('b"16sH"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("encode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    tun_name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ifn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("decode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("strip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\x00"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_name\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("start_tunnel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tun_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("popen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string-interpolation"}},[n("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"ip link set ')]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("tun_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v(' up"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("udp_server")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("udp_socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" udp_socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recvfrom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get data from udp."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),s._v("\n\n        os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("write"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@click"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@click"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("option")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--peer_node_ip"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-p"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" required"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("help")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"对端节点IP"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("peer_node_ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    peer_node_addr "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("peer_node_ip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" create_tunnel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    start_tunnel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tun_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    udp_socket "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("AF_INET"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SOCK_DGRAM"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    udp_socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bind"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BIND_ADDRESS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" threading"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Thread"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("target"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("udp_server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("udp_socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("daemon "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),s._v("\n    t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        data "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tun_fd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" BUFFER_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string-interpolation"}},[n("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"get data from tun. data size = ')]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"')])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        udp_socket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sendto"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" peer_node_addr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'__main__'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    main"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br")])]),n("p",[s._v("在Node1中运行该程序，设置Node2 IP")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("python3 tun_app.py "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("可以看到已经创建了tun设备")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip link show flannel0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("109")]),s._v(": tun0: "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc pfifo_fast state UNKNOWN group default qlen "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("\n    link/none \n    inet6 fe80::8e98:91a4:6537:d77a/64 scope "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" flags "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v(" \n       valid_lft forever preferred_lft forever\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在设置宿主机的路由，将所有到Node2容器的IP包，都转发到flannel0设备中。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.0/24 dev flannel0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("最后重复Node1的操作配置Node2")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建net3")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net3\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建veth pair")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net1网络")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net3\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2/24 dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.1/24 dev bridge0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置net3路由")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.1 dev veth0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建flannel0")]),s._v("\npython3 flanneld.py "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置到flannel0的路由")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.0/24 dev flannel0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("h3",{attrs:{id:"_2-4-分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-分析"}},[s._v("#")]),s._v(" 2.4 分析")]),s._v(" "),n("p",[s._v("在Node1的net1中ping Node2的net2的ip 172.19.2.2，可以看到是可以ping通的")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 172.19.2.2 -c 1")]),s._v("\nPING "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.641")]),s._v(" ms\n\n--- "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" packets transmitted, "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" received, "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 0ms\nrtt min/avg/max/mdev "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.641")]),s._v("/0.641/0.641/0.000 ms\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在Node1的flanneld.py中看到日志，从tun中收到了来自容器的IP数据包")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# python3 flanneld.py -p 10.65.132.188")]),s._v("\nget data from tun. data size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("在Node2的flanneld.py中看到日志，接收到了Node1发送过来的udp数据包。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# python3 flanneld.py -p 10.65.132.187")]),s._v("\nget data from udp.\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"_3-vxlan模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-vxlan模式"}},[s._v("#")]),s._v(" 3. VXLAN模式")]),s._v(" "),n("h3",{attrs:{id:"_3-1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-简介"}},[s._v("#")]),s._v(" 3.1 简介")]),s._v(" "),n("p",[s._v("在Flannel的"),n("a",{attrs:{href:"https://www.zhengwenfeng.com/pages/8a4b28/",target:"_blank",rel:"noopener noreferrer"}},[s._v("VXLAN"),n("OutboundLink")],1),s._v("模式中，每个节点都会启动一个VXLAN隧道，用于将容器之间的数据包封装在VXLAN协议中进行传输。当一个容器向另一个容器发送数据包时，它会将数据包发送到目标容器的IP地址和虚拟网络ID。Flannel会将该数据包封装在一个VXLAN数据包中，并将其发送到目标节点的VXLAN隧道。目标节点的VXLAN隧道会解析该数据包，并将其传递给目标容器。")]),s._v(" "),n("p",[n("strong",[s._v("vxlan模式也是通过封包与解包的形式来实现隧道达到容器的跨主机访问，那和UDP模式有什么区别呢？")]),s._v("\n区别在于，VXLAN的封包与解包都是在内核态完成的，对比UDP模式用户态与内核态的切换来说，效率大大的提升了。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-flannel实现vxlan模式流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-flannel实现vxlan模式流程"}},[s._v("#")]),s._v(" 3.3 flannel实现vxlan模式流程")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603105736.png",alt:""}})]),s._v(" "),n("p",[s._v("在Node1的net1中ping Node2的net3，数据流如下：")]),s._v(" "),n("ol",[n("li",[s._v("bridge作为net1的下一跳网关，所以会先发送ARP获取bridge的mac地址")]),s._v(" "),n("li",[s._v("获取到后，然后发送ICMP数据包通过bridge进入到宿主机的网络协议栈中，通过路由表，会进入到flannel.1中，下一跳地址为Node2的flannel.1的地址")]),s._v(" "),n("li",[s._v("本来是要发送ARP来获取Node2的flannel.1的地址，因为已经手动配置了ARP表，可以直接获取到到MAC地址，然后将其填充内层二层头中。")]),s._v(" "),n("li",[s._v("再通过查询FDB表，找到外层UDP包中目的IP地址，也就是Node2的IP地址，填充到外部IP头中。最终通过物理网卡ens18走外部网络达到Node2中。")]),s._v(" "),n("li",[s._v("达到Node2后，通过端口8472，将包转发给VTEP设备flannel.1进行解包，解封后的IP包经过路由表达到bridge中，最终转发到net3中。")])]),s._v(" "),n("h3",{attrs:{id:"_3-4-手动模拟flanneld维护vtep组实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-手动模拟flanneld维护vtep组实践"}},[s._v("#")]),s._v(" 3.4 手动模拟flanneld维护VTEP组实践")]),s._v(" "),n("p",[s._v("创建VTEP设备命名为flannel.1，然后flannel.1配置ip地址为172.19.1.0/32")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加VTEP设备")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" flannel.1 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8472")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 dev ens18 nolearning proxy\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置flannel.1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" flannel.1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.0/32 dev flannel.1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("ul",[n("li",[s._v("只需要填写local地址")]),s._v(" "),n("li",[s._v("nolearning，VTEP不要通过收到的报文学习FDB表项的内容，减少广播风暴，提高效率。")]),s._v(" "),n("li",[s._v("proxy，VTEP承担ARP代理功能，收到ARP请求时，如果有缓存则直接应答，减少广播风暴，提高效率。")])]),s._v(" "),n("p",[s._v("添加network namespace net1，创建veth pair，将其中一端放进net1中，并配置好ip地址，再添加默认路由都走veth0")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net1中网络配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2/24 dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认路由")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.1 dev veth0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("创建网桥设备命名为bridge0，并将veth1插到其上")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.1/24 dev bridge0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("到达net3的数据包下一跳为Node2的VTEP设备IP通过flannel.1设备，需要添加onlink，因为下一跳网关不和本地地址在同一网段，路由添加时输出路由不可达的错误，onlink的意义在于协议栈虽然找不到链路层直连路由，但是还是会发布针对via网关的arp请求的.")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.0/24 via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.0 dev flannel.1 onlink\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("在Node2节点中重复上面操作创建VETP设备和相关网络配置")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加VTEP设备")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" flannel.1 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" vxlan "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),s._v(" dstport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8472")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 dev ens18\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" flannel.1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.0/32 dev flannel.1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.0/24 via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.0 dev flannel.1 onlink\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加net3模拟容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net3\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net3中网络配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net3\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2/24 dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.1 dev veth0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.1/24 dev bridge0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("在Node1节点中需要再新增ARP缓存，Node1中添加路由的下一跳地址是Node2的VTEP设备，所以需要在arp添加VTEP IP和MAC地址的缓存。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("arp "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.0 8a:8b:4d:10:82:56 dev flannel.1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("再在节点FDB表中添加对端VETP MAC地址和对外IP（物理网卡IP）的映射关系表项")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("bridge fdb "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" 8a:8b:4d:10:82:56 dev flannel.1 dst "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("重复Node1操作，配置Node2的ARP缓存和FDB表。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[s._v("arp "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.0 1e:b7:5e:19:ab:90 dev flannel.1\nbridge fdb "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" 1e:b7:5e:19:ab:90 dev flannel.1 dst "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("通过以上操作完成了环境的搭建，接下来，我们在Node1的net1中进行ping Node2的net3，可以发现是可以ping通的")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec net1 ping 172.19.2.2 -c 2")]),s._v("\nPING "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("62")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.547")]),s._v(" ms\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2: "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("62")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.560")]),s._v(" ms\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"_4-host-gateway模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-host-gateway模式"}},[s._v("#")]),s._v(" 4. Host Gateway模式")]),s._v(" "),n("h3",{attrs:{id:"_4-1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-简介"}},[s._v("#")]),s._v(" 4.1 简介")]),s._v(" "),n("p",[s._v("通过把主机当作网关实现跨节点网络通信的。因此通信双方的宿主机要求能够直接路由，必须在同一个网络，这个限制使得host-gw模式无法适用于集群规模较大且需要对节点进行网段划分的场景。host-gw的另外一个限制则是随着集群中节点规模的增大，flanneld维护主机上成千上万条路由表的动态更新也是一个不小的压力。")]),s._v(" "),n("p",[s._v("flanneld的唯一作用就是负责主机上路由表的动态，但因为只能修改主机的路由，所以各个主机必须二层网络互通。")]),s._v(" "),n("p",[s._v("跟VXLAN模式和UDP模式比较，优点主要是没有封包与解包的操作，大大的提高了性能。")]),s._v(" "),n("h3",{attrs:{id:"_4-3-flannel实现host-gateway模式流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-flannel实现host-gateway模式流程"}},[s._v("#")]),s._v(" 4.3 flannel实现Host Gateway模式流程")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://gcore.jsdelivr.net/gh/tenqaz/BLOG-CDN@main/20230603110047.png",alt:""}})]),s._v(" "),n("p",[s._v("在Node1的net1中ping Node2的net3，数据流如下：")]),s._v(" "),n("ol",[n("li",[s._v("数据包从容器进入到宿主机网络协议栈逻辑与VXLAN模式一致")]),s._v(" "),n("li",[s._v("通过路由表可知，该数据包通过ens18网卡到达下一跳网关Node2的ens18")]),s._v(" "),n("li",[s._v("通过物理网络，达到Node2并进入网络协议栈，通过路由达到bridge进入到net3中")])]),s._v(" "),n("h3",{attrs:{id:"_4-4-手动模拟flannel实现host-gateway模式实验"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-手动模拟flannel实现host-gateway模式实验"}},[s._v("#")]),s._v(" 4.4 手动模拟flannel实现Host Gateway模式实验")]),s._v(" "),n("p",[s._v("在Node1中创建Network Namesapce net1、vethpair和网桥，并配置好其网络。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net1中网络配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net1\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2/24 dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认路由")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net1 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.1 dev veth0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.1/24 dev bridge0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("再添加路由，将Node2所分配到的容器网段为目的数据包都将Node2作为下一跳网关。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.0/24 via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.188 dev ens18\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("重复Node1的配置，并添加将Node1所分配到的容器网段为目的数据包都将Node1作为下一跳网关。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加net3模拟容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" net3\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" veth0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth1\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置net3中网络配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth0 netns net3\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2/24 dev veth0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth0 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" net3 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.1 dev veth0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加网桥")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bridge0 "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" bridge\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.1/24 dev bridge0\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" bridge0 up\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将另一端绑定在网桥上")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 up\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev veth1 master bridge0\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.0/24 via "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.65")]),s._v(".132.187 dev ens18\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("在Node1的net1中ping Node2的net2，是可以ping通的，说明网络互通了。")]),s._v(" "),n("p",[s._v("在通过tcpdump抓取Node2 ens18网卡的包，可以看到ICMP数据包到了Node2节点。")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -i ens18 host 172.19.2.2")]),s._v("\ndropped privs to tcpdump\ntcpdump: verbose output suppressed, use "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on ens18, link-type EN10MB "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":07:00.072677 IP "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2: ICMP "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("52240")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(", length "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":07:00.072782 IP "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".2.2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.19")]),s._v(".1.2: ICMP "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" reply, "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("52240")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(", length "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"_5-巨人的肩膀"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-巨人的肩膀"}},[s._v("#")]),s._v(" 5. 巨人的肩膀")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://izsk.me/2022/03/25/Kubernetes-Flannel-Vxlan/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Flannel Vxlan封包原理剖析"),n("OutboundLink")],1)]),s._v(" "),n("li",[s._v("《kubernetes网络权威指南》")]),s._v(" "),n("li",[s._v("《极客时间-深入剖析Kubernetes》")])])])}),[],!1,null,null,null);n.default=e.exports}}]);